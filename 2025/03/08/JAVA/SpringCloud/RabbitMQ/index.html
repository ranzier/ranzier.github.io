

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/about/dogs.jpg">
  <link rel="icon" href="/img/about/dogs.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ranzier">
  <meta name="keywords" content="">
  
    <meta name="description" content="RabbitMQå­¦ä¹ ç¬”è®°  1. è®¤è¯†MQ1.1 åŒæ­¥è°ƒç”¨åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒåŒæ­¥è°ƒç”¨ï¼ˆSynchronous Invocationï¼‰é€šå¸¸æŒ‡ä¸€ä¸ªæœåŠ¡è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨æ–¹å¤„ç†å®Œè¯·æ±‚å¹¶è¿”å›å“åº”åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ã€‚  ç‰¹ç‚¹ï¼š  é˜»å¡æ‰§è¡Œï¼šè°ƒç”¨æ–¹åœ¨ç­‰å¾…è¿”å›ç»“æœæ—¶æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ æ‰§è¡Œé¡ºåºä¸¥æ ¼ï¼šå¿…é¡»æŒ‰é¡ºåºç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ é€‚ç”¨äºçŸ­æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQå­¦ä¹ ç¬”è®°">
<meta property="og:url" content="http://example.com/2025/03/08/JAVA/SpringCloud/RabbitMQ/index.html">
<meta property="og:site_name" content="RANZIER">
<meta property="og:description" content="RabbitMQå­¦ä¹ ç¬”è®°  1. è®¤è¯†MQ1.1 åŒæ­¥è°ƒç”¨åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒåŒæ­¥è°ƒç”¨ï¼ˆSynchronous Invocationï¼‰é€šå¸¸æŒ‡ä¸€ä¸ªæœåŠ¡è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨æ–¹å¤„ç†å®Œè¯·æ±‚å¹¶è¿”å›å“åº”åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘ã€‚  ç‰¹ç‚¹ï¼š  é˜»å¡æ‰§è¡Œï¼šè°ƒç”¨æ–¹åœ¨ç­‰å¾…è¿”å›ç»“æœæ—¶æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚ æ‰§è¡Œé¡ºåºä¸¥æ ¼ï¼šå¿…é¡»æŒ‰é¡ºåºç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ é€‚ç”¨äºçŸ­æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg/30.jpg">
<meta property="article:published_time" content="2025-03-08T13:20:47.000Z">
<meta property="article:modified_time" content="2025-10-14T02:59:35.452Z">
<meta property="article:author" content="ranzier">
<meta property="article:tag" content="RabbitMQ">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="å­¦ä¹ ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/bg/30.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>RabbitMQå­¦ä¹ ç¬”è®° - RANZIER</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸŒŸ","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RANZIER</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.35)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="RabbitMQå­¦ä¹ ç¬”è®°"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-08 21:20" pubdate>
          2025å¹´3æœˆ8æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          7.3k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          æœ¬æ–‡é˜…è¯»æ¬¡æ•°ï¼š<span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">RabbitMQå­¦ä¹ ç¬”è®°</h1>
            
            
              <div class="markdown-body">
                
                <h1 align="center">RabbitMQå­¦ä¹ ç¬”è®°</h1>

<h2 id="1-è®¤è¯†MQ"><a href="#1-è®¤è¯†MQ" class="headerlink" title="1. è®¤è¯†MQ"></a>1. è®¤è¯†MQ</h2><h3 id="1-1-åŒæ­¥è°ƒç”¨"><a href="#1-1-åŒæ­¥è°ƒç”¨" class="headerlink" title="1.1 åŒæ­¥è°ƒç”¨"></a>1.1 åŒæ­¥è°ƒç”¨</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒåŒæ­¥è°ƒç”¨ï¼ˆSynchronous Invocationï¼‰é€šå¸¸<strong>æŒ‡ä¸€ä¸ªæœåŠ¡è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨æ–¹å¤„ç†å®Œè¯·æ±‚å¹¶è¿”å›å“åº”åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘</strong>ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>é˜»å¡æ‰§è¡Œï¼šè°ƒç”¨æ–¹åœ¨ç­‰å¾…è¿”å›ç»“æœæ—¶æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œé¡ºåºä¸¥æ ¼ï¼šå¿…é¡»æŒ‰é¡ºåºç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</li>
<li>é€‚ç”¨äºçŸ­æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œä¼šå½±å“ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œå¹¶å‘èƒ½åŠ›ã€‚</li>
</ul>
<p><strong>å­˜åœ¨çš„é—®é¢˜</strong>ï¼š</p>
<ul>
<li>æ‹“å±•æ€§å·®ï¼šæ¯æ¬¡æœ‰æ–°çš„éœ€æ±‚ï¼Œç°æœ‰æ”¯ä»˜é€»è¾‘éƒ½è¦è·Ÿç€å˜åŒ–ï¼Œä»£ç ç»å¸¸å˜åŠ¨ï¼Œä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ‹“å±•æ€§ä¸å¥½ã€‚</li>
<li>æ€§èƒ½ä¸‹é™ï¼šæ¯æ¬¡è¿œç¨‹è°ƒç”¨ï¼Œè°ƒç”¨è€…éƒ½æ˜¯é˜»å¡ç­‰å¾…çŠ¶æ€ã€‚æœ€ç»ˆæ•´ä¸ªä¸šåŠ¡çš„å“åº”æ—¶é•¿å°±æ˜¯æ¯æ¬¡è¿œç¨‹è°ƒç”¨çš„æ‰§è¡Œæ—¶é•¿ä¹‹å’Œ</li>
<li>çº§è”å¤±è´¥(é›ªå´©é—®é¢˜)ï¼šå½“äº¤æ˜“æœåŠ¡ã€é€šçŸ¥æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¼šå›æ»šï¼Œäº¤æ˜“å¤±è´¥ã€‚</li>
</ul>
<h3 id="1-2-å¼‚æ­¥è°ƒç”¨"><a href="#1-2-å¼‚æ­¥è°ƒç”¨" class="headerlink" title="1.2 å¼‚æ­¥è°ƒç”¨"></a>1.2 å¼‚æ­¥è°ƒç”¨</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¼‚æ­¥è°ƒç”¨ï¼ˆAsynchronous Invocationï¼‰æŒ‡çš„æ˜¯<strong>è°ƒç”¨æ–¹åœ¨è°ƒç”¨æŸä¸ªæœåŠ¡æ—¶ï¼Œä¸éœ€è¦ç­‰å¾…å…¶å®Œæˆï¼Œè€Œæ˜¯ç«‹å³è¿”å›å¹¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡</strong>ã€‚<strong>è¢«è°ƒç”¨æ–¹åœ¨å®Œæˆå¤„ç†å</strong>ï¼Œå¯ä»¥é€šè¿‡å›è°ƒã€è½®è¯¢ã€<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ç­‰æ–¹å¼é€šçŸ¥è°ƒç”¨æ–¹ã€‚</p>
<p>å¼‚æ­¥è°ƒç”¨æ–¹å¼å…¶å®å°±æ˜¯åŸºäºæ¶ˆæ¯é€šçŸ¥çš„æ–¹å¼ï¼Œä¸€èˆ¬åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯å‘é€è€…ï¼šæŠ•é€’æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„è°ƒç”¨æ–¹</li>
<li>æ¶ˆæ¯Brokerï¼šç®¡ç†ã€æš‚å­˜ã€è½¬å‘æ¶ˆæ¯ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆå¾®ä¿¡æœåŠ¡å™¨</li>
<li>æ¶ˆæ¯æ¥æ”¶è€…ï¼šæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„æœåŠ¡æä¾›æ–¹</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.2.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œå‘é€è€…ä¸å†ç›´æ¥åŒæ­¥è°ƒç”¨æ¥æ”¶è€…çš„ä¸šåŠ¡æ¥å£ï¼Œè€Œæ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯Brokerã€‚ç„¶åæ¥æ”¶è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä»æ¶ˆæ¯Brokeré‚£é‡Œè®¢é˜…æ¶ˆæ¯ã€‚æ¯å½“å‘é€æ–¹å‘é€æ¶ˆæ¯åï¼Œæ¥å—è€…éƒ½èƒ½è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.3.png" srcset="/img/loading.gif" lazyload></p>
<p>å¼‚æ­¥è°ƒç”¨çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p>
<ul>
<li>è€¦åˆåº¦æ›´ä½</li>
<li>æ€§èƒ½æ›´å¥½</li>
<li>ä¸šåŠ¡æ‹“å±•æ€§å¼º</li>
<li>æ•…éšœéš”ç¦»ï¼Œé¿å…çº§è”å¤±è´¥</li>
</ul>
<p>å¼‚æ­¥é€šä¿¡å­˜åœ¨ä¸‹åˆ—ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®Œå…¨ä¾èµ–äºBrokerçš„å¯é æ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½</li>
<li>æ¶æ„å¤æ‚ï¼ŒåæœŸç»´æŠ¤å’Œè°ƒè¯•éº»çƒ¦</li>
</ul>
<h3 id="1-3-å¸¸è§MQæŠ€æœ¯å¯¹æ¯”"><a href="#1-3-å¸¸è§MQæŠ€æœ¯å¯¹æ¯”" class="headerlink" title="1.3 å¸¸è§MQæŠ€æœ¯å¯¹æ¯”"></a>1.3 å¸¸è§MQæŠ€æœ¯å¯¹æ¯”</h3><table>
<thead>
<tr>
<th>å¸¸è§MQ</th>
<th>RabbitMQ</th>
<th>ActiveMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å…¬å¸&#x2F;ç¤¾åŒº</strong></td>
<td>Rabbit</td>
<td>Apache</td>
<td>é˜¿é‡Œ</td>
<td>Apache</td>
</tr>
<tr>
<td><strong>å¼€å‘è¯­è¨€</strong></td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td><strong>åè®®æ”¯æŒ</strong></td>
<td>AMQP, XMPP, SMTP, STOMP</td>
<td>OpenWire, STOMP, REST, XMPP, AMQP</td>
<td>è‡ªå®šä¹‰åè®®</td>
<td>è‡ªå®šä¹‰åè®®</td>
</tr>
<tr>
<td><strong>å¯ç”¨æ€§</strong></td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
<td>é«˜</td>
<td>é«˜</td>
</tr>
<tr>
<td><strong>å•æœºååé‡</strong></td>
<td>ä¸€èˆ¬</td>
<td>å·®</td>
<td>é«˜</td>
<td>éå¸¸é«˜</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å»¶è¿Ÿ</strong></td>
<td>å¾®ç§’çº§</td>
<td>æ¯«ç§’çº§</td>
<td>æ¯«ç§’çº§</td>
<td>æ¯«ç§’ä»¥å†…</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å¯é æ€§</strong></td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
</tr>
</tbody></table>
<h2 id="2-RabbitMQ"><a href="#2-RabbitMQ" class="headerlink" title="2. RabbitMQ"></a>2. RabbitMQ</h2><h3 id="2-1-RabbitMQæ¶æ„"><a href="#2-1-RabbitMQæ¶æ„" class="headerlink" title="2.1 RabbitMQæ¶æ„"></a>2.1 RabbitMQæ¶æ„</h3><ul>
<li>publisherï¼šç”Ÿäº§è€…ï¼Œä¹Ÿå°±æ˜¯å‘é€æ¶ˆæ¯çš„ä¸€æ–¹</li>
<li>consumerï¼šæ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ä¸€æ–¹</li>
<li>queueï¼šé˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯ã€‚ç”Ÿäº§è€…æŠ•é€’çš„æ¶ˆæ¯ä¼šæš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹è€…å¤„ç†</li>
<li>exchangeï¼šäº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±ã€‚ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”±äº¤æ¢æœºå†³å®šæŠ•é€’åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</li>
<li>virtual hostï¼šè™šæ‹Ÿä¸»æœºï¼Œèµ·åˆ°æ•°æ®éš”ç¦»çš„ä½œç”¨ã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºç›¸äº’ç‹¬ç«‹ï¼Œæœ‰å„è‡ªçš„exchangeã€queue</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.4.png" srcset="/img/loading.gif" lazyload></p>
<p>ç”Ÿäº§è€…å‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯ï¼Œåªä¼šè·¯ç”±åˆ°ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå› æ­¤ä»…ä»…åˆ›å»ºé˜Ÿåˆ—æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ä¸äº¤æ¢æœºç»‘å®š</p>
<h3 id="2-2-æ•°æ®éš”ç¦»"><a href="#2-2-æ•°æ®éš”ç¦»" class="headerlink" title="2.2 æ•°æ®éš”ç¦»"></a>2.2 æ•°æ®éš”ç¦»</h3><ul>
<li>ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸åŒçš„virtual hostï¼Œå°†æ¯ä¸ªé¡¹ç›®çš„æ•°æ®éš”ç¦»ã€‚</li>
<li>ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬ç«‹çš„è¿ç»´è´¦å·ï¼Œå°†ç®¡ç†æƒé™åˆ†ç¦»ã€‚</li>
</ul>
<h2 id="3-SpringAMQP"><a href="#3-SpringAMQP" class="headerlink" title="3. SpringAMQP"></a>3. SpringAMQP</h2><h3 id="3-1-å…¥é—¨æ¡ˆä¾‹"><a href="#3-1-å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="3.1 å…¥é—¨æ¡ˆä¾‹"></a>3.1 å…¥é—¨æ¡ˆä¾‹</h3><h4 id="3-1-1-å¼•å…¥ä¾èµ–"><a href="#3-1-1-å¼•å…¥ä¾èµ–" class="headerlink" title="3.1.1 å¼•å…¥ä¾èµ–"></a>3.1.1 å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-æ·»åŠ é…ç½®"><a href="#3-1-2-æ·»åŠ é…ç½®" class="headerlink" title="3.1.2 æ·»åŠ é…ç½®"></a>3.1.2 æ·»åŠ é…ç½®</h4><p>åœ¨publisheræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span> <span class="hljs-comment"># ä½ çš„è™šæ‹ŸæœºIP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span> <span class="hljs-comment"># ç«¯å£</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/hmall</span> <span class="hljs-comment"># è™šæ‹Ÿä¸»æœº</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">hmall</span> <span class="hljs-comment"># ç”¨æˆ·å</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123</span> <span class="hljs-comment"># å¯†ç </span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-3-å‘é€æ¶ˆæ¯"><a href="#3-1-3-å‘é€æ¶ˆæ¯" class="headerlink" title="3.1.3 å‘é€æ¶ˆæ¯"></a>3.1.3 å‘é€æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAmqpTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// é˜Ÿåˆ—åç§°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        <span class="hljs-comment">// æ¶ˆæ¯</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, spring amqp!&quot;</span>;<br>        <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>        rabbitTemplate.convertAndSend(queueName, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-4-æ¥æ”¶æ¶ˆæ¯"><a href="#3-1-4-æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="3.1.4 æ¥æ”¶æ¶ˆæ¯"></a>3.1.4 æ¥æ”¶æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRabbitListener</span> &#123;<br>        <span class="hljs-comment">// åˆ©ç”¨RabbitListeneræ¥å£°æ˜è¦ç›‘å¬çš„é˜Ÿåˆ—ä¿¡æ¯</span><br>    <span class="hljs-comment">// å°†æ¥ä¸€æ—¦ç›‘å¬çš„é˜Ÿåˆ—ä¸­æœ‰äº†æ¶ˆæ¯ï¼Œå°±ä¼šæ¨é€ç»™å½“å‰æœåŠ¡ï¼Œè°ƒç”¨å½“å‰æ–¹æ³•ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span><br>    <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­æ¥æ”¶çš„å°±æ˜¯æ¶ˆæ¯ä½“çš„å†…å®¹</span><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenSimpleQueueMessage</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-WorkQueuesæ¨¡å‹"><a href="#3-2-WorkQueuesæ¨¡å‹" class="headerlink" title="3.2 WorkQueuesæ¨¡å‹"></a>3.2 WorkQueuesæ¨¡å‹</h3><p>è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚å¯ä»¥ä½¿ç”¨WorkQueuesæ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œæ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-1-æ¶ˆæ¯å‘é€"><a href="#3-2-1-æ¶ˆæ¯å‘é€" class="headerlink" title="3.2.1 æ¶ˆæ¯å‘é€"></a>3.2.1 æ¶ˆæ¯å‘é€</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * workQueue</span><br><span class="hljs-comment">     * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWorkQueue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">// é˜Ÿåˆ—åç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, message_&quot;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) &#123;<br>        <span class="hljs-comment">// å‘é€æ¶ˆæ¯ï¼Œæ¯20æ¯«ç§’å‘é€ä¸€æ¬¡ï¼Œç›¸å½“äºæ¯ç§’å‘é€50æ¡æ¶ˆæ¯</span><br>        rabbitTemplate.convertAndSend(queueName, message + i);<br>        Thread.sleep(<span class="hljs-number">20</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-æ¶ˆæ¯æ¥æ”¶"><a href="#3-2-2-æ¶ˆæ¯æ¥æ”¶" class="headerlink" title="3.2.2 æ¶ˆæ¯æ¥æ”¶"></a>3.2.2 æ¶ˆæ¯æ¥æ”¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;work.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenWorkQueue1</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">20</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;work.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenWorkQueue2</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.err.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">200</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¶ˆè´¹è€…1 sleepäº†20æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’é’Ÿå¤„ç†50ä¸ªæ¶ˆæ¯</li>
<li>æ¶ˆè´¹è€…2 sleepäº†200æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’å¤„ç†5ä¸ªæ¶ˆæ¯</li>
</ul>
<h4 id="3-2-3-æµ‹è¯•ç»“æœ"><a href="#3-2-3-æµ‹è¯•ç»“æœ" class="headerlink" title="3.2.3 æµ‹è¯•ç»“æœ"></a>3.2.3 æµ‹è¯•ç»“æœ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java">æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_0ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.869555300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_1ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.884518</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_2ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.907454400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_4ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.953332100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_6ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.997867300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_8ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.042178700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_3ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.086478800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_10ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.087476600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_12ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.132578300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_14ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.175851200</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_16ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.218533400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_18ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.261322900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_5ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.287003700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_20ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.304412400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_22ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.349950100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_24ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.394533900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_26ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.439876500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_28ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.482937800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_7ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.488977100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_30ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.526409300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_32ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.572148</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_34ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.618264800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_36ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.660780600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_9ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.689189300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_38ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.705261</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_40ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.746927300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_42ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.789835</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_44ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.834393100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_46ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.875312100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_11ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.889969500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_48ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.920702500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_13ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.090725900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_15ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.293060600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_17ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.493748</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_19ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.696635100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_21ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.896809700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_23ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.099533400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_25ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.301446400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_27ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.504999100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_29ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.705702500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_31ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.906601200</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_33ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.108118500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_35ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.308945400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_37ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.511547700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_39ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.714038400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_41ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.916192700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_43ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.116286400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_45ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.318055100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_47ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.520656400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_49ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.723106700</span><br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ç«Ÿç„¶æ¯äººæ¶ˆè´¹äº†25æ¡æ¶ˆæ¯ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯</li>
<li>æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚<br>ä¹Ÿå°±æ˜¯è¯´<strong>æ¶ˆæ¯æ˜¯å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…</strong>ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚å¯¼è‡´1ä¸ªæ¶ˆè´¹è€…ç©ºé—²ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…å¿™çš„ä¸å¯å¼€äº¤ã€‚</li>
</ul>
<h4 id="3-2-4-èƒ½è€…å¤šåŠ³é…ç½®"><a href="#3-2-4-èƒ½è€…å¤šåŠ³é…ç½®" class="headerlink" title="3.2.4 èƒ½è€…å¤šåŠ³é…ç½®"></a>3.2.4 èƒ½è€…å¤šåŠ³é…ç½®</h4><p>ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span><br></code></pre></td></tr></table></figure>

<p>å†æ¬¡æµ‹è¯•å‘ç°ï¼Œç”±äºæ¶ˆè´¹è€…1å¤„ç†é€Ÿåº¦è¾ƒå¿«ï¼Œæ‰€ä»¥å¤„ç†äº†æ›´å¤šçš„æ¶ˆæ¯ï¼›æ¶ˆè´¹è€…2å¤„ç†é€Ÿåº¦è¾ƒæ…¢ï¼Œåªå¤„ç†äº†6æ¡æ¶ˆæ¯ã€‚è€Œæœ€ç»ˆæ€»çš„æ‰§è¡Œè€—æ—¶ä¹Ÿåœ¨1ç§’å·¦å³ï¼Œå¤§å¤§æå‡ã€‚<br>æ­£æ‰€è°“èƒ½è€…å¤šåŠ³ï¼Œè¿™æ ·å……åˆ†åˆ©ç”¨äº†æ¯ä¸€ä¸ªæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ¶ˆæ¯ç§¯å‹é—®é¢˜ã€‚</p>
<h4 id="3-2-5-Workæ¨¡å‹æ€»ç»“"><a href="#3-2-5-Workæ¨¡å‹æ€»ç»“" class="headerlink" title="3.2.5 Workæ¨¡å‹æ€»ç»“"></a>3.2.5 Workæ¨¡å‹æ€»ç»“</h4><ul>
<li>å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</li>
<li>é€šè¿‡è®¾ç½®prefetchæ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡</li>
</ul>
<h3 id="3-3-äº¤æ¢æœº"><a href="#3-3-äº¤æ¢æœº" class="headerlink" title="3.3 äº¤æ¢æœº"></a>3.3 äº¤æ¢æœº</h3><p>äº¤æ¢æœºçš„ç±»å‹ï¼š</p>
<ul>
<li>Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—ã€‚æˆ‘ä»¬æœ€æ—©åœ¨æ§åˆ¶å°ä½¿ç”¨çš„æ­£æ˜¯Fanoutäº¤æ¢æœº</li>
<li>Directï¼šè®¢é˜…ï¼ŒåŸºäºRoutingKeyï¼ˆè·¯ç”±keyï¼‰å‘é€ç»™è®¢é˜…äº†æ¶ˆæ¯çš„é˜Ÿåˆ—</li>
<li>Topicï¼šé€šé…ç¬¦è®¢é˜…ï¼Œä¸Directç±»ä¼¼ï¼Œåªä¸è¿‡RoutingKeyå¯ä»¥ä½¿ç”¨é€šé…ç¬¦</li>
</ul>
<h4 id="3-3-1-Fanoutäº¤æ¢æœº"><a href="#3-3-1-Fanoutäº¤æ¢æœº" class="headerlink" title="3.3.1 Fanoutäº¤æ¢æœº"></a>3.3.1 Fanoutäº¤æ¢æœº</h4><p><strong>å¹¿æ’­</strong>äº¤æ¢æœºï¼Œäº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯</p>
<p><img src="/img/blogs/java/springcloud/mq.6.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>æ¶ˆæ¯å‘é€</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFanoutExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.fanout&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, everyone!&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>æ¶ˆæ¯æ¥æ”¶</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFanoutExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.fanout&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, everyone!&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>FanoutExchangeçš„ä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—</li>
</ul>
<h4 id="3-3-2-Directäº¤æ¢æœº"><a href="#3-3-2-Directäº¤æ¢æœº" class="headerlink" title="3.3.2 Directäº¤æ¢æœº"></a>3.3.2 Directäº¤æ¢æœº</h4><p>Directæ¨¡å‹ä¸‹ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦æŒ‡å®šä¸€ä¸ªRoutingKeyï¼ˆè·¯ç”±keyï¼‰</li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹åœ¨ å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ RoutingKeyã€‚</li>
<li>Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„Routing Keyè¿›è¡Œåˆ¤æ–­ï¼Œ<strong>åªæœ‰é˜Ÿåˆ—çš„Routingkeyä¸æ¶ˆæ¯çš„ Routing keyå®Œå…¨ä¸€è‡´</strong>ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.7.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-3-2-1-æ¶ˆæ¯æ¥æ”¶"><a href="#3-3-2-1-æ¶ˆæ¯æ¥æ”¶" class="headerlink" title="3.3.2.1 æ¶ˆæ¯æ¥æ”¶"></a>3.3.2.1 æ¶ˆæ¯æ¥æ”¶</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;direct.queue1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue1</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;direct.queue2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue2</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-3-2-2-æ¶ˆæ¯å‘é€"><a href="#3-3-2-2-æ¶ˆæ¯å‘é€" class="headerlink" title="3.3.2.2 æ¶ˆæ¯å‘é€"></a>3.3.2.2 æ¶ˆæ¯å‘é€</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendDirectExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.direct&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;æœ€æ–°æŠ¥é“ï¼Œå“¥æ–¯æ‹‰æ˜¯å±…æ°‘è‡ªæ²»å·¨å‹æ°”çƒï¼Œè™šæƒŠä¸€åœºï¼&quot;</span>;<br>    <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;blue&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ­¤æ—¶åªæœ‰<code>blue</code>çš„æ¶ˆè´¹è€…æ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…1</p>
<h5 id="3-3-2-3-æ€»ç»“"><a href="#3-3-2-3-æ€»ç»“" class="headerlink" title="3.3.2.3 æ€»ç»“"></a>3.3.2.3 æ€»ç»“</h5><p>Directäº¤æ¢æœºä¸Fanoutäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ</p>
<ul>
<li>Fanoutäº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±ç»™æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li>
<li>Directäº¤æ¢æœºæ ¹æ®RoutingKeyåˆ¤æ–­è·¯ç”±ç»™å“ªä¸ªé˜Ÿåˆ—</li>
<li>å¦‚æœå¤šä¸ªé˜Ÿåˆ—å…·æœ‰ç›¸åŒçš„RoutingKeyï¼Œåˆ™ä¸FanoutåŠŸèƒ½ç±»ä¼¼</li>
</ul>
<h4 id="3-3-3-Topicäº¤æ¢æœº"><a href="#3-3-3-Topicäº¤æ¢æœº" class="headerlink" title="3.3.3 Topicäº¤æ¢æœº"></a>3.3.3 Topicäº¤æ¢æœº</h4><p>Topicç±»å‹çš„Exchangeä¸Directç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—ã€‚<br>åªä¸è¿‡Topicç±»å‹Exchangeå¯ä»¥è®©é˜Ÿåˆ—åœ¨ç»‘å®šBindingKey çš„æ—¶å€™ä½¿ç”¨é€šé…ç¬¦ï¼</p>
<p>é€šé…ç¬¦è§„åˆ™ï¼š</p>
<ul>
<li>#ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯</li>
<li>*ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯</li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<ul>
<li>item.#ï¼šèƒ½å¤ŸåŒ¹é…item.spu.insert æˆ–è€… item.spu</li>
<li>item.*ï¼šåªèƒ½åŒ¹é…item.spu</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.8.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>æ¶ˆæ¯å‘é€</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * topicExchange</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendTopicExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.topic&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;å–œæŠ¥ï¼å­™æ‚Ÿç©ºå¤§æˆ˜å“¥æ–¯æ‹‰ï¼Œèƒœ!&quot;</span>;<br>    <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;china.news&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>æ¶ˆæ¯æ¥æ”¶</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;topic.queue1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenTopicQueue1</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;topic.queue2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenTopicQueue2</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>Directäº¤æ¢æœºä¸Topicäº¤æ¢æœºçš„å·®å¼‚</li>
</ol>
<ul>
<li>Topicäº¤æ¢æœºæ¥æ”¶çš„æ¶ˆæ¯RoutingKeyå¿…é¡»æ˜¯å¤šä¸ªå•è¯ï¼Œä»¥ . åˆ†å‰²</li>
<li>Topicäº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®šæ—¶çš„bindingKeyå¯ä»¥æŒ‡å®šé€šé…ç¬¦</li>
<li>#ï¼šä»£è¡¨0ä¸ªæˆ–å¤šä¸ªè¯</li>
<li>*ï¼šä»£è¡¨1ä¸ªè¯</li>
</ul>
<h3 id="3-4-å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"><a href="#3-4-å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº" class="headerlink" title="3.4 å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"></a>3.4 å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</h3><p>Springæä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span><br><span class="hljs-meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span><br><span class="hljs-meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue1</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-5-æ¶ˆæ¯è½¬æ¢å™¨-JSONè½¬æ¢å™¨"><a href="#3-5-æ¶ˆæ¯è½¬æ¢å™¨-JSONè½¬æ¢å™¨" class="headerlink" title="3.5 æ¶ˆæ¯è½¬æ¢å™¨(JSONè½¬æ¢å™¨)"></a>3.5 æ¶ˆæ¯è½¬æ¢å™¨(JSONè½¬æ¢å™¨)</h3><p>é»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š</p>
<ul>
<li>æ•°æ®ä½“ç§¯è¿‡å¤§</li>
<li>æœ‰å®‰å…¨æ¼æ´</li>
<li>å¯è¯»æ€§å·®</li>
</ul>
<p>å› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<h4 id="3-5-1-å¼•å…¥ä¾èµ–"><a href="#3-5-1-å¼•å…¥ä¾èµ–" class="headerlink" title="3.5.1 å¼•å…¥ä¾èµ–"></a>3.5.1 å¼•å…¥ä¾èµ–</h4><p>åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-é…ç½®æ¶ˆæ¯è½¬æ¢å™¨"><a href="#3-5-2-é…ç½®æ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="3.5.2 é…ç½®æ¶ˆæ¯è½¬æ¢å™¨"></a>3.5.2 é…ç½®æ¶ˆæ¯è½¬æ¢å™¨</h4><p>åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡çš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªBeanå³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</span><br>    <span class="hljs-type">Jackson2JsonMessageConverter</span> <span class="hljs-variable">jackson2JsonMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    <span class="hljs-comment">// 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯</span><br>    jackson2JsonMessageConverter.setCreateMessageIds(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> jackson2JsonMessageConverter;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="3-5-3-æ¥æ”¶æ¶ˆæ¯"><a href="#3-5-3-æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="3.5.3 æ¥æ”¶æ¶ˆæ¯"></a>3.5.3 æ¥æ”¶æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;object.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenSimpleQueueMessage</span><span class="hljs-params">(Map&lt;String, Object&gt; msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°object.queueæ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-MQæ¶ˆæ¯çš„å¯é æ€§"><a href="#4-MQæ¶ˆæ¯çš„å¯é æ€§" class="headerlink" title="4. MQæ¶ˆæ¯çš„å¯é æ€§"></a>4. MQæ¶ˆæ¯çš„å¯é æ€§</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰çš„å¯é æ€§æŒ‡çš„æ˜¯<strong>æ¶ˆæ¯åœ¨ç”Ÿäº§ã€ä¼ è¾“å’Œæ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸¢å¤±ã€ä¸ä¼šé‡å¤ã€ä¸è¢«ç¯¡æ”¹ï¼Œå¹¶ä¸”èƒ½å¤ŸæŒ‰é¢„æœŸè¢«æ­£ç¡®æ¶ˆè´¹</strong>ã€‚ç¡®ä¿ MQ å¯é æ€§å¯¹äºä¿è¯ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§ã€æé«˜ç³»ç»Ÿç¨³å®šæ€§è‡³å…³é‡è¦ã€‚</p>
<p>æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š</p>
<ul>
<li>å‘é€æ¶ˆæ¯æ—¶ä¸¢å¤±ï¼š<ul>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶è¿æ¥MQå¤±è´¥</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°Exchange</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„Exchangeåï¼Œæœªæ‰¾åˆ°åˆé€‚çš„Queue</li>
<li>æ¶ˆæ¯åˆ°è¾¾MQåï¼Œå¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸</li>
</ul>
</li>
<li>MQå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š<ul>
<li>æ¶ˆæ¯åˆ°è¾¾MQï¼Œä¿å­˜åˆ°é˜Ÿåˆ—åï¼Œå°šæœªæ¶ˆè´¹å°±çªç„¶å®•æœº</li>
</ul>
</li>
<li>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶ï¼š<ul>
<li>æ¶ˆæ¯æ¥æ”¶åå°šæœªå¤„ç†çªç„¶å®•æœº</li>
<li>æ¶ˆæ¯æ¥æ”¶åå¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸</li>
</ul>
</li>
</ul>
<h3 id="4-1-å‘é€è€…çš„å¯é æ€§"><a href="#4-1-å‘é€è€…çš„å¯é æ€§" class="headerlink" title="4.1 å‘é€è€…çš„å¯é æ€§"></a>4.1 å‘é€è€…çš„å¯é æ€§</h3><h4 id="4-1-1-ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"><a href="#4-1-1-ç”Ÿäº§è€…é‡è¯•æœºåˆ¶" class="headerlink" title="4.1.1 ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"></a>4.1.1 ç”Ÿäº§è€…é‡è¯•æœºåˆ¶</h4><p>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œå‡ºç°äº†ç½‘ç»œæ•…éšœï¼Œå¯¼è‡´ä¸MQçš„è¿æ¥ä¸­æ–­ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSpringAMQPæä¾›çš„æ¶ˆæ¯å‘é€æ—¶çš„<strong>é‡è¯•æœºåˆ¶ã€‚å³ï¼šå½“RabbitTemplateä¸MQè¿æ¥è¶…æ—¶åï¼Œå¤šæ¬¡é‡è¯•</strong>ã€‚</p>
<p>ä¿®æ”¹publisheræ¨¡å—çš„application.yamlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">connection-timeout:</span> <span class="hljs-string">1s</span> <span class="hljs-comment"># è®¾ç½®MQçš„è¿æ¥è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">retry:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯è¶…æ—¶é‡è¯•æœºåˆ¶</span><br>        <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># å¤±è´¥åçš„åˆå§‹ç­‰å¾…æ—¶é—´</span><br>        <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># å¤±è´¥åä¸‹æ¬¡çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = initial-interval * multiplier</span><br>        <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span><br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šå½“ç½‘ç»œä¸ç¨³å®šçš„æ—¶å€™ï¼Œåˆ©ç”¨é‡è¯•æœºåˆ¶å¯ä»¥æœ‰æ•ˆæé«˜æ¶ˆæ¯å‘é€çš„æˆåŠŸç‡ã€‚ä¸è¿‡SpringAMQPæä¾›çš„<strong>é‡è¯•æœºåˆ¶æ˜¯é˜»å¡å¼çš„é‡è¯•</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šæ¬¡é‡è¯•ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„ã€‚<br>å¦‚æœå¯¹äºä¸šåŠ¡æ€§èƒ½æœ‰è¦æ±‚ï¼Œå»ºè®®ç¦ç”¨é‡è¯•æœºåˆ¶ã€‚å¦‚æœä¸€å®šè¦ä½¿ç”¨ï¼Œè¯·åˆç†é…ç½®ç­‰å¾…æ—¶é•¿å’Œé‡è¯•æ¬¡æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œå‘é€æ¶ˆæ¯çš„ä»£ç ã€‚</p>
<h4 id="4-1-2-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶-ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯"><a href="#4-1-2-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶-ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯" class="headerlink" title="4.1.2 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶(ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯)"></a>4.1.2 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶(ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯)</h4><p>RabbitMQæä¾›äº†ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Publisher Confirmå’ŒPublisher Returnä¸¤ç§ã€‚åœ¨å¼€å¯ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQåï¼ŒMQä¼šæ ¹æ®æ¶ˆæ¯å¤„ç†çš„æƒ…å†µè¿”å›ä¸åŒçš„å›æ‰§ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.9.png" srcset="/img/loading.gif" lazyload></p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å½“æ¶ˆæ¯æŠ•é€’åˆ°MQï¼Œä½†æ˜¯è·¯ç”±å¤±è´¥æ—¶ï¼Œé€šè¿‡Publisher Returnè¿”å›å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ—¶è¿”å›ackçš„ç¡®è®¤ä¿¡æ¯ï¼Œä»£è¡¨æŠ•é€’æˆåŠŸ</li>
<li>ä¸´æ—¶æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜ŸæˆåŠŸï¼Œè¿”å›ACKï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li>
<li>æŒä¹…æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜Ÿå®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›ACK ï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li>
<li>å…¶å®ƒæƒ…å†µéƒ½ä¼šè¿”å›NACKï¼Œå‘ŠçŸ¥æŠ•é€’å¤±è´¥</li>
</ul>
<h5 id="4-1-2-1-å¼€å¯ç”Ÿäº§è€…ç¡®è®¤"><a href="#4-1-2-1-å¼€å¯ç”Ÿäº§è€…ç¡®è®¤" class="headerlink" title="4.1.2.1 å¼€å¯ç”Ÿäº§è€…ç¡®è®¤"></a>4.1.2.1 å¼€å¯ç”Ÿäº§è€…ç¡®è®¤</h5><p>åœ¨publisheræ¨¡å—çš„application.yamlä¸­æ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment"># å¼€å¯publisher confirmæœºåˆ¶ï¼Œå¹¶è®¾ç½®confirmç±»å‹</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯publisher returnæœºåˆ¶</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œpublisher-confirm-typeæœ‰ä¸‰ç§æ¨¡å¼å¯é€‰ï¼š</p>
<ul>
<li>noneï¼šå…³é—­confirmæœºåˆ¶</li>
<li>simpleï¼šåŒæ­¥é˜»å¡ç­‰å¾…MQçš„å›æ‰§</li>
<li>correlatedï¼šMQå¼‚æ­¥å›è°ƒè¿”å›å›æ‰§(æ¨è)</li>
</ul>
<h5 id="4-1-2-2-å®šä¹‰ReturnCallback"><a href="#4-1-2-2-å®šä¹‰ReturnCallback" class="headerlink" title="4.1.2.2 å®šä¹‰ReturnCallback"></a>4.1.2.2 å®šä¹‰ReturnCallback</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>        rabbitTemplate.setReturnsCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnsCallback() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(ReturnedMessage returned)</span> &#123;<br>                log.error(<span class="hljs-string">&quot;è§¦å‘return callback,&quot;</span>);<br>                log.debug(<span class="hljs-string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());<br>                log.debug(<span class="hljs-string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());<br>                log.debug(<span class="hljs-string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());<br>                log.debug(<span class="hljs-string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());<br>                log.debug(<span class="hljs-string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4-1-2-3-å®šä¹‰ConfirmCallback"><a href="#4-1-2-3-å®šä¹‰ConfirmCallback" class="headerlink" title="4.1.2.3 å®šä¹‰ConfirmCallback"></a>4.1.2.3 å®šä¹‰ConfirmCallback</h5><p>CorrelationDataä¸­åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒçš„ä¸œè¥¿ï¼š</p>
<ul>
<li>idï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡ç¤ºï¼ŒMQå¯¹ä¸åŒçš„æ¶ˆæ¯çš„å›æ‰§ä»¥æ­¤åšåˆ¤æ–­ï¼Œé¿å…æ··æ·†</li>
<li>SettableListenableFutureï¼šå›æ‰§ç»“æœçš„Futureå¯¹è±¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPublisherConfirm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºCorrelationData</span><br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">cd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>();<br>    <span class="hljs-comment">// 2.ç»™Futureæ·»åŠ ConfirmCallback</span><br>    cd.getFuture().addCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Throwable ex)</span> &#123;<br>            <span class="hljs-comment">// 2.1.Futureå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¤„ç†é€»è¾‘ï¼ŒåŸºæœ¬ä¸ä¼šè§¦å‘</span><br>            log.error(<span class="hljs-string">&quot;send message fail&quot;</span>, ex);<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(CorrelationData.Confirm result)</span> &#123;<br>            <span class="hljs-comment">// 2.2.Futureæ¥æ”¶åˆ°å›æ‰§çš„å¤„ç†é€»è¾‘ï¼Œå‚æ•°ä¸­çš„resultå°±æ˜¯å›æ‰§å†…å®¹</span><br>            <span class="hljs-keyword">if</span>(result.isAck())&#123; <span class="hljs-comment">// result.isAck()ï¼Œbooleanç±»å‹ï¼Œtrueä»£è¡¨ackå›æ‰§ï¼Œfalse ä»£è¡¨ nackå›æ‰§</span><br>                log.debug(<span class="hljs-string">&quot;å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ”¶åˆ° ack!&quot;</span>);<br>            &#125;<span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">// result.getReason()ï¼ŒStringç±»å‹ï¼Œè¿”å›nackæ—¶çš„å¼‚å¸¸æè¿°</span><br>                log.error(<span class="hljs-string">&quot;å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæ”¶åˆ° nack, reason : &#123;&#125;&quot;</span>, result.getReason());<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-comment">// 3.å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;hmall.direct&quot;</span>, <span class="hljs-string">&quot;q&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>, cd);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-2-MQçš„å¯é æ€§"><a href="#4-2-MQçš„å¯é æ€§" class="headerlink" title="4.2 MQçš„å¯é æ€§"></a>4.2 MQçš„å¯é æ€§</h3><p>æ¶ˆæ¯åˆ°è¾¾MQä»¥åï¼Œå› ä¸º<strong>MQæ˜¯åŸºäºå†…å­˜å­˜å‚¨çš„ï¼Œå¦‚æœå†…å­˜ç©ºé—´è¢«æ¶ˆæ¯å æ»¡ï¼Œå¦‚æœMQä¸èƒ½åŠæ—¶ä¿å­˜ï¼Œä¹Ÿä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</strong><br>æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>æ•°æ®æŒä¹…åŒ–</li>
<li>LazyQueue(æ¨è)</li>
</ul>
<h4 id="4-2-1-æ•°æ®æŒä¹…åŒ–"><a href="#4-2-1-æ•°æ®æŒä¹…åŒ–" class="headerlink" title="4.2.1 æ•°æ®æŒä¹…åŒ–"></a>4.2.1 æ•°æ®æŒä¹…åŒ–</h4><p>ä¸ºäº†æå‡æ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹MQçš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜å­˜å‚¨çš„ä¸´æ—¶æ•°æ®ï¼Œé‡å¯åå°±ä¼šæ¶ˆå¤±ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œå¿…é¡»é…ç½®æ•°æ®æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>äº¤æ¢æœºæŒä¹…åŒ–</li>
<li>é˜Ÿåˆ—æŒä¹…åŒ–</li>
<li>æ¶ˆæ¯æŒä¹…åŒ–</li>
</ul>
<p>åœ¨æ§åˆ¶å°é…ç½®ç›¸å…³çš„æŒä¹…åŒ–æ¨¡å¼ï¼Œå³å¯å¼€å¯æ•°æ®æŒä¹…åŒ–</p>
<h4 id="4-2-2-LazyQueue"><a href="#4-2-2-LazyQueue" class="headerlink" title="4.2.2 LazyQueue"></a>4.2.2 LazyQueue</h4><p>ä»RabbitMQçš„3.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº†Lazy Queuesçš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§é˜Ÿåˆ—ã€‚æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>æ¥æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜</strong></li>
<li>æ¶ˆè´¹è€…è¦<strong>æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜</strong>ï¼ˆä¹Ÿå°±æ˜¯æ‡’åŠ è½½ï¼‰</li>
<li>æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨</li>
</ul>
<p>è€Œåœ¨3.12ç‰ˆæœ¬ä¹‹åï¼ŒLazyQueueå·²ç»æˆä¸ºæ‰€æœ‰é˜Ÿåˆ—çš„é»˜è®¤æ ¼å¼ã€‚å› æ­¤å®˜æ–¹æ¨èå‡çº§MQä¸º3.12ç‰ˆæœ¬æˆ–è€…æ‰€æœ‰é˜Ÿåˆ—éƒ½è®¾ç½®ä¸ºLazyQueueæ¨¡å¼ã€‚</p>
<h3 id="4-3-æ¶ˆè´¹è€…çš„å¯é æ€§"><a href="#4-3-æ¶ˆè´¹è€…çš„å¯é æ€§" class="headerlink" title="4.3 æ¶ˆè´¹è€…çš„å¯é æ€§"></a>4.3 æ¶ˆè´¹è€…çš„å¯é æ€§</h3><p>æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…å¹¶ä¸ä»£è¡¨å°±ä¸€å®šè¢«æ­£ç¡®æ¶ˆè´¹äº†ï¼Œå¯èƒ½å‡ºç°çš„æ•…éšœæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ¶ˆæ¯æŠ•é€’çš„è¿‡ç¨‹ä¸­å‡ºç°äº†ç½‘ç»œæ•…éšœ</li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åçªç„¶å®•æœº</li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œå› å¤„ç†ä¸å½“å¯¼è‡´å¼‚å¸¸</li>
</ul>
<h4 id="4-3-1-æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"><a href="#4-3-1-æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶" class="headerlink" title="4.3.1 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"></a>4.3.1 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶</h4><p>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ç»“æŸåï¼Œåº”è¯¥å‘RabbitMQå‘é€ä¸€ä¸ªå›æ‰§ï¼Œå‘ŠçŸ¥RabbitMQè‡ªå·±æ¶ˆæ¯å¤„ç†çŠ¶æ€ã€‚å›æ‰§æœ‰ä¸‰ç§å¯é€‰å€¼ï¼š</p>
<ul>
<li>ackï¼šæˆåŠŸå¤„ç†æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</li>
<li>nackï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥ï¼ŒRabbitMQéœ€è¦å†æ¬¡æŠ•é€’æ¶ˆæ¯</li>
<li>rejectï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥å¹¶æ‹’ç»è¯¥æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.10.png" srcset="/img/loading.gif" lazyload></p>
<p>SpringAMQPå¸®æˆ‘ä»¬å®ç°äº†æ¶ˆæ¯ç¡®è®¤ã€‚å¹¶å…è®¸æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ACKå¤„ç†æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li>noneï¼šä¸å¤„ç†ã€‚å³æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…åç«‹åˆ»ackï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»ä»MQåˆ é™¤ã€‚éå¸¸ä¸å®‰å…¨ï¼Œä¸å»ºè®®ä½¿ç”¨</li>
<li>manualï¼šæ‰‹åŠ¨æ¨¡å¼ã€‚éœ€è¦è‡ªå·±åœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨apiï¼Œå‘é€ackæˆ–rejectï¼Œå­˜åœ¨ä¸šåŠ¡å…¥ä¾µï¼Œä½†æ›´çµæ´»</li>
<li>autoï¼šè‡ªåŠ¨æ¨¡å¼ã€‚SpringAMQPåˆ©ç”¨AOPå¯¹æˆ‘ä»¬çš„æ¶ˆæ¯å¤„ç†é€»è¾‘åšäº†ç¯ç»•å¢å¼ºï¼Œå½“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œæ—¶åˆ™è‡ªåŠ¨è¿”å›ack.  å½“ä¸šåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸åˆ¤æ–­è¿”å›ä¸åŒç»“æœï¼š<ul>
<li>å¦‚æœæ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œä¼šè‡ªåŠ¨è¿”å›nackï¼›</li>
<li>å¦‚æœæ˜¯æ¶ˆæ¯å¤„ç†æˆ–æ ¡éªŒå¼‚å¸¸ï¼Œè‡ªåŠ¨è¿”å›reject;</li>
</ul>
</li>
</ul>
<p>ä¿®æ”¹SpringAMQPçš„ACKå¤„ç†æ–¹å¼:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">none</span> <span class="hljs-comment"># ä¸åšå¤„ç†</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-å¤±è´¥é‡è¯•æœºåˆ¶"><a href="#4-3-2-å¤±è´¥é‡è¯•æœºåˆ¶" class="headerlink" title="4.3.2 å¤±è´¥é‡è¯•æœºåˆ¶"></a>4.3.2 å¤±è´¥é‡è¯•æœºåˆ¶</h4><p>å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ¶ˆè´¹è€…å†æ¬¡æ‰§è¡Œä¾ç„¶å‡ºé”™ï¼Œæ¶ˆæ¯ä¼šå†æ¬¡requeueåˆ°é˜Ÿåˆ—ï¼Œå†æ¬¡æŠ•é€’ï¼Œç›´åˆ°æ¶ˆæ¯å¤„ç†æˆåŠŸä¸ºæ­¢ã€‚<br>æç«¯æƒ…å†µå°±æ˜¯æ¶ˆè´¹è€…ä¸€ç›´æ— æ³•æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆ<strong>æ¶ˆæ¯requeueå°±ä¼šæ— é™å¾ªç¯</strong>ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ã€‚</p>
<p>ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">retry:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•</span><br>          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’</span><br>          <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval</span><br>          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span><br>          <span class="hljs-attr">stateless:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse</span><br></code></pre></td></tr></table></figure>

<ul>
<li>é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼ŒSpringä¼šè¿”å›rejectï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ</li>
</ul>
<h4 id="4-3-3-å¤±è´¥å¤„ç†ç­–ç•¥"><a href="#4-3-3-å¤±è´¥å¤„ç†ç­–ç•¥" class="headerlink" title="4.3.3 å¤±è´¥å¤„ç†ç­–ç•¥"></a>4.3.3 å¤±è´¥å¤„ç†ç­–ç•¥</h4><p>Springå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°è€—å°½åçš„æ¶ˆæ¯å¤„ç†ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç”±MessageRecoveryæ¥å£æ¥å®šä¹‰çš„ï¼Œå®ƒæœ‰3ä¸ªä¸åŒå®ç°ï¼š</p>
<ul>
<li>RejectAndDontRequeueRecovererï¼šé‡è¯•è€—å°½åï¼Œç›´æ¥rejectï¼Œä¸¢å¼ƒæ¶ˆæ¯ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼ </li>
<li>ImmediateRequeueMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œè¿”å›nackï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ </li>
<li>RepublishMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº (æ¨è)</li>
</ul>
<ul>
<li>RepublishMessageRecoverer: å¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚</li>
</ul>
<p>åœ¨consumeræœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—,å®šä¹‰ä¸€ä¸ªRepublishMessageRecovererï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorMessageConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">errorMessageExchange</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(<span class="hljs-string">&quot;error.direct&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">errorQueue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;error.queue&quot;</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">errorBinding</span><span class="hljs-params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="hljs-string">&quot;error&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageRecoverer <span class="hljs-title function_">republishMessageRecoverer</span><span class="hljs-params">(RabbitTemplate rabbitTemplate)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="hljs-string">&quot;error.direct&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-ä¸šåŠ¡å¹‚ç­‰æ€§"><a href="#4-4-ä¸šåŠ¡å¹‚ç­‰æ€§" class="headerlink" title="4.4 ä¸šåŠ¡å¹‚ç­‰æ€§"></a>4.4 ä¸šåŠ¡å¹‚ç­‰æ€§</h3><p>åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œåˆ™æ˜¯æŒ‡<strong>åŒä¸€ä¸ªä¸šåŠ¡ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡å¯¹ä¸šåŠ¡çŠ¶æ€çš„å½±å“æ˜¯ä¸€è‡´çš„</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>æ ¹æ®idåˆ é™¤æ•°æ®</li>
<li>æŸ¥è¯¢æ•°æ®</li>
<li>æ–°å¢æ•°æ®<br>æ•°æ®çš„æ›´æ–°å¾€å¾€ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœ<strong>é‡å¤æ‰§è¡Œå¯èƒ½é€ æˆä¸ä¸€æ ·çš„åæœ</strong>ã€‚æ¯”å¦‚ï¼š</li>
<li>å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜çš„ä¸šåŠ¡ã€‚å¦‚æœå¤šæ¬¡æ¢å¤å°±ä¼šå‡ºç°åº“å­˜é‡å¤å¢åŠ çš„æƒ…å†µ</li>
<li>é€€æ¬¾ä¸šåŠ¡ã€‚é‡å¤é€€æ¬¾å¯¹å•†å®¶è€Œè¨€ä¼šæœ‰ç»æµæŸå¤±ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬è¦å°½å¯èƒ½é¿å…ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œã€‚</p>
<h4 id="4-4-1-å”¯ä¸€æ¶ˆæ¯ID"><a href="#4-4-1-å”¯ä¸€æ¶ˆæ¯ID" class="headerlink" title="4.4.1 å”¯ä¸€æ¶ˆæ¯ID"></a>4.4.1 å”¯ä¸€æ¶ˆæ¯ID</h4><ol>
<li>æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„idï¼Œä¸æ¶ˆæ¯ä¸€èµ·æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚</li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åå¤„ç†è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸåå°†æ¶ˆæ¯IDä¿å­˜åˆ°æ•°æ®åº“</li>
<li>å¦‚æœä¸‹æ¬¡åˆæ”¶åˆ°ç›¸åŒæ¶ˆæ¯ï¼Œå»æ•°æ®åº“æŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä¸ºé‡å¤æ¶ˆæ¯æ”¾å¼ƒå¤„ç†ã€‚</li>
</ol>
<p>SpringAMQPçš„MessageConverterè‡ªå¸¦äº†MessageIDçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªè¦å¼€å¯è¿™ä¸ªåŠŸèƒ½å³å¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</span><br>    <span class="hljs-type">Jackson2JsonMessageConverter</span> <span class="hljs-variable">jjmc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    <span class="hljs-comment">// 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯</span><br>    jjmc.setCreateMessageIds(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> jjmc;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-ä¸šåŠ¡åˆ¤æ–­"><a href="#4-4-2-ä¸šåŠ¡åˆ¤æ–­" class="headerlink" title="4.4.2 ä¸šåŠ¡åˆ¤æ–­"></a>4.4.2 ä¸šåŠ¡åˆ¤æ–­</h4><p>ä¸šåŠ¡åˆ¤æ–­å°±æ˜¯åŸºäºä¸šåŠ¡æœ¬èº«çš„é€»è¾‘æˆ–çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤çš„è¯·æ±‚æˆ–æ¶ˆæ¯ã€‚<br>å½“å‰æ¡ˆä¾‹ä¸­ï¼Œå¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘æ˜¯æŠŠè®¢å•çŠ¶æ€ä»æœªæ”¯ä»˜ä¿®æ”¹ä¸ºå·²æ”¯ä»˜ã€‚å› æ­¤æˆ‘ä»¬å°±å¯ä»¥<strong>åœ¨æ‰§è¡Œä¸šåŠ¡æ—¶åˆ¤æ–­è®¢å•çŠ¶æ€æ˜¯å¦æ˜¯æœªæ”¯ä»˜</strong>ï¼Œå¦‚æœä¸æ˜¯åˆ™è¯æ˜è®¢å•å·²ç»è¢«å¤„ç†è¿‡ï¼Œæ— éœ€é‡å¤å¤„ç†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.11.png" srcset="/img/loading.gif" lazyload></p>
<p>ä»¥æ”¯ä»˜ä¿®æ”¹è®¢å•çš„ä¸šåŠ¡ä¸ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markOrderPaySuccess</span><span class="hljs-params">(Long orderId)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢è®¢å•</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> getById(orderId);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­è®¢å•çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (old == <span class="hljs-literal">null</span> || old.getStatus() != <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// è®¢å•ä¸å­˜åœ¨æˆ–è€…è®¢å•çŠ¶æ€ä¸æ˜¯1ï¼Œæ”¾å¼ƒå¤„ç†</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 3.å°è¯•æ›´æ–°è®¢å•</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    order.setId(orderId);<br>    order.setStatus(<span class="hljs-number">2</span>);<br>    order.setPayTime(LocalDateTime.now());<br>    updateById(order);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-5-å…œåº•æ–¹æ¡ˆ"><a href="#4-5-å…œåº•æ–¹æ¡ˆ" class="headerlink" title="4.5 å…œåº•æ–¹æ¡ˆ"></a>4.5 å…œåº•æ–¹æ¡ˆ</h3><p>è™½ç„¶æˆ‘ä»¬åˆ©ç”¨å„ç§æœºåˆ¶å°½å¯èƒ½å¢åŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†ä¹Ÿä¸å¥½è¯´èƒ½ä¿è¯æ¶ˆæ¯100%çš„å¯é ã€‚ä¸‡ä¸€çœŸçš„MQé€šçŸ¥å¤±è´¥è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæœ‰æ²¡æœ‰å…¶å®ƒå…œåº•æ–¹æ¡ˆï¼Œèƒ½å¤Ÿç¡®ä¿è®¢å•çš„æ”¯ä»˜çŠ¶æ€ä¸€è‡´å‘¢ï¼Ÿ</p>
<p>æ—¢ç„¶MQé€šçŸ¥ä¸ä¸€å®šå‘é€åˆ°äº¤æ˜“æœåŠ¡ï¼Œé‚£ä¹ˆ<strong>äº¤æ˜“æœåŠ¡å°±å¿…é¡»è‡ªå·±ä¸»åŠ¨å»æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</strong>ã€‚è¿™æ ·å³ä¾¿æ”¯ä»˜æœåŠ¡çš„MQé€šçŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬ä¾ç„¶èƒ½<strong>é€šè¿‡ä¸»åŠ¨æŸ¥è¯¢æ¥ä¿è¯è®¢å•çŠ¶æ€çš„ä¸€è‡´</strong>ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.12.png" srcset="/img/loading.gif" lazyload></p>
<p>é€šå¸¸æˆ‘ä»¬é‡‡å–çš„æªæ–½å°±æ˜¯åˆ©ç”¨<strong>å®šæ—¶ä»»åŠ¡å®šæœŸæŸ¥è¯¢</strong>ï¼Œä¾‹å¦‚æ¯éš”20ç§’å°±æŸ¥è¯¢ä¸€æ¬¡ï¼Œ<strong>å¹¶åˆ¤æ–­æ”¯ä»˜çŠ¶æ€</strong>ã€‚å¦‚æœå‘ç°è®¢å•å·²ç»æ”¯ä»˜ï¼Œåˆ™ç«‹åˆ»æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜å³å¯ã€‚</p>
<h3 id="4-6-æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"><a href="#4-6-æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ" class="headerlink" title="4.6 æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"></a>4.6 æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ</h3><ul>
<li>é¦–å…ˆï¼Œæ”¯ä»˜æœåŠ¡ä¼šæ­£åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸä»¥ååˆ©ç”¨MQæ¶ˆæ¯é€šçŸ¥äº¤æ˜“æœåŠ¡ï¼Œå®Œæˆè®¢å•çŠ¶æ€åŒæ­¥ã€‚</li>
<li>å…¶æ¬¡ï¼Œä¸ºäº†ä¿è¯MQæ¶ˆæ¯çš„å¯é æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ã€æ¶ˆè´¹è€…ç¡®è®¤ã€æ¶ˆè´¹è€…å¤±è´¥é‡è¯•ç­‰ç­–ç•¥ï¼Œç¡®ä¿æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§</li>
<li>æœ€åï¼Œæˆ‘ä»¬è¿˜åœ¨äº¤æ˜“æœåŠ¡è®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ã€‚è¿™æ ·å³ä¾¿MQé€šçŸ¥å¤±è´¥ï¼Œè¿˜å¯ä»¥åˆ©ç”¨å®šæ—¶ä»»åŠ¡ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿è®¢å•æ”¯ä»˜çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
</ul>
<h2 id="5-å»¶è¿Ÿæ¶ˆæ¯"><a href="#5-å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="5. å»¶è¿Ÿæ¶ˆæ¯"></a>5. å»¶è¿Ÿæ¶ˆæ¯</h2><p>å¯¹äºè¶…è¿‡ä¸€å®šæ—¶é—´æœªæ”¯ä»˜çš„è®¢å•ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾å ç”¨çš„åº“å­˜ã€‚åƒè¿™ç§<strong>åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ‰æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå»¶è¿Ÿä»»åŠ¡</strong>ï¼Œè€Œè¦å®ç°å»¶è¿Ÿä»»åŠ¡ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ©ç”¨MQçš„å»¶è¿Ÿæ¶ˆæ¯äº†ã€‚</p>
<p>åœ¨RabbitMQä¸­å®ç°å»¶è¿Ÿæ¶ˆæ¯ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ul>
<li>æ­»ä¿¡äº¤æ¢æœº+TTL</li>
<li>å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶(æ¨è)</li>
</ul>
<h3 id="5-1-æ­»ä¿¡äº¤æ¢æœº"><a href="#5-1-æ­»ä¿¡äº¤æ¢æœº" class="headerlink" title="5.1 æ­»ä¿¡äº¤æ¢æœº"></a>5.1 æ­»ä¿¡äº¤æ¢æœº</h3><p>å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…ä½¿ç”¨basic.rejectæˆ– basic.nackå£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„requeueå‚æ•°è®¾ç½®ä¸ºfalse</li>
<li>æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹</li>
<li>è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.13.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>åˆ©ç”¨ TTL è®©æ¶ˆæ¯åœ¨æ™®é€šé˜Ÿåˆ—ä¸­å»¶è¿Ÿä¸€æ®µæ—¶é—´ã€‚</li>
<li>è¶…æ—¶åï¼Œæ¶ˆæ¯è¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Œå†è½¬å‘åˆ°çœŸæ­£çš„ç›®æ ‡é˜Ÿåˆ—ã€‚</li>
<li>æ¶ˆè´¹è€…ç›‘å¬ç›®æ ‡é˜Ÿåˆ—ï¼Œå»¶è¿Ÿæ—¶é—´ä¸€åˆ°ï¼Œæ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="5-2-DelayExchangeæ’ä»¶-æ¨è"><a href="#5-2-DelayExchangeæ’ä»¶-æ¨è" class="headerlink" title="5.2 DelayExchangeæ’ä»¶(æ¨è)"></a>5.2 DelayExchangeæ’ä»¶(æ¨è)</h3><p>RabbitMQç¤¾åŒºæä¾›äº†ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶æ¥å®ç°ç›¸åŒçš„æ•ˆæœ</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">æ’ä»¶ä¸‹è½½åœ°å€</a></p>
<p><strong>å£°æ˜å»¶è¿Ÿäº¤æ¢æœº</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span><br><span class="hljs-meta">        key = &quot;delay&quot;</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDelayMessage</span><span class="hljs-params">(String msg)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;æ¥æ”¶åˆ°delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, msg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPublisherDelayMessage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºæ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, delayed message&quot;</span>;<br>    <span class="hljs-comment">// 2.å‘é€æ¶ˆæ¯ï¼Œåˆ©ç”¨æ¶ˆæ¯åç½®å¤„ç†å™¨æ·»åŠ æ¶ˆæ¯å¤´</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;delay.direct&quot;</span>, <span class="hljs-string">&quot;delay&quot;</span>, message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>            <span class="hljs-comment">// æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯å±æ€§</span><br>            message.getMessageProperties().setDelay(<span class="hljs-number">5000</span>);<br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å †ç§¯çš„å»¶è¿Ÿæ¶ˆæ¯éå¸¸å¤šï¼Œä¼šå¸¦æ¥è¾ƒå¤§çš„CPUå¼€é”€ï¼Œä¸å»ºè®®è®¾ç½®å»¶è¿Ÿæ—¶é—´è¿‡é•¿çš„å»¶è¿Ÿæ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="5-3-è¶…æ—¶è®¢å•é—®é¢˜"><a href="#5-3-è¶…æ—¶è®¢å•é—®é¢˜" class="headerlink" title="5.3 è¶…æ—¶è®¢å•é—®é¢˜"></a>5.3 è¶…æ—¶è®¢å•é—®é¢˜</h3><p>ç”¨æˆ·ä¸‹å•å®Œæˆå,å‘é€15åˆ†é’Ÿå»¶è¿Ÿæ¶ˆæ¯,åœ¨15åˆ†é’Ÿåæ¥æ”¶æ¶ˆæ¯,æ£€æŸ¥æ”¯ä»˜çŠ¶æ€:</p>
<ul>
<li>å·²æ”¯ä»˜:æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</li>
<li>æœªæ”¯ä»˜:æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå…³é—­è®¢å•,æ¢å¤å•†å“åº“å­˜</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.14.png" srcset="/img/loading.gif" lazyload></p>
<p>å‚è€ƒæ–‡çŒ®ï¼š<a target="_blank" rel="noopener" href="https://b11et3un53m.feishu.cn/wiki/OQH4weMbcimUSLkIzD6cCpN0nvc">https://b11et3un53m.feishu.cn/wiki/OQH4weMbcimUSLkIzD6cCpN0nvc</a></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/SpringCloud/" class="category-chain-item">SpringCloud</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="print-no-link">#å­¦ä¹ </a>
      
        <a href="/tags/SpringCloud/" class="print-no-link">#SpringCloud</a>
      
        <a href="/tags/RabbitMQ/" class="print-no-link">#RabbitMQ</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/03/08/JAVA/SpringCloud/Elasticsearch/" title="Elasticsearchå­¦ä¹ ç¬”è®°">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Elasticsearchå­¦ä¹ ç¬”è®°</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/05/JAVA/SpringCloud/Docker/" title="Dockerå­¦ä¹ ç¬”è®°">
                        <span class="hidden-mobile">Dockerå­¦ä¹ ç¬”è®°</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"sj2tGuxMGSDhkN5hNuOIVta1-gzGzoHsz","appKey":"ysR5OTuTzoby2oNvNyGOtXFQ","path":"window.location.pathname","placeholder":"å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>AI</span> <i class="iconfont icon-love"></i> <span>CPP</span> <i class="iconfont icon-love"></i> <span>JAVA</span> <i class="iconfont icon-love"></i> <span>CyberSec</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
