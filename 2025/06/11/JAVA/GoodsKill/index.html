

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/about/dogs.jpg">
  <link rel="icon" href="/img/about/dogs.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ranzier">
  <meta name="keywords" content="">
  
    <meta name="description" content="å•†å“ç§’æ€(GoodsKill)  æœ¬æ–‡å¯¹githubå•†å“ç§’æ€é¡¹ç›®è¿›è¡Œé¡¹ç›®æ‹†è§£åˆ†æå’Œä»£ç è¯¦è§£ï¼Œä»è€Œå­¦ä¹ å¾®æœåŠ¡çš„çŸ¥è¯†ã€‹ã€‚ã€‚(å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»æˆ‘åˆ é™¤) é¡¹ç›®åœ°å€ï¼šgoodsKill 1. é¡¹ç›®æ¨¡å—æ€»è§ˆ123456789101112131415goodsKill|--goodskill-admin                          ||SpringBoot Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpr">
<meta property="og:type" content="article">
<meta property="og:title" content="GoodsKillé¡¹ç›®åˆ†æåŠäº®ç‚¹è§£æ">
<meta property="og:url" content="http://example.com/2025/06/11/JAVA/GoodsKill/index.html">
<meta property="og:site_name" content="RANZIER">
<meta property="og:description" content="å•†å“ç§’æ€(GoodsKill)  æœ¬æ–‡å¯¹githubå•†å“ç§’æ€é¡¹ç›®è¿›è¡Œé¡¹ç›®æ‹†è§£åˆ†æå’Œä»£ç è¯¦è§£ï¼Œä»è€Œå­¦ä¹ å¾®æœåŠ¡çš„çŸ¥è¯†ã€‹ã€‚ã€‚(å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»æˆ‘åˆ é™¤) é¡¹ç›®åœ°å€ï¼šgoodsKill 1. é¡¹ç›®æ¨¡å—æ€»è§ˆ123456789101112131415goodsKill|--goodskill-admin                          ||SpringBoot Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpr">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg/38.jpg">
<meta property="article:published_time" content="2025-06-11T14:01:29.000Z">
<meta property="article:modified_time" content="2025-10-14T08:08:19.722Z">
<meta property="article:author" content="ranzier">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="SpringCloud">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/bg/38.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>GoodsKillé¡¹ç›®åˆ†æåŠäº®ç‚¹è§£æ - RANZIER</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">
<link rel="stylesheet" href="/css/bubble.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸŒŸ","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RANZIER</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.35)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="GoodsKillé¡¹ç›®åˆ†æåŠäº®ç‚¹è§£æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-06-11 22:01" pubdate>
          2025å¹´6æœˆ11æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          38k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          189 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          æœ¬æ–‡é˜…è¯»æ¬¡æ•°ï¼š<span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">GoodsKillé¡¹ç›®åˆ†æåŠäº®ç‚¹è§£æ</h1>
            
            
              <div class="markdown-body">
                
                <h1 align="center">å•†å“ç§’æ€(GoodsKill)</h1>

<p>æœ¬æ–‡å¯¹githubå•†å“ç§’æ€é¡¹ç›®è¿›è¡Œé¡¹ç›®æ‹†è§£åˆ†æå’Œä»£ç è¯¦è§£ï¼Œä»è€Œå­¦ä¹ å¾®æœåŠ¡çš„çŸ¥è¯†ã€‹ã€‚ã€‚(<strong>å¦‚æœ‰ä¾µæƒï¼Œè¯·è”ç³»æˆ‘åˆ é™¤</strong>)</p>
<p>é¡¹ç›®åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/techa03/goodsKill">goodsKill</a></p>
<h1 id="1-é¡¹ç›®æ¨¡å—æ€»è§ˆ"><a href="#1-é¡¹ç›®æ¨¡å—æ€»è§ˆ" class="headerlink" title="1. é¡¹ç›®æ¨¡å—æ€»è§ˆ"></a>1. é¡¹ç›®æ¨¡å—æ€»è§ˆ</h1><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">goodsKill<br>|<span class="hljs-string">--goodskill-admin                          </span>||<span class="hljs-string">SpringBoot Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpring Cloudå¾®æœåŠ¡å‘ç°</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-ai                             </span>||<span class="hljs-string">AIæœºå™¨äººèŠå¤©æœåŠ¡</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-gateway                        </span>||<span class="hljs-string">å¾®æœåŠ¡APIç½‘å…³ï¼Œç»Ÿä¸€æœåŠ¡é‰´æƒï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-order-provider                 </span>||<span class="hljs-string">è®¢å•æœåŠ¡æä¾›è€…</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-seckill-provider               </span>||<span class="hljs-string">ç§’æ€æœåŠ¡æä¾›è€…</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-spring-boot-starter            </span>||<span class="hljs-string">é¡¹ç›®é…ç½®è‡ªåŠ¨è£…é…</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-common                         </span>||<span class="hljs-string">å…¬å…±æœåŠ¡(ç›®å‰åŒ…å«minioä¸Šä¼ ä¸‹è½½åŠŸèƒ½)</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-web                            </span>||<span class="hljs-string">æä¾›ç§’æ€æ¨¡æ‹Ÿæ¥å£è®¿é—®</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-job                            </span>||<span class="hljs-string">elastic-jobå®šæ—¶ä»»åŠ¡</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-seata                          </span>||<span class="hljs-string">é›†æˆnacos+dubbo+shardingjdbc+seataçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆç¤ºä¾‹</span><br><span class="hljs-string"></span>|<span class="hljs-string">--goodskill-auth                           </span>||<span class="hljs-string">authç™»å½•ä»¥åŠæˆæƒæ¨¡å—</span><br><span class="hljs-string"></span>|<span class="hljs-string">   </span>|<span class="hljs-string">--auth-service                         </span>||<span class="hljs-string">åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡</span><br><span class="hljs-string">    </span>|<span class="hljs-string">--oauth2-auth-server                   </span>||<span class="hljs-string">oauth2.0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡</span><br><span class="hljs-string">    </span>|<span class="hljs-string">--oauth2-resource-server               </span>||<span class="hljs-string">oauth2.0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡</span><br></code></pre></td></tr></table></figure>

<h1 id="2-goodskill-order-provider-è®¢å•æœåŠ¡æä¾›è€…"><a href="#2-goodskill-order-provider-è®¢å•æœåŠ¡æä¾›è€…" class="headerlink" title="2. goodskill-order-provider (è®¢å•æœåŠ¡æä¾›è€…)"></a>2. goodskill-order-provider (è®¢å•æœåŠ¡æä¾›è€…)</h1><p>åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>goodskill-order-api</li>
<li>goodskill-order-service</li>
</ul>
<h2 id="2-1-goodskill-order-api"><a href="#2-1-goodskill-order-api" class="headerlink" title="2.1 goodskill-order-api"></a>2.1 goodskill-order-api</h2><p><img src="/img/blogs/java/goodskill/2.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>OrderServiceæ¥å£åŠå…¶å®ç°ç±»</strong>ï¼š</p>
<ul>
<li>OrderServiceæ¥å£</li>
<li>OrderServiceFallbackå®ç°ç±»</li>
</ul>
<p>åŸºäº Spring Cloud OpenFeign å®ç°çš„ <strong>è®¢å•å¾®æœåŠ¡ (goodskill-order) è¿œç¨‹è°ƒç”¨æ¥å£</strong>ï¼Œå¹¶æä¾›äº† <strong>ç†”æ–­é™çº§å¤„ç†</strong>ã€‚<br>å®ƒçš„ä½œç”¨æ˜¯è®©å…¶ä»–å¾®æœåŠ¡ï¼ˆæ¯”å¦‚ goodskill-seckill-providerï¼‰å¯ä»¥é€šè¿‡ FeignClient è¿œç¨‹è°ƒç”¨è®¢å•æœåŠ¡ï¼Œå¹¶åœ¨æœåŠ¡ä¸å¯ç”¨æ—¶æä¾›é™çº§ç­–ç•¥ã€‚</p>
<h4 id="OrderServiceæ¥å£"><a href="#OrderServiceæ¥å£" class="headerlink" title="OrderServiceæ¥å£"></a>OrderServiceæ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">æŒ‡å®šè°ƒç”¨çš„å¾®æœåŠ¡åç§°ï¼šgoodskill-order</span><br><span class="hljs-comment">è®¾ç½®ç†”æ–­é™çº§å®ç°ç±»ï¼šOrderServiceFallback</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;goodskill-order&quot;, fallback = OrderServiceFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> &#123;<br><br>    <span class="hljs-comment">//è°ƒç”¨ goodskill-order æœåŠ¡çš„ /deleteRecord æ¥å£ï¼Œåˆ é™¤ç§’æ€è®¢å•</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/deleteRecord&quot;)</span><br>    Boolean <span class="hljs-title function_">deleteRecord</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span>;<br><br>    <span class="hljs-comment">//è°ƒç”¨ goodskill-order æœåŠ¡çš„ /saveRecord æ¥å£ï¼Œä¿å­˜è®¢å•è®°å½•ã€‚</span><br>    <span class="hljs-meta">@PostMapping(&quot;/saveRecord&quot;)</span><br>    Boolean <span class="hljs-title function_">saveRecord</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> OrderDTO orderDTO)</span>;<br><br>    <span class="hljs-comment">//è°ƒç”¨ goodskill-order æœåŠ¡çš„ /count æ¥å£ï¼ŒæŸ¥è¯¢æŸä¸ª seckillId çš„ è®¢å•æ•°é‡ã€‚</span><br>    <span class="hljs-meta">@GetMapping(&quot;/count&quot;)</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">count</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æŒ‡å®š<strong>è°ƒç”¨çš„å¾®æœåŠ¡åç§°ï¼šgoodskill-order</strong></li>
<li>è®¾ç½®<strong>ç†”æ–­é™çº§å®ç°ç±»ï¼šOrderServiceFallback</strong></li>
<li>è¿™æ„å‘³ç€å½“ goodskill-order æœåŠ¡ ä¸å¯ç”¨ æ—¶ï¼Œè°ƒç”¨ OrderServiceFallback é‡Œçš„æ–¹æ³•<strong>è¿”å›é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯è®©è¯·æ±‚ç›´æ¥å¤±è´¥</strong>ã€‚</li>
</ul>
<p>æ¥å£ä¸­ï¼š<strong>å®šä¹‰è¿œç¨‹è°ƒç”¨çš„ API</strong></p>
<ul>
<li>è°ƒç”¨ goodskill-order æœåŠ¡çš„ &#x2F;deleteRecord æ¥å£ï¼Œåˆ é™¤ç§’æ€è®¢å•</li>
<li>è°ƒç”¨ goodskill-order æœåŠ¡çš„ &#x2F;saveRecord æ¥å£ï¼Œä¿å­˜è®¢å•è®°å½•ã€‚</li>
<li>è°ƒç”¨ goodskill-order æœåŠ¡çš„ &#x2F;count æ¥å£ï¼ŒæŸ¥è¯¢æŸä¸ª seckillId çš„ è®¢å•æ•°é‡ã€‚</li>
</ul>
<h4 id="OrderServiceFallbackï¼ˆç†”æ–­é™çº§å®ç°ç±»ï¼‰"><a href="#OrderServiceFallbackï¼ˆç†”æ–­é™çº§å®ç°ç±»ï¼‰" class="headerlink" title="OrderServiceFallbackï¼ˆç†”æ–­é™çº§å®ç°ç±»ï¼‰"></a>OrderServiceFallbackï¼ˆç†”æ–­é™çº§å®ç°ç±»ï¼‰</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">ç†”æ–­é™çº§å®ç°ç±»ï¼šOrderServiceFallback</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-comment">//é™çº§ç­–ç•¥ï¼šå½“ deleteRecord() è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºåˆ é™¤å¤±è´¥ã€‚</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deleteRecord</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//é™çº§ç­–ç•¥ï¼šå½“ saveRecord() è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºè®¢å•ä¿å­˜å¤±è´¥ã€‚</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">saveRecord</span><span class="hljs-params">(OrderDTO orderDTO)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//é™çº§ç­–ç•¥ï¼šcount() æ–¹æ³•åœ¨é™çº§æ—¶ æŠ›å‡ºå¼‚å¸¸ï¼Œè¡¨ç¤ºæ­¤æ¥å£ä¸æä¾›å¤‡ç”¨æ–¹æ¡ˆã€‚</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">count</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NoFallbackAvailableException</span>(<span class="hljs-string">&quot;Boom!&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>é™çº§ç­–ç•¥ï¼š</p>
<ul>
<li>å½“ deleteRecord() è°ƒç”¨å¤±è´¥æ—¶ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºåˆ é™¤å¤±è´¥ã€‚</li>
<li>count() æ–¹æ³•åœ¨é™çº§æ—¶ æŠ›å‡ºå¼‚å¸¸ï¼Œè¡¨ç¤ºæ­¤æ¥å£ä¸æä¾›å¤‡ç”¨æ–¹æ¡ˆã€‚</li>
</ul>
<h2 id="2-2-goodskill-order-service"><a href="#2-2-goodskill-order-service" class="headerlink" title="2.2 goodskill-order-service"></a>2.2 goodskill-order-service</h2><p><img src="/img/blogs/java/goodskill/2.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-1-OrderApplicationå¯åŠ¨ç±»"><a href="#2-2-1-OrderApplicationå¯åŠ¨ç±»" class="headerlink" title="2.2.1 OrderApplicationå¯åŠ¨ç±»"></a>2.2.1 OrderApplicationå¯åŠ¨ç±»</h3><p>è®¢å•å¾®æœåŠ¡ï¼ˆgoodskill-order-providerï¼‰çš„å¯åŠ¨ç±» OrderApplicationï¼Œä½¿ç”¨çš„æ˜¯ Spring Boot + MongoDB + æ¶ˆæ¯é©±åŠ¨æ¨¡å‹ï¼ˆç±»ä¼¼ Stream æ¶ˆè´¹ï¼‰ã€‚</p>
<ul>
<li>å®ç°ï¼šç›‘å¬åä¸º seckillMongoSave çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆæˆ–é€šé“ï¼‰ï¼Œ<strong>æ¥æ”¶ç§’æ€è¯·æ±‚ä¿¡æ¯</strong> SeckillMockSaveVoï¼Œç„¶å<strong>å°è£…ä¸º OrderDTO å¯¹è±¡å¹¶å­˜å…¥ MongoDB</strong>ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.goodskill.order&quot;, &quot;com.goodskill.core&quot;&#125;)</span><br><span class="hljs-meta">@EnableMongoRepositories(basePackages = &quot;com.goodskill.order.repository&quot;)</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderApplication</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderServiceImpl mongoService;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplicationBuilder</span>(OrderApplication.class)<br>                .web(WebApplicationType.SERVLET)<br>                .registerShutdownHook(<span class="hljs-literal">true</span>)<br>                .run(args);<br>    &#125;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    å®šä¹‰ Beanï¼šç›‘å¬æ¶ˆæ¯é€šé“ seckillMongoSave</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Consumer&lt;SeckillMockSaveVo&gt; <span class="hljs-title function_">seckillMongoSave</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> it -&gt; &#123;<br>            log.info(<span class="hljs-string">&quot;æ¥æ”¶åˆ°æ¶ˆæ¯:&#123;&#125;&quot;</span>, it);<br>            <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>();<br>            orderDTO.setSeckillId(BigInteger.valueOf(it.getSeckillId()));<br>            orderDTO.setUserPhone(it.getUserPhone());<br>            orderDTO.setCreateTime(LocalDateTime.now());<br>            mongoService.saveRecord(orderDTO);<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å¯åŠ¨è®¢å•æœåŠ¡ï¼ˆåŸºäº Spring Bootï¼‰</li>
<li>å¯ç”¨ MongoDB çš„ä»“åº“æ”¯æŒ</li>
<li>ç›‘å¬åä¸º seckillMongoSave çš„æ¶ˆæ¯é€šé“</li>
<li>æ¯å½“æœ‰ç”¨æˆ·ç§’æ€è¯·æ±‚ï¼ˆå¦‚å‹æµ‹æ¨¡æ‹Ÿæ•°æ®ï¼‰é€šè¿‡æ¶ˆæ¯ä¸­é—´ä»¶å‘æ¥æ—¶ï¼š<ul>
<li>æ¥æ”¶æ¶ˆæ¯</li>
<li>æ„å»ºè®¢å•å¯¹è±¡ OrderDTO</li>
<li>è°ƒç”¨ OrderServiceImpl å°†å…¶ä¿å­˜è‡³ MongoDB</li>
</ul>
</li>
</ul>
<h3 id="2-2-2-è®¢å•å¾®æœåŠ¡çš„æ¥å£å’Œå®ç°ç±»"><a href="#2-2-2-è®¢å•å¾®æœåŠ¡çš„æ¥å£å’Œå®ç°ç±»" class="headerlink" title="2.2.2 è®¢å•å¾®æœåŠ¡çš„æ¥å£å’Œå®ç°ç±»"></a>2.2.2 è®¢å•å¾®æœåŠ¡çš„æ¥å£å’Œå®ç°ç±»</h3><ul>
<li>OrderController</li>
<li>OrderRepository</li>
<li>OrderServiceImpl</li>
</ul>
<h4 id="OrderController"><a href="#OrderController" class="headerlink" title="OrderController"></a>OrderController</h4><p>OrderController æ˜¯è®¢å•æ¨¡å—ï¼ˆgoodskill-order-providerï¼‰çš„ä¸€ä¸ª REST æ§åˆ¶å™¨ç±»ï¼Œç”¨äºæä¾›å¯¹è®¢å•çš„ åŸºç¡€å¢åˆ æŸ¥æ¥å£ï¼Œä¸»è¦æ˜¯ä¾›å†…éƒ¨æœåŠ¡æˆ–å…¶ä»–å¾®æœåŠ¡è°ƒç”¨ï¼Œæ¯”å¦‚ç§’æ€æœåŠ¡ã€å‰ç«¯ç®¡ç†ç³»ç»Ÿç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">æä¾›äº† è®¢å•è®°å½•çš„æ–°å¢ã€åˆ é™¤ã€ç»Ÿè®¡æŸ¥è¯¢çš„ HTTP æ¥å£</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderController</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderServiceImpl orderService;<br><br>    <span class="hljs-meta">@DeleteMapping(&quot;/deleteRecord&quot;)</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deleteRecord</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderService.deleteRecord(seckillId);<br>    &#125;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/saveRecord&quot;)</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">saveRecord</span><span class="hljs-params">(OrderDTO orderDTO)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderService.saveRecord(orderDTO);<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/count&quot;)</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">count</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderService.count(seckillId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>åŠŸèƒ½è¯´æ˜</th>
<th>è¯·æ±‚æ–¹å¼</th>
<th>è·¯å¾„</th>
</tr>
</thead>
<tbody><tr>
<td>deleteRecord</td>
<td>åˆ é™¤æŸä¸ªç§’æ€IDçš„è®¢å•è®°å½•</td>
<td>DELETE</td>
<td>&#x2F;deleteRecord</td>
</tr>
<tr>
<td>saveRecord</td>
<td>ä¿å­˜è®¢å•è®°å½•</td>
<td>POST</td>
<td>&#x2F;saveRecord</td>
</tr>
<tr>
<td>count</td>
<td>æŸ¥è¯¢æŸæ´»åŠ¨çš„è®¢å•æ€»æ•°</td>
<td>GET</td>
<td>&#x2F;count</td>
</tr>
</tbody></table>
<h4 id="OrderRepositoryæ¥å£"><a href="#OrderRepositoryæ¥å£" class="headerlink" title="OrderRepositoryæ¥å£"></a>OrderRepositoryæ¥å£</h4><p>OrderRepository æ¥å£æ˜¯è®¢å•æœåŠ¡ä¸­ç”¨äº <strong>æ“ä½œ MongoDB çš„æ•°æ®è®¿é—®å±‚</strong>ï¼ˆDAOï¼‰ï¼Œå®ƒç»§æ‰¿è‡ª Spring Data MongoDB æä¾›çš„ MongoRepositoryï¼Œè®©ä½ å‡ ä¹ä¸ç”¨å†™ SQL&#x2F;æŸ¥è¯¢è¯­å¥ï¼Œå°±å¯ä»¥å®ç°å¯¹ Order å®ä½“çš„ CRUD æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MongoRepository</span>&lt;Order, String&gt; &#123;<br><br>    <span class="hljs-comment">//æ ¹æ® seckillId åˆ é™¤æ‰€æœ‰å¯¹åº”çš„è®¢å•è®°å½•</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBySeckillId</span><span class="hljs-params">(BigInteger seckillId)</span>;<br><br>    <span class="hljs-comment">//ç»Ÿè®¡æŸä¸ªç§’æ€æ´»åŠ¨å¯¹åº”çš„è®¢å•æ•°é‡</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">countBySeckillId</span><span class="hljs-params">(BigInteger seckillId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ¥å£æ˜¯ æ“ä½œ MongoDB çš„æ ¸å¿ƒ DAO æ¥å£ï¼ŒåŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>deleteBySeckillId()</td>
<td>åˆ é™¤æŸä¸ªæ´»åŠ¨ä¸‹çš„è®¢å•è®°å½•</td>
</tr>
<tr>
<td>countBySeckillId()</td>
<td>ç»Ÿè®¡æŸä¸ªæ´»åŠ¨ä¸‹çš„è®¢å•æ•°é‡</td>
</tr>
<tr>
<td>ï¼ˆç»§æ‰¿è‡ª MongoRepositoryï¼‰</td>
<td>æä¾›å¸¸ç”¨å¢åˆ æ”¹æŸ¥æ“ä½œ</td>
</tr>
</tbody></table>
<h4 id="OrderServiceImpl"><a href="#OrderServiceImpl" class="headerlink" title="OrderServiceImpl"></a>OrderServiceImpl</h4><p>OrderServiceImpl æ˜¯è®¢å•æ¨¡å—ï¼ˆgoodskill-order-providerï¼‰çš„ <strong>ä¸šåŠ¡é€»è¾‘å®ç°ç±»</strong>ï¼Œç”¨äºå¤„ç†å’Œå°è£…è®¢å•çš„æ ¸å¿ƒæ“ä½œï¼š<strong>ä¿å­˜è®¢å•ã€åˆ é™¤è®¢å•ã€ç»Ÿè®¡è®¢å•æ•°é‡</strong>ã€‚å®ƒä½œä¸º OrderController çš„ <strong>Service å±‚å®ç°ç±»</strong>ï¼Œå¹¶ä¾èµ– MongoDB è¿›è¡ŒæŒä¹…åŒ–å­˜å‚¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> OrderRepository orderRepository;<br><br>    <span class="hljs-comment">//åˆ é™¤æŸåœºç§’æ€æ´»åŠ¨ä¸‹çš„æ‰€æœ‰è®¢å•è®°å½•</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">deleteRecord</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        orderRepository.deleteBySeckillId(BigInteger.valueOf(seckillId));<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//ç”¨äºç§’æ€æˆåŠŸæ—¶è½åº“ï¼Œæˆ–å‹æµ‹æ¨¡æ‹Ÿç”Ÿæˆè®¢å•</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">saveRecord</span><span class="hljs-params">(OrderDTO orderDTO)</span> &#123;<br>        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> Order.builder()<br>                .id(UUID.randomUUID().toString())<br>                .seckillId(orderDTO.getSeckillId())<br>                .userPhone(orderDTO.getUserPhone())<br>                .build();<br>        orderRepository.insert(order);<br>        log.info(<span class="hljs-string">&quot;ä¿å­˜æˆåŠŸ,&#123;&#125;&quot;</span>, order);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//ç»Ÿè®¡æŸä¸ª seckillId å¯¹åº”çš„è®¢å•æ•°</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">count</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderRepository.countBySeckillId(BigInteger.valueOf(seckillId));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>OrderServiceImpl æ˜¯è®¢å•å¾®æœåŠ¡çš„æ ¸å¿ƒä¸šåŠ¡ç±»ï¼Œè´Ÿè´£è®¢å•æ•°æ®çš„ åˆ›å»ºã€æ¸…ç†ã€ç»Ÿè®¡</li>
<li>ç”¨äºæ“ä½œè®¢å•æ•°æ®çš„ æœåŠ¡å®ç°ç±»ï¼Œè°ƒç”¨åº•å±‚ OrderRepository å®Œæˆ CRUDï¼Œå¹¶å¯¹å¤–æä¾›ç»Ÿä¸€çš„ä¸šåŠ¡é€»è¾‘å°è£…</li>
</ul>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨</th>
<th>è°ƒç”¨åº•å±‚ DAO æ–¹æ³•</th>
</tr>
</thead>
<tbody><tr>
<td>deleteRecord</td>
<td>åˆ é™¤æŒ‡å®šç§’æ€æ´»åŠ¨çš„æ‰€æœ‰è®¢å•è®°å½•</td>
<td>deleteBySeckillId(â€¦)</td>
</tr>
<tr>
<td>saveRecord</td>
<td>ä¿å­˜è®¢å•æ•°æ®åˆ° MongoDB</td>
<td>insert(order)</td>
</tr>
<tr>
<td>count</td>
<td>ç»Ÿè®¡æŸç§’æ€æ´»åŠ¨å¯¹åº”çš„è®¢å•æ•°é‡</td>
<td>countBySeckillId(â€¦)</td>
</tr>
</tbody></table>
<h3 id="2-2-3-application-ymlé…ç½®æ–‡ä»¶"><a href="#2-2-3-application-ymlé…ç½®æ–‡ä»¶" class="headerlink" title="2.2.3 application.ymlé…ç½®æ–‡ä»¶"></a>2.2.3 application.ymlé…ç½®æ–‡ä»¶</h3><p>é…ç½®æ–‡ä»¶ä¸º goodskill-order å¾®æœåŠ¡å‡†å¤‡äº† å¼€å‘ç¯å¢ƒä¸‹çš„è¿è¡ŒåŸºç¡€è®¾æ–½æ”¯æŒ</p>
<ul>
<li>æœåŠ¡æ³¨å†Œ&#x2F;é…ç½®ï¼šNacos</li>
<li>æ¶ˆæ¯ç›‘å¬ï¼šRabbitMQ + Stream + Function</li>
<li>æ•°æ®å­˜å‚¨ï¼šMongoDBï¼ˆå«è‡ªåŠ¨ç´¢å¼•ï¼‰</li>
<li>æ—¥å¿—è°ƒè¯•ï¼šMongo æ“ä½œå¯è§</li>
<li>é¡¹ç›®è§£è€¦å’Œå¤šç¯å¢ƒæ”¯æŒï¼šé…ç½®ä¸­å¿ƒå¯¼å…¥ + åŠ¨æ€ç«¯å£ + graceful shutdown</li>
</ul>
<h1 id="3-goodskill-seckill-provider-ç§’æ€æœåŠ¡æä¾›è€…"><a href="#3-goodskill-seckill-provider-ç§’æ€æœåŠ¡æä¾›è€…" class="headerlink" title="3. goodskill-seckill-provider (ç§’æ€æœåŠ¡æä¾›è€…)"></a>3. goodskill-seckill-provider (ç§’æ€æœåŠ¡æä¾›è€…)</h1><p>åˆ†ä¸ºä¸¤ä¸ªæ¨¡å—ï¼š</p>
<ul>
<li>goodskill-api</li>
<li>goodskill-service</li>
</ul>
<h2 id="3-1-goodskill-api"><a href="#3-1-goodskill-api" class="headerlink" title="3.1 goodskill-api"></a>3.1 goodskill-api</h2><p><img src="/img/blogs/java/goodskill/3.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-1-1-DTOå’ŒVO"><a href="#3-1-1-DTOå’ŒVO" class="headerlink" title="3.1.1 DTOå’ŒVO"></a>3.1.1 DTOå’ŒVO</h3><p><strong>DTOæ•°æ®ä¼ è¾“å¯¹è±¡</strong>ï¼š</p>
<ul>
<li><code>ExposerDTO</code>: <strong>æš´éœ²ç§’æ€åœ°å€</strong> çš„æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨ç§’æ€æ¥å£å¼€æ”¾æ—¶ï¼Œ<strong>å‘å‰ç«¯è¿”å›å½“å‰ç§’æ€çš„çŠ¶æ€å’Œå¿…è¦å‚æ•°</strong>ï¼ˆå¦‚ MD5 åŠ å¯†ä¸²ï¼‰</li>
<li><code>GoodsDTO</code>: <strong>å•†å“ä¿¡æ¯</strong>çš„ æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰,ç”¨äºå°è£…ç§’æ€å•†å“æˆ–æ™®é€šå•†å“çš„åŸºæœ¬ä¿¡æ¯ï¼Œä¾¿äºæœåŠ¡ä¹‹é—´ä¼ è¾“æˆ–å±•ç¤ºåœ¨å‰ç«¯é¡µé¢</li>
<li><code>SeckillExecutionDTO</code>: ç”¨äºè¡¨ç¤º <strong>ç§’æ€æ‰§è¡Œç»“æœ</strong> çš„æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œä¸»è¦æ˜¯ç”¨æ¥å°è£…ä¸€ä¸ªç”¨æˆ·å‚ä¸ç§’æ€åçš„ç»“æœè¯¦æƒ…ï¼Œæ¯”å¦‚æˆåŠŸ&#x2F;å¤±è´¥çŠ¶æ€ã€ç›¸å…³æè¿°ã€ä¸‹å•æ•°æ®ã€ä»¥åŠäºŒç»´ç è·¯å¾„ç­‰</li>
<li><code>SeckillInfoDTO</code>: å°è£…<strong>ç§’æ€æ´»åŠ¨åŸºæœ¬ä¿¡æ¯</strong>çš„ä¸€ä¸ªæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰,ç”¨äºä¼ é€’ç§’æ€æ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ—¶é—´ã€å•†å“ã€åº“å­˜å’Œä»·æ ¼ç­‰</li>
<li><code>SeckillMockCanalResponseDTO</code>: ç”¨äºè¡¨ç¤º<strong>ç§’æ€æ´»åŠ¨çŠ¶æ€å˜æ›´å“åº”ç»“æœ</strong>çš„ä¸€ä¸ªæ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰,å¸¸ç”¨äºæ¶ˆæ¯ä¼ é€’ã€æ´»åŠ¨æ›´æ–°åé¦ˆ</li>
<li><code>SeckillMockRequestDTO</code>: ç”¨äº<strong>æ¨¡æ‹Ÿç§’æ€è¯·æ±‚</strong>çš„è¯·æ±‚æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰,ä¸»è¦ç”¨äºç§’æ€æ¥å£çš„å‹æµ‹æˆ–å®šæ—¶ä»»åŠ¡æ¨¡æ‹Ÿç”¨æˆ·è¯·æ±‚è¡Œä¸º</li>
<li><code>SeckillMockResponseDTO</code>: ç”¨äº<strong>è¿”å›ç§’æ€æ¨¡æ‹Ÿä»»åŠ¡æ‰§è¡Œç»“æœ</strong>çš„å“åº”æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰,åŒ…å«ç§’æ€æ´»åŠ¨ IDã€æ‰§è¡Œå¤‡æ³¨ã€çŠ¶æ€ä»¥åŠä»»åŠ¡ ID</li>
<li><code>SeckillResponseDTO</code>: ç”¨äºå°è£… <strong>ç§’æ€æ“ä½œè¿”å›çš„äºŒè¿›åˆ¶æ•°æ®</strong>ï¼ˆbyte[]ï¼‰ï¼Œé€šå¸¸ç”¨äºè¿”å›ä¸€äº› <strong>ç»“æ„åŒ–æˆ–æ–‡ä»¶ç±»çš„æ•°æ®å†…å®¹</strong>ï¼Œè€Œä¸æ˜¯ç®€å•çš„ JSON æ–‡æœ¬</li>
<li><code>SuccessKilledDTO</code>: ç”¨äº<strong>å°è£…ç§’æ€æˆåŠŸè®°å½•</strong>çš„ æ•°æ®ä¼ è¾“å¯¹è±¡ï¼ˆDTOï¼‰ï¼Œå®ƒè®°å½•äº†æŸä¸ªç”¨æˆ·åœ¨å‚ä¸æŸæ¬¡ç§’æ€æ´»åŠ¨æ—¶çš„è¯¦ç»†ä¿¡æ¯ä¸çŠ¶æ€</li>
</ul>
<p><strong>VO</strong>ï¼š</p>
<ul>
<li><code>GoodsVO</code>: ç”¨äºè¡¨ç¤º <strong>å•†å“ä¿¡æ¯</strong>çš„å€¼å¯¹è±¡,ç”¨äºä¼ è¾“ä¸å•†å“ç›¸å…³çš„ä¿¡æ¯ï¼Œå¦‚å•†å“IDã€ä»·æ ¼ã€æè¿°ç­‰</li>
<li><code>SeckillVO</code>: ç”¨äºè¡¨ç¤º <strong>ç§’æ€æ´»åŠ¨ç›¸å…³çš„æ•°æ®</strong>ã€‚VO ç±»ä¸»è¦ç”¨äºæ•°æ®ä¼ è¾“ï¼Œé€šå¸¸ç”¨äºå‰åç«¯æ•°æ®äº¤äº’æˆ–ä¼ é€’ä¸šåŠ¡æ•°æ®</li>
</ul>
<h3 id="3-1-2-Serviceæ¥å£"><a href="#3-1-2-Serviceæ¥å£" class="headerlink" title="3.1.2 Serviceæ¥å£"></a>3.1.2 Serviceæ¥å£</h3><ul>
<li>GoodsEsService</li>
<li>GoodsService</li>
<li>SeckillService</li>
</ul>
<h4 id="GoodsEsService"><a href="#GoodsEsService" class="headerlink" title="GoodsEsService"></a>GoodsEsService</h4><p><code>GoodsEsService</code>æ˜¯ä¸€ä¸ª <strong>Feign å®¢æˆ·ç«¯æ¥å£</strong>ï¼Œå®ƒç”¨äºå’Œ <code>goodskill-seckill</code> å¾®æœåŠ¡è¿›è¡Œé€šä¿¡,ä¸º goodskill-seckill æœåŠ¡æä¾›äº†ä¿å­˜å•†å“ã€æ‰¹é‡ä¿å­˜å•†å“ã€åˆ é™¤å•†å“ä»¥åŠå•†å“åç§°æœç´¢çš„åŠŸèƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">ç”¨äºå’Œ `goodskill-seckill` å¾®æœåŠ¡è¿›è¡Œé€šä¿¡</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;goodskill-seckill&quot;, contextId = &quot;goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GoodsEsService</span> &#123;<br><br>    <span class="hljs-comment">//ä¿å­˜å•†å“ä¿¡æ¯ï¼šé€šè¿‡ save æ–¹æ³•ï¼Œå°†å•ä¸ªå•†å“ä¿¡æ¯ä¿å­˜åˆ° goodskill-seckill æœåŠ¡</span><br>    <span class="hljs-meta">@PutMapping(&quot;/save&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> GoodsDTO goodsDto)</span>;<br><br>    <span class="hljs-comment">//æ‰¹é‡ä¿å­˜å•†å“ä¿¡æ¯ï¼šé€šè¿‡ saveBatch æ–¹æ³•ï¼Œå°†å¤šä¸ªå•†å“ä¿¡æ¯æ‰¹é‡ä¿å­˜åˆ° goodskill-seckill æœåŠ¡</span><br>    <span class="hljs-meta">@PutMapping(&quot;/saveBatch&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> List&lt;GoodsDTO&gt; list)</span>;<br><br>    <span class="hljs-comment">//åˆ é™¤å•†å“ä¿¡æ¯ï¼šé€šè¿‡ delete æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„ GoodsDTO å¯¹è±¡åˆ é™¤å•†å“ä¿¡æ¯</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/delete&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> GoodsDTO goodsDto)</span>;<br><br>    <span class="hljs-comment">//æ ¹æ®å•†å“åç§°è¿›è¡Œåˆ†é¡µæŸ¥è¯¢ï¼šé€šè¿‡ searchWithNameByPage æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„å…³é”®è¯æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œå¹¶åˆ†é¡µè¿”å›ç»“æœ</span><br>    <span class="hljs-meta">@GetMapping(&quot;/searchWithNameByPage&quot;)</span><br>    List&lt;GoodsDTO&gt; <span class="hljs-title function_">searchWithNameByPage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;input&quot;)</span> String input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GoodsEsService æ¥å£å®šä¹‰äº†ä¸ <code>goodskill-seckill</code> å¾®æœåŠ¡è¿›è¡Œå•†å“ä¿¡æ¯äº¤äº’çš„æ“ä½œã€‚åŒ…æ‹¬ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<ol>
<li><strong>ä¿å­˜å•†å“ä¿¡æ¯</strong>ï¼šé€šè¿‡ save æ–¹æ³•ï¼Œå°†å•ä¸ªå•†å“ä¿¡æ¯ä¿å­˜åˆ° goodskill-seckill æœåŠ¡ã€‚</li>
<li><strong>æ‰¹é‡ä¿å­˜å•†å“ä¿¡æ¯</strong>ï¼šé€šè¿‡ saveBatch æ–¹æ³•ï¼Œå°†å¤šä¸ªå•†å“ä¿¡æ¯æ‰¹é‡ä¿å­˜åˆ° goodskill-seckill æœåŠ¡ã€‚</li>
<li><strong>åˆ é™¤å•†å“ä¿¡æ¯</strong>ï¼šé€šè¿‡ delete æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„ GoodsDTO å¯¹è±¡åˆ é™¤å•†å“ä¿¡æ¯ã€‚</li>
<li><strong>æ ¹æ®å•†å“åç§°è¿›è¡Œåˆ†é¡µæŸ¥è¯¢</strong>ï¼šé€šè¿‡ searchWithNameByPage æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„å…³é”®è¯æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œå¹¶åˆ†é¡µè¿”å›ç»“æœã€‚</li>
</ol>
<h4 id="GoodsService"><a href="#GoodsService" class="headerlink" title="GoodsService"></a>GoodsService</h4><p>ç”¨äº<strong>å¤„ç†å•†å“ç›¸å…³ä¸šåŠ¡é€»è¾‘</strong>çš„æ¥å£ï¼Œæä¾›äº†å¤šä¸ªæ–¹æ³•æ¥<strong>ç®¡ç†å•†å“ä¿¡æ¯</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GoodsService</span> &#123;<br><br>    <span class="hljs-comment">//ä¸Šä¼ å•†å“ç…§ç‰‡</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadGoodsPhoto</span><span class="hljs-params">(<span class="hljs-type">long</span> goodsId, String fileUrl)</span>;<br><br>    <span class="hljs-comment">//æ·»åŠ ä¸€ä¸ªæ–°çš„å•†å“</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGoods</span><span class="hljs-params">(GoodsVO goods)</span>;<br><br>    <span class="hljs-comment">//æŸ¥è¯¢å¤šä¸ªå•†å“</span><br>    List&lt;GoodsVO&gt; <span class="hljs-title function_">findMany</span><span class="hljs-params">()</span>;<br><br>    <span class="hljs-comment">//æ ¹æ®å•†å“IDæŸ¥è¯¢å•†å“</span><br>    GoodsVO <span class="hljs-title function_">findById</span><span class="hljs-params">(Serializable goodsId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>GoodsService æ¥å£ä¸»è¦<strong>è´Ÿè´£å•†å“çš„ç®¡ç†æ“ä½œ</strong>ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>ä¸Šä¼ å•†å“ç…§ç‰‡</strong>ï¼šé€šè¿‡ uploadGoodsPhoto æ–¹æ³•ä¸Šä¼ å•†å“ç…§ç‰‡ï¼Œå¹¶å°†ç…§ç‰‡å…³è”åˆ°å•†å“ã€‚</li>
<li><strong>æ·»åŠ å•†å“</strong>ï¼šé€šè¿‡ addGoods æ–¹æ³•å‘ç³»ç»Ÿä¸­æ·»åŠ æ–°çš„å•†å“ä¿¡æ¯ã€‚</li>
<li><strong>æŸ¥è¯¢å•†å“åˆ—è¡¨</strong>ï¼šé€šè¿‡ findMany æ–¹æ³•æŸ¥è¯¢å¤šä¸ªå•†å“ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºè·å–å•†å“çš„é›†åˆã€‚</li>
<li><strong>æ ¹æ®å•†å“IDæŸ¥è¯¢å•†å“ä¿¡æ¯</strong>ï¼šé€šè¿‡ findById æ–¹æ³•æŸ¥è¯¢æŒ‡å®šå•†å“çš„è¯¦ç»†ä¿¡æ¯ã€‚</li>
</ul>
<h4 id="SeckillService"><a href="#SeckillService" class="headerlink" title="SeckillService"></a>SeckillService</h4><p>ç”¨äºå¤„ç†ç§’æ€ç›¸å…³æ“ä½œçš„æœåŠ¡æ¥å£ï¼Œæ<strong>ä¾›äº†å¤šä¸ªä¸ç§’æ€æ´»åŠ¨ç›¸å…³çš„åŠŸèƒ½</strong>ã€‚è¯¥æ¥å£é€šè¿‡ Feign Client ä¸åä¸º <code>goodskill-seckill</code> çš„å¾®æœåŠ¡è¿›è¡Œé€šä¿¡</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç§’æ€æœåŠ¡</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@FeignClient(value = &quot;goodskill-seckill&quot;, contextId = &quot;seckill&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillService</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–ç§’æ€æ´»åŠ¨åˆ—è¡¨</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageNum   é¡µç </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> pageSize  æ¯é¡µæ•°é‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> goodsName å•†å“åç§°ï¼Œæ¨¡ç³ŠåŒ¹é…</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/getSeckillList&quot;)</span><br>    PageDTO&lt;SeckillVO&gt; <span class="hljs-title function_">getSeckillList</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;pageNum&quot;)</span> <span class="hljs-type">int</span> pageNum,</span><br><span class="hljs-params">                                      <span class="hljs-meta">@RequestParam(&quot;pageSize&quot;)</span> <span class="hljs-type">int</span> pageSize,</span><br><span class="hljs-params">                                      <span class="hljs-meta">@RequestParam(value = &quot;goodsName&quot;, required = false)</span> String goodsName)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æš´éœ²ç§’æ€æ´»åŠ¨url</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€æ´»åŠ¨id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> æ´»åŠ¨ä¿¡æ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/exportSeckillUrl&quot;)</span><br>    ExposerDTO <span class="hljs-title function_">exportSeckillUrl</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ®ç§’æ€idåˆ é™¤æˆåŠŸè®°å½•</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€æ´»åŠ¨id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> åˆ é™¤æ•°é‡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@DeleteMapping(&quot;/deleteSuccessKillRecord&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteSuccessKillRecord</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰§è¡Œç§’æ€ï¼Œé€šè¿‡åŒæ­¥æ¥æ§åˆ¶å¹¶å‘</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestDto     ç§’æ€è¯·æ±‚</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> strategyNumber ç§’æ€ç­–ç•¥ç¼–ç </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/execute&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SeckillMockRequestDTO requestDto,</span><br><span class="hljs-params">                 <span class="hljs-meta">@RequestParam(&quot;strategyNumber&quot;)</span> <span class="hljs-type">int</span> strategyNumber)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–æˆåŠŸç§’æ€è®°å½•æ•°</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€æ´»åŠ¨id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/getSuccessKillCount&quot;)</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">getSuccessKillCount</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Long seckillId)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‡†å¤‡ç§’æ€å•†å“æ•°é‡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId    ç§’æ€å•†å“id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillCount ç§’æ€æ•°é‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId ä»»åŠ¡id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/prepareSeckill&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareSeckill</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Long seckillId,</span><br><span class="hljs-params">                        <span class="hljs-meta">@RequestParam(&quot;seckillCount&quot;)</span> <span class="hljs-type">int</span> seckillCount, <span class="hljs-meta">@RequestParam(&quot;taskId&quot;)</span> String taskId)</span>;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/getById&quot;)</span><br>    SeckillVO <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Serializable seckillId)</span>;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/saveOrUpdate&quot;)</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveOrUpdateSeckill</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SeckillVO seckill)</span>;<br><br>    <span class="hljs-meta">@DeleteMapping(&quot;/removeById&quot;)</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeBySeckillId</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Serializable seckillId)</span>;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/save&quot;)</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">save</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SeckillVO seckill)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‡å•†å“åº“å­˜</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> successKilled</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 1ä»£è¡¨æˆåŠŸï¼Œå°äº1ä¸ºå¤±è´¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/reduceNumber&quot;)</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">reduceNumber</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SuccessKilledDTO successKilled)</span>;<br><br>    <span class="hljs-meta">@PostMapping(&quot;/reduceNumberInner&quot;)</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">reduceNumberInner</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> SuccessKilledDTO successKilled)</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–äºŒç»´ç </span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fileName äºŒç»´ç å›¾ç‰‡åç§°</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> SeckillResponseDto</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/getQrcode&quot;)</span><br>    SeckillResponseDTO <span class="hljs-title function_">getQrcode</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;fileName&quot;)</span> String fileName)</span> <span class="hljs-keyword">throws</span> IOException;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ ¹æ®ç§’æ€idè·å–ç§’æ€æ´»åŠ¨ä¿¡æ¯</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/getInfoById&quot;)</span><br>    SeckillInfoDTO <span class="hljs-title function_">getInfoById</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Serializable seckillId)</span>;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç»“æŸç§’æ€æ“ä½œ</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€ID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> boolean ç»“æŸç§’æ€æ˜¯å¦æˆåŠŸ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-title function_">endSeckill</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> Long seckillId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>SeckillService æ¥å£æ˜¯ç”¨äºç®¡ç†ç§’æ€æ´»åŠ¨çš„ä¸€ä¸ªæœåŠ¡æ¥å£ï¼Œæ¶µç›–äº†ç§’æ€æ´»åŠ¨çš„ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>ç§’æ€æ´»åŠ¨ç®¡ç†ï¼šåŒ…æ‹¬<strong>æŸ¥è¯¢ã€æ·»åŠ ã€æ›´æ–°ã€åˆ é™¤ç§’æ€æ´»åŠ¨</strong>ã€‚</li>
<li>ç§’æ€å•†å“ç®¡ç†ï¼š<strong>å‡†å¤‡ç§’æ€å•†å“æ•°é‡ã€å‡å°‘å•†å“åº“å­˜</strong>ç­‰ã€‚</li>
<li>ç§’æ€æ“ä½œï¼š<strong>æ‰§è¡Œç§’æ€ã€è·å–æˆåŠŸç§’æ€è®°å½•ã€è·å–äºŒç»´ç </strong>ç­‰ã€‚</li>
<li><strong>ç§’æ€ç»Ÿè®¡</strong>ï¼šè·å–ç§’æ€æ´»åŠ¨çš„æˆåŠŸç§’æ€è®°å½•æ•°ç­‰ã€‚</li>
</ul>
<h2 id="3-2-goodskill-service"><a href="#3-2-goodskill-service" class="headerlink" title="3.2 goodskill-service"></a>3.2 goodskill-service</h2><p><img src="/img/blogs/java/goodskill/3.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-2-1-commonåŒ…"><a href="#3-2-1-commonåŒ…" class="headerlink" title="3.2.1 commonåŒ…"></a>3.2.1 commonåŒ…</h3><p><img src="/img/blogs/java/goodskill/3.2.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>CommonConstant</code> ç±»ï¼š æ˜¯ä¸€ä¸ªå¸¸é‡ç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¸­ä½¿ç”¨çš„ å…¬å…±å¸¸é‡ï¼Œä¸»è¦ç”¨äºæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Spring Cloud Streamï¼‰ä¸­ç»‘å®šé€šé“ï¼ˆbinding nameï¼‰çš„å®šä¹‰</li>
<li><code>GoodsKillStrategyEnum</code> æ˜¯ä¸€ä¸ª æšä¸¾ç±»ï¼Œç”¨äºè¡¨ç¤º<strong>ç§’æ€ç³»ç»Ÿä¸­å¯é€‰çš„å¤šç§ç­–ç•¥å®ç°æ–¹æ¡ˆ</strong>ï¼Œæ–¹ä¾¿ç³»ç»Ÿåœ¨è¿è¡Œæ—¶æ ¹æ®é…ç½®æˆ–å‚æ•°é€‰æ‹©ä¸åŒçš„ç§’æ€å¤„ç†ç­–ç•¥ã€‚<strong>ç§’æ€ç­–ç•¥æšä¸¾ï¼Œé€šè¿‡æšä¸¾é¿å…æš´éœ²å…·ä½“æ–¹æ³•</strong></li>
<li><code>ResponseInfo</code> æ˜¯ä¸€ä¸ª <strong>å“åº”çŠ¶æ€æšä¸¾ç±»</strong>ï¼ˆEnumï¼‰ï¼Œç”¨äº<strong>ç»Ÿä¸€å®šä¹‰åç«¯æ¥å£çš„å“åº”çŠ¶æ€ç å’Œå¯¹åº”çš„ä¿¡æ¯</strong>ï¼Œä¾‹å¦‚æˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ã€æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ç­‰</li>
<li><code>SuccessKilledService</code>ä¸º<code>SuccessKilled</code> å®ä½“æä¾› <strong>åŸºç¡€çš„å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰æœåŠ¡</strong>ï¼Œé€šè¿‡ç»§æ‰¿ <code>IService&lt;T&gt;</code> æ¥å®ç°ã€‚</li>
</ul>
<h4 id="RedisService"><a href="#RedisService" class="headerlink" title="RedisService"></a>RedisService</h4><p>RedisService ç±»æ˜¯ä¸€ä¸ªç”¨äº<strong>æ“ä½œç§’æ€ç›¸å…³ Redis ç¼“å­˜çš„å·¥å…·ç±»</strong>ï¼Œå®ƒå°è£…äº†å¯¹ Redis çš„è¯»å†™é€»è¾‘ï¼Œä¸»è¦ç›®çš„æ˜¯æå‡æŸ¥è¯¢æ•ˆç‡ã€å‡è½»æ•°æ®åº“å‹åŠ›ã€æ ‡è¯†ç§’æ€çŠ¶æ€ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillMapper seckillMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br>    <br>    <span class="hljs-comment">//æŸ¥è¯¢ç§’æ€æ´»åŠ¨ç¼“å­˜ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æŸ¥æ•°æ®åº“å¹¶å›å¡«åˆ° Redisï¼‰</span><br>    <span class="hljs-keyword">public</span> Seckill <span class="hljs-title function_">getSeckill</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill:&quot;</span> + seckillId;<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> (Seckill) redisTemplate.opsForValue().get(key);<br>        <span class="hljs-keyword">if</span> (seckill != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> seckill;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            seckill = seckillMapper.selectById(seckillId);<br>            <span class="hljs-keyword">if</span> (seckill == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç§’æ€æ´»åŠ¨ä¸å­˜åœ¨ï¼&quot;</span>);<br>            &#125;<br>            putSeckill(seckill);<br>            <span class="hljs-keyword">return</span> seckill;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//å°† Seckill å¯¹è±¡å­˜å…¥ Redis,è¿‡æœŸæ—¶é—´æ˜¯60ç§’</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">putSeckill</span><span class="hljs-params">(Seckill seckill)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill:&quot;</span> + seckill.getSeckillId();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">timeout</span> <span class="hljs-operator">=</span> <span class="hljs-number">60</span>;<br>        redisTemplate.opsForValue().set(key, seckill, timeout, TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ é™¤ Redis ä¸­çš„ç§’æ€ç¼“å­˜</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeSeckill</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill:&quot;</span> + seckillId;<br>        redisTemplate.delete(key);<br>        redisTemplate.delete(String.valueOf(seckillId));<br>    &#125;<br><br>    <span class="hljs-comment">//è®¾ç½®ä¸€ä¸ªç§’æ€æ´»åŠ¨ç»“æŸçš„æ ‡è¯†ä½ï¼Œè¿”å›å€¼è¡¨ç¤ºæ˜¯å¦æˆåŠŸè®¾ç½®ï¼ˆç¬¬ä¸€æ¬¡è®¾ç½®æˆåŠŸè¿”å› trueï¼Œä¹‹åè¿”å› falseï¼‰</span><br>    <span class="hljs-comment">//ä½¿ç”¨åœºæ™¯ï¼šé˜²æ­¢å¤šçº¿ç¨‹/å¤šèŠ‚ç‚¹é‡å¤è§¦å‘â€œç§’æ€ç»“æŸâ€é€»è¾‘</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">setSeckillEndFlag</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, String taskId)</span> &#123;<br>        <span class="hljs-keyword">return</span> stringRedisTemplate.opsForValue().setIfAbsent(<span class="hljs-string">&quot;goodskill:seckill:end:notice&quot;</span> + seckillId + <span class="hljs-string">&quot;:&quot;</span> + taskId, <span class="hljs-string">&quot;1&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-comment">//åˆ é™¤å¯¹åº”çš„â€œç§’æ€å·²ç»“æŸâ€æ ‡å¿—ä½</span><br>    <span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">clearSeckillEndFlag</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, String taskId)</span> &#123;<br>        <span class="hljs-keyword">return</span> stringRedisTemplate.delete(<span class="hljs-string">&quot;goodskill:seckill:end:notice&quot;</span> + seckillId + <span class="hljs-string">&quot;:&quot;</span> + taskId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>ä¸»è¦èŒè´£</p>
<ul>
<li>æŸ¥è¯¢ç§’æ€æ´»åŠ¨ç¼“å­˜ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æŸ¥æ•°æ®åº“å¹¶å›å¡«åˆ° Redisï¼‰ï¼›</li>
<li>å†™å…¥&#x2F;åˆ é™¤ Redis ç¼“å­˜ä¸­çš„ç§’æ€æ´»åŠ¨æ•°æ®ï¼›</li>
<li>ç®¡ç†ç§’æ€æ˜¯å¦ç»“æŸçš„æ ‡è¯†ä½ï¼ˆå¸ƒå°”å€¼æ ‡è¯†ï¼‰ï¼›</li>
<li>å°è£… Redis è®¿é—®é€»è¾‘ï¼Œé¿å…ä¸šåŠ¡ä»£ç ä¸­é‡å¤æ“ä½œ Redisã€‚</li>
</ul>
<p><strong>æŠ€æœ¯ç‚¹æ€»ç»“</strong></p>
<ul>
<li>ä½¿ç”¨äº† Redis çš„<strong>è¿‡æœŸæœºåˆ¶</strong>å’Œ setIfAbsent æœºåˆ¶ï¼Œ<strong>ç¡®ä¿é«˜å¹¶å‘ä¸‹çš„æ“ä½œä¸€è‡´æ€§</strong>ã€‚</li>
<li><strong>ç¼“å­˜ç©¿é€æ§åˆ¶</strong>ï¼šç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®åº“å¹¶å›å¡«ï¼Œé˜²æ­¢å¤§é‡è¯·æ±‚ç›´å‡»æ•°æ®åº“ã€‚</li>
</ul>
<h3 id="3-2-2-configåŒ…"><a href="#3-2-2-configåŒ…" class="headerlink" title="3.2.2 configåŒ…"></a>3.2.2 configåŒ…</h3><p><img src="/img/blogs/java/goodskill/3.2.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="StateMachineConfig"><a href="#StateMachineConfig" class="headerlink" title="StateMachineConfig"></a>StateMachineConfig</h4><p>ç”¨äº<strong>æ§åˆ¶â€œç§’æ€æ´»åŠ¨çŠ¶æ€æœºâ€é€»è¾‘çš„æ ¸å¿ƒé…ç½®ç±»</strong>ï¼Œå®ƒåŸºäº Spring State Machine çŠ¶æ€æœºæ¡†æ¶ï¼Œé€šè¿‡<strong>é…ç½®çŠ¶æ€ã€äº‹ä»¶ã€çŠ¶æ€è½¬æ¢è§„åˆ™ã€ç›‘å¬å™¨ã€æŒä¹…åŒ–æœºåˆ¶</strong>æ¥é©±åŠ¨ä¸€ä¸ªæµç¨‹ï¼ˆæ¯”å¦‚ï¼šç§’æ€æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸï¼‰æŒ‰ç…§é¢„æœŸçš„æ­¥éª¤è¿è¡Œã€‚</p>
<p>ç›®å‰ç§’æ€æ´»åŠ¨çŠ¶æ€çš„æ§åˆ¶åŸºäºSpring StatemachineçŠ¶æ€æœºå®ç°ï¼Œä½¿ç”¨çŠ¶æ€æœºçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ç»Ÿä¸€æ§åˆ¶æ´»åŠ¨çŠ¶æ€ï¼Œä¾¿äºçŠ¶æ€çš„é›†ä¸­ç»´æŠ¤ï¼›</li>
<li>é˜²æ­¢ä¸šåŠ¡çŠ¶æ€è¢«éšæ„æ›´æ”¹ï¼Œä¿è¯çŠ¶æ€çš„å¯æ§æ›´æ–°ï¼›</li>
</ul>
<p><img src="/img/blogs/java/goodskill/3.2.4.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>StateMachineConfig é…ç½®äº† <strong>ç§’æ€æ´»åŠ¨çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº</strong>ï¼ŒåŒ…æ‹¬çŠ¶æ€ã€äº‹ä»¶ã€çŠ¶æ€è½¬æ¢é€»è¾‘ã€ç›‘å¬å™¨å’Œ Redis æŒä¹…åŒ–æ”¯æŒï¼Œæ˜¯æ´»åŠ¨æµç¨‹æ§åˆ¶çš„æ ¸å¿ƒé…ç½®ã€‚</li>
</ul>
<h4 id="ThreadPoolConfig"><a href="#ThreadPoolConfig" class="headerlink" title="ThreadPoolConfig"></a>ThreadPoolConfig</h4><p><strong>çº¿ç¨‹æ± é…ç½®ç±»</strong>ï¼Œç”¨äºåœ¨ Spring å®¹å™¨ä¸­æ³¨å†Œä¸€ä¸ª ThreadPoolExecutor ç±»å‹çš„ Beanï¼Œä¾›é¡¹ç›®ä¸­çš„å¼‚æ­¥ä»»åŠ¡æˆ–å¹¶å‘æ“ä½œå¤ç”¨ã€‚<br>æä¾›ä¸€ä¸ªå¯å¤ç”¨çš„çº¿ç¨‹æ±  taskExecutorï¼Œç”¨æ¥ç»Ÿä¸€ç®¡ç†é¡¹ç›®ä¸­çš„å¹¶å‘ä»»åŠ¡ï¼Œæ¯”å¦‚æ‰§è¡Œç§’æ€å¼‚æ­¥é€»è¾‘ã€å‘é€MQã€å¤„ç†å›è°ƒã€è®°å½•æ—¥å¿—ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * çº¿ç¨‹æ± é…ç½®</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPoolConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ThreadPoolExecutor <span class="hljs-title function_">taskExecutor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1</span>, TimeUnit.MINUTES,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedBlockingDeque</span>&lt;&gt;(<span class="hljs-number">100</span>), <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolExecutor</span>.CallerRunsPolicy());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td><code>corePoolSize = 2</code></td>
<td>æ ¸å¿ƒçº¿ç¨‹æ•°ï¼šå³ä½¿ç©ºé—²ä¹Ÿä¼šä¿ç•™ 2 ä¸ªçº¿ç¨‹</td>
</tr>
<tr>
<td><code>maximumPoolSize = 10</code></td>
<td>æœ€å¤§çº¿ç¨‹æ•°ä¸Šé™ä¸º 10ï¼Œè¶…è¿‡å°±è¿›å…¥é˜Ÿåˆ—æˆ–æ‹’ç»</td>
</tr>
<tr>
<td><code>keepAliveTime = 1 åˆ†é’Ÿ</code></td>
<td>éæ ¸å¿ƒçº¿ç¨‹é—²ç½® 1 åˆ†é’Ÿåä¼šè¢«é”€æ¯</td>
</tr>
<tr>
<td><code>LinkedBlockingDeque&lt;&gt;(100)</code></td>
<td>é˜Ÿåˆ—æœ€å¤§ç¼“å­˜ä»»åŠ¡æ•°æ˜¯ 100</td>
</tr>
<tr>
<td><code>CallerRunsPolicy</code></td>
<td>æ‹’ç»ç­–ç•¥ï¼šå½“çº¿ç¨‹å’Œé˜Ÿåˆ—éƒ½æ»¡äº†ï¼Œä»»åŠ¡ç”±æäº¤ä»»åŠ¡çš„çº¿ç¨‹è‡ªå·±æ‰§è¡Œï¼ˆä¸ä¼šä¸¢ä»»åŠ¡ï¼‰</td>
</tr>
</tbody></table>
<h3 id="3-2-3-Controllerå±‚"><a href="#3-2-3-Controllerå±‚" class="headerlink" title="3.2.3 Controllerå±‚"></a>3.2.3 Controllerå±‚</h3><p><img src="/img/blogs/java/goodskill/3.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="SeckillGraphqlController"><a href="#SeckillGraphqlController" class="headerlink" title="SeckillGraphqlController"></a>SeckillGraphqlController</h4><p>åŸºäº GraphQL çš„æ§åˆ¶å™¨ï¼š<strong>ä¸ºå‰ç«¯ GraphQL æŸ¥è¯¢æä¾›æ•°æ®è§£æèƒ½åŠ›</strong>ï¼Œé€šè¿‡æ³¨è§£é©±åŠ¨çš„æ–¹å¼ï¼Œå°†ä¸åŒçš„ GraphQL æŸ¥è¯¢æˆ–å­—æ®µè§£æï¼Œæ˜ å°„åˆ°åç«¯çš„æœåŠ¡æ¥å£ä¸Šï¼Œæ–¹ä¾¿åœ°æŸ¥è¯¢ç§’æ€æ´»åŠ¨åŠå…¶å…³è”ä¿¡æ¯ï¼ˆå¦‚å•†å“ä¿¡æ¯ã€æˆåŠŸç§’æ€è®°å½•ç­‰ï¼‰ã€‚<br>SeckillGraphqlController æ˜¯ä¸€ä¸ª <strong>GraphQL æ§åˆ¶å™¨ç±»</strong>ï¼Œç”¨äºå¤„ç†å‰ç«¯ GraphQL æŸ¥è¯¢è¯·æ±‚ï¼Œè´Ÿè´£ä»åç«¯æœåŠ¡ä¸­<strong>æŸ¥è¯¢ç§’æ€æ´»åŠ¨ã€å…³è”å•†å“ä¿¡æ¯ã€æˆåŠŸç§’æ€è®°å½•</strong>ç­‰ï¼Œå¹¶å°†å®ƒä»¬ç»‘å®šåˆ°å¯¹åº” GraphQL çš„å­—æ®µå’ŒæŸ¥è¯¢ç»“æ„ä¸­ã€‚</p>
<h4 id="GoodsController"><a href="#GoodsController" class="headerlink" title="GoodsController"></a>GoodsController</h4><p>GoodsController ç±»æ˜¯ä¸€ä¸ªåŸºäº Spring Boot çš„ RESTful æ§åˆ¶å™¨ç±»ï¼Œä¸»è¦ç”¨äº<strong>å•†å“ç®¡ç†æ¨¡å—ä¸­çš„è®¢å•ç»Ÿè®¡åŠŸèƒ½</strong>ï¼Œé€šè¿‡ HTTP æ¥å£å¯¹å¤–æä¾›æœåŠ¡ã€‚</p>
<p><strong>æä¾›ä¸€ä¸ªç”¨äºæŸ¥è¯¢æŸä¸ªç§’æ€æ´»åŠ¨ä¸‹è®¢å•æ•°é‡çš„æ¥å£</strong>ï¼Œä¾¿äºç»Ÿè®¡å‚ä¸æŸå•†å“ç§’æ€çš„ç”¨æˆ·æ•°é‡æˆ–ä¸‹å•æ•°é‡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Tag(name = &quot;å•†å“ç®¡ç†&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/seckill/goods&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodsController</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">//æŸ¥è¯¢è®¢å•æ•°é‡</span><br>    <span class="hljs-meta">@GetMapping(&quot;/orders/count&quot;)</span><br>    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">countOrders</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> orderService.count(seckillId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="SeckillController"><a href="#SeckillController" class="headerlink" title="SeckillController"></a>SeckillController</h4><p><strong>ç§’æ€ç®¡ç†æ§åˆ¶å™¨ç±»</strong>: ç”¨äºå¤„ç†ä¸ <strong>å•†å“ç§’æ€æ´»åŠ¨ç›¸å…³çš„é¡µé¢è·³è½¬ã€æ•°æ®æ¥å£å’Œä¸šåŠ¡æ“ä½œ</strong>ã€‚å®ƒç»“åˆäº†ä¼ ç»Ÿ MVC çš„é¡µé¢è·³è½¬å’Œ REST æ¥å£ï¼Œæ”¯æŒé¡µé¢æ¸²æŸ“ã€æ•°æ®åˆ†é¡µã€åˆ›å»º&#x2F;ç¼–è¾‘&#x2F;åˆ é™¤ç§’æ€æ´»åŠ¨ã€äºŒç»´ç æ”¯ä»˜ã€ä¸Šä¼ å›¾ç‰‡ã€å•†å“æœç´¢ç­‰åŠŸèƒ½ã€‚</p>
<p><strong>SeckillController æ–¹æ³•åŠŸèƒ½è¡¨</strong>:</p>
<table>
<thead>
<tr>
<th>è¯·æ±‚æ–¹å¼</th>
<th>è¯·æ±‚è·¯å¾„</th>
<th>æ–¹æ³•å</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>GET</code></td>
<td><code>/seckill/list</code></td>
<td><code>list</code></td>
<td><strong>åˆ†é¡µå±•ç¤ºç§’æ€æ´»åŠ¨åˆ—è¡¨</strong>ï¼Œæ”¯æŒå•†å“åç§°æœç´¢</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/{seckillId}/detail</code></td>
<td><code>detail</code></td>
<td><strong>æŸ¥çœ‹æŒ‡å®šç§’æ€æ´»åŠ¨çš„è¯¦æƒ…</strong></td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/seckill/{seckillId}/exposer</code></td>
<td><code>exposer</code></td>
<td><strong>è·å–ç§’æ€åœ°å€</strong>ï¼ˆæ¥å£æš´éœ²ï¼‰</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/seckill/create</code></td>
<td><code>addSeckill</code></td>
<td><strong>æ·»åŠ </strong>ä¸€ä¸ªæ–°çš„ç§’æ€æ´»åŠ¨</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/new</code></td>
<td><code>toAddSeckillPage</code></td>
<td><strong>è·³è½¬åˆ°æ–°å»ºç§’æ€æ´»åŠ¨çš„é¡µé¢</strong></td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/{seckillId}/delete</code></td>
<td><code>delete</code></td>
<td><strong>åˆ é™¤</strong>æŸä¸ªç§’æ€æ´»åŠ¨</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/{seckillId}/edit</code></td>
<td><code>edit</code></td>
<td>è·³è½¬åˆ°ç¼–è¾‘é¡µé¢ï¼ŒåŠ è½½å½“å‰æ´»åŠ¨ä¿¡æ¯</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/seckill/{seckillId}/update</code></td>
<td><code>update</code></td>
<td><strong>æ›´æ–°</strong>ç§’æ€æ´»åŠ¨ä¿¡æ¯</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/pay/Qrcode/{QRfilePath}</code></td>
<td><code>payTransaction</code></td>
<td>è·³è½¬åˆ°æ”¯ä»˜å®äºŒç»´ç æ”¯ä»˜é¡µé¢</td>
</tr>
<tr>
<td><code>POST</code></td>
<td><code>/seckill/upload/{seckillId}/create</code></td>
<td><code>uploadPhoto</code></td>
<td><strong>ä¸Šä¼ ç§’æ€å•†å“å›¾ç‰‡</strong>ï¼Œæ›´æ–°å•†å“å›¾åœ°å€</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/seckill/goods/search/{goodsName}</code></td>
<td><code>searchGoods</code></td>
<td>é€šè¿‡<strong>å•†å“åæ¨¡ç³Šæœç´¢</strong>ï¼ˆåŸºäºESï¼‰ï¼Œè¿”å›é«˜äº®æœç´¢ç»“æœ</td>
</tr>
</tbody></table>
<h3 id="3-2-4-entityåŒ…"><a href="#3-2-4-entityåŒ…" class="headerlink" title="3.2.4 entityåŒ…"></a>3.2.4 entityåŒ…</h3><p><img src="/img/blogs/java/goodskill/3.2.6.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>Goods</code> ç±»æ˜¯ä¸€ä¸ªå®ä½“ç±»ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­çš„<strong>å•†å“å¯¹è±¡</strong>ï¼Œåœ¨ç§’æ€ç³»ç»Ÿä¸­ç”¨äºå­˜å‚¨å’Œç®¡ç†<strong>å•†å“çš„ç›¸å…³ä¿¡æ¯</strong></li>
<li><code>Seckill</code> ç±»æ˜¯ä¸€ä¸ªå®ä½“ç±»ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­çš„<strong>ç§’æ€åº“å­˜æ´»åŠ¨å¯¹è±¡</strong>ï¼Œä¸»è¦ç”¨äºæè¿°<strong>ä¸€ä¸ªç‰¹å®šå•†å“çš„ç§’æ€æ´»åŠ¨çš„åŸºæœ¬ä¿¡æ¯</strong>ï¼ŒåŒ…æ‹¬æ—¶é—´ã€<strong>åº“å­˜</strong>ã€ä»·æ ¼ç­‰å†…å®¹</li>
<li><code>SuccessKilled</code> ç±»æ˜¯ä¸€ä¸ªå®ä½“ç±»ï¼Œè¡¨ç¤º<strong>ç§’æ€æˆåŠŸè®°å½•çš„å¯¹è±¡</strong>ï¼Œç”¨äºå­˜å‚¨ç”¨æˆ·å‚ä¸ç§’æ€æ´»åŠ¨å¹¶æˆåŠŸè´­ä¹°å•†å“çš„è®°å½•</li>
</ul>
<h3 id="3-2-5-esåŒ…-Elasticsearch"><a href="#3-2-5-esåŒ…-Elasticsearch" class="headerlink" title="3.2.5 esåŒ…(Elasticsearch)"></a>3.2.5 esåŒ…(Elasticsearch)</h3><p><img src="/img/blogs/java/goodskill/3.2.7.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>Goods</code> ç±»æ˜¯ä¸€ä¸ª <strong>Elasticsearch å®ä½“ç±»</strong>ï¼Œç”¨äº<strong>è¡¨ç¤ºå•†å“ä¿¡æ¯</strong>ï¼Œå¹¶ä¸”è¯¥ç±»é€šè¿‡ @Document æ³¨è§£ä¸ Elasticsearch ä¸­çš„ goods ç´¢å¼•è¿›è¡Œæ˜ å°„ã€‚</li>
</ul>
<p><code>GoodsRepository</code> æ¥å£æ˜¯ä¸€ä¸ªç”¨äºæ“ä½œ Elasticsearch æ•°æ®åº“çš„ Spring Data Elasticsearch ä»“åº“æ¥å£ã€‚å®ƒ<strong>ç»§æ‰¿è‡ª ElasticsearchRepository</strong>ï¼Œè¿™æ˜¯ Spring Data Elasticsearch æä¾›çš„ä¸€ä¸ªåŸºç¡€æ¥å£ï¼Œ<strong>æä¾›äº†å¸¸ç”¨çš„ CRUDï¼ˆåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤ï¼‰æ“ä½œ</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GoodsRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ElasticsearchRepository</span>&lt;Goods, String&gt; &#123;<br><br>   <span class="hljs-comment">//æ ¹æ® ID åˆ é™¤ Goods å®ä½“</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteByGoodsId</span><span class="hljs-params">(Integer goodsId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-2-6-handleråŒ…"><a href="#3-2-6-handleråŒ…" class="headerlink" title="3.2.6 handleråŒ…"></a>3.2.6 handleråŒ…</h3><p><img src="/img/blogs/java/goodskill/3.2.8.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="AbstractPreRequestHandler-æŠ½è±¡ç±»"><a href="#AbstractPreRequestHandler-æŠ½è±¡ç±»" class="headerlink" title="AbstractPreRequestHandler æŠ½è±¡ç±»"></a>AbstractPreRequestHandler æŠ½è±¡ç±»</h4><p>æŠ½è±¡åŸºç±»ï¼Œæä¾›é¢„å¤„ç†å™¨ç»Ÿä¸€æ¥å£å’Œæ‰§è¡Œé¡ºåºæ§åˆ¶<br>ç”¨äºè¯·æ±‚å‰çš„ç»Ÿä¸€å¤„ç†æµç¨‹ï¼ˆå¦‚æ ¡éªŒã€é™æµã€æ—¥å¿—ã€é‰´æƒç­‰ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractPreRequestHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PreRequestHandler</span>, Ordered &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="DatabasePreRequestHandler"><a href="#DatabasePreRequestHandler" class="headerlink" title="DatabasePreRequestHandler"></a>DatabasePreRequestHandler</h4><p>DatabasePreRequestHandler æ˜¯ä¸€ä¸ªç”¨äº <strong>æ•°æ®åº“åˆå§‹åŒ–&#x2F;é‡ç½®çš„è¯·æ±‚é¢„å¤„ç†å™¨</strong>ï¼Œåœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼ˆå¦‚æ¨¡æ‹Ÿç§’æ€ç¯å¢ƒæˆ–åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼‰ï¼Œè¯¥å¤„ç†å™¨ä¼šï¼š</p>
<ul>
<li><strong>é‡ç½®æŒ‡å®šç§’æ€æ´»åŠ¨çš„åº“å­˜æ•°é‡</strong></li>
<li><strong>æ¸…ç©ºè¯¥ç§’æ€æ´»åŠ¨ä¸‹çš„å·²æˆåŠŸç§’æ€è®°å½•</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabasePreRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPreRequestHandler</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SeckillMapper seckillMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SuccessKilledMapper successKilledMapper;<br>    <span class="hljs-comment">// æ›´æ–°åº“å­˜	å°†ä¼ å…¥çš„ç§’æ€å•†å“ ID çš„åº“å­˜æ•°é‡è®¾ç½®ä¸ºæŒ‡å®šæ•°é‡</span><br>    <span class="hljs-comment">// åˆ é™¤è®°å½•	æ¸…é™¤è¯¥å•†å“ ID æ‰€æœ‰çš„æˆåŠŸç§’æ€è®°å½•ï¼ˆä¾‹å¦‚ç”¨äºæµ‹è¯•æˆ–é‡ç½®ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span> &#123;<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Seckill</span>();<br>        entity.setSeckillId(request.getSeckillId());<br>        entity.setNumber(request.getSeckillCount());<br>        seckillMapper.updateById(entity);<br><br>        <span class="hljs-comment">// æ¸…ç†å·²æˆåŠŸç§’æ€è®°å½•</span><br>        <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilled</span>();<br>        example.setSeckillId(request.getSeckillId());<br>        successKilledMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;(example));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="MongoPreRequestHandler"><a href="#MongoPreRequestHandler" class="headerlink" title="MongoPreRequestHandler"></a>MongoPreRequestHandler</h4><p>MongoPreRequestHandler ç±»çš„ä½œç”¨æ˜¯ï¼š<strong>åœ¨æ‰§è¡Œç§’æ€å‹æµ‹æˆ–æµ‹è¯•ä¹‹å‰ï¼Œæ¸…ç©º MongoDB ä¸­è¯¥ç§’æ€æ´»åŠ¨çš„ç›¸å…³è®¢å•è®°å½•</strong>ï¼Œä»¥ä¿è¯æµ‹è¯•æ•°æ®å¹²å‡€ã€ä¸ä¼šå—åˆ°å†å²æ•°æ®å½±å“ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MongoPreRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPreRequestHandler</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> OrderService orderService;<br><br>    <span class="hljs-comment">//ä» MongoDB ä¸­åˆ é™¤è¯¥æ´»åŠ¨çš„æ‰€æœ‰è®¢å•æ•°æ®</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span> &#123;<br>        orderService.deleteRecord(request.getSeckillId());<br>    &#125;<br><br>    <span class="hljs-comment">//è´£ä»»é“¾ä¸­æ‰§è¡Œé¡ºåºæ’åœ¨åé¢ï¼ˆå€¼è¶Šå¤§è¶Šåæ‰§è¡Œï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PreRequestHandler-æ¥å£"><a href="#PreRequestHandler-æ¥å£" class="headerlink" title="PreRequestHandler æ¥å£"></a>PreRequestHandler æ¥å£</h4><p>å®šä¹‰ä¸€ä¸ªç»Ÿä¸€çš„â€œç§’æ€è¯·æ±‚é¢„å¤„ç†â€æ“ä½œè§„èŒƒ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¯·æ±‚å¤„ç†ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PreRequestHandler</span> &#123;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PreRequestPipeline"><a href="#PreRequestPipeline" class="headerlink" title="PreRequestPipeline"></a>PreRequestPipeline</h4><p>ç»Ÿä¸€è°ƒåº¦å’Œæ‰§è¡Œæ‰€æœ‰é¢„å¤„ç†å™¨ï¼ˆPreRequestHandlerï¼‰çš„é€»è¾‘ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é¡ºåºä¾æ¬¡æ‰§è¡Œæ¯ä¸ªé¢„å¤„ç†æ­¥éª¤ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Setter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PreRequestPipeline</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> List&lt;AbstractPreRequestHandler&gt; prePreRequestHandlers;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span> &#123;<br>        prePreRequestHandlers.stream().sorted(Comparator.comparing(Ordered::getOrder))<br>                .forEach(it -&gt; &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        it.handle(request);<br>                    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                        log.warn(<span class="hljs-string">&quot;pre request handler error&quot;</span>, e);<br>                    &#125;<br>                &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å…¥å‚æ˜¯ç§’æ€è¯·æ±‚çš„æ•°æ®å¯¹è±¡ SeckillWebMockRequestDTOï¼ŒåŒ…å«è¯¸å¦‚ç§’æ€ IDã€ç§’æ€åº“å­˜ç­‰ä¿¡æ¯ã€‚</li>
<li>ä¼šéå†æ‰€æœ‰æ³¨å†Œçš„ AbstractPreRequestHandler å®ç°ç±»ï¼ŒæŒ‰ç…§ getOrder() æŒ‡å®šçš„é¡ºåºä¾æ¬¡è°ƒç”¨ handle(request) æ–¹æ³•ã€‚</li>
<li><strong>å¦‚æœæŸä¸ªå¤„ç†å™¨å‡ºé”™ï¼Œæ•è·å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œåé¢çš„å¤„ç†å™¨ï¼Œä¸ä¸­æ–­æ•´ä¸ªæµç¨‹</strong>ã€‚</li>
</ul>
<h4 id="RedisPreRequestHandler"><a href="#RedisPreRequestHandler" class="headerlink" title="RedisPreRequestHandler"></a>RedisPreRequestHandler</h4><p>RedisPreRequestHandler ç±»æ˜¯ä¸€ä¸ªé¢„å¤„ç†å™¨ç»„ä»¶ï¼Œå…¶ä½œç”¨æ˜¯<strong>åœ¨æ‰§è¡Œç§’æ€å‰ï¼Œæ¸…ç†å’Œåˆå§‹åŒ– Redis ä¸­ä¸ç§’æ€æ´»åŠ¨ç›¸å…³çš„ç¼“å­˜æ•°æ®</strong>ï¼Œä»¥ç¡®ä¿ Redis ç¼“å­˜ç¯å¢ƒå¤„äºå¹²å‡€ä¸”æ­£ç¡®çš„çŠ¶æ€ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisPreRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPreRequestHandler</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisService redisService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> request.getSeckillId();<br>        redisService.removeSeckill(seckillId);<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> redisService.getSeckill(seckillId);<br>        seckill.setStatus(SeckillStatusConstant.IN_PROGRESS);<br>        redisService.putSeckill(seckill);<br>        redisService.clearSeckillEndFlag(seckillId, request.getTaskId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="StateMachinePreRequestHandler"><a href="#StateMachinePreRequestHandler" class="headerlink" title="StateMachinePreRequestHandler"></a>StateMachinePreRequestHandler</h4><p>è¿™ä¸ª StateMachinePreRequestHandler ç±»æ˜¯ä¸€ä¸ªé¢„å¤„ç†å™¨ç»„ä»¶ï¼Œç”¨äº<strong>åœ¨ç§’æ€æ´»åŠ¨å¼€å§‹å‰ï¼Œé€šè¿‡çŠ¶æ€æœºæœåŠ¡æ¥åˆå§‹åŒ–å’Œç®¡ç†ç§’æ€æ´»åŠ¨çš„çŠ¶æ€æµè½¬</strong>ï¼Œæ˜¯é¢„å¤„ç†è´£ä»»é“¾ä¸­çš„ç¬¬ä¸‰æ­¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StateMachinePreRequestHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractPreRequestHandler</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineService stateMachineService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(SeckillWebMockRequestDTO request)</span> &#123;<br>        <span class="hljs-comment">// çŠ¶æ€æœºåˆå§‹åŒ–</span><br>        stateMachineService.initStateMachine(request.getSeckillId());<br>        <span class="hljs-comment">// åˆå§‹åŒ–åº“å­˜æ•°é‡</span><br>        <span class="hljs-comment">// ä½¿ç”¨çŠ¶æ€æœºæ§åˆ¶æ´»åŠ¨çŠ¶æ€</span><br>        <span class="hljs-keyword">if</span> (!stateMachineService.feedMachine(Events.ACTIVITY_RESET, request.getSeckillId())) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;æ´»åŠ¨å°šæœªç»“æŸï¼Œè¯·ç­‰å¾…æ´»åŠ¨ç»“æŸåå†æ¬¡æ“ä½œ&quot;</span>);<br>        &#125;<br>        stateMachineService.feedMachine(Events.ACTIVITY_START, request.getSeckillId());<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Handlerçš„ä½œç”¨"><a href="#Handlerçš„ä½œç”¨" class="headerlink" title="Handlerçš„ä½œç”¨"></a>Handlerçš„ä½œç”¨</h4><p>ç§’æ€ç³»ç»Ÿçš„ç‰¹ç‚¹æ˜¯<strong>é«˜å¹¶å‘ã€æ•°æ®æ•æ„Ÿã€çŠ¶æ€å¤æ‚</strong>ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡æ´»åŠ¨å¼€å§‹å‰ï¼Œéœ€è¦<strong>å®Œæˆä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œ</strong><br>è¿™äº› Handler å°±åƒâ€œå¯åŠ¨å‰æ£€æŸ¥æ¸…å•â€ï¼Œæ¯ä¸ªè´Ÿè´£ä¸€ä¸ªç¯èŠ‚ï¼Œä»æ•°æ®ã€ç¼“å­˜ã€çŠ¶æ€ã€å†å²è®°å½•ç­‰å¤šä¸ªç»´åº¦åšå¥½å‡†å¤‡ï¼Œç¡®ä¿ç§’æ€ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹ä¹Ÿèƒ½ç¨³å®šè¿è¡Œã€‚<br>å‡è®¾ä½ è¿è¡Œä¸€ä¸ªæ–°çš„ç§’æ€æ¨¡æ‹Ÿä»»åŠ¡ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="/img/blogs/java/goodskill/3.2.9.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th>é¡ºåº</th>
<th>å¤„ç†å™¨</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>DatabasePreRequestHandler</td>
<td>é‡ç½®æ•°æ®åº“åº“å­˜ï¼Œæ¸…ç†è®¢å•è®°å½•</td>
</tr>
<tr>
<td>1</td>
<td>RedisPreRequestHandler</td>
<td>æ¸…é™¤ç¼“å­˜ã€è®¾ç½®ä¸ºæ´»åŠ¨è¿›è¡Œä¸­</td>
</tr>
<tr>
<td>2</td>
<td>StateMachinePreRequestHandler</td>
<td>åˆå§‹åŒ–çŠ¶æ€æœºã€æ£€æµ‹æ˜¯å¦å¯é‡å¯ã€å¯åŠ¨æ´»åŠ¨çŠ¶æ€</td>
</tr>
<tr>
<td>3</td>
<td>MongoPreRequestHandler</td>
<td>æ¸…é™¤ Mongo ä¸­çš„è®¢å•è®°å½•</td>
</tr>
</tbody></table>
<h3 id="3-2-7-implå®ç°ç±»"><a href="#3-2-7-implå®ç°ç±»" class="headerlink" title="3.2.7 implå®ç°ç±»"></a>3.2.7 implå®ç°ç±»</h3><p><img src="/img/blogs/java/goodskill/3.2.10.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="GoodsServiceImpl"><a href="#GoodsServiceImpl" class="headerlink" title="GoodsServiceImpl"></a>GoodsServiceImpl</h4><p>GoodsServiceImpl æ˜¯ä¸€ä¸ª<strong>å•†å“æœåŠ¡çš„å®ç°ç±»</strong>ï¼Œå±äºç§’æ€ç³»ç»Ÿä¸­çš„å•†å“æ¨¡å—ï¼Œè´Ÿè´£å•†å“çš„åŸºæœ¬ä¿¡æ¯ç®¡ç†ï¼ŒåŒ…æ‹¬æ•°æ®åº“æ“ä½œã€ESï¼ˆElasticsearchï¼‰ç´¢å¼•åŒæ­¥ã€å›¾ç‰‡ä¸Šä¼ ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DubboService</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodsServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;GoodsMapper, Goods&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsService</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> GoodsEsService goodsEsService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> GoodsMapper baseMapper;<br><br>    <span class="hljs-comment">//ä¸Šä¼ å¹¶æ›´æ–°å•†å“å›¾ç‰‡é“¾æ¥</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">uploadGoodsPhoto</span><span class="hljs-params">(<span class="hljs-type">long</span> goodsId, String fileUrl)</span> &#123;<br>        <span class="hljs-type">Goods</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Goods</span>();<br>        goods.setGoodsId((<span class="hljs-type">int</span>) goodsId);<br>        goods.setPhotoUrl(fileUrl);<br>        log.info(goods.toString());<br>        baseMapper.updateById(goods);<br>    &#125;<br><br>    <span class="hljs-comment">//æ·»åŠ æ–°å•†å“ï¼ˆå«ESåŒæ­¥ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addGoods</span><span class="hljs-params">(GoodsVO goods)</span> &#123;<br>        baseMapper.insert(BeanUtil.copyProperties(goods, Goods.class));<br>        <span class="hljs-type">GoodsDTO</span> <span class="hljs-variable">goodsDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoodsDTO</span>();<br>        goodsDto.setId(IdWorker.getId());<br>        BeanUtils.copyProperties(goods, goodsDto);<br>        <span class="hljs-keyword">try</span> &#123;<br>            goodsEsService.save(goodsDto);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.warn(<span class="hljs-string">&quot;esæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ï¼&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//æ ¹æ®å•†å“ ID æŸ¥è¯¢å•†å“ä¿¡æ¯</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> GoodsVO <span class="hljs-title function_">findById</span><span class="hljs-params">(Serializable id)</span> &#123;<br>        <span class="hljs-type">Goods</span> <span class="hljs-variable">byId</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">super</span>.getById(id);<br>        <span class="hljs-keyword">return</span> BeanUtil.copyProperties(byId, GoodsVO.class);<br>    &#125;<br><br>    <span class="hljs-comment">//æŸ¥è¯¢æ‰€æœ‰å•†å“</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;GoodsVO&gt; <span class="hljs-title function_">findMany</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> BeanUtil.copyToList(<span class="hljs-built_in">super</span>.list(), GoodsVO.class);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>æ–¹æ³•ä½œç”¨</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>uploadGoodsPhoto(long goodsId, String fileUrl)</code></td>
<td>ä¸Šä¼ å¹¶æ›´æ–°å•†å“å›¾ç‰‡é“¾æ¥</td>
<td>å°†ä¸Šä¼ å¥½çš„å›¾ç‰‡ URL å†™å…¥æ•°æ®åº“ä¸­å¯¹åº”çš„å•†å“è®°å½•é‡Œã€‚</td>
</tr>
<tr>
<td><code>addGoods(GoodsVO goods)</code></td>
<td>æ·»åŠ æ–°å•†å“ï¼ˆå«ESåŒæ­¥ï¼‰</td>
<td>- å°†å•†å“ä¿¡æ¯æ’å…¥æ•°æ®åº“ï¼›<br>- å°†å•†å“ä¿¡æ¯æ„é€ æˆ GoodsDTO å¯¹è±¡åŒæ­¥åˆ° Elasticsearchï¼›<br>- è‹¥ ES å‡ºé”™åˆ™è®°å½•è­¦å‘Šæ—¥å¿—ï¼Œä¸ä¸­æ–­äº‹åŠ¡ã€‚</td>
</tr>
<tr>
<td><code>findById(Serializable id)</code></td>
<td>æ ¹æ®å•†å“ ID æŸ¥è¯¢å•†å“ä¿¡æ¯</td>
<td>ä»æ•°æ®åº“æŸ¥è¯¢å•†å“è®°å½•å¹¶è½¬æ¢ä¸ºå‰ç«¯ç”¨çš„ GoodsVO å¯¹è±¡è¿”å›ã€‚</td>
</tr>
<tr>
<td><code>findMany()</code></td>
<td>æŸ¥è¯¢æ‰€æœ‰å•†å“</td>
<td>æŸ¥è¯¢æ‰€æœ‰å•†å“è®°å½•å¹¶å°è£…æˆ VO åˆ—è¡¨ã€‚</td>
</tr>
</tbody></table>
<h4 id="SeckillServiceImpl"><a href="#SeckillServiceImpl" class="headerlink" title="SeckillServiceImpl"></a>SeckillServiceImpl</h4><p><strong>ç§’æ€æœåŠ¡çš„å®ç°ç±»</strong>ï¼Œç»§æ‰¿äº† <code>ServiceImpl&lt;SeckillMapper, Seckill&gt;</code>ï¼Œå¹¶å®ç°äº† <code>SeckillService</code> æ¥å£ã€‚è¿™ä¸ªç±»é›†æˆäº† Dubboã€Redisã€MongoDBã€çº¿ç¨‹æ± ã€çŠ¶æ€æœºã€é¢„å¤„ç†æµæ°´çº¿ç­‰ç»„ä»¶ï¼ŒåŠŸèƒ½éå¸¸ä¸°å¯Œï¼Œæ ¸å¿ƒä½œç”¨æ˜¯è´Ÿè´£â€œç§’æ€æ´»åŠ¨â€çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ŒåŒ…æ‹¬æ´»åŠ¨å‡†å¤‡ã€ç§’æ€æ‰§è¡Œã€äºŒç»´ç ç”Ÿæˆã€ç§’æ€è®°å½•ç®¡ç†ç­‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@DubboService</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;SeckillMapper, Seckill&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SeckillService</span> &#123;<br>    <span class="hljs-comment">//åˆ†é¡µè·å–ç§’æ€æ´»åŠ¨åˆ—è¡¨ï¼Œæ”¯æŒå•†å“åæ¨¡ç³ŠæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ç»“æœç¼“å­˜è¿› Redisï¼Œé¿å…é¢‘ç¹ DB æŸ¥è¯¢</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> PageDTO&lt;SeckillVO&gt; <span class="hljs-title function_">getSeckillList</span><span class="hljs-params">(<span class="hljs-type">int</span> pageNum, <span class="hljs-type">int</span> pageSize, String goodsName)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckill:list:&quot;</span> + pageNum + <span class="hljs-string">&quot;:&quot;</span> + pageSize + <span class="hljs-string">&quot;:&quot;</span> + goodsName;<br>        <span class="hljs-type">ValueOperations</span> <span class="hljs-variable">valueOperations</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">pageCache</span> <span class="hljs-operator">=</span> valueOperations.get(key);<br>        PageDTO&lt;SeckillVO&gt; page;<br>        <span class="hljs-keyword">if</span> (Objects.isNull(pageCache)) &#123;<br>            QueryWrapper&lt;Seckill&gt; queryWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>            <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(goodsName)) &#123;<br>                queryWrapper.lambda().like(Seckill::getName, goodsName);<br>            &#125;<br>            Page&lt;Seckill&gt; seckillPage = baseMapper.selectPage(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>(pageNum, pageSize), queryWrapper);<br>            List&lt;SeckillVO&gt; collect = seckillPage.getRecords().stream().map(it -&gt; &#123;<br>                <span class="hljs-type">SeckillVO</span> <span class="hljs-variable">seckillVO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillVO</span>();<br>                BeanUtils.copyProperties(it, seckillVO);<br>                <span class="hljs-type">GoodsVO</span> <span class="hljs-variable">byId</span> <span class="hljs-operator">=</span> goodsService.findById(it.getGoodsId());<br>                <span class="hljs-keyword">if</span> (Objects.nonNull(byId)) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">photoUrl</span> <span class="hljs-operator">=</span> byId.getPhotoUrl();<br>                    seckillVO.setPhotoUrl(photoUrl);<br>                &#125;<br>                <span class="hljs-keyword">return</span> seckillVO;<br>            &#125;).collect(Collectors.toList());<br>            page = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PageDTO</span>&lt;&gt;();<br>            page.setCurrent(pageNum);<br>            page.setSize(pageSize);<br>            page.setTotal(seckillPage.getTotal());<br>            page.setRecords(collect);<br>            valueOperations.set(key, page, <span class="hljs-number">5</span>, TimeUnit.MINUTES);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            page = (PageDTO&lt;SeckillVO&gt;) pageCache;<br>        &#125;<br>        <span class="hljs-keyword">return</span> page;<br>    &#125;<br><br>    <span class="hljs-comment">//æš´éœ²ç§’æ€åœ°å€ï¼Œç”¨äºéªŒè¯æ´»åŠ¨æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå¸¦ MD5 çš„åŠ å¯†é“¾æ¥ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ExposerDTO <span class="hljs-title function_">exportSeckillUrl</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-comment">//ä»redisä¸­è·å–ç¼“å­˜ç§’æ€ä¿¡æ¯</span><br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> redisService.getSeckill(seckillId);<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> seckill.getStartTime();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> seckill.getEndTime();<br>        <span class="hljs-type">Date</span> <span class="hljs-variable">nowTime</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();<br>        <span class="hljs-keyword">if</span> (nowTime.getTime() &lt; startTime.getTime() || nowTime.getTime() &gt; endTime.getTime()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExposerDTO</span>(<span class="hljs-literal">false</span>, seckillId, nowTime.getTime(), startTime.getTime(), endTime.getTime());<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">md5</span> <span class="hljs-operator">=</span> MD5Util.getMD5(seckillId);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExposerDTO</span>(<span class="hljs-literal">true</span>, md5, seckillId);<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ é™¤æŸä¸ªç§’æ€æ´»åŠ¨çš„æ‰€æœ‰æˆåŠŸè®°å½•ï¼ˆæ“ä½œæ•°æ®åº“ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteSuccessKillRecord</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilled</span>();<br>        example.setSeckillId(seckillId);<br>        successKilledMapper.delete(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;(example));<br>    &#125;<br><br>    <span class="hljs-comment">//æ ¹æ®ç­–ç•¥ç¼–å·é€‰æ‹©å¯¹åº”çš„ç§’æ€ç­–ç•¥æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œç§’æ€é€»è¾‘ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto, <span class="hljs-type">int</span> strategyNumber)</span> &#123;<br>        goodskillStrategies.stream()<br>                .filter(n -&gt; n.getClass().getName().startsWith(Objects.requireNonNull(GoodsKillStrategyEnum.stateOf(strategyNumber)).getClassName()))<br>                .findFirst().ifPresent(n -&gt; n.execute(requestDto));<br>    &#125;<br><br>    <span class="hljs-comment">//è·å–ç§’æ€æˆåŠŸçš„è®°å½•æ•°ï¼Œä¼˜å…ˆæŸ¥æ•°æ®åº“ï¼Œæ²¡æœ‰å†æŸ¥ MongoDBã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getSuccessKillCount</span><span class="hljs-params">(Long seckillId)</span> &#123;<br>        <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">example</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilled</span>();<br>        example.setSeckillId(seckillId);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> successKilledMapper.selectCount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;(example));<br>        <span class="hljs-keyword">if</span> (count == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                count = orderService.count(seckillId);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;mongoæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ï¼&quot;</span>, e);<br>                <span class="hljs-keyword">throw</span> e;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br><br>    <span class="hljs-comment">//å‡†å¤‡ç§’æ€æ´»åŠ¨çš„èµ„æºï¼ˆåº“å­˜ã€çŠ¶æ€ã€ç¼“å­˜ç­‰ï¼‰ï¼Œè°ƒç”¨é¢„å¤„ç†æµæ°´çº¿ä¸­çš„å¤šä¸ª Handler æ‰§è¡Œã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">prepareSeckill</span><span class="hljs-params">(Long seckillId, <span class="hljs-type">int</span> seckillCount, String taskId)</span> &#123;<br>        <span class="hljs-type">SeckillWebMockRequestDTO</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillWebMockRequestDTO</span>();<br>        request.setSeckillId(seckillId);<br>        request.setSeckillCount(seckillCount);<br>        request.setTaskId(taskId);<br>        preRequestPipeline.handle(request);<br>    &#125;<br><br>    <span class="hljs-comment">//å‡åº“å­˜çš„å¤–å±‚æ–¹æ³•ï¼Œè°ƒç”¨ reduceNumberInnerã€‚æ•è·å¼‚å¸¸é¿å…ä¸­æ–­æµç¨‹ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">reduceNumber</span><span class="hljs-params">(SuccessKilledDTO successKilled)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            count = seckillService.reduceNumberInner(successKilled);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.warn(e.getMessage());<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br><br>    <span class="hljs-comment">//çœŸæ­£å‡åº“å­˜ï¼šæ’å…¥ç§’æ€è®°å½•ï¼Œç„¶åæ›´æ–°åº“å­˜ï¼ˆå¸¦æ¡ä»¶é™åˆ¶ï¼‰ã€‚æ›´æ–°å¤±è´¥ä¼šæŠ›å‡ºâ€œæ´»åŠ¨å·²ç»“æŸâ€å¼‚å¸¸ã€‚</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">reduceNumberInner</span><span class="hljs-params">(SuccessKilledDTO successKilled)</span> &#123;<br>        <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(successKilled, SuccessKilled.class);<br>        successKilledMapper.insert(entity);<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Seckill</span>();<br>        wrapper.setSeckillId(entity.getSeckillId());<br>        UpdateWrapper&lt;Seckill&gt; updateWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>(wrapper);<br>        updateWrapper.gt(<span class="hljs-string">&quot;end_time&quot;</span>, entity.getCreateTime());<br>        updateWrapper.lt(<span class="hljs-string">&quot;start_time&quot;</span>, entity.getCreateTime());<br>        updateWrapper.gt(<span class="hljs-string">&quot;number&quot;</span>, <span class="hljs-number">0</span>);<br>        updateWrapper.setSql(<span class="hljs-string">&quot;number = number - 1&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> baseMapper.update(<span class="hljs-literal">null</span>, updateWrapper);<br>        <span class="hljs-keyword">if</span> (update &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillCloseException</span>(<span class="hljs-string">&quot;seckill is closed&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> update;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">//æ ¹æ®æ–‡ä»¶åè¯»å–æœ¬åœ°äºŒç»´ç å›¾ç‰‡å¹¶è¿”å›å­—èŠ‚æµï¼Œé€šå¸¸ç”¨äºè®¢å•æ”¯ä»˜</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> SeckillResponseDTO <span class="hljs-title function_">getQrcode</span><span class="hljs-params">(String fileName)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">SeckillResponseDTO</span> <span class="hljs-variable">seckillResponseDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillResponseDTO</span>();<br>        <span class="hljs-keyword">if</span> (qrcodeImagePath == <span class="hljs-literal">null</span>) &#123;<br>            qrcodeImagePath = System.getProperty(<span class="hljs-string">&quot;user.dir&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(qrcodeImagePath + <span class="hljs-string">&quot;/&quot;</span> + fileName + <span class="hljs-string">&quot;.png&quot;</span>);<br>        <span class="hljs-type">int</span> b;<br>        <span class="hljs-comment">// äºŒç»´ç ä¸€èˆ¬ä¸è¶…è¿‡10KB</span><br>        <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">10</span>];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((b = inputStream.read()) != -<span class="hljs-number">1</span>) &#123;<br>            data[i] = (<span class="hljs-type">byte</span>) b;<br>            i++;<br>        &#125;<br>        seckillResponseDto.setData(data);<br>        <span class="hljs-keyword">return</span> seckillResponseDto;<br>    &#125;<br><br>    <span class="hljs-comment">//æŸ¥è¯¢ç§’æ€æ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç»‘å®šçš„å•†å“ä¿¡æ¯ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> SeckillInfoDTO <span class="hljs-title function_">getInfoById</span><span class="hljs-params">(Serializable seckillId)</span> &#123;<br>        <span class="hljs-type">SeckillInfoDTO</span> <span class="hljs-variable">seckillInfoDTO</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillInfoDTO</span>();<br>        <span class="hljs-type">SeckillVO</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> seckillService.findById(seckillId);<br>        <span class="hljs-type">GoodsVO</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> goodsService.findById(seckill.getGoodsId());<br>        BeanUtils.copyProperties(seckill, seckillInfoDTO);<br>        seckillInfoDTO.setGoodsName(goods.getName());<br>        <span class="hljs-keyword">return</span> seckillInfoDTO;<br>    &#125;<br><br>    <span class="hljs-comment">//é€šè¿‡çŠ¶æ€æœºç»“æŸç§’æ€æ´»åŠ¨ï¼ˆè§¦å‘çŠ¶æ€å˜è¿ï¼‰ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">endSeckill</span><span class="hljs-params">(Long seckillId)</span> &#123;<br>        <span class="hljs-keyword">return</span> stateMachineService.feedMachine(Events.ACTIVITY_END, seckillId);<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ é™¤æŸä¸ªç§’æ€æ´»åŠ¨ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">removeBySeckillId</span><span class="hljs-params">(Serializable id)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.removeById(id);<br>    &#125;<br><br>    <span class="hljs-comment">//æ–°å»ºç§’æ€æ´»åŠ¨è®°å½•ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">save</span><span class="hljs-params">(SeckillVO seckill)</span> &#123;<br>        <span class="hljs-keyword">return</span> baseMapper.insert(BeanUtil.copyProperties(seckill, Seckill.class)) &gt; <span class="hljs-number">0</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//æ ¹æ® ID è·å–ç§’æ€æ´»åŠ¨ VO å¯¹è±¡ï¼ˆå°è£…å±•ç¤ºæ•°æ®ï¼‰ã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> SeckillVO <span class="hljs-title function_">findById</span><span class="hljs-params">(Serializable id)</span> &#123;<br>        <span class="hljs-keyword">return</span> BeanUtil.copyProperties(<span class="hljs-built_in">super</span>.getById(id), SeckillVO.class);<br>    &#125;<br><br>    <span class="hljs-comment">//æ›´æ–°æˆ–æ–°å¢ç§’æ€æ´»åŠ¨æ•°æ®ï¼ˆMyBatis Plus å°è£…æ–¹æ³•ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">saveOrUpdateSeckill</span><span class="hljs-params">(SeckillVO seckill)</span> &#123;<br>        <span class="hljs-keyword">return</span> saveOrUpdate(BeanUtil.copyProperties(seckill, Seckill.class));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td><code>getSeckillList</code></td>
<td>åˆ†é¡µè·å–ç§’æ€æ´»åŠ¨åˆ—è¡¨ï¼Œæ”¯æŒå•†å“åæ¨¡ç³ŠæŸ¥è¯¢ï¼ŒæŸ¥è¯¢ç»“æœç¼“å­˜è¿› Redisï¼Œé¿å…é¢‘ç¹ DB æŸ¥è¯¢ã€‚</td>
</tr>
<tr>
<td><code>exportSeckillUrl</code></td>
<td>æš´éœ²ç§’æ€åœ°å€ï¼Œç”¨äºéªŒè¯æ´»åŠ¨æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå¸¦ MD5 çš„åŠ å¯†é“¾æ¥ã€‚</td>
</tr>
<tr>
<td><code>deleteSuccessKillRecord</code></td>
<td>åˆ é™¤æŸä¸ªç§’æ€æ´»åŠ¨çš„æ‰€æœ‰æˆåŠŸè®°å½•ï¼ˆæ“ä½œæ•°æ®åº“ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>execute</code></td>
<td>æ ¹æ®ç­–ç•¥ç¼–å·é€‰æ‹©å¯¹åº”çš„ç§’æ€ç­–ç•¥æ‰§è¡Œå™¨ï¼Œæ‰§è¡Œç§’æ€é€»è¾‘ï¼ˆç­–ç•¥æ¨¡å¼ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>getSuccessKillCount</code></td>
<td>è·å–ç§’æ€æˆåŠŸçš„è®°å½•æ•°ï¼Œä¼˜å…ˆæŸ¥æ•°æ®åº“ï¼Œæ²¡æœ‰å†æŸ¥ MongoDBã€‚</td>
</tr>
<tr>
<td><code>prepareSeckill</code></td>
<td>å‡†å¤‡ç§’æ€æ´»åŠ¨çš„èµ„æºï¼ˆåº“å­˜ã€çŠ¶æ€ã€ç¼“å­˜ç­‰ï¼‰ï¼Œè°ƒç”¨é¢„å¤„ç†æµæ°´çº¿ä¸­çš„å¤šä¸ª Handler æ‰§è¡Œã€‚</td>
</tr>
<tr>
<td><code>reduceNumber</code></td>
<td>å‡åº“å­˜çš„å¤–å±‚æ–¹æ³•ï¼Œè°ƒç”¨ reduceNumberInnerã€‚æ•è·å¼‚å¸¸é¿å…ä¸­æ–­æµç¨‹ã€‚</td>
</tr>
<tr>
<td><code>reduceNumberInner</code></td>
<td>çœŸæ­£å‡åº“å­˜ï¼šæ’å…¥ç§’æ€è®°å½•ï¼Œç„¶åæ›´æ–°åº“å­˜ï¼ˆå¸¦æ¡ä»¶é™åˆ¶ï¼‰ã€‚æ›´æ–°å¤±è´¥ä¼šæŠ›å‡ºâ€œæ´»åŠ¨å·²ç»“æŸâ€å¼‚å¸¸ã€‚</td>
</tr>
<tr>
<td><code>getQrcode</code></td>
<td>æ ¹æ®æ–‡ä»¶åè¯»å–æœ¬åœ°äºŒç»´ç å›¾ç‰‡å¹¶è¿”å›å­—èŠ‚æµï¼Œé€šå¸¸ç”¨äºè®¢å•æ”¯ä»˜ã€‚</td>
</tr>
<tr>
<td><code>getInfoById</code></td>
<td>æŸ¥è¯¢ç§’æ€æ´»åŠ¨çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç»‘å®šçš„å•†å“ä¿¡æ¯ã€‚</td>
</tr>
<tr>
<td><code>endSeckill</code></td>
<td>é€šè¿‡çŠ¶æ€æœºç»“æŸç§’æ€æ´»åŠ¨ï¼ˆè§¦å‘çŠ¶æ€å˜è¿ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>removeBySeckillId</code></td>
<td>åˆ é™¤æŸä¸ªç§’æ€æ´»åŠ¨ã€‚</td>
</tr>
<tr>
<td><code>save</code></td>
<td>æ–°å»ºç§’æ€æ´»åŠ¨è®°å½•ã€‚</td>
</tr>
<tr>
<td><code>findById</code></td>
<td>æ ¹æ® ID è·å–ç§’æ€æ´»åŠ¨ VO å¯¹è±¡ï¼ˆå°è£…å±•ç¤ºæ•°æ®ï¼‰ã€‚</td>
</tr>
<tr>
<td><code>saveOrUpdateSeckill</code></td>
<td>æ›´æ–°æˆ–æ–°å¢ç§’æ€æ´»åŠ¨æ•°æ®ï¼ˆMyBatis Plus å°è£…æ–¹æ³•ï¼‰ã€‚</td>
</tr>
</tbody></table>
<h4 id="GoodsEsServiceImpl"><a href="#GoodsEsServiceImpl" class="headerlink" title="GoodsEsServiceImpl"></a>GoodsEsServiceImpl</h4><p>æ˜¯ä¸€ä¸ªåŸºäºElasticsearch çš„æœåŠ¡å®ç°ç±»ï¼Œè´Ÿè´£å¯¹ <strong>å•†å“ä¿¡æ¯è¿›è¡Œ Elasticsearch çš„å¢åˆ æŸ¥æ“ä½œ</strong>ï¼Œæä¾›äº†ä¸æœç´¢ç›¸å…³çš„åŠŸèƒ½ï¼Œé€‚ç”¨äºç”µå•†ç±»ç³»ç»Ÿä¸­çš„å•†å“æœç´¢æ¨¡å—ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodsEsServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsEsService</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BeanCopier</span> <span class="hljs-variable">beanCopier</span> <span class="hljs-operator">=</span> BeanCopier.create(GoodsDTO.class, Goods.class, <span class="hljs-literal">false</span>);<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ElasticsearchOperations elasticsearchOperations;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> GoodsRepository goodsRepository;<br><br>    <span class="hljs-comment">//å°†å•ä¸ªå•†å“ä¿å­˜åˆ° Elasticsearch</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(GoodsDTO goodsDto)</span> &#123;<br>        <span class="hljs-type">Goods</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Goods</span>();<br>        beanCopier.copy(goodsDto, goods, <span class="hljs-literal">null</span>);<br>        goodsRepository.save(goods);<br>    &#125;<br><br>    <span class="hljs-comment">//æ‰¹é‡ä¿å­˜å•†å“ä¿¡æ¯åˆ° Elasticsearch</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveBatch</span><span class="hljs-params">(List&lt;GoodsDTO&gt; list)</span> &#123;<br>        List&lt;Goods&gt; collect = list.stream().map(dto -&gt; &#123;<br>            <span class="hljs-type">Goods</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Goods</span>();<br>            beanCopier.copy(dto, goods, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">return</span> goods;<br>        &#125;).collect(Collectors.toList());<br>        goodsRepository.saveAll(collect);<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ é™¤æŸä¸ªå•†å“çš„ ES ç´¢å¼•æ–‡æ¡£</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(GoodsDTO goodsDto)</span> &#123;<br>        goodsRepository.deleteByGoodsId(goodsDto.getGoodsId());<br>    &#125;<br><br>    <span class="hljs-comment">//æŒ‰å•†å“åæ¨¡ç³ŠåŒ¹é…æœç´¢å•†å“ï¼ˆæœ€å¤šè¿”å›3æ¡ï¼‰ï¼Œå¹¶é«˜äº®æœç´¢å…³é”®å­—</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;GoodsDTO&gt; <span class="hljs-title function_">searchWithNameByPage</span><span class="hljs-params">(String input)</span> &#123;<br>        <span class="hljs-type">Criteria</span> <span class="hljs-variable">criteria</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Criteria</span>(<span class="hljs-string">&quot;name&quot;</span>).matches(input);<br>        <span class="hljs-type">Query</span> <span class="hljs-variable">query</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CriteriaQuery</span>(criteria);<br><br>        <span class="hljs-type">HighlightFieldParameters</span> <span class="hljs-variable">parameters</span> <span class="hljs-operator">=</span> HighlightFieldParameters.builder()<br>                .withPostTags(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;&lt;/font&gt;&quot;</span>&#125;)<br>                .withPreTags(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;&lt;font color=&#x27;red&#x27;&gt;&quot;</span>&#125;)<br>                .build();<br>        <span class="hljs-type">HighlightField</span> <span class="hljs-variable">highlightField</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightField</span>(<span class="hljs-string">&quot;name&quot;</span>, parameters);<br>        <span class="hljs-type">Highlight</span> <span class="hljs-variable">highlight</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Highlight</span>(HighlightParameters.builder().build(), List.of(highlightField));<br>        query.setHighlightQuery(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HighlightQuery</span>(highlight, <span class="hljs-literal">null</span>));<br>        query.setPageable(PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>));<br>        <span class="hljs-keyword">return</span> elasticsearchOperations.search(query, Goods.class)<br>                .getSearchHits().stream().map(s -&gt; &#123;<br>                    <span class="hljs-type">Goods</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> s.getContent();<br>                    <span class="hljs-type">GoodsDTO</span> <span class="hljs-variable">goodsDto</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoodsDTO</span>();<br>                    goodsDto.setName(s.getHighlightField(<span class="hljs-string">&quot;name&quot;</span>).getFirst());<br>                    goodsDto.setRawName(goods.getName());<br>                    <span class="hljs-keyword">return</span> goodsDto;<br>                &#125;).collect(Collectors.toList());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å°†å•†å“ä¿¡æ¯ GoodsDTO åŒæ­¥ä¿å­˜åˆ° Elasticsearchã€‚</li>
<li>æ”¯æŒæ‰¹é‡ä¿å­˜ã€åˆ é™¤ã€‚</li>
<li>æä¾›å•†å“åç§°çš„æœç´¢åŠŸèƒ½ï¼Œå¸¦ <strong>å…³é”®å­—é«˜äº®</strong>ã€‚</li>
<li>ä½œä¸ºç³»ç»Ÿä¸­æœç´¢æœåŠ¡çš„å®ç°ç±»ï¼Œé€‚ç”¨äºç”¨æˆ·è¾“å…¥å•†å“åç§°å…³é”®å­—æ—¶çš„è”æƒ³æœç´¢&#x2F;æ¨¡ç³Šæœç´¢ã€‚</li>
</ul>
<h4 id="SuccessKilledServiceImpl"><a href="#SuccessKilledServiceImpl" class="headerlink" title="SuccessKilledServiceImpl"></a>SuccessKilledServiceImpl</h4><p>å®ç°äº† SuccessKilledService æ¥å£ï¼Œå¹¶ç»§æ‰¿äº† MyBatis-Plus æä¾›çš„ <code>ServiceImpl&lt;SuccessKilledMapper, SuccessKilled&gt;</code>ï¼Œå› æ­¤ è‡ªåŠ¨ç»§æ‰¿äº†å¤§éƒ¨åˆ† CRUD æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SuccessKilledServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;SuccessKilledMapper, SuccessKilled&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SuccessKilledService</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-8-inneråŒ…"><a href="#3-2-8-inneråŒ…" class="headerlink" title="3.2.8 inneråŒ…"></a>3.2.8 inneråŒ…</h3><p><img src="/img/blogs/java/goodskill/3.2.11.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="æ¥å£-SeckillExecutor"><a href="#æ¥å£-SeckillExecutor" class="headerlink" title="æ¥å£ SeckillExecutor"></a>æ¥å£ SeckillExecutor</h4><p>SeckillExecutor æ˜¯ä¸€ä¸ª<strong>å®šä¹‰äº†æ ‡å‡†ç§’æ€å¤„ç†æ–¹æ³•çš„æ¥å£</strong>ï¼Œä¸ºæ•´ä¸ªç§’æ€ç³»ç»Ÿä¸­ä¸åŒçš„æ‰§è¡Œç­–ç•¥æä¾›ç»Ÿä¸€çš„æ‰©å±•å…¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SeckillExecutor</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ç§’æ€å†…éƒ¨å¤„ç†æ–¹æ³•</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">dealSeckill</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, String userPhone, String note, String taskId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="å®ç°ç±»-SeckillProcedureExecutor"><a href="#å®ç°ç±»-SeckillProcedureExecutor" class="headerlink" title="å®ç°ç±» SeckillProcedureExecutor"></a>å®ç°ç±» SeckillProcedureExecutor</h4><p>æ˜¯ SeckillExecutor æ¥å£çš„ä¸€ä¸ªå…·ä½“å®ç°ï¼Œç”¨äºå¤„ç†ç”¨æˆ·å‘èµ·çš„ç§’æ€è¯·æ±‚</p>
<p>è¿™æ˜¯ä¸€ä¸ªåŸºäº<strong>æ•°æ®åº“å­˜å‚¨è¿‡ç¨‹&#x2F;ä¹è§‚é”é€»è¾‘çš„ç§’æ€æ‰§è¡Œå™¨å®ç°ç±»</strong>ï¼Œä¸»è¦èŒè´£æ˜¯ï¼š</p>
<ul>
<li>å°è¯•ä¸ºç”¨æˆ·æ‰§è¡Œä¸€æ¬¡ç§’æ€æ“ä½œ</li>
<li>åœ¨åº“å­˜å”®ç½„æ—¶ï¼Œè§¦å‘çŠ¶æ€æœºå˜æ›´ã€é€šçŸ¥ä¸‹æ¸¸ç³»ç»Ÿï¼ˆå¦‚é€šè¿‡ StreamBridge å‘æ¶ˆæ¯ï¼‰</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillProcedureExecutor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SeckillExecutor</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¤„ç†ç”¨æˆ·ç§’æ€è¯·æ±‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€æ´»åŠ¨id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userPhone ç§’æ€ç”¨æˆ·æ‰‹æœºå·</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> note      ç§’æ€å¤‡æ³¨ä¿¡æ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId    ç§’æ€ä»»åŠ¡id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dealSeckill</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, String userPhone, String note, String taskId)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">InetAddress</span> <span class="hljs-variable">localHost</span> <span class="hljs-operator">=</span> InetAddress.getLocalHost();<br>            <span class="hljs-type">SuccessKilledDTO</span> <span class="hljs-variable">successKilled</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilledDTO</span>();<br>            successKilled.setSeckillId(seckillId);<br>            successKilled.setUserPhone(userPhone);<br>            successKilled.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>            successKilled.setServerIp(localHost.getHostAddress() + <span class="hljs-string">&quot;:&quot;</span> + localHost.getHostName());<br>            <span class="hljs-keyword">if</span> (seckillService.reduceNumber(successKilled) &lt; <span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> seckillMapper.selectById(seckillId);<br>                log.debug(<span class="hljs-string">&quot;#dealSeckill å½“å‰åº“å­˜ï¼š&#123;&#125;ï¼Œç§’æ€æ´»åŠ¨id:&#123;&#125;ï¼Œå•†å“id:&#123;&#125;&quot;</span>, seckill.getNumber(), seckill.getSeckillId(), seckill.getGoodsId());<br>                <span class="hljs-keyword">if</span> (stateMachineService.checkState(seckillId, States.IN_PROGRESS)) &#123;<br>                    stateMachineService.feedMachine(Events.ACTIVITY_CALCULATE, seckillId);<br>                    <span class="hljs-comment">// é«˜å¹¶å‘æ—¶å¯èƒ½å¤šæ¬¡å‘é€å®Œæˆé€šçŸ¥ï¼Œä½¿ç”¨é”æ§åˆ¶</span><br>                    <span class="hljs-type">Boolean</span> <span class="hljs-variable">endFlag</span> <span class="hljs-operator">=</span> redisService.setSeckillEndFlag(seckillId, taskId);<br>                    <span class="hljs-keyword">if</span> (endFlag) &#123;<br>                        streamBridge.send(DEFAULT_BINDING_NAME, MessageBuilder.withPayload(<br>                                        SeckillMockResponseDTO.builder().seckillId(seckillId).note(note).status(<span class="hljs-literal">true</span>).taskId(taskId).build())<br>                                .build());<br>                        log.info(<span class="hljs-string">&quot;#dealSeckill å•†å“å·²å”®ç½„ï¼Œæœ€æ–°ç§’æ€ä¿¡æ¯ï¼š&#123;&#125;&quot;</span>, seckill);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (seckill.getNumber() &lt;= <span class="hljs-number">0</span>) &#123;<br>                    log.debug(<span class="hljs-string">&quot;#dealSeckill åº“å­˜ä¸è¶³ï¼Œæ— æ³•ç»§ç»­ç§’æ€ï¼&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownHostException e) &#123;<br>            log.error(e.getMessage(), e);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-9-mapperå±‚"><a href="#3-2-9-mapperå±‚" class="headerlink" title="3.2.9 mapperå±‚"></a>3.2.9 mapperå±‚</h3><p><img src="/img/blogs/java/goodskill/3.2.12.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™ä¸‰ä¸ª Mapper æ¥å£æ˜¯åŸºäº MyBatis-Plus çš„æ•°æ®è®¿é—®æ¥å£ï¼Œå®ƒä»¬åˆ†åˆ«å¯¹åº”æ•°æ®åº“ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒè¡¨ï¼š<strong>å•†å“è¡¨ã€ç§’æ€æ´»åŠ¨è¡¨ã€ç§’æ€æˆåŠŸè®°å½•è¡¨</strong></p>
<ul>
<li><code>GoodsMapper</code>ï¼šæ“ä½œ<strong>å•†å“è¡¨</strong> goods çš„æ•°æ®åº“æ¥å£</li>
<li><code>SeckillMapper</code>ï¼šæ“ä½œ<strong>ç§’æ€æ´»åŠ¨è¡¨</strong> seckill çš„æ•°æ®åº“æ¥å£<ul>
<li>æ‰©å±•äº†ä¸¤ä¸ªç”¨äºåº“å­˜æ‰£å‡çš„è‡ªå®šä¹‰ SQL æ–¹æ³•ï¼š<ul>
<li>æ™®é€šçš„ SQL æ‰£å‡åº“å­˜è¯­å¥</li>
<li>åŠ å…¥äº† <strong>ä¹è§‚é”æ§åˆ¶</strong>çš„æ‰£å‡æ–¹å¼ï¼ˆé€šè¿‡ä¼ å…¥ number ä¿è¯ç‰ˆæœ¬ä¸€è‡´æ€§ï¼‰</li>
</ul>
</li>
</ul>
</li>
<li><code>SuccessKilledMapper</code>ï¼šæ“ä½œ<strong>ç§’æ€æˆåŠŸè®°å½•è¡¨</strong> success_killed çš„æ•°æ®åº“æ¥å£</li>
</ul>
<h3 id="3-2-10-mock-strategy"><a href="#3-2-10-mock-strategy" class="headerlink" title="3.2.10 mock.strategy"></a>3.2.10 mock.strategy</h3><p><img src="/img/blogs/java/goodskill/3.2.13.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="GoodsKillStrategy"><a href="#GoodsKillStrategy" class="headerlink" title="GoodsKillStrategy"></a>GoodsKillStrategy</h4><p>æ¥å£ GoodsKillStrategy æ˜¯ä¸€ä¸ª <strong>ç§’æ€ç­–ç•¥æ¥å£</strong>ï¼Œç”¨äºæ”¯æŒç­–ç•¥æ¨¡å¼ï¼Œç›®çš„æ˜¯æ ¹æ®ä¸åŒçš„ç­–ç•¥ï¼Œæ‰§è¡Œä¸åŒçš„â€œç§’æ€å¤„ç†é€»è¾‘â€ã€‚</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ªç»Ÿä¸€çš„<strong>ç§’æ€å¤„ç†æ–¹æ³•</strong> execute(â€¦)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç§’æ€ç­–ç•¥æ¥å£</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰§è¡Œç§’æ€</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestDto ç§’æ€è¯·æ±‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ç­–ç•¥1ï¼šAtomicUpdateStrategyåŸå­æ›´æ–°ç­–ç•¥"><a href="#ç­–ç•¥1ï¼šAtomicUpdateStrategyåŸå­æ›´æ–°ç­–ç•¥" class="headerlink" title="ç­–ç•¥1ï¼šAtomicUpdateStrategyåŸå­æ›´æ–°ç­–ç•¥"></a>ç­–ç•¥1ï¼šAtomicUpdateStrategyåŸå­æ›´æ–°ç­–ç•¥</h4><p>å®ç°äº†ç§’æ€ç­–ç•¥æ¥å£ GoodsKillStrategy çš„ä¸€ç§å…·ä½“ç­–ç•¥å®ç°ï¼Œå±äº<strong>åŸå­æ›´æ–°ç­–ç•¥</strong>ï¼ˆAtomic Updateï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicUpdateStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        seckillExecutor.dealSeckill(requestDto.getSeckillId(), requestDto.getPhoneNumber(), ATOMIC_UPDATE.getName(), requestDto.getTaskId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>AtomicUpdateStrategy æ›´å¼ºè°ƒï¼š</p>
<ul>
<li>ä½¿ç”¨ <strong>æ•°æ®åº“ä¹è§‚é”æœºåˆ¶ æˆ– åŸå­æ€§æ›´æ–°è¯­å¥</strong>ï¼ˆå¦‚ UPDATE â€¦ SET number &#x3D; number - 1 WHERE number &gt; 0ï¼‰</li>
<li>æ¥ä¿éšœé«˜å¹¶å‘ç¯å¢ƒä¸‹çš„<strong>æ•°æ®ä¸€è‡´æ€§ä¸åº“å­˜å®‰å…¨</strong></li>
</ul>
<h4 id="ç­–ç•¥2ï¼šAtomicWithCanalStrategy"><a href="#ç­–ç•¥2ï¼šAtomicWithCanalStrategy" class="headerlink" title="ç­–ç•¥2ï¼šAtomicWithCanalStrategy"></a>ç­–ç•¥2ï¼šAtomicWithCanalStrategy</h4><p>AtomicWithCanalStrategy æ˜¯ä¸€ä¸ªç§’æ€ç­–ç•¥çš„å…·ä½“å®ç°ç±»ï¼Œç»“åˆäº†æ•°æ®åº“åŸå­æ€§æ›´æ–°æ“ä½œä¸**Canalç›‘å¬ binlogï¼ˆæ•°æ®åº“å˜æ›´æ—¥å¿—)**çš„æ¶æ„æ€è·¯ï¼Œæ¥å®Œæˆé«˜å¹¶å‘ç§’æ€çš„å¤„ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicWithCanalStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SeckillMapper seckillMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SuccessKilledMapper successKilledMapper;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineService stateMachineService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Object&gt; seckillIdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> requestDto.getSeckillId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> requestDto.getPhoneNumber();<br>        <span class="hljs-comment">// æ­¤å¤„å·²ä¼˜åŒ–ï¼Œé”å•ä¸ªå•†å“è€Œä¸æ˜¯æ•´ä¸ªæ–¹æ³•</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">seckillMonitor</span> <span class="hljs-operator">=</span> seckillIdList.get(seckillId);<br>        <span class="hljs-keyword">if</span> (seckillMonitor == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            seckillIdList.put(seckillId, value);<br>        &#125;<br>        <span class="hljs-keyword">synchronized</span> (seckillIdList.get(seckillId)) &#123;<br>            <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> seckillMapper.selectById(seckillId);<br>            <span class="hljs-keyword">if</span> (seckill.getNumber() &gt; <span class="hljs-number">0</span>) &#123;<br>                seckillMapper.reduceNumber(seckillId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>                <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilled</span>();<br>                record.setSeckillId(seckillId);<br>                record.setUserPhone(String.valueOf(userId));<br>                record.setStatus(<span class="hljs-number">1</span>);<br>                record.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>                successKilledMapper.insert(record);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                stateMachineService.feedMachine(Events.ACTIVITY_CALCULATE, seckillId);<br>                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                    log.debug(<span class="hljs-string">&quot;#execute åº“å­˜ä¸è¶³ï¼Œæ— æ³•ç»§ç»­ç§’æ€ï¼&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨ç§’æ€æ—¶ï¼š</p>
<ol>
<li>åˆ©ç”¨ <strong>æ•°æ®åº“å±‚çš„åŸå­æ›´æ–°æ“ä½œï¼ˆSQLè¯­å¥ç›´æ¥å‡å°‘åº“å­˜ï¼‰</strong> æ¥é˜²æ­¢è¶…å–ã€‚</li>
<li>åˆ©ç”¨ <strong>å±€éƒ¨åŒæ­¥é”ï¼ˆæŒ‰å•†å“ ID åŠ é”ï¼‰</strong> æ¥æ§åˆ¶å¹¶å‘ã€‚</li>
<li>å°†ç”¨æˆ·ç§’æ€æˆåŠŸä¿¡æ¯æ’å…¥æ•°æ®åº“ï¼ˆåç»­å¯é€šè¿‡ Canal ç›‘å¬è¯¥è¡¨çš„ binlog è¿›è¡Œå¼‚æ­¥å¤„ç†ï¼Œæ¯”å¦‚å‘æ”¾ä¼˜æƒ åˆ¸ã€é€šçŸ¥ç”¨æˆ·ç­‰ï¼‰ã€‚</li>
<li>åœ¨åº“å­˜è€—å°½æ—¶ï¼Œé€šçŸ¥çŠ¶æ€æœºè¿›å…¥â€œç»“æŸè®¡ç®—â€çŠ¶æ€ã€‚</li>
</ol>
<h4 id="ç­–ç•¥3ï¼šRedisMongoReactiveStrategy"><a href="#ç­–ç•¥3ï¼šRedisMongoReactiveStrategy" class="headerlink" title="ç­–ç•¥3ï¼šRedisMongoReactiveStrategy"></a>ç­–ç•¥3ï¼šRedisMongoReactiveStrategy</h4><p>RedisMongoReactiveStrategy ç±»çš„ç­–ç•¥æ˜¯å¤„ç†ç§’æ€è¯·æ±‚çš„å¼‚æ­¥é€»è¾‘ã€‚å®ƒä¸»è¦é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>å¼‚æ­¥æ‰§è¡Œç§’æ€è¯·æ±‚ã€‚</li>
<li>ä½¿ç”¨ Redis æ¥åˆ¤æ–­ç§’æ€å•†å“åº“å­˜ï¼Œå¹¶è¿›è¡Œå¢é‡æ“ä½œã€‚</li>
<li>è‹¥ç§’æ€æˆåŠŸï¼Œå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œè¿›è¡Œ MongoDB ä¿å­˜æ“ä½œã€‚</li>
<li>è‹¥ç§’æ€å¤±è´¥ï¼ˆåº“å­˜ä¸è¶³ï¼‰ï¼Œé€šè¿‡çŠ¶æ€æœºæ£€æŸ¥æ´»åŠ¨çŠ¶æ€ï¼Œå¹¶å‘é€ç§’æ€ç»“æŸçš„æ¶ˆæ¯ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMongoReactiveStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisService redisService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br>    <span class="hljs-meta">@Resource(name = &quot;taskExecutor&quot;)</span><br>    <span class="hljs-keyword">private</span> ThreadPoolExecutor taskExecutor;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StreamBridge streamBridge;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineService stateMachineService;<br>    <span class="hljs-comment">//å½“æ”¶åˆ°ç§’æ€è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå°†è¯·æ±‚äº¤ç»™çº¿ç¨‹æ±  taskExecutor å¼‚æ­¥æ‰§è¡Œã€‚</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        taskExecutor.execute(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                doExecute(requestDto);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;ç§’æ€å¤±è´¥&quot;</span>, e);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">//æ‰§è¡Œç§’æ€é€»è¾‘çš„ä¸»è¦æ–¹æ³•</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doExecute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> requestDto.getSeckillId();<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> redisService.getSeckill(seckillId);<br>        <span class="hljs-keyword">if</span> (redisTemplate.opsForValue().increment(String.valueOf(seckillId)) &lt;= seckill.getNumber()) &#123;<br>            taskExecutor.execute(() -&gt;<br>                    streamBridge.send(DEFAULT_BINDING_NAME_MONGO_SAVE, MessageBuilder.withPayload(<br>                            SeckillMockSaveVo<br>                                    .builder()<br>                                    .seckillId(seckillId)<br>                                    .userPhone(requestDto.getPhoneNumber())<br>                                    .note(REDIS_MONGO_REACTIVE.getName())<br>                                    .build())<br>                            .build())<br>            );<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                seckill = redisService.getSeckill(seckillId);<br>                <span class="hljs-keyword">if</span> (stateMachineService.checkState(seckillId, States.IN_PROGRESS)) &#123;<br>                    stateMachineService.feedMachine(Events.ACTIVITY_CALCULATE, seckillId);<br>                    log.info(<span class="hljs-string">&quot;ç§’æ€å•†å“æš‚æ— åº“å­˜ï¼Œå‘é€æ´»åŠ¨ç»“æŸæ¶ˆæ¯ï¼&quot;</span>);<br>                    streamBridge.send(DEFAULT_BINDING_NAME, MessageBuilder.withPayload(<br>                            SeckillMockResponseDTO<br>                                    .builder()<br>                                    .status(<span class="hljs-literal">true</span>)<br>                                    .seckillId(seckillId)<br>                                    .note(REDIS_MONGO_REACTIVE.getName())<br>                                    .taskId(requestDto.getTaskId())<br>                                    .build())<br>                            .build());<br>                    seckill.setStatus(SeckillStatusConstant.END);<br>                    redisService.putSeckill(seckill);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ç­–ç•¥4ï¼šRedissonStrategy"><a href="#ç­–ç•¥4ï¼šRedissonStrategy" class="headerlink" title="ç­–ç•¥4ï¼šRedissonStrategy"></a>ç­–ç•¥4ï¼šRedissonStrategy</h4><p>é€šè¿‡<strong>åˆ†å¸ƒå¼é” Redisson ä¿è¯åœ¨é«˜å¹¶å‘ä¸‹å¯¹åŒä¸€ä¸ªå•†å“çš„ç§’æ€æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨</strong>çš„ï¼Œ<strong>é¿å…è¶…å–é—®é¢˜</strong>ã€‚</p>
<ul>
<li>RedissonStrategy æ˜¯ä¸€ç§ åŸºäº Redisson åˆ†å¸ƒå¼é”çš„ç§’æ€ç­–ç•¥ï¼Œå®ƒé€šè¿‡ç»™æ¯ä¸ªç§’æ€å•†å“åŠ é”æ¥ç¡®ä¿åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¤„ç†æŸä¸ªå•†å“çš„ç§’æ€é€»è¾‘ï¼Œä»è€Œå®ç°å¹¶å‘æ§åˆ¶å’Œåº“å­˜ä¸€è‡´æ€§ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br>    <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    ä¸ºå½“å‰å•†å“è·å–ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼ˆé”åä¸ºå•†å“ ID çš„å­—ç¬¦ä¸²ï¼‰ã€‚</span><br><span class="hljs-comment">    ä½¿ç”¨çš„æ˜¯ å¯é‡å…¥é” RLockï¼Œå¤šä¸ªèŠ‚ç‚¹ä¸‹çš„å¹¶å‘ç”¨æˆ·éƒ½ä¼šç«äº‰è¿™ä¸ªé”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(requestDto.getSeckillId() + <span class="hljs-string">&quot;&quot;</span>);<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            seckillExecutor.dealSeckill(requestDto.getSeckillId(), requestDto.getPhoneNumber(), REDISSION_LOCK.getName(), requestDto.getTaskId());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ç­–ç•¥5ï¼šSentinelLimitStrategy"><a href="#ç­–ç•¥5ï¼šSentinelLimitStrategy" class="headerlink" title="ç­–ç•¥5ï¼šSentinelLimitStrategy"></a>ç­–ç•¥5ï¼šSentinelLimitStrategy</h4><p>SentinelLimitStrategy æ˜¯ä¸€ä¸ªåŸºäº <strong>Sentinel çš„é™æµç­–ç•¥</strong>ï¼Œç”¨äºåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢ç§’æ€æ¥å£è¢«è¿‡è½½è°ƒç”¨å¯¼è‡´ç³»ç»Ÿå´©æºƒã€‚å®ƒæ˜¯ GoodsKillStrategy æ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œæ ¸å¿ƒæ˜¯<strong>åˆ©ç”¨ Sentinel åšæµé‡æ§åˆ¶ï¼ˆé™æµï¼‰</strong>ã€‚</p>
<ul>
<li>é€šè¿‡ Sentinel å®ç°é™æµä¿æŠ¤æœºåˆ¶ï¼Œé™åˆ¶æ¯ç§’è¿›å…¥ç§’æ€ç³»ç»Ÿçš„è¯·æ±‚æ•°é‡ï¼›</li>
<li>ä¸€æ—¦è¯·æ±‚è¶…è¿‡é˜ˆå€¼ï¼ŒSentinel ä¼šè§¦å‘ blockHandler æ–¹æ³•ï¼Œè¿›è¡Œé™çº§å¤„ç†ï¼Œè€Œä¸ä¼šç»§ç»­æ‰§è¡Œç§’æ€é€»è¾‘ï¼›</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SentinelLimitStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@SentinelResource(value = &quot;limit&quot;, blockHandler = &quot;exceptionHandler&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        seckillExecutor.dealSeckill(requestDto.getSeckillId(), requestDto.getPhoneNumber(), ATOMIC_UPDATE.getName(), requestDto.getTaskId());<br>    &#125;<br><br>    <span class="hljs-comment">// ç›¸å½“äºä¸€ç§â€œç†”æ–­é™çº§å¤„ç†â€ï¼Œç³»ç»Ÿè¿‡è½½æ—¶æ‹’ç»è¯·æ±‚ï¼Œè€Œä¸æ˜¯è®©æœåŠ¡å®•æœº</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionHandler</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, String userPhone, String note, BlockException ex)</span> &#123;<br>        log.error(<span class="hljs-string">&quot;Oops, error occurred at &#123;&#125;:&#123;&#125;:&#123;&#125;&quot;</span>, seckillId, userPhone, note, ex);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>é€šè¿‡ Sentinel çš„æµæ§è§„åˆ™å¯¹æŒ‡å®šæ–¹æ³•åšé™æµ</li>
<li>Sentinel çš„é™æµæ˜¯åŸºäºæ»‘åŠ¨çª—å£ç®—æ³•å®ç°ï¼Œæ€§èƒ½å¼€é”€ä½</li>
</ul>
<h4 id="ç­–ç•¥6ï¼šSynchronizedLockStrategy"><a href="#ç­–ç•¥6ï¼šSynchronizedLockStrategy" class="headerlink" title="ç­–ç•¥6ï¼šSynchronizedLockStrategy"></a>ç­–ç•¥6ï¼šSynchronizedLockStrategy</h4><p>é‡‡ç”¨çš„æ˜¯æœ€ä¼ ç»Ÿçš„ Java æœ¬åœ°é” synchronized å…³é”®å­—æ¥æ§åˆ¶å¹¶å‘æ“ä½œï¼Œé˜²æ­¢ç§’æ€è¶…å–ã€‚</p>
<p>å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š<strong>å¯¹æ¯ä¸ªå•†å“ ID å»ºç«‹ä¸€ä¸ªç›‘è§†å¯¹è±¡</strong>ï¼ˆObjectï¼‰ï¼Œç„¶å<strong>ç”¨ synchronized å…³é”®å­—å¯¹è¿™ä¸ªå•†å“åŠ é”</strong>ï¼Œ<strong>å®ç°å•å•†å“çš„å¹¶å‘æ§åˆ¶</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SynchronizedLockStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillMapper seckillMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SuccessKilledMapper successKilledMapper;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StreamBridge streamBridge;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineService stateMachineService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;Long, Object&gt; seckillIdList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> requestDto.getSeckillId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> requestDto.getPhoneNumber();<br>        <span class="hljs-comment">// æ­¤å¤„å·²ä¼˜åŒ–ï¼Œé”å•ä¸ªå•†å“è€Œä¸æ˜¯æ•´ä¸ªæ–¹æ³•</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">seckillMonitor</span> <span class="hljs-operator">=</span> seckillIdList.get(seckillId);<br>        <span class="hljs-keyword">if</span> (seckillMonitor == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>            seckillIdList.put(seckillId, value);<br>        &#125;<br>        <span class="hljs-keyword">synchronized</span> (seckillIdList.get(seckillId)) &#123;<br>            <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> seckillMapper.selectById(seckillId);<br>            <span class="hljs-keyword">if</span> (seckill.getNumber() &gt; <span class="hljs-number">0</span>) &#123;<br>                seckillMapper.reduceNumber(seckillId, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>                <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SuccessKilled</span>();<br>                record.setSeckillId(seckillId);<br>                record.setUserPhone(String.valueOf(userId));<br>                record.setStatus(<span class="hljs-number">1</span>);<br>                record.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>                successKilledMapper.insert(record);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">if</span> (stateMachineService.checkState(seckillId, States.IN_PROGRESS)) &#123;<br>                    stateMachineService.feedMachine(Events.ACTIVITY_CALCULATE, seckillId);<br>                    streamBridge.send(DEFAULT_BINDING_NAME, MessageBuilder.withPayload(<br>                                    SeckillMockResponseDTO<br>                                            .builder()<br>                                            .seckillId(seckillId)<br>                                            .status(<span class="hljs-literal">true</span>)<br>                                            .note(SYCHRONIZED.getName())<br>                                            .taskId(requestDto.getTaskId())<br>                                            .build())<br>                            .build());<br>                &#125;<br>                <span class="hljs-keyword">if</span> (log.isDebugEnabled()) &#123;<br>                    log.debug(<span class="hljs-string">&quot;åº“å­˜ä¸è¶³ï¼Œæ— æ³•ç»§ç»­ç§’æ€ï¼&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ul>
<li>SynchronizedLockStrategy æ˜¯ä¸€ç§åŸºäº Java æœ¬åœ°é”ã€æŒ‰å•†å“ç²’åº¦åŠ é”çš„ç§’æ€ç­–ç•¥ï¼Œé€‚ç”¨äºå•æœºé¡¹ç›®ï¼Œç®€å•æ˜“å®ç°ï¼Œä½†ä¸é€‚åˆå¤šèŠ‚ç‚¹éƒ¨ç½²ã€‚</li>
</ul>
<h4 id="ç­–ç•¥7ï¼šZookeeperLockStrategy"><a href="#ç­–ç•¥7ï¼šZookeeperLockStrategy" class="headerlink" title="ç­–ç•¥7ï¼šZookeeperLockStrategy"></a>ç­–ç•¥7ï¼šZookeeperLockStrategy</h4><p><strong>åŸºäº Zookeeper åˆ†å¸ƒå¼é”çš„ç§’æ€ç­–ç•¥</strong>ã€‚å®ƒé€šè¿‡ Apache Curator æä¾›çš„ InterProcessMutexï¼ˆåˆ†å¸ƒå¼å¯é‡å…¥é”ï¼‰æ¥æ§åˆ¶å¯¹ç§’æ€å•†å“çš„å¹¶å‘è®¿é—®ï¼Œç¡®ä¿åœ¨åˆ†å¸ƒå¼éƒ¨ç½²ç¯å¢ƒä¸‹çš„æ•°æ®ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZookeeperLockStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> ZookeeperLockUtil zookeeperLockUtil;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> requestDto.getSeckillId();<br>        <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> zookeeperLockUtil.lock(seckillId);<br>        <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                seckillExecutor.dealSeckill(seckillId, requestDto.getPhoneNumber(), ZOOKEEPER_LOCK.getName(), requestDto.getTaskId());<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                lock.release();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ul>
<li>æä¾›çš„ä¸€ç§ <strong>å¯é‡å…¥ã€é˜»å¡å¼åˆ†å¸ƒå¼é”</strong>å®ç°</li>
<li>ä¿è¯åœ¨å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ä¸­ï¼ŒæŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è·å¾—é”æ¥æ“ä½œè¯¥å•†å“ã€‚</li>
<li>æœ€åé‡Šæ”¾é”ï¼Œæ— è®ºæ‰§è¡ŒæˆåŠŸä¸å¦ï¼Œ<strong>å¿…é¡»é‡Šæ”¾é”é˜²æ­¢æ­»é”</strong>ã€‚</li>
</ul>
<h3 id="3-2-11-mq"><a href="#3-2-11-mq" class="headerlink" title="3.2.11 mq"></a>3.2.11 mq</h3><p><img src="/img/blogs/java/goodskill/3.2.14.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="SeckillKafkaConsumer"><a href="#SeckillKafkaConsumer" class="headerlink" title="SeckillKafkaConsumer"></a>SeckillKafkaConsumer</h4><p><strong>åŸºäº Kafka æ¶ˆæ¯é˜Ÿåˆ—çš„æ¶ˆè´¹è€…ç»„ä»¶</strong>ï¼Œç”¨äº<strong>å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚</strong>ã€‚å®ƒç›‘å¬åä¸º â€œgoodskill-kafkaâ€ çš„ Kafka ä¸»é¢˜ï¼Œæ¥æ”¶åˆ°ç§’æ€æ¶ˆæ¯åï¼Œè°ƒç”¨æ ¸å¿ƒä¸šåŠ¡å¤„ç†ç±» SeckillExecutor æ‰§è¡Œå…·ä½“çš„ç§’æ€æ“ä½œã€‚<br>SeckillKafkaConsumer æ˜¯ä¸€ä¸ª Kafka æ¶ˆè´¹è€…ç±»ï¼Œä¸»è¦ç”¨äºæ¥æ”¶å¼‚æ­¥ç§’æ€è¯·æ±‚æ¶ˆæ¯ï¼Œè§£åŒ…åè°ƒç”¨å®é™…çš„ç§’æ€å¤„ç†é€»è¾‘ï¼Œå®ç°â€œå‰Šå³°å¡«è°·â€ï¼Œæœ‰æ•ˆç¼“è§£é«˜å¹¶å‘å¸¦æ¥çš„ç³»ç»Ÿå‹åŠ›ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillKafkaConsumer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@KafkaListener(topics = &quot;goodskill-kafka&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Object data)</span> &#123;<br>        <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">instanceof</span> ConsumerRecord record) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">userPhone</span> <span class="hljs-operator">=</span> record.key().toString();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (String) record.value();<br>            SeckillMockRequestDTO seckillMockRequestDTO;<br>            <span class="hljs-keyword">if</span> (StringUtils.hasText(value)) &#123;<br>                seckillMockRequestDTO = JSON.parseObject(value, SeckillMockRequestDTO.class);<br>                seckillExecutor.dealSeckill(seckillMockRequestDTO.getSeckillId(), userPhone, <span class="hljs-string">&quot;ç§’æ€åœºæ™¯å››(kafkaæ¶ˆæ¯é˜Ÿåˆ—å®ç°)&quot;</span>, seckillMockRequestDTO.getTaskId());<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            log.warn(<span class="hljs-string">&quot;æœªå¤„ç†æ•°æ®ï¼š&#123;&#125;&quot;</span>, data.toString());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="StreamMessageConsumer"><a href="#StreamMessageConsumer" class="headerlink" title="StreamMessageConsumer"></a>StreamMessageConsumer</h4><p>StreamMessageConsumer æ˜¯ä¸€ä¸ª åŸºäº Spring Cloud Stream çš„<strong>æ¶ˆæ¯æ¶ˆè´¹è€…é…ç½®ç±»</strong>ï¼Œç”¨äº<strong>å¤„ç†æ¥è‡ªæ¶ˆæ¯ä¸­é—´ä»¶</strong>ï¼ˆå¦‚ RabbitMQã€Kafkaã€RocketMQ ç­‰ï¼‰çš„<strong>ç§’æ€è¯·æ±‚æ¶ˆæ¯</strong>ã€‚å®ƒå°†æ¥æ”¶åˆ°çš„ SeckillMockRequestDTO ç±»å‹æ¶ˆæ¯äº¤ç”± SeckillExecutor æ‰§è¡Œï¼Œä»è€Œå®Œæˆå¼‚æ­¥ã€è§£è€¦çš„ç§’æ€æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamMessageConsumer</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">log</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(StreamMessageConsumer.class);<br><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setSeckillExecutor</span><span class="hljs-params">(SeckillExecutor seckillExecutor)</span> &#123;<br>        <span class="hljs-built_in">this</span>.seckillExecutor = seckillExecutor;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Consumer&lt;SeckillMockRequestDTO&gt; <span class="hljs-title function_">seckill</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span>  (payload) -&gt; &#123;<br>            log.info(<span class="hljs-string">&quot;æ”¶åˆ°ç§’æ€è¯·æ±‚:&#123;&#125;&quot;</span>, payload);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">userPhone</span> <span class="hljs-operator">=</span> payload.getPhoneNumber();<br>            <span class="hljs-type">Long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> payload.getSeckillId();<br>            seckillExecutor.dealSeckill(seckillId, userPhone, SeckillSolutionEnum.RABBIT_MQ.name(), payload.getTaskId());<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-12-pojo"><a href="#3-2-12-pojo" class="headerlink" title="3.2.12 pojo"></a>3.2.12 pojo</h3><p><img src="/img/blogs/java/goodskill/3.2.15.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li><code>ResponseDTO&lt;T&gt;</code><br>é€šç”¨å“åº”å°è£…ç±»ï¼Œç”¨äºåœ¨ç³»ç»Ÿä¸­<strong>ç»Ÿä¸€è¿”å›ç»“æœæ ¼å¼</strong>ï¼Œä¾¿äºå‰åç«¯äº¤äº’æ—¶çš„æ•°æ®ç»“æ„ä¸€è‡´æ€§å’Œå¤„ç†ç»Ÿä¸€æ€§ã€‚ä½ å¯ä»¥ç†è§£ä¸ºè¿™æ˜¯ä¸€ä¸ªå‰åç«¯é€šä¿¡çš„â€œæ ‡å‡†è¿”å›æ¨¡æ¿â€ã€‚<br>ResponseDTO<T> ç”¨äºåŒ…è£…æ¥å£çš„è¿”å›æ•°æ®ï¼Œæ”¯æŒæºå¸¦ï¼š</li>
</ol>
<ul>
<li>çŠ¶æ€ç ï¼ˆcodeï¼‰</li>
<li>æç¤ºä¿¡æ¯ï¼ˆmsgï¼‰</li>
<li>æ€»è®°å½•æ•°ï¼ˆcountï¼‰</li>
<li>å®é™…è¿”å›çš„æ•°æ®æ•°ç»„ï¼ˆdataï¼‰</li>
</ul>
<p><strong>å®ƒå¯ä»¥ç»Ÿä¸€è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥çš„å“åº”ç»“æœ</strong></p>
<ol start="2">
<li><code>PageVO&lt;T&gt;</code><br>PageVO<T> æ˜¯ä¸€ä¸ª<strong>é€šç”¨åˆ†é¡µç»“æœå¯¹è±¡</strong>ï¼Œç”¨äºç»Ÿä¸€å°è£…åˆ†é¡µæ¥å£çš„è¿”å›ç»“æœï¼ŒåŒ…æ‹¬ï¼š</li>
</ol>
<ul>
<li>æ€»è®°å½•æ•° total</li>
<li>å½“å‰é¡µçš„æ•°æ®é¡¹ items</li>
</ul>
<ol start="3">
<li><code>UserVO</code>ç”¨æˆ·è§†å›¾å¯¹è±¡<br>UserVO æ˜¯ç”¨æ¥è¡¨ç¤º<strong>ç”¨æˆ·ä¿¡æ¯çš„å±•ç¤ºæ¨¡å‹</strong>ï¼Œé€šå¸¸æ˜¯æ¥å£è¿”å›ç”¨æˆ·ä¿¡æ¯æ—¶ä½¿ç”¨çš„ç»“æ„ï¼Œæ˜¯ä»æ•°æ®åº“å®ä½“ Userï¼ˆæˆ–ç±»ä¼¼è¡¨ï¼‰è½¬æ¢è€Œæ¥</li>
</ol>
<h3 id="3-2-13-util"><a href="#3-2-13-util" class="headerlink" title="3.2.13 util"></a>3.2.13 util</h3><p><img src="/img/blogs/java/goodskill/3.2.16.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="StateMachineService"><a href="#StateMachineService" class="headerlink" title="StateMachineService"></a>StateMachineService</h4><p>é€šè¿‡ Spring StateMachine <strong>ç®¡ç†æ¯ä¸€ä¸ªç§’æ€æ´»åŠ¨çš„çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ</strong>ï¼Œ<br>ç”¨æ¥åè°ƒå•†å“åœ¨ä¸åŒçŠ¶æ€ä¸‹çš„è¡Œä¸ºï¼ˆæ¯”å¦‚è¿›è¡Œä¸­ã€å·²ç»“æŸç­‰ï¼‰ï¼Œå¹¶ä¸”é€šè¿‡ Redis å®ç°çŠ¶æ€æŒä¹…åŒ–å’Œè·¨æœåŠ¡å…±äº«ã€‚</p>
<p>è¯¥ç±»æ˜¯ä¸€ä¸ª <strong>çŠ¶æ€æœºç®¡ç†æœåŠ¡ç»„ä»¶</strong>ï¼Œä¸ºæ¯ä¸ªç§’æ€æ´»åŠ¨ï¼ˆä»¥ seckillId åŒºåˆ†ï¼‰ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹çš„çŠ¶æ€æœºå®ä¾‹ã€‚æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>feedMachine()</td>
<td>è¾“å…¥ä¸€ä¸ªäº‹ä»¶ï¼Œé©±åŠ¨çŠ¶æ€å˜åŒ–, ç»™çŠ¶æ€æœºå‘é€äº‹ä»¶ï¼Œé©±åŠ¨çŠ¶æ€æµè½¬</td>
</tr>
<tr>
<td>checkState()</td>
<td>æ£€æŸ¥æŒ‡å®šæ´»åŠ¨æ˜¯å¦å¤„äºæŸä¸ªçŠ¶æ€</td>
</tr>
<tr>
<td>initStateMachine()</td>
<td>åˆå§‹åŒ–æŸä¸ªæ´»åŠ¨çš„çŠ¶æ€æœºï¼Œå¹¶æŒä¹…åŒ–</td>
</tr>
</tbody></table>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StateMachineService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">STATEMACHINE_REDIS_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;seckillId:&quot;</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, StateMachine&lt;States, Events&gt;&gt; stateMachineMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineFactory&lt;States, Events&gt; stateMachineFactory;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachinePersister&lt;States, Events, String&gt; stateMachinePersister;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å‘çŠ¶æ€æœºä¸­è¾“å…¥äº‹ä»¶ï¼Œç”¨äºå¤„ç†æ´»åŠ¨äº‹ä»¶çš„æ–¹æ³•</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> e           å¾…å¤„ç†çš„æ´»åŠ¨äº‹ä»¶</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">feedMachine</span><span class="hljs-params">(Events e, <span class="hljs-type">long</span> seckillId)</span> &#123;<br>        StateMachine&lt;States, Events&gt; stateMachine = stateMachineMap.get(String.valueOf(seckillId));<br>        stateMachinePersister.restore(stateMachine, STATEMACHINE_REDIS_KEY_PREFIX + seckillId);<br>        StateMachineEventResult&lt;States, Events&gt; eventResult =<br>                stateMachine.sendEvent(Mono.just(MessageBuilder.withPayload(e).build())).blockLast();<br>        log.info(<span class="hljs-string">&quot;eventResult:&#123;&#125;&quot;</span>, eventResult);<br>        stateMachinePersister.persist(stateMachine, STATEMACHINE_REDIS_KEY_PREFIX + seckillId);<br>        <span class="hljs-keyword">return</span> eventResult != <span class="hljs-literal">null</span> &amp;&amp; StateMachineEventResult.ResultType.ACCEPTED.equals(eventResult.getResultType());<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ£€æŸ¥ç§’æ€æ´»åŠ¨çš„çŠ¶æ€æ˜¯å¦ç¬¦åˆè¦æ±‚</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€æ´»åŠ¨çš„ID</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> state     æŒ‡å®šçš„çŠ¶æ€</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> å¦‚æœå½“å‰çŠ¶æ€ä¸stateç›¸åŒåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">checkState</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId, States state)</span> &#123;<br>        StateMachine&lt;States, Events&gt; stateMachine = stateMachineMap.get(String.valueOf(seckillId));<br>        stateMachinePersister.restore(stateMachine, STATEMACHINE_REDIS_KEY_PREFIX + seckillId);<br>        <span class="hljs-keyword">return</span> stateMachine.getState().getId().equals(state);<br>    &#125;<br><br>    <span class="hljs-meta">@SneakyThrows</span><br>    <span class="hljs-keyword">public</span> StateMachine&lt;States, Events&gt; <span class="hljs-title function_">initStateMachine</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        StateMachine&lt;States, Events&gt; stateMachine = stateMachineFactory.getStateMachine();<br>        stateMachinePersister.persist(stateMachine, STATEMACHINE_REDIS_KEY_PREFIX + seckillId);<br>        <span class="hljs-keyword">return</span> stateMachineMap.putIfAbsent(String.valueOf(seckillId), stateMachine);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>StateMachineService æ˜¯ä¸€ä¸ªåŸºäº Spring StateMachine å®ç°çš„<strong>æ´»åŠ¨çŠ¶æ€ç®¡ç†ä¸­å¿ƒ</strong>ï¼Œæ¯ä¸ªå•†å“ç§’æ€æ´»åŠ¨éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„çŠ¶æ€æµè½¬è¿‡ç¨‹ï¼ˆå¼€å§‹ã€è¿›è¡Œä¸­ã€ç»“æŸï¼‰ï¼Œè¿™ä¸ªç±»è´Ÿè´£äº‹ä»¶é©±åŠ¨ã€çŠ¶æ€åˆ¤æ–­å’ŒæŒä¹…åŒ–æ“ä½œï¼Œç¡®ä¿ç³»ç»Ÿåœ¨å¹¶å‘ä¸‹ä»èƒ½å¯é åœ°è¿›è¡Œç§’æ€æµç¨‹æ§åˆ¶ã€‚</p>
<h4 id="UploadFileUtil"><a href="#UploadFileUtil" class="headerlink" title="UploadFileUtil"></a>UploadFileUtil</h4><p>å°è£…äº†ä¸€ä¸ª MinIO å®¢æˆ·ç«¯çš„æ–‡ä»¶ä¸Šä¼ å·¥å…·ç±»ï¼Œæä¾›äº†å°†æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯å‰ç«¯ä¸Šä¼ çš„å›¾ç‰‡ã€è§†é¢‘ã€æ–‡æ¡£ç­‰ï¼‰ä¸Šä¼ è‡³ MinIO å¯¹è±¡å­˜å‚¨æœåŠ¡çš„åŠŸèƒ½ï¼Œå¹¶è¿”å›è®¿é—®åœ°å€ã€‚</p>
<ul>
<li>UploadFileUtil æ˜¯ä¸€ä¸ª<strong>ä¸Šä¼ æ–‡ä»¶åˆ° MinIO å¹¶è¿”å›æ–‡ä»¶ URL çš„å·¥å…·ç±»</strong>ã€‚</li>
</ul>
<h4 id="ZookeeperLockUtil"><a href="#ZookeeperLockUtil" class="headerlink" title="ZookeeperLockUtil"></a>ZookeeperLockUtil</h4><p><strong>æä¾›åŸºäº ZooKeeper çš„åˆ†å¸ƒå¼é”åŠŸèƒ½</strong>ï¼Œä½¿ç”¨ Curator æ¡†æ¶å®ç°åˆ†å¸ƒå¼é”çš„è·å–å’Œé‡Šæ”¾ï¼Œä»¥ä¿è¯åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œç§’æ€æ´»åŠ¨ç­‰å¹¶å‘åœºæ™¯ä¸­çš„èµ„æºï¼ˆå¦‚åº“å­˜ï¼‰èƒ½å¤Ÿè¢«æœ‰æ•ˆæ§åˆ¶å’Œåè°ƒ</p>
<ul>
<li>ç”¨äºåœ¨å¹¶å‘åœºæ™¯ä¸­æ§åˆ¶å¯¹æŸä¸ªèµ„æºï¼ˆå¦‚ç§’æ€å•†å“åº“å­˜ï¼‰çš„è®¿é—®ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªçº¿ç¨‹&#x2F;è¿›ç¨‹èƒ½åœ¨åŒä¸€æ—¶åˆ»å¯¹å…¶è¿›è¡Œæ“ä½œ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ZookeeperLockUtil</span> &#123;<br><br>    <span class="hljs-keyword">private</span> CuratorFramework client;<br>    <span class="hljs-meta">@Value(&quot;$&#123;zookeeper_ip&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String zookeeperIp;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é‡‡ç”¨curatoræä¾›çš„äº’æ–¥é”è·å–é”æ–¹æ³•</span><br><span class="hljs-comment">     * é‡‡ç”¨çº¿ç¨‹æœ¬åœ°å˜é‡çš„æ–¹æ³•è§£å†³å¹¶å‘é—®é¢˜</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> seckillId ç§’æ€id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true åŠ é”æˆåŠŸ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> InterProcessMutex <span class="hljs-title function_">lock</span><span class="hljs-params">(<span class="hljs-type">long</span> seckillId)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">rootLockPath</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/goodskill&quot;</span>;<br>            <span class="hljs-type">InterProcessMutex</span> <span class="hljs-variable">interProcessMutex</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InterProcessMutex</span>(client, rootLockPath + <span class="hljs-string">&quot;/&quot;</span> + seckillId);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">acquire</span> <span class="hljs-operator">=</span> interProcessMutex.acquire(<span class="hljs-number">1000L</span>, TimeUnit.MILLISECONDS);<br>            <span class="hljs-keyword">if</span> (acquire) &#123;<br>                log.info(<span class="hljs-string">&quot;æˆåŠŸè·å–åˆ°zké”,ç§’æ€id&#123;&#125;&quot;</span>, seckillId);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                log.info(<span class="hljs-string">&quot;æœªè·å–åˆ°zké”,ç§’æ€id&#123;&#125;&quot;</span>, seckillId);<br>            &#125;<br>            <span class="hljs-keyword">return</span> interProcessMutex;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.warn(<span class="hljs-string">&quot;è·å–zké”å¼‚å¸¸:&#123;&#125;&quot;</span>, e.getMessage());<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initClient</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ–Curatorå®¢æˆ·ç«¯</span><br>        <span class="hljs-type">RetryPolicy</span> <span class="hljs-variable">retryPolicy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExponentialBackoffRetry</span>(<span class="hljs-number">1000</span>, <span class="hljs-number">3</span>);<br>        <span class="hljs-built_in">this</span>.client = CuratorFrameworkFactory.newClient(zookeeperIp, retryPolicy);<br>        client.start();<br>    &#125;<br><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stopLocal</span><span class="hljs-params">()</span> &#123;<br>        client.close();<br>        log.info(<span class="hljs-string">&quot;zkClientå·²å…³é—­&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-title function_">ZookeeperLockUtil</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-14-SeckillApplicationç§’æ€æœåŠ¡å¯åŠ¨ç±»"><a href="#3-2-14-SeckillApplicationç§’æ€æœåŠ¡å¯åŠ¨ç±»" class="headerlink" title="3.2.14 SeckillApplicationç§’æ€æœåŠ¡å¯åŠ¨ç±»"></a>3.2.14 SeckillApplicationç§’æ€æœåŠ¡å¯åŠ¨ç±»</h3><p>è¿™ä¸ªç±»æ˜¯ Spring Boot åº”ç”¨çš„å¯åŠ¨ç±»ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥é…ç½®å’Œå¯åŠ¨åº”ç”¨ï¼š</p>
<ol>
<li>å¯åŠ¨ Spring Boot åº”ç”¨ã€‚</li>
<li>å¯ç”¨è‡ªåŠ¨é…ç½®ã€äº‹åŠ¡ç®¡ç†ã€MyBatis Mapper æ‰«æã€æœåŠ¡å‘ç°ï¼ˆå¦‚ Eurekaï¼‰ã€Feign å®¢æˆ·ç«¯ç­‰åŠŸèƒ½ã€‚</li>
<li>å®šä¹‰äº† REST API æ§åˆ¶å™¨ï¼Œèƒ½å¤Ÿå¤„ç† HTTP è¯·æ±‚å¹¶è¿”å›å“åº”ã€‚</li>
<li>ä½¿ç”¨ Lombok è‡ªåŠ¨ç”Ÿæˆæ—¥å¿—åŠŸèƒ½</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication(scanBasePackages = &#123;</span><br><span class="hljs-meta">        &quot;com.goodskill.service&quot;,</span><br><span class="hljs-meta">        &quot;com.goodskill.core&quot;,</span><br><span class="hljs-meta">        &quot;com.goodskill.order.api&quot;,</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-meta">@MapperScan(&quot;com.goodskill.service.mapper&quot;)</span><br><span class="hljs-meta">@EnableDiscoveryClient</span><br><span class="hljs-meta">@EnableFeignClients(&#123;&quot;com.goodskill.order.api&quot;&#125;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillApplication</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">SpringApplication</span> <span class="hljs-variable">application</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpringApplication</span>(SeckillApplication.class);<br>        application.setBannerMode(Banner.Mode.CONSOLE);<br>        application.run(args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-15-application-yml"><a href="#3-2-15-application-yml" class="headerlink" title="3.2.15 application.yml"></a>3.2.15 application.yml</h3><p>åŒ…å«ä»¥ä¸‹é…ç½®ï¼š</p>
<ul>
<li>æœåŠ¡ç«¯å£å’Œåº”ç”¨ä¿¡æ¯ã€‚</li>
<li>æ•°æ®åº“è¿æ¥é…ç½®ï¼Œå¦‚ MySQL å’Œ Redisã€‚</li>
<li>Spring Cloud å’Œæ¶ˆæ¯æµé…ç½®ï¼ŒåŒ…æ‹¬ Nacosã€Kafkaã€RabbitMQã€‚</li>
<li>åˆ†å¸ƒå¼äº‹åŠ¡ é…ç½®ï¼ˆSeataï¼‰å’Œ Dubbo é…ç½®ã€‚</li>
<li>Flyway å’Œ Feign é…ç½®ã€‚</li>
</ul>
<h1 id="4-goodskill-web-æä¾›ç§’æ€æ¨¡æ‹Ÿæ¥å£è®¿é—®"><a href="#4-goodskill-web-æä¾›ç§’æ€æ¨¡æ‹Ÿæ¥å£è®¿é—®" class="headerlink" title="4. goodskill-web (æä¾›ç§’æ€æ¨¡æ‹Ÿæ¥å£è®¿é—®)"></a>4. goodskill-web (æä¾›ç§’æ€æ¨¡æ‹Ÿæ¥å£è®¿é—®)</h1><p><img src="/img/blogs/java/goodskill/4.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="4-1-configåŒ…"><a href="#4-1-configåŒ…" class="headerlink" title="4.1 configåŒ…"></a>4.1 configåŒ…</h2><ul>
<li>GlobalExceptionHandler</li>
</ul>
<h4 id="GlobalExceptionHandler"><a href="#GlobalExceptionHandler" class="headerlink" title="GlobalExceptionHandler"></a>GlobalExceptionHandler</h4><p>GlobalExceptionHandler ç±»æ˜¯ä¸€ä¸ªç”¨äº<strong>å…¨å±€å¼‚å¸¸å¤„ç†çš„ç±»</strong>ï¼ŒåŸºäº Spring Boot ä¸­çš„ @RestControllerAdvice å’Œ @ExceptionHandler æ³¨è§£ã€‚è¿™ä¸ªç±»æ•è·å¹¶å¤„ç†åº”ç”¨ä¸­çš„å„ç§å¼‚å¸¸ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–çš„å“åº”ä¿¡æ¯ã€‚å®ƒçš„ä½œç”¨æ˜¯<strong>é›†ä¸­å¤„ç†åº”ç”¨ä¸­çš„å¼‚å¸¸ï¼Œæä¾›ç»Ÿä¸€çš„é”™è¯¯ä¿¡æ¯å“åº”æ ¼å¼</strong>ï¼Œä»¥ä¾¿å‰ç«¯æˆ–å®¢æˆ·ç«¯æ›´å¥½åœ°å¤„ç†é”™è¯¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å…¨å±€å¼‚å¸¸å¤„ç†ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestControllerAdvice</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> &#123;<br><br>    <span class="hljs-comment">//ç”¨æ¥å¤„ç†æ‰€æœ‰æœªè¢«å…¶ä»– @ExceptionHandler æ•è·çš„é€šç”¨å¼‚å¸¸ï¼ˆç»§æ‰¿è‡ª Exception ç±»çš„å¼‚å¸¸ï¼‰</span><br>    <span class="hljs-meta">@ExceptionHandler(Exception.class)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.OK)</span><br>    <span class="hljs-keyword">public</span> ApiResult <span class="hljs-title function_">exception</span><span class="hljs-params">(Exception e)</span> &#123;<br>        log.error(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> ApiResult.error(ResultCode.C500.getCode(), e.getMessage());<br>    &#125;<br><br>    <span class="hljs-comment">// ç”¨æ¥å¤„ç†å‚æ•°ç»‘å®šå¼‚å¸¸ï¼Œé€šå¸¸å‘ç”Ÿåœ¨è¯·æ±‚çš„å‚æ•°ä¸ç¬¦åˆè¦æ±‚æ—¶ï¼ˆä¾‹å¦‚è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯ï¼‰ã€‚</span><br>    <span class="hljs-comment">// è¿™ç§å¼‚å¸¸ä¸€èˆ¬æ˜¯åœ¨ Spring MVC ä¸­å‘ç”Ÿçš„ï¼Œå½“è¯·æ±‚ä½“æ•°æ®æ— æ³•ç»‘å®šåˆ° Java Bean æ—¶ï¼Œä¼šæŠ›å‡º BindExceptionã€‚</span><br>    <span class="hljs-meta">@ExceptionHandler(BindException.class)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.OK)</span><br>    <span class="hljs-keyword">public</span> ApiResult <span class="hljs-title function_">exception</span><span class="hljs-params">(BindException e)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMsg</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldErrors().stream()<br>                .map(errorInfo -&gt; errorInfo.getField() + errorInfo.getDefaultMessage()).collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>        log.warn(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> ApiResult.error(ResultCode.C500.getCode(), <span class="hljs-string">&quot;å‚æ•°æ ¡éªŒå¤±è´¥:&quot;</span> + errorMsg);<br>    &#125;<br><br>    <span class="hljs-comment">//å¤„ç†å‚æ•°æ ¡éªŒå¤±è´¥çš„å¼‚å¸¸ï¼Œé€šå¸¸å‘ç”Ÿåœ¨ä½¿ç”¨ @Valid æˆ– @Validated æ³¨è§£è¿›è¡Œå‚æ•°æ ¡éªŒæ—¶</span><br>    <span class="hljs-comment">// å¦‚æœæ ¡éªŒå¤±è´¥ï¼ŒSpring ä¼šæŠ›å‡º MethodArgumentNotValidExceptionã€‚</span><br>    <span class="hljs-meta">@ExceptionHandler(MethodArgumentNotValidException.class)</span><br>    <span class="hljs-meta">@ResponseStatus(HttpStatus.OK)</span><br>    <span class="hljs-keyword">public</span> ApiResult <span class="hljs-title function_">exception</span><span class="hljs-params">(MethodArgumentNotValidException e)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">errorMsg</span> <span class="hljs-operator">=</span> e.getBindingResult().getFieldErrors().stream()<br>                .map(errorInfo -&gt; errorInfo.getField() + errorInfo.getDefaultMessage()).collect(Collectors.joining(<span class="hljs-string">&quot;,&quot;</span>));<br>        log.warn(e.getMessage(), e);<br>        <span class="hljs-keyword">return</span> ApiResult.error(ResultCode.C500.getCode(), <span class="hljs-string">&quot;å‚æ•°æ ¡éªŒå¤±è´¥:&quot;</span> + errorMsg);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-2-controller"><a href="#4-2-controller" class="headerlink" title="4.2 controller"></a>4.2 controller</h2><ul>
<li>SeckillMockController</li>
</ul>
<h4 id="SeckillMockController"><a href="#SeckillMockController" class="headerlink" title="SeckillMockController"></a>SeckillMockController</h4><p>æ¨¡æ‹Ÿç§’æ€åœºæ™¯çš„æ§åˆ¶å™¨ï¼Œä¸»è¦ç”¨äºæ¨¡æ‹Ÿä¸åŒç±»å‹çš„ç§’æ€ç­–ç•¥ï¼Œå¹¶é€šè¿‡ä¸åŒçš„æ–¹å¼æ¥æ§åˆ¶å¹¶å‘ã€åº“å­˜ã€ä»»åŠ¡åˆ†é…ç­‰ã€‚</p>
<p><strong>ä¸»è¦åŠŸèƒ½å’Œä½œç”¨</strong>ï¼š</p>
<ol>
<li><p><strong>æ¨¡æ‹Ÿä¸åŒçš„ç§’æ€åœºæ™¯ï¼š</strong></p>
<ul>
<li>ç±»ä¸­çš„æ–¹æ³•æ¨¡æ‹Ÿäº†å¤šç§ç§’æ€åœºæ™¯ï¼Œæ¶µç›–äº†åŒæ­¥é”ã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ•°æ®åº“åŸå­æ›´æ–°ç­‰æŠ€æœ¯æ‰‹æ®µã€‚</li>
<li>æ¯ä¸ªåœºæ™¯å¯¹åº”ä¸€ä¸ªç§’æ€ç­–ç•¥ï¼Œæ¨¡æ‹Ÿç§’æ€çš„å¹¶å‘å¤„ç†å’Œåº“å­˜æ›´æ–°ã€‚</li>
</ul>
</li>
<li><p><strong>åœºæ™¯è¯¦ç»†è§£é‡Šï¼š</strong></p>
<ul>
<li><strong>åœºæ™¯ä¸€ (<code>sychronized</code>)</strong>ï¼šä½¿ç”¨åŒæ­¥é”æ¥æ§åˆ¶å¹¶å‘ï¼Œæ¨¡æ‹Ÿå•æœºç¯å¢ƒä¸‹çš„ç§’æ€ã€‚</li>
<li><strong>åœºæ™¯äºŒ (<code>redisson</code>)</strong>ï¼šä½¿ç”¨ Redis åˆ†å¸ƒå¼é”æ¥æ§åˆ¶å¹¶å‘ï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒã€‚</li>
<li><strong>åœºæ™¯ä¸‰ (<code>activemq</code>)</strong>ï¼šä½¿ç”¨ ActiveMQ æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥ç§’æ€ï¼Œæ¨¡æ‹Ÿé«˜å¹¶å‘æƒ…å†µä¸‹çš„å¼‚æ­¥å¤„ç†ã€‚</li>
<li><strong>åœºæ™¯å›› (<code>kafka</code>)</strong>ï¼šä½¿ç”¨ Kafka æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæå‡æ€§èƒ½å¹¶å¤„ç†æ›´é«˜å¹¶å‘ã€‚</li>
<li><strong>åœºæ™¯äº” (<code>procedure</code>)</strong>ï¼šä½¿ç”¨æ•°æ®åº“åŸå­æ€§æ›´æ–°æ¥å¤„ç†ç§’æ€ï¼Œä½¿ç”¨ SQL å­˜å‚¨è¿‡ç¨‹è¿›è¡Œåº“å­˜æ›´æ–°ã€‚</li>
<li><strong>åœºæ™¯å…­ (<code>activemq/reply</code>)</strong>ï¼šå¼‚æ­¥ç§’æ€å¹¶åœ¨ 30 ç§’å†…è¿”å›ç§’æ€æ‰§è¡Œç»“æœã€‚</li>
<li><strong>åœºæ™¯ä¸ƒ (<code>zookeeperLock</code>)</strong>ï¼šä½¿ç”¨ Zookeeper åˆ†å¸ƒå¼é”æ¥æ§åˆ¶å¹¶å‘ã€‚</li>
<li><strong>åœºæ™¯å…« (<code>redisReactiveMongo</code>)</strong>ï¼šä½¿ç”¨ Redis ç¼“å­˜æ‰§è¡Œå‡åº“å­˜æ“ä½œï¼Œæœ€åé€šè¿‡ MQ å®Œæˆæ•°æ®è½åœ°ã€‚</li>
<li><strong>åœºæ™¯ä¹ (<code>rabbitmq</code>)</strong>ï¼šä½¿ç”¨ RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—æ¥è¿›è¡Œå¼‚æ­¥ç§’æ€å¤„ç†ã€‚</li>
<li><strong>åœºæ™¯å (<code>limit</code>)</strong>ï¼šä½¿ç”¨ Sentinel é™æµç­–ç•¥ä¸æ•°æ®åº“åŸå­æ›´æ–°ç»“åˆï¼Œé˜²æ­¢è¿‡å¤šè¯·æ±‚å¯¹ç³»ç»Ÿé€ æˆè¿‡è½½ã€‚</li>
<li><strong>åœºæ™¯åä¸€ (<code>atomicWithCanal</code>)</strong>ï¼šä½¿ç”¨æ•°æ®åº“åŸå­æ›´æ–°å’Œ Canal ç›‘å¬æ•°æ®åº“å˜æ›´ï¼Œå¤„ç†ç§’æ€ç»“æœã€‚</li>
</ul>
</li>
<li><p><strong>æ‰§è¡Œç§’æ€æ“ä½œï¼š</strong></p>
<ul>
<li>æ¯ä¸ªç§’æ€åœºæ™¯éƒ½é€šè¿‡ <code>processSeckill</code> æ–¹æ³•æ¥æ‰§è¡Œã€‚æ­¤æ–¹æ³•è´Ÿè´£å‡†å¤‡ç§’æ€çš„åº“å­˜ã€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ã€è®°å½•ä»»åŠ¡å¼€å§‹æ—¶é—´ç­‰ã€‚</li>
<li>è¯¥æ–¹æ³•å¯ä»¥é€šè¿‡ä¸åŒçš„ç§’æ€ç­–ç•¥ï¼ˆå¦‚åŒæ­¥é”ã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰æ¥æ‰§è¡Œç§’æ€ï¼Œå¹¶æä¾›è‡ªå®šä¹‰çš„æ‰§è¡Œä»»åŠ¡ï¼ˆå¦‚å‘é€æ¶ˆæ¯é˜Ÿåˆ—ã€æ‰§è¡Œç§’æ€æœåŠ¡ç­‰ï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>å¼‚æ­¥å’Œå¹¶å‘å¤„ç†ï¼š</strong></p>
<ul>
<li>è¯¥ç±»é€šè¿‡çº¿ç¨‹æ±  (<code>taskExecutor</code>) æ¥æ¨¡æ‹Ÿé«˜å¹¶å‘ç¯å¢ƒä¸‹çš„ç§’æ€å¤„ç†ï¼Œç¡®ä¿å¤§é‡è¯·æ±‚å¯ä»¥åŒæ—¶è¿›è¡Œã€‚</li>
<li>ä½¿ç”¨ä¸åŒçš„å¹¶å‘æ§åˆ¶æ–¹æ³•ï¼ˆå¦‚åŒæ­¥é”ã€Redis é”ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰ï¼‰æ¥ä¿è¯ç§’æ€è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸€è‡´æ€§å’Œåº“å­˜æ­£ç¡®æ€§ã€‚</li>
</ul>
</li>
<li><p><strong>è‡ªå®šä¹‰ä»»åŠ¡å’Œæ—¥å¿—è®°å½•ï¼š</strong></p>
<ul>
<li>é€šè¿‡ <code>Runnable</code> æ¥å®šä¹‰ä»»åŠ¡å¹¶æäº¤ç»™çº¿ç¨‹æ± ï¼Œæ¨¡æ‹Ÿæ¯ä¸ªç”¨æˆ·å‚ä¸ç§’æ€çš„æ“ä½œã€‚</li>
<li>æ¯ä¸ªç§’æ€è¯·æ±‚éƒ½ä¼šé€šè¿‡æ—¥å¿—è®°å½•ç›¸å…³ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§ã€‚</li>
</ul>
</li>
<li><p><strong>ä»»åŠ¡ç»Ÿè®¡ä¸æ—¶é—´è®°å½•ï¼š</strong></p>
<ul>
<li>ç±»ä¸­è¿˜åŒ…æ‹¬äº†ä¸€äº›ç”¨äºä»»åŠ¡æ—¶é—´ç»Ÿè®¡çš„å·¥å…·ï¼ˆå¦‚ <code>TaskTimeCaculateUtil</code>ï¼‰ï¼Œå¯ä»¥è®°å½•å’Œè¿”å›æ¯ä¸ªç§’æ€ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ã€‚</li>
</ul>
</li>
<li><p><strong>æ‰©å±•æ€§ä¸å®¹é”™å¤„ç†ï¼š</strong></p>
<ul>
<li>è¯¥æ§åˆ¶å™¨æ”¯æŒä¸åŒçš„ç§’æ€ç­–ç•¥å’Œå¤šç§åˆ†å¸ƒå¼ç¯å¢ƒçš„é…ç½®ï¼ˆå¦‚ Redisã€Zookeeperã€Kafkaã€RabbitMQ ç­‰ï¼‰ï¼Œä½¿å¾—ç§’æ€ç³»ç»Ÿå¯ä»¥æ ¹æ®å®é™…éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œä¼˜åŒ–ã€‚</li>
<li>é”™è¯¯å¤„ç†ä¹Ÿç»è¿‡äº†è®¾è®¡ï¼Œèƒ½å¤Ÿåœ¨å„ç§åœºæ™¯ä¸‹æä¾›åé¦ˆã€‚</li>
</ul>
</li>
</ol>
<h2 id="4-3-stream-consumer"><a href="#4-3-stream-consumer" class="headerlink" title="4.3 stream.consumer"></a>4.3 stream.consumer</h2><ul>
<li>SeckillMockCanalResponseListener</li>
<li>SeckillMockResponseListener</li>
</ul>
<h4 id="SeckillMockCanalResponseListener"><a href="#SeckillMockCanalResponseListener" class="headerlink" title="SeckillMockCanalResponseListener"></a>SeckillMockCanalResponseListener</h4><p>è¯¥ç±»ä¸»è¦ç”¨äºåœ¨ç§’æ€æ´»åŠ¨ç»“æŸæ—¶ï¼Œç›‘å¬ Canal æ¨é€çš„æ•°æ®åº“å˜æ›´æ¶ˆæ¯ï¼Œè®°å½•ç§’æ€æ´»åŠ¨çš„ç»“æŸæ—¶é—´ã€ID å’ŒæˆåŠŸçš„äº¤æ˜“ç¬”æ•°ã€‚å®ƒå®ç°äº†ä¸€ä¸ªåŸºäº Canal çš„æ•°æ®åº“å˜æ›´ç›‘å¬æœºåˆ¶ï¼Œå¸®åŠ©ç³»ç»Ÿåœ¨ç§’æ€æ´»åŠ¨ç»“æŸåæ‰§è¡Œåç»­å¤„ç†å’Œç»Ÿè®¡æ“ä½œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * canal binlogç§’æ€ç»“æœæ¶ˆæ¯æ¶ˆè´¹è€…</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillMockCanalResponseListener</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> SeckillService seckillService;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Consumer&lt;SeckillMockCanalResponseDTO&gt; <span class="hljs-title function_">seckillCanalResult</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> responseDto -&gt; &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> responseDto.getSeckillId();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">note</span> <span class="hljs-operator">=</span> responseDto.getNote();<br><br>            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(responseDto.getStatus())) &#123;<br>                log.info(<span class="hljs-string">&quot;binlogç›‘æ§åˆ°ç§’æ€æ´»åŠ¨ç»“æŸï¼Œ&#123;&#125;æ—¶é—´ï¼š&#123;&#125;,ç§’æ€idï¼š&#123;&#125;&quot;</span>, note, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), seckillId);<br>                <span class="hljs-type">long</span> <span class="hljs-variable">successKillCount</span> <span class="hljs-operator">=</span> seckillService.getSuccessKillCount(seckillId);<br>                log.info(<span class="hljs-string">&quot;æœ€ç»ˆæˆåŠŸäº¤æ˜“ç¬”æ•°ï¼š&#123;&#125;&quot;</span>, successKillCount);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>seckillCanalResult</code>ï¼šåˆ›å»ºäº†ä¸€ä¸ª <code>Consumer&lt;SeckillMockCanalResponseDTO&gt;</code>ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•å¤„ç† Canal ç›‘å¬åˆ°çš„ <code>SeckillMockCanalResponseDTO</code> æ•°æ®ã€‚<ul>
<li>å¦‚æœ status ä¸º trueï¼ˆè¡¨ç¤ºç§’æ€æ´»åŠ¨å·²ç»“æŸï¼‰ï¼Œåˆ™æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š<ul>
<li>æ‰“å°ç§’æ€ç»“æŸçš„æ—¥å¿—ï¼ŒåŒ…æ‹¬æ´»åŠ¨çš„ç»“æŸæ—¶é—´ã€ç§’æ€ ID å’Œæè¿°ä¿¡æ¯ã€‚</li>
<li>è°ƒç”¨ <code>seckillService.getSuccessKillCount(seckillId)</code> è·å–æˆåŠŸç§’æ€çš„æ€»æ•°ï¼Œå¹¶æ‰“å°å‡ºæ¥ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="SeckillMockResponseListener"><a href="#SeckillMockResponseListener" class="headerlink" title="SeckillMockResponseListener"></a>SeckillMockResponseListener</h4><p>æ ¸å¿ƒåŠŸèƒ½æ˜¯<strong>ç›‘å¬ç§’æ€æ´»åŠ¨çš„ç»“æŸäº‹ä»¶</strong>ï¼Œç¡®ä¿åœ¨æ´»åŠ¨ç»“æŸåæ­£ç¡®è®¡ç®—å¹¶è®°å½•æˆåŠŸçš„äº¤æ˜“ç¬”æ•°ï¼Œå¤„ç†å¼‚æ­¥æ“ä½œå¸¦æ¥çš„å»¶è¿Ÿï¼Œå¹¶è¾“å‡ºç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚å®ƒè¿˜ç¡®ä¿åœ¨åœºæ™¯å…«ï¼ˆRedis + MongoDB å¼‚æ­¥æ“ä½œåœºæ™¯ï¼‰ä¸‹ï¼Œæ‰§è¡Œè¡¥å¿ç­‰å¾…æ“ä½œï¼Œæœ€ç»ˆç»“æŸç§’æ€æ´»åŠ¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillMockResponseListener</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> SeckillService seckillService;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Consumer&lt;SeckillMockResponseDTO&gt; <span class="hljs-title function_">seckillResult</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> responseDto -&gt; &#123;<br>            <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> responseDto.getSeckillId();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">note</span> <span class="hljs-operator">=</span> responseDto.getNote();<br><br>            <span class="hljs-keyword">if</span> (Boolean.TRUE.equals(responseDto.getStatus())) &#123;<br>                log.info(<span class="hljs-string">&quot;ç§’æ€æ´»åŠ¨ç»“æŸï¼Œ&#123;&#125;æ—¶é—´ï¼š&#123;&#125;,ç§’æ€idï¼š&#123;&#125;&quot;</span>, note, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(), seckillId);<br>                <span class="hljs-type">long</span> <span class="hljs-variable">successKillCount</span> <span class="hljs-operator">=</span> seckillService.getSuccessKillCount(seckillId);<br>                <span class="hljs-type">long</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">while</span> (successKillCount != temp) &#123;<br>                    <span class="hljs-comment">// è®¡ç®—æ€»æ•°å¯èƒ½æœ‰å»¶è¿Ÿï¼Œç­‰å¾…ç»Ÿè®¡æ•°æ®ç¨³å®šåå¾—åˆ°æœ€ç»ˆç»“æœ</span><br>                    log.info(<span class="hljs-string">&quot;æœ€ç»ˆæˆåŠŸäº¤æ˜“ç¬”æ•°ç»Ÿè®¡ä¸­ã€‚ã€‚ã€‚&quot;</span>);<br>                    successKillCount = temp;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        Thread.sleep(<span class="hljs-number">1500L</span>);<br>                    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                        log.warn(e.getMessage(), e);<br>                    &#125;<br>                    temp = seckillService.getSuccessKillCount(seckillId);<br>                &#125;<br>                TaskTimeCaculateUtil.stop(responseDto.getTaskId());<br>                log.info(<span class="hljs-string">&quot;æœ€ç»ˆæˆåŠŸäº¤æ˜“ç¬”æ•°ï¼š&#123;&#125;&quot;</span>, successKillCount);<br>                log.info(<span class="hljs-string">&quot;å†å²ä»»åŠ¡è€—æ—¶ç»Ÿè®¡ï¼š&#123;&#125;&quot;</span>, TaskTimeCaculateUtil.prettyPrint(responseDto.getTaskId()));<br>                <span class="hljs-comment">// åœºæ™¯å…«ç”±äºæ˜¯å¼‚æ­¥æ’å…¥ï¼Œè¡¥å¿æŸ¥è¯¢æœ€æ–°æ’å…¥è®°å½•æ•°ï¼Œå»¶è¿Ÿ10s</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (SeckillSolutionEnum.REDIS_MONGO_REACTIVE.getName().endsWith(note)) &#123;<br>                        Thread.sleep(<span class="hljs-number">10000</span>);<br>                        log.info(<span class="hljs-string">&quot;mongoæœ€ç»ˆæˆåŠŸäº¤æ˜“ç¬”æ•°ï¼š&#123;&#125;&quot;</span>, successKillCount);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    log.error(e.getMessage(), e);<br>                    Thread.currentThread().interrupt();<br>                &#125;<br>                seckillService.endSeckill(seckillId);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ul>
<li>seckillResult()ï¼šåˆ›å»ºäº†ä¸€ä¸ª Consumer<SeckillMockResponseDTO>ï¼Œè¯¥æ–¹æ³•å®šä¹‰äº†å¦‚ä½•å¤„ç†æ”¶åˆ°çš„ç§’æ€æ´»åŠ¨ç»“æŸæ¶ˆæ¯ï¼š<ul>
<li>å®ƒé¦–å…ˆè·å–ç§’æ€æ´»åŠ¨çš„ ID å’ŒçŠ¶æ€ï¼ˆé€šè¿‡ responseDtoï¼‰ã€‚</li>
<li>å¦‚æœç§’æ€æ´»åŠ¨å·²ç»ç»“æŸï¼ˆstatus &#x3D;&#x3D; trueï¼‰ï¼Œåˆ™å¼€å§‹ç»Ÿè®¡æˆåŠŸäº¤æ˜“ç¬”æ•°ã€‚</li>
<li>å¦‚æœç»Ÿè®¡çš„æˆåŠŸäº¤æ˜“ç¬”æ•°å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ä¼šç»§ç»­ç­‰å¾…ï¼Œç›´åˆ°æ•°æ®ç¨³å®šã€‚</li>
<li>å®Œæˆç»Ÿè®¡åï¼Œåœæ­¢ä»»åŠ¡æ—¶é—´ç»Ÿè®¡ï¼Œè¾“å‡ºæ—¥å¿—ï¼Œè®°å½•æ´»åŠ¨çš„æœ€ç»ˆæˆåŠŸäº¤æ˜“ç¬”æ•°å’Œä»»åŠ¡çš„è€—æ—¶ã€‚</li>
<li>å¦‚æœæ˜¯ç‰¹å®šåœºæ™¯ï¼ˆå¦‚ Redis + MongoDB å¼‚æ­¥å¤„ç†ï¼‰ï¼Œè¿˜ä¼šè¿›è¡Œè¡¥å¿æ“ä½œï¼Œç­‰å¾…æ•°æ®æ’å…¥å®Œæˆåå†è¾“å‡ºæœ€ç»ˆç»“æœã€‚</li>
<li>æœ€åï¼Œè°ƒç”¨ seckillService.endSeckill(seckillId) æ¥ç»“æŸç§’æ€æ´»åŠ¨ã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-4-util"><a href="#4-4-util" class="headerlink" title="4.4 util"></a>4.4 util</h2><ul>
<li>TaskTimeCaculateUtil</li>
</ul>
<h4 id="TaskTimeCaculateUtil"><a href="#TaskTimeCaculateUtil" class="headerlink" title="TaskTimeCaculateUtil"></a>TaskTimeCaculateUtil</h4><p>TaskTimeCaculateUtil ç±»é€šè¿‡å°è£… StopWatch æ¥æä¾›ç®€å•çš„ä»»åŠ¡è®¡æ—¶ã€åœæ­¢å’Œç»Ÿè®¡åŠŸèƒ½ã€‚å®ƒå¯ä»¥ç”¨æ¥ç›‘æ§ä»»åŠ¡æ‰§è¡Œçš„æ—¶é•¿ã€è¾“å‡ºæ‰§è¡Œæ—¶é—´æŠ¥å‘Š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskTimeCaculateUtil</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è®¡æ—¶å™¨</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">StopWatch</span> <span class="hljs-variable">stopWatch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StopWatch</span>();<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»»åŠ¡è®¡æ—¶å™¨æ˜ å°„, taskId:stopWatch</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, StopWatch&gt; taskWatchMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;();<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¼€å¯ä¸€ä¸ªè®¡æ—¶ä»»åŠ¡ï¼Œæœ€å¤§å…è®¸åŒæ—¶å¼€å¯åä¸ªä»»åŠ¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskName ä»»åŠ¡å</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId   ä»»åŠ¡id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startTask</span><span class="hljs-params">(String taskName, String taskId)</span> &#123;<br>        <span class="hljs-keyword">if</span> (stopWatch.getTaskCount() &gt; <span class="hljs-number">10</span> || stopWatch.isRunning()) &#123;<br>            stopWatch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StopWatch</span>();<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            stopWatch.start(taskName);<br>            taskWatchMap.put(taskId, stopWatch);<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalStateException e) &#123;<br>            log.warn(<span class="hljs-string">&quot;Last task have not finish yet!&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åœæ­¢ä¸Šä¸€ä¸ªè®¡æ—¶ä»»åŠ¡</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId ä»»åŠ¡id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">(String taskId)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            taskWatchMap.get(taskId).stop();<br>        &#125; <span class="hljs-keyword">catch</span> (IllegalStateException e) &#123;<br>            log.warn(<span class="hljs-string">&quot;Oops, stop error occurs!&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¾“å‡ºå†å²ä»»åŠ¡çš„è€—æ—¶æƒ…å†µ</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> taskId ä»»åŠ¡id</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> ä»»åŠ¡çš„è€—æ—¶æƒ…å†µ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">prettyPrint</span><span class="hljs-params">(String taskId)</span> &#123;<br>        <span class="hljs-keyword">return</span> taskWatchMap.get(taskId).prettyPrint();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>å…³é”®æ–¹æ³•ï¼š</p>
<ol>
<li>startTask(String taskName, String taskId)ï¼š<ul>
<li>å¯åŠ¨ä¸€ä¸ªæ–°çš„è®¡æ—¶ä»»åŠ¡ã€‚æœ€å¤šå…è®¸åŒæ—¶æœ‰ 10 ä¸ªä»»åŠ¡åœ¨è®¡æ—¶ï¼ˆé€šè¿‡æ£€æŸ¥ stopWatch.getTaskCount()ï¼‰ã€‚å¦‚æœä»»åŠ¡æ•°è¶…è¿‡é™åˆ¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„è®¡æ—¶å™¨å®ä¾‹ã€‚</li>
<li>ä½¿ç”¨ taskId å°†ä»»åŠ¡ä¸è®¡æ—¶å™¨å®ä¾‹å…³è”ã€‚</li>
</ul>
</li>
<li>stop(String taskId)ï¼š<ul>
<li>åœæ­¢æŒ‡å®šä»»åŠ¡çš„è®¡æ—¶ã€‚é€šè¿‡ taskId è·å–å¯¹åº”çš„ StopWatch å¯¹è±¡å¹¶åœæ­¢å®ƒã€‚</li>
<li>å¦‚æœåœæ­¢æ—¶å‡ºç°å¼‚å¸¸ï¼ˆå¦‚æ²¡æœ‰æ‰¾åˆ°å¯¹åº”çš„ä»»åŠ¡æˆ–ä»»åŠ¡æ²¡æœ‰å¯åŠ¨ï¼‰ï¼Œä¼šè®°å½•è­¦å‘Šæ—¥å¿—ã€‚</li>
</ul>
</li>
<li>prettyPrint(String taskId)ï¼š<ul>
<li>è·å–å¹¶è¿”å›æŸä¸ªä»»åŠ¡çš„è¯¦ç»†è€—æ—¶ä¿¡æ¯ï¼ˆå¦‚å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€æ€»è€—æ—¶ç­‰ï¼‰ï¼Œè¾“å‡ºçš„æ ¼å¼é€šè¿‡ StopWatch çš„ prettyPrint æ–¹æ³•æ¥å®ç°ã€‚</li>
</ul>
</li>
</ol>
<h2 id="4-5-SampleWebApplicationå¯åŠ¨ç±»"><a href="#4-5-SampleWebApplicationå¯åŠ¨ç±»" class="headerlink" title="4.5 SampleWebApplicationå¯åŠ¨ç±»"></a>4.5 SampleWebApplicationå¯åŠ¨ç±»</h2><p>è¯¥å¯åŠ¨ç±»çš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>å¯åŠ¨ä¸€ä¸ª Spring Boot åº”ç”¨ã€‚</li>
<li>å¯ç”¨æœåŠ¡å‘ç°åŠŸèƒ½ï¼Œå…è®¸åº”ç”¨ä¸æœåŠ¡æ³¨å†Œä¸­å¿ƒè¿›è¡Œäº¤äº’ã€‚</li>
<li>å¯ç”¨ Feign å®¢æˆ·ç«¯æ”¯æŒï¼Œæ–¹ä¾¿è¿œç¨‹è°ƒç”¨å…¶ä»–æœåŠ¡ã€‚</li>
<li>å¯ç”¨å¼‚æ­¥åŠŸèƒ½ï¼Œæ”¯æŒæ–¹æ³•çš„å¼‚æ­¥æ‰§è¡Œã€‚</li>
<li>æ˜¾å¼åœ°æŒ‡å®š Web åº”ç”¨ç±»å‹ä¸º Servletï¼Œä½¿ç”¨ä¼ ç»Ÿçš„ Servlet å®¹å™¨å¯åŠ¨ã€‚</li>
</ul>
<h1 id="5-goodskill-spring-boot-starter-é¡¹ç›®é…ç½®è‡ªåŠ¨è£…é…"><a href="#5-goodskill-spring-boot-starter-é¡¹ç›®é…ç½®è‡ªåŠ¨è£…é…" class="headerlink" title="5. goodskill-spring-boot-starter (é¡¹ç›®é…ç½®è‡ªåŠ¨è£…é…)"></a>5. goodskill-spring-boot-starter (é¡¹ç›®é…ç½®è‡ªåŠ¨è£…é…)</h1><p><img src="/img/blogs/java/goodskill/5.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p>goodskill-spring-boot-starter æ¨¡å—çš„ä½œç”¨</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªä¸º GoodSkill ç³»ç»Ÿå°è£…çš„ Spring Boot è‡ªåŠ¨é…ç½®æ¨¡å—ï¼Œæä¾›äº† OAuth2 ç™»å½•æ”¯æŒã€MinIO å¯¹è±¡å­˜å‚¨æ”¯æŒã€ä»¥åŠå…¶ä»–é€šç”¨èƒ½åŠ›çš„å¼€ç®±å³ç”¨é›†æˆï¼Œç®€åŒ–ä¸šåŠ¡æ¨¡å—çš„é›†æˆå’Œé…ç½®ã€‚</li>
</ul>
<p>åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œå¤šä¸ªå¾®æœåŠ¡å¯èƒ½éƒ½è¦ä½¿ç”¨ï¼š</p>
<ul>
<li>ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆæ¯”å¦‚ Gitee OAuth2ï¼‰</li>
<li>MinIO å¯¹è±¡å­˜å‚¨æœåŠ¡</li>
<li>é€šç”¨çš„æœåŠ¡æ³¨å†Œä¸é…ç½®é€»è¾‘</li>
<li>è‡ªå®šä¹‰å·¥å…·ç±»ã€AOP ç»„ä»¶ç­‰</li>
</ul>
<p><strong>å¦‚æœæ¯ä¸ªæ¨¡å—éƒ½æ‰‹åŠ¨å»å†™ä¸€éé…ç½®ï¼Œé‚£å¾ˆéº»çƒ¦è€Œä¸”å®¹æ˜“å‡ºé”™ã€‚</strong><br>äºæ˜¯å°±æœ‰äº†è¿™ä¸ª starter æ¨¡å—ï¼Œç»Ÿä¸€å°è£…å¥½è¿™äº›é…ç½®å’Œå·¥å…·ç±»<br>ä¸»å·¥ç¨‹åªè¦åœ¨ application.yml é‡Œå†™å¥½é…ç½®ï¼Œå°±èƒ½è‡ªåŠ¨è£…é…å¹¶ä½¿ç”¨è¿™äº›åŠŸèƒ½ï¼Œå®ç°â€œ<strong>å¼€ç®±å³ç”¨</strong>â€</p>
<h1 id="6-goodskill-seata-é›†æˆnacos-dubbo-shardingjdbc-seataçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆç¤ºä¾‹"><a href="#6-goodskill-seata-é›†æˆnacos-dubbo-shardingjdbc-seataçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆç¤ºä¾‹" class="headerlink" title="6. goodskill-seata (é›†æˆnacos+dubbo+shardingjdbc+seataçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆç¤ºä¾‹)"></a>6. goodskill-seata (é›†æˆnacos+dubbo+shardingjdbc+seataçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆç¤ºä¾‹)</h1><p><img src="/img/blogs/java/goodskill/6.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="6-1-feignåŒ…"><a href="#6-1-feignåŒ…" class="headerlink" title="6.1 feignåŒ…"></a>6.1 feignåŒ…</h2><h4 id="AuthFeignClientæ¥å£"><a href="#AuthFeignClientæ¥å£" class="headerlink" title="AuthFeignClientæ¥å£"></a>AuthFeignClientæ¥å£</h4><p>AuthFeignClient æ¥å£æ˜¯ä¸€ä¸ª Feign å®¢æˆ·ç«¯ï¼Œç”¨äºåœ¨ Spring Cloud å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œ<strong>é€šè¿‡å£°æ˜å¼æ–¹å¼è¿œç¨‹è°ƒç”¨ goodskill-auth æœåŠ¡çš„æ¥å£</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;goodskill-auth&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AuthFeignClient</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¸ºç”¨æˆ·å¢åŠ è§’è‰²</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostMapping(&quot;/user/role/add&quot;)</span><br>    Result&lt;String&gt; <span class="hljs-title function_">addRole</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, <span class="hljs-meta">@RequestParam(&quot;roleId&quot;)</span> <span class="hljs-type">int</span> roleId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>AuthFeignClient çš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>åœ¨å½“å‰æœåŠ¡ä¸­ï¼Œä»¥ Java æ¥å£çš„æ–¹å¼ï¼Œ<strong>è°ƒç”¨ goodskill-auth æœåŠ¡çš„ â€œä¸ºç”¨æˆ·æ·»åŠ è§’è‰²â€ æ¥å£</strong>ï¼Œå®ç°è·¨æœåŠ¡è¿œç¨‹è°ƒç”¨ï¼Œè€Œä¸éœ€è¦æ‰‹åŠ¨å†™ HTTP è¯·æ±‚é€»è¾‘ã€‚</li>
</ul>
<h2 id="6-2-GoodskillSeataApplication"><a href="#6-2-GoodskillSeataApplication" class="headerlink" title="6.2 GoodskillSeataApplication"></a>6.2 GoodskillSeataApplication</h2><p>è¿™æ˜¯ä¸€ä¸ª Spring Boot åº”ç”¨çš„å¯åŠ¨ç±»ï¼Œä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p>
<p>âœ… åœ¨ä¸€ä¸ªæœåŠ¡ä¸­åŒæ—¶è°ƒç”¨å¤šä¸ªè¿œç¨‹æœåŠ¡ï¼ˆDubbo + Feignï¼‰<br>âœ… <strong>é€šè¿‡ Seata å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ç®¡ç†</strong><br>âœ… æµ‹è¯•åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œå¤šä¸ªå­æœåŠ¡ä¹‹é—´çš„æ•°æ®å›æ»šæ•ˆæœï¼Œç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication(scanBasePackages = &#123;&quot;com.goodskill.seata&quot;, &quot;com.goodskill.core&quot;&#125;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@EnableFeignClients(basePackages = &quot;com.goodskill.seata.feign&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GoodskillSeataApplication</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> SeckillService seckillService;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> GoodsService goodsService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AuthFeignClient authFeignClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æµ‹è¯•seataåˆ†å¸ƒå¼äº‹åŠ¡</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@GetMapping(&quot;/test&quot;)</span><br>    <span class="hljs-meta">@GlobalTransactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testGlobalTransaction</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">GoodsVO</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoodsVO</span>();<br>        goods.setName(<span class="hljs-string">&quot;test&quot;</span>);<br>        goodsService.addGoods(goods);<br>        <span class="hljs-type">SeckillVO</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> seckillService.findById(<span class="hljs-number">1001L</span>);<br>        seckill.setNumber(seckill.getNumber() - <span class="hljs-number">1</span>);<br>        seckillService.saveOrUpdateSeckill(seckill);<br>        authFeignClient.addRole(<span class="hljs-number">21</span>, <span class="hljs-number">7</span>);<br>        <span class="hljs-comment">// æµ‹è¯•å¼‚å¸¸æƒ…å†µ</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        SpringApplication.run(GoodskillSeataApplication.class, args);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>å› ä¸ºåŠ äº† @GlobalTransactionalï¼Œ<strong>åªè¦ä»»ä½•ä¸€ä¸ªå­æ“ä½œå¤±è´¥</strong>ï¼ˆæ¯”å¦‚æœ€åæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œ<strong>å°±ä¼šè§¦å‘ Seata çš„äº‹åŠ¡å›æ»šæœºåˆ¶</strong>ï¼Œè®©ï¼š</p>
<ul>
<li>æ·»åŠ å•†å“</li>
<li>æ›´æ–°ç§’æ€ä¿¡æ¯</li>
<li>æ·»åŠ ç”¨æˆ·è§’è‰²<br>å…¨éƒ¨å›æ»šï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚</li>
</ul>
<h1 id="7-goodskill-admin-SpringBoot-Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpring-Cloudå¾®æœåŠ¡å‘ç°"><a href="#7-goodskill-admin-SpringBoot-Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpring-Cloudå¾®æœåŠ¡å‘ç°" class="headerlink" title="7. goodskill-admin (SpringBoot Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpring Cloudå¾®æœåŠ¡å‘ç°)"></a>7. goodskill-admin (SpringBoot Adminç›‘æ§æœåŠ¡ç«¯ï¼Œæ”¯æŒSpring Cloudå¾®æœåŠ¡å‘ç°)</h1><p><img src="/img/blogs/java/goodskill/7.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>GoodskillAdminApplication</strong>ï¼š<br>åå°ç®¡ç†æ¨¡å—çš„å¯åŠ¨ç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯åŠ¨æ•´ä¸ª goodskill-admin å¾®æœåŠ¡ã€‚<br>ç”¨äºæ„å»ºä¸€ä¸ª<strong>ç”¨äºç›‘æ§å…¶ä»– Spring Boot å¾®æœåŠ¡çš„åå°ç®¡ç†ç•Œé¢</strong>ã€‚</p>
<h1 id="8-goodskill-job-elastic-jobå®šæ—¶ä»»åŠ¡"><a href="#8-goodskill-job-elastic-jobå®šæ—¶ä»»åŠ¡" class="headerlink" title="8. goodskill-job (elastic-jobå®šæ—¶ä»»åŠ¡)"></a>8. goodskill-job (elastic-jobå®šæ—¶ä»»åŠ¡)</h1><p><img src="/img/blogs/java/goodskill/8.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="goodskill-job-simpleåŒ…"><a href="#goodskill-job-simpleåŒ…" class="headerlink" title="goodskill.job.simpleåŒ…"></a>goodskill.job.simpleåŒ…</h2><ul>
<li>MyJob</li>
<li>MyJob2</li>
</ul>
<h4 id="MyJob"><a href="#MyJob" class="headerlink" title="MyJob"></a>MyJob</h4><p>åˆ†ç‰‡å®šæ—¶ä»»åŠ¡å®ç°ç±»</p>
<p><strong>ä½œç”¨</strong>ï¼š</p>
<ul>
<li><p><strong>å®šæ—¶åŒæ­¥å•†å“æ•°æ®åˆ° Elasticsearch ç´¢å¼•ä¸­</strong>ï¼Œé€šè¿‡ ElasticJob çš„åˆ†ç‰‡æœºåˆ¶å¯¹ä»»åŠ¡è¿›è¡Œåˆ†å¸ƒå¼æ‹†åˆ†å’Œæ‰§è¡Œã€‚</p>
</li>
<li><p>é€šè¿‡ Dubbo è°ƒç”¨è¿œç¨‹çš„å•†å“æœåŠ¡ï¼Œè·å–å•†å“åˆ—è¡¨ã€‚</p>
</li>
<li><p>å°†å•†å“æ•°æ®è½¬æ¢ä¸º ES æ‰€éœ€çš„ VO å¯¹è±¡åï¼Œè°ƒç”¨ goodsEsService.saveBatch() æ‰¹é‡æ›´æ–°ç´¢å¼•</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyJob</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">SimpleJob</span> &#123;<br>    <span class="hljs-meta">@DubboReference</span><br>    <span class="hljs-keyword">private</span> GoodsService goodsService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> GoodsEsService goodsEsService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(ShardingContext context)</span> &#123;<br>        <span class="hljs-keyword">switch</span> (context.getShardingItem()) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.info(<span class="hljs-string">&quot;åˆ†ç‰‡0 å•†å“esç´¢å¼•å¼€å§‹æ›´æ–°ã€‚ã€‚ã€‚&quot;</span>);<br>                    <span class="hljs-type">List</span> <span class="hljs-variable">list</span> <span class="hljs-operator">=</span> goodsService.findMany().parallelStream().map(g -&gt; &#123;<br>                        <span class="hljs-type">GoodsVO</span> <span class="hljs-variable">goods</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GoodsVO</span>();<br>                        BeanUtils.copyProperties(g, goods);<br>                        <span class="hljs-keyword">return</span> goods;<br>                    &#125;).collect(Collectors.toList());<br>                    goodsEsService.saveBatch(list);<br>                    log.info(<span class="hljs-string">&quot;åˆ†ç‰‡0 å•†å“esç´¢å¼•æ›´æ–°æˆåŠŸï¼Œæ¡æ•°:&#123;&#125;&quot;</span>, list.size());<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.warn(<span class="hljs-string">&quot;åˆ†ç‰‡0 å•†å“esç´¢å¼•å®šæ—¶ä»»åŠ¡æ›´æ–°å¤±è´¥!&quot;</span>, e);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.info(<span class="hljs-string">&quot;åˆ†ç‰‡1 å•†å“esç´¢å¼•å¼€å§‹æ›´æ–°ã€‚ã€‚ã€‚&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.warn(<span class="hljs-string">&quot;åˆ†ç‰‡1 å•†å“esç´¢å¼•å®šæ—¶ä»»åŠ¡æ›´æ–°å¤±è´¥!&quot;</span>, e);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                <span class="hljs-keyword">try</span> &#123;<br>                    log.info(<span class="hljs-string">&quot;åˆ†ç‰‡2 å•†å“esç´¢å¼•å¼€å§‹æ›´æ–°ã€‚ã€‚ã€‚&quot;</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.warn(<span class="hljs-string">&quot;åˆ†ç‰‡2 å•†å“esç´¢å¼•å®šæ—¶ä»»åŠ¡æ›´æ–°å¤±è´¥!&quot;</span>, e);<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-comment">// case n: ...</span><br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ElasticJob ä¼šæ ¹æ®<strong>åˆ†ç‰‡æ•°å¤šçº¿ç¨‹è°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ¯ä¸ªåˆ†ç‰‡è´Ÿè´£å¤„ç†ä¸åŒçš„æ•°æ®</strong>ã€‚</p>
<ul>
<li>åˆ†ç‰‡0çš„æ‰§è¡Œé€»è¾‘<ul>
<li><strong>è·å–å•†å“åˆ—è¡¨</strong>ï¼šè°ƒç”¨è¿œç¨‹ goodsService.findMany() è·å–æ‰€æœ‰å•†å“æ•°æ®ã€‚</li>
<li><strong>è½¬æ¢æˆ VO å¯¹è±¡</strong>ï¼šä½¿ç”¨ BeanUtils.copyProperties() æŠŠåŸå§‹å•†å“å®ä½“è½¬ä¸º GoodsVOï¼ˆé€‚ç”¨äº ES å­˜å‚¨ç»“æ„ï¼‰ã€‚</li>
<li><strong>å¹¶è¡Œå¤„ç†æ•°æ®</strong>ï¼šparallelStream() å¤šçº¿ç¨‹åŠ é€Ÿå±æ€§æ‹·è´ï¼ˆè§†æ•°æ®é‡è€Œå®šæ˜¯å¦æœ‰æ•ˆï¼‰ã€‚</li>
<li><strong>æ‰¹é‡å­˜å‚¨åˆ° ES</strong>ï¼šé€šè¿‡ goodsEsService.saveBatch(list) ä¸€æ¬¡æ€§æŠŠæ‰€æœ‰å•†å“æ•°æ®åŒæ­¥åˆ° Elasticsearch ç´¢å¼•ä¸­ã€‚</li>
<li><strong>è®°å½•æ—¥å¿—</strong>ï¼šè®°å½•æ›´æ–°æˆåŠŸçš„å•†å“æ¡æ•°ã€‚</li>
</ul>
</li>
</ul>
<h4 id="MyJob2"><a href="#MyJob2" class="headerlink" title="MyJob2"></a>MyJob2</h4><p>è¿™ä¸ªç±»ä¹Ÿæ˜¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡çš„å®ç°ç±»ï¼Œä¸è¿‡ï¼š</p>
<p><strong>ä½œç”¨</strong>ï¼š<br>ä½œä¸ºç¬¬äºŒä¸ªå®šæ—¶ä»»åŠ¡ç¤ºä¾‹ï¼Œä»…æ‰“å°æ—¥å¿—ï¼Œæ¼”ç¤ºåˆ†ç‰‡åŠŸèƒ½å¦‚ä½•ç”Ÿæ•ˆã€‚</p>
<h4 id="ElasticJobApplication"><a href="#ElasticJobApplication" class="headerlink" title="ElasticJobApplication"></a>ElasticJobApplication</h4><p>ElasticJob æœåŠ¡å¯åŠ¨ç±»</p>
<ul>
<li>å¯åŠ¨æ•´ä¸ªä»»åŠ¡æœåŠ¡ç¨‹åºï¼Œæ³¨å†Œä¸¤ä¸ª ElasticJob å®šæ—¶ä»»åŠ¡</li>
</ul>
<h4 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h4><p>ElasticJob é…ç½®æ–‡ä»¶</p>
<ul>
<li>é…ç½®äº† ElasticJobã€Dubboã€Nacosã€æœåŠ¡ç«¯å£ç­‰ä¿¡æ¯ï¼Œæ˜¯æ•´ä¸ªä»»åŠ¡ç³»ç»Ÿçš„é…ç½®ä¸­å¿ƒã€‚</li>
<li>æ¯ 6 ç§’æ‰§è¡Œä¸€æ¬¡ MyJob</li>
<li>å®šä¹‰å¹¶é…ç½®ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆsimpleJob å’Œ simpleJob2ï¼‰çš„æ‰§è¡Œæ–¹å¼ï¼ŒåŒ…æ‹¬è°ƒåº¦æ—¶é—´ã€åˆ†ç‰‡ç­–ç•¥ã€æ‰§è¡Œç±»ç­‰ã€‚</li>
<li>æ³¨å†Œäº†ä¸¤ä¸ª ElasticJob åˆ†ç‰‡ä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œç±»åˆ†åˆ«æ˜¯ MyJob å’Œ MyJob2ï¼Œéƒ½æ¯ 6 ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œåˆ†ç‰‡æ•°é‡ä¸º 1ï¼Œæ‰§è¡Œæ—¶ä½¿ç”¨è½®è¯¢ç­–ç•¥ï¼Œå¹¶é€šè¿‡ Zookeeper æ³¨å†Œä¸­å¿ƒè¿›è¡Œè°ƒåº¦ç®¡ç†ã€‚</li>
</ul>
<h4 id="goodskill-job-æ‰§è¡Œæµç¨‹"><a href="#goodskill-job-æ‰§è¡Œæµç¨‹" class="headerlink" title="goodskill-job æ‰§è¡Œæµç¨‹"></a>goodskill-job æ‰§è¡Œæµç¨‹</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs lua">          +<span class="hljs-comment">--------------------------+</span><br>          | ElasticJobApplication    |<br>          |  â¬‡ å¯åŠ¨ SpringBoot       |<br>          +<span class="hljs-comment">------------+-------------+</span><br>                       |<br>             Registers ElasticJob Jobs<br>                       |<br>         +<span class="hljs-comment">-------------+--------------+</span><br>         |                            |<br>+<span class="hljs-comment">------------------+       +------------------+</span><br>|     MyJob        |       |     MyJob2       |<br>| ES ç´¢å¼•æ›´æ–°ä»»åŠ¡   |       | æ—¥å¿—æ¼”ç¤ºä»»åŠ¡       |<br>+<span class="hljs-comment">------------------+       +------------------+</span><br>         |                            |<br>    +<span class="hljs-comment">----v----+                 +-----v----+</span><br>    | Dubbo   |                 |  æ—¥å¿—æ‰“å° |<br>    | Goods   |                 +<span class="hljs-comment">----------+</span><br>    | Services|<br>    +<span class="hljs-comment">---------+</span><br></code></pre></td></tr></table></figure>


<h1 id="9-goodskill-common-å…¬å…±æœåŠ¡"><a href="#9-goodskill-common-å…¬å…±æœåŠ¡" class="headerlink" title="9. goodskill-common (å…¬å…±æœåŠ¡)"></a>9. goodskill-common (å…¬å…±æœåŠ¡)</h1><ul>
<li>goodskill.common.api</li>
<li>goodskill.common.service</li>
<li>goodskill.core</li>
</ul>
<p><img src="/img/blogs/java/goodskill/9.0.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="9-1-goodskill-common-api-æ¨¡å—"><a href="#9-1-goodskill-common-api-æ¨¡å—" class="headerlink" title="9.1 goodskill-common-api æ¨¡å—"></a>9.1 goodskill-common-api æ¨¡å—</h2><p><img src="/img/blogs/java/goodskill/9.1.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>DictDTO</code>: ä¸šåŠ¡å­—å…¸è¡¨ï¼Œç”¨äºåœ¨ç³»ç»Ÿä¸­ä¼ é€’â€œä¸šåŠ¡å­—å…¸â€ç›¸å…³çš„æ•°æ®</li>
<li><code>DictSimpleDTO</code>: <strong>ç®€åŒ–ç‰ˆ</strong>å­—å…¸æ•°æ®æ¨¡å‹</li>
</ul>
<h4 id="DictionaryService"><a href="#DictionaryService" class="headerlink" title="DictionaryService"></a>DictionaryService</h4><p><strong>å­—å…¸é€šç”¨æœåŠ¡æ¥å£</strong></p>
<ul>
<li>ä¸ºç³»ç»Ÿæä¾›ç»Ÿä¸€çš„ä¸šåŠ¡å­—å…¸æŸ¥è¯¢èƒ½åŠ›ï¼Œæ”¯æŒé€šè¿‡å­—å…¸ç¼–ç ã€é”®ï¼ˆkeyï¼‰ã€å€¼ï¼ˆvalueï¼‰ç­‰æ–¹å¼è·å–ç®€åŒ–çš„å­—å…¸æ•°æ®ï¼Œç”¨äºå‰ç«¯å±•ç¤ºæˆ–ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚</li>
</ul>
<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>getSimpleDictByCode</td>
<td>å‰ç«¯åŠ è½½ä¸‹æ‹‰æ¡†&#x2F;å•é€‰æ¡†é€‰é¡¹</td>
</tr>
<tr>
<td>getSimpleDictByDictCodeAndDictKey</td>
<td>é€šè¿‡ code+key æ˜¾ç¤ºå…·ä½“å­—å…¸é¡¹ï¼Œæ¯”å¦‚å±•ç¤ºâ€œç”·â€è€Œä¸æ˜¯â€œ1â€</td>
</tr>
<tr>
<td>getSimpleDictByDictCodeAndDictValue</td>
<td>é€šè¿‡ code+value åæŸ¥ keyï¼Œé€‚ç”¨äºæ•°æ®å…¥åº“æˆ–æ¯”å¯¹</td>
</tr>
</tbody></table>
<h4 id="GlobalDictionaryService"><a href="#GlobalDictionaryService" class="headerlink" title="GlobalDictionaryService"></a>GlobalDictionaryService</h4><p><strong>å…¨å±€å­—å…¸é€šç”¨æœåŠ¡æ¥å£</strong></p>
<ul>
<li>å®ƒçš„æ ¸å¿ƒç›®æ ‡æ˜¯ä¸ºç³»ç»Ÿæä¾›æ— éœ€æŒ‡å®šç³»ç»Ÿç¼–ç ï¼ˆsystemCodeï¼‰çš„å­—å…¸æŸ¥è¯¢èƒ½åŠ›ï¼Œ<strong>é€‚ç”¨äºé€šç”¨æ€§æ›´å¼ºã€ä¸åŒºåˆ†å­ç³»ç»Ÿçš„å­—å…¸æŸ¥è¯¢åœºæ™¯</strong>ã€‚</li>
</ul>
<h2 id="9-2-goodskill-common-service"><a href="#9-2-goodskill-common-service" class="headerlink" title="9.2 goodskill-common-service"></a>9.2 goodskill-common-service</h2><p><img src="/img/blogs/java/goodskill/9.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="OssFileController"><a href="#OssFileController" class="headerlink" title="OssFileController"></a>OssFileController</h4><p>æ˜¯ä¸€ä¸ªåŸºäº Spring Boot å®ç°çš„ <strong>æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½æ§åˆ¶å™¨ç±»</strong>ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li><strong>æä¾›ç»Ÿä¸€çš„æ¥å£</strong>ï¼Œç”¨äºæ¥æ”¶å‰ç«¯ä¸Šä¼ çš„æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶ä¸Šä¼ åˆ° MinIOï¼ŒåŒæ—¶ä¿å­˜æ–‡ä»¶ä¿¡æ¯ï¼ˆå¦‚ MD5ã€æ–‡ä»¶åæ˜ å°„ï¼‰åˆ° MongoDB ä¸­ï¼›åŒæ—¶æä¾›æ–‡ä»¶ä¸‹è½½æ¥å£ï¼Œæ”¯æŒè¿”å›æ–‡ä»¶çš„äºŒè¿›åˆ¶æµæˆ–ç”Ÿæˆä¸´æ—¶ä¸‹è½½ URLã€‚</li>
</ul>
<h4 id="FileNameMapping"><a href="#FileNameMapping" class="headerlink" title="FileNameMapping"></a>FileNameMapping</h4><p>ä½œä¸º<strong>æ–‡ä»¶åæ˜ å°„ä¿¡æ¯çš„å®ä½“ç±»</strong>ï¼Œ<strong>ç”¨äºå­˜å‚¨ä¸Šä¼ æ–‡ä»¶çš„å…ƒæ•°æ®ä¿¡æ¯</strong>ï¼Œ<strong>å¹¶æŒä¹…åŒ–åˆ° MongoDB</strong> çš„ oss_file_name_mapping é›†åˆä¸­ã€‚</p>
<h4 id="FileNameMappingRepository"><a href="#FileNameMappingRepository" class="headerlink" title="FileNameMappingRepository"></a>FileNameMappingRepository</h4><p>ç”¨äº<strong>æ“ä½œ MongoDB çš„ æ•°æ®è®¿é—®å±‚æ¥å£</strong>ï¼ˆRepositoryï¼‰ï¼Œç»§æ‰¿è‡ª Spring Data æä¾›çš„ MongoRepositoryï¼Œç”¨äº<strong>ç®¡ç† FileNameMapping å®ä½“çš„æ•°æ®åº“æ“ä½œ</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•ç­¾å</th>
<th>æŸ¥è¯¢æ¡ä»¶</th>
<th>è¿”å›å†…å®¹</th>
<th>ä½œç”¨è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>findByOriginalFileName(String originalFileName)</td>
<td>æ ¹æ®åŸå§‹æ–‡ä»¶åæŸ¥è¯¢</td>
<td><code>Optional&lt;FileNameMapping&gt;</code></td>
<td>åˆ¤æ–­ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨</td>
</tr>
<tr>
<td>findByUniqueFileName(String uniqueFileName)</td>
<td>æ ¹æ®å”¯ä¸€æ–‡ä»¶åæŸ¥è¯¢</td>
<td><code>Optional&lt;FileNameMapping&gt;</code></td>
<td>æ ¹æ® MinIO ä¸Šçš„æ–‡ä»¶åæ‰¾è®°å½•</td>
</tr>
<tr>
<td>findFirstByFileMd5(String fileMd5)</td>
<td>æ ¹æ®æ–‡ä»¶ MD5 æŸ¥è¯¢ä¸€æ¡è®°å½•</td>
<td><code>Optional&lt;FileNameMapping&gt;</code></td>
<td>åˆ¤æ–­æ˜¯å¦ä¸Šä¼ è¿‡ç›¸åŒå†…å®¹çš„æ–‡ä»¶ï¼ˆå®ç°æ–‡ä»¶å»é‡é€»è¾‘ï¼‰</td>
</tr>
</tbody></table>
<h4 id="CommonServiceApplication"><a href="#CommonServiceApplication" class="headerlink" title="CommonServiceApplication"></a>CommonServiceApplication</h4><p>ç”¨äºå¯åŠ¨æ•´ä¸ª Common Service æ¨¡å—çš„æœåŠ¡</p>
<h2 id="9-3-goodskill-core"><a href="#9-3-goodskill-core" class="headerlink" title="9.3 goodskill-core"></a>9.3 goodskill-core</h2><p><img src="/img/blogs/java/goodskill/9.3.1.png" srcset="/img/loading.gif" lazyload></p>
<p>åˆ†ä¸ºä¸‰ä¸ªå­æ¨¡å—ï¼š</p>
<ul>
<li>core-jwt</li>
<li>core-orm</li>
<li>core-util</li>
</ul>
<h3 id="9-3-1-core-jwt"><a href="#9-3-1-core-jwt" class="headerlink" title="9.3.1 core-jwt"></a>9.3.1 core-jwt</h3><p><img src="/img/blogs/java/goodskill/9.3.2.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="JwtUtils"><a href="#JwtUtils" class="headerlink" title="JwtUtils"></a>JwtUtils</h4><p><strong>JWT å·¥å…·ç±»</strong></p>
<ul>
<li>ç”¨äºåœ¨é¡¹ç›®ä¸­ åˆ›å»ºã€éªŒè¯å’Œè§£æ JWTï¼ˆJSON Web Tokenï¼‰ä»¤ç‰Œï¼Œå¸¸ç”¨äºç”¨æˆ·èº«ä»½è®¤è¯å’Œæˆæƒåœºæ™¯ã€‚</li>
</ul>
<p>JwtUtils å°è£…äº† JWT çš„å¸¸ç”¨æ“ä½œï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li>åˆ›å»º Tokenï¼ˆcreateTokenï¼‰</li>
<li>éªŒè¯ Token åˆæ³•æ€§ï¼ˆverifyTokenï¼‰</li>
<li>è§£æ Token ä¸­çš„å†…å®¹ï¼ˆparseTokenï¼‰</li>
<li>ç”Ÿæˆç”¨äºç­¾åçš„å¯†é’¥ï¼ˆgenerateKeyï¼‰<br>é€‚åˆåœ¨ç™»å½•æˆåŠŸåç”Ÿæˆ Tokenï¼Œä¸‹æ¬¡è®¿é—®æ¥å£æ—¶ç”¨è¿™ä¸ª Token éªŒè¯ç”¨æˆ·èº«ä»½ã€‚</li>
</ul>
<h3 id="9-3-2-core-orm"><a href="#9-3-2-core-orm" class="headerlink" title="9.3.2 core-orm"></a>9.3.2 core-orm</h3><p><img src="/img/blogs/java/goodskill/9.3.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="FieldMetaObjectHandler"><a href="#FieldMetaObjectHandler" class="headerlink" title="FieldMetaObjectHandler"></a>FieldMetaObjectHandler</h4><p>æ˜¯ MyBatis-Plus æä¾›çš„ä¸€ä¸ª <strong>å­—æ®µè‡ªåŠ¨å¡«å……å¤„ç†å™¨</strong>ï¼Œç”¨äºåœ¨æ’å…¥æˆ–æ›´æ–°æ•°æ®åº“è®°å½•æ—¶ï¼Œ<strong>è‡ªåŠ¨å¡«å……å…¬å…±å­—æ®µ</strong>ï¼ˆå¦‚ï¼šcreateTime, updateTime, createUser, updateUser ç­‰ï¼‰ï¼Œé¿å…æ‰‹åŠ¨èµ‹å€¼ï¼Œç®€åŒ–å¼€å‘ã€‚</p>
<ul>
<li>FieldMetaObjectHandler æ˜¯ä¸ºäº†è§£å†³ä½ åœ¨æ–°å¢æˆ–æ›´æ–°æ•°æ®æ—¶ï¼Œä¸ç”¨æ¯æ¬¡éƒ½æ‰‹åŠ¨è®¾ç½® åˆ›å»ºäºº&#x2F;åˆ›å»ºæ—¶é—´&#x2F;æ›´æ–°äºº&#x2F;æ›´æ–°æ—¶é—´ï¼ŒMyBatis-Plus å¸®ä½ è‡ªåŠ¨æå®šã€‚</li>
</ul>
<h4 id="MybatisPlusConfig"><a href="#MybatisPlusConfig" class="headerlink" title="MybatisPlusConfig"></a>MybatisPlusConfig</h4><p>æ˜¯ä¸€ä¸ª MyBatis-Plus çš„é…ç½®ç±»ï¼Œä¸»è¦ä½œç”¨æ˜¯<strong>é…ç½®åˆ†é¡µæ’ä»¶ï¼Œä»¥æ”¯æŒæ•°æ®åº“çš„åˆ†é¡µæŸ¥è¯¢åŠŸèƒ½</strong>ã€‚</p>
<ul>
<li>å‘ Spring å®¹å™¨ä¸­æ³¨å…¥ MybatisPlusInterceptorï¼Œå¹¶æ³¨å†Œåˆ†é¡µæ‹¦æˆªå™¨ PaginationInnerInterceptorï¼Œç”¨äºå¼€å¯ MyBatis-Plus çš„åˆ†é¡µåŠŸèƒ½ã€‚</li>
</ul>
<h3 id="9-3-3-core-util"><a href="#9-3-3-core-util" class="headerlink" title="9.3.3 core-util"></a>9.3.3 core-util</h3><p><img src="/img/blogs/java/goodskill/9.3.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="constantåŒ…"><a href="#constantåŒ…" class="headerlink" title="constantåŒ…"></a>constantåŒ…</h4><ul>
<li><code>SeckillStatusConstant</code>ï¼šå®šä¹‰ç§’æ€æ´»åŠ¨çŠ¶æ€çš„å¸¸é‡</li>
</ul>
<h4 id="entityåŒ…"><a href="#entityåŒ…" class="headerlink" title="entityåŒ…"></a>entityåŒ…</h4><ul>
<li><code>BaseColEntity</code> æ˜¯ä¸€ä¸ª é€šç”¨çš„åŸºç¡€ç±»ï¼Œä¸»è¦ä½œç”¨æ˜¯<strong>ä¸ºç³»ç»Ÿä¸­ç»å¤§éƒ¨åˆ†å®ä½“ç±»æä¾›å…¬å…±å­—æ®µï¼Œæ¯”å¦‚ï¼šcreateTimeã€updateTimeã€createUser å’Œ updateUser</strong>, ç”¨äºå°è£…å®ä½“ç±»ä¸­å¸¸è§çš„å®¡è®¡å­—æ®µï¼ˆè®°å½•åˆ›å»ºã€æ›´æ–°äººå’Œæ—¶é—´ï¼‰ï¼Œæ–¹ä¾¿ä»£ç å¤ç”¨ï¼Œå‡å°‘å†—ä½™ã€‚</li>
</ul>
<h4 id="enumsåŒ…"><a href="#enumsåŒ…" class="headerlink" title="enumsåŒ…"></a>enumsåŒ…</h4><ul>
<li><code>ActivityEvent</code>ï¼š æšä¸¾å„ä¸ªæ”¯ä»˜äº‹ä»¶</li>
<li><code>CommonConstants</code>: å…¬å…±å¸¸é‡ç±»ï¼ŒåŒ…å«ç”¨æˆ·è´¦æˆ·çŠ¶æ€</li>
<li><code>Events</code>: æšä¸¾å„ä¸ªæ”¯ä»˜äº‹ä»¶(å’ŒActivityEventä¸€æ ·) </li>
<li><code>SeckillSolutionEnum</code>: æšä¸¾å„ä¸ªç§’æ€åœºæ™¯</li>
<li><code>SeckillStatEnum</code>: æšä¸¾ç§’æ€çŠ¶æ€</li>
<li><code>States</code>: ç§’æ€æ´»åŠ¨çŠ¶æ€æšä¸¾</li>
<li><code>UserAccountEnum</code>: æšä¸¾ç”¨æˆ·è´¦æˆ·ç™»å½•çŠ¶æ€</li>
</ul>
<h4 id="exceptionåŒ…"><a href="#exceptionåŒ…" class="headerlink" title="exceptionåŒ…"></a>exceptionåŒ…</h4><ul>
<li><code>CommonException</code>: è‡ªå®šä¹‰æ™®é€šå¼‚å¸¸</li>
<li><code>SeckillException</code>: è‡ªå®šä¹‰ç§’æ€å¼‚å¸¸</li>
<li><code>SeckillCloseException</code>: è‡ªå®šä¹‰ç§’æ€å…³é—­å¼‚å¸¸</li>
</ul>
<h4 id="feignåŒ…"><a href="#feignåŒ…" class="headerlink" title="feignåŒ…"></a>feignåŒ…</h4><ul>
<li><code>FeignHeaderInterceptor</code> çš„ä½œç”¨æ˜¯ <strong>æ‹¦æˆªå¹¶ä¼ é€’ HTTP è¯·æ±‚ä¸­çš„å¤´éƒ¨ä¿¡æ¯</strong>ï¼Œä½¿å¾—åœ¨ä½¿ç”¨ Feign è¿›è¡Œè¿œç¨‹è°ƒç”¨æ—¶ï¼Œèƒ½å¤Ÿå°†å½“å‰è¯·æ±‚çš„å¤´éƒ¨ä¿¡æ¯è‡ªåŠ¨æ·»åŠ åˆ° Feign è¯·æ±‚çš„å¤´éƒ¨ã€‚</li>
</ul>
<h4 id="infoåŒ…"><a href="#infoåŒ…" class="headerlink" title="infoåŒ…"></a>infoåŒ…</h4><ul>
<li><code>ResultCode</code>ï¼š æšä¸¾ç³»ç»Ÿå“åº”ç </li>
</ul>
<h5 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h5><p>é€šç”¨çš„å“åº”å°è£…ç±»ï¼Œç”¨äº<strong>ç»Ÿä¸€å°è£… API å“åº”ç»“æœ</strong></p>
<ul>
<li>ç»Ÿä¸€å°è£… API å“åº”ç»“æœï¼Œä½¿å¾—æ‰€æœ‰æ¥å£çš„è¿”å›ç»“æ„ä¿æŒä¸€è‡´ã€‚</li>
<li>æä¾›äº†é€šç”¨çš„è¿”å›ç ï¼ˆå¦‚æˆåŠŸã€å¤±è´¥ï¼‰å’Œå“åº”ä¿¡æ¯å­—æ®µï¼Œä¾¿äºå®¢æˆ·ç«¯å¤„ç†ã€‚</li>
</ul>
<h5 id="ApiResult"><a href="#ApiResult" class="headerlink" title="ApiResult"></a>ApiResult</h5><p><strong>API å“åº”ç»“æœçš„å°è£…ç±»</strong>ï¼Œç”¨äºç»Ÿä¸€ç®¡ç†æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼</p>
<ul>
<li>ApiResult ç±»ä¸»è¦ç”¨äºå°è£… API çš„å“åº”å†…å®¹ã€‚é€šè¿‡è¯¥ç±»ï¼Œå¼€å‘è€…å¯ä»¥ç»Ÿä¸€å®šä¹‰æ¥å£è¿”å›çš„æ ¼å¼ï¼Œä½¿å¾—æ¥å£çš„å“åº”ç»“æ„åœ¨ç³»ç»Ÿä¸­ä¿æŒä¸€è‡´ã€‚</li>
</ul>
<h4 id="pojoåŒ…"><a href="#pojoåŒ…" class="headerlink" title="pojoåŒ…"></a>pojoåŒ…</h4><ul>
<li><code>UserBO</code> ç±»æ˜¯ä¸€ä¸ªç”¨äºè¡¨ç¤º <strong>ç”¨æˆ·åŸºæœ¬ä¿¡æ¯çš„ä¸šåŠ¡å¯¹è±¡</strong>ï¼ˆBO, Business Objectï¼‰ã€‚å®ƒå°è£…äº†ä¸ç”¨æˆ·ç›¸å…³çš„æ‰€æœ‰åŸºç¡€ä¿¡æ¯ï¼Œé€šå¸¸ç”¨äºåœ¨ç³»ç»Ÿä¸­ä¼ é€’æˆ–æŒä¹…åŒ–ç”¨æˆ·æ•°æ®ã€‚</li>
<li><code>AuthResponseDTO</code> ç±»æ˜¯ä¸€ä¸ª <strong>ç”¨æˆ·é‰´æƒæœåŠ¡çš„å“åº”æ•°æ®ä¼ è¾“å¯¹è±¡</strong>ã€‚å®ƒç”¨äºåœ¨ç”¨æˆ·è®¤è¯æˆåŠŸåå‘å®¢æˆ·ç«¯è¿”å›è®¤è¯ä¿¡æ¯ã€‚</li>
<li><code>SeckillWebMockRequestDTO</code> ç±»æ˜¯ä¸€ä¸ª <strong>æ¨¡æ‹Ÿç§’æ€è¯·æ±‚</strong>çš„ DTOï¼Œç”¨äºæ¨¡æ‹Ÿç§’æ€æ´»åŠ¨ä¸­çš„è¯·æ±‚æ•°æ®ã€‚è¯¥ç±»å¯èƒ½ç”¨äºæµ‹è¯•ã€æ¨¡æ‹Ÿæˆ–è°ƒè¯•ç§’æ€ç³»ç»Ÿçš„åŠŸèƒ½</li>
</ul>
<h4 id="utilåŒ…"><a href="#utilåŒ…" class="headerlink" title="utilåŒ…"></a>utilåŒ…</h4><ul>
<li><code>HeaderUtil</code>: ä»å½“å‰è¯·æ±‚çš„ Header ä¸­æå– userIdã€‚</li>
<li><code>MD5Util</code>: ç”Ÿæˆå’Œè·å–md5åŠ å¯†</li>
<li><code>UserInfoUtil</code>: ç”¨æˆ·ä¿¡æ¯å·¥å…·ç±»ï¼Œä¸»è¦ç”¨äºä»å½“å‰è¯·æ±‚ä¸­æå–ç”¨æˆ·ä¿¡æ¯ã€‚</li>
</ul>
<h1 id="10-goodskill-gateway-å¾®æœåŠ¡APIç½‘å…³ï¼Œç»Ÿä¸€æœåŠ¡é‰´æƒï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½"><a href="#10-goodskill-gateway-å¾®æœåŠ¡APIç½‘å…³ï¼Œç»Ÿä¸€æœåŠ¡é‰´æƒï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½" class="headerlink" title="10. goodskill-gateway (å¾®æœåŠ¡APIç½‘å…³ï¼Œç»Ÿä¸€æœåŠ¡é‰´æƒï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½)"></a>10. goodskill-gateway (å¾®æœåŠ¡APIç½‘å…³ï¼Œç»Ÿä¸€æœåŠ¡é‰´æƒï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±åŠ è½½)</h1><p><img src="/img/blogs/java/goodskill/10.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="10-1-configåŒ…"><a href="#10-1-configåŒ…" class="headerlink" title="10.1 configåŒ…"></a>10.1 configåŒ…</h2><ul>
<li>GatewayConfiguration</li>
<li>SaTokenConfiguration</li>
<li>StpInterfaceImpl</li>
</ul>
<h4 id="GatewayConfiguration"><a href="#GatewayConfiguration" class="headerlink" title="GatewayConfiguration"></a>GatewayConfiguration</h4><p><strong>é…ç½® Spring Cloud Gateway ç½‘å…³è·¯ç”±</strong></p>
<ul>
<li>ä¸ºå¾®æœåŠ¡æ¶æ„ä¸­çš„ Spring Cloud Gateway ç½‘å…³æœåŠ¡ æä¾› è·¯ç”±è½¬å‘èƒ½åŠ›å’Œè¿œç¨‹è°ƒç”¨çš„å…¼å®¹æ”¯æŒã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GatewayConfiguration</span> &#123;<br><br>    <span class="hljs-comment">// å®šä¹‰ç½‘å…³è·¯ç”±è§„åˆ™</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RouteLocator <span class="hljs-title function_">customizedLocator</span><span class="hljs-params">(RouteLocatorBuilder builder)</span> &#123;<br>        <span class="hljs-keyword">return</span> builder.routes()<br>                .route(<span class="hljs-string">&quot;goodskill-order&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/api/order/**&quot;</span>)<br>                        .filters(f -&gt; f.stripPrefix(<span class="hljs-number">2</span>))<br>                        .uri(<span class="hljs-string">&quot;lb://goodskill-order&quot;</span>))<br>                .route(<span class="hljs-string">&quot;goodskill-seata&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/api/seata/**&quot;</span>)<br>                        .filters(f -&gt; f.stripPrefix(<span class="hljs-number">2</span>))<br>                        .uri(<span class="hljs-string">&quot;lb://goodskill-seata&quot;</span>))<br>                .route(<span class="hljs-string">&quot;goodskill-seckill&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/api/seckill/**&quot;</span>)<br>                        .filters(f -&gt; f.stripPrefix(<span class="hljs-number">2</span>))<br>                        .uri(<span class="hljs-string">&quot;lb://goodskill-seckill&quot;</span>))<br>                .route(<span class="hljs-string">&quot;goodskill-auth&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/api/auth/**&quot;</span>)<br>                        .filters(f -&gt; f.stripPrefix(<span class="hljs-number">2</span>))<br>                        .uri(<span class="hljs-string">&quot;lb://goodskill-auth&quot;</span>))<br>                .route(<span class="hljs-string">&quot;goodskill-web&quot;</span>, r -&gt; r.path(<span class="hljs-string">&quot;/api/web/**&quot;</span>)<br>                        .filters(f -&gt; f.stripPrefix(<span class="hljs-number">2</span>))<br>                        .uri(<span class="hljs-string">&quot;lb://goodskill-web&quot;</span>))<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">// ä¿®å¤ä½¿ç”¨feign clientè¿œç¨‹è°ƒç”¨æœåŠ¡æ—¶æŠ¥HttpMessageConvertersç¼ºå¤±é—®é¢˜</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-keyword">public</span> HttpMessageConverters <span class="hljs-title function_">messageConverters</span><span class="hljs-params">(ObjectProvider&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpMessageConverters</span>(converters.orderedStream().collect(Collectors.toList()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ–¹æ³•</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>customizedLocator</td>
<td>å®šä¹‰ç½‘å…³è·¯ç”±è§„åˆ™ï¼Œå°† &#x2F;api&#x2F;â€¦ è·¯å¾„è½¬å‘ç»™å¯¹åº”å¾®æœåŠ¡ï¼Œæ”¯æŒè·¯å¾„å‰ç¼€å‰¥ç¦»ã€æœåŠ¡åè·¯ç”±ç­‰</td>
</tr>
<tr>
<td>messageConverters</td>
<td>é˜²æ­¢ Feign ä½¿ç”¨ä¸­ HTTP æ¶ˆæ¯è½¬æ¢å™¨ç¼ºå¤±çš„é—®é¢˜ï¼Œä¿éšœè¿œç¨‹è°ƒç”¨çš„æ•°æ®è½¬æ¢æ­£å¸¸</td>
</tr>
</tbody></table>
<h4 id="SaTokenConfiguration"><a href="#SaTokenConfiguration" class="headerlink" title="SaTokenConfiguration"></a>SaTokenConfiguration</h4><p>Sa-Token æƒé™è®¤è¯æ¡†æ¶çš„ <strong>å…¨å±€é…ç½®ç±»</strong>ï¼Œå…¶ä¸»è¦ä½œç”¨æ˜¯<strong>åœ¨ç½‘å…³å±‚ç»Ÿä¸€å¤„ç†ç™»å½•æ ¡éªŒã€æƒé™æ§åˆ¶ã€æ”¾è¡Œç™½åå•ã€å¼‚å¸¸å¤„ç†ç­‰é€»è¾‘</strong>ã€‚</p>
<ul>
<li>é…ç½® Sa-Token çš„å…¨å±€è¿‡æ»¤å™¨ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œç»Ÿä¸€çš„æƒé™è®¤è¯å¤„ç†</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * [Sa-Token æƒé™è®¤è¯] å…¨å±€é…ç½®ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SaTokenConfiguration</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IgnoreProperties ignoreProperties;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ³¨å†Œ [Sa-Tokenå…¨å±€è¿‡æ»¤å™¨]ï¼Œä¼˜å…ˆçº§é«˜äºGlobalFilterï¼Œå³åœ¨GlobalFilterä¹‹å‰æ‰§è¡Œ</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> SaReactorFilter <span class="hljs-title function_">getSaReactorFilter</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SaReactorFilter</span>()<br>                <span class="hljs-comment">// æŒ‡å®š [æ‹¦æˆªè·¯ç”±]</span><br>                .addInclude(<span class="hljs-string">&quot;/**&quot;</span>)    <span class="hljs-comment">/* æ‹¦æˆªæ‰€æœ‰path */</span><br>                <span class="hljs-comment">// æŒ‡å®š [æ”¾è¡Œè·¯ç”±]</span><br>                .addExclude(<span class="hljs-string">&quot;/favicon.ico&quot;</span>, <span class="hljs-string">&quot;/actuator/**&quot;</span>)<br>                <span class="hljs-comment">// æŒ‡å®š[è®¤è¯å‡½æ•°]: æ¯æ¬¡è¯·æ±‚æ‰§è¡Œ</span><br>                .setAuth(obj -&gt; &#123;<br>                    <span class="hljs-comment">// æ‰“å°è·¯å¾„</span><br>                    <span class="hljs-type">ServerHttpRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> SaReactorSyncHolder.getContext().getRequest();<br>                    <span class="hljs-type">RequestPath</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> request.getPath();<br>                    log.info(<span class="hljs-string">&quot;---------- saå…¨å±€è®¤è¯, è¯·æ±‚url:&#123;&#125;&quot;</span>, path);<br>                    SaRouter.notMatch(ignoreProperties.getWhiteUrl())<br>                            .check(r -&gt; &#123;<br>                                StpUtil.checkLogin();<br>                                request.mutate().header(USER_ID_HEADER, StpUtil.getLoginId() + <span class="hljs-string">&quot;&quot;</span>);<br>                                List&lt;String&gt; userWhiteUrlList = ignoreProperties.getLoginUserWhiteUrls();<br>                                <span class="hljs-comment">// ç™»å½•ç”¨æˆ·ç™½åå•æ¥å£æ”¾è¡Œ</span><br>                                <span class="hljs-keyword">if</span> (!ifMatchUserLoginWhiteUrl(userWhiteUrlList, path)) &#123;<br><span class="hljs-comment">//                                    StpUtil.checkPermission(path.value());</span><br>                                &#125;<br>                            &#125;);<br>                &#125;)<br>                <span class="hljs-comment">// æŒ‡å®š[å¼‚å¸¸å¤„ç†å‡½æ•°]ï¼šæ¯æ¬¡[è®¤è¯å‡½æ•°]å‘ç”Ÿå¼‚å¸¸æ—¶æ‰§è¡Œæ­¤å‡½æ•°</span><br>                .setError(e -&gt; &#123;<br>                    log.error(<span class="hljs-string">&quot;---------- saå…¨å±€å¼‚å¸¸&quot;</span>, e);<br>                    <span class="hljs-keyword">return</span> SaResult.error(e.getMessage());<br>                &#125;);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ¤æ–­å½“å‰urlæ˜¯å¦å‘½ä¸­ç™½åå•</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">ifMatchUserLoginWhiteUrl</span><span class="hljs-params">(List&lt;String&gt; userWhite, RequestPath path)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">found</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (String pattern : userWhite) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">match</span> <span class="hljs-operator">=</span> SaPathMatcherHolder.getPathMatcher().match(pattern, path.value());<br>            <span class="hljs-keyword">if</span> (match) &#123;<br>                found = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> found;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>åŠŸèƒ½æ¨¡å—</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>ç™»å½•æ ¡éªŒ</td>
<td>éç™½åå•æ¥å£å¿…é¡»ç™»å½•æ‰èƒ½è®¿é—®</td>
</tr>
<tr>
<td>æƒé™æ§åˆ¶</td>
<td>ç™»å½•åå¯æ‹“å±•æ§åˆ¶ç”¨æˆ·è®¿é—®å“ªäº›æ¥å£ï¼ˆé¢„ç•™æƒé™æ ¡éªŒä»£ç ï¼‰</td>
</tr>
<tr>
<td>ç™½åå•æœºåˆ¶</td>
<td>æ”¯æŒé…ç½®å…¨å±€ç™½åå• + ç™»å½•ç”¨æˆ·ç™½åå•</td>
</tr>
<tr>
<td>å¼‚å¸¸ç»Ÿä¸€å¤„ç†</td>
<td>æ‰€æœ‰å¼‚å¸¸éƒ½è¢«ç»Ÿä¸€æ•è·è¿”å›æ ¼å¼åŒ–çš„é”™è¯¯å“åº”</td>
</tr>
<tr>
<td>å…¼å®¹æ€§å¥½</td>
<td>åŸºäº Sa-Token + Spring Cloud Gatewayï¼Œé€‚ç”¨äºå¾®æœåŠ¡æ¶æ„</td>
</tr>
</tbody></table>
<h4 id="StpInterfaceImpl"><a href="#StpInterfaceImpl" class="headerlink" title="StpInterfaceImpl"></a>StpInterfaceImpl</h4><p>Sa-Token æ¡†æ¶ä¸­ç”¨äº <strong>è‡ªå®šä¹‰æƒé™å’Œè§’è‰²åŠ è½½é€»è¾‘çš„å®ç°ç±»</strong>ï¼Œå®ƒé€šè¿‡è¿œç¨‹è°ƒç”¨ç”¨æˆ·æƒé™æœåŠ¡ï¼ˆauthFeignClientï¼‰æ¥åŠ¨æ€è·å–ç”¨æˆ·çš„æƒé™å’Œè§’è‰²ã€‚</p>
<ul>
<li>æ ¹æ®ç”¨æˆ·çš„ loginId åŠ è½½å…¶æƒé™ç é›†åˆå’Œè§’è‰²é›†åˆï¼Œç”¨äº StpUtil.checkPermission()ã€StpUtil.checkRole() è¿™æ ·çš„æƒé™åˆ¤æ–­æ–¹æ³•</li>
<li>ç»“åˆ Sa-Token çš„æƒé™æ§åˆ¶æœºåˆ¶ï¼Œ<strong>å®ç°åœ¨ç™»å½•ååŠ¨æ€è·å–ç”¨æˆ·æƒé™å’Œè§’è‰²ä¿¡æ¯</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// sa-tokenè‡ªå®šä¹‰æƒé™åŠ è½½æ¥å£å®ç°ç±»</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StpInterfaceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StpInterface</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> AuthFeignClient authFeignClient;<br><br><br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getPermissionList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; authFeignClient.listUserPermission(String.valueOf(loginId), loginType)).join();<br>    &#125;<br><br><br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getRoleList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; authFeignClient.listUserRole(String.valueOf(loginId), loginType)).join();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>è¿”å›å€¼</th>
<th>ä½œç”¨è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>getPermissionList(Object loginId, String loginType)</td>
<td><code>List&lt;String&gt;</code></td>
<td>æ ¹æ® loginId è·å–è¯¥ç”¨æˆ·çš„æƒé™åˆ—è¡¨ï¼ˆå¦‚ï¼šuser:add, order:view ç­‰ï¼‰ï¼Œä¾›æƒé™æ³¨è§£æˆ–æ–¹æ³•è°ƒç”¨ä½¿ç”¨</td>
</tr>
<tr>
<td>getRoleList(Object loginId, String loginType)</td>
<td><code>List&lt;String&gt;</code></td>
<td>è·å–è¯¥ç”¨æˆ·æ‰€å±çš„è§’è‰²åˆ—è¡¨ï¼ˆå¦‚ï¼šadmin, user, super_adminï¼‰ï¼Œä¾›è§’è‰²æ³¨è§£æˆ–æ–¹æ³•è°ƒç”¨ä½¿ç”¨</td>
</tr>
</tbody></table>
<h2 id="10-2-feignåŒ…"><a href="#10-2-feignåŒ…" class="headerlink" title="10.2 feignåŒ…"></a>10.2 feignåŒ…</h2><h4 id="AuthFeignClientæ¥å£-1"><a href="#AuthFeignClientæ¥å£-1" class="headerlink" title="AuthFeignClientæ¥å£"></a>AuthFeignClientæ¥å£</h4><p>Feign å®¢æˆ·ç«¯æ¥å£ï¼Œç”¨äºåœ¨å¾®æœåŠ¡æ¶æ„ä¸­ <strong>è¿œç¨‹è°ƒç”¨ goodskill-auth æœåŠ¡</strong>çš„æ¥å£ï¼Œä¸“é—¨<strong>ç”¨äºè·å–ç”¨æˆ·çš„æƒé™ä¿¡æ¯å’Œè§’è‰²ä¿¡æ¯</strong>ã€‚</p>
<h2 id="10-3-properties"><a href="#10-3-properties" class="headerlink" title="10.3 properties"></a>10.3 properties</h2><h4 id="IgnoreProperties"><a href="#IgnoreProperties" class="headerlink" title="IgnoreProperties"></a>IgnoreProperties</h4><p>é…ç½® æ¥å£ç™½åå• çš„ Spring é…ç½®ç±»ï¼Œä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>ä»é…ç½®æ–‡ä»¶ä¸­è¯»å–ä¸éœ€è¦æƒé™æ ¡éªŒçš„ URL åˆ—è¡¨ï¼ˆç™½åå•ï¼‰ï¼Œå¹¶æä¾›ç»™æƒé™æ¡†æ¶ï¼ˆå¦‚ Sa-Tokenï¼‰ä½¿ç”¨ã€‚</li>
<li>ç”¨äºåŠ è½½å¹¶ç®¡ç† <strong>ç™½åå• URL åˆ—è¡¨</strong>ï¼ˆä¸æ‹¦æˆªã€æ— éœ€ç™»å½•å³å¯è®¿é—®ï¼‰</li>
</ul>
<h2 id="10-4-service"><a href="#10-4-service" class="headerlink" title="10.4 service"></a>10.4 service</h2><ul>
<li>DynamicRouteConfigWatcher</li>
<li>DynamicRouteRefresh</li>
</ul>
<h4 id="DynamicRouteConfigWatcher"><a href="#DynamicRouteConfigWatcher" class="headerlink" title="DynamicRouteConfigWatcher"></a>DynamicRouteConfigWatcher</h4><p><strong>åŠ¨æ€ç½‘å…³è·¯ç”±é…ç½®ç›‘å¬å™¨å’Œåˆå§‹åŒ–å™¨</strong>ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>ä» Nacos ä¸­è¯»å–ã€ç›‘å¬å¹¶åº”ç”¨åŠ¨æ€è·¯ç”±é…ç½®ï¼Œç”¨äº Spring Cloud Gateway çš„åŠ¨æ€è·¯ç”±ç®¡ç†ã€‚</li>
</ul>
<ol>
<li>åˆå§‹åŒ–ç½‘å…³è·¯ç”±é…ç½®ï¼ˆä» Nacos è·å–ï¼‰</li>
<li>ç›‘å¬ Nacos ä¸­è·¯ç”±é…ç½®å˜åŒ–å¹¶è‡ªåŠ¨æ›´æ–°ç½‘å…³è·¯ç”±</li>
<li>å¯åŠ¨æ—¶åŠ è½½å½“å‰é…ç½®</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * åŠ¨æ€è·¯ç”±é…ç½®ç›‘å¬ä»¥åŠåˆå§‹åŒ–</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRouteConfigWatcher</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandLineRunner</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DynamicRouteRefresh dynamicRouteService;<br><br>    <span class="hljs-keyword">private</span> ConfigService configService;<br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.cloud.nacos.server-addr&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_SERVER_ADDR;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.cloud.nacos.namespace:&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_NAMESPACE;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.cloud.nacos.group:DEFAULT_GROUP&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_ROUTE_GROUP;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.cloud.nacos.username&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_USERNAME;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;spring.cloud.nacos.password&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_PASSWORD;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;nacos.router.data.id&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String NACOS_ROUTE_DATA_ID;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼šç”¨äºåˆå§‹åŒ– ConfigService å¹¶æ³¨å†Œè·¯ç”±é…ç½®ç›‘å¬å™¨</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        log.info(<span class="hljs-string">&quot;gateway route init...&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            configService = initConfigService();<br>            <span class="hljs-keyword">if</span> (configService == <span class="hljs-literal">null</span>) &#123;<br>                log.warn(<span class="hljs-string">&quot;initConfigService fail&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;åˆå§‹åŒ–ç½‘å…³è·¯ç”±æ—¶å‘ç”Ÿé”™è¯¯&quot;</span>, e);<br>        &#125;<br>        dynamicRouteByNacosListener(NACOS_ROUTE_DATA_ID, NACOS_ROUTE_GROUP);<br>    &#125;<br><br>    <span class="hljs-comment">// ç›‘å¬æŒ‡å®šçš„ Nacos è·¯ç”±é…ç½®ï¼Œå¦‚æœè·¯ç”±æœ‰å˜æ›´ï¼Œåˆ™è§¦å‘æ›´æ–°</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dynamicRouteByNacosListener</span><span class="hljs-params">(String dataId, String group)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            configService.addListener(dataId, group, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveConfigInfo</span><span class="hljs-params">(String configInfo)</span> &#123;<br>                    log.info(<span class="hljs-string">&quot;è¿›è¡Œç½‘å…³æ›´æ–°:\n\r&#123;&#125;&quot;</span>, configInfo);<br>                    List&lt;RouteDefinition&gt; definitionList = JSON.parseArray(configInfo, RouteDefinition.class);<br>                    log.info(<span class="hljs-string">&quot;update route : &#123;&#125;&quot;</span>, definitionList.toString());<br>                    dynamicRouteService.updateList(definitionList);<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getExecutor</span><span class="hljs-params">()</span> &#123;<br>                    log.info(<span class="hljs-string">&quot;getExecutor\n\r&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>            &#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (NacosException e) &#123;<br>            log.error(<span class="hljs-string">&quot;ä»nacosæ¥æ”¶åŠ¨æ€è·¯ç”±é…ç½®å‡ºé”™!!!&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆå§‹åŒ– Nacos é…ç½®å®¢æˆ·ç«¯ï¼Œè®¾ç½®å¿…è¦è¿æ¥å‚æ•°ï¼Œå¦‚åœ°å€ã€è´¦å·ã€å¯†ç ç­‰ã€‚</span><br>    <span class="hljs-keyword">private</span> ConfigService <span class="hljs-title function_">initConfigService</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>            properties.setProperty(<span class="hljs-string">&quot;serverAddr&quot;</span>, NACOS_SERVER_ADDR);<br>            properties.setProperty(<span class="hljs-string">&quot;username&quot;</span>, NACOS_USERNAME);<br>            properties.setProperty(<span class="hljs-string">&quot;password&quot;</span>, NACOS_PASSWORD);<br>            properties.setProperty(<span class="hljs-string">&quot;namespace&quot;</span>, NACOS_NAMESPACE);<br>            <span class="hljs-type">return</span> <span class="hljs-variable">configService</span> <span class="hljs-operator">=</span> NacosFactory.createConfigService(properties);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;åˆå§‹åŒ–ç½‘å…³è·¯ç”±æ—¶å‘ç”Ÿé”™è¯¯&quot;</span>, e);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// å®ç° CommandLineRunner æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶æ‰§è¡Œï¼šæ‹‰å–ä¸€æ¬¡å½“å‰ Nacos ä¸­çš„è·¯ç”±é…ç½®å¹¶åŠ è½½åˆ°ç½‘å…³ä¸­</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">configInfo</span> <span class="hljs-operator">=</span> configService.getConfig(NACOS_ROUTE_DATA_ID, NACOS_ROUTE_GROUP, <span class="hljs-number">3000</span>);<br>        log.info(<span class="hljs-string">&quot;è·å–ç½‘å…³å½“å‰é…ç½®:&#123;&#125;&quot;</span>, configInfo);<br>        List&lt;RouteDefinition&gt; definitionList = JSON.parseArray(configInfo, RouteDefinition.class);<br>        <span class="hljs-keyword">if</span> (!CollectionUtils.isEmpty(definitionList)) &#123;<br>            definitionList.forEach(definition -&gt; &#123;<br>                log.info(<span class="hljs-string">&quot;add route : &#123;&#125;&quot;</span>, definition.toString());<br>                dynamicRouteService.save(definition);<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>æ–¹æ³•å &#x2F; ç”Ÿå‘½å‘¨æœŸ</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>@PostConstruct init()</td>
<td>åˆå§‹åŒ–æ—¶è°ƒç”¨ï¼šç”¨äºåˆå§‹åŒ– ConfigService å¹¶æ³¨å†Œè·¯ç”±é…ç½®ç›‘å¬å™¨ï¼ˆåŠ¨æ€ç›‘å¬ Nacos é…ç½®å˜åŒ–ï¼‰ã€‚</td>
</tr>
<tr>
<td>dynamicRouteByNacosListener(String dataId, String group)</td>
<td>ç›‘å¬æŒ‡å®šçš„ Nacos è·¯ç”±é…ç½®ï¼Œå¦‚æœè·¯ç”±æœ‰å˜æ›´ï¼Œåˆ™è§¦å‘æ›´æ–°ã€‚</td>
</tr>
<tr>
<td>ConfigService initConfigService()</td>
<td>åˆå§‹åŒ– Nacos é…ç½®å®¢æˆ·ç«¯ï¼Œè®¾ç½®å¿…è¦è¿æ¥å‚æ•°ï¼Œå¦‚åœ°å€ã€è´¦å·ã€å¯†ç ç­‰ã€‚</td>
</tr>
<tr>
<td>run(Stringâ€¦ args)</td>
<td>å®ç° CommandLineRunner æ¥å£ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶æ‰§è¡Œï¼šæ‹‰å–ä¸€æ¬¡å½“å‰ Nacos ä¸­çš„è·¯ç”±é…ç½®å¹¶åŠ è½½åˆ°ç½‘å…³ä¸­ã€‚</td>
</tr>
</tbody></table>
<h4 id="DynamicRouteRefresh"><a href="#DynamicRouteRefresh" class="headerlink" title="DynamicRouteRefresh"></a>DynamicRouteRefresh</h4><p>å®ç° <strong>åŠ¨æ€ç½‘å…³è·¯ç”±åˆ·æ–°åŠŸèƒ½</strong>çš„æ ¸å¿ƒç±»</p>
<ul>
<li><strong>å®ç°å¯¹ç½‘å…³è·¯ç”±çš„ æ–°å¢ã€æ›´æ–°ã€åˆ é™¤ æ“ä½œ</strong>ï¼Œå¹¶é€šè¿‡äº‹ä»¶æœºåˆ¶ï¼ˆRefreshRoutesEventï¼‰åŠ¨æ€åˆ·æ–°è·¯ç”±ã€‚</li>
</ul>
<ol>
<li>ä½¿ç”¨ ApplicationEventPublisher æ¨é€äº‹ä»¶åˆ·æ–°ç½‘å…³è·¯ç”±ã€‚</li>
<li>æ“ä½œå†…å­˜ä¸­çš„ RouteDefinitionRepositoryï¼ˆè·¯ç”±å®šä¹‰ä»“åº“ï¼‰ã€‚</li>
<li>æä¾›ä¾›å¤–éƒ¨è°ƒç”¨çš„ API æ–¹æ³•æ¥åŠ¨æ€ç®¡ç†ç½‘å…³è·¯ç”±ã€‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 1ï¼‰å®ç°ä¸€ä¸ªSpringæä¾›çš„äº‹ä»¶æ¨é€æ¥å£ApplicationEventPublisherAware</span><br><span class="hljs-comment"> * 2ï¼‰æä¾›åŠ¨æ€è·¯ç”±çš„åŸºç¡€æ–¹æ³•ï¼Œå¯é€šè¿‡è·å–beanæ“ä½œè¯¥ç±»çš„æ–¹æ³•ã€‚è¯¥ç±»æä¾›æ–°å¢è·¯ç”±ã€æ›´æ–°è·¯ç”±ã€åˆ é™¤è·¯ç”±ï¼Œç„¶åå®ç°å‘å¸ƒçš„åŠŸèƒ½ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DynamicRouteRefresh</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationEventPublisherAware</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> InMemoryRouteDefinitionRepository memoryRouteDefinitionRepository;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationEventPublisher publisher;<br>    <br>    <span class="hljs-comment">// 	è®¾ç½®äº‹ä»¶å‘å¸ƒå™¨</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationEventPublisher</span><span class="hljs-params">(ApplicationEventPublisher applicationEventPublisher)</span> &#123;<br>        <span class="hljs-built_in">this</span>.publisher = applicationEventPublisher;<br>    &#125;<br><br>    <span class="hljs-comment">// åˆ é™¤æŒ‡å®š id çš„è·¯ç”±å®šä¹‰ï¼Œå¹¶å‘å¸ƒåˆ·æ–°äº‹ä»¶</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">delete</span><span class="hljs-params">(String id)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            log.info(<span class="hljs-string">&quot;gateway delete route id &#123;&#125;&quot;</span>, id);<br>            memoryRouteDefinitionRepository.delete(Mono.just(id)).doOnError(error -&gt; log.error(<span class="hljs-string">&quot;åˆ é™¤å¤±è´¥,id:&#123;&#125;&quot;</span>, id))<br>                    .doAfterTerminate(() -&gt; <span class="hljs-built_in">this</span>.publisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshRoutesEvent</span>(<span class="hljs-built_in">this</span>))).subscribe();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;delete success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;delete fail&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// æ‰¹é‡æ›´æ–°è·¯ç”±åˆ—è¡¨</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">updateList</span><span class="hljs-params">(List&lt;RouteDefinition&gt; definitions)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;gateway update route &#123;&#125;&quot;</span>, definitions);<br>        <span class="hljs-comment">// åˆ é™¤ç¼“å­˜routerDefinition</span><br>        memoryRouteDefinitionRepository.getRouteDefinitions()<br>                .filter(it -&gt; !it.getId().startsWith(<span class="hljs-string">&quot;ReactiveCompositeDiscoveryClient_&quot;</span>))<br>                .doOnNext(routeDefinition -&gt; &#123;<br>                    log.info(<span class="hljs-string">&quot;delete routeDefinition:&#123;&#125;&quot;</span>, routeDefinition);<br>                    delete(routeDefinition.getId());<br>                &#125;).doAfterTerminate(() -&gt; definitions.forEach(<span class="hljs-built_in">this</span>::save)).subscribe();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// ä¿å­˜ä¸€ä¸ªæ–°çš„è·¯ç”±å®šä¹‰</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">save</span><span class="hljs-params">(RouteDefinition definition)</span> &#123;<br>        log.info(<span class="hljs-string">&quot;gateway add route &#123;&#125;&quot;</span>, definition);<br>        <span class="hljs-keyword">try</span> &#123;<br>            memoryRouteDefinitionRepository.save(Mono.just(definition))<br>                    .doAfterTerminate(() -&gt; <span class="hljs-built_in">this</span>.publisher.publishEvent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshRoutesEvent</span>(<span class="hljs-built_in">this</span>))).subscribe();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;success&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;update route fail&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>ä½œç”¨</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>setApplicationEventPublisher(â€¦)</td>
<td>è®¾ç½®äº‹ä»¶å‘å¸ƒå™¨</td>
<td>å®ç° ApplicationEventPublisherAware æ¥å£åï¼ŒSpring å®¹å™¨å¯åŠ¨æ—¶ä¼šæ³¨å…¥ publisherã€‚</td>
</tr>
<tr>
<td>delete()</td>
<td>åˆ é™¤æŒ‡å®š id çš„è·¯ç”±å®šä¹‰ï¼Œå¹¶å‘å¸ƒåˆ·æ–°äº‹ä»¶</td>
<td>åˆ é™¤è·¯ç”±åç«‹å³è§¦å‘ RefreshRoutesEventï¼Œä½¿ç½‘å…³è·¯ç”±ç«‹å³æ›´æ–°ã€‚</td>
</tr>
<tr>
<td>updateList()</td>
<td>æ‰¹é‡æ›´æ–°è·¯ç”±åˆ—è¡¨</td>
<td>ä¼šå…ˆåˆ é™¤æ—§è·¯ç”±ï¼ˆéæ³¨å†Œä¸­å¿ƒè‡ªåŠ¨ç”Ÿæˆçš„ï¼‰ï¼Œå†é€ä¸ªæ–°å¢ï¼Œå¹¶å‘å¸ƒåˆ·æ–°äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>save()</td>
<td>ä¿å­˜ä¸€ä¸ªæ–°çš„è·¯ç”±å®šä¹‰</td>
<td>æ·»åŠ åˆ°å†…å­˜ä¸­å¹¶è§¦å‘åˆ·æ–°äº‹ä»¶ï¼Œä½¿å…¶ç«‹å³ç”Ÿæ•ˆã€‚</td>
</tr>
</tbody></table>
<h2 id="10-5-GatewayBootApplication"><a href="#10-5-GatewayBootApplication" class="headerlink" title="10.5 GatewayBootApplication"></a>10.5 GatewayBootApplication</h2><p>è¿™æ˜¯æ•´ä¸ªç½‘å…³æœåŠ¡çš„å…¥å£ç±»ï¼Œå¯åŠ¨æ—¶ä¼šåˆå§‹åŒ– Spring Boot åº”ç”¨ç¯å¢ƒï¼Œå¹¶å¼€å¯ Feign å®¢æˆ·ç«¯æ”¯æŒï¼Œæ³¨å†Œå¾®æœåŠ¡é—´è¿œç¨‹è°ƒç”¨èƒ½åŠ›ã€‚</p>
<h1 id="11-goodskill-auth-authç™»å½•ä»¥åŠæˆæƒæ¨¡å—"><a href="#11-goodskill-auth-authç™»å½•ä»¥åŠæˆæƒæ¨¡å—" class="headerlink" title="11. goodskill-auth (authç™»å½•ä»¥åŠæˆæƒæ¨¡å—)"></a>11. goodskill-auth (authç™»å½•ä»¥åŠæˆæƒæ¨¡å—)</h1><p><img src="/img/blogs/java/goodskill/11.0.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>auth-service</code><ul>
<li>åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡</li>
</ul>
</li>
<li><code>oauth2-auth-client</code><ul>
<li>oauth2.0ç™»å½•å®¢æˆ·ç«¯</li>
</ul>
</li>
<li><code>oauth2-auth-server</code><ul>
<li>oauth2.0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡</li>
</ul>
</li>
<li><code>oauth2-resource-server</code><ul>
<li>oauth2.0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡</li>
</ul>
</li>
</ul>
<h2 id="11-1-auth-service-åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡"><a href="#11-1-auth-service-åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡" class="headerlink" title="11.1 auth-service (åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡)"></a>11.1 auth-service (åŸºäºSa-Tokenæ¡†æ¶çš„ç”¨æˆ·ç™»å½•æˆæƒæœåŠ¡)</h2><p><img src="/img/blogs/java/goodskill/11.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="11-1-1-configåŒ…"><a href="#11-1-1-configåŒ…" class="headerlink" title="11.1.1 configåŒ…"></a>11.1.1 configåŒ…</h3><ul>
<li><code>EncryptConfig</code>: åŠ å¯†é…ç½®</li>
<li>StpInterfaceImpl</li>
</ul>
<h4 id="StpInterfaceImpl-1"><a href="#StpInterfaceImpl-1" class="headerlink" title="StpInterfaceImpl"></a>StpInterfaceImpl</h4><p>æ˜¯ä¸€ä¸ª Sa-Token æ¡†æ¶çš„<strong>è‡ªå®šä¹‰æƒé™åŠ è½½å®ç°ç±»</strong>ï¼Œç”¨äºåœ¨<strong>ç”¨æˆ·ç™»å½•åï¼ŒåŠ¨æ€åŠ è½½å…¶æ‹¥æœ‰çš„ è§’è‰² å’Œ æƒé™ç </strong>ã€‚</p>
<ul>
<li>å®ƒå®ç°äº† StpInterface æ¥å£ï¼Œæ˜¯ æƒé™æ§åˆ¶æ ¸å¿ƒçš„ä¸€éƒ¨åˆ†ã€‚</li>
<li>â€œå½“ä½ éœ€è¦åˆ¤æ–­æŸä¸ªç”¨æˆ·çš„è§’è‰²æˆ–æƒé™æ—¶ï¼Œæˆ‘æ¥å‘Šè¯‰ä½ ä»–æœ‰å“ªäº›ã€‚â€</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * sa-tokenè‡ªå®šä¹‰æƒé™åŠ è½½æ¥å£å®ç°ç±»</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StpInterfaceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StpInterface</span> &#123;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> UserRoleService userRoleService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RolePermissionService rolePermissionService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RoleService roleService;<br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> PermissionService permissionService;<br> <br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„æƒé™ç é›†åˆ</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getPermissionList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-comment">// 1. å£°æ˜æƒé™ç é›†åˆ</span><br>        List&lt;String&gt; permissionList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// 2. éå†è§’è‰²åˆ—è¡¨ï¼ŒæŸ¥è¯¢æ‹¥æœ‰çš„æƒé™ç </span><br>        <span class="hljs-keyword">for</span> (String roleCode : getRoleList(loginId, loginType)) &#123;<br>            <span class="hljs-type">SaSession</span> <span class="hljs-variable">roleSession</span> <span class="hljs-operator">=</span> SaSessionCustomUtil.getSessionById(<span class="hljs-string">&quot;role-&quot;</span> + roleCode);<br>            List&lt;String&gt; list = roleSession.get(<span class="hljs-string">&quot;Permission_List&quot;</span>, () -&gt; &#123;<br>                List&lt;Integer&gt; roleIdList = roleService.list(Wrappers.&lt;Role&gt;lambdaQuery().eq(Role::getRoleCode, roleCode))<br>                        .stream().map(Role::getRoleId).collect(Collectors.toList());<br>                List&lt;Integer&gt; permissionIdList = rolePermissionService.list(Wrappers.&lt;RolePermission&gt;lambdaQuery().in(RolePermission::getRoleId, roleIdList))<br>                        .stream().map(RolePermission::getPermissionId).distinct().collect(Collectors.toList());<br>                List&lt;Permission&gt; permissions = permissionService.list(Wrappers.&lt;Permission&gt;lambdaQuery().in(Permission::getPermissionId, permissionIdList));<br>                <span class="hljs-keyword">return</span> permissions.stream().map(Permission::getPermissionCode).collect(Collectors.toList());<br>            &#125;);<br>            permissionList.addAll(list);<br>        &#125;<br>        <span class="hljs-comment">// 3. è¿”å›æƒé™ç é›†åˆ</span><br>        <span class="hljs-keyword">return</span> permissionList;<br>    &#125;<br> <br>    <span class="hljs-comment">// è¿”å›ä¸€ä¸ªè´¦å·æ‰€æ‹¥æœ‰çš„è§’è‰²æ ‡è¯†é›†åˆ (æƒé™ä¸è§’è‰²å¯åˆ†å¼€æ ¡éªŒ)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">getRoleList</span><span class="hljs-params">(Object loginId, String loginType)</span> &#123;<br>        <span class="hljs-type">SaSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> StpUtil.getSessionByLoginId(loginId);<br>        <span class="hljs-keyword">return</span> session.get(<span class="hljs-string">&quot;Role_List&quot;</span>, () -&gt; &#123;<br>            <span class="hljs-comment">// ä»æ•°æ®åº“æŸ¥è¯¢è¿™ä¸ªè´¦å·idæ‹¥æœ‰çš„è§’è‰²åˆ—è¡¨</span><br>            List&lt;UserRole&gt; userRoleList = userRoleService.list(Wrappers.&lt;UserRole&gt;lambdaQuery().eq(UserRole::getUserId, loginId));<br>            List&lt;Integer&gt; roleIds = userRoleList.stream().map(UserRole::getRoleId).collect(Collectors.toList());<br>            <span class="hljs-keyword">return</span> roleService.list(Wrappers.&lt;Role&gt;lambdaQuery().in(Role::getRoleId, roleIds)).stream().map(Role::getRoleCode)<br>                    .collect(Collectors.toList());<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>è·å–æŒ‡å®šç”¨æˆ·çš„æƒé™ç é›†åˆï¼ˆæƒé™å­—ç¬¦ä¸²åˆ—è¡¨ï¼‰ã€‚</li>
<li>è·å–æŒ‡å®šç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ä»£ç é›†åˆ</li>
</ul>
<h3 id="11-1-2-controller"><a href="#11-1-2-controller" class="headerlink" title="11.1.2 controller"></a>11.1.2 controller</h3><ul>
<li>LoginController</li>
<li>UserController</li>
</ul>
<h4 id="LoginController"><a href="#LoginController" class="headerlink" title="LoginController"></a>LoginController</h4><p>ç”¨äº<strong>å¤„ç†ç™»å½•ç›¸å…³æ“ä½œçš„æ§åˆ¶å™¨ç±»</strong>ï¼Œä¸»è¦ç”¨äº<strong>æä¾›æ¥å£æ¥æµ‹è¯•ç™»å½•çŠ¶æ€ã€æ‰§è¡Œç™»å½•ã€é€€å‡ºç™»å½•ã€æ³¨å†Œç­‰åŠŸèƒ½</strong>ã€‚</p>
<table>
<thead>
<tr>
<th>æ¥å£è·¯å¾„</th>
<th>æ–¹æ³•</th>
<th>åŠŸèƒ½ç®€ä»‹</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;isLogin</td>
<td>GET</td>
<td>æ£€æŸ¥æ˜¯å¦å·²ç™»å½•</td>
</tr>
<tr>
<td>&#x2F;tokenInfo</td>
<td>GET</td>
<td>è·å–å½“å‰ç™»å½• token ä¿¡æ¯</td>
</tr>
<tr>
<td>&#x2F;logout</td>
<td>POST</td>
<td>ç”¨æˆ·ç™»å‡º</td>
</tr>
<tr>
<td>&#x2F;register</td>
<td>POST</td>
<td>ç”¨æˆ·æ³¨å†Œ</td>
</tr>
<tr>
<td>&#x2F;login</td>
<td>POST</td>
<td>ç”¨æˆ·ç™»å½•å¹¶è¿”å› token</td>
</tr>
</tbody></table>
<h4 id="UserController"><a href="#UserController" class="headerlink" title="UserController"></a>UserController</h4><p>ç”¨äº<strong>ç”¨æˆ·ç®¡ç†çš„æ§åˆ¶å™¨ç±»</strong>ï¼Œæä¾›äº†å’Œç”¨æˆ·è§’è‰²ã€æƒé™ç›¸å…³çš„æ¥å£ï¼Œæ ¸å¿ƒå›´ç»• <strong>è§’è‰²åˆ†é…ã€ç”¨æˆ·ä¿¡æ¯è·å–ã€æƒé™&#x2F;è§’è‰²æŸ¥è¯¢</strong> å±•å¼€</p>
<ul>
<li>æä¾›å¯¹ç”¨æˆ·ä¿¡æ¯ã€è§’è‰²å’Œæƒé™çš„ç®¡ç†èƒ½åŠ›ï¼Œä¾èµ– UserService å’Œ StpInterface å®ç°ç”¨æˆ·ä¿¡æ¯çš„æŸ¥è¯¢å’Œæƒé™ä½“ç³»çš„æ¥å…¥ã€‚</li>
</ul>
<h3 id="11-1-3-entity"><a href="#11-1-3-entity" class="headerlink" title="11.1.3 entity"></a>11.1.3 entity</h3><table>
<thead>
<tr>
<th>å®ä½“ç±»å</th>
<th>ä½œç”¨è¯´æ˜</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>Permission</code></td>
<td>æƒé™è¡¨å®ä½“ç±»ï¼Œè¡¨ç¤ºç³»ç»Ÿä¸­çš„å…·ä½“æƒé™é¡¹</td>
<td>ç”¨äºæ§åˆ¶æŒ‰é’®&#x2F;èœå•æƒé™ç­‰ï¼Œé…åˆè§’è‰²ä½¿ç”¨</td>
</tr>
<tr>
<td><code>Role</code></td>
<td>è§’è‰²è¡¨å®ä½“ç±»ï¼Œå®šä¹‰ç³»ç»Ÿä¸­ä¸åŒçš„è§’è‰²</td>
<td>å’Œæƒé™ã€ç”¨æˆ·å…³è”ï¼Œç”¨äºæˆæƒç®¡ç†</td>
</tr>
<tr>
<td><code>RolePermission</code></td>
<td>è§’è‰²ä¸æƒé™çš„ä¸­é—´è¡¨å®ä½“ç±»ï¼Œç”¨äºç»´æŠ¤è§’è‰²æ‹¥æœ‰çš„æƒé™</td>
<td>å¤šå¯¹å¤šå…³è”è¡¨</td>
</tr>
<tr>
<td><code>User</code></td>
<td>ç”¨æˆ·è¡¨å®ä½“ç±»ï¼Œä¿å­˜ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</td>
<td>æ ¸å¿ƒç”¨æˆ·å®ä½“ç±»</td>
</tr>
<tr>
<td><code>UserAuthAccount</code></td>
<td>ç”¨æˆ·ç¬¬ä¸‰æ–¹æˆæƒè´¦å·è¡¨ï¼Œä¿å­˜ç»‘å®šçš„ç¬¬ä¸‰æ–¹ç™»å½•ä¿¡æ¯</td>
<td>ç”¨äºå®ç°å¾®ä¿¡ã€QQç­‰ç¬¬ä¸‰æ–¹ç™»å½•</td>
</tr>
<tr>
<td><code>UserRole</code></td>
<td>ç”¨æˆ·ä¸è§’è‰²çš„ä¸­é—´è¡¨å®ä½“ç±»ï¼Œç”¨äºç»´æŠ¤ç”¨æˆ·æ‹¥æœ‰çš„è§’è‰²</td>
<td>å¤šå¯¹å¤šå…³è”è¡¨</td>
</tr>
</tbody></table>
<h3 id="11-1-4-pojo"><a href="#11-1-4-pojo" class="headerlink" title="11.1.4 pojo"></a>11.1.4 pojo</h3><ul>
<li><code>UserDTO</code>: ç”¨æˆ·DTO</li>
<li><code>UserInfoVO</code>: ç”¨æˆ·ä¿¡æ¯è§†å›¾å¯¹è±¡</li>
</ul>
<h3 id="11-1-5-mapper"><a href="#11-1-5-mapper" class="headerlink" title="11.1.5 mapper"></a>11.1.5 mapper</h3><p>è¿™äº›mapperéƒ½ç»§æ‰¿äº†mybatis-plusä¸­çš„BaseMapperæ¥å£ï¼Œå®ç°äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥</p>
<ul>
<li><code>PermissionMapper</code>: æƒé™è¡¨mapperæ¥å£</li>
<li><code>RoleMapper</code>ï¼š è§’è‰²è¡¨mapperæ¥å£</li>
<li><code>RolePermissionMapper</code>: è§’è‰²æƒé™è¡¨mapperæ¥å£</li>
<li><code>UserAuthAccountMapper</code>: ç”¨æˆ·æˆæƒè´¦å·è¡¨ Mapper æ¥å£</li>
<li><code>UserMapper</code>: ç”¨æˆ·è¡¨mapperæ¥å£</li>
<li><code>UserRoleMapper</code>: ç”¨æˆ·è§’è‰²è¡¨mapperæ¥å£</li>
</ul>
<h3 id="11-1-6-serviceæ¥å£å’Œå®ç°ç±»"><a href="#11-1-6-serviceæ¥å£å’Œå®ç°ç±»" class="headerlink" title="11.1.6 serviceæ¥å£å’Œå®ç°ç±»"></a>11.1.6 serviceæ¥å£å’Œå®ç°ç±»</h3><h4 id="serviceæ¥å£"><a href="#serviceæ¥å£" class="headerlink" title="serviceæ¥å£"></a>serviceæ¥å£</h4><p>è¿™äº›serviceæ¥å£ç»§æ‰¿äº†mybatis-plusä¸­çš„IServiceæ¥å£ï¼Œå®ç°äº†åŸºæœ¬çš„å¢åˆ æ”¹æŸ¥</p>
<ul>
<li><code>PermissionService</code></li>
<li><code>RolePermissionService</code></li>
<li><code>RoleService</code></li>
<li><code>UserAccountService</code></li>
<li><code>UserAuthAccountService</code>: ç”¨æˆ·æˆæƒè´¦å·è¡¨æœåŠ¡ç±»</li>
<li><code>UserRoleService</code></li>
<li><code>UserService</code></li>
</ul>
<h4 id="ServiceImplæœåŠ¡å®ç°ç±»"><a href="#ServiceImplæœåŠ¡å®ç°ç±»" class="headerlink" title="ServiceImplæœåŠ¡å®ç°ç±»"></a>ServiceImplæœåŠ¡å®ç°ç±»</h4><p>è¿™äº›å®ç°ç±»åŒæ ·ç»§æ‰¿äº†mybatis-plusä¸­çš„ServiceImpl</p>
<ul>
<li><code>PermissionServiceImpl</code></li>
<li><code>RolePermissionServiceImpl</code></li>
<li><code>RoleServiceImpl</code></li>
<li><code>UserAccountServiceImpl</code></li>
<li><code>UserRoleServiceImpl</code></li>
</ul>
<h4 id="UserAuthAccountServiceImpl"><a href="#UserAuthAccountServiceImpl" class="headerlink" title="UserAuthAccountServiceImpl"></a>UserAuthAccountServiceImpl</h4><p>æ˜¯ä¸€ä¸ª <strong>ç”¨æˆ·ç¬¬ä¸‰æ–¹æˆæƒè´¦å·æœåŠ¡</strong>çš„å®ç°ç±»<br>è¯¥ç±»çš„ä¸»è¦èŒè´£æ˜¯å¤„ç†ç”¨æˆ·ä¸ç¬¬ä¸‰æ–¹è´¦å·ï¼ˆå¦‚å¾®ä¿¡ã€QQã€GitHubç­‰ï¼‰çš„å…³è”é€»è¾‘ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ ¹æ®ç¬¬ä¸‰æ–¹è´¦å·æŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ã€‚</li>
<li>åˆ¤æ–­æŸä¸ªç¬¬ä¸‰æ–¹è´¦å·æ˜¯å¦å·²ç»ç»‘å®šè¿‡ç³»ç»Ÿç”¨æˆ·ã€‚</li>
</ul>
<h4 id="UserServiceImpl"><a href="#UserServiceImpl" class="headerlink" title="UserServiceImpl"></a>UserServiceImpl</h4><p><strong>ç”¨æˆ·ç®¡ç†çš„æ ¸å¿ƒæœåŠ¡ç±»</strong>ï¼Œä¸»è¦è´Ÿè´£å¤„ç†<strong>ç”¨æˆ·çš„æ³¨å†Œã€æŸ¥è¯¢ã€æƒé™è§’è‰²ç®¡ç†ã€ç™»å½•çŠ¶æ€æ›´æ–°ç­‰é€»è¾‘ã€‚</strong><br>å®ƒç»§æ‰¿äº† <code>ServiceImpl&lt;UserMapper, User&gt;</code>ï¼Œå®ç°äº† UserService æ¥å£ï¼Œå€ŸåŠ© MyBatis-Plus çš„é€šç”¨ Service åŠŸèƒ½ï¼Œå¹¶é›†æˆäº†ç”¨æˆ·ã€è§’è‰²ã€æƒé™ç­‰å¤šä¸ªæ¨¡å—çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<table>
<thead>
<tr>
<th>æ–¹æ³•å</th>
<th>æ–¹æ³•ä½œç”¨æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td><code>register</code></td>
<td>ç”¨æˆ·æ³¨å†Œï¼Œä¿å­˜åŠ å¯†å¯†ç å’Œç”¨æˆ·ååˆ°æ•°æ®åº“</td>
</tr>
<tr>
<td><code>findRoles</code></td>
<td>æ ¹æ®è´¦å·æŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²</td>
</tr>
<tr>
<td><code>findPermissions</code></td>
<td>æ ¹æ®è´¦å·æŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰æƒé™ï¼ˆé€šè¿‡è§’è‰²æƒé™ä¸­é—´è¡¨ï¼‰</td>
</tr>
<tr>
<td><code>findByUserAccount</code></td>
<td>æ ¹æ®è´¦å·æŸ¥æ‰¾å¯¹åº”çš„ç”¨æˆ·å®ä½“</td>
</tr>
<tr>
<td><code>getUserInfoById</code></td>
<td>æ ¹æ®ç”¨æˆ· ID æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶éšè—å¯†ç </td>
</tr>
<tr>
<td><code>page</code></td>
<td>è·å–ç”¨æˆ·åˆ†é¡µä¿¡æ¯ï¼ˆä½¿ç”¨ MyBatis-Plus æä¾›çš„åˆ†é¡µï¼‰</td>
</tr>
<tr>
<td><code>removeById</code></td>
<td>æ ¹æ®ç”¨æˆ· ID åˆ é™¤ç”¨æˆ·</td>
</tr>
<tr>
<td><code>updateLastLoginTime</code></td>
<td>æ›´æ–°ç”¨æˆ·æœ€è¿‘ä¸€æ¬¡ç™»å½•æ—¶é—´</td>
</tr>
<tr>
<td><code>checkPassword</code></td>
<td>æ ¡éªŒè¾“å…¥å¯†ç æ˜¯å¦ä¸åŠ å¯†å¯†ç åŒ¹é…</td>
</tr>
<tr>
<td><code>addRole</code></td>
<td>ä¸ºæŒ‡å®šç”¨æˆ·æ·»åŠ ä¸€ä¸ªè§’è‰²ï¼ˆæ ¡éªŒè§’è‰²æ˜¯å¦å­˜åœ¨ï¼‰</td>
</tr>
</tbody></table>
<h3 id="11-1-7-AuthApplication"><a href="#11-1-7-AuthApplication" class="headerlink" title="11.1.7 AuthApplication"></a>11.1.7 AuthApplication</h3><p>æ˜¯ <strong>è®¤è¯æœåŠ¡çš„å¯åŠ¨ç±»</strong>, ä½œç”¨æ˜¯<strong>å¯åŠ¨æ•´ä¸ªè®¤è¯æ¨¡å—ï¼ˆauth æ¨¡å—ï¼‰çš„åº”ç”¨</strong></p>
<h2 id="11-2-oauth2-auth-client-oauth2-0ç™»å½•å®¢æˆ·ç«¯"><a href="#11-2-oauth2-auth-client-oauth2-0ç™»å½•å®¢æˆ·ç«¯" class="headerlink" title="11.2 oauth2-auth-client (oauth2.0ç™»å½•å®¢æˆ·ç«¯)"></a>11.2 oauth2-auth-client (oauth2.0ç™»å½•å®¢æˆ·ç«¯)</h2><p><img src="/img/blogs/java/goodskill/11.2.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>OAuth2LoginController</code> æ˜¯ä¸€ä¸ªç”¨äº <strong>å±•ç¤º OAuth2 ç™»å½•æˆåŠŸåç”¨æˆ·ä¿¡æ¯çš„æ§åˆ¶å™¨</strong>ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¤„ç†ç”¨æˆ·ç™»å½•æˆåŠŸåçš„é¡µé¢è¯·æ±‚ï¼Œå¹¶å°†ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯å±•ç¤ºåœ¨é¡µé¢ä¸Š</li>
<li><code>OAuth2AuthClientApplication</code>: OAuth2.0æˆæƒå®¢æˆ·ç«¯æœåŠ¡çš„å¯åŠ¨ç±»</li>
</ul>
<h2 id="11-3-oauth2-auth-service-oauth2-0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡"><a href="#11-3-oauth2-auth-service-oauth2-0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡" class="headerlink" title="11.3 oauth2-auth-service (oauth2.0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡)"></a>11.3 oauth2-auth-service (oauth2.0ç™»å½•æˆæƒæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡)</h2><p><img src="/img/blogs/java/goodskill/11.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="SecurityConfig"><a href="#SecurityConfig" class="headerlink" title="SecurityConfig"></a>SecurityConfig</h4><p>SecurityConfig ç±»æ˜¯ä¸€ä¸ª Spring Security é…ç½®ç±»ï¼Œç”¨äº<strong>é…ç½® OAuth2 è®¤è¯ä¸æˆæƒæœåŠ¡å™¨çš„å®‰å…¨ç­–ç•¥</strong>ï¼Œä»¥åŠ<strong>å¤„ç† èµ„æºæœåŠ¡å™¨ å’Œ é»˜è®¤çš„ç”¨æˆ·è®¤è¯</strong>ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œå®ƒè´Ÿè´£ï¼š</p>
<ol>
<li>é…ç½® æˆæƒæœåŠ¡å™¨çš„å®‰å…¨ç­–ç•¥ã€‚</li>
<li>é…ç½® èµ„æºæœåŠ¡å™¨ï¼ˆJWT éªŒè¯ï¼‰ã€‚</li>
<li>é…ç½® ç”¨æˆ·è®¤è¯ä¸ç™»å½•ã€‚</li>
<li>è®¾ç½® å®¢æˆ·ç«¯å’Œ å…¬é’¥ç§é’¥å¯¹ã€‚</li>
</ol>
<h4 id="SimpleController"><a href="#SimpleController" class="headerlink" title="SimpleController"></a>SimpleController</h4><p>æ˜¯ä¸€ä¸ª Spring Boot æ§åˆ¶å™¨ï¼Œç”¨äºå¤„ç†ä¸€ä¸ªç®€å•çš„ GET è¯·æ±‚ã€‚å…¶ä¸»è¦åŠŸèƒ½æ˜¯<strong>é€šè¿‡ Spring Security çš„ @AuthenticationPrincipal æ³¨è§£è·å–å½“å‰è®¤è¯ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå¹¶è¿”å›è¯¥ç”¨æˆ·çš„åç§°</strong>ã€‚</p>
<h4 id="UserInfoController"><a href="#UserInfoController" class="headerlink" title="UserInfoController"></a>UserInfoController</h4><p>æ˜¯ä¸€ä¸ª Spring Boot REST æ§åˆ¶å™¨ï¼Œå®ƒå®šä¹‰äº†ä¸¤ä¸ªç«¯ç‚¹ï¼š&#x2F;user å’Œ &#x2F;whoamiï¼Œå¹¶æä¾›äº†ä¸€äº›ç”¨æˆ·ä¿¡æ¯çš„åŠŸèƒ½</p>
<h4 id="OAuth2AuthorizationServerApplication"><a href="#OAuth2AuthorizationServerApplication" class="headerlink" title="OAuth2AuthorizationServerApplication"></a>OAuth2AuthorizationServerApplication</h4><p>ä½œç”¨æ˜¯å¯åŠ¨ä¸€ä¸ª OAuth2 æˆæƒæœåŠ¡å™¨</p>
<h2 id="11-4-oauth2-resource-server-oauth2-0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡"><a href="#11-4-oauth2-resource-server-oauth2-0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡" class="headerlink" title="11.4 oauth2-resource-server (oauth2.0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡)"></a>11.4 oauth2-resource-server (oauth2.0èµ„æºæœåŠ¡ç«¯ï¼Œè‡ªå®šä¹‰çš„ç™»å½•æˆæƒæœåŠ¡)</h2><p><img src="/img/blogs/java/goodskill/11.4.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><code>UserInfoController</code>: æä¾›å…³äºç”¨æˆ·çš„ä¸¤ç±»ä¿¡æ¯ï¼šä¸€æ˜¯æ¨¡æ‹Ÿçš„ç”¨æˆ·æ•°æ®ï¼ŒäºŒæ˜¯å½“å‰å·²è®¤è¯ç”¨æˆ·çš„æ•°æ®ã€‚<ul>
<li>&#x2F;user æ¥å£æä¾›æ¨¡æ‹Ÿçš„ç”¨æˆ·æ•°æ®ï¼Œè¿”å›ä¸€ä¸ªé™æ€çš„ JSON å“åº”ã€‚</li>
<li>&#x2F;whoami æ¥å£ç”¨äºè·å–å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿”å›è®¤è¯ç”¨æˆ·çš„ç›¸å…³ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li><code>OAuth2ResourceServerApplication</code>: OAuth2.0èµ„æºæœåŠ¡å™¨å¯åŠ¨ç±»</li>
</ul>
<h1 id="12-goodskill-ai-AIæœºå™¨äººèŠå¤©æœåŠ¡"><a href="#12-goodskill-ai-AIæœºå™¨äººèŠå¤©æœåŠ¡" class="headerlink" title="12. goodskill-ai (AIæœºå™¨äººèŠå¤©æœåŠ¡)"></a>12. goodskill-ai (AIæœºå™¨äººèŠå¤©æœåŠ¡)</h1><p><img src="/img/blogs/java/goodskill/12.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="12-1-controller"><a href="#12-1-controller" class="headerlink" title="12.1 controller"></a>12.1 controller</h2><ul>
<li>AssistantController</li>
<li>ChatRequest</li>
</ul>
<h4 id="AssistantController"><a href="#AssistantController" class="headerlink" title="AssistantController"></a>AssistantController</h4><p>ä¸»è¦<strong>ç”¨äºå¤„ç†ä¸ç”¨æˆ·çš„å¯¹è¯ï¼ˆèŠå¤©ï¼‰è¯·æ±‚</strong>ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªåŸºäº Web çš„èŠå¤©æ¥å£ï¼Œå…è®¸ç”¨æˆ·ä¸ä¸€ä¸ªåŠ©æ‰‹è¿›è¡Œäº’åŠ¨ã€‚ç±»ä¸­å®šä¹‰çš„è¯·æ±‚æ¥å£ä¼šé€šè¿‡ UserSupportAssistant æ¥å¤„ç†ç”¨æˆ·çš„è¾“å…¥å¹¶è¿”å›èŠå¤©ä¿¡æ¯ã€‚</p>
<ul>
<li>ä½œä¸ºä¸€ä¸ªå®æ—¶çš„ç”¨æˆ·åŠ©æ‰‹èŠå¤©æ¥å£ï¼Œå¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶å®æ—¶æ¨é€èŠå¤©å›å¤ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(&quot;/api/assistant&quot;)</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssistantController</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserSupportAssistant agent;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">AssistantController</span><span class="hljs-params">(UserSupportAssistant agent)</span> &#123;<br>		<span class="hljs-built_in">this</span>.agent = agent;<br>	&#125;<br><br>	<span class="hljs-meta">@RequestMapping(path=&quot;/chat&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>	<span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String chatId, <span class="hljs-meta">@RequestParam</span> String userMessage)</span> &#123;<br>		<span class="hljs-keyword">return</span> agent.chat(chatId, userMessage);<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¥å£åŠŸèƒ½ï¼š&#x2F;api&#x2F;assistant&#x2F;chat æä¾›äº†ä¸€ä¸ªä¸ç”¨æˆ·èŠå¤©çš„æ¥å£ã€‚ç”¨æˆ·é€šè¿‡ä¼ é€’ chatId å’Œ userMessage è¿›è¡Œäº¤äº’ï¼ŒåŠ©æ‰‹ä¼šå®æ—¶è¿”å›èŠå¤©æ¶ˆæ¯ã€‚</li>
<li>æµå¼å“åº”ï¼šé€šè¿‡ <code>Flux&lt;String&gt;</code> å’Œ SSEï¼Œå®ç°äº†ä¸€ä¸ªå®æ—¶å¯¹è¯çš„æœºåˆ¶ã€‚å®¢æˆ·ç«¯å¯ä»¥é€æ­¥æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ï¼Œè€Œä¸éœ€è¦å¤šæ¬¡è¯·æ±‚ã€‚</li>
</ul>
<h4 id="ChatRequest"><a href="#ChatRequest" class="headerlink" title="ChatRequest"></a>ChatRequest</h4><p>ChatRequest ç±»çš„ä½œç”¨æ˜¯<strong>è¡¨ç¤ºä¸€ä¸ªèŠå¤©è¯·æ±‚</strong>ï¼Œé€šå¸¸ç”¨äºå‘èŠå¤©æ¨¡å‹ï¼ˆå¦‚ OpenAI çš„ GPT æ¨¡å‹ï¼‰å‘é€ç”¨æˆ·æ¶ˆæ¯ï¼Œå¹¶è¯·æ±‚æ¨¡å‹ç”Ÿæˆç›¸åº”çš„å›å¤ã€‚è¿™ä¸ªç±»åŒ…å«äº†è¯·æ±‚æ¨¡å‹æ‰€éœ€çš„å…³é”®ä¿¡æ¯ï¼Œæ¯”å¦‚æ¨¡å‹çš„é€‰æ‹©ã€æ¶ˆæ¯çš„å†…å®¹ã€æ˜¯å¦å¯ç”¨æµå¼å“åº”ç­‰ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatRequest</span> &#123;<br>    <span class="hljs-keyword">private</span> String model;<br>    <span class="hljs-keyword">private</span> List&lt;Message&gt; messages;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> stream;<br><br>    <span class="hljs-comment">// Getters and Setters</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getModel</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> model;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setModel</span><span class="hljs-params">(String model)</span> &#123;<br>        <span class="hljs-built_in">this</span>.model = model;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title function_">getMessages</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> messages;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMessages</span><span class="hljs-params">(List&lt;Message&gt; messages)</span> &#123;<br>        <span class="hljs-built_in">this</span>.messages = messages;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStream</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> stream;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setStream</span><span class="hljs-params">(<span class="hljs-type">boolean</span> stream)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stream = stream;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> &#123;<br>        <span class="hljs-keyword">private</span> String role;<br>        <span class="hljs-keyword">private</span> String content;<br><br>        <span class="hljs-comment">// Getters and Setters</span><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRole</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> role;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setRole</span><span class="hljs-params">(String role)</span> &#123;<br>            <span class="hljs-built_in">this</span>.role = role;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">return</span> content;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> &#123;<br>            <span class="hljs-built_in">this</span>.content = content;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ul>
<li><strong>è¯·æ±‚æ¨¡å‹ç”ŸæˆèŠå¤©å†…å®¹</strong>ï¼šChatRequest ç±»è¡¨ç¤ºå‘èŠå¤©æ¨¡å‹å‘é€çš„è¯·æ±‚ï¼ŒåŒ…æ‹¬æ¨¡å‹ç±»å‹ã€æ¶ˆæ¯åˆ—è¡¨å’Œæµå¼å“åº”çš„è®¾ç½®ã€‚</li>
<li><strong>æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡</strong>ï¼šé€šè¿‡ messages åˆ—è¡¨ï¼Œå¯ä»¥ä¼ é€’å¤šè½®å¯¹è¯çš„ä¸Šä¸‹æ–‡ï¼Œç¡®ä¿æ¨¡å‹æ ¹æ®å†å²å¯¹è¯ç”Ÿæˆåˆé€‚çš„å›åº”ã€‚</li>
<li><strong>æµå¼èŠå¤©</strong>ï¼šé€šè¿‡ stream è®¾ç½®ï¼Œå¯ä»¥å®ç°å®æ—¶çš„å¯¹è¯æµå¼è¿”å›ï¼Œä½¿å¾—æ¶ˆæ¯èƒ½å¤Ÿé€æ­¥æ¨é€ç»™å®¢æˆ·ç«¯ï¼Œæ”¯æŒæ›´æµç•…çš„èŠå¤©ä½“éªŒã€‚</li>
</ul>
<h2 id="12-2-service"><a href="#12-2-service" class="headerlink" title="12.2 service"></a>12.2 service</h2><ul>
<li>SeckillMockFeignClient</li>
<li>LoggingAdvisor</li>
<li>SeckillTools</li>
<li>UserSupportAssistant</li>
</ul>
<h4 id="SeckillMockFeignClient"><a href="#SeckillMockFeignClient" class="headerlink" title="SeckillMockFeignClient"></a>SeckillMockFeignClient</h4><p>æ˜¯ä¸€ä¸ª Feignå®¢æˆ·ç«¯æ¥å£ï¼Œç”¨äºæ¨¡æ‹Ÿç§’æ€åœºæ™¯å¹¶ä¸ goodskill-web æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚</p>
<ul>
<li>è¯¥ç±»åŒ…å«å¤šä¸ªæ¨¡æ‹Ÿç§’æ€åœºæ™¯çš„æ¥å£ï¼Œæ¯ä¸ªæ–¹æ³•å¯¹åº”ä¸€ä¸ªç‰¹å®šçš„ç§’æ€å®ç°æ–¹æ¡ˆï¼Œå¦‚åŒæ­¥é”ã€åˆ†å¸ƒå¼é”ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ•°æ®åº“æ“ä½œç­‰ã€‚è¿™äº›æ¥å£ä¸»è¦ç”¨äºæ¨¡æ‹Ÿä¸åŒæŠ€æœ¯æ ˆä¸‹çš„ç§’æ€åœºæ™¯ï¼Œå¹¶è¿”å›ç›¸åº”çš„ç§’æ€æ“ä½œç»“æœã€‚</li>
</ul>
<h4 id="LoggingAdvisor"><a href="#LoggingAdvisor" class="headerlink" title="LoggingAdvisor"></a>LoggingAdvisor</h4><p>å®ç°äº† RequestResponseAdvisor æ¥å£çš„ç±»ï¼Œç”¨äºå¯¹è¯·æ±‚è¿›è¡Œæ—¥å¿—è®°å½•ã€‚è¿™é€šå¸¸ç”¨äºæ‹¦æˆªå’Œå¤„ç†è¯·æ±‚æ•°æ®ï¼Œåœ¨è¯·æ±‚è¢«è¿›ä¸€æ­¥å¤„ç†ä¹‹å‰æˆ–ä¹‹åæ‰§è¡Œä¸€äº›æ“ä½œï¼Œæ¯”å¦‚æ—¥å¿—è®°å½•ã€ç›‘æ§ç­‰ã€‚</p>
<ul>
<li>ä¸»è¦ä½œç”¨æ˜¯æ‹¦æˆªè¯·æ±‚å¹¶è¾“å‡ºè¯·æ±‚çš„æ—¥å¿—ä¿¡æ¯ï¼Œå¸®åŠ©å¼€å‘äººå‘˜äº†è§£å’Œè·Ÿè¸ªè¯·æ±‚çš„ç»†èŠ‚ã€‚è¿™å¯¹äºè°ƒè¯•å’Œç›‘æ§ç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€éå¸¸æœ‰ç”¨ã€‚</li>
</ul>
<h4 id="SeckillTools"><a href="#SeckillTools" class="headerlink" title="SeckillTools"></a>SeckillTools</h4><p>ä¸»è¦ç”¨äºå°è£…å’Œæš´éœ²ä¸â€œç§’æ€â€åŠŸèƒ½ç›¸å…³çš„å·¥å…·æ–¹æ³•ï¼Œä»¥ä¾¿ä»¥å‡½æ•°å¼ç¼–ç¨‹çš„æ–¹å¼è°ƒç”¨</p>
<p>è¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½ç»„ä»¶ç±»ï¼Œç”¨äºï¼š</p>
<ul>
<li><p>å¼€å¯æ¨¡æ‹Ÿçš„ç§’æ€æ´»åŠ¨ï¼ˆä½¿ç”¨æŸç§ç­–ç•¥å¦‚æ•°æ®åº“åŸå­æ›´æ–°ï¼‰</p>
</li>
<li><p>è·å–æŸä¸ªç§’æ€æ´»åŠ¨å¯¹åº”ä»»åŠ¡çš„è€—æ—¶ç»Ÿè®¡ä¿¡æ¯</p>
</li>
<li><p>ä½¿ç”¨ @Bean + Function&lt;â€¦&gt; çš„æ–¹å¼æš´éœ²æ–¹æ³•ï¼Œé€‚ç”¨äºå‡½æ•°å¼ç¼–ç¨‹æ¥å£ï¼Œåƒ Spring Cloud Function è¿™ç±»å¹³å°å¯ä»¥è‡ªåŠ¨æ‰«æè¿™äº›å‡½æ•°ç”¨äºæœåŠ¡æ³¨å†Œæˆ–äº‹ä»¶é©±åŠ¨ç¼–ç¨‹ã€‚</p>
</li>
<li><p>ä½¿ç”¨äº† CompletableFuture.supplyAsync() ä»¥å¼‚æ­¥æ–¹å¼è°ƒç”¨è¿œç¨‹æœåŠ¡ï¼Œé¿å…é˜»å¡ã€‚</p>
</li>
</ul>
<h4 id="UserSupportAssistant"><a href="#UserSupportAssistant" class="headerlink" title="UserSupportAssistant"></a>UserSupportAssistant</h4><p>UserSupportAssistant æ˜¯ä¸€ä¸ª æœåŠ¡ç±»ï¼ˆ@Serviceï¼‰ï¼Œå…¶ä½œç”¨æ˜¯<strong>é€šè¿‡ä¸ ChatClient çš„äº¤äº’ï¼Œå……å½“ç”¨æˆ·æ”¯æŒèŠå¤©ä»£ç†ï¼Œæä¾›ä¸ç§’æ€æ´»åŠ¨ç›¸å…³çš„åŠŸèƒ½ï¼Œå¦‚æŸ¥è¯¢å•†å“è¯¦æƒ…ã€å¼€å¯å’Œé‡ç½®ç§’æ€æ´»åŠ¨ç­‰</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSupportAssistant</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSupportAssistant</span><span class="hljs-params">(ChatClient.Builder modelBuilder, VectorStore vectorStore, ChatMemory chatMemory)</span> &#123;<br>        <span class="hljs-comment">// @formatter:off</span><br>		<span class="hljs-built_in">this</span>.chatClient = modelBuilder<br>				.defaultSystem(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">						æ‚¨æ˜¯ç”¨æˆ·èŠå¤©æ”¯æŒä»£ç†ã€‚è¯·ä»¥å‹å¥½ã€ä¹äºåŠ©äººä¸”æ„‰å¿«çš„æ–¹å¼æ¥å›å¤ã€‚</span><br><span class="hljs-string">						æ‚¨æ­£åœ¨é€šè¿‡åœ¨çº¿èŠå¤©ç³»ç»Ÿä¸ç”¨æˆ·äº’åŠ¨ã€‚</span><br><span class="hljs-string">						æ‚¨èƒ½å¤Ÿæ”¯æŒå·²æœ‰ç§’æ€å•†å“è¯¦æƒ…æŸ¥è¯¢ã€å¼€å¯ç§’æ€æ´»åŠ¨ã€é‡ç½®ç§’æ€æ´»åŠ¨ç­‰æ“ä½œï¼Œå…¶ä½™åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ï¼Œå¦‚æœç”¨æˆ·é—®çš„é—®é¢˜ä¸æ”¯æŒè¯·å‘ŠçŸ¥è¯¦æƒ…ã€‚</span><br><span class="hljs-string">					   åœ¨æä¾›æœ‰å…³ç§’æ€æ´»åŠ¨æŸ¥è¯¢ã€å¼€å¯ç§’æ€æ´»åŠ¨ã€é‡ç½®ç§’æ€æ´»åŠ¨ç­‰æ“ä½œä¹‹å‰ï¼Œæ‚¨å¿…é¡»å§‹ç»ˆä»ç”¨æˆ·å¤„è·å–ä»¥ä¸‹ä¿¡æ¯ï¼šç§’æ€æ´»åŠ¨idã€ç§’æ€å•†å“æ•°é‡ã€è¯·æ±‚æ¬¡æ•°ã€‚</span><br><span class="hljs-string">					   å¦‚æœéœ€è¦æå‰ç»“æŸç§’æ€æ´»åŠ¨ï¼Œæ‚¨å¿…é¡»åœ¨ç»§ç»­ä¹‹å‰å¾å¾—ç”¨æˆ·åŒæ„ã€‚</span><br><span class="hljs-string">					   ä½¿ç”¨æä¾›çš„åŠŸèƒ½è·å–ç§’æ€æ´»åŠ¨ä»¥åŠå•†å“è¯¦ç»†ä¿¡æ¯ã€å¼€å¯ç§’æ€æ´»åŠ¨å’Œé‡ç½®ç§’æ€ã€‚</span><br><span class="hljs-string">					   ç”¨æˆ·å¼€å§‹ç§’æ€æ´»åŠ¨åï¼Œç­‰å¾…10ç§’ï¼Œç„¶åè°ƒç”¨ è·å–ä»»åŠ¡è€—æ—¶ç»Ÿè®¡ä¿¡æ¯ å‡½æ•°ï¼Œæœ€åå°†å‡½æ•°ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</span><br><span class="hljs-string">					   å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥è°ƒç”¨ç›¸åº”å‡½æ•°è¾…åŠ©å®Œæˆã€‚</span><br><span class="hljs-string">					   è¯·è®²ä¸­æ–‡ã€‚</span><br><span class="hljs-string">					   ä»Šå¤©çš„æ—¥æœŸæ˜¯ &#123;current_date&#125;.</span><br><span class="hljs-string">					&quot;&quot;&quot;</span>)<br>				.defaultAdvisors(<br>						<span class="hljs-comment">// Chat Memory</span><br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptChatMemoryAdvisor</span>(chatMemory),<br>						<span class="hljs-comment">// new VectorStoreChatMemoryAdvisor(vectorStore)),</span><br>						<span class="hljs-comment">// RAG</span><br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">QuestionAnswerAdvisor</span>(vectorStore, SearchRequest.builder().topK(<span class="hljs-number">4</span>).similarityThresholdAll().build()),<br>						<span class="hljs-comment">// new QuestionAnswerAdvisor(vectorStore, SearchRequest.defaults()</span><br>						<span class="hljs-comment">// 	.withFilterExpression(&quot;&#x27;documentType&#x27; == &#x27;terms-of-service&#x27; &amp;&amp; region in [&#x27;EU&#x27;, &#x27;US&#x27;]&quot;)),</span><br>						<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingAdvisor</span>())<br>				<span class="hljs-comment">// FUNCTION CALLING</span><br>				.defaultFunctions(<span class="hljs-string">&quot;startSeckill&quot;</span>, <span class="hljs-string">&quot;getTaskTimeInfo&quot;</span>)<br>				.build();<br>		<span class="hljs-comment">// @formatter:on</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(String chatId, String userMessageContent)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatClient.prompt().system(s -&gt; s.param(<span class="hljs-string">&quot;current_date&quot;</span>, LocalDate.now().toString()))<br>                .user(userMessageContent)<br>                .advisors(a -&gt; a.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, <span class="hljs-number">100</span>))<br>                .stream()<br>				.content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p><strong>åŠŸèƒ½</strong>ï¼š</p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªæ™ºèƒ½èŠå¤©åŠ©æ‰‹ï¼Œå¤„ç†ç”¨æˆ·çš„ç§’æ€æ´»åŠ¨æŸ¥è¯¢ã€å¯åŠ¨å’Œé‡ç½®è¯·æ±‚ã€‚</li>
<li>é€šè¿‡ ChatClientï¼Œè¯¥ç±»èƒ½å¤Ÿä¸ç”¨æˆ·è¿›è¡Œäº’åŠ¨ï¼Œè‡ªåŠ¨æ”¶é›†ä¿¡æ¯ï¼ˆå¦‚ç§’æ€æ´»åŠ¨IDã€å•†å“æ•°é‡ã€è¯·æ±‚æ¬¡æ•°ï¼‰ï¼Œå¹¶åœ¨åå°æ‰§è¡Œç›¸å…³åŠŸèƒ½ã€‚</li>
<li>åŒæ—¶æ”¯æŒé€šè¿‡â€œèŠå¤©â€æ–¹å¼ä¸ç”¨æˆ·è¿›è¡Œäº¤æµï¼Œæä¾›å‹å¥½ã€ä¹äºåŠ©äººçš„æœåŠ¡ã€‚</li>
</ul>
<p><strong>æ¶æ„</strong>ï¼š</p>
<ul>
<li>ä¾èµ–äº ChatClientã€VectorStore å’Œ ChatMemory ç»„ä»¶ï¼Œå…¶ä¸­ ChatClient æ˜¯ä¸èŠå¤©ç³»ç»Ÿäº¤äº’çš„æ ¸å¿ƒã€‚</li>
<li>è¯¥ç±»å®šä¹‰äº†ä¸€ä¸ªä»¥èŠå¤©ä¸ºåŸºç¡€çš„äº¤äº’å¼åŠŸèƒ½æœåŠ¡ï¼Œå¸®åŠ©ç”¨æˆ·æ‰§è¡Œå’ŒæŸ¥è¯¢ç§’æ€æ´»åŠ¨ç›¸å…³æ“ä½œã€‚</li>
</ul>
<h2 id="12-3-AiBotApplication"><a href="#12-3-AiBotApplication" class="headerlink" title="12.3 AiBotApplication"></a>12.3 AiBotApplication</h2><p>ç”¨äºå¯åŠ¨ä¸€ä¸ªAIæœºå™¨äººåº”ç”¨çš„å¯åŠ¨ç±»</p>
<ul>
<li>AiBotApplication æ˜¯AIæœºå™¨äººåº”ç”¨çš„æ ¸å¿ƒå¯åŠ¨ç±»ï¼Œè´Ÿè´£é…ç½®å’Œåˆå§‹åŒ–å„ä¸ªç»„ä»¶ï¼Œå¹¶å¤„ç†åº”ç”¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„å…³é”®é…ç½®ã€‚</li>
</ul>
<h1 id="13-ä»å‰å¾€ååˆ†æ"><a href="#13-ä»å‰å¾€ååˆ†æ" class="headerlink" title="13. ä»å‰å¾€ååˆ†æ"></a>13. ä»å‰å¾€ååˆ†æ</h1><h2 id="13-1-goodskill-order-provider"><a href="#13-1-goodskill-order-provider" class="headerlink" title="13.1 goodskill-order-provider"></a>13.1 goodskill-order-provider</h2><h3 id="A-OrderService"><a href="#A-OrderService" class="headerlink" title="A. OrderService"></a>A. OrderService</h3><p><code>package com.goodskill.order.api</code></p>
<p>åŸºäº Spring Cloud OpenFeign å®ç°çš„ è®¢å•å¾®æœåŠ¡ (goodskill-order) è¿œç¨‹è°ƒç”¨æ¥å£ï¼Œå¹¶æä¾›äº† ç†”æ–­é™çº§å¤„ç†ã€‚</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>åŸºäº Feign çš„å£°æ˜å¼æœåŠ¡è°ƒç”¨</strong><ul>
<li>ä½¿ç”¨ Spring Cloud OpenFeign å®ç°å£°æ˜å¼ HTTP å®¢æˆ·ç«¯ï¼Œ<strong>ç®€åŒ–äº†å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨</strong>ã€‚<strong>æé«˜äº†ä»£ç å¯è¯»æ€§å’Œå¼€å‘æ•ˆç‡</strong>ï¼Œå±è”½äº†åº•å±‚ HTTP é€šä¿¡ç»†èŠ‚ï¼Œç¬¦åˆå¾®æœåŠ¡æ¶æ„ä¸­æœåŠ¡é—´é€šä¿¡çš„ç®€æ´æ€§è¦æ±‚ã€‚</li>
</ul>
</li>
<li><strong>æœåŠ¡ç†”æ–­ä¸é™çº§æœºåˆ¶</strong><ul>
<li>é›†æˆäº†æœåŠ¡ç†”æ–­å’Œé™çº§åŠŸèƒ½ï¼Œé€šè¿‡ <code>fallback</code> æŒ‡å®šå¤‡ç”¨æ–¹æ¡ˆï¼Œ<strong>ç¡®ä¿æœåŠ¡è°ƒç”¨å¤±è´¥æ—¶ç³»ç»Ÿä»èƒ½å¹³ç¨³è¿è¡Œ</strong>ã€‚åœ¨é«˜å¹¶å‘æˆ–æœåŠ¡ä¸å¯ç”¨åœºæ™¯ä¸‹ï¼Œé¿å…äº†è¯·æ±‚å †ç§¯å’Œç³»ç»Ÿå´©æºƒï¼Œæå‡äº†ç³»ç»Ÿçš„å®¹é”™èƒ½åŠ›å’Œç¨³å®šæ€§ï¼Œç‰¹åˆ«é€‚åˆç§’æ€è¿™ç§é«˜è´Ÿè½½åœºæ™¯ã€‚</li>
</ul>
</li>
<li><strong>çµæ´»çš„é™çº§ç­–ç•¥è®¾è®¡</strong><ul>
<li><strong>é™çº§ç­–ç•¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚å·®å¼‚åŒ–å¤„ç†</strong>ï¼Œæ—¢æœ‰é»˜è®¤è¿”å›å€¼ï¼Œä¹Ÿæœ‰å¼‚å¸¸æŠ›å‡ºï¼Œä½“ç°äº†è®¾è®¡çš„çµæ´»æ€§ã€‚æ ¹æ®æ¥å£çš„é‡è¦æ€§å’Œä¸šåŠ¡é€»è¾‘ï¼Œåˆç†é€‰æ‹©é™çº§æ–¹å¼</li>
</ul>
</li>
</ol>
<h2 id="13-2-goodskill-seckill-provider"><a href="#13-2-goodskill-seckill-provider" class="headerlink" title="13.2 goodskill-seckill-provider"></a>13.2 goodskill-seckill-provider</h2><h3 id="A-RedisService"><a href="#A-RedisService" class="headerlink" title="A. RedisService"></a>A. RedisService</h3><p><code>package com.goodskill.service.common</code></p>
<p>RedisService ç±»æ˜¯ä¸€ä¸ªç”¨äºæ“ä½œç§’æ€ç›¸å…³ Redis ç¼“å­˜çš„å·¥å…·ç±»ï¼Œå®ƒå°è£…äº†å¯¹ Redis çš„è¯»å†™é€»è¾‘ï¼Œä¸»è¦ç›®çš„æ˜¯æå‡æŸ¥è¯¢æ•ˆç‡ã€å‡è½»æ•°æ®åº“å‹åŠ›ã€æ ‡è¯†ç§’æ€çŠ¶æ€ç­‰</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨äº† Redis çš„<strong>è¿‡æœŸæœºåˆ¶</strong>å’Œ setIfAbsent æœºåˆ¶ï¼Œç¡®ä¿é«˜å¹¶å‘ä¸‹çš„æ“ä½œä¸€è‡´æ€§ã€‚</li>
<li><strong>ç¼“å­˜ç©¿é€æ§åˆ¶</strong>ï¼šç¼“å­˜æœªå‘½ä¸­æ—¶è‡ªåŠ¨åŠ è½½æ•°æ®åº“å¹¶å›å¡«ï¼Œé˜²æ­¢å¤§é‡è¯·æ±‚ç›´å‡»æ•°æ®åº“ã€‚</li>
<li>ä½¿ç”¨ Redis çš„ setIfAbsent æ“ä½œå®ç°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç§’æ€ç»“æŸæ ‡å¿—çš„åŸå­æ€§è®¾ç½®ï¼Œé˜²æ­¢é‡å¤è§¦å‘é€»è¾‘ã€‚</li>
</ol>
<h3 id="B-StateMachineConfig"><a href="#B-StateMachineConfig" class="headerlink" title="B. StateMachineConfig"></a>B. StateMachineConfig</h3><p><code>package com.goodskill.service.config</code></p>
<p>StateMachineConfig çš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºç§’æ€ç³»ç»Ÿå®šä¹‰å’Œç®¡ç†ä¸€ä¸ªçŠ¶æ€æœºï¼Œç”¨äºæ§åˆ¶ç§’æ€æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸã€‚çŠ¶æ€æœºé€šè¿‡é¢„å®šä¹‰çš„çŠ¶æ€å’Œäº‹ä»¶é©±åŠ¨çŠ¶æ€è½¬æ¢ï¼Œç¡®ä¿æ´»åŠ¨çŠ¶æ€çš„æœ‰åºæ€§å’Œä¸€è‡´æ€§ã€‚å…·ä½“ä½œç”¨åŒ…æ‹¬ï¼š</p>
<ol>
<li>çŠ¶æ€å®šä¹‰: å®šä¹‰äº†ç§’æ€æ´»åŠ¨çš„å„ç§çŠ¶æ€ï¼ˆå¦‚ INITã€IN_PROGRESSã€CALCULATINGã€ENDã€INTERRUPTTEDï¼‰ã€‚</li>
<li>çŠ¶æ€è½¬æ¢: é€šè¿‡äº‹ä»¶ï¼ˆå¦‚ ACTIVITY_STARTã€ACTIVITY_ENDï¼‰é©±åŠ¨çŠ¶æ€ä¹‹é—´çš„è·³è½¬ï¼Œä¾‹å¦‚ä» INIT åˆ° IN_PROGRESSã€‚</li>
<li>çŠ¶æ€æŒä¹…åŒ–: ä½¿ç”¨ Redis å­˜å‚¨çŠ¶æ€æœºçš„ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„çŠ¶æ€æ¢å¤å’Œä¸€è‡´æ€§ã€‚</li>
<li>çŠ¶æ€ç›‘æ§: é€šè¿‡ç›‘å¬å™¨è®°å½•çŠ¶æ€å˜åŒ–å’Œæœªæ¥å—äº‹ä»¶ï¼Œä¾¿äºè°ƒè¯•å’Œæ—¥å¿—è¿½è¸ªã€‚</li>
</ol>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨ Spring Statemachine æ¡†æ¶å®ç°çŠ¶æ€æœºï¼Œæ¸…æ™°å®šä¹‰äº†ç§’æ€æ´»åŠ¨çš„çŠ¶æ€å’Œè½¬æ¢è§„åˆ™ã€‚çŠ¶æ€æœºå°†å¤æ‚çš„ä¸šåŠ¡æµç¨‹æŠ½è±¡ä¸ºçŠ¶æ€å’Œäº‹ä»¶ï¼Œ<strong>é™ä½äº†ä»£ç å¤æ‚åº¦ï¼Œæé«˜äº†æµç¨‹çš„å¯æ§æ€§å’Œå¯ç»´æŠ¤æ€§</strong></li>
<li>é›†æˆ Redis å®ç°çŠ¶æ€æœºçš„æŒä¹…åŒ–ï¼Œç¡®ä¿åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çŠ¶æ€çš„ä¸€è‡´æ€§å’Œå¯æ¢å¤æ€§ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒèŠ‚ç‚¹å¯èƒ½æ•…éšœæˆ–é‡å¯ï¼Œé€šè¿‡ Redis æŒä¹…åŒ–çŠ¶æ€æœºä¸Šä¸‹æ–‡ï¼Œå¯ä»¥ä¿è¯çŠ¶æ€ä¸ä¼šä¸¢å¤±ï¼Œæ”¯æŒé«˜å¯ç”¨æ€§å’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ã€‚</li>
</ol>
<h3 id="C-PreRequestHandler"><a href="#C-PreRequestHandler" class="headerlink" title="C. PreRequestHandler"></a>C. PreRequestHandler</h3><p><code>package com.goodskill.service.handler</code></p>
<p>åŒ…å«ä»¥ä¸‹è¿™äº›ç±»ï¼š</p>
<ul>
<li>AbstractPreRequestHandler </li>
<li>DatabasePreRequestHandler</li>
<li>MongoPreRequestHandler</li>
<li>PreRequestHandler</li>
<li>PreRequestPipeline</li>
<li>RedisPreRequestHandler</li>
<li>StateMachinePreRequestHandler</li>
</ul>
<p>ç§’æ€ç³»ç»Ÿçš„ç‰¹ç‚¹æ˜¯<strong>é«˜å¹¶å‘ã€æ•°æ®æ•æ„Ÿã€çŠ¶æ€å¤æ‚</strong>ï¼Œæ‰€ä»¥<strong>åœ¨æ¯æ¬¡æ´»åŠ¨å¼€å§‹å‰ï¼Œéœ€è¦å®Œæˆä¸€ç³»åˆ—çš„å‡†å¤‡å·¥ä½œ</strong>ï¼Œ è¿™äº› Handler å°±åƒâ€œå¯åŠ¨å‰æ£€æŸ¥æ¸…å•â€ï¼Œæ¯ä¸ªè´Ÿè´£ä¸€ä¸ªç¯èŠ‚ï¼Œä»æ•°æ®ã€ç¼“å­˜ã€çŠ¶æ€ã€å†å²è®°å½•ç­‰å¤šä¸ªç»´åº¦åšå¥½å‡†å¤‡ï¼Œç¡®ä¿ç§’æ€ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹ä¹Ÿèƒ½ç¨³å®šè¿è¡Œã€‚</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibilityï¼‰å®ç°é¢„å¤„ç†é€»è¾‘çš„è§£è€¦å’Œæœ‰åºæ‰§è¡Œã€‚è§£è€¦äº†é¢„å¤„ç†é€»è¾‘ï¼Œä½¿æ¯ä¸ªå¤„ç†å™¨ä¸“æ³¨äºç‰¹å®šä»»åŠ¡ï¼Œæ˜“äºæ‰©å±•å’Œç»´æŠ¤</li>
<li>è¦†ç›–æ•°æ®åº“ã€Redis ç¼“å­˜ã€MongoDB å’ŒçŠ¶æ€æœºç­‰å¤šç»´åº¦çš„æ•°æ®åˆå§‹åŒ–ï¼Œç¡®ä¿ç³»ç»ŸçŠ¶æ€å…¨é¢ä¸€è‡´ã€‚åœ¨é«˜å¹¶å‘ç§’æ€åœºæ™¯ä¸‹ï¼Œå¤šæ•°æ®æºçš„ä¸€è‡´æ€§è‡³å…³é‡è¦ï¼Œè¿™ç§å…¨é¢è¦†ç›–çš„è®¾è®¡æœ‰æ•ˆé¿å…äº†å†å²æ•°æ®å¹²æ‰°å’ŒçŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ã€‚</li>
<li>é¢„å¤„ç†ç®¡é“å…·å¤‡å®¹é”™èƒ½åŠ›ï¼Œå•ä¸ªå¤„ç†å™¨å‡ºé”™ä¸ä¼šä¸­æ–­æ•´ä½“æµç¨‹ã€‚æé«˜äº†ç³»ç»Ÿçš„å¥å£®æ€§ï¼Œç¡®ä¿å³ä½¿éƒ¨åˆ†é¢„å¤„ç†å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå½±å“æ•´ä½“æµç¨‹ï¼ŒåŒæ—¶é€šè¿‡å¼‚å¸¸å’Œæ—¥å¿—ä¾¿äºé—®é¢˜å®šä½ã€‚</li>
</ol>
<h3 id="D-SeckillServiceImpl"><a href="#D-SeckillServiceImpl" class="headerlink" title="D. SeckillServiceImpl"></a>D. SeckillServiceImpl</h3><p><code>package com.goodskill.service.impl.dubbo</code></p>
<p><strong>ç§’æ€ç³»ç»Ÿçš„æ ¸å¿ƒæœåŠ¡å®ç°ç±»</strong></p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨ Apache Dubbo å®ç°å¾®æœåŠ¡é€šä¿¡ï¼Œæ”¯æŒè¿œç¨‹è°ƒç”¨å’Œåˆ†å¸ƒå¼éƒ¨ç½²ã€‚</li>
<li>Redis ç¼“å­˜ä¼˜åŒ–: åˆ©ç”¨ Redis ç¼“å­˜ç§’æ€æ´»åŠ¨åˆ—è¡¨å’Œçƒ­ç‚¹æ•°æ®ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›ã€‚</li>
<li>äº‹åŠ¡æ€§åº“å­˜ç®¡ç†: ä½¿ç”¨ @Transactional ç¡®ä¿åº“å­˜æ‰£å‡å’Œè®°å½•æ’å…¥çš„åŸå­æ€§ï¼Œé˜²æ­¢è¶…å–ã€‚åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…äº†åº“å­˜è¶…å–æˆ–å°‘å–é—®é¢˜</li>
<li>é€šè¿‡çŠ¶æ€æœºæ§åˆ¶ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œç¡®ä¿çŠ¶æ€è½¬æ¢çš„æ­£ç¡®æ€§ã€‚çŠ¶æ€æœºæä¾›äº†ç»Ÿä¸€çš„æµç¨‹æ§åˆ¶ï¼Œé˜²æ­¢éæ³•çŠ¶æ€è·³è½¬ï¼Œæå‡äº†ä¸šåŠ¡é€»è¾‘çš„å¯é æ€§ã€‚</li>
<li>å¤šæ•°æ®æºæŸ¥è¯¢æ”¯æŒ: æ”¯æŒä»æ•°æ®åº“å’Œ MongoDB æŸ¥è¯¢æˆåŠŸè®°å½•ï¼Œå¢å¼ºäº†æ•°æ®è®¿é—®çš„çµæ´»æ€§ã€‚é€‚åº”äº†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ•°æ®åˆ†æ•£çš„åœºæ™¯ï¼Œæä¾›äº†<strong>å®¹é”™æœºåˆ¶</strong>ï¼ˆMongoDB ä¸å¯ç”¨æ—¶è®°å½•æ—¥å¿—å¹¶æŠ›å¼‚å¸¸ï¼‰ã€‚</li>
<li>é¢„å¤„ç†ç®¡é“é›†æˆ: é€šè¿‡ PreRequestPipeline ç»Ÿä¸€è°ƒåº¦é¢„å¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ´»åŠ¨å¼€å§‹å‰çš„èµ„æºå‡†å¤‡ã€‚</li>
</ol>
<h3 id="E-GoodsEsServiceImpl"><a href="#E-GoodsEsServiceImpl" class="headerlink" title="E. GoodsEsServiceImpl"></a>E. GoodsEsServiceImpl</h3><p><code>package com.goodskill.service.impl</code></p>
<p>æ˜¯ä¸€ä¸ªåŸºäºElasticsearch çš„æœåŠ¡å®ç°ç±»ï¼Œè´Ÿè´£<strong>å¯¹å•†å“ä¿¡æ¯è¿›è¡Œ Elasticsearch çš„å¢åˆ æŸ¥æ“ä½œ</strong></p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>Elasticsearch é›†æˆ</strong>: ä½¿ç”¨ Spring Data Elasticsearch é›†æˆ Elasticsearchï¼Œæä¾›äº†é«˜æ•ˆçš„å…¨æ–‡æœç´¢å’Œç´¢å¼•ç®¡ç†åŠŸèƒ½ã€‚åˆ©ç”¨ Elasticsearch çš„åˆ†å¸ƒå¼æœç´¢èƒ½åŠ›ï¼Œæ”¯æŒç§’æ€ç³»ç»Ÿä¸­å•†å“ä¿¡æ¯çš„é«˜æ€§èƒ½æŸ¥è¯¢ï¼Œå°¤å…¶é€‚åˆæ¨¡ç³Šæœç´¢å’Œå®æ—¶ç´¢å¼•æ›´æ–°åœºæ™¯ã€‚</li>
<li><strong>é«˜äº®æœç´¢åŠŸèƒ½</strong>: å®ç°å•†å“åç§°çš„æ¨¡ç³Šæœç´¢ï¼Œå¹¶å¯¹åŒ¹é…å…³é”®å­—è¿›è¡Œé«˜äº®æ˜¾ç¤ºï¼Œæå‡äº†æœç´¢ç»“æœçš„å¯è¯»æ€§ã€‚</li>
<li><strong>åˆ†é¡µä¸ç»“æœé™åˆ¶</strong>: æœç´¢ç»“æœé™åˆ¶ä¸ºæœ€å¤š 3 æ¡ï¼Œå¹¶æ”¯æŒåˆ†é¡µæŸ¥è¯¢ï¼Œä¼˜åŒ–äº†æ€§èƒ½å’Œè¿”å›æ•°æ®é‡. åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé™åˆ¶è¿”å›æ•°æ®é‡é¿å…äº†è¿‡å¤šçš„ç»“æœå¤„ç†å¼€é”€ï¼ŒåŒæ—¶æ»¡è¶³äº†å¿«é€Ÿå“åº”çš„éœ€æ±‚ã€‚</li>
</ol>
<h3 id="F-mock-strategyç§’æ€ç­–ç•¥"><a href="#F-mock-strategyç§’æ€ç­–ç•¥" class="headerlink" title="F. mock.strategyç§’æ€ç­–ç•¥"></a>F. mock.strategyç§’æ€ç­–ç•¥</h3><p><code>package com.goodskill.service.mock.strategy.impl</code></p>
<p><strong>ç­–ç•¥å¯¹æ¯”è¡¨æ ¼</strong></p>
<table>
<thead>
<tr>
<th>ç­–ç•¥åç§°</th>
<th>æ ¸å¿ƒæœºåˆ¶</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody><tr>
<td>AtomicUpdateStrategy</td>
<td>æ•°æ®åº“åŸå­æ›´æ–°ï¼ˆä¹è§‚é”ï¼‰</td>
<td>ç®€å•é«˜æ•ˆï¼Œä¾èµ–æ•°æ®åº“äº‹åŠ¡ä¿è¯ä¸€è‡´æ€§</td>
<td>é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›å¤§ï¼Œå¯èƒ½å‡ºç°é”å†²çª</td>
<td>å•æœºæˆ–å°è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td>AtomicWithCanalStrategy</td>
<td>æ•°æ®åº“åŸå­æ›´æ–° + Canal ç›‘å¬ binlog</td>
<td>ç»“åˆæ•°æ®åº“ä¸€è‡´æ€§å’Œå¼‚æ­¥å¤„ç†ï¼ˆå¦‚é€šçŸ¥ï¼‰ï¼Œç»†ç²’åº¦é”é™ä½å†²çª</td>
<td>å®ç°å¤æ‚ï¼Œä¾èµ– Canal é…ç½®å’Œéƒ¨ç½²</td>
<td>éœ€è¦å¼‚æ­¥å¤„ç†çš„åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td>RedisMongoReactiveStrategy</td>
<td>Redis è®¡æ•° + å¼‚æ­¥ MongoDB ä¿å­˜</td>
<td>é«˜æ€§èƒ½ï¼Œå¼‚æ­¥è§£è€¦ï¼Œåº“å­˜æ£€æŸ¥æ— éœ€æ•°æ®åº“</td>
<td>Redis æ•°æ®ä¸€è‡´æ€§éœ€é¢å¤–ä¿éšœï¼Œå¤æ‚æ€§å¢åŠ </td>
<td>é«˜å¹¶å‘ã€éœ€è¦å¿«é€Ÿå“åº”çš„åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td>RedissonStrategy</td>
<td>Redisson åˆ†å¸ƒå¼é”</td>
<td>åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çº¿ç¨‹å®‰å…¨ï¼Œç®€å•æ˜“ç”¨ï¼Œå¯é‡å…¥é”æ”¯æŒ</td>
<td>é”è·å–å’Œé‡Šæ”¾æœ‰ç½‘ç»œå¼€é”€ï¼Œæ€§èƒ½ç¨é€Š</td>
<td>å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td>SentinelLimitStrategy</td>
<td>Sentinel é™æµ</td>
<td>ä¿æŠ¤ç³»ç»Ÿèµ„æºï¼Œé˜²æ­¢è¿‡è½½ï¼Œé™çº§å¤„ç†ä¼˜é›…</td>
<td>ä¸ç›´æ¥è§£å†³åº“å­˜ä¸€è‡´æ€§ï¼Œéœ€é…åˆå…¶ä»–æœºåˆ¶</td>
<td>é«˜æµé‡åœºæ™¯ï¼Œéœ€ä¿æŠ¤åç«¯æœåŠ¡</td>
</tr>
<tr>
<td>SynchronizedLockStrategy</td>
<td>Java æœ¬åœ°é”ï¼ˆsynchronizedï¼‰</td>
<td>å®ç°ç®€å•ï¼Œé€‚ç”¨äºå•æœºï¼ŒæŒ‰å•†å“åŠ é”å‡å°‘é”ç²’åº¦</td>
<td>ä¸æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œé«˜å¹¶å‘ä¸‹æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾</td>
<td>å•æœºæˆ–ä½å¹¶å‘åœºæ™¯</td>
</tr>
<tr>
<td>ZookeeperLockStrategy</td>
<td>Zookeeper åˆ†å¸ƒå¼é”</td>
<td>å¼ºä¸€è‡´æ€§ï¼Œå¯é‡å…¥é˜»å¡é”ï¼Œé€‚åˆåˆ†å¸ƒå¼ç¯å¢ƒ</td>
<td>Zookeeper ä¾èµ–éƒ¨ç½²ï¼Œé”ç«äº‰æ—¶å»¶è¿Ÿè¾ƒé«˜</td>
<td>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¼ºè°ƒä¸€è‡´æ€§è€Œéæè‡´æ€§èƒ½</td>
</tr>
</tbody></table>
<h3 id="G-StreamMessageConsumer"><a href="#G-StreamMessageConsumer" class="headerlink" title="G. StreamMessageConsumer"></a>G. StreamMessageConsumer</h3><p><code>package com.goodskill.service.mq</code></p>
<p>åŸºäº Spring Cloud Stream çš„æ¶ˆæ¯æ¶ˆè´¹è€…é…ç½®ç±»ï¼Œç”¨äºå¤„ç†é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ RabbitMQï¼‰æ¥æ”¶çš„ç§’æ€è¯·æ±‚</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>Spring Cloud Stream é›†æˆ</strong>: ä½¿ç”¨ Spring Cloud Stream å®ç°æ¶ˆæ¯é©±åŠ¨çš„å¾®æœåŠ¡æ¶æ„ï¼Œç®€åŒ–äº†æ¶ˆæ¯æ¶ˆè´¹çš„é…ç½®ã€‚åˆ©ç”¨ Spring Cloud Stream çš„ç»‘å®šæœºåˆ¶ï¼ˆé»˜è®¤ç»‘å®šåˆ° RabbitMQ æˆ–å…¶ä»– MQï¼‰ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®è¿æ¥å’Œé˜Ÿåˆ—ï¼Œé™ä½äº†å¼€å‘å¤æ‚æ€§ï¼Œæå‡äº†ä»£ç å¯è¯»æ€§ã€‚</li>
<li><strong>å¼‚æ­¥è§£è€¦è®¾è®¡</strong>: é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å®ç°ç§’æ€è¯·æ±‚çš„å¼‚æ­¥å¤„ç†ï¼Œè§£è€¦äº†è¯·æ±‚å‘é€ç«¯å’Œæ‰§è¡Œç«¯ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå¼‚æ­¥å¤„ç†æé«˜äº†ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œååé‡ï¼Œé¿å…äº†è¯·æ±‚å †ç§¯å¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆ</li>
</ol>
<h3 id="H-StateMachineService"><a href="#H-StateMachineService" class="headerlink" title="H. StateMachineService"></a>H. StateMachineService</h3><p><code>package com.goodskill.service.util</code></p>
<p>ä»ä½ æä¾›çš„ StateMachineService ç±»ä»£ç æ¥çœ‹ï¼Œè¿™æ˜¯ä¸€ä¸ªåŸºäº Spring StateMachine å®ç°çš„çŠ¶æ€æœºç®¡ç†æœåŠ¡ï¼Œç”¨äºåœ¨ç§’æ€ç³»ç»Ÿä¸­åè°ƒå’Œç®¡ç†æ¯ä¸ªç§’æ€æ´»åŠ¨ï¼ˆä»¥ seckillId åŒºåˆ†ï¼‰çš„çŠ¶æ€ç”Ÿå‘½å‘¨æœŸ</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><strong>Spring StateMachine é›†æˆ</strong>: åˆ©ç”¨ Spring StateMachine æ¡†æ¶å®ç°çŠ¶æ€ç®¡ç†ï¼Œæ¸…æ™°å®šä¹‰ç§’æ€æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸã€‚çŠ¶æ€æœºå°†å¤æ‚çš„ä¸šåŠ¡æµç¨‹æŠ½è±¡ä¸ºçŠ¶æ€å’Œäº‹ä»¶ï¼Œé™ä½äº†é€»è¾‘å¤æ‚æ€§ï¼Œæå‡äº†æµç¨‹çš„å¯æ§æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</li>
<li><strong>åˆ†å¸ƒå¼çŠ¶æ€æŒä¹…åŒ–</strong>: é€šè¿‡ Redis æŒä¹…åŒ–çŠ¶æ€æœºä¸Šä¸‹æ–‡ï¼Œæ”¯æŒåˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„çŠ¶æ€ä¸€è‡´æ€§å’Œæ¢å¤ã€‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒèŠ‚ç‚¹æ•…éšœæˆ–é‡å¯åä»èƒ½æ¢å¤çŠ¶æ€ï¼Œç¡®ä¿åˆ†å¸ƒå¼ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œä¸€è‡´æ€§ã€‚</li>
<li><strong>å¹¶å‘å®‰å…¨çš„å®ä¾‹ç®¡ç†</strong>: ä½¿ç”¨ ConcurrentHashMap ç¼“å­˜çŠ¶æ€æœºå®ä¾‹ï¼Œæ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¹¶å‘è®¿é—®ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé¿å…äº†çŠ¶æ€æœºå®ä¾‹çš„é‡å¤åˆ›å»ºæˆ–è¦†ç›–ï¼Œä¿è¯äº†çº¿ç¨‹å®‰å…¨å’Œæ€§èƒ½ã€‚</li>
</ol>
<h3 id="I-ZookeeperLockUtil"><a href="#I-ZookeeperLockUtil" class="headerlink" title="I. ZookeeperLockUtil"></a>I. ZookeeperLockUtil</h3><p><code>package com.goodskill.service.util</code></p>
<p>ZookeeperLockUtil çš„ä¸»è¦ä½œç”¨æ˜¯æä¾›åŸºäº ZooKeeper çš„åˆ†å¸ƒå¼é”åŠŸèƒ½</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>Curator æ¡†æ¶é›†æˆ: ä½¿ç”¨ Apache Curator ç®€åŒ– ZooKeeper çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæä¾›é«˜çº§æŠ½è±¡å’Œå¥å£®æ€§ã€‚</li>
<li>åˆ†å¸ƒå¼é”æ”¯æŒ: æä¾›åŸºäº ZooKeeper çš„åˆ†å¸ƒå¼é”åŠŸèƒ½ï¼Œç¡®ä¿å¤šèŠ‚ç‚¹ç¯å¢ƒä¸‹çš„èµ„æºäº’æ–¥è®¿é—®ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ˆå¦‚å¾®æœåŠ¡æ¶æ„ï¼‰ï¼Œé€šè¿‡ ZooKeeper çš„å¼ºä¸€è‡´æ€§ä¿è¯äº†é”çš„æ­£ç¡®æ€§ï¼Œé˜²æ­¢å¹¶å‘å†²çªï¼ˆå¦‚åº“å­˜è¶…å–ï¼‰ã€‚</li>
<li>è¶…æ—¶ä¸å®¹é”™æœºåˆ¶: é”è·å–è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œå¹¶é€šè¿‡é‡è¯•ç­–ç•¥æå‡å®¹é”™æ€§ã€‚è¶…æ—¶æœºåˆ¶é˜²æ­¢é”ç«äº‰æ—¶çš„æ­»é”ï¼Œé‡è¯•ç­–ç•¥å¢å¼ºäº†è¿æ¥ ZooKeeper çš„é²æ£’æ€§ï¼Œæå‡äº†ç³»ç»Ÿç¨³å®šæ€§ã€‚</li>
</ol>
<h2 id="13-3-goodskill-web"><a href="#13-3-goodskill-web" class="headerlink" title="13.3 goodskill-web"></a>13.3 goodskill-web</h2><h3 id="A-GlobalExceptionHandler"><a href="#A-GlobalExceptionHandler" class="headerlink" title="A. GlobalExceptionHandler"></a>A. GlobalExceptionHandler</h3><p><code>package com.goodskill.web.config</code></p>
<p>åŸºäº Spring Boot çš„å…¨å±€å¼‚å¸¸å¤„ç†ç±»ï¼Œåˆ©ç”¨ @RestControllerAdvice å’Œ @ExceptionHandler æ³¨è§£é›†ä¸­å¤„ç†åº”ç”¨ä¸­çš„å¼‚å¸¸ï¼Œå¹¶è¿”å›ç»Ÿä¸€çš„å“åº”æ ¼å¼ã€‚</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>å…¨å±€å¼‚å¸¸å¤„ç†: ä½¿ç”¨ @RestControllerAdvice å®ç°å…¨å±€å¼‚å¸¸æ•è·ï¼Œé›†ä¸­ç®¡ç†åº”ç”¨ä¸­çš„é”™è¯¯å¤„ç†é€»è¾‘ã€‚é¿å…äº†åœ¨æ¯ä¸ªæ§åˆ¶å™¨ä¸­é‡å¤ç¼–å†™å¼‚å¸¸å¤„ç†ä»£ç ï¼Œé™ä½äº†ä»£ç å†—ä½™ï¼Œæé«˜äº†å¯ç»´æŠ¤æ€§ã€‚</li>
<li>ç»Ÿä¸€çš„å“åº”æ ¼å¼: è¿”å›æ ‡å‡†åŒ–çš„ ApiResult å¯¹è±¡ï¼Œç¡®ä¿é”™è¯¯å“åº”çš„æ ¼å¼ä¸€è‡´ã€‚</li>
<li>ç»†ç²’åº¦çš„å¼‚å¸¸åˆ†ç±»: é’ˆå¯¹ä¸åŒç±»å‹çš„å¼‚å¸¸ï¼ˆé€šç”¨å¼‚å¸¸ã€å‚æ•°ç»‘å®šå¼‚å¸¸ã€æ ¡éªŒå¼‚å¸¸ï¼‰æä¾›ç‰¹å®šå¤„ç†é€»è¾‘ã€‚æ ¹æ®å¼‚å¸¸ç±»å‹è¿”å›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚å­—æ®µçº§åˆ«çš„æ ¡éªŒå¤±è´¥åŸå› ï¼‰ï¼Œæé«˜äº†é”™è¯¯å¤„ç†çš„ç²¾å‡†æ€§å’Œå®ç”¨æ€§ã€‚</li>
</ol>
<h3 id="B-SeckillMockController"><a href="#B-SeckillMockController" class="headerlink" title="B. SeckillMockController"></a>B. SeckillMockController</h3><p><code>package com.goodskill.web.controller</code></p>
<p>ç”¨äºæ¨¡æ‹Ÿç§’æ€åœºæ™¯çš„æ§åˆ¶å™¨ç±»ï¼Œé€šè¿‡ RESTful æ¥å£æä¾›å¤šç§ç§’æ€ç­–ç•¥çš„æµ‹è¯•å…¥å£ã€‚å®ƒé›†æˆäº†å¤šç§æŠ€æœ¯ï¼ˆå¦‚ Dubboã€æ¶ˆæ¯é˜Ÿåˆ—ã€çº¿ç¨‹æ± ã€Redis ç­‰ï¼‰</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>å¤šç§ç§’æ€ç­–ç•¥æ”¯æŒ: é€šè¿‡å•ä¸€æ§åˆ¶å™¨æ”¯æŒå¤šç§ç§’æ€ç­–ç•¥ï¼ˆå¦‚åŒæ­¥é”ã€Redissonã€Kafkaã€RabbitMQã€Sentinel ç­‰ï¼‰ï¼Œä½“ç°äº†çµæ´»æ€§å’Œå¯æ‰©å±•æ€§ã€‚</li>
<li>çº¿ç¨‹æ± å¹¶å‘æ¨¡æ‹Ÿ: ä½¿ç”¨ ThreadPoolTaskExecutor æ¨¡æ‹Ÿé«˜å¹¶å‘è¯·æ±‚ï¼Œæ”¯æŒåŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—é›†æˆ: é›†æˆ Kafka å’Œ RabbitMQï¼ˆé€šè¿‡ StreamBridgeï¼‰å®ç°å¼‚æ­¥ç§’æ€è¯·æ±‚ï¼Œæå‡å“åº”é€Ÿåº¦ã€‚å¼‚æ­¥å¤„ç†è§£è€¦äº†è¯·æ±‚å‘é€å’Œå®é™…æ‰§è¡Œï¼Œæé«˜äº†ç³»ç»Ÿçš„ååé‡å’Œå¯æ‰©å±•æ€§ï¼Œé€‚åˆé«˜å¹¶å‘åœºæ™¯ã€‚</li>
</ol>
<h2 id="13-4-goodskill-job"><a href="#13-4-goodskill-job" class="headerlink" title="13.4 goodskill-job"></a>13.4 goodskill-job</h2><h3 id="ElasticJob-çš„åˆ†ç‰‡æœºåˆ¶"><a href="#ElasticJob-çš„åˆ†ç‰‡æœºåˆ¶" class="headerlink" title="ElasticJob çš„åˆ†ç‰‡æœºåˆ¶"></a>ElasticJob çš„åˆ†ç‰‡æœºåˆ¶</h3><p><code>package com.goodskill.job.simple</code></p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ElasticJob åˆ†ç‰‡æœºåˆ¶çš„åˆ†å¸ƒå¼ä»»åŠ¡æ‹†åˆ†<ul>
<li>ElasticJob é€šè¿‡åˆ†ç‰‡æœºåˆ¶å°†ä»»åŠ¡åˆ†å¸ƒå¼æ‹†åˆ†åˆ°å¤šä¸ªèŠ‚ç‚¹æ‰§è¡Œï¼ŒMyJob ç±»ä¸­çš„ ShardingContext å‚æ•°å…è®¸ä»»åŠ¡æ ¹æ® shardingItemï¼ˆåˆ†ç‰‡é¡¹ï¼‰åŠ¨æ€åˆ†é…ä¸åŒçš„æ‰§è¡Œé€»è¾‘ã€‚è¿™ç§è®¾è®¡ç‰¹åˆ«é€‚åˆå¤„ç†å¤§è§„æ¨¡æ•°æ®åŒæ­¥ä»»åŠ¡ï¼Œä¾‹å¦‚å°†å•†å“æ•°æ®åŒæ­¥åˆ° Elasticsearchã€‚<ul>
<li>è´Ÿè½½å‡è¡¡: åˆ†ç‰‡æœºåˆ¶ç»“åˆ Zookeeper æ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥å°†ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹ï¼Œé¿å…å•ç‚¹å‹åŠ›ã€‚</li>
<li>å¯æ‰©å±•æ€§: å½“æ•°æ®é‡æˆ–èŠ‚ç‚¹æ•°å¢åŠ æ—¶ï¼Œåªéœ€è°ƒæ•´åˆ†ç‰‡æ•°é‡ï¼ˆshardingTotalCountï¼‰å’Œé€»è¾‘ï¼Œæ— éœ€å¤§å¹…æ”¹åŠ¨ä»£ç ã€‚</li>
<li>å®¹é”™æ€§: ElasticJob è‡ªå¸¦ä»»åŠ¡å¤±è´¥é‡è¯•å’ŒèŠ‚ç‚¹æ•…éšœè½¬ç§»åŠŸèƒ½ï¼Œç¡®ä¿ä»»åŠ¡æ‰§è¡Œçš„å¯é æ€§ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é«˜æ•ˆåŒæ­¥å•†å“æ•°æ®åˆ° Elasticsearch<ul>
<li>MyJob é€šè¿‡ Dubbo è¿œç¨‹è°ƒç”¨ GoodsService è·å–å•†å“æ•°æ®ï¼Œå¹¶åˆ©ç”¨ parallelStream() å¹¶è¡Œå¤„ç†æ•°æ®è½¬æ¢ï¼Œæœ€åé€šè¿‡ goodsEsService.saveBatch() æ‰¹é‡æ›´æ–° Elasticsearch ç´¢å¼•ã€‚è¿™ç§è®¾è®¡å…¼é¡¾äº†åˆ†å¸ƒå¼è°ƒç”¨å’Œæ‰¹é‡æ“ä½œçš„æ•ˆç‡ã€‚<ul>
<li>é«˜æ€§èƒ½: å¹¶è¡Œæµå’Œæ‰¹é‡æ“ä½œæ˜¾è‘—æå‡äº†æ•°æ®å¤„ç†çš„ååé‡ã€‚</li>
<li>è§£è€¦æ€§: é€šè¿‡ Dubbo è°ƒç”¨å•†å“æœåŠ¡ï¼Œä»»åŠ¡æ¨¡å—ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="13-5-goodskill-gateway"><a href="#13-5-goodskill-gateway" class="headerlink" title="13.5 goodskill-gateway"></a>13.5 goodskill-gateway</h2><h3 id="A-gateway-config-ç½‘å…³é…ç½®"><a href="#A-gateway-config-ç½‘å…³é…ç½®" class="headerlink" title="A. gateway.config ç½‘å…³é…ç½®"></a>A. gateway.config ç½‘å…³é…ç½®</h3><p><code>com.goodskill.gateway.config</code></p>
<p>æœ¬é¡¹ç›®åŸºäº Spring Cloud Gateway å’Œ Sa-Token å®ç°äº†ç»Ÿä¸€è®¤è¯ç½‘å…³ï¼Œå°è£…äº†ç™»å½•é‰´æƒã€è·¯ç”±è½¬å‘ã€æƒé™æ§åˆ¶ã€ç™½åå•æœºåˆ¶ç­‰æ ¸å¿ƒåŠŸèƒ½ï¼Œæå‡äº†ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚é€šè¿‡æ³¨å…¥è‡ªå®šä¹‰æƒé™æ¥å£å¹¶ç»“åˆè¿œç¨‹è°ƒç”¨ï¼Œå®Œæˆäº†å¾®æœåŠ¡é—´è®¤è¯æˆæƒä½“ç³»çš„ç»Ÿä¸€è®¾è®¡ã€‚</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½æ¨¡å—</th>
<th>ç±»å</th>
<th>ä¼˜åŠ¿</th>
</tr>
</thead>
<tbody><tr>
<td>è·¯ç”±è½¬å‘</td>
<td>GatewayConfiguration</td>
<td>å®ç°é›†ä¸­å¼ç½‘å…³è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€æœåŠ¡å‘ç°ã€å‰ç¼€å‰¥ç¦»ç­‰ï¼Œæé«˜æ¥å£ç»Ÿä¸€æ€§ä¸å¯ç»´æŠ¤æ€§</td>
</tr>
<tr>
<td>å®‰å…¨è®¤è¯</td>
<td>SaTokenConfiguration</td>
<td>æä¾›å…¨å±€ç»Ÿä¸€è®¤è¯å…¥å£ï¼Œæ”¯æŒè·¯å¾„åŒ¹é…ã€ç™½åå•æ§åˆ¶ã€ç”¨æˆ·ä¿¡æ¯ä¼ é€’ç­‰ï¼Œä¿éšœå®‰å…¨ã€è§£è€¦ä¸šåŠ¡</td>
</tr>
<tr>
<td>æƒé™æ§åˆ¶</td>
<td>StpInterfaceImpl</td>
<td>æ”¯æŒè¿œç¨‹æƒé™æŸ¥è¯¢ã€åŠ¨æ€è§’è‰²ç®¡ç†ï¼Œå®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼Œæ”¯æŒæœªæ¥æƒé™ç®¡ç†å‡çº§</td>
</tr>
</tbody></table>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><code>GatewayConfiguration</code> â€”â€” ç½‘å…³è·¯ç”±é…ç½®ç±»<ul>
<li>é›†ä¸­å¼è·¯ç”±ç®¡ç†ï¼š é€šè¿‡ RouteLocatorBuilder æ˜ç¡®é…ç½®äº†å¤šä¸ªå¾®æœåŠ¡ï¼ˆå¦‚ goodskill-orderã€goodskill-auth ç­‰ï¼‰çš„è·¯ç”±è·¯å¾„ã€‚</li>
<li>æœåŠ¡æ³¨å†Œå‘ç°é›†æˆï¼šä½¿ç”¨äº† æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚ Nacosã€Eurekaï¼‰ï¼Œé€šè¿‡<strong>è´Ÿè½½å‡è¡¡</strong>è°ƒç”¨åç«¯æœåŠ¡ï¼Œä¾¿äºæœåŠ¡æ²»ç†ã€‚</li>
</ul>
</li>
<li><code>SaTokenConfiguration</code> â€”â€” Sa-Token å…¨å±€è¿‡æ»¤å™¨é…ç½®ç±»<ul>
<li>å…¨å±€è®¤è¯ç»Ÿä¸€å…¥å£ï¼šé€šè¿‡ SaReactorFilter å®ç°å…¨å±€è¯·æ±‚æ‹¦æˆªï¼Œåœ¨ä¸šåŠ¡å¤„ç†å‰è¿›è¡Œç»Ÿä¸€è®¤è¯ã€‚</li>
<li>è®¤è¯å¢å¼ºï¼šç™»å½•æ ¡éªŒï¼šStpUtil.checkLogin() å¼ºåˆ¶è¦æ±‚ç™»å½•çŠ¶æ€ã€‚</li>
<li>å¼‚å¸¸ç»Ÿä¸€å¤„ç†ï¼šæ‰€æœ‰è®¤è¯å¼‚å¸¸éƒ½ç”± .setError(â€¦) æ•æ‰å¹¶è¿”å›ç»Ÿä¸€æ ¼å¼å“åº”ï¼Œæå‡æ¥å£ä¸€è‡´æ€§ã€‚</li>
</ul>
</li>
<li><code>StpInterfaceImpl</code> â€”â€” Sa-Token æƒé™ä¸è§’è‰²æä¾›å™¨<ul>
<li>åŠ¨æ€æƒé™åŠ è½½ï¼šå®ç° StpInterface æ¥å£ï¼Œç»“åˆè¿œç¨‹ AuthFeignClientï¼Œå®ç°æƒé™å’Œè§’è‰²çš„åŠ¨æ€æŸ¥è¯¢ã€‚</li>
</ul>
</li>
</ol>
<h3 id="B-gateway-service"><a href="#B-gateway-service" class="headerlink" title="B. gateway.service"></a>B. gateway.service</h3><p><code>package com.goodskill.gateway.service</code></p>
<p>å¾®æœåŠ¡ç½‘å…³åŠ¨æ€è·¯ç”±çš„æ ¸å¿ƒï¼Œé…åˆ Spring Cloud Gateway å’Œ Nacosï¼Œå®ç°äº†<strong>è·¯ç”±é…ç½®çš„åŠ¨æ€ç®¡ç†ä¸çƒ­æ›´æ–°</strong></p>
<p>åœ¨ç½‘å…³æ¨¡å—ä¸­è®¾è®¡å¹¶å®ç°äº†åŸºäº Nacos é…ç½®ä¸­å¿ƒçš„åŠ¨æ€è·¯ç”±ç®¡ç†æœºåˆ¶ï¼Œæ”¯æŒè·¯ç”±é…ç½®çš„çƒ­æ›´æ–°ä¸è‡ªåŠ¨åŒæ­¥ã€‚é€šè¿‡ç›‘å¬é…ç½®ä¸­å¿ƒå˜æ›´äº‹ä»¶ï¼Œç»“åˆ Spring Cloud Gateway çš„äº‹ä»¶æœºåˆ¶ï¼Œå®Œæˆç½‘å…³è·¯ç”±çš„å®æ—¶åˆ·æ–°ï¼Œå¤§å¹…æå‡ç³»ç»Ÿçš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œç¡®ä¿ç½‘å…³åœ¨é«˜å¯ç”¨å’ŒæœåŠ¡é¢‘ç¹å˜æ›´åœºæ™¯ä¸‹ä¾ç„¶ä¿æŒè·¯ç”±ä¸€è‡´æ€§ä¸ç¨³å®šæ€§ã€‚</p>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li><code>DynamicRouteConfigWatcher</code> â€”â€” åŠ¨æ€è·¯ç”±ç›‘å¬å™¨<ul>
<li>è‡ªåŠ¨ç›‘å¬ Nacos è·¯ç”±é…ç½®å˜æ›´: å®ç°äº†ç½‘å…³æ— æ„ŸçŸ¥è‡ªåŠ¨åˆ·æ–°ï¼Œä¸éœ€è¦é‡å¯æœåŠ¡ï¼ŒçœŸæ­£å®ç°é…ç½®çƒ­æ›´æ–°ã€‚</li>
<li>ä¸ DynamicRouteRefresh è”åŠ¨ï¼Œå®æ—¶æ›´æ–°è·¯ç”±</li>
<li>å¯åŠ¨æ—¶è‡ªåŠ¨æ‹‰å–å·²æœ‰è·¯ç”±é…ç½®</li>
</ul>
</li>
<li><code>DynamicRouteRefresh</code> â€”â€” åŠ¨æ€è·¯ç”±åˆ·æ–°æœåŠ¡ç±»<ul>
<li>åˆ©ç”¨ Spring æä¾›çš„äº‹ä»¶æœºåˆ¶ RefreshRoutesEvent é€šçŸ¥ Spring Cloud Gateway åˆ·æ–°è·¯ç”±</li>
<li>è·¯ç”±åˆ é™¤ä¸æ›´æ–°é€»è¾‘åˆ†ç¦»: updateList() å®ç°å…¨é‡åˆ·æ–°é€»è¾‘ï¼Œå…ˆåˆ é™¤å·²æœ‰è·¯ç”±ï¼Œå†é‡æ–°æ·»åŠ ï¼Œå®ç°å¹‚ç­‰åŒ–è·¯ç”±æ›´æ–°ã€‚</li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th>æ¨¡å—</th>
<th>ç±»å</th>
<th>åŠŸèƒ½äº®ç‚¹</th>
<th>å¾®æœåŠ¡ä¼˜åŠ¿</th>
</tr>
</thead>
<tbody><tr>
<td>åŠ¨æ€è·¯ç”±ç›‘å¬å™¨</td>
<td>DynamicRouteConfigWatcher</td>
<td>ç›‘å¬ Nacos å˜æ›´ã€å¯åŠ¨æ—¶åˆå§‹åŒ–è·¯ç”±</td>
<td>å®ç°åŠ¨æ€æ„ŸçŸ¥è·¯ç”±é…ç½®å˜æ›´ï¼Œæ— éœ€é‡å¯ç½‘å…³</td>
</tr>
<tr>
<td>è·¯ç”±åˆ·æ–°æœåŠ¡</td>
<td>DynamicRouteRefresh</td>
<td>å†…å­˜è·¯ç”±ç»´æŠ¤ã€äº‹ä»¶é©±åŠ¨åˆ·æ–°</td>
<td>é«˜æ€§èƒ½è·¯ç”±æ›´æ–°æœºåˆ¶ï¼Œæ”¯æŒå¤§è§„æ¨¡æœåŠ¡è·¯ç”±åŠ¨æ€ç®¡ç†</td>
</tr>
</tbody></table>
<h2 id="13-6-goodskill-ai"><a href="#13-6-goodskill-ai" class="headerlink" title="13.6 goodskill-ai"></a>13.6 goodskill-ai</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs scss">ç”¨æˆ·è¯·æ±‚ â†’ AssistantController<span class="hljs-selector-class">.chat</span>(chatId, userMessage)<br>           â†“<br>      UserSupportAssistant<span class="hljs-selector-class">.chat</span>(...)<br>           â†“<br>      ChatClientï¼šç”Ÿæˆå›å¤ + è°ƒç”¨å‡½æ•° + ç®¡ç†ä¸Šä¸‹æ–‡<br>           â†“<br>      è¿”å› Flux&lt;String&gt; æµå¼æ¶ˆæ¯<br></code></pre></td></tr></table></figure>


<h3 id="A-AssistantController"><a href="#A-AssistantController" class="headerlink" title="A. AssistantController"></a>A. AssistantController</h3><p><code>package com.goodskill.ai.controller</code></p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½ç‚¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>èŠå¤©å…¥å£</td>
<td>æä¾› &#x2F;api&#x2F;assistant&#x2F;chat æ¥å£ä½œä¸ºç”¨æˆ·ä¸ AI åŠ©æ‰‹çš„å¯¹è¯å…¥å£</td>
</tr>
<tr>
<td>è°ƒç”¨ AI æœåŠ¡</td>
<td>å°†ç”¨æˆ·è¾“å…¥äº¤ç”± UserSupportAssistantï¼ˆæ ¸å¿ƒ AI æœåŠ¡ç±»ï¼‰å¤„ç†</td>
</tr>
<tr>
<td>æµå¼å“åº”</td>
<td>ä½¿ç”¨ <code>Flux&lt;String&gt;</code> ç»“åˆ TEXT_EVENT_STREAM_VALUE è¿”å›æµå¼æ¶ˆæ¯ï¼Œå®ç°ç±»ä¼¼ ChatGPT çš„â€œå®æ—¶å›å¤â€ä½“éªŒ</td>
</tr>
</tbody></table>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ä½¿ç”¨ Spring WebFlux å®ç° æµå¼å“åº”ï¼ˆServer-Sent Events, SSEï¼‰<ul>
<li>è¿”å› <code>Flux&lt;String&gt;</code> å®ç°â€œé€æ¡æ¶ˆæ¯å®æ—¶æ¨é€â€ï¼Œæå‡å‰ç«¯äº¤äº’ä½“éªŒã€‚</li>
<li>å‡å°‘ç”¨æˆ·ç­‰å¾…æ—¶é—´ï¼Œæ¨¡æ‹Ÿâ€œæ‰“å­—å¼â€AIå›å¤æ•ˆæœï¼Œäº¤äº’æ›´è‡ªç„¶ã€‚</li>
</ul>
</li>
</ol>
<h3 id="B-UserSupportAssistant"><a href="#B-UserSupportAssistant" class="headerlink" title="B. UserSupportAssistant"></a>B. UserSupportAssistant</h3><p><code>package com.goodskill.ai.service</code></p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>AI åŠ©æ‰‹æœåŠ¡ç±»</td>
<td>è¿™æ˜¯ AI å¾®æœåŠ¡ä¸­çœŸæ­£å¤„ç†ç”¨æˆ·èŠå¤©è¯·æ±‚çš„æ ¸å¿ƒé€»è¾‘ç±»ï¼Œæ§åˆ¶äº†èŠå¤©æµç¨‹</td>
</tr>
<tr>
<td>AI æ¨¡å‹é©±åŠ¨</td>
<td>ä½¿ç”¨ ChatClient å°è£…å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ ChatGPTï¼‰ï¼Œå®ç°è‡ªç„¶è¯­è¨€å¯¹è¯</td>
</tr>
<tr>
<td>æ”¯æŒ RAG æ£€ç´¢å¼é—®ç­”</td>
<td>é›†æˆå‘é‡æ•°æ®åº“ï¼ˆVectorStoreï¼‰æ¥æ”¯æŒä¸Šä¸‹æ–‡é—®ç­”ï¼Œå¢å¼ºå¯¹è¯æ™ºèƒ½</td>
</tr>
<tr>
<td>è®°å¿†ç®¡ç†</td>
<td>é›†æˆ ChatMemory å®ç°å¤šè½®å¯¹è¯è®°å¿†</td>
</tr>
<tr>
<td>å‡½æ•°è°ƒç”¨</td>
<td>æ”¯æŒé€šè¿‡å¯¹è¯è§¦å‘ç³»ç»Ÿå‡½æ•°ï¼ˆå¦‚ï¼šå¼€å¯ç§’æ€ã€è·å–ä»»åŠ¡è€—æ—¶ï¼‰</td>
</tr>
</tbody></table>
<p><strong>äº®ç‚¹ï¼š</strong></p>
<ol>
<li>ç³»ç»Ÿæç¤ºè¯ System Prompt çµæ´»é…ç½®</li>
<li>RAGï¼ˆRetrieval-Augmented Generationï¼‰å¢å¼ºé—®ç­”èƒ½åŠ›</li>
<li>æ”¯æŒå‡½æ•°å¼è°ƒç”¨: æ¨¡å‹å¯è¯†åˆ«ç”¨æˆ·æ„å›¾å¹¶è§¦å‘å¦‚ startSeckill()ã€getTaskTimeInfo() ç­‰åç«¯å®é™…æ–¹æ³• â†’ å®ç° å¯¹è¯å³æ“ä½œ çš„äº¤äº’ä½“éªŒã€‚</li>
<li>å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†: åˆ©ç”¨ ChatMemory å’Œ PromptChatMemoryAdvisor å®ç°è®°å¿†è¿½è¸ªï¼Œæ¨¡å‹å¯è®°ä½ç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚</li>
<li>å“åº”å¼ç¼–ç¨‹: è¿”å› <code>Flux&lt;String&gt;</code> æµå¼å“åº”ï¼Œæå‡å¯¹è¯å®æ—¶æ€§ä¸ç”¨æˆ·ä½“éªŒã€‚</li>
</ol>
<h1 id="14-é¡¹ç›®äº®ç‚¹"><a href="#14-é¡¹ç›®äº®ç‚¹" class="headerlink" title="14. é¡¹ç›®äº®ç‚¹"></a>14. é¡¹ç›®äº®ç‚¹</h1><ol>
<li>å®ç°å¤šç§é«˜å¹¶å‘ç§’æ€ç­–ç•¥ï¼Œæ”¯æŒåŒæ­¥ä¸å¼‚æ­¥åŒé€šé“ï¼Œæ¶µç›–SychronizedåŒæ­¥é”ã€æ•°æ®åº“ä¹è§‚é”ã€Redissonåˆ†å¸ƒå¼é”ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–ï¼Œå…¨é¢ä¿éšœé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§</li>
<li>åŸºäº Nacos å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†ï¼›ä½¿ç”¨ OpenFeign å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡ç›¸åº”çš„æœåŠ¡é™çº§é€»è¾‘å¤„ç†ï¼›ä½¿ç”¨ Gateway æ„å»ºå¾®æœåŠ¡ API ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯</li>
<li>é‡‡ç”¨åŸºäºè´£ä»»é“¾æ¨¡å¼çš„é¢„å¤„ç†å™¨æœºåˆ¶ï¼Œåœ¨ç§’æ€å‰å¯¹æ•°æ®åº“ã€ç¼“å­˜ã€çŠ¶æ€æœºç­‰è¿›è¡Œåˆå§‹åŒ–é¢„å¤„ç†</li>
<li>åˆ©ç”¨ Spring StateMachine çŠ¶æ€æœºå®šä¹‰å’Œç®¡ç†ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œç»Ÿä¸€æ§åˆ¶æ´»åŠ¨çŠ¶æ€ï¼Œä¾¿äºçŠ¶æ€çš„é›†ä¸­ç»´æŠ¤</li>
<li>é›†æˆElasticsearchå®ç°é«˜æ•ˆå•†å“æ£€ç´¢ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢ä¸å…³é”®è¯é«˜äº®ï¼Œæå‡ç”¨æˆ·æ£€ç´¢ä½“éªŒ</li>
<li>åŸºäºSpring AI Alibabaæ„å»ºç§’æ€AIå¯¹è¯æœåŠ¡ï¼Œé€šè¿‡æµå¼å“åº”å®ç°å®æ—¶äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ™ºèƒ½é—®ç­”è§¦å‘ç§’æ€æ“ä½œ</li>
</ol>
<h1 id="15-äº®ç‚¹è¯¦è§£"><a href="#15-äº®ç‚¹è¯¦è§£" class="headerlink" title="15. äº®ç‚¹è¯¦è§£"></a>15. äº®ç‚¹è¯¦è§£</h1><h2 id="1-å®ç°å¤šç§é«˜å¹¶å‘ç§’æ€ç­–ç•¥ï¼Œæ”¯æŒåŒæ­¥ä¸å¼‚æ­¥åŒé€šé“ï¼Œæ¶µç›–SychronizedåŒæ­¥é”ã€æ•°æ®åº“ä¹è§‚é”ã€Redissonåˆ†å¸ƒå¼é”ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€Redis-è®¡æ•°-MongoDB-å¼‚æ­¥æŒä¹…åŒ–ï¼Œå…¨é¢ä¿éšœé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§"><a href="#1-å®ç°å¤šç§é«˜å¹¶å‘ç§’æ€ç­–ç•¥ï¼Œæ”¯æŒåŒæ­¥ä¸å¼‚æ­¥åŒé€šé“ï¼Œæ¶µç›–SychronizedåŒæ­¥é”ã€æ•°æ®åº“ä¹è§‚é”ã€Redissonåˆ†å¸ƒå¼é”ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€Redis-è®¡æ•°-MongoDB-å¼‚æ­¥æŒä¹…åŒ–ï¼Œå…¨é¢ä¿éšœé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§" class="headerlink" title="1. å®ç°å¤šç§é«˜å¹¶å‘ç§’æ€ç­–ç•¥ï¼Œæ”¯æŒåŒæ­¥ä¸å¼‚æ­¥åŒé€šé“ï¼Œæ¶µç›–SychronizedåŒæ­¥é”ã€æ•°æ®åº“ä¹è§‚é”ã€Redissonåˆ†å¸ƒå¼é”ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–ï¼Œå…¨é¢ä¿éšœé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§"></a>1. å®ç°å¤šç§é«˜å¹¶å‘ç§’æ€ç­–ç•¥ï¼Œæ”¯æŒåŒæ­¥ä¸å¼‚æ­¥åŒé€šé“ï¼Œæ¶µç›–SychronizedåŒæ­¥é”ã€æ•°æ®åº“ä¹è§‚é”ã€Redissonåˆ†å¸ƒå¼é”ã€RabbitMQæ¶ˆæ¯é˜Ÿåˆ—ã€Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–ï¼Œå…¨é¢ä¿éšœé«˜å¹¶å‘åœºæ™¯ä¸‹çš„æ•°æ®ä¸€è‡´æ€§</h2><h3 id="1-1-åˆ†åˆ«ä»‹ç»ä½ çš„è¿™äº›æ›´æ–°ç­–ç•¥æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#1-1-åˆ†åˆ«ä»‹ç»ä½ çš„è¿™äº›æ›´æ–°ç­–ç•¥æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="1.1 åˆ†åˆ«ä»‹ç»ä½ çš„è¿™äº›æ›´æ–°ç­–ç•¥æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>1.1 åˆ†åˆ«ä»‹ç»ä½ çš„è¿™äº›æ›´æ–°ç­–ç•¥æ€ä¹ˆå®ç°çš„ï¼Ÿ</h3><h4 id="1-1-1-SychronizedåŒæ­¥é”"><a href="#1-1-1-SychronizedåŒæ­¥é”" class="headerlink" title="1.1.1 SychronizedåŒæ­¥é”"></a>1.1.1 SychronizedåŒæ­¥é”</h4><p><strong>ä¸€ã€synchronized æ˜¯æ€ä¹ˆç”¨çš„ï¼Ÿ</strong><br>åœ¨ <code>SynchronizedLockStrategy</code> ç­–ç•¥ç±»ä¸­ï¼Œsynchronized è¢«ç”¨äº æŒ‰å•†å“ç²’åº¦åŠ é”ï¼Œ<strong>æ§åˆ¶å¯¹åŒä¸€ä¸ªå•†å“çš„å¹¶å‘è¯·æ±‚</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (seckillIdList.get(seckillId)) &#123;<br>    <span class="hljs-comment">// æ ¸å¿ƒç§’æ€é€»è¾‘ï¼ˆæ‰£åº“å­˜ + è®°å½•ç§’æ€æˆåŠŸä¿¡æ¯ï¼‰</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆå§‹åŒ–é”å¯¹è±¡ï¼ˆæŒ‰å•†å“ ID åˆ†é…ä¸€æŠŠé”ï¼‰</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">seckillMonitor</span> <span class="hljs-operator">=</span> seckillIdList.get(seckillId);<br><span class="hljs-keyword">if</span> (seckillMonitor == <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();<br>    seckillIdList.put(seckillId, value);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>äºŒã€é”åŠ åœ¨äº†å“ªé‡Œï¼Ÿ</strong><br>é”åŠ åœ¨äº† <code>ConcurrentHashMap&lt;Long, Object&gt; seckillIdList</code> ä¸­çš„ <strong>å•†å“ ID å¯¹åº”çš„é”å¯¹è±¡</strong> ä¸Šï¼š</p>
<ul>
<li>æ¯ä¸ªå•†å“ ID æœ‰ä¸€æŠŠç‹¬ç«‹çš„é”ã€‚</li>
<li>åŒä¸€æ—¶é—´å†…ï¼Œ<strong>åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒä¸€ä¸ªå•†å“çš„ç§’æ€é€»è¾‘</strong>ã€‚<br><strong>æ€»ç»“ï¼šå¯¹æ¯ä¸ªå•†å“è¿›è¡Œå•ç‹¬çš„åŠ é”</strong></li>
</ul>
<p><strong>ä¸‰ã€å®ƒè§£å†³äº†ç§’æ€ä¸­çš„å“ªäº›é—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>é«˜å¹¶å‘ä¸‹<strong>åº“å­˜è¶…å–</strong>ï¼š	åŒæ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰£åº“å­˜</li>
<li>å¤šçº¿ç¨‹<strong>é‡å¤ä¸‹å•</strong>ï¼š 	åŒæ­¥é”ä¿éšœåŒä¸€å•†å“åªè¢«ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹</li>
<li>æ•°æ®ä¸ä¸€è‡´ï¼š	æ‰£åº“å­˜ + è®°å½•æˆåŠŸä¿¡æ¯åœ¨ä¸€ä¸ªé”å†…ï¼Œä¿è¯åŸå­æ€§</li>
</ul>
<p><strong>å››ã€ä½†å®ƒæœ‰ä»€ä¹ˆå±€é™ï¼Ÿ</strong></p>
<ul>
<li>åªé€‚åˆå•æœºï¼š	synchronized æ˜¯ JVM å†…éƒ¨é”ï¼Œä¸é€‚ç”¨äºå¤šå°æœåŠ¡å™¨éƒ¨ç½²</li>
<li>æ€§èƒ½å·®	åœ¨é«˜å¹¶å‘ä¸‹ä¼šå¯¼è‡´çº¿ç¨‹ç­‰å¾…ï¼Œååé‡ä½</li>
</ul>
<p><strong>æ€»ç»“ä¸€å¥è¯ï¼š</strong><br>synchronized åŒæ­¥é”åœ¨ GoodsKill ä¸­<strong>åŠ åœ¨äº† å•†å“ ID æ˜ å°„çš„é”å¯¹è±¡ä¸Š</strong>ï¼Œç”¨äºæ§åˆ¶æ¯ä¸ªå•†å“çš„å¹¶å‘è¯·æ±‚ï¼Œè§£å†³äº†<strong>å¹¶å‘ä¸‹çš„åº“å­˜è¶…å–å’Œé‡å¤ä¸‹å•é—®é¢˜</strong>ï¼Œä½†ä»…é€‚åˆå•æœºéƒ¨ç½²çš„ç§’æ€ç³»ç»Ÿã€‚</p>
<h4 id="1-1-2-æ•°æ®åº“ä¹è§‚é”"><a href="#1-1-2-æ•°æ®åº“ä¹è§‚é”" class="headerlink" title="1.1.2 æ•°æ®åº“ä¹è§‚é”"></a>1.1.2 æ•°æ®åº“ä¹è§‚é”</h4><p><strong>ä¸€ã€ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ</strong><br>ä¹è§‚é”æ˜¯ä¸€ç§å¹¶å‘æ§åˆ¶ç­–ç•¥ï¼Œå®ƒå‡è®¾<strong>å¤šä¸ªäº‹åŠ¡å¹¶å‘æ“ä½œæ—¶ä¸ä¼šå‘ç”Ÿå†²çª</strong>ï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®æ—¶ä¸åŠ é”ã€‚<strong>åªæœ‰åœ¨æ›´æ–°æ•°æ®æ—¶æ‰æ£€æŸ¥æ•°æ®æœ‰æ²¡æœ‰è¢«å…¶ä»–äº‹åŠ¡ä¿®æ”¹</strong>ã€‚</p>
<p><strong>äºŒã€GoodsKill ä¸­çš„ä¹è§‚é”ä½¿ç”¨åœºæ™¯</strong></p>
<p><strong>è§£å†³è¶…å–é—®é¢˜</strong>ï¼šåœ¨ ç§’æ€æ“ä½œ â†’ å‡åº“å­˜ è¿™ä¸ªæµç¨‹ä¸­ï¼Œå¦‚æœå¤šä¸ªç”¨æˆ·åŒæ—¶æŠ¢è´­åŒä¸€ä¸ªå•†å“ï¼Œè€Œæ²¡æœ‰å¹¶å‘æ§åˆ¶ï¼Œä¼šå¯¼è‡´åº“å­˜è¢«å‡æˆè´Ÿæ•°ï¼Œå³â€œ<strong>è¶…å–</strong>â€ã€‚</p>
<p>ä¹è§‚é”çš„ä½œç”¨å°±æ˜¯ï¼šåœ¨æ›´æ–°åº“å­˜æ—¶æ ¡éªŒåº“å­˜æ˜¯å¦ä»æ˜¯â€œé¢„æœŸå€¼â€ï¼Œå¦‚æœä¸æ˜¯ï¼Œè¯´æ˜åº“å­˜å·²ç»è¢«åˆ«çš„çº¿ç¨‹æ”¹è¿‡äº†ï¼Œå°±æ”¾å¼ƒæ›´æ–°ï¼Œé˜²æ­¢é”™è¯¯å‡åº“å­˜ã€‚</p>
<p><strong>ä¸‰ã€å®ç°æ–¹å¼ï¼ˆæºç åˆ†æï¼‰</strong><br>åœ¨ <code>SeckillServiceImpl</code>çš„<code>reduceNumberInner</code>æ–¹æ³•ä¸­:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//çœŸæ­£å‡åº“å­˜ï¼šæ’å…¥ç§’æ€è®°å½•ï¼Œç„¶åæ›´æ–°åº“å­˜ï¼ˆå¸¦æ¡ä»¶é™åˆ¶ï¼‰ã€‚æ›´æ–°å¤±è´¥ä¼šæŠ›å‡ºâ€œæ´»åŠ¨å·²ç»“æŸâ€å¼‚å¸¸ã€‚</span><br>    <span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">reduceNumberInner</span><span class="hljs-params">(SuccessKilledDTO successKilled)</span> &#123;<br>        <span class="hljs-type">SuccessKilled</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(successKilled, SuccessKilled.class);<br>        successKilledMapper.insert(entity);<br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Seckill</span>();<br>        wrapper.setSeckillId(entity.getSeckillId());<br>        UpdateWrapper&lt;Seckill&gt; updateWrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>(wrapper);<br>        updateWrapper.gt(<span class="hljs-string">&quot;end_time&quot;</span>, entity.getCreateTime());<br>        updateWrapper.lt(<span class="hljs-string">&quot;start_time&quot;</span>, entity.getCreateTime());<br>        updateWrapper.gt(<span class="hljs-string">&quot;number&quot;</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// ä¹è§‚é”æ ¡éªŒç‚¹ï¼šåº“å­˜å¿…é¡»å¤§äº 0</span><br>        updateWrapper.setSql(<span class="hljs-string">&quot;number = number - 1&quot;</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">update</span> <span class="hljs-operator">=</span> baseMapper.update(<span class="hljs-literal">null</span>, updateWrapper);<br>        <span class="hljs-keyword">if</span> (update &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillCloseException</span>(<span class="hljs-string">&quot;seckill is closed&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> update;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>å•†å“åº“å­˜ number &gt; 0</li>
<li>å¦‚æœæ»¡è¶³æ¡ä»¶ï¼Œåˆ™æ‰§è¡Œ SQLï¼šUPDATE seckill SET number &#x3D; number - 1</li>
<li>å¦‚æœ update &#x3D;&#x3D; 0ï¼Œè¯´æ˜ï¼šåº“å­˜å·²ç»è¢«æŠ¢å®Œäº†ï¼Œæˆ–è€…æ•°æ®è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº† â†’ å½“å‰çº¿ç¨‹æ›´æ–°å¤±è´¥ï¼ˆç§’æ€å¤±è´¥ï¼‰ã€‚</li>
</ul>
<p><strong>å››ã€æ€»ç»“</strong>ï¼š<br>GoodsKill ä½¿ç”¨ä¹è§‚é”ç­–ç•¥ï¼Œç¡®ä¿åœ¨é«˜å¹¶å‘ä¸‹åª<strong>æœ‰åœ¨åº“å­˜ä»ç„¶å¤§äº 0 æ—¶æ‰å…è®¸å‡åº“å­˜</strong>ï¼Œä»è€Œ<strong>æœ‰æ•ˆé˜²æ­¢è¶…å–å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜</strong>ï¼ŒåŒæ—¶ä¿æŒç³»ç»Ÿé«˜æ€§èƒ½è¿è¡Œã€‚</p>
<h4 id="1-1-3-Redissonåˆ†å¸ƒå¼é”"><a href="#1-1-3-Redissonåˆ†å¸ƒå¼é”" class="headerlink" title="1.1.3 Redissonåˆ†å¸ƒå¼é”"></a>1.1.3 Redissonåˆ†å¸ƒå¼é”</h4><p><strong>ä¸€ã€Redisson åˆ†å¸ƒå¼é”åŠ åœ¨äº†å“ªé‡Œï¼Ÿ</strong></p>
<p>åœ¨ç­–ç•¥ç±» <code>RedissonStrategy</code> ä¸­ä½¿ç”¨çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedissonClient redissonClient;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    ä¸ºå½“å‰å•†å“è·å–ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼ˆé”åä¸ºå•†å“ ID çš„å­—ç¬¦ä¸²ï¼‰ã€‚</span><br><span class="hljs-comment">    ä½¿ç”¨çš„æ˜¯ å¯é‡å…¥é” RLockï¼Œå¤šä¸ªèŠ‚ç‚¹ä¸‹çš„å¹¶å‘ç”¨æˆ·éƒ½ä¼šç«äº‰è¿™ä¸ªé”ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œä¸‹é¢çš„é€»è¾‘ã€‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(requestDto.getSeckillId() + <span class="hljs-string">&quot;&quot;</span>);<br>        lock.lock();<br>        <span class="hljs-keyword">try</span> &#123;<br>            seckillExecutor.dealSeckill(requestDto.getSeckillId(), requestDto.getPhoneNumber(), REDISSION_LOCK.getName(), requestDto.getTaskId());<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            lock.unlock();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>getLock(requestDto.getSeckillId() + â€œâ€) æ˜¯ä¸º æ¯ä¸ªå•†å“ ID åŠ¨æ€ç”Ÿæˆä¸€æŠŠåˆ†å¸ƒå¼é”ã€‚</li>
<li><strong>åŠ é”ç²’åº¦æ˜¯ï¼šå•†å“çº§åˆ«</strong>ï¼Œæ¯ä¸ªå•†å“ ID æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„é”ã€‚</li>
<li>ä½¿ç”¨çš„æ˜¯ Redisson æä¾›çš„ <strong>RLock åˆ†å¸ƒå¼å¯é‡å…¥é”</strong>ï¼ˆåŸºäº Redis å®ç°ï¼‰ã€‚</li>
</ul>
<p><strong>äºŒã€å®ƒè§£å†³äº†ç§’æ€ä¸­çš„å“ªäº›æ ¸å¿ƒé—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>åˆ†å¸ƒå¼ç¯å¢ƒå¹¶å‘æ§åˆ¶	å¤šå°æœåŠ¡å™¨éƒ¨ç½²æ—¶ï¼Œ<strong>ç¡®ä¿æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å¤„ç†æŸä¸ªå•†å“çš„ç§’æ€é€»è¾‘</strong></li>
<li>é¿å…è¶…å–ï¼š	é€šè¿‡å¯¹åº“å­˜æ‰£å‡åŠ é”ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰£åº“å­˜å¯¼è‡´è¶…å–</li>
<li>ä¿è¯åº“å­˜ä¸€è‡´æ€§ï¼š	ä¿è¯åœ¨æ‰§è¡Œç§’æ€é€»è¾‘ï¼ˆå‡åº“å­˜ã€å†™æˆåŠŸè®°å½•ï¼‰æ—¶æ•°æ®ä¸€è‡´æ€§</li>
<li>æ›¿ä»£ synchronizedï¼š	synchronized åªåœ¨å•æœºæœ‰æ•ˆï¼Œè€Œ Redisson é€‚ç”¨äºé›†ç¾¤ç¯å¢ƒ</li>
</ul>
<p><strong>ä¸‰ã€å¦‚ä½•æµ‹è¯•æ¯”è¾ƒSynchronizedLockå’ŒRedissonLock</strong><br>âœ… å•æœºæµ‹è¯•ï¼ˆä½¿ç”¨ SynchronizedLockï¼‰</p>
<ol>
<li>ä½¿ç”¨å¤šçº¿ç¨‹å¹¶å‘æ¨¡æ‹Ÿ 1000 ä¸ªçº¿ç¨‹è®¿é—®åŒä¸€èµ„æº</li>
<li>æ£€æŸ¥å¹¶å‘å®‰å…¨æ€§ã€è€—æ—¶</li>
</ol>
<p>âœ… é›†ç¾¤æµ‹è¯•ï¼ˆä½¿ç”¨ RedissonLockï¼‰</p>
<ol>
<li>éƒ¨ç½²åˆ°å¤šä¸ª Tomcat èŠ‚ç‚¹æˆ–ç”¨ <strong>Spring Boot æ¨¡æ‹Ÿé›†ç¾¤</strong></li>
<li>ä½¿ç”¨ Redis é…ç½® Redisson åˆ†å¸ƒå¼é”</li>
<li><strong>ä½¿ç”¨ JMeter</strong> &#x2F; Apache Bench æ¨¡æ‹Ÿå¹¶å‘è¯·æ±‚</li>
<li>æ£€æŸ¥é”ç«äº‰ä¸‹çš„æ­£ç¡®æ€§ã€å“åº”æ—¶é—´ã€Redis å‹åŠ›</li>
</ol>
<p><strong>æ€»ç»“ä¸€å¥è¯ï¼š</strong></p>
<p>åœ¨ GoodsKill é¡¹ç›®ä¸­ï¼ŒRedisson åˆ†å¸ƒå¼é”è¢«<strong>åŠ åœ¨æ¯ä¸ªå•†å“ ID çš„é”å¯¹è±¡</strong>ä¸Šï¼Œç”¨äº<strong>æ§åˆ¶åˆ†å¸ƒå¼ç¯å¢ƒä¸­åŒä¸€å•†å“çš„å¹¶å‘ç§’æ€è¯·æ±‚</strong>ï¼Œä»è€Œæœ‰æ•ˆ<strong>é˜²æ­¢åº“å­˜è¶…å–ã€æ•°æ®é”™ä¹±ã€ç§’æ€å¼‚å¸¸ç­‰é—®é¢˜</strong>ï¼Œæ˜¯åº”å¯¹é«˜å¹¶å‘åœºæ™¯ä¸‹è·¨èŠ‚ç‚¹ç§’æ€æ“ä½œçš„å…³é”®æ‰‹æ®µä¹‹ä¸€ã€‚</p>
<h4 id="1-1-4-RabbitMQæ¶ˆæ¯é˜Ÿåˆ—"><a href="#1-1-4-RabbitMQæ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="1.1.4 RabbitMQæ¶ˆæ¯é˜Ÿåˆ—"></a>1.1.4 RabbitMQæ¶ˆæ¯é˜Ÿåˆ—</h4><p><strong>ä¸€ã€RabbitMQåœ¨ç§’æ€ä¸­çš„å®ç°æ–¹å¼</strong></p>
<p>æ­¥éª¤ 1ï¸âƒ£ï¼š<strong>ç§’æ€è¯·æ±‚å…¥é˜Ÿ</strong><br>åœ¨ç”¨æˆ·å‘èµ·ç§’æ€è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šï¼š</p>
<ul>
<li>ç”Ÿæˆä¸€ä¸ªè¯·æ±‚å¯¹è±¡ï¼ˆåŒ…æ‹¬ç”¨æˆ·æ‰‹æœºå·ã€å•†å“IDã€ä»»åŠ¡IDç­‰ï¼‰ï¼›</li>
<li>å°†å…¶åºåˆ—åŒ–æˆ JSONï¼›</li>
<li>å‘é€åˆ° RabbitMQ æŒ‡å®šä¸»é¢˜ï¼ˆå¦‚ â€œgoodskill-RabbitMQâ€ï¼‰ä¸­ã€‚</li>
</ul>
<p>æ­¥éª¤ 2ï¸âƒ£ï¼š<strong>æ¶ˆè´¹è€…å¼‚æ­¥å¤„ç†</strong><br>åœ¨åç«¯ï¼ŒRabbitMQ æ¶ˆè´¹è€…ï¼ˆå¦‚ SeckillRabbitmqConsumer ç±»ï¼‰é€šè¿‡ @RabbitmqListener ç›‘å¬è¯¥ä¸»é¢˜ï¼š</p>
<ul>
<li>æ‹¿åˆ°æ¶ˆæ¯åååºåˆ—åŒ–ï¼›</li>
<li>è°ƒç”¨æ ¸å¿ƒç§’æ€é€»è¾‘ï¼ˆå¦‚åˆ¤æ–­åº“å­˜ã€é”å®šã€æ‰£å‡ã€ä¸‹å•ç­‰ï¼‰ï¼›</li>
<li>å®Œæˆä¸šåŠ¡å¤„ç†å¹¶è®°å½•æ—¥å¿—æˆ–çŠ¶æ€ã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillKafkaConsumer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> SeckillExecutor seckillExecutor;<br><br>    <span class="hljs-meta">@KafkaListener(topics = &quot;goodskill-kafka&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(Object data)</span> &#123;<br>       <span class="hljs-comment">// è§£æå¹¶å¤„ç†ç§’æ€è¯·æ±‚</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ­¥éª¤ 3ï¸âƒ£ï¼šçº¿ç¨‹æ± å¹¶å‘æ¨¡æ‹Ÿï¼ˆå‹æµ‹ï¼‰<br>åœ¨æ¨¡æ‹Ÿåœºæ™¯ä¸­ï¼Œç³»ç»Ÿä½¿ç”¨çº¿ç¨‹æ± åŒæ—¶å¹¶å‘è§¦å‘ RabbitMQ æ¶ˆæ¯å‘é€ï¼Œæ¨¡æ‹Ÿå¤§è§„æ¨¡ç”¨æˆ·æŠ¢è´­ï¼Œè¾¾åˆ°å‹æµ‹ç›®çš„ã€‚</p>
<p><strong>äºŒã€è§£å†³äº†å“ªäº›ç§’æ€ä¸­çš„æ ¸å¿ƒé—®é¢˜ï¼Ÿ</strong></p>
<ul>
<li>é«˜å¹¶å‘ç¬æ—¶æµé‡ï¼š	MQ å……å½“ç¼“å†²å±‚ï¼Œæ¶ˆæ¯æ’é˜Ÿåç”±æ¶ˆè´¹è€…æœ‰åºå¤„ç†ï¼Œå‰Šå³°å¡«è°·</li>
<li>è¯·æ±‚å“åº”æ…¢ï¼š	å‰ç«¯å¿«é€Ÿå“åº”â€œè¯·æ±‚å·²æ¥æ”¶â€ï¼Œå®é™…å¤„ç†å¼‚æ­¥è¿›è¡Œï¼Œæé«˜ç”¨æˆ·ä½“éªŒ</li>
<li>æ•°æ®åº“å‹åŠ›å¤§ï¼š	<strong>å‡å°‘ç¬æ—¶å†™å…¥å‹åŠ›</strong>ï¼Œé¿å…æ•°æ®åº“è¿æ¥çˆ†ç‚¸</li>
</ul>
<p><strong>å°ç»“ä¸€å¥è¯</strong><br>RabbitMQ åœ¨ç§’æ€ç³»ç»Ÿä¸­æ˜¯ é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å…³é”®ä¸­é—´ä»¶ï¼Œé€šè¿‡å¼‚æ­¥ã€å‰Šå³°ã€è§£è€¦ã€æ‰©å±•æ€§å¼ºç­‰ç‰¹æ€§ï¼Œæœ‰æ•ˆè§£å†³äº†ä¼ ç»ŸåŒæ­¥å¤„ç†æ¶æ„åœ¨ç§’æ€åœºæ™¯ä¸­é‡åˆ°çš„æ€§èƒ½ç“¶é¢ˆå’Œç³»ç»Ÿç¨³å®šæ€§é—®é¢˜ã€‚</p>
<h4 id="1-1-5-Redis-è®¡æ•°-MongoDB-å¼‚æ­¥æŒä¹…åŒ–"><a href="#1-1-5-Redis-è®¡æ•°-MongoDB-å¼‚æ­¥æŒä¹…åŒ–" class="headerlink" title="1.1.5 Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–"></a>1.1.5 Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–</h4><p><code>RedisMongoReactiveStrategy</code>ç±»</p>
<p><strong>ä½¿ç”¨Redisè¿›è¡Œç§’æ€å•†å“å‡åº“å­˜æ“ä½œï¼Œç§’æ€ç»“æŸåå¼‚æ­¥å‘é€MQï¼Œä½¿ç”¨MongoDBå®Œæˆæ•°æ®è½åœ°</strong></p>
<p><strong>æ ¸å¿ƒé€»è¾‘</strong></p>
<ul>
<li>Redis è®¡æ•°ï¼šåˆ©ç”¨ Redis çš„åŸå­æ€§æ“ä½œï¼ˆå¦‚ INCR æˆ– DECRï¼‰æ¥å¿«é€Ÿæ‰£å‡åº“å­˜ï¼Œè®°å½•ç§’æ€æˆåŠŸçš„è¯·æ±‚ã€‚<ul>
<li>å¯¹ Redis ä¸­çš„å•†å“ç§’æ€è®¡æ•°è¿›è¡Œ +1ï¼›</li>
<li>è‹¥è®¡æ•° &lt;&#x3D; åº“å­˜ï¼Œåˆ™ç§’æ€æˆåŠŸï¼›</li>
<li>å‘é€ç§’æ€æˆåŠŸæ¶ˆæ¯ï¼ˆåŒ…å«æ‰‹æœºå·ã€å•†å“IDã€æ³¨é‡Šç­‰ï¼‰åˆ°ç»‘å®šé€šé“ï¼Œå¼‚æ­¥è½åº“ MongoDBï¼ˆå³â€œæœ€ç»ˆå†™å…¥æ•°æ®åº“â€ï¼‰ã€‚</li>
</ul>
</li>
<li>MongoDB å¼‚æ­¥æŒä¹…åŒ–ï¼šå°†ç§’æ€æˆåŠŸçš„è®¢å•æ•°æ®å¼‚æ­¥å†™å…¥ MongoDBï¼Œé¿å…æ•°æ®åº“æ“ä½œé˜»å¡ä¸»æµç¨‹ã€‚</li>
</ul>
<p><strong>å¼‚æ­¥æŒä¹…åŒ–æµç¨‹</strong></p>
<ul>
<li><strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼šé¡¹ç›®ä½¿ç”¨ Spring Cloud Streamï¼ˆé»˜è®¤ç»‘å®š RabbitMQ æˆ– Kafkaï¼‰ä½œä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ã€‚StreamBridge å°†è®¢å•æ•°æ®ï¼ˆSeckillMockSaveVoï¼‰å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ seckillMongoSave é€šé“ã€‚</li>
<li><strong>è®¢å•æœåŠ¡æ¶ˆè´¹</strong>ï¼šgoodskill-order-provider æ¨¡å—çš„ OrderApplication é…ç½®äº†ä¸€ä¸ªæ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œç›‘å¬ seckillMongoSave é€šé“ï¼Œæ¥æ”¶æ¶ˆæ¯åå°†è®¢å•æ•°æ®ä¿å­˜åˆ° MongoDBã€‚</li>
</ul>
<p><strong>è§£å†³äº†ç§’æ€ä¸­çš„å“ªäº›é—®é¢˜</strong></p>
<ol>
<li>é«˜å¹¶å‘ä¸‹çš„æ€§èƒ½ç“¶é¢ˆ<ul>
<li>é—®é¢˜ï¼šä¼ ç»Ÿç§’æ€ç³»ç»Ÿä¸­ï¼Œåº“å­˜æ‰£å‡å’Œè®¢å•å†™å…¥é€šå¸¸ç›´æ¥æ“ä½œå…³ç³»å‹æ•°æ®åº“ï¼ˆå¦‚ MySQLï¼‰ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œæ•°æ®åº“çš„é”ç«äº‰å’Œ I&#x2F;O æ“ä½œä¼šå¯¼è‡´æ€§èƒ½ç“¶é¢ˆï¼Œç”šè‡³å¼•å‘æ•°æ®åº“å®•æœºã€‚</li>
<li>è§£å†³æ–¹æ¡ˆï¼š<ul>
<li>Redis è®¡æ•°ï¼š<strong>å°†åº“å­˜æ‰£å‡æ“ä½œç§»åˆ° Redis</strong>ï¼Œ<strong>å†…å­˜æ“ä½œé€Ÿåº¦è¿œè¶…æ•°æ®åº“</strong>ï¼Œå•èŠ‚ç‚¹ Redis å¯å¤„ç†æ•°ä¸‡ QPSï¼Œæå¤§æå‡äº†å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</li>
<li>å¼‚æ­¥æŒä¹…åŒ–ï¼šè®¢å•å†™å…¥ MongoDB çš„æ“ä½œé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œï¼Œä¸»æµç¨‹æ— éœ€ç­‰å¾…æ•°æ®åº“å“åº”ï¼Œå“åº”æ—¶é—´ä»æ¯«ç§’çº§é™åˆ°å¾®ç§’çº§ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>è¶…å–é—®é¢˜</strong><ul>
<li>é—®é¢˜ï¼šåœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¤šä¸ªè¯·æ±‚å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒçš„åº“å­˜å€¼ï¼Œå¯¼è‡´åº“å­˜æ‰£å‡ä¸å‡†ç¡®ï¼Œå‡ºç°è¶…å–ï¼ˆå–å‡ºæ•°é‡è¶…è¿‡å®é™…åº“å­˜ï¼‰</li>
<li>è§£å†³æ–¹æ¡ˆï¼š<ul>
<li><strong>Redis åŸå­æ“ä½œ</strong>ï¼šä½¿ç”¨ DECR å‘½ä»¤ç¡®ä¿åº“å­˜æ‰£å‡æ˜¯åŸå­æ€§çš„ï¼Œ<strong>åªæœ‰å½“åº“å­˜å¤§äº 0 æ—¶æ‰å…è®¸æ‰£å‡ï¼Œå½»åº•é¿å…è¶…å–</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>æ•°æ®åº“å‹åŠ›è¿‡å¤§<ul>
<li>é—®é¢˜ï¼šç§’æ€åœºæ™¯ä¸‹ï¼ŒçŸ­æ—¶é—´å†…å¤§é‡è®¢å•å†™å…¥ä¼šå¯¼è‡´æ•°æ®åº“å‹åŠ›æ¿€å¢ï¼Œå¯èƒ½å¼•å‘è¿æ¥æ± è€—å°½æˆ–æ…¢æŸ¥è¯¢ã€‚</li>
<li>è§£å†³æ–¹æ¡ˆï¼š<ul>
<li>MongoDB å¼‚æ­¥å†™å…¥ï¼šMongoDB æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ NoSQL æ•°æ®åº“ï¼Œ<strong>é€‚åˆé«˜ååå†™å…¥åœºæ™¯</strong>ã€‚é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å†™å…¥ï¼Œè®¢å•æ•°æ®é€æ­¥æŒä¹…åŒ–ï¼Œå¹³æ»‘äº†æ•°æ®åº“çš„ç¬æ—¶å‹åŠ›ã€‚</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—ç¼“å†²ï¼š<strong>æ¶ˆæ¯é˜Ÿåˆ—ä½œä¸ºç¼“å†²å±‚</strong>ï¼Œå¸æ”¶äº†é«˜å¹¶å‘è¯·æ±‚çš„å³°å€¼æµé‡ï¼Œè®¢å•æœåŠ¡å¯ä»¥æŒ‰è‡ªèº«èŠ‚å¥æ¶ˆè´¹æ¶ˆæ¯ï¼Œé¿å…æ•°æ®åº“ç›´æ¥é¢å¯¹æµé‡æ´ªå³°ã€‚</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Redis + MongoDB å“åº”å¼ç§’æ€ç­–ç•¥å®ç°</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * è¯¥ç±»ä½¿ç”¨çº¿ç¨‹æ± å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚ï¼Œç»“åˆ Redis è¿›è¡Œåº“å­˜æ§åˆ¶ï¼Œ</span><br><span class="hljs-comment"> * ç§’æ€æˆåŠŸåé€šè¿‡ StreamBridge å¼‚æ­¥å†™å…¥ MongoDBï¼Œé¿å…é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›è¿‡å¤§ï¼›</span><br><span class="hljs-comment"> * å½“åº“å­˜è€—å°½æ—¶ï¼Œç»“åˆçŠ¶æ€æœºè¿›è¡ŒçŠ¶æ€æ›´æ–°ï¼Œå¹¶å‘é€â€œæ´»åŠ¨ç»“æŸâ€æ¶ˆæ¯é€šçŸ¥å…¶ä»–æ¨¡å—ã€‚</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * æŠ€æœ¯ç‚¹ï¼šçº¿ç¨‹æ±  + Redis + Mongo + StreamBridge + çŠ¶æ€æœº</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisMongoReactiveStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GoodsKillStrategy</span> &#123;<br><br>    <span class="hljs-comment">// Redis ç¼“å­˜æœåŠ¡ï¼Œå°è£…äº†ç§’æ€å•†å“ä¿¡æ¯çš„è·å–ä¸å­˜å‚¨</span><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisService redisService;<br><br>    <span class="hljs-comment">// Redis åŸç”Ÿæ“ä½œå·¥å…·ï¼Œç”¨äºåº“å­˜è®¡æ•°ï¼ˆè‡ªå¢ï¼‰</span><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;<br><br>    <span class="hljs-comment">// å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± ï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡ï¼Œæå‡ç³»ç»Ÿååé‡</span><br>    <span class="hljs-meta">@Resource(name = &quot;taskExecutor&quot;)</span><br>    <span class="hljs-keyword">private</span> ThreadPoolExecutor taskExecutor;<br><br>    <span class="hljs-comment">// æ¶ˆæ¯å‘é€å™¨ï¼Œç”¨äºå‘ç»‘å®šé€šé“å‘é€æ¶ˆæ¯ï¼ˆå¦‚ï¼šä¿å­˜è®¢å•ï¼Œé€šçŸ¥æ´»åŠ¨ç»“æŸï¼‰</span><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StreamBridge streamBridge;<br><br>    <span class="hljs-comment">// çŠ¶æ€æœºæœåŠ¡ï¼Œæ§åˆ¶æ´»åŠ¨çŠ¶æ€ï¼ˆå¦‚ï¼šè¿›è¡Œä¸­ã€å·²ç»“æŸï¼‰</span><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StateMachineService stateMachineService;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ¥æ”¶ç§’æ€è¯·æ±‚ï¼Œäº¤ç”±çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œä¸»é€»è¾‘</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> requestDto ç§’æ€è¯·æ±‚å‚æ•°ï¼ˆåŒ…å«ç§’æ€IDã€æ‰‹æœºå·ã€ä»»åŠ¡IDç­‰ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        taskExecutor.execute(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                doExecute(requestDto);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;ç§’æ€å¤±è´¥&quot;</span>, e);<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰§è¡Œå…·ä½“çš„ç§’æ€å¤„ç†é€»è¾‘</span><br><span class="hljs-comment">     * 1. Redis ä¸­è¿›è¡Œåº“å­˜é€’å¢åˆ¤æ–­æ˜¯å¦æˆåŠŸ</span><br><span class="hljs-comment">     * 2. ç§’æ€æˆåŠŸï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å‘é€ä¿å­˜è®¢å•ä¿¡æ¯</span><br><span class="hljs-comment">     * 3. ç§’æ€å¤±è´¥ï¼šåˆ¤æ–­æ˜¯å¦å·²ç»“æŸå¹¶è§¦å‘çŠ¶æ€æœºæ›´æ–°ï¼ŒåŒæ—¶å¹¿æ’­æ´»åŠ¨ç»“æŸé€šçŸ¥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doExecute</span><span class="hljs-params">(SeckillMockRequestDTO requestDto)</span> &#123;<br>        <span class="hljs-type">long</span> <span class="hljs-variable">seckillId</span> <span class="hljs-operator">=</span> requestDto.getSeckillId();<br><br>        <span class="hljs-comment">// ä» Redis è·å–ç§’æ€å•†å“è¯¦æƒ…</span><br>        <span class="hljs-type">Seckill</span> <span class="hljs-variable">seckill</span> <span class="hljs-operator">=</span> redisService.getSeckill(seckillId);<br><br>        <span class="hljs-comment">// å°è¯•ä½¿ç”¨ Redis è‡ªå¢æ¨¡æ‹Ÿåº“å­˜æ‰£å‡æ“ä½œ</span><br>        <span class="hljs-keyword">if</span> (redisTemplate.opsForValue().increment(String.valueOf(seckillId)) &lt;= seckill.getNumber()) &#123;<br><br>            <span class="hljs-comment">// ç§’æ€æˆåŠŸï¼šé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å°†è®¢å•å†™å…¥ MongoDB</span><br>            taskExecutor.execute(() -&gt;<br>                streamBridge.send(DEFAULT_BINDING_NAME_MONGO_SAVE, MessageBuilder.withPayload(<br>                        SeckillMockSaveVo.builder()<br>                                .seckillId(seckillId)<br>                                .userPhone(requestDto.getPhoneNumber())<br>                                .note(REDIS_MONGO_REACTIVE.getName())<br>                                .build())<br>                        .build())<br>            );<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// ç§’æ€å¤±è´¥ï¼šåº“å­˜è¶…é™ï¼Œå¯èƒ½éœ€è¦å¹¿æ’­æ´»åŠ¨ç»“æŸ</span><br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) &#123;<br>                <span class="hljs-comment">// å†æ¬¡è·å– Redis ä¸­å•†å“çŠ¶æ€ï¼ˆé˜²æ­¢å¹¶å‘ä¸€è‡´æ€§é—®é¢˜ï¼‰</span><br>                seckill = redisService.getSeckill(seckillId);<br><br>                <span class="hljs-comment">// åˆ¤æ–­å½“å‰æ´»åŠ¨æ˜¯å¦ä»å¤„äºè¿›è¡Œä¸­</span><br>                <span class="hljs-keyword">if</span> (stateMachineService.checkState(seckillId, States.IN_PROGRESS)) &#123;<br>                    <span class="hljs-comment">// è§¦å‘çŠ¶æ€æœºäº‹ä»¶ï¼šè®¡ç®— -&gt; æ´»åŠ¨ç»“æŸ</span><br>                    stateMachineService.feedMachine(Events.ACTIVITY_CALCULATE, seckillId);<br><br>                    log.info(<span class="hljs-string">&quot;ç§’æ€å•†å“æš‚æ— åº“å­˜ï¼Œå‘é€æ´»åŠ¨ç»“æŸæ¶ˆæ¯ï¼&quot;</span>);<br><br>                    <span class="hljs-comment">// å‘é€æ´»åŠ¨ç»“æŸæ¶ˆæ¯ï¼ˆç”¨äºå‰ç«¯æç¤ºã€å…³é—­é¡µé¢ç­‰ï¼‰</span><br>                    streamBridge.send(DEFAULT_BINDING_NAME, MessageBuilder.withPayload(<br>                            SeckillMockResponseDTO.builder()<br>                                    .status(<span class="hljs-literal">true</span>)<br>                                    .seckillId(seckillId)<br>                                    .note(REDIS_MONGO_REACTIVE.getName())<br>                                    .taskId(requestDto.getTaskId())<br>                                    .build())<br>                            .build());<br><br>                    <span class="hljs-comment">// æ›´æ–° Redis ä¸­è¯¥å•†å“çŠ¶æ€ä¸ºâ€œç»“æŸâ€</span><br>                    seckill.setStatus(SeckillStatusConstant.END);<br>                    redisService.putSeckill(seckill);<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="1-2-å“ªäº›æ˜¯åŒæ­¥ï¼Œå“ªäº›æ˜¯å¼‚æ­¥ï¼Ÿ"><a href="#1-2-å“ªäº›æ˜¯åŒæ­¥ï¼Œå“ªäº›æ˜¯å¼‚æ­¥ï¼Ÿ" class="headerlink" title="1.2 å“ªäº›æ˜¯åŒæ­¥ï¼Œå“ªäº›æ˜¯å¼‚æ­¥ï¼Ÿ"></a>1.2 å“ªäº›æ˜¯åŒæ­¥ï¼Œå“ªäº›æ˜¯å¼‚æ­¥ï¼Ÿ</h3><p>ç³»ç»Ÿåœ¨å¤„ç†ç§’æ€è¯·æ±‚æ—¶ï¼Œæä¾›äº†ä¸¤ç§å¹¶è¡Œçš„å¤„ç†æ–¹å¼â€”â€”<strong>åŒæ­¥é€šé“å’Œå¼‚æ­¥é€šé“</strong></p>
<ul>
<li>åŒæ­¥é€šé“æ˜¯æŒ‡è¯·æ±‚çš„å¤„ç†æµç¨‹æ˜¯å®æ—¶çš„ã€<strong>é˜»å¡çš„</strong>,<strong>ç”¨æˆ·éœ€è¦ç­‰å¾…</strong>å¤„ç†å®Œæˆã€‚</li>
<li>å¼‚æ­¥é€šé“æ˜¯æŒ‡è¯·æ±‚çš„å¤„ç†æµç¨‹æ˜¯<strong>éé˜»å¡çš„</strong>ï¼Œç”¨æˆ·å‘å‡ºè¯·æ±‚åï¼Œç³»ç»Ÿç«‹å³è¿”å›ä¸€ä¸ªåˆæ­¥å“åº”, <strong>ç”¨æˆ·æ— éœ€ç­‰å¾…</strong>æ‰€æœ‰æ“ä½œå®Œæˆ</li>
</ul>
<p><strong>åŒæ­¥é€šé“çš„å®ç°</strong></p>
<ul>
<li>SynchronizedLockStrategyï¼šä½¿ç”¨ Java çš„ <strong>synchronized æœ¬åœ°é”</strong>ï¼ŒæŒ‰å•†å“ ID åŠ é”ï¼Œä¸²è¡Œå¤„ç†è¯·æ±‚ã€‚</li>
<li>AtomicUpdateStrategyï¼šé€šè¿‡æ•°æ®åº“çš„<strong>ä¹è§‚é”</strong>ï¼ˆå¦‚ UPDATE â€¦ WHERE stock &gt; 0ï¼‰å®ç°åº“å­˜æ‰£å‡ã€‚</li>
<li><strong>Redissonåˆ†å¸ƒå¼é”</strong></li>
</ul>
<p><strong>å¼‚æ­¥é€šé“çš„å®ç°</strong></p>
<ul>
<li>RabbitMQStrategyï¼šé€šè¿‡ <strong>RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—</strong>å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚ã€‚</li>
<li>RedisMongoReactiveStrategyï¼šä½¿ç”¨ Redis è®¡æ•°æ‰£å‡åº“å­˜ï¼Œé€šè¿‡<strong>æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å†™å…¥ MongoDB</strong></li>
</ul>
<h3 id="1-3-å¦‚ä½•æµ‹è¯•çš„è¿™äº›æ–¹æ³•ï¼Ÿ"><a href="#1-3-å¦‚ä½•æµ‹è¯•çš„è¿™äº›æ–¹æ³•ï¼Ÿ" class="headerlink" title="1.3 å¦‚ä½•æµ‹è¯•çš„è¿™äº›æ–¹æ³•ï¼Ÿ"></a>1.3 å¦‚ä½•æµ‹è¯•çš„è¿™äº›æ–¹æ³•ï¼Ÿ</h3><ol>
<li>sychronizedåŒæ­¥é”</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * é€šè¿‡åŒæ­¥é”æ§åˆ¶ç§’æ€å¹¶å‘ï¼ˆç§’æ€æœªå®Œæˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰</span><br><span class="hljs-comment">    * åœºæ™¯ä¸€ï¼šåˆå§‹åŒ–å½“å‰åº“å­˜ä¸º1000ï¼Œé€šè¿‡çº¿ç¨‹æ± è°ƒåº¦ï¼Œæ¨¡æ‹Ÿæ€»å…±æœ‰2000äººå‚ä¸ç§’æ€ï¼ŒæœŸæœ›å€¼ä¸ºæœ€åæˆåŠŸç¬”æ•°ä¸º1000</span><br><span class="hljs-comment">    * ç»“æœï¼šå¤šæ¬¡è¿è¡Œï¼Œæœ€ç»ˆçš„ç»“æœä¸º1000</span><br><span class="hljs-comment">    * æ€»ç»“ï¼šåŠ ä¸ŠåŒæ­¥é”å¯ä»¥è§£å†³ç§’æ€é—®é¢˜ï¼Œé€‚ç”¨äºå•æœºæ¨¡å¼ï¼Œæ‰©å±•æ€§å·®ã€‚</span><br><span class="hljs-comment">    */</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>redissonåˆ†å¸ƒå¼é”</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * é€šè¿‡åŒæ­¥é”æ§åˆ¶ç§’æ€å¹¶å‘ï¼ˆç§’æ€æœªå®Œæˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰</span><br><span class="hljs-comment"> * åœºæ™¯äºŒï¼šåˆå§‹åŒ–å½“å‰åº“å­˜ä¸º1000ï¼Œé€šè¿‡çº¿ç¨‹æ± è°ƒåº¦ï¼Œæ¨¡æ‹Ÿæ€»å…±æœ‰2000äººå‚ä¸ç§’æ€ï¼ŒæœŸæœ›å€¼ä¸ºæœ€åæˆåŠŸç¬”æ•°ä¸º1000</span><br><span class="hljs-comment"> * ç»“æœï¼šå¤šæ¬¡è¿è¡Œï¼Œæœ€ç»ˆçš„ç»“æœä¸º1000</span><br><span class="hljs-comment"> * æ€»ç»“ï¼šåŠ ä¸ŠåŒæ­¥é”å¯ä»¥è§£å†³ç§’æ€é—®é¢˜ï¼Œé€‚ç”¨äºåˆ†å¸ƒå¼ç¯å¢ƒï¼Œä½†é€Ÿåº¦ä¸å¦‚åŠ åŒæ­¥é”ã€‚</span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>RabbitMQæ¶ˆæ¯é˜Ÿåˆ—</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">   * å¼‚æ­¥ç§’æ€</span><br><span class="hljs-comment">   * åœºæ™¯ä¸‰ï¼šåˆå§‹åŒ–å½“å‰åº“å­˜ä¸º1000ï¼Œé€šè¿‡çº¿ç¨‹æ± è°ƒåº¦ï¼Œæ¨¡æ‹Ÿæ€»å…±æœ‰2000äººå‚ä¸ç§’æ€ï¼ŒæœŸæœ›å€¼ä¸ºæœ€åæˆåŠŸç¬”æ•°ä¸º1000</span><br><span class="hljs-comment">   * ç»“æœï¼šå¤šæ¬¡è¿è¡Œï¼Œæœ€ç»ˆçš„ç»“æœä¸º1000</span><br><span class="hljs-comment">   * æ€»ç»“ï¼šé€Ÿåº¦å¿«ã€‚</span><br><span class="hljs-comment">   */</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>æ•°æ®åº“ä¹è§‚é”</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é€šè¿‡åŒæ­¥é”æ§åˆ¶ç§’æ€å¹¶å‘ï¼Œç§’æ€è¿‡ç¨‹ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼ˆç§’æ€æœªå®Œæˆé˜»å¡ä¸»çº¿ç¨‹ï¼‰</span><br><span class="hljs-comment">     * åœºæ™¯äº”ï¼šåˆå§‹åŒ–å½“å‰åº“å­˜ä¸º1000ï¼Œé€šè¿‡çº¿ç¨‹æ± è°ƒåº¦ï¼Œæ¨¡æ‹Ÿæ€»å…±æœ‰2000äººå‚ä¸ç§’æ€ï¼ŒæœŸæœ›å€¼ä¸ºæœ€åæˆåŠŸç¬”æ•°ä¸º1000</span><br><span class="hljs-comment">     * ç»“æœï¼šå¤šæ¬¡è¿è¡Œï¼Œæœ€ç»ˆçš„ç»“æœä¸º1000</span><br><span class="hljs-comment">     * æ€»ç»“ï¼šé€Ÿåº¦å¿«</span><br><span class="hljs-comment">     */</span><br></code></pre></td></tr></table></figure>

<ol start="5">
<li>Redis è®¡æ•° +  MongoDB å¼‚æ­¥æŒä¹…åŒ–</li>
</ol>
<p>ä½¿ç”¨redisç¼“å­˜æ‰§è¡Œåº“å­˜-1æ“ä½œï¼Œæœ€åé€šè¿‡å‘é€MQå®Œæˆæ•°æ®è½åœ°ï¼ˆå­˜å…¥mongoDBï¼‰</p>
<h3 id="1-4-äº”ç§ç­–ç•¥æ€»ç»“"><a href="#1-4-äº”ç§ç­–ç•¥æ€»ç»“" class="headerlink" title="1.4 äº”ç§ç­–ç•¥æ€»ç»“"></a>1.4 äº”ç§ç­–ç•¥æ€»ç»“</h3><p><strong>äº”ç§ç§’æ€ç­–ç•¥å¯¹æ¯”è¡¨æ ¼</strong></p>
<table>
<thead>
<tr>
<th><strong>ç­–ç•¥åç§°</strong></th>
<th><strong>ä½œç”¨</strong></th>
<th><strong>å®ç°æ–¹å¼</strong></th>
<th><strong>ä¼˜ç‚¹</strong></th>
<th><strong>ç¼ºç‚¹</strong></th>
<th><strong>é€‚ç”¨åœºæ™¯</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Synchronized åŒæ­¥é”</strong></td>
<td>ä½¿ç”¨ Java æœ¬åœ°é”ä¸²è¡Œå¤„ç†è¯·æ±‚ï¼Œç¡®ä¿åº“å­˜æ‰£å‡çš„çº¿ç¨‹å®‰å…¨ï¼Œé˜²æ­¢è¶…å–ã€‚</td>
<td>é€šè¿‡ <code>synchronized</code> å…³é”®å­—å¯¹å•†å“ ID åŠ é”ï¼ŒåŒæ­¥æ‰§è¡Œåº“å­˜æ£€æŸ¥å’Œæ‰£å‡ï¼Œè®¢å•ç›´æ¥å†™å…¥æ•°æ®åº“ã€‚</td>
<td>1. å®ç°ç®€å•ï¼Œæ— éœ€é¢å¤–ç»„ä»¶<br>2. å•æœºç¯å¢ƒä¸‹ä¿è¯ä¸€è‡´æ€§<br>3. é”ç²’åº¦ç»†ï¼ˆæŒ‰å•†å“ï¼‰</td>
<td>1. ä¸æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²<br>2. é«˜å¹¶å‘ä¸‹æ€§èƒ½ç“¶é¢ˆæ˜æ˜¾ï¼ˆé”ç«äº‰ï¼‰<br>3. å•çº¿ç¨‹å¤„ç†ï¼Œååé‡ä½</td>
<td>å•æœºã€ä½å¹¶å‘åœºæ™¯</td>
</tr>
<tr>
<td><strong>æ•°æ®åº“ä¹è§‚é”</strong></td>
<td>é€šè¿‡æ•°æ®åº“ç‰ˆæœ¬å·æˆ–æ¡ä»¶æ›´æ–°å®ç°åº“å­˜æ‰£å‡çš„å¹¶å‘æ§åˆ¶ï¼Œä¿è¯ä¸€è‡´æ€§ã€‚</td>
<td>ä½¿ç”¨ SQLï¼ˆå¦‚ <code>UPDATE seckill SET stock = stock - 1 WHERE stock &gt; 0 AND id = ?</code>ï¼‰åŸå­æ›´æ–°åº“å­˜ã€‚</td>
<td>1. ç®€å•é«˜æ•ˆï¼Œä¾èµ–æ•°æ®åº“äº‹åŠ¡<br>2. æ— éœ€é¢å¤–ä¸­é—´ä»¶<br>3. å•æœºæˆ–å°è§„æ¨¡åˆ†å¸ƒå¼ä¸€è‡´æ€§å¼º</td>
<td>1. é«˜å¹¶å‘ä¸‹æ•°æ®åº“å‹åŠ›å¤§<br>2. é”å†²çªé¢‘ç¹ï¼ŒæˆåŠŸç‡é™ä½<br>3. æ€§èƒ½å—æ•°æ®åº“ç“¶é¢ˆé™åˆ¶</td>
<td>å•æœºæˆ–ä¸­å°è§„æ¨¡åˆ†å¸ƒå¼ç³»ç»Ÿ</td>
</tr>
<tr>
<td><strong>Redisson åˆ†å¸ƒå¼é”</strong></td>
<td>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹é€šè¿‡ Redis åˆ†å¸ƒå¼é”å®ç°åº“å­˜æ‰£å‡çš„äº’æ–¥æ€§ï¼Œé˜²æ­¢è¶…å–ã€‚</td>
<td>ä½¿ç”¨ Redisson çš„ <code>RLock</code> å¯¹å•†å“ ID åŠ é”ï¼Œé”ä½åæ‰§è¡Œåº“å­˜æ‰£å‡å’Œè®¢å•å†™å…¥ã€‚</td>
<td>1. æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²<br>2. ç®€å•æ˜“ç”¨ï¼Œå¯é‡å…¥é”æ”¯æŒ<br>3. Redis æ€§èƒ½é«˜ï¼Œé”ç²’åº¦å¯æ§</td>
<td>1. é”è·å–&#x2F;é‡Šæ”¾æœ‰ç½‘ç»œå¼€é”€<br>2. Redis æ•…éšœå½±å“é”å¯ç”¨æ€§<br>3. é«˜å¹¶å‘ä¸‹é”ç«äº‰å¯èƒ½å¯¼è‡´å»¶è¿Ÿ</td>
<td>å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¼ºè°ƒä¸€è‡´æ€§</td>
</tr>
<tr>
<td><strong>RabbitMQ æ¶ˆæ¯é˜Ÿåˆ—</strong></td>
<td>é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†ç§’æ€è¯·æ±‚ï¼Œå¿«é€Ÿå“åº”ç”¨æˆ·ï¼Œç¼“è§£æ•°æ®åº“å‹åŠ›ã€‚</td>
<td>Redis æ£€æŸ¥åº“å­˜ï¼ŒæˆåŠŸåå°†è®¢å•æ¶ˆæ¯å‘é€åˆ° RabbitMQï¼Œåå°æ¶ˆè´¹è€…å¼‚æ­¥å†™å…¥æ•°æ®åº“ï¼ˆå¦‚ MongoDBï¼‰ã€‚</td>
<td>1. é«˜ååé‡ï¼Œå¼‚æ­¥è§£è€¦<br>2. å¿«é€Ÿå“åº”ç”¨æˆ·<br>3. ç¼“å†²å³°å€¼æµé‡ï¼Œä¿æŠ¤æ•°æ®åº“</td>
<td>1. æœ€ç»ˆä¸€è‡´æ€§ï¼Œå»¶è¿Ÿå¯èƒ½å½±å“ä½“éªŒ<br>2. ç³»ç»Ÿå¤æ‚æ€§å¢åŠ <br>3. RabbitMQ æ•…éšœéœ€å®¹é”™æœºåˆ¶</td>
<td>é«˜å¹¶å‘åœºæ™¯ï¼Œéœ€å¿«é€Ÿå“åº”</td>
</tr>
<tr>
<td><strong>Redis è®¡æ•° + MongoDB å¼‚æ­¥æŒä¹…åŒ–</strong></td>
<td>ä½¿ç”¨ Redis åŸå­è®¡æ•°å¿«é€Ÿæ‰£å‡åº“å­˜ï¼ŒMongoDB å¼‚æ­¥æŒä¹…åŒ–è®¢å•ï¼Œæå‡æ€§èƒ½ã€‚</td>
<td>Redis <code>DECR</code> æ‰£å‡åº“å­˜ï¼Œè®¢å•æ•°æ®é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ RabbitMQ&#x2F;Kafkaï¼‰å¼‚æ­¥å†™å…¥ MongoDBã€‚</td>
<td>1. æé«˜æ€§èƒ½ï¼ˆRedis å¾®ç§’çº§å“åº”ï¼‰<br>2. å¼‚æ­¥è§£è€¦ï¼Œååé‡é«˜<br>3. åº“å­˜ä¸€è‡´æ€§å¼ºï¼Œé˜²è¶…å–</td>
<td>1. æœ€ç»ˆä¸€è‡´æ€§éœ€ä¸šåŠ¡å®¹å¿<br>2. æ¶æ„å¤æ‚ï¼Œä¾èµ–å¤šç»„ä»¶<br>3. Redis æ•…éšœå¯èƒ½ä¸¢å¤±åº“å­˜æ•°æ®</td>
<td>é«˜å¹¶å‘ã€åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œè¿½æ±‚æè‡´æ€§èƒ½</td>
</tr>
</tbody></table>
<h2 id="2-åŸºäº-Nacos-å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†ï¼›ä½¿ç”¨-OpenFeign-å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡ç›¸åº”çš„æœåŠ¡é™çº§é€»è¾‘å¤„ç†ï¼›ä½¿ç”¨-Gateway-æ„å»ºå¾®æœåŠ¡-API-ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯"><a href="#2-åŸºäº-Nacos-å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†ï¼›ä½¿ç”¨-OpenFeign-å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡ç›¸åº”çš„æœåŠ¡é™çº§é€»è¾‘å¤„ç†ï¼›ä½¿ç”¨-Gateway-æ„å»ºå¾®æœåŠ¡-API-ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯" class="headerlink" title="2. åŸºäº Nacos å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†ï¼›ä½¿ç”¨ OpenFeign å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡ç›¸åº”çš„æœåŠ¡é™çº§é€»è¾‘å¤„ç†ï¼›ä½¿ç”¨ Gateway æ„å»ºå¾®æœåŠ¡ API ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯"></a>2. åŸºäº Nacos å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†ï¼›ä½¿ç”¨ OpenFeign å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡ç›¸åº”çš„æœåŠ¡é™çº§é€»è¾‘å¤„ç†ï¼›ä½¿ç”¨ Gateway æ„å»ºå¾®æœåŠ¡ API ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯</h2><h3 id="2-1-åŸºäº-Nacos-å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†"><a href="#2-1-åŸºäº-Nacos-å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†" class="headerlink" title="2.1 åŸºäº Nacos å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†"></a>2.1 åŸºäº Nacos å®ç°ç»Ÿä¸€é…ç½®ä¸­å¿ƒç®¡ç†</h3><p>Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒå’ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œåœ¨ GoodsKill é¡¹ç›®ä¸­ç”¨äºé›†ä¸­ç®¡ç†å¾®æœåŠ¡çš„é…ç½®ï¼ˆå¦‚æ•°æ®åº“è¿æ¥ã€æ¶ˆæ¯é˜Ÿåˆ—å‚æ•°ç­‰ï¼‰ï¼Œå¹¶æ”¯æŒé…ç½®çš„åŠ¨æ€åˆ·æ–°ã€‚</p>
<ol>
<li>ä¾èµ–å¼•å…¥ï¼š åœ¨ pom.xml ä¸­å¼•å…¥ Nacos é…ç½®ç®¡ç†çš„ä¾èµ–</li>
<li>é…ç½®æ–‡ä»¶ï¼š åœ¨ bootstrap.ymlï¼ˆä¼˜å…ˆäº application.yml åŠ è½½ï¼‰ä¸­é…ç½® Nacos åœ°å€å’Œé…ç½®ä¿¡æ¯</li>
<li>é…ç½® Nacos ç®¡ç†ç•Œé¢ï¼š åœ¨ Nacos æ§åˆ¶å°åˆ›å»ºé…ç½®æ–‡ä»¶</li>
<li>æœåŠ¡å¯åŠ¨ï¼š å¯åŠ¨æœåŠ¡æ—¶ï¼ŒSpring Boot ä¼šä» Nacos æ‹‰å–é…ç½®ï¼Œè¦†ç›–æœ¬åœ° application.ymlï¼Œå¹¶æ³¨å†ŒæœåŠ¡åˆ° Nacosã€‚</li>
</ol>
<h3 id="2-2-ä½¿ç”¨-OpenFeign-å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡æœåŠ¡é™çº§é€»è¾‘å¤„ç†"><a href="#2-2-ä½¿ç”¨-OpenFeign-å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡æœåŠ¡é™çº§é€»è¾‘å¤„ç†" class="headerlink" title="2.2 ä½¿ç”¨ OpenFeign å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡æœåŠ¡é™çº§é€»è¾‘å¤„ç†"></a>2.2 ä½¿ç”¨ OpenFeign å®ç°å¾®æœåŠ¡ä¹‹é—´çš„è¿œç¨‹è°ƒç”¨å’ŒæœåŠ¡ç†”æ–­ï¼Œå¹¶è®¾è®¡æœåŠ¡é™çº§é€»è¾‘å¤„ç†</h3><p><a href="#131-goodskill-order-provider">è·³è½¬åˆ°OrderService</a></p>
<p><strong>OrderService</strong><br><code>package com.goodskill.order.api</code></p>
<p>åŸºäº Spring Cloud OpenFeign å®ç°çš„ <strong>è®¢å•å¾®æœåŠ¡ (goodskill-order) è¿œç¨‹è°ƒç”¨æ¥å£</strong>ï¼Œå¹¶æä¾›äº† ç†”æ–­é™çº§å¤„ç†ã€‚</p>
<ul>
<li>ä½¿ç”¨Spring Cloud Alibaba æä¾›äº† <strong>Sentinel æ¥åšæœåŠ¡ç†”æ–­ã€é™æµã€é™çº§ã€‚</strong></li>
</ul>
<ol>
<li>æ·»åŠ ä¾èµ–</li>
<li>Feign å®¢æˆ·ç«¯å¼€å¯é™çº§æ”¯æŒ</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">sentinel:</span><br>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ç¼–å†™æ¥å£å’Œ fallback ç±»</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;goodskill-order&quot;, fallback = OrderServiceFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/count&quot;)</span><br>    <span class="hljs-type">long</span> <span class="hljs-title function_">count</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;seckillId&quot;)</span> <span class="hljs-type">long</span> seckillId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-ä½¿ç”¨-Gateway-æ„å»ºå¾®æœåŠ¡-API-ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯"><a href="#2-3-ä½¿ç”¨-Gateway-æ„å»ºå¾®æœåŠ¡-API-ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯" class="headerlink" title="2.3 ä½¿ç”¨ Gateway æ„å»ºå¾®æœåŠ¡ API ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯"></a>2.3 ä½¿ç”¨ Gateway æ„å»ºå¾®æœåŠ¡ API ç½‘å…³ï¼Œæ”¯æŒåŠ¨æ€è·¯ç”±ã€é…ç½®çƒ­æ›´æ–°ä¸ç»Ÿä¸€èº«ä»½è®¤è¯</h3><p><a href="#10-goodskill-gateway-%E5%BE%AE%E6%9C%8D%E5%8A%A1api%E7%BD%91%E5%85%B3%E7%BB%9F%E4%B8%80%E6%9C%8D%E5%8A%A1%E9%89%B4%E6%9D%83%E6%94%AF%E6%8C%81%E5%8A%A8%E6%80%81%E8%B7%AF%E7%94%B1%E5%8A%A0%E8%BD%BD">è·³è½¬åˆ°goodskill-gatewayå¾®æœåŠ¡ç½‘å…³API</a></p>
<p><a href="#135-goodskill-gateway">è·³è½¬åˆ°goodskill-gatewayè§£æ</a></p>
<h4 id="2-3-1-åŠ¨æ€è·¯ç”±æ”¯æŒï¼ˆåŸºäº-Nacosï¼‰"><a href="#2-3-1-åŠ¨æ€è·¯ç”±æ”¯æŒï¼ˆåŸºäº-Nacosï¼‰" class="headerlink" title="2.3.1 åŠ¨æ€è·¯ç”±æ”¯æŒï¼ˆåŸºäº Nacosï¼‰"></a>2.3.1 åŠ¨æ€è·¯ç”±æ”¯æŒï¼ˆåŸºäº Nacosï¼‰</h4><p><strong>å®ç°åŸç†ï¼š</strong><br>é€šè¿‡ <code>DynamicRouteConfigWatcher</code> + <code>DynamicRouteRefresh</code> å®ç°ï¼š</p>
<h5 id="DynamicRouteConfigWatcher-1"><a href="#DynamicRouteConfigWatcher-1" class="headerlink" title="DynamicRouteConfigWatcher"></a><code>DynamicRouteConfigWatcher</code></h5><ul>
<li><p><strong>åˆå§‹åŒ–é˜¶æ®µï¼ˆ@PostConstructï¼‰</strong>ï¼š</p>
<ul>
<li>é€šè¿‡ <code>initConfigService()</code> è¿æ¥åˆ° Nacos é…ç½®ä¸­å¿ƒã€‚</li>
<li>æ³¨å†Œç›‘å¬å™¨ç›‘å¬åŠ¨æ€è·¯ç”±é…ç½®ï¼ˆ<code>dataId</code> + <code>group</code>ï¼‰ã€‚</li>
<li>å¯åŠ¨æ—¶ä» Nacos æ‹‰å–å½“å‰ç½‘å…³è·¯ç”±é…ç½®ï¼Œé€šè¿‡ <code>run()</code> æ–¹æ³•æ³¨å…¥åˆ°ç½‘å…³ä¸­ã€‚</li>
</ul>
</li>
<li><p><strong>ç›‘å¬é…ç½®å˜åŒ–</strong>ï¼š</p>
<ul>
<li>å½“é…ç½®å˜æ›´æ—¶è§¦å‘ <code>receiveConfigInfo()</code> æ–¹æ³•ï¼Œå°†å˜æ›´çš„è·¯ç”±é…ç½®è§£æä¸º <code>RouteDefinition</code> åˆ—è¡¨ï¼Œè°ƒç”¨ <code>dynamicRouteService.updateList(...)</code> æ›´æ–°ç½‘å…³è·¯ç”±ã€‚</li>
</ul>
</li>
</ul>
<h5 id="DynamicRouteRefresh-1"><a href="#DynamicRouteRefresh-1" class="headerlink" title="DynamicRouteRefresh"></a><code>DynamicRouteRefresh</code></h5><ul>
<li>æä¾› <code>save()</code>ã€<code>delete()</code>ã€<code>updateList()</code> æ–¹æ³•å¯¹ç½‘å…³è·¯ç”±è¿›è¡ŒåŠ¨æ€ç»´æŠ¤ã€‚</li>
<li>æ¯æ¬¡æ“ä½œéƒ½ä¼šé€šè¿‡ <code>ApplicationEventPublisher</code> å‘å¸ƒ <code>RefreshRoutesEvent</code>ï¼Œ<strong>å®æ—¶åˆ·æ–°ç½‘å…³è·¯ç”±</strong>ã€‚</li>
</ul>
<h4 id="2-3-2-é…ç½®çƒ­æ›´æ–°ï¼ˆä¾èµ–-Nacosï¼‰"><a href="#2-3-2-é…ç½®çƒ­æ›´æ–°ï¼ˆä¾èµ–-Nacosï¼‰" class="headerlink" title="2.3.2 é…ç½®çƒ­æ›´æ–°ï¼ˆä¾èµ– Nacosï¼‰"></a>2.3.2 é…ç½®çƒ­æ›´æ–°ï¼ˆä¾èµ– Nacosï¼‰</h4><ul>
<li>ä½¿ç”¨ Nacos ç®¡ç†æ‰€æœ‰è·¯ç”±è§„åˆ™ï¼Œé€šè¿‡ç›‘å¬æœºåˆ¶ï¼ˆ<code>Listener</code> æ¥å£ï¼‰è‡ªåŠ¨æ„ŸçŸ¥é…ç½®å˜åŠ¨ã€‚</li>
<li>ä¸€æ—¦ç›‘å¬åˆ°é…ç½®æ›´æ–°ï¼Œç«‹åˆ»åˆ·æ–°ç½‘å…³è·¯ç”±è¡¨ï¼ˆæ— éœ€é‡å¯æœåŠ¡ï¼‰ã€‚</li>
<li>åŠ¨æ€åŠ è½½çš„æ•°æ®æ ¼å¼æ˜¯æ ‡å‡†çš„ <code>RouteDefinition</code> JSON æ•°ç»„ï¼Œå¦‚ï¼š</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;route1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;uri&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;lb://goodskill-order&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;predicates&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Path&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/api/order/**&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;filters&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;StripPrefix&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;args&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_genkey_0&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<h4 id="2-3-3-ç»Ÿä¸€èº«ä»½è®¤è¯ä¸æƒé™æ§åˆ¶ï¼ˆåŸºäº-Sa-Tokenï¼‰"><a href="#2-3-3-ç»Ÿä¸€èº«ä»½è®¤è¯ä¸æƒé™æ§åˆ¶ï¼ˆåŸºäº-Sa-Tokenï¼‰" class="headerlink" title="2.3.3. ç»Ÿä¸€èº«ä»½è®¤è¯ä¸æƒé™æ§åˆ¶ï¼ˆåŸºäº Sa-Tokenï¼‰"></a>2.3.3. ç»Ÿä¸€èº«ä»½è®¤è¯ä¸æƒé™æ§åˆ¶ï¼ˆåŸºäº Sa-Tokenï¼‰</h4><h5 id="SaTokenConfigurationï¼ˆæ³¨å†Œå…¨å±€è®¤è¯è¿‡æ»¤å™¨ï¼‰"><a href="#SaTokenConfigurationï¼ˆæ³¨å†Œå…¨å±€è®¤è¯è¿‡æ»¤å™¨ï¼‰" class="headerlink" title="SaTokenConfigurationï¼ˆæ³¨å†Œå…¨å±€è®¤è¯è¿‡æ»¤å™¨ï¼‰"></a>SaTokenConfigurationï¼ˆæ³¨å†Œå…¨å±€è®¤è¯è¿‡æ»¤å™¨ï¼‰</h5><ul>
<li>æ³¨å†Œå…¨å±€è®¤è¯è¿‡æ»¤å™¨ <code>SaReactorFilter</code>ï¼Œåœ¨è¯·æ±‚è¿›å…¥å¾®æœåŠ¡å‰è¿›è¡Œç»Ÿä¸€èº«ä»½æ ¡éªŒï¼š<ul>
<li>å¯¹æ‰€æœ‰è·¯å¾„ <code>/**</code> è¿›è¡Œæ‹¦æˆªï¼›</li>
<li>ç™½åå•ï¼ˆå¦‚ <code>/favicon.ico</code>ã€<code>/actuator/**</code>ï¼‰æ”¾è¡Œï¼›</li>
<li>åˆ¤æ–­æ˜¯å¦ç™»å½•ï¼ˆ<code>StpUtil.checkLogin()</code>ï¼‰ï¼›</li>
<li>æ”¯æŒç™»å½•ç”¨æˆ·ç™½åå•ï¼ˆæ”¾è¡ŒæŸäº›ä¸éœ€æƒé™çš„æ¥å£ï¼‰ï¼›</li>
<li>æƒé™æ§åˆ¶é¢„ç•™æ¥å£ï¼ˆå¯å¯ç”¨ <code>StpUtil.checkPermission()</code> å®ç°æ›´ç²¾ç»†çš„æƒé™æ§åˆ¶ï¼‰ï¼›</li>
<li>æ‰€æœ‰å¼‚å¸¸ç»Ÿä¸€æ•è·å¹¶æ ¼å¼åŒ–è¿”å›ï¼ˆé€šè¿‡ <code>.setError(...)</code> å®ç°ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h5 id="StpInterfaceImplï¼ˆæƒé™å’Œè§’è‰²åŠ¨æ€åŠ è½½ï¼‰"><a href="#StpInterfaceImplï¼ˆæƒé™å’Œè§’è‰²åŠ¨æ€åŠ è½½ï¼‰" class="headerlink" title="StpInterfaceImplï¼ˆæƒé™å’Œè§’è‰²åŠ¨æ€åŠ è½½ï¼‰"></a>StpInterfaceImplï¼ˆæƒé™å’Œè§’è‰²åŠ¨æ€åŠ è½½ï¼‰</h5><ul>
<li>å®ç° <code>StpInterface</code> æ¥å£ï¼š<ul>
<li>é€šè¿‡ Feign å®¢æˆ·ç«¯è°ƒç”¨ <code>goodskill-auth</code> æœåŠ¡è¿œç¨‹åŠ è½½ç”¨æˆ·çš„æƒé™ç ã€è§’è‰²åˆ—è¡¨ã€‚</li>
<li>å¼‚æ­¥æ‰§è¡Œï¼ˆ<code>CompletableFuture</code>ï¼‰ï¼Œæå‡è°ƒç”¨æ•ˆç‡ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h4 id="2-3-4-è·¯ç”±å®šä¹‰é…ç½®ï¼ˆGatewayConfigurationï¼‰"><a href="#2-3-4-è·¯ç”±å®šä¹‰é…ç½®ï¼ˆGatewayConfigurationï¼‰" class="headerlink" title="2.3.4. è·¯ç”±å®šä¹‰é…ç½®ï¼ˆGatewayConfigurationï¼‰"></a>2.3.4. è·¯ç”±å®šä¹‰é…ç½®ï¼ˆGatewayConfigurationï¼‰</h4><ul>
<li>åœ¨é™æ€æ¨¡å¼ä¸‹å®šä¹‰é»˜è®¤è·¯ç”±è½¬å‘è§„åˆ™ï¼ˆä¾‹å¦‚ï¼š<code>/api/order/** â†’ lb://goodskill-order</code>ï¼‰ï¼Œç”¨äºå…œåº•æˆ–æœªé…ç½®åŠ¨æ€è·¯ç”±æ—¶ä½¿ç”¨ã€‚</li>
<li>æ”¯æŒ <code>stripPrefix</code> åŠŸèƒ½ï¼Œå‰¥ç¦» <code>/api</code> å‰ç¼€ï¼Œç¡®ä¿å†…éƒ¨æœåŠ¡ URL æ­£ç¡®æ˜ å°„ã€‚</li>
</ul>
<h4 id="æ€»ç»“ï¼šGateway-ä¸»è¦èƒ½åŠ›"><a href="#æ€»ç»“ï¼šGateway-ä¸»è¦èƒ½åŠ›" class="headerlink" title="æ€»ç»“ï¼šGateway ä¸»è¦èƒ½åŠ›"></a>æ€»ç»“ï¼šGateway ä¸»è¦èƒ½åŠ›</h4><table>
<thead>
<tr>
<th>èƒ½åŠ›</th>
<th>å®ç°æœºåˆ¶</th>
</tr>
</thead>
<tbody><tr>
<td>åŠ¨æ€è·¯ç”±</td>
<td>Nacos + <code>DynamicRouteConfigWatcher</code> + <code>DynamicRouteRefresh</code></td>
</tr>
<tr>
<td>è·¯ç”±çƒ­æ›´æ–°</td>
<td>ç›‘å¬ Nacos é…ç½®å˜åŒ–ï¼Œå®æ—¶åˆ·æ–°è·¯ç”±</td>
</tr>
<tr>
<td>æœåŠ¡å‘ç°ä¸è½¬å‘</td>
<td><code>lb://</code> URI + Spring Cloud Gateway</td>
</tr>
<tr>
<td>è·¯ç”±å‰ç¼€å‰¥ç¦»</td>
<td><code>stripPrefix</code> è¿‡æ»¤å™¨</td>
</tr>
<tr>
<td>ç™»å½•è®¤è¯</td>
<td>Sa-Token å…¨å±€è¿‡æ»¤å™¨ <code>SaReactorFilter</code></td>
</tr>
<tr>
<td>æƒé™ä¸è§’è‰²æ§åˆ¶</td>
<td>è‡ªå®šä¹‰ <code>StpInterfaceImpl</code> æ¥å£</td>
</tr>
<tr>
<td>ç»Ÿä¸€å¼‚å¸¸å¤„ç†</td>
<td><code>.setError()</code> è¿”å›æ ‡å‡†é”™è¯¯å“åº”ç»“æ„</td>
</tr>
<tr>
<td>ç™½åå•æœºåˆ¶</td>
<td>æ”¯æŒå…¨å±€ä¸ç™»å½•ç”¨æˆ·çº§ç™½åå•</td>
</tr>
</tbody></table>
<h2 id="3-åŸºäºè´£ä»»é“¾æ¨¡å¼çš„é¢„å¤„ç†å™¨æœºåˆ¶ï¼Œåœ¨ç§’æ€å‰å¯¹æ•°æ®åº“ã€ç¼“å­˜ã€çŠ¶æ€æœºç­‰è¿›è¡Œåˆå§‹åŒ–é¢„å¤„ç†"><a href="#3-åŸºäºè´£ä»»é“¾æ¨¡å¼çš„é¢„å¤„ç†å™¨æœºåˆ¶ï¼Œåœ¨ç§’æ€å‰å¯¹æ•°æ®åº“ã€ç¼“å­˜ã€çŠ¶æ€æœºç­‰è¿›è¡Œåˆå§‹åŒ–é¢„å¤„ç†" class="headerlink" title="3. åŸºäºè´£ä»»é“¾æ¨¡å¼çš„é¢„å¤„ç†å™¨æœºåˆ¶ï¼Œåœ¨ç§’æ€å‰å¯¹æ•°æ®åº“ã€ç¼“å­˜ã€çŠ¶æ€æœºç­‰è¿›è¡Œåˆå§‹åŒ–é¢„å¤„ç†"></a>3. åŸºäºè´£ä»»é“¾æ¨¡å¼çš„é¢„å¤„ç†å™¨æœºåˆ¶ï¼Œåœ¨ç§’æ€å‰å¯¹æ•°æ®åº“ã€ç¼“å­˜ã€çŠ¶æ€æœºç­‰è¿›è¡Œåˆå§‹åŒ–é¢„å¤„ç†</h2><p><a href="#326-handler%E5%8C%85">è·³è½¬åˆ°handleråŒ…</a></p>
<p>é€šè¿‡å®šä¹‰ <code>PreRequestHandler</code> æ¥å£åŠå…¶æŠ½è±¡å®ç° <code>AbstractPreRequestHandler</code>, å°†â€œç§’æ€æ´»åŠ¨åˆå§‹åŒ–â€è¿‡ç¨‹æ‹†è§£ä¸ºå¤šä¸ªç‹¬ç«‹æ­¥éª¤ï¼Œå¦‚æ•°æ®åº“åˆå§‹åŒ–ã€Redis ç¼“å­˜æ¸…ç†ã€çŠ¶æ€æœºå¯åŠ¨ã€Mongo æ•°æ®æ¸…é™¤ç­‰</p>
<ul>
<li>PreRequestHandlerï¼šæ¥å£</li>
<li>PreRequestPipeline</li>
<li>AbstractPreRequestHandler ï¼›æŠ½è±¡ç±»</li>
</ul>
<h3 id="3-1-Handler-æµç¨‹çš„æ‰§è¡Œé¡ºåºï¼Ÿ"><a href="#3-1-Handler-æµç¨‹çš„æ‰§è¡Œé¡ºåºï¼Ÿ" class="headerlink" title="3.1 Handler æµç¨‹çš„æ‰§è¡Œé¡ºåºï¼Ÿ"></a>3.1 Handler æµç¨‹çš„æ‰§è¡Œé¡ºåºï¼Ÿ</h3><p>æ‰§è¡Œé¡ºåºï¼š</p>
<ol>
<li>DatabasePreRequestHandler</li>
<li>RedisPreRequestHandler</li>
<li>StateMachinePreRequestHandler</li>
<li>MongoPreRequestHandler</li>
</ol>
<table>
<thead>
<tr>
<th>é¡ºåº</th>
<th>Handler åç§°</th>
<th>ä¸»è¦ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><code>0</code></td>
<td><strong>DatabasePreRequestHandler</strong></td>
<td>é‡ç½®æ•°æ®åº“ä¸­æŒ‡å®šç§’æ€å•†å“çš„åº“å­˜ã€æ¸…ç†æˆåŠŸç§’æ€è®°å½•</td>
</tr>
<tr>
<td><code>1</code></td>
<td><strong>RedisPreRequestHandler</strong></td>
<td>æ¸…ç©º Redis ä¸­ç›¸å…³ç¼“å­˜ã€è®¾ç½®å•†å“çŠ¶æ€ä¸ºâ€œè¿›è¡Œä¸­â€</td>
</tr>
<tr>
<td><code>2</code></td>
<td><strong>StateMachinePreRequestHandler</strong></td>
<td>åˆå§‹åŒ–çŠ¶æ€æœºï¼Œè§¦å‘çŠ¶æ€å˜æ›´ï¼ˆé‡ç½® â†’ å¼€å§‹ï¼‰</td>
</tr>
<tr>
<td><code>3</code></td>
<td><strong>MongoPreRequestHandler</strong></td>
<td>åˆ é™¤ MongoDB ä¸­å†å²è®¢å•æ•°æ®</td>
</tr>
</tbody></table>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs text">                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>                            â”‚     PreRequestPipeline     â”‚<br>                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<br>                                         â”‚<br>                             ä¾é¡ºåºè°ƒç”¨ handle()<br>                                         â–¼<br>        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<br>        â–¼              â–¼                â–¼              â–¼                    â–¼<br>DatabaseHandler â†’ RedisHandler â†’ StateMachineHandler â†’ MongoHandler â†’ ç§’æ€ä¸»é€»è¾‘å¼€å§‹<br>(é‡ç½®åº“å­˜)     (æ¸…ç†ç¼“å­˜)      (çŠ¶æ€æµè½¬)         (æ¸…ç†Mongo)         ï¼ˆæ‰§è¡Œå‹æµ‹/è¯·æ±‚ï¼‰<br></code></pre></td></tr></table></figure>


<h3 id="3-2-åœ¨é«˜å¹¶å‘ä¸‹å¦‚ä½•ç¡®ä¿è¿™äº›-Handlers-çš„é¡ºåºæ€§ï¼Ÿ"><a href="#3-2-åœ¨é«˜å¹¶å‘ä¸‹å¦‚ä½•ç¡®ä¿è¿™äº›-Handlers-çš„é¡ºåºæ€§ï¼Ÿ" class="headerlink" title="3.2 åœ¨é«˜å¹¶å‘ä¸‹å¦‚ä½•ç¡®ä¿è¿™äº› Handlers çš„é¡ºåºæ€§ï¼Ÿ"></a>3.2 åœ¨é«˜å¹¶å‘ä¸‹å¦‚ä½•ç¡®ä¿è¿™äº› Handlers çš„é¡ºåºæ€§ï¼Ÿ</h3><ul>
<li>æ ¸å¿ƒæœºåˆ¶ï¼šé¡ºåºæ€§ç”±<strong>å•çº¿ç¨‹è°ƒç”¨è´£ä»»é“¾</strong>ä¿è¯</li>
<li>è´£ä»»é“¾çš„è§¦å‘å…¥å£ PreRequestPipeline.handle() æ˜¯åŒæ­¥ä¸²è¡Œè°ƒç”¨çš„ã€‚</li>
<li>ç³»ç»Ÿå¯ä»¥åŒæ—¶æœ‰å¤šä¸ªè¯·æ±‚å¹¶å‘è¿›æ¥ï¼Œæ¯ä¸ªè¯·æ±‚å„è‡ªå¯åŠ¨ä¸€æ¡å®Œæ•´çš„é¢„å¤„ç†æµç¨‹ï¼ˆåœ¨è‡ªå·±çº¿ç¨‹å†…ï¼‰ï¼Œä½†æ¯æ¡é“¾ä¸Šçš„ handler æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸ä¼šä¹±åºæˆ–å¹¶å‘æ‰§è¡Œã€‚</li>
</ul>
<h3 id="3-3-æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ"><a href="#3-3-æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ" class="headerlink" title="3.3 æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ"></a>3.3 æ˜¯å¦å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Ÿ</h3><ul>
<li>æ¯ä¸ª handler ç±»æœ¬èº«æ˜¯<strong>å•ä¾‹çš„</strong>ï¼ˆ@Componentï¼‰ï¼Œä½† handler <strong>åªè¯»å–</strong>é…ç½®æˆ–<strong>æ‰§è¡Œå¤–éƒ¨æ“ä½œ</strong>ï¼Œ<strong>ä¸ä¾èµ–å…±äº«å¯å˜çŠ¶æ€</strong>ï¼Œå› æ­¤æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li>
</ul>
<h3 id="3-4-ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Ÿæ˜¯å¦å¯ä»¥ç”¨å¤šçº¿ç¨‹æå‡æ€§èƒ½ï¼Ÿ"><a href="#3-4-ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Ÿæ˜¯å¦å¯ä»¥ç”¨å¤šçº¿ç¨‹æå‡æ€§èƒ½ï¼Ÿ" class="headerlink" title="3.4 ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Ÿæ˜¯å¦å¯ä»¥ç”¨å¤šçº¿ç¨‹æå‡æ€§èƒ½ï¼Ÿ"></a>3.4 ä¸ºä»€ä¹ˆä¸ä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Ÿæ˜¯å¦å¯ä»¥ç”¨å¤šçº¿ç¨‹æå‡æ€§èƒ½ï¼Ÿ</h3><p>é¢„å¤„ç†æµç¨‹æœ¬è´¨ä¸Šæ˜¯â€œåˆå§‹åŒ– + æ ¡éªŒ + æ¸…ç†â€çš„ä¸²è¡Œæ­¥éª¤ï¼Œæ¯”å¦‚å…ˆæ¸…æ•°æ®åº“ã€å†æ¸… Redisã€æœ€ååˆå§‹åŒ–çŠ¶æ€æœºï¼Œé¡ºåºä¸èƒ½ä¹±ã€‚<br>å¦‚æœä½ ç”¨å¼‚æ­¥æˆ–å¹¶è¡Œæ‰§è¡Œï¼Œåè€Œä¼šç ´åè¿™å¥—è¯­ä¹‰æ­£ç¡®æ€§ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>Redis è¿˜æ²¡æ¸…ç†å°±å¯åŠ¨çŠ¶æ€æœºï¼Œå¯èƒ½å¯¼è‡´çŠ¶æ€å¼‚å¸¸ï¼›</li>
<li>æ•°æ®åº“è¿˜æ²¡æ¸…ç©ºï¼ŒMongo æ¸…ç†äº†ä¹Ÿæ²¡æ„ä¹‰ï¼›</li>
<li>æŸä¸ªå¼‚å¸¸æœªå¤„ç†ä¼šæå‰ç»ˆæ­¢æ•´ä¸ªé“¾æ¡ã€‚</li>
</ul>
<h2 id="4-åˆ©ç”¨-Spring-StateMachine-ç®¡ç†ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é›†æˆ-Redis-æŒä¹…åŒ–ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°çŠ¶æ€çš„å…±äº«ä¸æ¢å¤"><a href="#4-åˆ©ç”¨-Spring-StateMachine-ç®¡ç†ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é›†æˆ-Redis-æŒä¹…åŒ–ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°çŠ¶æ€çš„å…±äº«ä¸æ¢å¤" class="headerlink" title="4. åˆ©ç”¨ Spring StateMachine ç®¡ç†ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é›†æˆ Redis æŒä¹…åŒ–ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°çŠ¶æ€çš„å…±äº«ä¸æ¢å¤"></a>4. åˆ©ç”¨ Spring StateMachine ç®¡ç†ç§’æ€æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶é›†æˆ Redis æŒä¹…åŒ–ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­å®ç°çŠ¶æ€çš„å…±äº«ä¸æ¢å¤</h2><h3 id="4-1-çŠ¶æ€æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#4-1-çŠ¶æ€æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4.1 çŠ¶æ€æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ"></a>4.1 çŠ¶æ€æœºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</h3><table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>çŠ¶æ€æœºçš„ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>æ´»åŠ¨çŠ¶æ€ä¸å¥½ç®¡ç†</td>
<td>ç”¨çŠ¶æ€æœºç»Ÿä¸€ç®¡ç†â€œæœªå¼€å§‹ â†’ è¿›è¡Œä¸­ â†’ ç»“æŸâ€ç­‰æµç¨‹</td>
</tr>
<tr>
<td>çŠ¶æ€å®¹æ˜“è¢«ä¹±æ”¹</td>
<td>çŠ¶æ€åªèƒ½é€šè¿‡â€œäº‹ä»¶é©±åŠ¨â€å˜æ›´ï¼Œé¿å…éšæ„ä¿®æ”¹</td>
</tr>
<tr>
<td>å¤šçº¿ç¨‹çŠ¶æ€æ··ä¹±</td>
<td>çŠ¶æ€å˜æ›´å…·å¤‡åŸå­æ€§å’Œçº¿ç¨‹å®‰å…¨ï¼Œé˜²æ­¢å¹¶å‘çŠ¶æ€é”™ä¹±</td>
</tr>
<tr>
<td>æ‰©å±•æ€§å¼±</td>
<td>ä½¿ç”¨çŠ¶æ€æœºæ›´æ˜“æ‰©å±•æ›´å¤šæ´»åŠ¨çŠ¶æ€ï¼ˆå¦‚å–æ¶ˆã€å¤±è´¥ã€è®¡ç®—ä¸­ï¼‰</td>
</tr>
</tbody></table>
<h3 id="4-2-GoodsKill-ä¸­çŠ¶æ€æœºæ§åˆ¶äº†ä»€ä¹ˆï¼Ÿ"><a href="#4-2-GoodsKill-ä¸­çŠ¶æ€æœºæ§åˆ¶äº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4.2 GoodsKill ä¸­çŠ¶æ€æœºæ§åˆ¶äº†ä»€ä¹ˆï¼Ÿ"></a>4.2 GoodsKill ä¸­çŠ¶æ€æœºæ§åˆ¶äº†ä»€ä¹ˆï¼Ÿ</h3><p>ä¸»è¦æ§åˆ¶çš„æ˜¯ <strong>ç§’æ€æ´»åŠ¨ï¼ˆSeckillï¼‰çŠ¶æ€</strong>ï¼š</p>
<h4 id="æ´»åŠ¨çŠ¶æ€æµè½¬ç¤ºæ„å›¾ï¼š"><a href="#æ´»åŠ¨çŠ¶æ€æµè½¬ç¤ºæ„å›¾ï¼š" class="headerlink" title="æ´»åŠ¨çŠ¶æ€æµè½¬ç¤ºæ„å›¾ï¼š"></a>æ´»åŠ¨çŠ¶æ€æµè½¬ç¤ºæ„å›¾ï¼š</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs css">INITï¼ˆåˆå§‹çŠ¶æ€ï¼‰<br>  â””â”€â”€<span class="hljs-selector-attr">[ACTIVITY_START]</span>â”€â”€â–¶ IN_PROGRESSï¼ˆè¿›è¡Œä¸­ï¼‰<br>        â””â”€â”€<span class="hljs-selector-attr">[ACTIVITY_CALCULATE]</span>â”€â”€â–¶ CALCULATINGï¼ˆè®¡ç®—ä¸­ï¼‰<br>              â””â”€â”€<span class="hljs-selector-attr">[ACTIVITY_END]</span>â”€â”€â–¶ ENDï¼ˆå·²ç»“æŸï¼‰<br></code></pre></td></tr></table></figure>



<h3 id="4-3-é¡¹ç›®ä¸­å¦‚ä½•å®ç°-Spring-StateMachineï¼Ÿ"><a href="#4-3-é¡¹ç›®ä¸­å¦‚ä½•å®ç°-Spring-StateMachineï¼Ÿ" class="headerlink" title="4.3 é¡¹ç›®ä¸­å¦‚ä½•å®ç° Spring StateMachineï¼Ÿ"></a>4.3 é¡¹ç›®ä¸­å¦‚ä½•å®ç° Spring StateMachineï¼Ÿ</h3><p>çŠ¶æ€æœºçš„é…ç½®ä¸»è¦åœ¨æ¨¡å—ï¼š<code>goodskill-seckill-provider</code> ä¸­ã€‚</p>
<h4 id="4-3-1-é…ç½®ç±»ï¼šStateMachineConfig"><a href="#4-3-1-é…ç½®ç±»ï¼šStateMachineConfig" class="headerlink" title="4.3.1 é…ç½®ç±»ï¼šStateMachineConfig"></a>4.3.1 é…ç½®ç±»ï¼š<code>StateMachineConfig</code></h4><p>è¯¥ç±»å®šä¹‰äº†**çŠ¶æ€ã€äº‹ä»¶ã€çŠ¶æ€è¿ç§»è§„åˆ™ã€ç›‘å¬å™¨ã€æŒä¹…åŒ–æœºåˆ¶ï¼ˆRedisï¼‰**ç­‰æ ¸å¿ƒå†…å®¹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableStateMachineFactory</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StateMachineConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StateMachineConfigurerAdapter</span>&lt;States, Events&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(StateMachineStateConfigurer&lt;States, Events&gt; states)</span> &#123;<br>        states.withStates()<br>              .initial(States.INIT)<br>              .state(States.IN_PROGRESS)<br>              .state(States.CALCULATING)<br>              .end(States.END);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">configure</span><span class="hljs-params">(StateMachineTransitionConfigurer&lt;States, Events&gt; transitions)</span> &#123;<br>        transitions<br>            .withExternal().source(States.INIT).target(States.IN_PROGRESS).event(Events.ACTIVITY_START)<br>            .and()<br>            .withExternal().source(States.IN_PROGRESS).target(States.CALCULATING).event(Events.ACTIVITY_CALCULATE)<br>            .and()<br>            .withExternal().source(States.CALCULATING).target(States.END).event(Events.ACTIVITY_END);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-3-2-çŠ¶æ€æšä¸¾"><a href="#4-3-2-çŠ¶æ€æšä¸¾" class="headerlink" title="4.3.2 çŠ¶æ€æšä¸¾"></a>4.3.2 çŠ¶æ€æšä¸¾</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">States</span> &#123;<br>    INIT,           <span class="hljs-comment">// åˆå§‹</span><br>    IN_PROGRESS,    <span class="hljs-comment">// è¿›è¡Œä¸­</span><br>    CALCULATING,    <span class="hljs-comment">// ç»“ç®—ä¸­</span><br>    END             <span class="hljs-comment">// å·²ç»“æŸ</span><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Events</span> &#123;<br>    ACTIVITY_START,       <span class="hljs-comment">// å¯åŠ¨æ´»åŠ¨</span><br>    ACTIVITY_CALCULATE,   <span class="hljs-comment">// æ´»åŠ¨å®Œæˆã€ç»Ÿè®¡</span><br>    ACTIVITY_END          <span class="hljs-comment">// æ´»åŠ¨ç»“æŸ</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="4-3-3-è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡-StateMachineService"><a href="#4-3-3-è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡-StateMachineService" class="headerlink" title="4.3.3 è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡ StateMachineService"></a>4.3.3 è°ƒç”¨æ–¹å¼ï¼šé€šè¿‡ <code>StateMachineService</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆå§‹åŒ–çŠ¶æ€æœº</span><br>stateMachineService.initStateMachine(seckillId);<br><br><span class="hljs-comment">// è§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶</span><br>stateMachineService.feedMachine(Events.ACTIVITY_START, seckillId);<br></code></pre></td></tr></table></figure>

<p>è¿™ç§æ–¹å¼ç”¨åœ¨å¤šä¸ªåœ°æ–¹ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>ç§’æ€å‰å‡†å¤‡é˜¶æ®µï¼ˆprepareSeckillï¼‰â†’ è¿›å…¥ <code>IN_PROGRESS</code></li>
<li>ç§’æ€åº“å­˜å”®ç½„ â†’ è¿›å…¥ <code>CALCULATING</code></li>
<li>ç»“æŸæ¸…ç† â†’ è¿›å…¥ <code>END</code></li>
</ul>
<h4 id="4-3-4-é…åˆ-Redis-æŒä¹…åŒ–"><a href="#4-3-4-é…åˆ-Redis-æŒä¹…åŒ–" class="headerlink" title="4.3.4 é…åˆ Redis æŒä¹…åŒ–"></a>4.3.4 é…åˆ Redis æŒä¹…åŒ–</h4><p>ä½¿ç”¨äº† Spring StateMachine çš„ Redis æŒä¹…åŒ–æ‰©å±•ï¼Œå¯ä»¥æŠŠæ¯ä¸ªæ´»åŠ¨çš„çŠ¶æ€å­˜åœ¨ Redis ä¸­ï¼Œä¿è¯çŠ¶æ€ï¼š</p>
<ul>
<li>å¯æ¢å¤ï¼ˆå®¹å™¨é‡å¯ä¸ä¸¢å¤±ï¼‰</li>
<li>å¯å…±äº«ï¼ˆå¤šä¸ªèŠ‚ç‚¹å…±äº«çŠ¶æ€ï¼‰</li>
<li>å¯ç›‘æ§ï¼ˆå¯é€šè¿‡ Redis æŸ¥çœ‹æ´»åŠ¨çŠ¶æ€ï¼‰</li>
</ul>
<h3 id="4-4-Spring-StateMachine-å¦‚ä½•å’Œ-Redis-åšæŒä¹…åŒ–é›†æˆï¼Ÿ"><a href="#4-4-Spring-StateMachine-å¦‚ä½•å’Œ-Redis-åšæŒä¹…åŒ–é›†æˆï¼Ÿ" class="headerlink" title="4.4 Spring StateMachine å¦‚ä½•å’Œ Redis åšæŒä¹…åŒ–é›†æˆï¼Ÿ"></a>4.4 Spring StateMachine å¦‚ä½•å’Œ Redis åšæŒä¹…åŒ–é›†æˆï¼Ÿ</h3><h4 id="4-4-1-ä¸ºä»€ä¹ˆéœ€è¦-Redis-æŒä¹…åŒ–ï¼Ÿ"><a href="#4-4-1-ä¸ºä»€ä¹ˆéœ€è¦-Redis-æŒä¹…åŒ–ï¼Ÿ" class="headerlink" title="4.4.1 ä¸ºä»€ä¹ˆéœ€è¦ Redis æŒä¹…åŒ–ï¼Ÿ"></a>4.4.1 ä¸ºä»€ä¹ˆéœ€è¦ Redis æŒä¹…åŒ–ï¼Ÿ</h4><p>çŠ¶æ€æœºé»˜è®¤æ˜¯å†…å­˜çŠ¶æ€ï¼Œå¦‚æœé¡¹ç›®æ˜¯<strong>åˆ†å¸ƒå¼éƒ¨ç½²ã€å¤šèŠ‚ç‚¹</strong>ï¼Œæ¯ä¸ªæœåŠ¡å®ä¾‹ç»´æŠ¤è‡ªå·±çš„çŠ¶æ€ï¼Œå¾ˆå®¹æ˜“å‡ºç°çŠ¶æ€ä¸ä¸€è‡´é—®é¢˜ã€‚</p>
<p>â†’ ä½¿ç”¨ Redis ä½œä¸º <strong>çŠ¶æ€å­˜å‚¨ä¸­å¿ƒ</strong>ï¼Œå¯ä»¥è®©æ‰€æœ‰å®ä¾‹å…±äº«çŠ¶æ€ï¼Œå®ç°ï¼š</p>
<ul>
<li>çŠ¶æ€å¯æ¢å¤ï¼ˆæœåŠ¡é‡å¯ä¸ä¸¢å¤±ï¼‰</li>
<li>çŠ¶æ€å…±äº«ä¸€è‡´</li>
<li>çŠ¶æ€å¯è§†åŒ–è°ƒè¯•</li>
</ul>
<h4 id="4-4-2-å¦‚ä½•ä½¿ç”¨RedisåšæŒä¹…åŒ–çš„ï¼Ÿ"><a href="#4-4-2-å¦‚ä½•ä½¿ç”¨RedisåšæŒä¹…åŒ–çš„ï¼Ÿ" class="headerlink" title="4.4.2 å¦‚ä½•ä½¿ç”¨RedisåšæŒä¹…åŒ–çš„ï¼Ÿ"></a>4.4.2 å¦‚ä½•ä½¿ç”¨RedisåšæŒä¹…åŒ–çš„ï¼Ÿ</h4><p>åœ¨JAVA17ä¸­ï¼Œå¼•å…¥ä¾èµ–å°±å¯ä»¥ç›´æ¥ç”¨äº†</p>
<p>JAVA17çš„ç±»ï¼š <code>RedisStateMachinePersister</code></p>
<p>æ¯æ¬¡ä½¿ç”¨çŠ¶æ€æœºæ—¶ï¼š</p>
<ul>
<li>ä» Redis åŠ è½½çŠ¶æ€ â†’ redisPersister.restore(machine, seckillId.toString())</li>
<li>æ‰§è¡ŒçŠ¶æ€æµè½¬</li>
<li>ä¿å­˜æ–°çŠ¶æ€ â†’ redisPersister.persist(machine, seckillId.toString())</li>
</ul>
<h2 id="5-é›†æˆ-ElasticSearch-å®ç°é«˜æ•ˆå•†å“æ£€ç´¢ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢ä¸å…³é”®è¯é«˜äº®ï¼Œæå‡ç”¨æˆ·æ£€ç´¢ä½“éªŒ"><a href="#5-é›†æˆ-ElasticSearch-å®ç°é«˜æ•ˆå•†å“æ£€ç´¢ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢ä¸å…³é”®è¯é«˜äº®ï¼Œæå‡ç”¨æˆ·æ£€ç´¢ä½“éªŒ" class="headerlink" title="5. é›†æˆ ElasticSearch å®ç°é«˜æ•ˆå•†å“æ£€ç´¢ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢ä¸å…³é”®è¯é«˜äº®ï¼Œæå‡ç”¨æˆ·æ£€ç´¢ä½“éªŒ"></a>5. é›†æˆ ElasticSearch å®ç°é«˜æ•ˆå•†å“æ£€ç´¢ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢ä¸å…³é”®è¯é«˜äº®ï¼Œæå‡ç”¨æˆ·æ£€ç´¢ä½“éªŒ</h2><h3 id="5-1-å¦‚ä½•å®ç°çš„ElasticSearch-æœç´¢ï¼Ÿ"><a href="#5-1-å¦‚ä½•å®ç°çš„ElasticSearch-æœç´¢ï¼Ÿ" class="headerlink" title="5.1 å¦‚ä½•å®ç°çš„ElasticSearch æœç´¢ï¼Ÿ"></a>5.1 å¦‚ä½•å®ç°çš„ElasticSearch æœç´¢ï¼Ÿ</h3><p><code>GoodsEsServiceImpl</code></p>
<p><a href="#goodsesserviceimpl">è·³è½¬åˆ°GoodsEsServiceImpl</a></p>
<ul>
<li>Elasticsearch é›†æˆ: ä½¿ç”¨ Spring Data Elasticsearch é›†æˆ Elasticsearchï¼Œæä¾›äº†é«˜æ•ˆçš„å…¨æ–‡æœç´¢å’Œç´¢å¼•ç®¡ç†åŠŸèƒ½</li>
<li>é«˜äº®æœç´¢åŠŸèƒ½: å®ç°å•†å“åç§°çš„æ¨¡ç³Šæœç´¢ï¼Œå¹¶å¯¹åŒ¹é…å…³é”®å­—è¿›è¡Œé«˜äº®æ˜¾ç¤º</li>
</ul>
<h2 id="6-åŸºäº-Spring-AI-æ„å»ºç§’æ€AIå¯¹è¯æœåŠ¡ï¼Œé€šè¿‡æµå¼å“åº”å®ç°å®æ—¶äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ™ºèƒ½é—®ç­”è§¦å‘ç§’æ€æ“ä½œ"><a href="#6-åŸºäº-Spring-AI-æ„å»ºç§’æ€AIå¯¹è¯æœåŠ¡ï¼Œé€šè¿‡æµå¼å“åº”å®ç°å®æ—¶äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ™ºèƒ½é—®ç­”è§¦å‘ç§’æ€æ“ä½œ" class="headerlink" title="6. åŸºäº Spring AI æ„å»ºç§’æ€AIå¯¹è¯æœåŠ¡ï¼Œé€šè¿‡æµå¼å“åº”å®ç°å®æ—¶äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ™ºèƒ½é—®ç­”è§¦å‘ç§’æ€æ“ä½œ"></a>6. åŸºäº Spring AI æ„å»ºç§’æ€AIå¯¹è¯æœåŠ¡ï¼Œé€šè¿‡æµå¼å“åº”å®ç°å®æ—¶äº¤äº’ï¼Œæ”¯æŒå¤šè½®å¯¹è¯å’Œæ™ºèƒ½é—®ç­”è§¦å‘ç§’æ€æ“ä½œ</h2><ul>
<li>åŸºäºSpring AI Alibabaæ„å»ºçš„ç®€æ˜“ç§’æ€æœºå™¨äººæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡æœºå™¨äººæœåŠ¡å®ŒæˆæœåŠ¡è°ƒç”¨ï¼Œç›®å‰ä»…æ”¯æŒå¼€å¯ç§’æ€æ´»åŠ¨ï¼Œä»¥åŠè¾“å‡ºæ´»åŠ¨è€—æ—¶æƒ…å†µ</li>
</ul>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªå¯¹è¯ç¤ºä¾‹:</p>
<figure class="highlight xquery"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xquery">æˆ‘: å¸®æˆ‘æ‰§è¡Œç§’æ€<br><br>AI: å½“ç„¶å¯ä»¥å¸®åŠ©æ‚¨æ‰§è¡Œç§’æ€æ´»åŠ¨å•¦ï¼ä¸ºäº†é¡ºåˆ©è¿›è¡Œï¼Œè¯·å‘Šè¯‰æˆ‘ä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼š<span class="hljs-number">1</span>.ç§’æ€æ´»åŠ¨çš„IDæ˜¯å¤šå°‘ï¼Ÿ<span class="hljs-number">2</span>. è¿™æ¬¡ç§’æ€çš„å•†å“æ•°é‡æ˜¯å¤šå°‘ï¼Ÿ<span class="hljs-number">3</span>.æ‚¨æ‰“ç®—è¿™æ¬¡è¯·æ±‚çš„æ¬¡æ•°æ˜¯å¤šå°‘ï¼Ÿæœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œæˆ‘å°±èƒ½å¸®æ‚¨å¼€å§‹äº†ï¼ğŸ˜Š<br><br>æˆ‘: ç§’æ€æ´»<span class="hljs-built_in">åŠ¨id</span> <span class="hljs-number">1001</span>ï¼Œè¯·æ±‚æ¬¡æ•°<span class="hljs-number">20</span>ï¼Œå•†å“æ•°é‡<span class="hljs-number">10</span>ä¸ª<br><br>AI: ç§’æ€æ´»åŠ¨å·²æˆåŠŸå¼€å¯ï¼æˆ‘ä»¬ç°åœ¨ç­‰å¾…<span class="hljs-number">10</span>ç§’é’Ÿï¼Œç„¶åæˆ‘ä¼šä¸ºæ‚¨è·å–ä»»åŠ¡çš„è€—æ—¶ç»Ÿè®¡ä¿¡æ¯ã€‚ç§’æ€æ´»åŠ¨å·²æˆåŠŸå¯åŠ¨ï¼Œå¹¶åœ¨<span class="hljs-number">10</span>ç§’åè·å¾—äº†ä»»åŠ¡è€—æ—¶ç»Ÿè®¡ä¿¡æ¯ï¼šæ€»è€—æ—¶ï¼š<span class="hljs-number">6.673773375</span>ç§’å…·ä½“è€—æ—¶åˆ†å¸ƒå¦‚ä¸‹ï¼š- ç§’æ€æ´»<span class="hljs-built_in">åŠ¨id</span>:<span class="hljs-number">1001</span>ï¼Œç§’æ€åœºæ™¯äº”(æ•°æ®åº“åŸå­æ€§æ›´æ–°<span class="hljs-keyword">update</span> setnum = num -<span class="hljs-number">1</span>)è€—æ—¶ <span class="hljs-number">3.528280125</span> ç§’ï¼Œå æ¯” <span class="hljs-number">53</span><span class="hljs-meta">%-</span>ç§’æ€æ´»<span class="hljs-built_in">åŠ¨id</span>:<span class="hljs-number">1001</span>ï¼Œç§’æ€åœºæ™¯äº”(æ•°æ®åº“åŸå­æ€§æ›´æ–°updateset num = num-<span class="hljs-number">1</span>)è€—æ—¶<span class="hljs-number">3.14549325</span> ç§’ï¼Œå æ¯” <span class="hljs-number">47</span>%å¸Œæœ›è¿™äº›ä¿¡æ¯å¯¹æ‚¨æœ‰å¸®åŠ©ï¼å¦‚æœè¿˜æœ‰å…¶ä»–é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥çš„å¸®åŠ©ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘å“¦ï¼ğŸ˜Š<br></code></pre></td></tr></table></figure>

<h3 id="6-1-å¦‚ä½•æ„å»ºçš„AIèŠå¤©ï¼Ÿ"><a href="#6-1-å¦‚ä½•æ„å»ºçš„AIèŠå¤©ï¼Ÿ" class="headerlink" title="6.1 å¦‚ä½•æ„å»ºçš„AIèŠå¤©ï¼Ÿ"></a>6.1 å¦‚ä½•æ„å»ºçš„AIèŠå¤©ï¼Ÿ</h3><p><a href="#12-goodskill-ai-ai%E6%9C%BA%E5%99%A8%E4%BA%BA%E8%81%8A%E5%A4%A9%E6%9C%8D%E5%8A%A1">è·³è½¬åˆ°goodskill-ai</a></p>
<p><a href="#136-goodskill-ai">è·³è½¬åˆ°AIäº®ç‚¹è§£æ</a></p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs lasso">ç”¨æˆ·è¯·æ±‚ â†’ AssistantController.chat(chatId, userMessage)<br>           â†“<br>      UserSupportAssistant.chat(<span class="hljs-params">...</span>)<br>           â†“<br>      ChatClientï¼šç”Ÿæˆå›å¤ + è°ƒç”¨å‡½æ•° + ç®¡ç†ä¸Šä¸‹æ–‡<br>           â†“<br>      è¿”å› Flux&lt;<span class="hljs-built_in">String</span>&gt; æµå¼æ¶ˆæ¯<br></code></pre></td></tr></table></figure>

<h4 id="AssistantController-1"><a href="#AssistantController-1" class="headerlink" title="AssistantController"></a>AssistantController</h4><p><strong>ä½œä¸ºå¯¹è¯æ¥å£çš„å…¥å£ï¼Œæ¥æ”¶ç”¨æˆ·è¯·æ±‚ï¼Œè°ƒç”¨åç«¯åŠ©æ‰‹é€»è¾‘è¿›è¡Œå¤„ç†ï¼Œå¹¶ä»¥ Server-Sent Eventsï¼ˆSSEï¼‰æ–¹å¼å°†å“åº”å†…å®¹å®æ—¶è¿”å›ç»™å‰ç«¯ã€‚</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * AssistantController æ˜¯ä¸€ä¸ª REST æ§åˆ¶å™¨ï¼Œç”¨äºå¤„ç†ä¸ç”¨æˆ·æ”¯æŒåŠ©æ‰‹ï¼ˆUserSupportAssistantï¼‰çš„å¯¹è¯è¯·æ±‚ã€‚</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * ä¸»è¦èŒè´£æ˜¯æ¥æ”¶å‰ç«¯ä¼ æ¥çš„å¯¹è¯å‚æ•°ï¼Œè°ƒç”¨ agentï¼ˆUserSupportAssistantï¼‰è¿›è¡Œä¼šè¯å¤„ç†ï¼Œå¹¶ä»¥ SSE æµæ–¹å¼è¿”å›å“åº”å†…å®¹ã€‚</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/assistant&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AssistantController</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserSupportAssistant agent;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AssistantController</span><span class="hljs-params">(UserSupportAssistant agent)</span> &#123;<br>        <span class="hljs-built_in">this</span>.agent = agent;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¸ç”¨æˆ·åŠ©æ‰‹è¿›è¡Œå¯¹è¯çš„æ¥å£</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chatId      å½“å‰å¯¹è¯çš„å”¯ä¸€ IDï¼ˆç”¨äºå…³è”ä¸Šä¸‹æ–‡ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userMessage ç”¨æˆ·å½“å‰è¾“å…¥çš„æ¶ˆæ¯å†…å®¹</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> Flux&lt;String&gt;ï¼šæœåŠ¡ç«¯äº‹ä»¶æµå“åº”ï¼Œå®æ—¶è¿”å› AI åŠ©æ‰‹çš„å›ç­”å†…å®¹</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/chat&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String chatId, <span class="hljs-meta">@RequestParam</span> String userMessage)</span> &#123;<br>        <span class="hljs-keyword">return</span> agent.chat(chatId, userMessage);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ol>
<li><p><strong>å¯¹å¤–æä¾› HTTP API æ¥å£ï¼š</strong></p>
<ul>
<li>è·¯å¾„å‰ç¼€æ˜¯ <code>/api/assistant</code>ï¼Œå­è·¯å¾„æ˜¯ <code>/chat</code>ï¼Œç”¨äºæ¥æ”¶ç”¨æˆ·çš„èŠå¤©è¯·æ±‚ã€‚</li>
</ul>
</li>
<li><p><strong>å‚æ•°æ¥æ”¶ï¼š</strong></p>
<ul>
<li><code>chatId</code>ï¼šå”¯ä¸€æ ‡è¯†ä¸€æ¬¡ä¼šè¯ï¼ˆä¾¿äºä¸Šä¸‹æ–‡ç®¡ç†ï¼‰ã€‚</li>
<li><code>userMessage</code>ï¼šç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯æ–‡æœ¬ã€‚</li>
</ul>
</li>
<li><p><strong>è°ƒç”¨åç«¯èŠå¤©é€»è¾‘ï¼š</strong></p>
<ul>
<li>å°†è¯·æ±‚å§”æ‰˜ç»™æ³¨å…¥çš„ <code>UserSupportAssistant</code> ç»„ä»¶å¤„ç†ï¼Œè¿™ä¸ªç»„ä»¶å°è£…äº†å®é™…çš„å¯¹è¯å¤„ç†æµç¨‹ï¼Œå¦‚ï¼šä¸Šä¸‹æ–‡ç®¡ç†ã€å¤§æ¨¡å‹äº¤äº’ã€å›å¤ç”Ÿæˆç­‰ã€‚</li>
</ul>
</li>
<li><p><strong>ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰è¿”å›æµå¼å“åº”ï¼š</strong></p>
<ul>
<li>è®¾ç½® <code>produces = MediaType.TEXT_EVENT_STREAM_VALUE</code>ï¼Œè¡¨æ˜è¯¥æ¥å£ä¼šè¿”å› <strong>å®æ—¶æµå¼æ•°æ®ï¼ˆ<code>Flux&lt;String&gt;</code>ï¼‰</strong>ã€‚</li>
<li>å‰ç«¯å¯ä»¥ä¸€è¾¹æ¥æ”¶ä¸€è¾¹å±•ç¤ºå›å¤ï¼Œæé«˜äº¤äº’ä½“éªŒï¼ˆç±»ä¼¼ ChatGPT æ‰“å­—æ•ˆæœï¼‰ã€‚</li>
</ul>
</li>
</ol>
<h4 id="UserSupportAssistant-1"><a href="#UserSupportAssistant-1" class="headerlink" title="UserSupportAssistant"></a>UserSupportAssistant</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç”¨æˆ·èŠå¤©æ”¯æŒåŠ©æ‰‹æœåŠ¡ç±»ã€‚</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * è¯¥ç±»å°è£…äº†ä¸€ä¸ªæ™ºèƒ½èŠå¤©å®¢æˆ·ç«¯ ChatClientï¼Œç”¨äºä¸ç”¨æˆ·è¿›è¡Œå¤šè½®å¯¹è¯äº¤äº’ï¼Œæ”¯æŒåŸºäºä¸Šä¸‹æ–‡çš„è¯­ä¹‰ç†è§£ä¸å‡½æ•°è°ƒç”¨ï¼Œ</span><br><span class="hljs-comment"> * å¯å®ç°å¯¹ç§’æ€ç³»ç»Ÿä¸­çš„æ´»åŠ¨æŸ¥è¯¢ã€æ´»åŠ¨é‡ç½®ã€æ´»åŠ¨å¼€å¯ã€è€—æ—¶ç»Ÿè®¡ç­‰åŠŸèƒ½çš„æ™ºèƒ½é—®ç­”ä¸æµç¨‹æ§åˆ¶ã€‚</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * ChatClient æ˜¯ä¸€ä¸ªç»“åˆå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰ã€èŠå¤©ä¸Šä¸‹æ–‡è®°å¿†ï¼ˆChatMemoryï¼‰ã€çŸ¥è¯†å‘é‡æ£€ç´¢ï¼ˆVectorStoreï¼‰ã€</span><br><span class="hljs-comment"> * ä»¥åŠå‡½æ•°è°ƒç”¨ï¼ˆfunction callingï¼‰èƒ½åŠ›çš„æ™ºèƒ½èŠå¤©ä»£ç†ã€‚</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserSupportAssistant</span> &#123;<br><br>    <span class="hljs-comment">// ChatClient å°è£…äº†èŠå¤©ä¸Šä¸‹æ–‡ç®¡ç†ã€è¯­ä¹‰æ£€ç´¢ã€æ—¥å¿—è®°å½•ç­‰å¤šä¸ªå¯¹è¯å¢å¼ºåŠŸèƒ½</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ„é€ å‡½æ•°æ³¨å…¥æ ¸å¿ƒä¾èµ–ï¼š</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> modelBuilder ç”¨äºæ„å»º ChatClient çš„ Builder å®ä¾‹ï¼ˆå« LLM é…ç½®ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> vectorStore  å‘é‡å­˜å‚¨å™¨ï¼Œç”¨äºè¯­ä¹‰ç›¸ä¼¼åº¦æ£€ç´¢ï¼ˆçŸ¥è¯†åº“é—®ç­”ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chatMemory   èŠå¤©ä¸Šä¸‹æ–‡è®°å¿†ç»„ä»¶ï¼Œç”¨äºä¿æŒå¤šè½®å¯¹è¯çš„å†å²ä¿¡æ¯</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserSupportAssistant</span><span class="hljs-params">(ChatClient.Builder modelBuilder, VectorStore vectorStore, ChatMemory chatMemory)</span> &#123;<br>        <span class="hljs-built_in">this</span>.chatClient = modelBuilder<br>                <span class="hljs-comment">// è®¾ç½®ç³»ç»Ÿé»˜è®¤æç¤ºè¯ï¼ˆsystem promptï¼‰ï¼ŒæŒ‡å¯¼ AI å¦‚ä½•å›å¤</span><br>                .defaultSystem(<span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">                    æ‚¨æ˜¯ç”¨æˆ·èŠå¤©æ”¯æŒä»£ç†ã€‚è¯·ä»¥å‹å¥½ã€ä¹äºåŠ©äººä¸”æ„‰å¿«çš„æ–¹å¼æ¥å›å¤ã€‚</span><br><span class="hljs-string">                    æ‚¨æ­£åœ¨é€šè¿‡åœ¨çº¿èŠå¤©ç³»ç»Ÿä¸ç”¨æˆ·äº’åŠ¨ã€‚</span><br><span class="hljs-string">                    æ‚¨èƒ½å¤Ÿæ”¯æŒå·²æœ‰ç§’æ€å•†å“è¯¦æƒ…æŸ¥è¯¢ã€å¼€å¯ç§’æ€æ´»åŠ¨ã€é‡ç½®ç§’æ€æ´»åŠ¨ç­‰æ“ä½œï¼Œå…¶ä½™åŠŸèƒ½å°†åœ¨åç»­ç‰ˆæœ¬ä¸­æ·»åŠ ï¼Œå¦‚æœç”¨æˆ·é—®çš„é—®é¢˜ä¸æ”¯æŒè¯·å‘ŠçŸ¥è¯¦æƒ…ã€‚</span><br><span class="hljs-string">                    åœ¨æä¾›æœ‰å…³ç§’æ€æ´»åŠ¨æŸ¥è¯¢ã€å¼€å¯ç§’æ€æ´»åŠ¨ã€é‡ç½®ç§’æ€æ´»åŠ¨ç­‰æ“ä½œä¹‹å‰ï¼Œæ‚¨å¿…é¡»å§‹ç»ˆä»ç”¨æˆ·å¤„è·å–ä»¥ä¸‹ä¿¡æ¯ï¼šç§’æ€æ´»åŠ¨idã€ç§’æ€å•†å“æ•°é‡ã€è¯·æ±‚æ¬¡æ•°ã€‚</span><br><span class="hljs-string">                    å¦‚æœéœ€è¦æå‰ç»“æŸç§’æ€æ´»åŠ¨ï¼Œæ‚¨å¿…é¡»åœ¨ç»§ç»­ä¹‹å‰å¾å¾—ç”¨æˆ·åŒæ„ã€‚</span><br><span class="hljs-string">                    ä½¿ç”¨æä¾›çš„åŠŸèƒ½è·å–ç§’æ€æ´»åŠ¨ä»¥åŠå•†å“è¯¦ç»†ä¿¡æ¯ã€å¼€å¯ç§’æ€æ´»åŠ¨å’Œé‡ç½®ç§’æ€ã€‚</span><br><span class="hljs-string">                    ç”¨æˆ·å¼€å§‹ç§’æ€æ´»åŠ¨åï¼Œç­‰å¾…10ç§’ï¼Œç„¶åè°ƒç”¨ è·å–ä»»åŠ¡è€—æ—¶ç»Ÿè®¡ä¿¡æ¯ å‡½æ•°ï¼Œæœ€åå°†å‡½æ•°ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</span><br><span class="hljs-string">                    å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥è°ƒç”¨ç›¸åº”å‡½æ•°è¾…åŠ©å®Œæˆã€‚</span><br><span class="hljs-string">                    è¯·è®²ä¸­æ–‡ã€‚</span><br><span class="hljs-string">                    ä»Šå¤©çš„æ—¥æœŸæ˜¯ &#123;current_date&#125;.</span><br><span class="hljs-string">                &quot;&quot;&quot;</span>)<br>                <span class="hljs-comment">// è®¾ç½®å¯¹è¯å¢å¼ºæ¨¡å—ï¼ˆé¡¾é—®ï¼‰ï¼šè®°å¿†ã€è¯­ä¹‰æ£€ç´¢ã€æ—¥å¿—è®°å½•</span><br>                .defaultAdvisors(<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptChatMemoryAdvisor</span>(chatMemory),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">QuestionAnswerAdvisor</span>(vectorStore, SearchRequest.builder().topK(<span class="hljs-number">4</span>).similarityThresholdAll().build()),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingAdvisor</span>()<br>                )<br>                <span class="hljs-comment">// æ³¨å†Œé»˜è®¤å¯è°ƒç”¨çš„å‡½æ•°ï¼ˆä¸åç«¯ä¸šåŠ¡é€»è¾‘ç»‘å®šï¼‰</span><br>                .defaultFunctions(<span class="hljs-string">&quot;startSeckill&quot;</span>, <span class="hljs-string">&quot;getTaskTimeInfo&quot;</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä¸»èŠå¤©å¤„ç†æ–¹æ³•ã€‚</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> chatId å½“å‰ç”¨æˆ·å¯¹è¯çš„å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºåŒºåˆ†ä¸åŒä¼šè¯ã€ç»‘å®šä¸Šä¸‹æ–‡ï¼‰</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userMessageContent ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯æ–‡æœ¬</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> è¿”å›ä¸€ä¸ª Flux&lt;String&gt;ï¼Œè¡¨ç¤ºæµå¼çš„èŠå¤©å“åº”ï¼ˆé€å¥è¿”å›ï¼‰</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(String chatId, String userMessageContent)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatClient<br>                .prompt()<br>                .system(s -&gt; s.param(<span class="hljs-string">&quot;current_date&quot;</span>, LocalDate.now().toString()))  <span class="hljs-comment">// å¡«å……ç³»ç»Ÿæç¤ºè¯ä¸­çš„åŠ¨æ€æ—¥æœŸ</span><br>                .user(userMessageContent) <span class="hljs-comment">// è®¾ç½®ç”¨æˆ·è¾“å…¥å†…å®¹</span><br>                .advisors(a -&gt; a<br>                    .param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId)   <span class="hljs-comment">// ç»‘å®šä¸Šä¸‹æ–‡ ID</span><br>                    .param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, <span class="hljs-number">100</span>)        <span class="hljs-comment">// è®¾ç½®å†å²ä¼šè¯æœ€å¤§æ£€ç´¢æ•°</span><br>                )<br>                .stream()  <span class="hljs-comment">// å¯åŠ¨æµå¼å“åº”</span><br>                .content(); <span class="hljs-comment">// è·å–å†…å®¹éƒ¨åˆ†ä½œä¸º Flux&lt;String&gt; è¿”å›</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<ol>
<li><p><strong>æ„é€ é˜¶æ®µï¼š</strong></p>
<ul>
<li>æ„å»º <code>ChatClient</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ™ºèƒ½èŠå¤©ä»£ç†ã€‚</li>
<li>é…ç½®äº†ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰ï¼Œç”¨äºè®¾å®š AI çš„è¯­æ°”å’Œè¡Œä¸ºè¾¹ç•Œã€‚</li>
<li>æ·»åŠ å¤šä¸ª â€œAdvisorâ€ é¡¾é—®æ¨¡å—ï¼š<ul>
<li><strong>è®°å¿†é¡¾é—®ï¼ˆChatMemoryAdvisorï¼‰</strong>ï¼šä¿æŒå¯¹è¯ä¸Šä¸‹æ–‡ã€‚</li>
<li><strong>è¯­ä¹‰æ£€ç´¢é¡¾é—®ï¼ˆVectorStore QAï¼‰</strong>ï¼šä»çŸ¥è¯†åº“ä¸­æŸ¥æ‰¾åŒ¹é…å›ç­”ã€‚</li>
<li><strong>æ—¥å¿—é¡¾é—®ï¼ˆLoggingAdvisorï¼‰</strong>ï¼šè®°å½•æ¯æ¬¡äº¤äº’æ—¥å¿—ã€‚</li>
</ul>
</li>
<li>æ³¨å†Œå¯è°ƒç”¨çš„å‡½æ•°ï¼ˆstartSeckillã€getTaskTimeInfoï¼‰ç”¨äºå¢å¼ºå¯¹è¯æ‰§è¡ŒåŠ›ã€‚</li>
</ul>
</li>
<li><p><strong>èŠå¤©é˜¶æ®µï¼ˆ<code>chat</code> æ–¹æ³•ï¼‰ï¼š</strong></p>
<ul>
<li>åŠ¨æ€è®¾ç½®å½“å‰æ—¥æœŸåˆ° prompt ä¸­ã€‚</li>
<li>æ¥æ”¶ç”¨æˆ·è¾“å…¥ä½œä¸ºå¯¹è¯å†…å®¹ã€‚</li>
<li>ä½¿ç”¨ chatId ç»‘å®šä¼šè¯ä¸Šä¸‹æ–‡ã€‚</li>
<li>è¿”å›ä¸€ä¸ª <strong>SSE æµå¼å“åº”ï¼ˆ<code>Flux&lt;String&gt;</code>ï¼‰</strong>ï¼Œå‰ç«¯å¯é€å¥å®æ—¶å±•ç¤ºå¯¹è¯ã€‚</li>
</ul>
</li>
</ol>
<h3 id="6-2-ä»€ä¹ˆæ˜¯Flux-æµå¼æ¶ˆæ¯"><a href="#6-2-ä»€ä¹ˆæ˜¯Flux-æµå¼æ¶ˆæ¯" class="headerlink" title="6.2 ä»€ä¹ˆæ˜¯Flux&lt;String&gt; æµå¼æ¶ˆæ¯?"></a>6.2 ä»€ä¹ˆæ˜¯<code>Flux&lt;String&gt;</code> æµå¼æ¶ˆæ¯?</h3><table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Flux<String></th>
<th>æ™®é€š String</th>
</tr>
</thead>
<tbody><tr>
<td>å“åº”ç±»å‹</td>
<td>å¼‚æ­¥æµï¼ˆå¤šæ¡ï¼‰</td>
<td>åŒæ­¥æ–‡æœ¬ï¼ˆå•æ¡ï¼‰</td>
</tr>
<tr>
<td>è¿”å›æ¨¡å¼</td>
<td>ä¸€æ¡æ¡æ¨é€</td>
<td>ä¸€æ¬¡æ€§è¿”å›</td>
</tr>
<tr>
<td>æ€§èƒ½ä¼˜åŠ¿</td>
<td>å‡å°‘å†…å­˜ã€æå‡ä½“éªŒ</td>
<td>å®¹æ˜“é˜»å¡</td>
</tr>
<tr>
<td>åœºæ™¯</td>
<td>èŠå¤©ã€æ—¥å¿—æµã€å®æ—¶é€šçŸ¥</td>
<td>è¡¨å•æäº¤ã€å›ºå®šå“åº”</td>
</tr>
</tbody></table>
<p>å‡è®¾æˆ‘ä»¬è¦æ¨¡æ‹Ÿä¸€ä¸ªâ€œAIå°åŠ©æ‰‹â€è¿ç»­å‘é€æ¶ˆæ¯çš„åœºæ™¯ï¼Œæ¯ 1 ç§’å‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæ€»å…±å‘ 5 æ¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/api/demo&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(value = &quot;/chat&quot;, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span><br>    <span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">streamChat</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Flux.interval(Duration.ofSeconds(<span class="hljs-number">1</span>))  <span class="hljs-comment">// æ¯ç§’å‘é€ä¸€æ¬¡</span><br>                   .take(<span class="hljs-number">5</span>)                         <span class="hljs-comment">// æ€»å…±å‘ 5 æ¬¡</span><br>                   .map(i -&gt; <span class="hljs-string">&quot;AIåŠ©æ‰‹æ¶ˆæ¯ #&quot;</span> + (i + <span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>å½“ä½ è®¿é—®å‰ç«¯é¡µé¢æ—¶ï¼ŒAIåŠ©æ‰‹ä¼šæ¯ç§’è¾“å‡ºä¸€å¥è¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">AIåŠ©æ‰‹æ¶ˆæ¯ <span class="hljs-comment">#1</span><br>AIåŠ©æ‰‹æ¶ˆæ¯ <span class="hljs-comment">#2</span><br>AIåŠ©æ‰‹æ¶ˆæ¯ <span class="hljs-comment">#3</span><br>AIåŠ©æ‰‹æ¶ˆæ¯ <span class="hljs-comment">#4</span><br>AIåŠ©æ‰‹æ¶ˆæ¯ <span class="hljs-comment">#5</span><br></code></pre></td></tr></table></figure>

<p>æ¶ˆæ¯ä¸€æ¡æ¡æ¨é€ï¼Œé¡µé¢è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€åˆ·æ–°æˆ–ç­‰å¾…æ•´ä½“å“åº”è¿”å›ï¼</p>
<p>åœ¨ AssistantController ä¸­ä½¿ç”¨ <code>Flux&lt;String&gt;</code> å°±æ˜¯å®ç°äº†è¿™ç§ æµå¼æ¨é€èŠå¤©ä½“éªŒï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°â€œAI æ­£åœ¨å®æ—¶å›å¤â€ï¼Œä¸æ˜¯ç­‰å¾ˆä¹…ä¸€å£æ°”å‘ä¸€æ®µé•¿æ–‡æœ¬ã€‚</p>
<h3 id="6-3-é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨Flux-æµå¼æ¶ˆæ¯ï¼Ÿ"><a href="#6-3-é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨Flux-æµå¼æ¶ˆæ¯ï¼Ÿ" class="headerlink" title="6.3 é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨Flux&lt;String&gt; æµå¼æ¶ˆæ¯ï¼Ÿ"></a>6.3 é¡¹ç›®ä¸­å¦‚ä½•ä½¿ç”¨<code>Flux&lt;String&gt;</code> æµå¼æ¶ˆæ¯ï¼Ÿ</h3><p>çœ‹ä¸‹é¢è¿™æ¡å…³é”®è¯­å¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">produces = MediaType.TEXT_EVENT_STREAM_VALUE<br></code></pre></td></tr></table></figure>

<p>å®ƒçš„æ„æ€æ˜¯ï¼š</p>
<blockquote>
<p>å‘Šè¯‰æµè§ˆå™¨&#x2F;å‰ç«¯ï¼šâ€œæˆ‘è¦ç”¨ <strong>SSEï¼ˆServer-Sent Eventsï¼‰åè®®</strong> æ¥æ¨é€æ–‡æœ¬æµï¼ŒåƒèŠå¤©ä¸€æ ·ä¸€æ¡ä¸€æ¡å‘â€ã€‚</p>
</blockquote>
<p>å†çœ‹ <code>UserSupportAssistant.chat()</code> çš„è¿”å›ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Flux&lt;String&gt; <span class="hljs-title function_">chat</span><span class="hljs-params">(String chatId, String userMessageContent)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatClient.prompt()<br>        .system(s -&gt; s.param(<span class="hljs-string">&quot;current_date&quot;</span>, LocalDate.now().toString()))<br>        .user(userMessageContent)<br>        .advisors(a -&gt; a.param(CHAT_MEMORY_CONVERSATION_ID_KEY, chatId).param(CHAT_MEMORY_RETRIEVE_SIZE_KEY, <span class="hljs-number">100</span>))<br>        .stream()<br>        .content();  <span class="hljs-comment">// è¿”å› Flux&lt;String&gt;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™æ®µé€»è¾‘å¯ä»¥æ‹†è§£ç†è§£ä¸ºï¼š</p>
<ol>
<li><code>prompt()</code> è®¾ç½®äº† AI èŠå¤©ä¸Šä¸‹æ–‡ï¼ˆå½“å‰æ—¥æœŸã€ç”¨æˆ·å†…å®¹ã€èŠå¤©å†å²ç­‰ï¼‰</li>
<li><code>.stream()</code> å¼€å¯æµå¼å“åº”ï¼ˆä¸æ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆå®Œæ•´å›ç­”ï¼Œè€Œæ˜¯<strong>è¾¹ç”Ÿæˆè¾¹æ¨é€</strong>ï¼‰</li>
<li><code>.content()</code> æŠŠä¸€æ¡æ¡ç”Ÿæˆçš„å›å¤å†…å®¹åŒ…è£…æˆ <code>Flux&lt;String&gt;</code> â€”â€” Spring WebFlux ä¼šå°†å®ƒè½¬åŒ–æˆæµå¼å“åº”è¿”å›ç»™å‰ç«¯ã€‚</li>
</ol>
<h3 id="6-4-AIæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#6-4-AIæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="6.4 AIæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>6.4 AIæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</h3><p>åœ¨æˆ‘çš„é¡¹ç›®ä¸­ï¼Œ<strong>ä½¿ç”¨çš„æ˜¯Spring AI Alibabaæä¾›çš„ChatClientæ¥å£</strong>ã€‚</p>
<p>è¦åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Spring AI Alibaba æä¾›çš„ <code>ChatClient</code> æ¥å£ï¼Œæ‚¨å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š</p>
<ol>
<li><p><strong>å¼•å…¥ä¾èµ–</strong>ï¼šåœ¨æ‚¨çš„ Maven é¡¹ç›®çš„ <code>pom.xml</code> æ–‡ä»¶ä¸­æ·»åŠ  <code>spring-ai-alibaba-starter</code> ä¾èµ–ï¼šîˆ†</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-alibaba-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0-M6.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>


<p>è¯·æ³¨æ„ï¼Œç”±äº <code>spring-ai</code> ç›¸å…³ä¾èµ–å°šæœªå‘å¸ƒåˆ°ä¸­å¤®ä»“åº“ï¼Œæ‚¨å¯èƒ½éœ€è¦åœ¨ <code>pom.xml</code> ä¸­æ·»åŠ  Spring çš„é‡Œç¨‹ç¢‘ä»“åº“ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">repositories</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>spring-milestones<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Spring Milestones<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">repositories</span>&gt;</span><br></code></pre></td></tr></table></figure>


<p>å¦‚æœæ‚¨çš„æœ¬åœ° Maven <code>settings.xml</code> æ–‡ä»¶ä¸­é…ç½®äº†é€šé…ç¬¦ <code>*</code> çš„é•œåƒï¼Œè¯·æ ¹æ®ä»¥ä¸‹ç¤ºä¾‹è¿›è¡Œè°ƒæ•´ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">mirror</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mirrorOf</span>&gt;</span>central<span class="hljs-tag">&lt;/<span class="hljs-name">mirrorOf</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://repo.maven.apache.org/maven2<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mirror</span>&gt;</span><br></code></pre></td></tr></table></figure>

</li>
<li><p><strong>åˆ›å»º ChatClient å®ä¾‹</strong>ï¼šåœ¨æ‚¨çš„ Spring Boot åº”ç”¨ä¸­ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ³¨å…¥ <code>ChatClient</code>ï¼šîˆ†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChatClient chatClient;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(ChatClient.Builder builder)</span> &#123;<br>        <span class="hljs-built_in">this</span>.chatClient = builder.build();<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/chat&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chat</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String input)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatClient.prompt()<br>            .user(input)<br>            .call()<br>            .content();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œ<code>ChatClient.Builder</code> ç”¨äºæ„å»º <code>ChatClient</code> å®ä¾‹ï¼Œ<code>chat</code> æ–¹æ³•æ¥æ”¶ç”¨æˆ·è¾“å…¥ï¼Œå¹¶é€šè¿‡ <code>ChatClient</code> ä¸ AI æ¨¡å‹è¿›è¡Œäº¤äº’ï¼Œè¿”å›ç”Ÿæˆçš„å“åº”ã€‚</p>
</li>
<li><p><strong>é…ç½®æ¨¡å‹æœåŠ¡</strong>ï¼šç¡®ä¿æ‚¨å·²åœ¨åº”ç”¨çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®äº†æ‰€éœ€çš„æ¨¡å‹æœåŠ¡å‚æ•°ï¼Œä¾‹å¦‚é˜¿é‡Œäº‘çš„ API å¯†é’¥ç­‰ã€‚è¿™äº›é…ç½®é€šå¸¸åŒ…æ‹¬æœåŠ¡çš„è®¿é—®å¯†é’¥ã€åŒºåŸŸç­‰ä¿¡æ¯ï¼Œä»¥ä¾¿ <code>ChatClient</code> èƒ½å¤Ÿæ­£ç¡®åœ°ä¸æ¨¡å‹æœåŠ¡è¿›è¡Œé€šä¿¡ã€‚</p>
</li>
<li><p><strong>å¤„ç†å“åº”</strong>ï¼šä½¿ç”¨ <code>ChatClient</code> çš„ <code>prompt()</code> æ–¹æ³•è®¾ç½®ç”¨æˆ·è¾“å…¥ï¼Œç„¶åè°ƒç”¨ <code>call()</code> æ–¹æ³•å‘é€è¯·æ±‚å¹¶è·å–å“åº”ã€‚æ‚¨å¯ä»¥æ ¹æ®éœ€è¦å¤„ç†è¿”å›çš„å†…å®¹ï¼Œä¾‹å¦‚å°†å…¶æ˜ å°„ä¸ºå®ä½“ç±»ã€è¿›è¡Œæµå¼å¤„ç†ç­‰ã€‚</p>
</li>
</ol>
<p>é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæ‚¨å¯ä»¥åœ¨é¡¹ç›®ä¸­é›†æˆå¹¶ä½¿ç”¨ Spring AI Alibaba æä¾›çš„ <code>ChatClient</code> æ¥å£ï¼Œå®ç°ä¸ AI æ¨¡å‹çš„äº¤äº’ã€‚</p>
<h3 id="6-5-ChatClientæ¥å£"><a href="#6-5-ChatClientæ¥å£" class="headerlink" title="6.5 ChatClientæ¥å£"></a>6.5 ChatClientæ¥å£</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-ai-alibaba/blob/main/README-zh.md?utm_source=chatgpt.com">Spring AI Alibabaå®˜ç½‘</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wanganui/article/details/145593518?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522d430c59fed4299cbb3beb65216e7841c%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=d430c59fed4299cbb3beb65216e7841c&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-145593518-null-null.142%5Ev102%5Epc_search_result_base2&utm_term=Spring%20AI%20ChatClient&spm=1018.2226.3001.4187">Spring AIè¿›é˜¶ï¼šAIèŠå¤©æœºå™¨äººä¹‹ChatMemoryæŒä¹…åŒ–ï¼ˆäºŒï¼‰</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_42402854/article/details/146404218?ops_request_misc=&request_id=&biz_id=102&utm_term=Spring%20AI%20ChatClient&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-5-146404218.142%5Ev102%5Epc_search_result_base2&spm=1018.2226.3001.4187">Spring AI Alibaba ChatClientä½¿ç”¨</a></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/JAVA/" class="category-chain-item">JAVA</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/JAVA/" class="print-no-link">#JAVA</a>
      
        <a href="/tags/SpringBoot/" class="print-no-link">#SpringBoot</a>
      
        <a href="/tags/SpringCloud/" class="print-no-link">#SpringCloud</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/05/09/Algorithm/Hot100/" title="LeetcodeHOT100åˆ·é¢˜ç¬”è®°">
                        <span class="hidden-mobile">LeetcodeHOT100åˆ·é¢˜ç¬”è®°</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"sj2tGuxMGSDhkN5hNuOIVta1-gzGzoHsz","appKey":"ysR5OTuTzoby2oNvNyGOtXFQ","path":"window.location.pathname","placeholder":"å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>AI</span> <i class="iconfont icon-love"></i> <span>CPP</span> <i class="iconfont icon-love"></i> <span>JAVA</span> <i class="iconfont icon-love"></i> <span>CyberSec</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>
<script src="/js/bubble.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>
