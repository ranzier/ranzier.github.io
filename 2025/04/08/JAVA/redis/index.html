

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/about/dogs.jpg">
  <link rel="icon" href="/img/about/dogs.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ranzier">
  <meta name="keywords" content="">
  
    <meta name="description" content="Rediså­¦ä¹ ç¬”è®°   ä¸€. Rediså¿«é€Ÿå…¥é—¨1. åˆè¯†Redis Redisæ˜¯ä¸€ç§é”®å€¼å‹çš„NoSqlæ•°æ®åº“ å…¨ç§°æ˜¯Remote  Dictionary Server è¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚  ç‰¹å¾ï¼š  é”®å€¼ï¼ˆkey-valueï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§ ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ã€‚ æ”¯æŒ">
<meta property="og:type" content="article">
<meta property="og:title" content="Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ">
<meta property="og:url" content="http://example.com/2025/04/08/JAVA/redis/index.html">
<meta property="og:site_name" content="RANZIER">
<meta property="og:description" content="Rediså­¦ä¹ ç¬”è®°   ä¸€. Rediså¿«é€Ÿå…¥é—¨1. åˆè¯†Redis Redisæ˜¯ä¸€ç§é”®å€¼å‹çš„NoSqlæ•°æ®åº“ å…¨ç§°æ˜¯Remote  Dictionary Server è¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚  ç‰¹å¾ï¼š  é”®å€¼ï¼ˆkey-valueï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§ ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ã€‚ æ”¯æŒ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg/33.jpg">
<meta property="article:published_time" content="2025-04-08T12:33:09.000Z">
<meta property="article:modified_time" content="2025-10-14T06:51:04.608Z">
<meta property="article:author" content="ranzier">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="å­¦ä¹ ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/bg/33.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ - RANZIER</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">
<link rel="stylesheet" href="/css/bubble.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸŒŸ","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RANZIER</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.35)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-08 20:33" pubdate>
          2025å¹´4æœˆ8æ—¥ æ™šä¸Š
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          46k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          231 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          æœ¬æ–‡é˜…è¯»æ¬¡æ•°ï¼š<span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ</h1>
            
            
              <div class="markdown-body">
                
                <h1 align="center">Rediså­¦ä¹ ç¬”è®°</h1>


<h1 id="ä¸€-Rediså¿«é€Ÿå…¥é—¨"><a href="#ä¸€-Rediså¿«é€Ÿå…¥é—¨" class="headerlink" title="ä¸€. Rediså¿«é€Ÿå…¥é—¨"></a>ä¸€. Rediså¿«é€Ÿå…¥é—¨</h1><h2 id="1-åˆè¯†Redis"><a href="#1-åˆè¯†Redis" class="headerlink" title="1. åˆè¯†Redis"></a>1. åˆè¯†Redis</h2><ul>
<li>Redisæ˜¯ä¸€ç§<strong>é”®å€¼å‹</strong>çš„<strong>NoSqlæ•°æ®åº“</strong></li>
<li>å…¨ç§°æ˜¯<strong>Re</strong>mote  <strong>D</strong>ictionary <strong>S</strong>erver è¿œç¨‹è¯å…¸æœåŠ¡å™¨ï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„é”®å€¼å‹NoSQLæ•°æ®åº“ã€‚</li>
</ul>
<p><strong>ç‰¹å¾</strong>ï¼š</p>
<ul>
<li>é”®å€¼ï¼ˆkey-valueï¼‰å‹ï¼Œvalueæ”¯æŒå¤šç§ä¸åŒæ•°æ®ç»“æ„ï¼ŒåŠŸèƒ½ä¸°å¯Œ</li>
<li>å•çº¿ç¨‹ï¼Œæ¯ä¸ªå‘½ä»¤å…·å¤‡åŸå­æ€§</li>
<li>ä½å»¶è¿Ÿï¼Œé€Ÿåº¦å¿«ï¼ˆåŸºäºå†…å­˜ã€IOå¤šè·¯å¤ç”¨ã€è‰¯å¥½çš„ç¼–ç ï¼‰ã€‚</li>
<li>æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ”¯æŒä¸»ä»é›†ç¾¤ã€åˆ†ç‰‡é›†ç¾¤</li>
<li>æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯</li>
</ul>
<h2 id="2-Rediså¸¸è§å‘½ä»¤"><a href="#2-Rediså¸¸è§å‘½ä»¤" class="headerlink" title="2. Rediså¸¸è§å‘½ä»¤"></a>2. Rediså¸¸è§å‘½ä»¤</h2><p>Redisæ˜¯å…¸å‹çš„key-valueæ•°æ®åº“ï¼Œkeyä¸€èˆ¬æ˜¯å­—ç¬¦ä¸²ï¼Œè€ŒvalueåŒ…å«å¾ˆå¤šä¸åŒçš„æ•°æ®ç±»å‹</p>
<p><img src="/img/blogs/java/redis/1.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-1-Redisé€šç”¨å‘½ä»¤"><a href="#2-1-Redisé€šç”¨å‘½ä»¤" class="headerlink" title="2.1 Redisé€šç”¨å‘½ä»¤"></a>2.1 Redisé€šç”¨å‘½ä»¤</h3><p>éƒ½å¯ä»¥ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œå¸¸è§çš„æœ‰ï¼š</p>
<ul>
<li>KEYSï¼šæŸ¥çœ‹ç¬¦åˆæ¨¡æ¿çš„æ‰€æœ‰key</li>
<li>DELï¼šåˆ é™¤ä¸€ä¸ªæŒ‡å®šçš„key</li>
<li>EXISTSï¼šåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨</li>
<li>EXPIREï¼šç»™ä¸€ä¸ªkey<strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼Œæœ‰æ•ˆæœŸåˆ°æœŸæ—¶è¯¥keyä¼šè¢«è‡ªåŠ¨åˆ é™¤</li>
<li>TTLï¼šæŸ¥çœ‹ä¸€ä¸ªKEYçš„<strong>å‰©ä½™æœ‰æ•ˆæœŸ</strong></li>
</ul>
<h3 id="2-2-Stringç±»å‹"><a href="#2-2-Stringç±»å‹" class="headerlink" title="2.2 Stringç±»å‹"></a>2.2 Stringç±»å‹</h3><p>å…¶valueæ˜¯å­—ç¬¦ä¸²ï¼Œä¸è¿‡æ ¹æ®å­—ç¬¦ä¸²çš„æ ¼å¼ä¸åŒï¼Œåˆå¯ä»¥åˆ†ä¸º3ç±»:</p>
<ul>
<li>stringï¼šæ™®é€šå­—ç¬¦ä¸²</li>
<li>intï¼šæ•´æ•°ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li>
<li>floatï¼šæµ®ç‚¹ç±»å‹ï¼Œå¯ä»¥åšè‡ªå¢ã€è‡ªå‡æ“ä½œ</li>
</ul>
<p><strong>Stringçš„å¸¸è§å‘½ä»¤æœ‰</strong>ï¼š</p>
<ul>
<li>SETï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹å·²ç»å­˜åœ¨çš„ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹</li>
<li>GETï¼šæ ¹æ®keyè·å–Stringç±»å‹çš„value</li>
<li>MSETï¼šæ‰¹é‡æ·»åŠ å¤šä¸ªStringç±»å‹çš„é”®å€¼å¯¹</li>
<li>MGETï¼šæ ¹æ®å¤šä¸ªkeyè·å–å¤šä¸ªStringç±»å‹çš„value</li>
<li>INCRï¼šè®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢1</li>
<li>INCRBY:è®©ä¸€ä¸ªæ•´å‹çš„keyè‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿ï¼Œä¾‹å¦‚ï¼šincrby num 2 è®©numå€¼è‡ªå¢2</li>
<li>INCRBYFLOATï¼šè®©ä¸€ä¸ªæµ®ç‚¹ç±»å‹çš„æ•°å­—è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</li>
<li>SETNXï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå‰ææ˜¯è¿™ä¸ªkeyä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li>
<li>SETEXï¼šæ·»åŠ ä¸€ä¸ªStringç±»å‹çš„é”®å€¼å¯¹ï¼Œå¹¶ä¸”æŒ‡å®šæœ‰æ•ˆæœŸ</li>
</ul>
<h3 id="2-3-Keyç»“æ„"><a href="#2-3-Keyç»“æ„" class="headerlink" title="2.3 Keyç»“æ„"></a>2.3 Keyç»“æ„</h3><p>é€šè¿‡ç»™keyæ·»åŠ å‰ç¼€åŠ ä»¥åŒºåˆ†,Redisçš„keyå…è®¸æœ‰å¤šä¸ªå•è¯å½¢æˆ<strong>å±‚çº§ç»“æ„</strong>ï¼Œå¤šä¸ªå•è¯ä¹‹é—´ç”¨â€™:â€™éš”å¼€ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">é¡¹ç›®å:ä¸šåŠ¡å:ç±»å‹:<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p>ä¾‹å¦‚æˆ‘ä»¬çš„é¡¹ç›®åç§°å« heimaï¼Œæœ‰userå’Œproductä¸¤ç§ä¸åŒç±»å‹çš„æ•°æ®ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·å®šä¹‰keyï¼š</p>
<ul>
<li>userç›¸å…³çš„keyï¼š<strong>heima:user:1</strong></li>
<li>productç›¸å…³çš„keyï¼š<strong>heima:product:1</strong></li>
</ul>
<h3 id="2-4-Hashç±»å‹"><a href="#2-4-Hashç±»å‹" class="headerlink" title="2.4 Hashç±»å‹"></a>2.4 Hashç±»å‹</h3><p>Hashç±»å‹ï¼Œä¹Ÿå«æ•£åˆ—ï¼Œå…¶valueæ˜¯ä¸€ä¸ªæ— åºå­—å…¸ï¼Œç±»ä¼¼äºJavaä¸­çš„HashMapç»“æ„ã€‚</p>
<p><img src="/img/blogs/java/redis/1.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Hashçš„å¸¸è§å‘½ä»¤æœ‰</strong>ï¼š</p>
<ul>
<li>HSET key field valueï¼šæ·»åŠ æˆ–è€…ä¿®æ”¹hashç±»å‹keyçš„fieldçš„å€¼</li>
<li>HGET key fieldï¼šè·å–ä¸€ä¸ªhashç±»å‹keyçš„fieldçš„å€¼</li>
<li>HMSETï¼šæ‰¹é‡æ·»åŠ å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼</li>
<li>HMGETï¼šæ‰¹é‡è·å–å¤šä¸ªhashç±»å‹keyçš„fieldçš„å€¼</li>
<li>HGETALLï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„fieldå’Œvalue</li>
<li>HKEYSï¼šè·å–ä¸€ä¸ªhashç±»å‹çš„keyä¸­çš„æ‰€æœ‰çš„field</li>
<li>HINCRBY:è®©ä¸€ä¸ªhashç±»å‹keyçš„å­—æ®µå€¼è‡ªå¢å¹¶æŒ‡å®šæ­¥é•¿</li>
<li>HSETNXï¼šæ·»åŠ ä¸€ä¸ªhashç±»å‹çš„keyçš„fieldå€¼ï¼Œå‰ææ˜¯è¿™ä¸ªfieldä¸å­˜åœ¨ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li>
</ul>
<h3 id="2-5-Listç±»å‹"><a href="#2-5-Listç±»å‹" class="headerlink" title="2.5 Listç±»å‹"></a>2.5 Listç±»å‹</h3><p>Redisä¸­çš„Listç±»å‹ä¸Javaä¸­çš„<strong>LinkedList</strong>ç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ª<strong>åŒå‘é“¾è¡¨</strong>ç»“æ„ã€‚æ—¢å¯ä»¥æ”¯æŒæ­£å‘æ£€ç´¢å’Œä¹Ÿå¯ä»¥æ”¯æŒåå‘æ£€ç´¢</p>
<p>ç‰¹å¾ä¹Ÿä¸LinkedListç±»ä¼¼ï¼š</p>
<ul>
<li>æœ‰åº</li>
<li>å…ƒç´ å¯ä»¥é‡å¤</li>
<li>æ’å…¥å’Œåˆ é™¤å¿«</li>
<li>æŸ¥è¯¢é€Ÿåº¦ä¸€èˆ¬</li>
</ul>
<p>å¸¸ç”¨æ¥å­˜å‚¨ä¸€ä¸ªæœ‰åºæ•°æ®ï¼Œä¾‹å¦‚ï¼šæœ‹å‹åœˆç‚¹èµåˆ—è¡¨ï¼Œè¯„è®ºåˆ—è¡¨ç­‰ã€‚</p>
<p>Listçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>LPUSH key element â€¦ ï¼šå‘åˆ—è¡¨å·¦ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li>
<li>LPOP keyï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å·¦ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œæ²¡æœ‰åˆ™è¿”å›nil</li>
<li>RPUSH key element â€¦ ï¼šå‘åˆ—è¡¨å³ä¾§æ’å…¥ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li>
<li>RPOP keyï¼šç§»é™¤å¹¶è¿”å›åˆ—è¡¨å³ä¾§çš„ç¬¬ä¸€ä¸ªå…ƒç´ </li>
<li>LRANGE key star endï¼šè¿”å›ä¸€æ®µè§’æ ‡èŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ </li>
<li>BLPOPå’ŒBRPOPï¼šä¸LPOPå’ŒRPOPç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æ²¡æœ‰å…ƒç´ æ—¶ç­‰å¾…æŒ‡å®šæ—¶é—´ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›nil</li>
</ul>
<h3 id="2-6-Setç±»å‹"><a href="#2-6-Setç±»å‹" class="headerlink" title="2.6 Setç±»å‹"></a>2.6 Setç±»å‹</h3><p>Redisçš„Setç»“æ„ä¸Javaä¸­çš„HashSetç±»ä¼¼ï¼Œå¯ä»¥çœ‹åšæ˜¯ä¸€ä¸ªvalueä¸ºnullçš„HashMap</p>
<p>Setçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>SADD key member â€¦ ï¼šå‘setä¸­æ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ </li>
<li>SREM key member â€¦ : ç§»é™¤setä¸­çš„æŒ‡å®šå…ƒç´ </li>
<li>SCARD keyï¼š è¿”å›setä¸­å…ƒç´ çš„ä¸ªæ•°</li>
<li>SISMEMBER key memberï¼šåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å­˜åœ¨äºsetä¸­</li>
<li>SMEMBERSï¼šè·å–setä¸­çš„æ‰€æœ‰å…ƒç´ </li>
<li>SINTER key1 key2 â€¦ ï¼šæ±‚key1ä¸key2çš„äº¤é›†</li>
</ul>
<h3 id="2-7-SortedSetç±»å‹"><a href="#2-7-SortedSetç±»å‹" class="headerlink" title="2.7 SortedSetç±»å‹"></a>2.7 SortedSetç±»å‹</h3><p>Redisçš„SortedSetæ˜¯ä¸€ä¸ªå¯æ’åºçš„seté›†åˆ</p>
<p>SortedSetå…·å¤‡ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li>å¯æ’åº</li>
<li>å…ƒç´ ä¸é‡å¤</li>
<li>æŸ¥è¯¢é€Ÿåº¦å¿«</li>
</ul>
<p>å› ä¸ºSortedSetçš„<strong>å¯æ’åºç‰¹æ€§</strong>ï¼Œç»å¸¸è¢«ç”¨æ¥å®ç°æ’è¡Œæ¦œè¿™æ ·çš„åŠŸèƒ½ã€‚</p>
<p>SortedSetçš„å¸¸è§å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>ZADD key score memberï¼šæ·»åŠ ä¸€ä¸ªæˆ–å¤šä¸ªå…ƒç´ åˆ°sorted set ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™æ›´æ–°å…¶scoreå€¼</li>
<li>ZREM key memberï¼šåˆ é™¤sorted setä¸­çš„ä¸€ä¸ªæŒ‡å®šå…ƒç´ </li>
<li>ZSCORE key member : è·å–sorted setä¸­çš„æŒ‡å®šå…ƒç´ çš„scoreå€¼</li>
<li>ZRANK key memberï¼šè·å–sorted set ä¸­çš„æŒ‡å®šå…ƒç´ çš„æ’å</li>
<li>ZCARD keyï¼šè·å–sorted setä¸­çš„å…ƒç´ ä¸ªæ•°</li>
<li>ZCOUNT key min maxï¼šç»Ÿè®¡scoreå€¼åœ¨ç»™å®šèŒƒå›´å†…çš„æ‰€æœ‰å…ƒç´ çš„ä¸ªæ•°</li>
<li>ZINCRBY key increment memberï¼šè®©sorted setä¸­çš„æŒ‡å®šå…ƒç´ è‡ªå¢ï¼Œæ­¥é•¿ä¸ºæŒ‡å®šçš„incrementå€¼</li>
<li>ZRANGE key min maxï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šæ’åèŒƒå›´å†…çš„å…ƒç´ </li>
<li>ZRANGEBYSCORE key min maxï¼šæŒ‰ç…§scoreæ’åºåï¼Œè·å–æŒ‡å®šscoreèŒƒå›´å†…çš„å…ƒç´ </li>
<li>ZDIFFã€ZINTERã€ZUNIONï¼šæ±‚å·®é›†ã€äº¤é›†ã€å¹¶é›†</li>
</ul>
<p>æ³¨æ„ï¼šæ‰€æœ‰çš„æ’åé»˜è®¤éƒ½æ˜¯å‡åºï¼Œå¦‚æœè¦é™åºåˆ™åœ¨å‘½ä»¤çš„Zåé¢æ·»åŠ REVå³å¯</p>
<h2 id="3-Redisçš„Javaå®¢æˆ·ç«¯"><a href="#3-Redisçš„Javaå®¢æˆ·ç«¯" class="headerlink" title="3. Redisçš„Javaå®¢æˆ·ç«¯"></a>3. Redisçš„Javaå®¢æˆ·ç«¯</h2><ul>
<li>Jediså’ŒLettuceï¼šè¿™ä¸¤ä¸ªä¸»è¦æ˜¯æä¾›äº†Rediså‘½ä»¤å¯¹åº”çš„APIï¼Œæ–¹ä¾¿æˆ‘ä»¬æ“ä½œRedisï¼Œè€ŒSpringDataRedisåˆå¯¹è¿™ä¸¤ç§åšäº†æŠ½è±¡å’Œå°è£…ï¼Œå› æ­¤æˆ‘ä»¬åæœŸä¼šç›´æ¥ä»¥SpringDataRedisæ¥å­¦ä¹ ã€‚</li>
<li>Redissonï¼šæ˜¯åœ¨RedisåŸºç¡€ä¸Šå®ç°äº†åˆ†å¸ƒå¼çš„å¯ä¼¸ç¼©çš„javaæ•°æ®ç»“æ„ï¼Œä¾‹å¦‚Mapã€Queueç­‰ï¼Œè€Œä¸”æ”¯æŒè·¨è¿›ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼šLockã€Semaphoreç­‰å¾…ï¼Œæ¯”è¾ƒé€‚åˆç”¨æ¥å®ç°ç‰¹æ®Šçš„åŠŸèƒ½éœ€æ±‚ã€‚</li>
</ul>
<h3 id="3-1-Jediså®¢æˆ·ç«¯"><a href="#3-1-Jediså®¢æˆ·ç«¯" class="headerlink" title="3.1 Jediså®¢æˆ·ç«¯"></a>3.1 Jediså®¢æˆ·ç«¯</h3><h4 id="3-1-1-å¿«é€Ÿå…¥é—¨"><a href="#3-1-1-å¿«é€Ÿå…¥é—¨" class="headerlink" title="3.1.1 å¿«é€Ÿå…¥é—¨"></a>3.1.1 å¿«é€Ÿå…¥é—¨</h4><ol>
<li>å¼•å…¥ä¾èµ–ï¼š</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--jedis--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å»ºç«‹è¿æ¥<br>æ–°å»ºä¸€ä¸ªå•å…ƒæµ‹è¯•ç±»ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Jedis jedis;<br><br><span class="hljs-meta">@BeforeEach</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.å»ºç«‹è¿æ¥</span><br>    <span class="hljs-comment">// jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span><br>    jedis = JedisConnectionFactory.getJedis();<br>    <span class="hljs-comment">// 2.è®¾ç½®å¯†ç </span><br>    jedis.auth(<span class="hljs-string">&quot;123321&quot;</span>);<br>    <span class="hljs-comment">// 3.é€‰æ‹©åº“</span><br>    jedis.select(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>æµ‹è¯•ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// å­˜å…¥æ•°æ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è™å“¥&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;result = &quot;</span> + result);<br>    <span class="hljs-comment">// è·å–æ•°æ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;name = &quot;</span> + name);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>é‡Šæ”¾èµ„æº</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterEach</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (jedis != <span class="hljs-literal">null</span>) &#123;<br>        jedis.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-è¿æ¥æ± "><a href="#3-1-2-è¿æ¥æ± " class="headerlink" title="3.1.2 è¿æ¥æ± "></a>3.1.2 è¿æ¥æ± </h4><p>Jedisæœ¬èº«æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¹¶ä¸”é¢‘ç¹çš„åˆ›å»ºå’Œé”€æ¯è¿æ¥ä¼šæœ‰æ€§èƒ½æŸè€—ï¼Œå› æ­¤æˆ‘ä»¬<strong>ä½¿ç”¨Jedisè¿æ¥æ± ä»£æ›¿Jedisçš„ç›´è¿æ–¹å¼</strong>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisConnectionFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">// é…ç½®è¿æ¥æ± </span><br>        <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>        poolConfig.setMaxTotal(<span class="hljs-number">8</span>);<br>        poolConfig.setMaxIdle(<span class="hljs-number">8</span>);<br>        poolConfig.setMinIdle(<span class="hljs-number">0</span>);<br>        poolConfig.setMaxWaitMillis(<span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">// åˆ›å»ºè¿æ¥æ± å¯¹è±¡ï¼Œå‚æ•°ï¼šè¿æ¥æ± é…ç½®ã€æœåŠ¡ç«¯ipã€æœåŠ¡ç«¯ç«¯å£ã€è¶…æ—¶æ—¶é—´ã€å¯†ç </span><br>        jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig, <span class="hljs-string">&quot;192.168.150.101&quot;</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">&quot;123321&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-SpringDataRediså®¢æˆ·ç«¯"><a href="#3-2-SpringDataRediså®¢æˆ·ç«¯" class="headerlink" title="3.2 SpringDataRediså®¢æˆ·ç«¯"></a>3.2 SpringDataRediså®¢æˆ·ç«¯</h3><p>SpringDataæ˜¯Springä¸­æ•°æ®æ“ä½œçš„æ¨¡å—ï¼ŒåŒ…å«å¯¹å„ç§æ•°æ®åº“çš„é›†æˆï¼Œå…¶ä¸­<strong>å¯¹Redisçš„é›†æˆæ¨¡å—å°±å«åšSpringDataRedis</strong></p>
<ul>
<li>æä¾›äº†<strong>å¯¹ä¸åŒRediså®¢æˆ·ç«¯çš„æ•´åˆï¼ˆLettuceå’ŒJedisï¼‰</strong></li>
<li>æä¾›äº†RedisTemplateç»Ÿä¸€APIæ¥æ“ä½œRedis</li>
<li>æ”¯æŒRedisçš„å‘å¸ƒè®¢é˜…æ¨¡å‹</li>
<li>æ”¯æŒRediså“¨å…µå’ŒRedisé›†ç¾¤</li>
<li>æ”¯æŒåŸºäºLettuceçš„å“åº”å¼ç¼–ç¨‹</li>
<li>æ”¯æŒåŸºäºJDKã€JSONã€å­—ç¬¦ä¸²ã€Springå¯¹è±¡çš„æ•°æ®åºåˆ—åŒ–åŠååºåˆ—åŒ–</li>
<li>æ”¯æŒåŸºäºRedisçš„JDKCollectionå®ç°</li>
</ul>
<p>SpringDataRedisä¸­æä¾›äº†RedisTemplateå·¥å…·ç±»ï¼Œå…¶ä¸­å°è£…äº†å„ç§å¯¹Redisçš„æ“ä½œã€‚å¹¶ä¸”å°†ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œAPIå°è£…åˆ°äº†ä¸åŒçš„ç±»å‹ä¸­ï¼š</p>
<p><img src="/img/blogs/java/redis/1.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-1-å¿«é€Ÿå…¥é—¨"><a href="#3-2-1-å¿«é€Ÿå…¥é—¨" class="headerlink" title="3.2.1 å¿«é€Ÿå…¥é—¨"></a>3.2.1 å¿«é€Ÿå…¥é—¨</h4><ol>
<li>å¼•å…¥ä¾èµ–</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--redisä¾èµ–--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--common-pool--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®Redis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123321</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">100ms</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>æ³¨å…¥RedisTemplate</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStringTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ç¼–å†™æµ‹è¯•</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStringTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate edisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// å†™å…¥ä¸€æ¡Stringæ•°æ®</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è™å“¥&quot;</span>);<br>        <span class="hljs-comment">// è·å–stringæ•°æ®</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;name = &quot;</span> + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-è‡ªå®šä¹‰åºåˆ—åŒ–"><a href="#3-2-2-è‡ªå®šä¹‰åºåˆ—åŒ–" class="headerlink" title="3.2.2 è‡ªå®šä¹‰åºåˆ—åŒ–"></a>3.2.2 è‡ªå®šä¹‰åºåˆ—åŒ–</h4><p>RedisTemplateå¯ä»¥æ¥æ”¶ä»»æ„Objectä½œä¸ºå€¼å†™å…¥Redisï¼š<br>åªä¸è¿‡å†™å…¥å‰ä¼šæŠŠObjectåºåˆ—åŒ–ä¸ºå­—èŠ‚å½¢å¼ï¼Œé»˜è®¤æ˜¯é‡‡ç”¨JDKåºåˆ—åŒ–ï¼Œå¾—åˆ°çš„ç»“æœæ˜¯åºåˆ—åŒ–ä¹‹åçš„å­—ç¬¦ä¸²ã€‚å¯è¯»æ€§å·®ï¼Œå†…å­˜å ç”¨è¾ƒå¤§ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰RedisTemplateçš„åºåˆ—åŒ–æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span>&#123;<br>        <span class="hljs-comment">// åˆ›å»ºRedisTemplateå¯¹è±¡</span><br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        <span class="hljs-comment">// è®¾ç½®è¿æ¥å·¥å‚</span><br>        template.setConnectionFactory(connectionFactory);<br>        <span class="hljs-comment">// åˆ›å»ºJSONåºåˆ—åŒ–å·¥å…·</span><br>        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonRedisSerializer</span> <span class="hljs-operator">=</span> <br>            							<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br>        <span class="hljs-comment">// è®¾ç½®Keyçš„åºåˆ—åŒ–</span><br>        template.setKeySerializer(RedisSerializer.string());<br>        template.setHashKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// è®¾ç½®Valueçš„åºåˆ—åŒ–</span><br>        template.setValueSerializer(jsonRedisSerializer);<br>        template.setHashValueSerializer(jsonRedisSerializer);<br>        <span class="hljs-comment">// è¿”å›</span><br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-3-StringRedisTemplate"><a href="#3-2-3-StringRedisTemplate" class="headerlink" title="3.2.3 StringRedisTemplate"></a>3.2.3 StringRedisTemplate</h4><p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ä½¿ç”¨JSONåºåˆ—åŒ–å™¨æ¥å¤„ç†valueï¼Œè€Œæ˜¯ç»Ÿä¸€ä½¿ç”¨Stringåºåˆ—åŒ–å™¨ï¼Œè¦æ±‚åªèƒ½å­˜å‚¨Stringç±»å‹çš„keyå’Œvalueã€‚å½“éœ€è¦å­˜å‚¨Javaå¯¹è±¡æ—¶ï¼Œæ‰‹åŠ¨å®Œæˆå¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<p><img src="/img/blogs/java/redis/1.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p>StringRedisTemplateï¼Œå®ƒçš„keyå’Œvalueçš„åºåˆ—åŒ–æ–¹å¼é»˜è®¤å°±æ˜¯Stringæ–¹å¼ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><span class="hljs-comment">// JSONåºåˆ—åŒ–å·¥å…·</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>    <span class="hljs-comment">// åˆ›å»ºå¯¹è±¡</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;è™å“¥&quot;</span>, <span class="hljs-number">21</span>);<br>    <span class="hljs-comment">// æ‰‹åŠ¨åºåˆ—åŒ–</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(user);<br>    <span class="hljs-comment">// å†™å…¥æ•°æ®</span><br>    stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:200&quot;</span>, json);<br><br>    <span class="hljs-comment">// è·å–æ•°æ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonUser</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:200&quot;</span>);<br>    <span class="hljs-comment">// æ‰‹åŠ¨ååºåˆ—åŒ–</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper.readValue(jsonUser, User.class);<br>    System.out.println(<span class="hljs-string">&quot;user1 = &quot;</span> + user1);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="äºŒ-å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„"><a href="#äºŒ-å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„" class="headerlink" title="äºŒ. å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„"></a>äºŒ. å®æˆ˜ç¯‡-é»‘é©¬ç‚¹è¯„</h1><p><img src="/img/blogs/java/redis/2.0.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="1-çŸ­ä¿¡ç™»å½•"><a href="#1-çŸ­ä¿¡ç™»å½•" class="headerlink" title="1. çŸ­ä¿¡ç™»å½•"></a>1. çŸ­ä¿¡ç™»å½•</h2><h3 id="1-1-åŸºäºSessionå®ç°ç™»å½•æµç¨‹"><a href="#1-1-åŸºäºSessionå®ç°ç™»å½•æµç¨‹" class="headerlink" title="1.1 åŸºäºSessionå®ç°ç™»å½•æµç¨‹"></a>1.1 åŸºäºSessionå®ç°ç™»å½•æµç¨‹</h3><p><img src="/img/blogs/java/redis/2.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>å‘é€éªŒè¯ç ï¼š</strong></p>
<p>ç”¨æˆ·åœ¨æäº¤æ‰‹æœºå·åï¼Œä¼šæ ¡éªŒæ‰‹æœºå·æ˜¯å¦åˆæ³•ï¼Œå¦‚æœä¸åˆæ³•ï¼Œåˆ™è¦æ±‚ç”¨æˆ·é‡æ–°è¾“å…¥æ‰‹æœºå·</p>
<p>å¦‚æœæ‰‹æœºå·åˆæ³•ï¼Œåå°æ­¤æ—¶ç”Ÿæˆå¯¹åº”çš„éªŒè¯ç ï¼ŒåŒæ—¶å°†éªŒè¯ç è¿›è¡Œä¿å­˜ï¼Œç„¶åå†é€šè¿‡çŸ­ä¿¡çš„æ–¹å¼å°†éªŒè¯ç å‘é€ç»™ç”¨æˆ·</p>
<p><strong>çŸ­ä¿¡éªŒè¯ç ç™»å½•ã€æ³¨å†Œï¼š</strong></p>
<p>ç”¨æˆ·å°†éªŒè¯ç å’Œæ‰‹æœºå·è¿›è¡Œè¾“å…¥ï¼Œåå°ä»sessionä¸­æ‹¿åˆ°å½“å‰éªŒè¯ç ï¼Œç„¶åå’Œç”¨æˆ·è¾“å…¥çš„éªŒè¯ç è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœä¸ä¸€è‡´ï¼Œåˆ™æ— æ³•é€šè¿‡æ ¡éªŒï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™åå°æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ï¼Œå¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ™ä¸ºç”¨æˆ·åˆ›å»ºè´¦å·ä¿¡æ¯ï¼Œä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ— è®ºæ˜¯å¦å­˜åœ¨ï¼Œéƒ½ä¼šå°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°sessionä¸­ï¼Œæ–¹ä¾¿åç»­è·å¾—å½“å‰ç™»å½•ä¿¡æ¯</p>
<p><strong>æ ¡éªŒç™»å½•çŠ¶æ€:</strong></p>
<p>ç”¨æˆ·åœ¨è¯·æ±‚æ—¶å€™ï¼Œä¼šä»cookieä¸­æºå¸¦è€…JsessionIdåˆ°åå°ï¼Œåå°é€šè¿‡JsessionIdä»sessionä¸­æ‹¿åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰sessionä¿¡æ¯ï¼Œåˆ™è¿›è¡Œæ‹¦æˆªï¼Œå¦‚æœæœ‰sessionä¿¡æ¯ï¼Œåˆ™å°†ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œ</p>
<h3 id="1-2-å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½"><a href="#1-2-å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½" class="headerlink" title="1.2 å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½"></a>1.2 å®ç°å‘é€çŸ­ä¿¡éªŒè¯ç åŠŸèƒ½</h3><ul>
<li><strong>å‘é€éªŒè¯ç </strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sendCode</span><span class="hljs-params">(String phone, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.æ ¡éªŒæ‰‹æœºå·</span><br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.ç¬¦åˆï¼Œç”ŸæˆéªŒè¯ç </span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment">// 4.ä¿å­˜éªŒè¯ç åˆ° session</span><br>    session.setAttribute(<span class="hljs-string">&quot;code&quot;</span>,code);<br>    <span class="hljs-comment">// 5.å‘é€éªŒè¯ç </span><br>    log.debug(<span class="hljs-string">&quot;å‘é€çŸ­ä¿¡éªŒè¯ç æˆåŠŸï¼ŒéªŒè¯ç ï¼š&#123;&#125;&quot;</span>, code);<br>    <span class="hljs-comment">// è¿”å›ok</span><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>ç™»å½•</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.æ ¡éªŒæ‰‹æœºå·</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.æ ¡éªŒéªŒè¯ç </span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;code&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span>(cacheCode == <span class="hljs-literal">null</span> || !cacheCode.toString().equals(code))&#123;<br>         <span class="hljs-comment">//3.ä¸ä¸€è‡´ï¼ŒæŠ¥é”™</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br><br>    <span class="hljs-comment">//5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º</span><br>        user =  createUserWithPhone(phone);<br>    &#125;<br>    <span class="hljs-comment">//7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°sessionä¸­</span><br>    session.setAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½"><a href="#1-3-å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½" class="headerlink" title="1.3 å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½"></a>1.3 å®ç°ç™»å½•æ‹¦æˆªåŠŸèƒ½</h3><p><img src="/img/blogs/java/redis/2.1.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>æ‹¦æˆªå™¨ä»£ç </strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">//1.è·å–session</span><br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>        <span class="hljs-comment">//2.è·å–sessionä¸­çš„ç”¨æˆ·</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-comment">//3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>              <span class="hljs-comment">//4.ä¸å­˜åœ¨ï¼Œæ‹¦æˆªï¼Œè¿”å›401çŠ¶æ€ç </span><br>              response.setStatus(<span class="hljs-number">401</span>);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//5.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°Threadlocal</span><br>        UserHolder.saveUser((User)user);<br>        <span class="hljs-comment">//6.æ”¾è¡Œ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>è®©æ‹¦æˆªå™¨ç”Ÿæ•ˆ</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// ç™»å½•æ‹¦æˆªå™¨</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>                .excludePathPatterns(<br>                        <span class="hljs-string">&quot;/shop/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/voucher/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/shop-type/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/upload/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/blog/hot&quot;</span>,<br>                        <span class="hljs-string">&quot;/user/code&quot;</span>,<br>                        <span class="hljs-string">&quot;/user/login&quot;</span><br>                ).order(<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// tokenåˆ·æ–°çš„æ‹¦æˆªå™¨</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>).order(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯"><a href="#1-4-éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯" class="headerlink" title="1.4 éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯"></a>1.4 éšè—ç”¨æˆ·æ•æ„Ÿä¿¡æ¯</h3><p>æˆ‘ä»¬é€šè¿‡æµè§ˆå™¨è§‚å¯Ÿåˆ°æ­¤æ—¶ç”¨æˆ·çš„å…¨éƒ¨ä¿¡æ¯éƒ½åœ¨ï¼Œè¿™æ ·æä¸ºä¸é è°±ï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“åœ¨è¿”å›ç”¨æˆ·ä¿¡æ¯ä¹‹å‰ï¼Œå°†ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯è¿›è¡Œéšè—ï¼Œé‡‡ç”¨çš„æ ¸å¿ƒæ€è·¯å°±æ˜¯ä¹¦å†™ä¸€ä¸ªUserDTOå¯¹è±¡ï¼Œè¿™ä¸ªUserDTOå¯¹è±¡å°±æ²¡æœ‰æ•æ„Ÿä¿¡æ¯äº†ï¼Œæˆ‘ä»¬åœ¨è¿”å›å‰ï¼Œ<strong>å°†æœ‰ç”¨æˆ·æ•æ„Ÿä¿¡æ¯çš„Userå¯¹è±¡è½¬åŒ–æˆæ²¡æœ‰æ•æ„Ÿä¿¡æ¯çš„UserDTOå¯¹è±¡</strong>ï¼Œé‚£ä¹ˆå°±èƒ½å¤Ÿé¿å…è¿™ä¸ªå°´å°¬çš„é—®é¢˜äº†</p>
<h3 id="1-5-sessionå…±äº«é—®é¢˜"><a href="#1-5-sessionå…±äº«é—®é¢˜" class="headerlink" title="1.5 sessionå…±äº«é—®é¢˜"></a>1.5 sessionå…±äº«é—®é¢˜</h3><p>sessionå…±äº«é—®é¢˜:å¤šå°Tomcatå¹¶ä¸å…±äº«sessionå­˜å‚¨ç©ºé—´,å½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒtomcatæœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜</p>
<p><img src="/img/blogs/java/redis/2.1.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>æ¯ä¸ªtomcatä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„session</li>
<li>å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°tomcatï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„sessionä¸­</li>
<li>ä½†æ˜¯ç¬¬äºŒæ¬¡è¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°tomcatï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„session</li>
</ul>
<p><strong>è§£å†³æ–¹æ³•</strong>ï¼š</p>
<p>æ‰€ä»¥å’±ä»¬åæ¥é‡‡ç”¨çš„æ–¹æ¡ˆéƒ½æ˜¯åŸºäºredisæ¥å®Œæˆï¼Œæˆ‘ä»¬<strong>æŠŠsessionæ¢æˆredis</strong>ï¼Œ<strong>redisæ•°æ®æœ¬èº«å°±æ˜¯å…±äº«çš„ï¼Œå°±å¯ä»¥é¿å…sessionå…±äº«</strong>çš„é—®é¢˜äº†</p>
<h3 id="1-6-Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹"><a href="#1-6-Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹" class="headerlink" title="1.6 Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹"></a>1.6 Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹</h3><p><img src="/img/blogs/java/redis/2.1.4.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.1.5.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>å½“æ³¨å†Œå®Œæˆåï¼Œç”¨æˆ·å»ç™»å½•ä¼šå»æ ¡éªŒç”¨æˆ·æäº¤çš„æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œæ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºã€‚æœ€åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°redisï¼Œå¹¶ä¸”ç”Ÿæˆtokenä½œä¸ºredisçš„key</li>
<li>å½“æˆ‘ä»¬æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æ—¶ï¼Œä¼šå»æºå¸¦ç€tokenè¿›è¡Œè®¿é—®ï¼Œä»redisä¸­å–å‡ºtokenå¯¹åº”çš„valueï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹¦æˆªï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶ä¿å­˜åˆ°ThreadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œã€‚</li>
</ol>
<h3 id="1-7-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•"><a href="#1-7-åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•" class="headerlink" title="1.7 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•"></a>1.7 åŸºäºRediså®ç°çŸ­ä¿¡ç™»å½•</h3><p><strong>UserServiceImplä»£ç </strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.æ ¡éªŒæ‰‹æœºå·</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.å¦‚æœä¸ç¬¦åˆï¼Œè¿”å›é”™è¯¯ä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;æ‰‹æœºå·æ ¼å¼é”™è¯¯ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.ä»redisè·å–éªŒè¯ç å¹¶æ ¡éªŒ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span> (cacheCode == <span class="hljs-literal">null</span> || !cacheCode.equals(code)) &#123;<br>        <span class="hljs-comment">// ä¸ä¸€è‡´ï¼ŒæŠ¥é”™</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;éªŒè¯ç é”™è¯¯&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 4.ä¸€è‡´ï¼Œæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ· select * from tb_user where phone = ?</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br><br>    <span class="hljs-comment">// 5.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 6.ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·å¹¶ä¿å­˜</span><br>        user = createUserWithPhone(phone);<br>    &#125;<br><br>    <span class="hljs-comment">// 7.ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° redisä¸­</span><br>    <span class="hljs-comment">// 7.1.éšæœºç”Ÿæˆtokenï¼Œä½œä¸ºç™»å½•ä»¤ç‰Œ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">// 7.2.å°†Userå¯¹è±¡è½¬ä¸ºHashMapå­˜å‚¨</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);<br>    Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(),<br>            CopyOptions.create()<br>                    .setIgnoreNullValue(<span class="hljs-literal">true</span>)<br>                    .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));<br>    <span class="hljs-comment">// 7.3.å­˜å‚¨</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tokenKey</span> <span class="hljs-operator">=</span> LOGIN_USER_KEY + token;<br>    stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);<br>    <span class="hljs-comment">// 7.4.è®¾ç½®tokenæœ‰æ•ˆæœŸ</span><br>    stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);<br><br>    <span class="hljs-comment">// 8.è¿”å›token</span><br>    <span class="hljs-keyword">return</span> Result.ok(token);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-8-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜"><a href="#1-8-è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜" class="headerlink" title="1.8 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜"></a>1.8 è§£å†³çŠ¶æ€ç™»å½•åˆ·æ–°é—®é¢˜</h3><ul>
<li>åŸå§‹æ‹¦æˆªå™¨ç¡®å®å¯ä»¥ä½¿ç”¨å¯¹åº”è·¯å¾„çš„æ‹¦æˆªï¼ŒåŒæ—¶åˆ·æ–°ç™»å½•tokenä»¤ç‰Œçš„å­˜æ´»æ—¶é—´ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä»–åªæ˜¯æ‹¦æˆªéœ€è¦è¢«æ‹¦æˆªçš„è·¯å¾„</li>
<li>å‡è®¾å½“å‰ç”¨æˆ·è®¿é—®äº†ä¸€äº›ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¸ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥æ­¤æ—¶ä»¤ç‰Œåˆ·æ–°çš„åŠ¨ä½œå®é™…ä¸Šå°±ä¸ä¼šæ‰§è¡Œ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.1.6.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨ï¼Œåœ¨<strong>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„</strong>ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶åˆ·æ–°ä»¤ç‰Œï¼Œå› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†threadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶<strong>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯</strong>ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚</li>
</ul>
<p><strong>RefreshTokenInterceptor</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshTokenInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RefreshTokenInterceptor</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.è·å–è¯·æ±‚å¤´ä¸­çš„token</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;authorization&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(token)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 2.åŸºäºTOKENè·å–redisä¸­çš„ç”¨æˆ·</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span>  <span class="hljs-operator">=</span> LOGIN_USER_KEY + token;<br>        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);<br>        <span class="hljs-comment">// 3.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (userMap.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 5.å°†æŸ¥è¯¢åˆ°çš„hashæ•°æ®è½¬ä¸ºUserDTO</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>(), <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// 6.å­˜åœ¨ï¼Œä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ° ThreadLocal</span><br>        UserHolder.saveUser(userDTO);<br>        <span class="hljs-comment">// 7.åˆ·æ–°tokenæœ‰æ•ˆæœŸ</span><br>        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">// 8.æ”¾è¡Œ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ç§»é™¤ç”¨æˆ·</span><br>        UserHolder.removeUser();<br>    &#125;<br>&#125;<br>	<br></code></pre></td></tr></table></figure>

<p><strong>LoginInterceptor</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰</span><br>        <span class="hljs-keyword">if</span> (UserHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç </span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-comment">// æ‹¦æˆª</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// æœ‰ç”¨æˆ·ï¼Œåˆ™æ”¾è¡Œ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>MvcConfig</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>       <span class="hljs-comment">// ç™»å½•æ‹¦æˆªå™¨</span><br>       registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>               .excludePathPatterns(<br>                       <span class="hljs-string">&quot;/shop/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/voucher/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/shop-type/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/upload/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/blog/hot&quot;</span>,<br>                       <span class="hljs-string">&quot;/user/code&quot;</span>,<br>                       <span class="hljs-string">&quot;/user/login&quot;</span><br>               ).order(<span class="hljs-number">1</span>);<br>       <span class="hljs-comment">// tokenåˆ·æ–°çš„æ‹¦æˆªå™¨</span><br>       registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>).order(<span class="hljs-number">0</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>


<h2 id="2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜"><a href="#2-å•†æˆ·æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="2. å•†æˆ·æŸ¥è¯¢ç¼“å­˜"></a>2. å•†æˆ·æŸ¥è¯¢ç¼“å­˜</h2><h3 id="2-1-ä»€ä¹ˆæ˜¯ç¼“å­˜"><a href="#2-1-ä»€ä¹ˆæ˜¯ç¼“å­˜" class="headerlink" title="2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜?"></a>2.1 ä»€ä¹ˆæ˜¯ç¼“å­˜?</h3><p>ç¼“å­˜å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆç§°ä½œCacheï¼‰ï¼Œæ˜¯å­˜è´®æ•°æ®çš„ä¸´æ—¶åœ°æ–¹ï¼Œä¸€èˆ¬è¯»å†™æ€§èƒ½è¾ƒé«˜ã€‚</p>
<ul>
<li><p><strong>ç¼“å­˜(<strong>Cache),å°±æ˜¯æ•°æ®äº¤æ¢çš„</strong>ç¼“å†²åŒº</strong>,ä¿—ç§°çš„ç¼“å­˜å°±æ˜¯<strong>ç¼“å†²åŒºå†…çš„æ•°æ®</strong>,ä¸€èˆ¬ä»æ•°æ®åº“ä¸­è·å–,å­˜å‚¨äºæœ¬åœ°ä»£ç </p>
</li>
<li><p>ä¸ºä»€ä¹ˆä½¿ç”¨ç¼“å­˜ï¼Ÿ</p>
<ul>
<li><strong>é€Ÿåº¦å¿«,å¥½ç”¨</strong></li>
<li>ç¼“å­˜æ•°æ®å­˜å‚¨äºä»£ç ä¸­,è€Œä»£ç è¿è¡Œåœ¨å†…å­˜ä¸­,å†…å­˜çš„è¯»å†™æ€§èƒ½è¿œé«˜äºç£ç›˜,ç¼“å­˜å¯ä»¥å¤§å¤§é™ä½<strong>ç”¨æˆ·è®¿é—®å¹¶å‘é‡å¸¦æ¥çš„</strong>æœåŠ¡å™¨è¯»å†™å‹åŠ›</li>
</ul>
</li>
<li><p>ä½†æ˜¯ç¼“å­˜ä¹Ÿä¼šå¢åŠ ä»£ç å¤æ‚åº¦å’Œè¿è¥çš„æˆæœ¬</p>
</li>
</ul>
<h3 id="2-2-æ·»åŠ å•†æˆ·ç¼“å­˜"><a href="#2-2-æ·»åŠ å•†æˆ·ç¼“å­˜" class="headerlink" title="2.2 æ·»åŠ å•†æˆ·ç¼“å­˜"></a>2.2 æ·»åŠ å•†æˆ·ç¼“å­˜</h3><p><img src="/img/blogs/java/redis/2.2.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redis</li>
</ul>
<p><strong>ShopServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-comment">// 3.å­˜åœ¨,ç›´æ¥è¿”å›</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>    <span class="hljs-comment">// 4.ä¸å­˜åœ¨,æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 5.ä¸å­˜åœ¨,è¿”å›é”™è¯¯</span><br>    <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;åº—é“ºä¸å­˜åœ¨!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.å­˜åœ¨,å†™å…¥redis</span><br>    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));<br>    <span class="hljs-comment">// 7.è¿”å›</span><br>    <span class="hljs-keyword">return</span> Result.ok(shop);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#2-3-ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>2.3 ç¼“å­˜æ›´æ–°ç­–ç•¥</h3><p>redisä¼šå¯¹éƒ¨åˆ†æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œæˆ–è€…æŠŠä»–å«ä¸ºæ·˜æ±°<br>æœ‰ä»¥ä¸‹ä¸‰ç§æ›´æ–°ç­–ç•¥ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>å†…å­˜æ·˜æ±°</th>
<th>è¶…æ—¶åˆ é™¤</th>
<th>ä¸»åŠ¨æ›´æ–°</th>
</tr>
</thead>
<tbody><tr>
<td><strong>è¯´æ˜</strong></td>
<td>ä¸ç”¨è‡ªå·±ç»´æŠ¤ï¼Œåˆ©ç”¨Redisçš„å†…å­˜æ·˜æ±°æœºåˆ¶ï¼Œå½“å†…å­˜ä¸è¶³æ—¶è‡ªåŠ¨æ·˜æ±°éƒ¨åˆ†æ•°æ®ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td>ç»™ç¼“å­˜æ•°æ®æ·»åŠ TTLæ—¶é—´ï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ç¼“å­˜ã€‚ä¸‹æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°ç¼“å­˜ã€‚</td>
<td>ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œæ›´æ–°ç¼“å­˜ã€‚</td>
</tr>
<tr>
<td><strong>ä¸€è‡´æ€§</strong></td>
<td>å·®</td>
<td>ä¸€èˆ¬</td>
<td>å¥½</td>
</tr>
<tr>
<td><strong>ç»´æŠ¤æˆæœ¬</strong></td>
<td>æ— </td>
<td>ä½</td>
<td>é«˜</td>
</tr>
</tbody></table>
<p>ä¸šåŠ¡åœºæ™¯ï¼š</p>
<ul>
<li>ä½ä¸€è‡´æ€§éœ€æ±‚ï¼šä½¿ç”¨å†…å­˜æ·˜æ±°æœºåˆ¶ã€‚ä¾‹å¦‚åº—é“ºç±»å‹çš„æŸ¥è¯¢ç¼“å­˜</li>
<li>é«˜ä¸€è‡´æ€§éœ€æ±‚ï¼šä¸»åŠ¨æ›´æ–°ï¼Œå¹¶ä»¥è¶…æ—¶å‰”é™¤ä½œä¸ºå…œåº•æ–¹æ¡ˆã€‚ä¾‹å¦‚åº—é“ºè¯¦æƒ…æŸ¥è¯¢çš„ç¼“å­˜</li>
</ul>
<p><strong>æ•°æ®åº“å’Œç¼“å­˜ä¸ä¸€è‡´é‡‡ç”¨ä»€ä¹ˆæ–¹æ¡ˆ</strong>ï¼Ÿ<br>äººå·¥ç¼–ç æ–¹å¼ï¼š<strong>ç¼“å­˜è°ƒç”¨è€…åœ¨æ›´æ–°å®Œæ•°æ®åº“åå†å»æ›´æ–°ç¼“å­˜</strong>ï¼Œä¹Ÿç§°ä¹‹ä¸ºåŒå†™æ–¹æ¡ˆ</p>
<ul>
<li><p>åˆ é™¤ç¼“å­˜è¿˜æ˜¯æ›´æ–°ç¼“å­˜ï¼Ÿ(<strong>é€‰æ‹©åˆ é™¤ç¼“å­˜</strong>)</p>
<ul>
<li>æ›´æ–°ç¼“å­˜ï¼šæ¯æ¬¡æ›´æ–°æ•°æ®åº“éƒ½æ›´æ–°ç¼“å­˜ï¼Œæ— æ•ˆå†™æ“ä½œè¾ƒå¤š</li>
<li>åˆ é™¤ç¼“å­˜ï¼šæ›´æ–°æ•°æ®åº“æ—¶è®©ç¼“å­˜å¤±æ•ˆï¼ŒæŸ¥è¯¢æ—¶å†æ›´æ–°ç¼“å­˜</li>
</ul>
</li>
<li><p>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</p>
<ul>
<li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
</li>
<li><p>å…ˆæ“ä½œç¼“å­˜è¿˜æ˜¯å…ˆæ“ä½œæ•°æ®åº“ï¼Ÿ(<strong>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong>)</p>
<ul>
<li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ“ä½œæ•°æ®åº“</li>
<li>å…ˆæ“ä½œæ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</li>
</ul>
</li>
</ul>
<h3 id="2-4-å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´"><a href="#2-4-å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´" class="headerlink" title="2.4 å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´"></a>2.4 å®ç°å•†é“ºå’Œç¼“å­˜ä¸æ•°æ®åº“åŒå†™ä¸€è‡´</h3><p>ä¿®æ”¹ShopControllerä¸­çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ»¡è¶³ä¸‹é¢çš„éœ€æ±‚ï¼š</p>
<ul>
<li>æ ¹æ®idæŸ¥è¯¢åº—é“ºæ—¶ï¼Œå¦‚æœç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†æ•°æ®åº“ç»“æœå†™å…¥ç¼“å­˜ï¼Œå¹¶<strong>è®¾ç½®è¶…æ—¶æ—¶é—´</strong></li>
<li>æ ¹æ®idä¿®æ”¹åº—é“ºæ—¶ï¼Œ<strong>å…ˆä¿®æ”¹æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜</strong></li>
</ul>
<h3 id="2-5-ç¼“å­˜ç©¿é€"><a href="#2-5-ç¼“å­˜ç©¿é€" class="headerlink" title="2.5 ç¼“å­˜ç©¿é€"></a>2.5 ç¼“å­˜ç©¿é€</h3><p>ç¼“å­˜ç©¿é€ ï¼šç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯<strong>è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨</strong>ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“ã€‚</p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡<ul>
<li>ä¼˜ç‚¹ï¼šå®ç°ç®€å•ï¼Œç»´æŠ¤æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼š<ul>
<li>é¢å¤–çš„å†…å­˜æ¶ˆè€—</li>
<li>å¯èƒ½é€ æˆçŸ­æœŸçš„ä¸ä¸€è‡´</li>
</ul>
</li>
</ul>
</li>
<li>å¸ƒéš†è¿‡æ»¤<ul>
<li>ä¼˜ç‚¹ï¼šå†…å­˜å ç”¨è¾ƒå°‘ï¼Œæ²¡æœ‰å¤šä½™key</li>
<li>ç¼ºç‚¹ï¼š<ul>
<li>å®ç°å¤æ‚</li>
<li>å­˜åœ¨è¯¯åˆ¤å¯èƒ½</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ç¼–ç è§£å†³å•†å“æŸ¥è¯¢çš„ç¼“å­˜ç©¿é€é—®é¢˜</strong>ï¼š</p>
<ul>
<li>åŸæ¥çš„é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°è¿™ä¸ª<strong>æ•°æ®åœ¨mysqlä¸­ä¸å­˜åœ¨ï¼Œç›´æ¥å°±è¿”å›404</strong>äº†ï¼Œè¿™æ ·æ˜¯ä¼šå­˜åœ¨ç¼“å­˜ç©¿é€é—®é¢˜çš„</li>
<li>ç°åœ¨çš„é€»è¾‘ä¸­ï¼šå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œæˆ‘ä»¬ä¸ä¼šè¿”å›404 <ul>
<li>è€Œæ˜¯<strong>ä¼šæŠŠè¿™ä¸ªæ•°æ®å†™å…¥åˆ°Redisä¸­ï¼Œå¹¶ä¸”å°†valueè®¾ç½®ä¸ºç©º</strong></li>
<li>å½“å†æ¬¡å‘èµ·æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å‘½ä¸­ä¹‹åï¼Œ<strong>åˆ¤æ–­è¿™ä¸ªvalueæ˜¯å¦æ˜¯null</strong>ï¼Œå¦‚æœæ˜¯nullï¼Œåˆ™æ˜¯ä¹‹å‰å†™å…¥çš„æ•°æ®ï¼Œè¯æ˜æ˜¯ç¼“å­˜ç©¿é€æ•°æ®ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>CacheClient</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;R,ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(</span><br><span class="hljs-params">        String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>    <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>        <span class="hljs-comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><br>        <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>    &#125;<br>    <span class="hljs-comment">// åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span><br>    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>    <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>    <span class="hljs-comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span><br>    <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// å°†ç©ºå€¼å†™å…¥redis</span><br>        stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 6.å­˜åœ¨ï¼Œå†™å…¥redis</span><br>    <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-6-ç¼“å­˜é›ªå´©"><a href="#2-6-ç¼“å­˜é›ªå´©" class="headerlink" title="2.6 ç¼“å­˜é›ªå´©"></a>2.6 ç¼“å­˜é›ªå´©</h3><p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.4.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-ç¼“å­˜å‡»ç©¿"><a href="#2-7-ç¼“å­˜å‡»ç©¿" class="headerlink" title="2.7 ç¼“å­˜å‡»ç©¿"></a>2.7 ç¼“å­˜å‡»ç©¿</h3><p>ç¼“å­˜å‡»ç©¿é—®é¢˜ä¹Ÿå«çƒ­ç‚¹Keyé—®é¢˜ï¼Œå°±æ˜¯ä¸€ä¸ª<strong>è¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆäº†</strong>ï¼Œæ— æ•°çš„è¯·æ±‚è®¿é—®ä¼šåœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§çš„å†²å‡»ã€‚</p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>äº’æ–¥é”</li>
<li>é€»è¾‘è¿‡æœŸ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.5.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.2.6.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th>è§£å†³æ–¹æ¡ˆ</th>
<th>ä¼˜ç‚¹</th>
<th>ç¼ºç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td>äº’æ–¥é”</td>
<td>- æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—<br>- ä¿è¯ä¸€è‡´æ€§<br>- å®ç°ç®€å•</td>
<td>- çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“<br>- å¯èƒ½æœ‰æ­»é”é£é™©</td>
</tr>
<tr>
<td>é€»è¾‘è¿‡æœŸ</td>
<td>- çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½</td>
<td>- ä¸ä¿è¯ä¸€è‡´æ€§<br>- æœ‰é¢å¤–å†…å­˜æ¶ˆè€—<br>- å®ç°å¤æ‚</td>
</tr>
</tbody></table>
<h4 id="2-7-1-åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜"><a href="#2-7-1-åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜" class="headerlink" title="2.7.1 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜"></a>2.7.1 åˆ©ç”¨äº’æ–¥é”è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h4><p><img src="/img/blogs/java/redis/2.2.7.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ShopServiceImpl</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(Long id)</span>  &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>       <span class="hljs-comment">// 1ã€ä»redisä¸­æŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;key&quot;</span>);<br>       <span class="hljs-comment">// 2ã€åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>       <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>           <span class="hljs-comment">// å­˜åœ¨,ç›´æ¥è¿”å›</span><br>           <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);<br>       &#125;<br>       <span class="hljs-comment">//åˆ¤æ–­å‘½ä¸­çš„å€¼æ˜¯å¦æ˜¯ç©ºå€¼</span><br>       <span class="hljs-keyword">if</span> (shopJson != <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-comment">//è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>       <span class="hljs-comment">// 4.å®ç°ç¼“å­˜é‡æ„</span><br>       <span class="hljs-comment">//4.1 è·å–äº’æ–¥é”</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:shop:&quot;</span> + id;<br>       <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>           <span class="hljs-comment">// 4.2 åˆ¤æ–­å¦è·å–æˆåŠŸ</span><br>           <span class="hljs-keyword">if</span>(!isLock)&#123;<br>               <span class="hljs-comment">//4.3 å¤±è´¥ï¼Œåˆ™ä¼‘çœ é‡è¯•</span><br>               Thread.sleep(<span class="hljs-number">50</span>);<br>               <span class="hljs-keyword">return</span> queryWithMutex(id);<br>           &#125;<br>           <span class="hljs-comment">//4.4 æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>            shop = getById(id);<br>           <span class="hljs-comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span><br>           <span class="hljs-keyword">if</span>(shop == <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//å°†ç©ºå€¼å†™å…¥redis</span><br>               stringRedisTemplate.opsForValue().set(key,<span class="hljs-string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);<br>               <span class="hljs-comment">//è¿”å›é”™è¯¯ä¿¡æ¯</span><br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>           &#125;<br>           <span class="hljs-comment">//6.å†™å…¥redis</span><br>           stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);<br><br>       &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>       &#125;<br>       <span class="hljs-keyword">finally</span> &#123;<br>           <span class="hljs-comment">//7.é‡Šæ”¾äº’æ–¥é”</span><br>           unlock(lockKey);<br>       &#125;<br>       <span class="hljs-keyword">return</span> shop;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-7-2-åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜"><a href="#2-7-2-åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜" class="headerlink" title="2.7.2 åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜"></a>2.7.2 åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</h4><p>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢å•†é“ºçš„ä¸šåŠ¡ï¼ŒåŸºäºé€»è¾‘è¿‡æœŸæ–¹å¼æ¥è§£å†³ç¼“å­˜å‡»ç©¿é—®é¢˜</p>
<p><img src="/img/blogs/java/redis/2.2.8.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ShopServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">( Long id )</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>        <span class="hljs-comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span><br>    <span class="hljs-keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> shop;<br>    &#125;<br>    <span class="hljs-comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span><br>    <span class="hljs-comment">// 6.ç¼“å­˜é‡å»º</span><br>    <span class="hljs-comment">// 6.1.è·å–äº’æ–¥é”</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span> (isLock)&#123;<br>        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;<br><br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-comment">//é‡å»ºç¼“å­˜</span><br>                <span class="hljs-built_in">this</span>.saveShop2Redis(id,<span class="hljs-number">20L</span>);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                unlock(lockKey);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span><br>    <span class="hljs-keyword">return</span> shop;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-8-å°è£…Rediså·¥å…·ç±»"><a href="#2-8-å°è£…Rediså·¥å…·ç±»" class="headerlink" title="2.8 å°è£…Rediså·¥å…·ç±»"></a>2.8 å°è£…Rediså·¥å…·ç±»</h3><p>åŸºäºStringRedisTemplateå°è£…ä¸€ä¸ªç¼“å­˜å·¥å…·ç±»ï¼Œæ»¡è¶³ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ul>
<li>æ–¹æ³•1ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®TTLè¿‡æœŸæ—¶é—´</li>
<li>æ–¹æ³•2ï¼šå°†ä»»æ„Javaå¯¹è±¡åºåˆ—åŒ–ä¸ºjsonå¹¶å­˜å‚¨åœ¨stringç±»å‹çš„keyä¸­ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œç”¨äºå¤„ç†ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
<li>æ–¹æ³•3ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œåˆ©ç”¨ç¼“å­˜ç©ºå€¼çš„æ–¹å¼è§£å†³<strong>ç¼“å­˜ç©¿é€</strong>é—®é¢˜</li>
<li>æ–¹æ³•4ï¼šæ ¹æ®æŒ‡å®šçš„keyæŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶ååºåˆ—åŒ–ä¸ºæŒ‡å®šç±»å‹ï¼Œéœ€è¦åˆ©ç”¨é€»è¾‘è¿‡æœŸè§£å†³<strong>ç¼“å­˜å‡»ç©¿</strong>é—®é¢˜</li>
</ul>
<p><strong>å°è£…æˆCacheClientç±»</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheClient</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithLogicalExpire</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-comment">// è®¾ç½®é€»è¾‘è¿‡æœŸ</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>        redisData.setData(value);<br>        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));<br>        <span class="hljs-comment">// å†™å…¥Redis</span><br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>            <span class="hljs-comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>        &#125;<br>        <span class="hljs-comment">// åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span><br>        <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 4.ä¸å­˜åœ¨ï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>        <span class="hljs-comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span><br>        <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// å°†ç©ºå€¼å†™å…¥redis</span><br>            stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>            <span class="hljs-comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 6.å­˜åœ¨ï¼Œå†™å…¥redis</span><br>        <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>            <span class="hljs-comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 4.å‘½ä¸­ï¼Œéœ€è¦å…ˆæŠŠjsonååºåˆ—åŒ–ä¸ºå¯¹è±¡</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>        <span class="hljs-comment">// 5.åˆ¤æ–­æ˜¯å¦è¿‡æœŸ</span><br>        <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>            <span class="hljs-comment">// 5.1.æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›åº—é“ºä¿¡æ¯</span><br>            <span class="hljs-keyword">return</span> r;<br>        &#125;<br>        <span class="hljs-comment">// 5.2.å·²è¿‡æœŸï¼Œéœ€è¦ç¼“å­˜é‡å»º</span><br>        <span class="hljs-comment">// 6.ç¼“å­˜é‡å»º</span><br>        <span class="hljs-comment">// 6.1.è·å–äº’æ–¥é”</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-comment">// 6.2.åˆ¤æ–­æ˜¯å¦è·å–é”æˆåŠŸ</span><br>        <span class="hljs-keyword">if</span> (isLock) &#123;<br>            <span class="hljs-comment">// 6.3.æˆåŠŸï¼Œå¼€å¯ç‹¬ç«‹çº¿ç¨‹ï¼Œå®ç°ç¼“å­˜é‡å»º</span><br>            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// æŸ¥è¯¢æ•°æ®åº“</span><br>                    <span class="hljs-type">R</span> <span class="hljs-variable">newR</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>                    <span class="hljs-comment">// é‡å»ºç¼“å­˜</span><br>                    <span class="hljs-built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// é‡Šæ”¾é”</span><br>                    unlock(lockKey);<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 6.4.è¿”å›è¿‡æœŸçš„å•†é“ºä¿¡æ¯</span><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>            <span class="hljs-comment">// 3.å­˜åœ¨ï¼Œç›´æ¥è¿”å›</span><br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, type);<br>        &#125;<br>        <span class="hljs-comment">// åˆ¤æ–­å‘½ä¸­çš„æ˜¯å¦æ˜¯ç©ºå€¼</span><br>        <span class="hljs-keyword">if</span> (shopJson != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// è¿”å›ä¸€ä¸ªé”™è¯¯ä¿¡æ¯</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 4.å®ç°ç¼“å­˜é‡å»º</span><br>        <span class="hljs-comment">// 4.1.è·å–äº’æ–¥é”</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>            <span class="hljs-comment">// 4.2.åˆ¤æ–­æ˜¯å¦è·å–æˆåŠŸ</span><br>            <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                <span class="hljs-comment">// 4.3.è·å–é”å¤±è´¥ï¼Œä¼‘çœ å¹¶é‡è¯•</span><br>                Thread.sleep(<span class="hljs-number">50</span>);<br>                <span class="hljs-keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);<br>            &#125;<br>            <span class="hljs-comment">// 4.4.è·å–é”æˆåŠŸï¼Œæ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>            r = dbFallback.apply(id);<br>            <span class="hljs-comment">// 5.ä¸å­˜åœ¨ï¼Œè¿”å›é”™è¯¯</span><br>            <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// å°†ç©ºå€¼å†™å…¥redis</span><br>                stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>                <span class="hljs-comment">// è¿”å›é”™è¯¯ä¿¡æ¯</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-comment">// 6.å­˜åœ¨ï¼Œå†™å…¥redis</span><br>            <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 7.é‡Šæ”¾é”</span><br>            unlock(lockKey);<br>        &#125;<br>        <span class="hljs-comment">// 8.è¿”å›</span><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> &#123;<br>        stringRedisTemplate.delete(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="3-ä¼˜æƒ åˆ¸ç§’æ€"><a href="#3-ä¼˜æƒ åˆ¸ç§’æ€" class="headerlink" title="3. ä¼˜æƒ åˆ¸ç§’æ€"></a>3. ä¼˜æƒ åˆ¸ç§’æ€</h2><h3 id="3-1-å…¨å±€å”¯ä¸€ID"><a href="#3-1-å…¨å±€å”¯ä¸€ID" class="headerlink" title="3.1 å…¨å±€å”¯ä¸€ID"></a>3.1 å…¨å±€å”¯ä¸€ID</h3><p>å½“ç”¨æˆ·æŠ¢è´­æ—¶ï¼Œå°±ä¼šç”Ÿæˆè®¢å•å¹¶ä¿å­˜åˆ°tb_voucher_orderè¿™å¼ è¡¨ä¸­ï¼Œè€Œè®¢å•è¡¨å¦‚æœä½¿ç”¨æ•°æ®åº“è‡ªå¢IDå°±å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>idçš„è§„å¾‹æ€§å¤ªæ˜æ˜¾</li>
<li>å—å•è¡¨æ•°æ®é‡çš„é™åˆ¶</li>
</ul>
<p><strong>å…¨å±€IDç”Ÿæˆå™¨</strong>ï¼Œæ˜¯ä¸€ç§åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸‹ç”¨æ¥ç”Ÿæˆå…¨å±€å”¯ä¸€IDçš„å·¥å…·ï¼Œä¸€èˆ¬è¦æ»¡è¶³ä¸‹åˆ—ç‰¹æ€§ï¼š</p>
<ul>
<li>å”¯ä¸€æ€§</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>é€’å¢æ€§</li>
<li>å®‰å…¨æ€§</li>
</ul>
<ul>
<li>ä¸ºäº†å¢åŠ IDçš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ç›´æ¥ä½¿ç”¨Redisè‡ªå¢çš„æ•°å€¼ï¼Œè€Œæ˜¯æ‹¼æ¥ä¸€äº›å…¶å®ƒä¿¡æ¯ï¼š<ul>
<li>IDçš„ç»„æˆéƒ¨åˆ†ï¼šç¬¦å·ä½ï¼š1bitï¼Œæ°¸è¿œä¸º0</li>
<li>æ—¶é—´æˆ³ï¼š31bitï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œå¯ä»¥ä½¿ç”¨69å¹´</li>
<li>åºåˆ—å·ï¼š32bitï¼Œç§’å†…çš„è®¡æ•°å™¨ï¼Œæ”¯æŒæ¯ç§’äº§ç”Ÿ2^32ä¸ªä¸åŒID</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.3.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Rediså®ç°å…¨å±€å”¯ä¸€Id</strong>ï¼š </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisIdWorker</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å¼€å§‹æ—¶é—´æˆ³</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BEGIN_TIMESTAMP</span> <span class="hljs-operator">=</span> <span class="hljs-number">1640995200L</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åºåˆ—å·çš„ä½æ•°</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisIdWorker</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nextId</span><span class="hljs-params">(String keyPrefix)</span> &#123;<br>        <span class="hljs-comment">// 1.ç”Ÿæˆæ—¶é—´æˆ³</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowSecond</span> <span class="hljs-operator">=</span> now.toEpochSecond(ZoneOffset.UTC);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> nowSecond - BEGIN_TIMESTAMP;<br><br>        <span class="hljs-comment">// 2.ç”Ÿæˆåºåˆ—å·</span><br>        <span class="hljs-comment">// 2.1.è·å–å½“å‰æ—¥æœŸï¼Œç²¾ç¡®åˆ°å¤©</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy:MM:dd&quot;</span>));<br>        <span class="hljs-comment">// 2.2.è‡ªå¢é•¿</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="hljs-string">&quot;icr:&quot;</span> + keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + date);<br><br>        <span class="hljs-comment">// 3.æ‹¼æ¥å¹¶è¿”å›</span><br>        <span class="hljs-keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-2-æ·»åŠ ä¼˜æƒ åˆ¸-å®ç°ç§’æ€ä¸‹å•"><a href="#3-2-æ·»åŠ ä¼˜æƒ åˆ¸-å®ç°ç§’æ€ä¸‹å•" class="headerlink" title="3.2 æ·»åŠ ä¼˜æƒ åˆ¸&amp;å®ç°ç§’æ€ä¸‹å•"></a>3.2 æ·»åŠ ä¼˜æƒ åˆ¸&amp;å®ç°ç§’æ€ä¸‹å•</h3><p>æ¯ä¸ªåº—é“ºéƒ½å¯ä»¥å‘å¸ƒä¼˜æƒ åˆ¸ï¼Œåˆ†ä¸ºå¹³ä»·åˆ¸å’Œç‰¹ä»·åˆ¸ã€‚å¹³ä»·åˆ¸å¯ä»¥ä»»æ„è´­ä¹°ï¼Œè€Œç‰¹ä»·åˆ¸éœ€è¦ç§’æ€æŠ¢è´­ï¼š</p>
<p><img src="/img/blogs/java/redis/2.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>å®ç°ç§’æ€ä¸‹å•</strong>ï¼š</p>
<p><img src="/img/blogs/java/redis/2.3.3.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸‹å•æ—¶éœ€è¦åˆ¤æ–­ä¸¤ç‚¹ï¼š</p>
<ul>
<li>ç§’æ€æ˜¯å¦å¼€å§‹æˆ–ç»“æŸï¼Œå¦‚æœå°šæœªå¼€å§‹æˆ–å·²ç»ç»“æŸåˆ™æ— æ³•ä¸‹å•</li>
<li>åº“å­˜æ˜¯å¦å……è¶³ï¼Œä¸è¶³åˆ™æ— æ³•ä¸‹å•</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢ä¼˜æƒ åˆ¸</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">voucher</span> <span class="hljs-operator">=</span> seckillVoucherService.getById(voucherId);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­ç§’æ€æ˜¯å¦å¼€å§‹</span><br>    <span class="hljs-keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// å°šæœªå¼€å§‹</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç§’æ€å°šæœªå¼€å§‹ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.åˆ¤æ–­ç§’æ€æ˜¯å¦å·²ç»ç»“æŸ</span><br>    <span class="hljs-keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// å°šæœªå¼€å§‹</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç§’æ€å·²ç»ç»“æŸï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 4.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³</span><br>    <span class="hljs-keyword">if</span> (voucher.getStock() &lt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// åº“å­˜ä¸è¶³</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//5ï¼Œæ‰£å‡åº“å­˜</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update();<br>    <span class="hljs-keyword">if</span> (!success) &#123;<br>        <span class="hljs-comment">//æ‰£å‡åº“å­˜</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;åº“å­˜ä¸è¶³ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.åˆ›å»ºè®¢å•</span><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    <span class="hljs-comment">// 6.1.è®¢å•id</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    voucherOrder.setId(orderId);<br>    <span class="hljs-comment">// 6.2.ç”¨æˆ·id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    voucherOrder.setUserId(userId);<br>    <span class="hljs-comment">// 6.3.ä»£é‡‘åˆ¸id</span><br>    voucherOrder.setVoucherId(voucherId);<br>    save(voucherOrder);<br><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-åº“å­˜è¶…å–é—®é¢˜-å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#3-3-åº“å­˜è¶…å–é—®é¢˜-å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="3.3 åº“å­˜è¶…å–é—®é¢˜(å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜)"></a>3.3 åº“å­˜è¶…å–é—®é¢˜(å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜)</h3><p>å‡è®¾çº¿ç¨‹1è¿‡æ¥æŸ¥è¯¢åº“å­˜ï¼Œåˆ¤æ–­å‡ºæ¥åº“å­˜å¤§äº1ï¼Œæ­£å‡†å¤‡å»æ‰£å‡åº“å­˜ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ¥å¾—åŠå»æ‰£å‡ï¼Œæ­¤æ—¶çº¿ç¨‹2è¿‡æ¥ï¼Œçº¿ç¨‹2ä¹Ÿå»æŸ¥è¯¢åº“å­˜ï¼Œå‘ç°è¿™ä¸ªæ•°é‡ä¸€å®šä¹Ÿå¤§äº1ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªçº¿ç¨‹éƒ½ä¼šå»æ‰£å‡åº“å­˜ï¼Œæœ€ç»ˆå¤šä¸ªçº¿ç¨‹ç›¸å½“äºä¸€èµ·å»æ‰£å‡åº“å­˜ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°åº“å­˜çš„è¶…å–é—®é¢˜ã€‚</p>
<p><img src="/img/blogs/java/redis/2.3.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-3-1-è§£å†³æ–¹æ¡ˆ-åŠ é”"><a href="#3-3-1-è§£å†³æ–¹æ¡ˆ-åŠ é”" class="headerlink" title="3.3.1 è§£å†³æ–¹æ¡ˆ(åŠ é”)"></a>3.3.1 è§£å†³æ–¹æ¡ˆ(åŠ é”)</h4><p><strong>æ‚²è§‚é”ï¼š</strong></p>
<ul>
<li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚</li>
<li>ä¾‹å¦‚Synchronizedã€Lockéƒ½å±äºæ‚²è§‚é”</li>
</ul>
<p><strong>ä¹è§‚é”ï¼š</strong></p>
<ul>
<li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œåªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®ã€‚</li>
<li>å¦‚æœå·²ç»è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸</li>
</ul>
<h4 id="3-3-2-åŸºäºä¹è§‚é”-CAS-çš„è§£å†³æ–¹æ¡ˆ"><a href="#3-3-2-åŸºäºä¹è§‚é”-CAS-çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="3.3.2 åŸºäºä¹è§‚é”(CAS)çš„è§£å†³æ–¹æ¡ˆ"></a>3.3.2 åŸºäºä¹è§‚é”(CAS)çš„è§£å†³æ–¹æ¡ˆ</h4><p><img src="/img/blogs/java/redis/2.3.5.png" srcset="/img/loading.gif" lazyload></p>
<p>åªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„ã€‚æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆstockå¤§äº0 å³å¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="hljs-string">&quot;stock&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">//where id = ? and stock &gt; 0</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-æ€»ç»“"><a href="#3-3-3-æ€»ç»“" class="headerlink" title="3.3.3 æ€»ç»“"></a>3.3.3 æ€»ç»“</h4><p>è¶…å–è¿™æ ·çš„çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè§£å†³æ–¹æ¡ˆæœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>æ‚²è§‚é”ï¼šæ·»åŠ åŒæ­¥é”ï¼Œè®©çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œ<ul>
<li>ä¼˜ç‚¹ï¼šç®€å•ç²—æš´</li>
<li>ç¼ºç‚¹ï¼šæ€§èƒ½ä¸€èˆ¬</li>
</ul>
</li>
<li>ä¹è§‚é”ï¼šä¸åŠ é”ï¼Œåœ¨æ›´æ–°æ—¶åˆ¤æ–­æ˜¯å¦æœ‰å…¶å®ƒçº¿ç¨‹åœ¨ä¿®æ”¹<ul>
<li>ä¼˜ç‚¹ï¼šæ€§èƒ½å¥½</li>
<li>ç¼ºç‚¹ï¼šå­˜åœ¨æˆåŠŸç‡ä½çš„é—®é¢˜</li>
</ul>
</li>
</ul>
<h3 id="3-4-ä¸€äººä¸€å•"><a href="#3-4-ä¸€äººä¸€å•" class="headerlink" title="3.4 ä¸€äººä¸€å•"></a>3.4 ä¸€äººä¸€å•</h3><p>ä¿®æ”¹ç§’æ€ä¸šåŠ¡ï¼Œè¦æ±‚<strong>åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</strong></p>
<p><img src="/img/blogs/java/redis/2.3.6.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 5.1.æŸ¥è¯¢è®¢å•</span><br>   <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>   <span class="hljs-comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>   <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>       <span class="hljs-comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span><br>       <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡ä¸€æ¬¡ï¼&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>ä¸ºäº†ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œåœ¨æ–¹æ³•ä¸Šæ·»åŠ äº†ä¸€æŠŠsynchronized é”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-5-é›†ç¾¤ç¯å¢ƒä¸‹ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜"><a href="#3-5-é›†ç¾¤ç¯å¢ƒä¸‹ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜" class="headerlink" title="3.5 é›†ç¾¤ç¯å¢ƒä¸‹ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜"></a>3.5 é›†ç¾¤ç¯å¢ƒä¸‹ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜</h3><p>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯<strong>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†</strong></p>
<p>ç”±äºç°åœ¨æˆ‘ä»¬éƒ¨ç½²äº†å¤šä¸ªtomcatï¼Œ<strong>æ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvm</strong>ï¼Œ<strong>æ¯ä¸ªJVMéƒ½æœ‰å„è‡ªçš„é”ç›‘è§†å™¨ï¼Œå¯¼è‡´ä¸åŒJVMçš„é”åœ¨ä¸åŒçš„é”ç›‘è§†å™¨ä¸­</strong>ã€‚é‚£ä¹ˆå‡è®¾åœ¨æœåŠ¡å™¨Açš„tomcatå†…éƒ¨ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹ç”±äºä½¿ç”¨çš„æ˜¯åŒä¸€ä»½ä»£ç ï¼Œé‚£ä¹ˆä»–ä»¬çš„é”å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œæ˜¯å¯ä»¥å®ç°äº’æ–¥çš„ï¼Œä½†æ˜¯å¦‚æœç°åœ¨æ˜¯æœåŠ¡å™¨Bçš„tomcatå†…éƒ¨ï¼Œåˆæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½†æ˜¯ä»–ä»¬çš„é”å¯¹è±¡å†™çš„è™½ç„¶å’ŒæœåŠ¡å™¨Aä¸€æ ·ï¼Œä½†æ˜¯é”å¯¹è±¡å´ä¸æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹3å’Œçº¿ç¨‹4å¯ä»¥å®ç°äº’æ–¥ï¼Œä½†æ˜¯å´æ— æ³•å’Œçº¿ç¨‹1å’Œçº¿ç¨‹2å®ç°äº’æ–¥ï¼Œè¿™å°±æ˜¯ é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œsyné”å¤±æ•ˆçš„åŸå› ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨åˆ†å¸ƒå¼é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p><img src="/img/blogs/java/redis/2.3.7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-6-ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€"><a href="#3-6-ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€" class="headerlink" title="3.6 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€"></a>3.6 ç§’æ€ä¼˜åŒ–-å¼‚æ­¥ç§’æ€</h3><ul>
<li>æˆ‘ä»¬å°†è€—æ—¶æ¯”è¾ƒçŸ­çš„é€»è¾‘åˆ¤æ–­æ”¾å…¥åˆ°redisä¸­ï¼Œæ¯”å¦‚æ˜¯å¦åº“å­˜è¶³å¤Ÿï¼Œæ¯”å¦‚æ˜¯å¦ä¸€äººä¸€å•ï¼Œè¿™æ ·çš„æ“ä½œï¼Œåªè¦è¿™ç§é€»è¾‘å¯ä»¥å®Œæˆï¼Œå°±æ„å‘³ç€æˆ‘ä»¬æ˜¯ä¸€å®šå¯ä»¥ä¸‹å•å®Œæˆçš„ï¼Œæˆ‘ä»¬åªéœ€è¦è¿›è¡Œå¿«é€Ÿçš„é€»è¾‘åˆ¤æ–­ï¼Œæ ¹æœ¬å°±ä¸ç”¨ç­‰ä¸‹å•é€»è¾‘èµ°å®Œï¼Œæˆ‘ä»¬ç›´æ¥ç»™ç”¨æˆ·è¿”å›æˆåŠŸ</li>
<li>å†åœ¨åå°å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåå°çº¿ç¨‹æ…¢æ…¢çš„å»æ‰§è¡Œqueueé‡Œè¾¹çš„æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/redis/2.3.8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.3.9.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li><p>å½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œåˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³åªéœ€è¦å¯¼redisä¸­å»æ ¹æ®keyæ‰¾å¯¹åº”çš„valueæ˜¯å¦å¤§äº0å³å¯ï¼Œå¦‚æœä¸å……è¶³ï¼Œåˆ™ç›´æ¥ç»“æŸï¼Œå¦‚æœå……è¶³ï¼Œç»§ç»­åœ¨redisä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡æ•°æ®ï¼Œè¯´æ˜ä»–å¯ä»¥ä¸‹å•ï¼Œå¦‚æœseté›†åˆä¸­æ²¡æœ‰è¿™æ¡è®°å½•ï¼Œåˆ™å°†userIdå’Œä¼˜æƒ å·å­˜å…¥åˆ°redisä¸­ï¼Œå¹¶ä¸”è¿”å›0ï¼Œæ•´ä¸ªè¿‡ç¨‹éœ€è¦ä¿è¯æ˜¯åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨luaæ¥æ“ä½œ</p>
</li>
<li><p>å½“ä»¥ä¸Šåˆ¤æ–­é€»è¾‘èµ°å®Œä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥åˆ¤æ–­å½“å‰redisä¸­è¿”å›çš„ç»“æœæ˜¯å¦æ˜¯0 ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥ä¸‹å•ï¼Œåˆ™å°†ä¹‹å‰è¯´çš„ä¿¡æ¯å­˜å…¥åˆ°åˆ°queueä¸­å»ï¼Œç„¶åè¿”å›ï¼Œç„¶åå†æ¥ä¸ªçº¿ç¨‹å¼‚æ­¥çš„ä¸‹å•ï¼Œå‰ç«¯å¯ä»¥é€šè¿‡è¿”å›çš„è®¢å•idæ¥åˆ¤æ–­æ˜¯å¦ä¸‹å•æˆåŠŸã€‚</p>
</li>
</ol>
<h3 id="3-7-ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­"><a href="#3-7-ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­" class="headerlink" title="3.7 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­"></a>3.7 ç§’æ€ä¼˜åŒ–-Rediså®Œæˆç§’æ€èµ„æ ¼åˆ¤æ–­</h3><p>éœ€æ±‚ï¼š</p>
<ol>
<li><p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
</li>
<li><p>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</p>
</li>
<li><p>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</p>
</li>
<li><p>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</p>
</li>
<li><p>æ–°å¢ç§’æ€ä¼˜æƒ åˆ¸çš„åŒæ—¶ï¼Œå°†ä¼˜æƒ åˆ¸ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSeckillVoucher</span><span class="hljs-params">(Voucher voucher)</span> &#123;<br>    <span class="hljs-comment">// ä¿å­˜ä¼˜æƒ åˆ¸</span><br>    save(voucher);<br>    <span class="hljs-comment">// ä¿å­˜ç§’æ€ä¿¡æ¯</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillVoucher</span>();<br>    seckillVoucher.setVoucherId(voucher.getId());<br>    seckillVoucher.setStock(voucher.getStock());<br>    seckillVoucher.setBeginTime(voucher.getBeginTime());<br>    seckillVoucher.setEndTime(voucher.getEndTime());<br>    seckillVoucherService.save(seckillVoucher);<br>    <span class="hljs-comment">// ä¿å­˜ç§’æ€åº“å­˜åˆ°Redisä¸­</span><br>    <span class="hljs-comment">//SECKILL_STOCK_KEY è¿™ä¸ªå˜é‡å®šä¹‰åœ¨RedisConstansä¸­</span><br>    <span class="hljs-comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span><br>    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åŸºäºLuaè„šæœ¬ï¼Œåˆ¤æ–­ç§’æ€åº“å­˜ã€ä¸€äººä¸€å•ï¼Œå†³å®šç”¨æˆ·æ˜¯å¦æŠ¢è´­æˆåŠŸ</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 1.å‚æ•°åˆ—è¡¨</span><br><span class="hljs-comment">-- 1.1.ä¼˜æƒ åˆ¸id</span><br><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 1.2.ç”¨æˆ·id</span><br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><span class="hljs-comment">-- 1.3.è®¢å•id</span><br><span class="hljs-keyword">local</span> orderId = ARGV[<span class="hljs-number">3</span>]<br><br><span class="hljs-comment">-- 2.æ•°æ®key</span><br><span class="hljs-comment">-- 2.1.åº“å­˜key</span><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-comment">-- 2.2.è®¢å•key</span><br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br><span class="hljs-comment">-- 3.è„šæœ¬ä¸šåŠ¡</span><br><span class="hljs-comment">-- 3.1.åˆ¤æ–­åº“å­˜æ˜¯å¦å……è¶³ get stockKey</span><br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 3.2.åº“å­˜ä¸è¶³ï¼Œè¿”å›1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.2.åˆ¤æ–­ç”¨æˆ·æ˜¯å¦ä¸‹å• SISMEMBER orderKey userId</span><br><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 3.3.å­˜åœ¨ï¼Œè¯´æ˜æ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.4.æ‰£åº“å­˜ incrby stockKey -1</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br><span class="hljs-comment">-- 3.5.ä¸‹å•ï¼ˆä¿å­˜ç”¨æˆ·ï¼‰sadd orderKey userId</span><br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><span class="hljs-comment">-- 3.6.å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—ä¸­ï¼Œ XADD stream.orders * k1 v1 k2 v2 ...</span><br>redis.call(<span class="hljs-string">&#x27;xadd&#x27;</span>, <span class="hljs-string">&#x27;stream.orders&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;userId&#x27;</span>, userId, <span class="hljs-string">&#x27;voucherId&#x27;</span>, voucherId, <span class="hljs-string">&#x27;id&#x27;</span>, orderId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><strong>VoucherOrderServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">//è·å–ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    <span class="hljs-comment">// 1.æ‰§è¡Œluaè„šæœ¬</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>            SECKILL_SCRIPT,<br>            Collections.emptyList(),<br>            voucherId.toString(), userId.toString(), String.valueOf(orderId)<br>    );<br>    <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>    <span class="hljs-comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span><br>    <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span><br>        <span class="hljs-keyword">return</span> Result.fail(r == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="hljs-string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//TODO ä¿å­˜é˜»å¡é˜Ÿåˆ—</span><br>    <span class="hljs-comment">// 3.è¿”å›è®¢å•id</span><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-8-ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–"><a href="#3-8-ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–" class="headerlink" title="3.8 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–"></a>3.8 ç§’æ€ä¼˜åŒ–-åŸºäºé˜»å¡é˜Ÿåˆ—å®ç°ç§’æ€ä¼˜åŒ–</h3><ol start="3">
<li>å¦‚æœæŠ¢è´­æˆåŠŸï¼Œå°†ä¼˜æƒ åˆ¸idå’Œç”¨æˆ·idå°è£…åå­˜å…¥é˜»å¡é˜Ÿåˆ—</li>
<li>å¼€å¯çº¿ç¨‹ä»»åŠ¡ï¼Œä¸æ–­ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–ä¿¡æ¯ï¼Œå®ç°å¼‚æ­¥ä¸‹å•åŠŸèƒ½</li>
</ol>
<p>ä¿®æ”¹ä¸‹å•åŠ¨ä½œï¼Œç°åœ¨æˆ‘ä»¬å»ä¸‹å•æ—¶ï¼Œæ˜¯é€šè¿‡luaè¡¨è¾¾å¼å»åŸå­æ‰§è¡Œåˆ¤æ–­é€»è¾‘ï¼Œå¦‚æœåˆ¤æ–­æˆ‘å‡ºæ¥ä¸ä¸º0 ï¼Œåˆ™è¦ä¹ˆæ˜¯åº“å­˜ä¸è¶³ï¼Œè¦ä¹ˆæ˜¯é‡å¤ä¸‹å•ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœæ˜¯0ï¼Œåˆ™æŠŠä¸‹å•çš„é€»è¾‘ä¿å­˜åˆ°é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å¼‚æ­¥å¤„ç†çº¿ç¨‹æ± </span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">SECKILL_ORDER_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><br><span class="hljs-comment">//åœ¨ç±»åˆå§‹åŒ–ä¹‹åæ‰§è¡Œï¼Œå› ä¸ºå½“è¿™ä¸ªç±»åˆå§‹åŒ–å¥½äº†ä¹‹åï¼Œéšæ—¶éƒ½æ˜¯æœ‰å¯èƒ½è¦æ‰§è¡Œçš„</span><br><span class="hljs-meta">@PostConstruct</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>   SECKILL_ORDER_EXECUTOR.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrderHandler</span>());<br>&#125;<br><span class="hljs-comment">// ç”¨äºçº¿ç¨‹æ± å¤„ç†çš„ä»»åŠ¡</span><br><span class="hljs-comment">// å½“åˆå§‹åŒ–å®Œæ¯•åï¼Œå°±ä¼šå»ä»å¯¹åˆ—ä¸­å»æ‹¿ä¿¡æ¯</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 1.è·å–é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯</span><br>                    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> orderTasks.take();<br>                    <span class="hljs-comment">// 2.åˆ›å»ºè®¢å•</span><br>                    handleVoucherOrder(voucherOrder);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.error(<span class="hljs-string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);<br>                &#125;<br>          	 &#125;<br>        &#125;<br>     <br>       <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>            <span class="hljs-comment">//1.è·å–ç”¨æˆ·</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>            <span class="hljs-comment">// 2.åˆ›å»ºé”å¯¹è±¡</span><br>            <span class="hljs-type">RLock</span> <span class="hljs-variable">redisLock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock:order:&quot;</span> + userId);<br>            <span class="hljs-comment">// 3.å°è¯•è·å–é”</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> redisLock.lock();<br>            <span class="hljs-comment">// 4.åˆ¤æ–­æ˜¯å¦è·å¾—é”æˆåŠŸ</span><br>            <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                <span class="hljs-comment">// è·å–é”å¤±è´¥ï¼Œç›´æ¥è¿”å›å¤±è´¥æˆ–è€…é‡è¯•</span><br>                log.error(<span class="hljs-string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•ï¼&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//æ³¨æ„ï¼šç”±äºæ˜¯springçš„äº‹åŠ¡æ˜¯æ”¾åœ¨threadLocalä¸­ï¼Œæ­¤æ—¶çš„æ˜¯å¤šçº¿ç¨‹ï¼Œäº‹åŠ¡ä¼šå¤±æ•ˆ</span><br>                proxy.createVoucherOrder(voucherOrder);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// é‡Šæ”¾é”</span><br>                redisLock.unlock();<br>            &#125;<br>    &#125;<br>     <span class="hljs-comment">//a</span><br>	<span class="hljs-keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks =<span class="hljs-keyword">new</span>  <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>        <span class="hljs-comment">// 1.æ‰§è¡Œluaè„šæœ¬</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>                SECKILL_SCRIPT,<br>                Collections.emptyList(),<br>                voucherId.toString(), userId.toString(), String.valueOf(orderId)<br>        );<br>        <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>        <span class="hljs-comment">// 2.åˆ¤æ–­ç»“æœæ˜¯å¦ä¸º0</span><br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 2.1.ä¸ä¸º0 ï¼Œä»£è¡¨æ²¡æœ‰è´­ä¹°èµ„æ ¼</span><br>            <span class="hljs-keyword">return</span> Result.fail(r == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;åº“å­˜ä¸è¶³&quot;</span> : <span class="hljs-string">&quot;ä¸èƒ½é‡å¤ä¸‹å•&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        <span class="hljs-comment">// 2.3.è®¢å•id</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>        voucherOrder.setId(orderId);<br>        <span class="hljs-comment">// 2.4.ç”¨æˆ·id</span><br>        voucherOrder.setUserId(userId);<br>        <span class="hljs-comment">// 2.5.ä»£é‡‘åˆ¸id</span><br>        voucherOrder.setVoucherId(voucherId);<br>        <span class="hljs-comment">// 2.6.æ”¾å…¥é˜»å¡é˜Ÿåˆ—</span><br>        orderTasks.add(voucherOrder);<br>        <span class="hljs-comment">//3.è·å–ä»£ç†å¯¹è±¡</span><br>         proxy = (IVoucherOrderService)AopContext.currentProxy();<br>        <span class="hljs-comment">//4.è¿”å›è®¢å•id</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br>     <br>      <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>        <span class="hljs-comment">// 5.1.æŸ¥è¯¢è®¢å•</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();<br>        <span class="hljs-comment">// 5.2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†</span><br>           log.error(<span class="hljs-string">&quot;ç”¨æˆ·å·²ç»è´­ä¹°è¿‡äº†&quot;</span>);<br>           <span class="hljs-keyword">return</span> ;<br>        &#125;<br><br>        <span class="hljs-comment">// 6.æ‰£å‡åº“å­˜</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>) <span class="hljs-comment">// set stock = stock - 1</span><br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// where id = ? and stock &gt; 0</span><br>                .update();<br>        <span class="hljs-keyword">if</span> (!success) &#123;<br>            <span class="hljs-comment">// æ‰£å‡å¤±è´¥</span><br>            log.error(<span class="hljs-string">&quot;åº“å­˜ä¸è¶³&quot;</span>);<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>        save(voucherOrder);<br> <br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>å°æ€»ç»“ï¼š</strong></p>
<p>ç§’æ€ä¸šåŠ¡çš„ä¼˜åŒ–æ€è·¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>å…ˆåˆ©ç”¨Rediså®Œæˆåº“å­˜ä½™é‡ã€ä¸€äººä¸€å•åˆ¤æ–­ï¼Œå®ŒæˆæŠ¢å•ä¸šåŠ¡</li>
<li>å†å°†ä¸‹å•ä¸šåŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œåˆ©ç”¨ç‹¬ç«‹çº¿ç¨‹å¼‚æ­¥ä¸‹å•</li>
<li>åŸºäºé˜»å¡é˜Ÿåˆ—çš„å¼‚æ­¥ç§’æ€å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ<ul>
<li>å†…å­˜é™åˆ¶é—®é¢˜</li>
<li>æ•°æ®å®‰å…¨é—®é¢˜</li>
</ul>
</li>
</ul>
<h2 id="4-åˆ†å¸ƒå¼é”"><a href="#4-åˆ†å¸ƒå¼é”" class="headerlink" title="4. åˆ†å¸ƒå¼é”"></a>4. åˆ†å¸ƒå¼é”</h2><h3 id="4-1-åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”"><a href="#4-1-åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”" class="headerlink" title="4.1 åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”"></a>4.1 åŸºæœ¬åŸç†å’Œå®ç°æ–¹å¼å¯¹æ¯”</h3><p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚<br>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</p>
<p><img src="/img/blogs/java/redis/2.4.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>åˆ†å¸ƒå¼é”éœ€è¦æ»¡è¶³çš„æ¡ä»¶<ul>
<li>å¯è§æ€§</li>
<li>äº’æ–¥</li>
<li>é«˜å¯ç”¨</li>
<li>é«˜æ€§èƒ½</li>
<li>å®‰å…¨æ€§</li>
</ul>
</li>
</ul>
<p><strong>å¸¸è§çš„åˆ†å¸ƒå¼é”æœ‰ä¸‰ç§</strong>ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>MySQL</th>
<th>Redis</th>
<th>Zookeeper</th>
</tr>
</thead>
<tbody><tr>
<td>äº’æ–¥</td>
<td>åˆ©ç”¨MySQLæœ¬èº«çš„äº’æ–¥é”æœºåˆ¶</td>
<td>åˆ©ç”¨setnxè¿™æ ·çš„äº’æ–¥å‘½ä»¤</td>
<td>åˆ©ç”¨èŠ‚ç‚¹çš„å”¯ä¸€æ€§å’Œæœ‰åºæ€§å®ç°äº’æ–¥</td>
</tr>
<tr>
<td>é«˜å¯ç”¨</td>
<td>å¥½</td>
<td>å¥½</td>
<td>å¥½</td>
</tr>
<tr>
<td>é«˜æ€§èƒ½</td>
<td>ä¸€èˆ¬</td>
<td>å¥½</td>
<td>ä¸€èˆ¬</td>
</tr>
<tr>
<td>å®‰å…¨æ€§</td>
<td>æ–­å¼€è¿æ¥ï¼Œè‡ªåŠ¨é‡Šæ”¾é”</td>
<td>åˆ©ç”¨é”è¶…æ—¶æ—¶é—´ï¼Œåˆ°æœŸé‡Šæ”¾</td>
<td>ä¸´æ—¶èŠ‚ç‚¹ï¼Œæ–­å¼€è¿æ¥è‡ªåŠ¨é‡Šæ”¾</td>
</tr>
</tbody></table>
<h3 id="4-2-åŸºäºRedisçš„åˆ†å¸ƒå¼é”"><a href="#4-2-åŸºäºRedisçš„åˆ†å¸ƒå¼é”" class="headerlink" title="4.2 åŸºäºRedisçš„åˆ†å¸ƒå¼é”"></a>4.2 åŸºäºRedisçš„åˆ†å¸ƒå¼é”</h3><p>å®ç°åˆ†å¸ƒå¼é”æ—¶éœ€è¦å®ç°çš„ä¸¤ä¸ªåŸºæœ¬æ–¹æ³•ï¼š</p>
<ul>
<li>è·å–é”ï¼š<ul>
<li>äº’æ–¥ï¼šç¡®ä¿åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”</li>
<li>éé˜»å¡ï¼šå°è¯•ä¸€æ¬¡ï¼ŒæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false</li>
</ul>
</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-comment"># æ·»åŠ é”ï¼ŒNXæ˜¯äº’æ–¥ã€EXæ˜¯è®¾ç½®è¶…æ—¶æ—¶é—´</span><br>SET lock thread1 NX EX <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<ul>
<li>é‡Šæ”¾é”ï¼š<ul>
<li>æ‰‹åŠ¨é‡Šæ”¾</li>
<li>è¶…æ—¶é‡Šæ”¾ï¼šè·å–é”æ—¶æ·»åŠ ä¸€ä¸ªè¶…æ—¶æ—¶é—´</li>
</ul>
</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-comment"># é‡Šæ”¾é”ï¼Œåˆ é™¤å³å¯</span><br>DEL key<br></code></pre></td></tr></table></figure>

<p><img src="/img/blogs/java/redis/2.4.2.png" srcset="/img/loading.gif" lazyload></p>
<p>æˆ‘ä»¬åˆ©ç”¨redis çš„setNx æ–¹æ³•ï¼Œå½“æœ‰å¤šä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œæˆ‘ä»¬å°±åˆ©ç”¨è¯¥æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æ—¶ï¼Œredis ä¸­å°±æœ‰è¿™ä¸ªkey äº†ï¼Œè¿”å›äº†1ï¼Œå¦‚æœç»“æœæ˜¯1ï¼Œåˆ™è¡¨ç¤ºä»–æŠ¢åˆ°äº†é”ï¼Œé‚£ä¹ˆä»–å»æ‰§è¡Œä¸šåŠ¡ï¼Œç„¶åå†åˆ é™¤é”ï¼Œé€€å‡ºé”é€»è¾‘ï¼Œæ²¡æœ‰æŠ¢åˆ°é”çš„å“¥ä»¬ï¼Œç­‰å¾…ä¸€å®šæ—¶é—´åé‡è¯•å³å¯</p>
<h3 id="4-3-å®ç°åˆ†å¸ƒå¼é”-ç‰ˆæœ¬ä¸€"><a href="#4-3-å®ç°åˆ†å¸ƒå¼é”-ç‰ˆæœ¬ä¸€" class="headerlink" title="4.3 å®ç°åˆ†å¸ƒå¼é”(ç‰ˆæœ¬ä¸€)"></a>4.3 å®ç°åˆ†å¸ƒå¼é”(ç‰ˆæœ¬ä¸€)</h3><ul>
<li>åˆ©ç”¨setnxæ–¹æ³•è¿›è¡ŒåŠ é”ï¼ŒåŒæ—¶å¢åŠ è¿‡æœŸæ—¶é—´ï¼Œé˜²æ­¢æ­»é”ï¼Œæ­¤æ–¹æ³•å¯ä»¥ä¿è¯åŠ é”å’Œå¢åŠ è¿‡æœŸæ—¶é—´å…·æœ‰åŸå­æ€§</li>
<li>é‡Šæ”¾é”é€»è¾‘<ul>
<li>é‡Šæ”¾é”ï¼Œé˜²æ­¢åˆ é™¤åˆ«äººçš„é”</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String KEY_PREFIX=<span class="hljs-string">&quot;lock:&quot;</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>    <span class="hljs-comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId()<br>    <span class="hljs-comment">// è·å–é”</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>            .setIfAbsent(KEY_PREFIX + name, threadId + <span class="hljs-string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//é€šè¿‡delåˆ é™¤é”</span><br>    stringRedisTemplate.delete(KEY_PREFIX + name);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>ä¿®æ”¹ä¸šåŠ¡ä»£ç :</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-comment">//åˆ›å»ºé”å¯¹è±¡(æ–°å¢ä»£ç )</span><br>      <span class="hljs-type">SimpleRedisLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRedisLock</span>(<span class="hljs-string">&quot;order:&quot;</span> + userId, stringRedisTemplate);<br>      <span class="hljs-comment">//è·å–é”å¯¹è±¡</span><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1200</span>);<br><span class="hljs-comment">//åŠ é”å¤±è´¥</span><br>      <span class="hljs-keyword">if</span> (!isLock) &#123;<br>          <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ä¸å…è®¸é‡å¤ä¸‹å•&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">//è·å–ä»£ç†å¯¹è±¡(äº‹åŠ¡)</span><br>          <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) AopContext.currentProxy();<br>          <span class="hljs-keyword">return</span> proxy.createVoucherOrder(voucherId);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-comment">//é‡Šæ”¾é”</span><br>          lock.unlock();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ"><a href="#4-4-Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ" class="headerlink" title="4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ"></a>4.4 Redisåˆ†å¸ƒå¼é”è¯¯åˆ æƒ…å†µ</h3><p>æŒæœ‰é”çš„çº¿ç¨‹åœ¨é”çš„å†…éƒ¨å‡ºç°äº†é˜»å¡ï¼Œå¯¼è‡´ä»–çš„é”è‡ªåŠ¨é‡Šæ”¾ï¼Œè¿™æ—¶å…¶ä»–çº¿ç¨‹ï¼Œçº¿ç¨‹2æ¥å°è¯•è·å¾—é”ï¼Œå°±æ‹¿åˆ°äº†è¿™æŠŠé”ï¼Œç„¶åçº¿ç¨‹2åœ¨æŒæœ‰é”æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹1ååº”è¿‡æ¥ï¼Œç»§ç»­æ‰§è¡Œï¼Œè€Œçº¿ç¨‹1æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ<strong>èµ°åˆ°äº†åˆ é™¤é”é€»è¾‘ï¼Œæ­¤æ—¶å°±ä¼šæŠŠæœ¬åº”è¯¥å±äºçº¿ç¨‹2çš„é”è¿›è¡Œåˆ é™¤</strong>ï¼Œè¿™å°±æ˜¯è¯¯åˆ åˆ«äººé”çš„æƒ…å†µè¯´æ˜</p>
<p><img src="/img/blogs/java/redis/2.4.3.png" srcset="/img/loading.gif" lazyload></p>
<p>è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨æ¯ä¸ªçº¿ç¨‹<strong>é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå»åˆ¤æ–­ä¸€ä¸‹å½“å‰è¿™æŠŠé”æ˜¯å¦å±äºè‡ªå·±</strong>ï¼Œå¦‚æœå±äºè‡ªå·±ï¼Œåˆ™ä¸è¿›è¡Œé”çš„åˆ é™¤</p>
<p><img src="/img/blogs/java/redis/2.4.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜"><a href="#è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜" class="headerlink" title="è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜"></a>è§£å†³Redisåˆ†å¸ƒå¼é”è¯¯åˆ é—®é¢˜</h4><p><img src="/img/blogs/java/redis/2.4.5.png" srcset="/img/loading.gif" lazyload></p>
<p>éœ€æ±‚ï¼šä¿®æ”¹ä¹‹å‰çš„åˆ†å¸ƒå¼é”å®ç°ï¼Œæ»¡è¶³ï¼š</p>
<ul>
<li>åœ¨è·å–é”æ—¶å­˜å…¥çº¿ç¨‹æ ‡ç¤ºï¼ˆå¯ä»¥ç”¨UUIDè¡¨ç¤ºï¼‰</li>
<li>åœ¨é‡Šæ”¾é”æ—¶å…ˆè·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´<ul>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä¸é‡Šæ”¾é”</li>
</ul>
</li>
</ul>
<p><strong>åŠ é”</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>   <span class="hljs-comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span><br>   <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();<br>   <span class="hljs-comment">// è·å–é”</span><br>   <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);<br>   <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>é‡Šæ”¾é”</strong>ï¼š<strong>å…ˆåˆ¤æ–­ï¼Œå†é‡Šæ”¾</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è·å–çº¿ç¨‹æ ‡ç¤º</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();<br>    <span class="hljs-comment">// è·å–é”ä¸­çš„æ ‡ç¤º</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);<br>    <span class="hljs-comment">// åˆ¤æ–­æ ‡ç¤ºæ˜¯å¦ä¸€è‡´</span><br>    <span class="hljs-keyword">if</span>(threadId.equals(id)) &#123;<br>        <span class="hljs-comment">// é‡Šæ”¾é”</span><br>        stringRedisTemplate.delete(KEY_PREFIX + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="4-5-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜"><a href="#4-5-åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜" class="headerlink" title="4.5 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜"></a>4.5 åˆ†å¸ƒå¼é”çš„åŸå­æ€§é—®é¢˜</h3><p>çº¿ç¨‹1ç°åœ¨æŒæœ‰é”ä¹‹åï¼Œåœ¨æ‰§è¡Œä¸šåŠ¡é€»è¾‘è¿‡ç¨‹ä¸­ï¼Œä»–æ­£å‡†å¤‡åˆ é™¤é”ï¼Œè€Œä¸”å·²ç»èµ°åˆ°äº†æ¡ä»¶åˆ¤æ–­çš„è¿‡ç¨‹ä¸­ï¼Œæ¯”å¦‚ä»–å·²ç»æ‹¿åˆ°äº†å½“å‰è¿™æŠŠé”ç¡®å®æ˜¯å±äºä»–è‡ªå·±çš„ï¼Œæ­£å‡†å¤‡åˆ é™¤é”ï¼Œä½†æ˜¯æ­¤æ—¶ä»–çš„é”åˆ°æœŸäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶çº¿ç¨‹2è¿›æ¥ï¼Œä½†æ˜¯çº¿ç¨‹1ä»–ä¼šæ¥ç€å¾€åæ‰§è¡Œï¼Œå½“ä»–å¡é¡¿ç»“æŸåï¼Œä»–ç›´æ¥å°±ä¼šæ‰§è¡Œåˆ é™¤é”é‚£è¡Œä»£ç ï¼Œç›¸å½“äºæ¡ä»¶åˆ¤æ–­å¹¶æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œè¿™å°±æ˜¯åˆ é”æ—¶çš„åŸå­æ€§é—®é¢˜ï¼Œä¹‹æ‰€ä»¥æœ‰è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºçº¿ç¨‹1çš„æ‹¿é”ï¼Œæ¯”é”ï¼Œåˆ é”ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯åŸå­æ€§çš„</p>
<p><img src="/img/blogs/java/redis/2.4.6.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-6-Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜"><a href="#4-6-Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜" class="headerlink" title="4.6 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜"></a>4.6 Luaè„šæœ¬è§£å†³å¤šæ¡å‘½ä»¤åŸå­æ€§é—®é¢˜</h3><p>Redisæä¾›äº†Luaè„šæœ¬åŠŸèƒ½ï¼Œåœ¨ä¸€ä¸ªè„šæœ¬ä¸­ç¼–å†™å¤šæ¡Rediså‘½ä»¤ï¼Œç¡®ä¿å¤šæ¡å‘½ä»¤æ‰§è¡Œæ—¶çš„åŸå­æ€§</p>
<p>Redisæä¾›çš„è°ƒç”¨å‡½æ•°ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">redis.call(<span class="hljs-string">&#x27;å‘½ä»¤åç§°&#x27;</span>, <span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;å…¶å®ƒå‚æ•°&#x27;</span>, ...)<br></code></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦æ‰§è¡Œset name jackï¼Œåˆ™è„šæœ¬æ˜¯è¿™æ ·ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"># æ‰§è¡Œ set name jack<br>redis.call(<span class="hljs-string">&#x27;set&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;jack&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œæˆ‘ä»¬è¦å…ˆæ‰§è¡Œset name Roseï¼Œå†æ‰§è¡Œget nameï¼Œåˆ™è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"># å…ˆæ‰§è¡Œ set name jack<br>redis.call(<span class="hljs-string">&#x27;set&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Rose&#x27;</span>)<br># å†æ‰§è¡Œ get name<br><span class="hljs-keyword">local</span> name = redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)<br># è¿”å›<br><span class="hljs-keyword">return</span> name<br></code></pre></td></tr></table></figure>

<ul>
<li>é‡Šæ”¾é”çš„ä¸šåŠ¡æµç¨‹æ˜¯è¿™æ ·çš„<ol>
<li>è·å–é”ä¸­çš„çº¿ç¨‹æ ‡ç¤º</li>
<li>åˆ¤æ–­æ˜¯å¦ä¸æŒ‡å®šçš„æ ‡ç¤ºï¼ˆå½“å‰çº¿ç¨‹æ ‡ç¤ºï¼‰ä¸€è‡´</li>
<li>å¦‚æœä¸€è‡´åˆ™é‡Šæ”¾é”ï¼ˆåˆ é™¤ï¼‰</li>
<li>å¦‚æœä¸ä¸€è‡´åˆ™ä»€ä¹ˆéƒ½ä¸åš</li>
</ol>
</li>
</ul>
<p>æœ€ç»ˆæˆ‘ä»¬æ“ä½œredisçš„æ‹¿é”æ¯”é”åˆ é”çš„luaè„šæœ¬å°±ä¼šå˜æˆè¿™æ ·</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- è¿™é‡Œçš„ KEYS[1] å°±æ˜¯é”çš„keyï¼Œè¿™é‡Œçš„ARGV[1] å°±æ˜¯å½“å‰çº¿ç¨‹æ ‡ç¤º</span><br><span class="hljs-comment">-- è·å–é”ä¸­çš„æ ‡ç¤ºï¼Œåˆ¤æ–­æ˜¯å¦ä¸å½“å‰çº¿ç¨‹æ ‡ç¤ºä¸€è‡´</span><br><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;GET&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>]) <span class="hljs-keyword">then</span><br>  <span class="hljs-comment">-- ä¸€è‡´ï¼Œåˆ™åˆ é™¤é”</span><br>  <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;DEL&#x27;</span>, KEYS[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- ä¸ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>


<h3 id="4-7-åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”"><a href="#4-7-åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”" class="headerlink" title="4.7 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”"></a>4.7 åˆ©ç”¨Javaä»£ç è°ƒç”¨Luaè„šæœ¬æ”¹é€ åˆ†å¸ƒå¼é”</h3><p>RedisTemplateä¸­ï¼Œå¯ä»¥åˆ©ç”¨executeæ–¹æ³•å»æ‰§è¡Œluaè„šæœ¬</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;<br>    <span class="hljs-keyword">static</span> &#123;<br>        UNLOCK_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        UNLOCK_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;unlock.lua&quot;</span>));<br>        UNLOCK_SCRIPT.setResultType(Long.class);<br>    &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// è°ƒç”¨luaè„šæœ¬</span><br>    stringRedisTemplate.execute(<br>            UNLOCK_SCRIPT,<br>            Collections.singletonList(KEY_PREFIX + name),<br>            ID_PREFIX + Thread.currentThread().getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-8-åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯"><a href="#4-8-åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯" class="headerlink" title="4.8 åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯"></a>4.8 åŸºäºRedisçš„åˆ†å¸ƒå¼é”å®ç°æ€è·¯</h3><ul>
<li>åˆ©ç”¨set nx exè·å–é”ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¿å­˜çº¿ç¨‹æ ‡ç¤º</li>
<li>é‡Šæ”¾é”æ—¶å…ˆåˆ¤æ–­çº¿ç¨‹æ ‡ç¤ºæ˜¯å¦ä¸è‡ªå·±ä¸€è‡´ï¼Œä¸€è‡´åˆ™åˆ é™¤é”<ul>
<li>ç‰¹æ€§ï¼š<ul>
<li>åˆ©ç”¨set nxæ»¡è¶³äº’æ–¥æ€§</li>
<li>åˆ©ç”¨set exä¿è¯æ•…éšœæ—¶é”ä¾ç„¶èƒ½é‡Šæ”¾ï¼Œé¿å…æ­»é”ï¼Œæé«˜å®‰å…¨æ€§</li>
<li>åˆ©ç”¨Redisé›†ç¾¤ä¿è¯é«˜å¯ç”¨å’Œé«˜å¹¶å‘ç‰¹æ€§</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-9-åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»"><a href="#4-9-åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»" class="headerlink" title="4.9 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»"></a>4.9 åˆ†å¸ƒå¼é”-redissionåŠŸèƒ½ä»‹ç»</h3><p>åŸºäºsetnxå®ç°çš„åˆ†å¸ƒå¼é”å­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š</p>
<ul>
<li><strong>ä¸å¯é‡å…¥é—®é¢˜</strong>ï¼šåŒä¸€ä¸ªçº¿ç¨‹æ— æ³•å¤šæ¬¡è·å–åŒä¸€æŠŠé”</li>
<li><strong>ä¸å¯é‡è¯•</strong>ï¼šè·å–é”åªå°è¯•ä¸€æ¬¡å°±è¿”å›falseï¼Œæ²¡æœ‰é‡è¯•æœºåˆ¶</li>
<li><strong>è¶…æ—¶é‡Šæ”¾ï¼š</strong>ï¼š é”è¶…æ—¶é‡Šæ”¾è™½ç„¶å¯ä»¥é¿å…æ­»é”ï¼Œä½†å¦‚æœæ˜¯ä¸šåŠ¡æ‰§è¡Œè€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¼šå¯¼è‡´é”é‡Šæ”¾ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£</li>
<li><strong>ä¸»ä»ä¸€è‡´æ€§ï¼š</strong> ï¼šå¦‚æœRedisæä¾›äº†ä¸»ä»é›†ç¾¤ï¼Œä¸»ä»åŒæ­¥å­˜åœ¨å»¶è¿Ÿï¼Œå½“ä¸»å®•æœºæ—¶ï¼Œå¦‚æœä»å¹¶åŒæ­¥ä¸»ä¸­çš„é”æ•°æ®ï¼Œåˆ™ä¼šå‡ºç°é”å®ç°</li>
</ul>
<p>Redissonæ˜¯ä¸€ä¸ªåœ¨Redisçš„åŸºç¡€ä¸Šå®ç°çš„Javaé©»å†…å­˜æ•°æ®ç½‘æ ¼ï¼ˆIn-Memory Data Gridï¼‰ã€‚å®ƒä¸ä»…æä¾›äº†ä¸€ç³»åˆ—çš„åˆ†å¸ƒå¼çš„Javaå¸¸ç”¨å¯¹è±¡ï¼Œè¿˜æä¾›äº†è®¸å¤šåˆ†å¸ƒå¼æœåŠ¡ï¼Œå…¶ä¸­å°±åŒ…å«äº†å„ç§åˆ†å¸ƒå¼é”çš„å®ç°ã€‚</p>
<p><strong>Redissionæä¾›äº†åˆ†å¸ƒå¼é”çš„å¤šç§å¤šæ ·çš„åŠŸèƒ½</strong></p>
<h3 id="4-10-åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨"><a href="#4-10-åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨" class="headerlink" title="4.10 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨"></a>4.10 åˆ†å¸ƒå¼é”-Redissionå¿«é€Ÿå…¥é—¨</h3><ol>
<li>å¼•å…¥ä¾èµ–ï¼š</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.13.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®Redissonå®¢æˆ·ç«¯ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// é…ç½®</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.150.101:6379&quot;</span>)<br>            .setPassword(<span class="hljs-string">&quot;123321&quot;</span>);<br>        <span class="hljs-comment">// åˆ›å»ºRedissonClientå¯¹è±¡</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ä½¿ç”¨Redissionçš„åˆ†å¸ƒå¼é”</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissionClient redissonClient;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br>    <span class="hljs-comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>    <span class="hljs-comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span>(isLock)&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          <br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            <span class="hljs-comment">//é‡Šæ”¾é”</span><br>            lock.unlock();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="4-11-åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†"><a href="#4-11-åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†" class="headerlink" title="4.11 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†"></a>4.11 åˆ†å¸ƒå¼é”-redissionå¯é‡å…¥é”åŸç†</h3><p><img src="/img/blogs/java/redis/2.4.7.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºé”å¯¹è±¡</span><br>   <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>       <span class="hljs-keyword">if</span> (!isLock) &#123;<br>           log.error(<span class="hljs-string">&quot;è·å–é”å¤±è´¥,1&quot;</span>);<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-keyword">try</span> &#123;<br>           log.info(<span class="hljs-string">&quot;è·å–é”æˆåŠŸ,1&quot;</span>);<br>           method2();<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           log.info(<span class="hljs-string">&quot;é‡Šæ”¾é”,1&quot;</span>);<br>           lock.unlock();<br>       &#125;<br><br>       <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span> <span class="hljs-params">()</span> &#123;<br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>           <span class="hljs-keyword">if</span> (!isLock) &#123;<br>               log.error(<span class="hljs-string">&quot;è·å–é”å¤±è´¥,2&quot;</span>);<br>               <span class="hljs-keyword">return</span>;<br>           &#125;<br>           <span class="hljs-keyword">try</span> &#123;<br>               log.info(<span class="hljs-string">&quot;è·å–é”æˆåŠŸ,2&quot;</span>);<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               log.info(<span class="hljs-string">&quot;é‡Šæ”¾é”,2&quot;</span>);<br>               lock.unlock();<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-12-åˆ†å¸ƒå¼é”-redission-é”é‡è¯•å’ŒWatchDogæœºåˆ¶"><a href="#4-12-åˆ†å¸ƒå¼é”-redission-é”é‡è¯•å’ŒWatchDogæœºåˆ¶" class="headerlink" title="4.12 åˆ†å¸ƒå¼é”-redission é”é‡è¯•å’ŒWatchDogæœºåˆ¶"></a>4.12 åˆ†å¸ƒå¼é”-redission é”é‡è¯•å’ŒWatchDogæœºåˆ¶</h3><p><img src="/img/blogs/java/redis/2.4.8.png" srcset="/img/loading.gif" lazyload></p>
<p>Redissonåˆ†å¸ƒå¼é”åŸç†ï¼š</p>
<ul>
<li>å¯é‡å…¥ï¼šåˆ©ç”¨hashç»“æ„è®°å½•çº¿ç¨‹idå’Œé‡å…¥æ¬¡æ•°</li>
<li>å¯é‡è¯•ï¼šåˆ©ç”¨ä¿¡å·é‡å’ŒPubSubåŠŸèƒ½å®ç°ç­‰å¾…ã€å”¤é†’ï¼Œè·å–é”å¤±è´¥çš„é‡è¯•æœºåˆ¶</li>
<li>è¶…æ—¶ç»­çº¦ï¼šåˆ©ç”¨watchDogï¼Œæ¯éš”ä¸€æ®µæ—¶é—´ï¼ˆreleaseTime &#x2F; 3ï¼‰ï¼Œé‡ç½®è¶…æ—¶æ—¶é—´</li>
</ul>
<h3 id="4-13-åˆ†å¸ƒå¼é”-redission-é”çš„MutiLockåŸç†"><a href="#4-13-åˆ†å¸ƒå¼é”-redission-é”çš„MutiLockåŸç†" class="headerlink" title="4.13 åˆ†å¸ƒå¼é”-redission  é”çš„MutiLockåŸç†"></a>4.13 åˆ†å¸ƒå¼é”-redission  é”çš„MutiLockåŸç†</h3><p>redissionæå‡ºæ¥äº†MutiLocké”ï¼Œä½¿ç”¨è¿™æŠŠé”å’±ä»¬å°±ä¸ä½¿ç”¨ä¸»ä»äº†,æ¯ä¸ªèŠ‚ç‚¹çš„åœ°ä½éƒ½æ˜¯ä¸€æ ·çš„<br>è¿™æŠŠé”åŠ é”çš„é€»è¾‘éœ€è¦å†™å…¥åˆ°æ¯ä¸€ä¸ªä¸»ä¸›èŠ‚ç‚¹ä¸Šï¼Œåªæœ‰æ‰€æœ‰çš„æœåŠ¡å™¨éƒ½å†™å…¥æˆåŠŸï¼Œæ­¤æ—¶æ‰æ˜¯åŠ é”æˆåŠŸï¼Œå‡è®¾ç°åœ¨æŸä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£ä¹ˆä»–å»è·å¾—é”çš„æ—¶å€™ï¼Œåªè¦æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‹¿ä¸åˆ°ï¼Œéƒ½ä¸èƒ½ç®—æ˜¯åŠ é”æˆåŠŸï¼Œå°±ä¿è¯äº†åŠ é”çš„å¯é æ€§ã€‚</p>
<p><img src="/img/blogs/java/redis/2.4.9.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><ol>
<li>ä¸å¯é‡å…¥Redisåˆ†å¸ƒå¼é”ï¼š<ul>
<li>åŸç†ï¼šåˆ©ç”¨setnxçš„äº’æ–¥æ€§ï¼›åˆ©ç”¨exé¿å…æ­»é”ï¼›é‡Šæ”¾é”æ—¶åˆ¤æ–­çº¿ç¨‹æ ‡ç¤º</li>
<li>ç¼ºé™·ï¼šä¸å¯é‡å…¥ã€æ— æ³•é‡è¯•ã€é”è¶…æ—¶å¤±æ•ˆ</li>
</ul>
</li>
<li>å¯é‡å…¥çš„Redisåˆ†å¸ƒå¼é”ï¼š<ul>
<li>åŸç†ï¼šåˆ©ç”¨hashç»“æ„ï¼Œè®°å½•çº¿ç¨‹æ ‡ç¤ºå’Œé‡å…¥æ¬¡æ•°ï¼›åˆ©ç”¨watchDogå»¶ç»­é”æ—¶é—´ï¼›åˆ©ç”¨ä¿¡å·é‡æ§åˆ¶é”é‡è¯•ç­‰å¾…</li>
<li>ç¼ºé™·ï¼šrediså®•æœºå¼•èµ·é”å¤±æ•ˆé—®é¢˜</li>
</ul>
</li>
<li>Redissonçš„multiLockï¼š<ul>
<li>åŸç†ï¼šå¤šä¸ªç‹¬ç«‹çš„RedisèŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è·å–é‡å…¥é”ï¼Œæ‰ç®—è·å–é”æˆåŠŸ</li>
<li>ç¼ºé™·ï¼šè¿ç»´æˆæœ¬é«˜ã€å®ç°å¤æ‚</li>
</ul>
</li>
</ol>
<h2 id="5-Redisæ¶ˆæ¯é˜Ÿåˆ—-å®ç°å¼‚æ­¥ç§’æ€"><a href="#5-Redisæ¶ˆæ¯é˜Ÿåˆ—-å®ç°å¼‚æ­¥ç§’æ€" class="headerlink" title="5. Redisæ¶ˆæ¯é˜Ÿåˆ—(å®ç°å¼‚æ­¥ç§’æ€)"></a>5. Redisæ¶ˆæ¯é˜Ÿåˆ—(å®ç°å¼‚æ­¥ç§’æ€)</h2><h3 id="5-1-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-1-è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5.1 è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—"></a>5.1 è®¤è¯†æ¶ˆæ¯é˜Ÿåˆ—</h3><p>ä»€ä¹ˆæ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚æœ€ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹åŒ…æ‹¬3ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå­˜å‚¨å’Œç®¡ç†æ¶ˆæ¯ï¼Œä¹Ÿè¢«ç§°ä¸ºæ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰</li>
<li>ç”Ÿäº§è€…ï¼šå‘é€æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>æ¶ˆè´¹è€…ï¼šä»æ¶ˆæ¯é˜Ÿåˆ—è·å–æ¶ˆæ¯å¹¶å¤„ç†æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.1.png" srcset="/img/loading.gif" lazyload></p>
<p>Redisæä¾›äº†ä¸‰ç§ä¸åŒçš„æ–¹å¼æ¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼š</p>
<ul>
<li>listç»“æ„ï¼šåŸºäºListç»“æ„æ¨¡æ‹Ÿæ¶ˆæ¯é˜Ÿåˆ—</li>
<li>PubSubï¼šåŸºæœ¬çš„ç‚¹å¯¹ç‚¹æ¶ˆæ¯æ¨¡å‹</li>
<li>Streamï¼šæ¯”è¾ƒå®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—æ¨¡å‹</li>
</ul>
<h3 id="5-2-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-2-åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—"></a>5.2 åŸºäºListå®ç°æ¶ˆæ¯é˜Ÿåˆ—</h3><p><strong>åªèƒ½å•ä¸ªç”Ÿäº§è€…å•ä¸ªæ¶ˆè´¹è€…</strong><br>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰ï¼Œå­—é¢æ„æ€å°±æ˜¯å­˜æ”¾æ¶ˆæ¯çš„é˜Ÿåˆ—ã€‚è€ŒRedisçš„listæ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¾ˆå®¹æ˜“æ¨¡æ‹Ÿå‡ºé˜Ÿåˆ—æ•ˆæœã€‚</p>
<ul>
<li>é˜Ÿåˆ—æ˜¯å…¥å£å’Œå‡ºå£ä¸åœ¨ä¸€è¾¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ï¼šLPUSH ç»“åˆ RPOPã€æˆ–è€… RPUSH ç»“åˆ LPOPæ¥å®ç°ã€‚</li>
<li>ä¸è¿‡è¦æ³¨æ„çš„æ˜¯ï¼Œå½“é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯æ—¶RPOPæˆ–LPOPæ“ä½œä¼šè¿”å›nullï¼Œå¹¶ä¸åƒJVMçš„é˜»å¡é˜Ÿåˆ—é‚£æ ·ä¼šé˜»å¡å¹¶ç­‰å¾…æ¶ˆæ¯ã€‚å› æ­¤è¿™é‡Œåº”è¯¥ä½¿ç”¨BRPOPæˆ–è€…BLPOPæ¥å®ç°é˜»å¡æ•ˆæœã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>åŸºäºListçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹</strong>?</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>åˆ©ç”¨Rediså­˜å‚¨ï¼Œä¸å—é™äºJVMå†…å­˜ä¸Šé™</li>
<li>åŸºäºRedisçš„æŒä¹…åŒ–æœºåˆ¶ï¼Œæ•°æ®å®‰å…¨æ€§æœ‰ä¿è¯</li>
<li>å¯ä»¥æ»¡è¶³æ¶ˆæ¯æœ‰åºæ€§</li>
</ul>
</li>
<li><p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>åªæ”¯æŒå•æ¶ˆè´¹è€…</li>
</ul>
</li>
</ul>
<h3 id="5-3-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-3-åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5.3 åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—"></a>5.3 åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p><strong>å¯ä»¥å¤šç”Ÿäº§å¤šæ¶ˆè´¹</strong><br>PubSubï¼ˆå‘å¸ƒè®¢é˜…ï¼‰æ˜¯Redis2.0ç‰ˆæœ¬å¼•å…¥çš„æ¶ˆæ¯ä¼ é€’æ¨¡å‹ã€‚é¡¾åæ€ä¹‰ï¼Œ<strong>æ¶ˆè´¹è€…å¯ä»¥è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªchannel</strong>ï¼Œç”Ÿäº§è€…å‘å¯¹åº”channelå‘é€æ¶ˆæ¯åï¼Œæ‰€æœ‰è®¢é˜…è€…éƒ½èƒ½æ”¶åˆ°ç›¸å…³æ¶ˆæ¯ã€‚</p>
<p>å¸¸ç”¨å‘½ä»¤ï¼š</p>
<ul>
<li><code>SUBSCRIBE channel [channel]</code> ï¼šè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“</li>
<li><code>PUBLISH channel msg</code> ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯</li>
<li><code>PSUBSCRIBE pattern[pattern]</code> ï¼šè®¢é˜…ä¸patternæ ¼å¼åŒ¹é…çš„æ‰€æœ‰é¢‘é“</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>åŸºäºPubSubçš„æ¶ˆæ¯é˜Ÿåˆ—æœ‰å“ªäº›ä¼˜ç¼ºç‚¹ï¼Ÿ</strong><br>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>é‡‡ç”¨å‘å¸ƒè®¢é˜…æ¨¡å‹ï¼Œæ”¯æŒå¤šç”Ÿäº§ã€å¤šæ¶ˆè´¹</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸æ”¯æŒæ•°æ®æŒä¹…åŒ–</li>
<li>æ— æ³•é¿å…æ¶ˆæ¯ä¸¢å¤±</li>
<li>æ¶ˆæ¯å †ç§¯æœ‰ä¸Šé™ï¼Œè¶…å‡ºæ—¶æ•°æ®ä¸¢å¤±</li>
</ul>
<h3 id="5-4-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-4-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5.4 åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—"></a>5.4 åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—</h3><p>Stream æ˜¯ Redis 5.0 å¼•å…¥çš„ä¸€ç§æ–°æ•°æ®ç±»å‹ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªåŠŸèƒ½éå¸¸å®Œå–„çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<ol>
<li>å‘é€æ¶ˆæ¯çš„å‘½ä»¤ï¼š</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.4.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>è¯»å–æ¶ˆæ¯çš„æ–¹å¼ä¹‹ä¸€ï¼šXREAD</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.5.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>XREADé˜»å¡æ–¹å¼ï¼Œè¯»å–æœ€æ–°çš„æ¶ˆæ¯ï¼š</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.6.png" srcset="/img/loading.gif" lazyload></p>
<ol start="4">
<li>åœ¨ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¾ªç¯çš„è°ƒç”¨XREADé˜»å¡æ–¹å¼æ¥æŸ¥è¯¢æœ€æ–°æ¶ˆæ¯ï¼Œä»è€Œå®ç°æŒç»­ç›‘å¬é˜Ÿåˆ—çš„æ•ˆæœï¼Œä¼ªä»£ç å¦‚ä¸‹</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.7.png" srcset="/img/loading.gif" lazyload></p>
<p>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADå‘½ä»¤ç‰¹ç‚¹ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªæ¶ˆè´¹è€…è¯»å–</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
</ul>
<h3 id="5-5-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„"><a href="#5-5-åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„" class="headerlink" title="5.5 åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„"></a>5.5 åŸºäºStreamçš„æ¶ˆæ¯é˜Ÿåˆ—-æ¶ˆè´¹è€…ç»„</h3><p>æ¶ˆè´¹è€…ç»„ï¼ˆConsumer Groupï¼‰ï¼šå°†å¤šä¸ªæ¶ˆè´¹è€…åˆ’åˆ†åˆ°ä¸€ä¸ªç»„ä¸­ï¼Œç›‘å¬åŒä¸€ä¸ªé˜Ÿåˆ—ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li><strong>æ¶ˆæ¯åˆ†æµ</strong><ul>
<li>é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ä¼šåˆ†æµç»™ç»„å†…çš„ä¸åŒæ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯é‡å¤æ¶ˆè´¹ï¼Œä»è€ŒåŠ å¿«æ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦</li>
</ul>
</li>
<li><strong>æ¶ˆæ¯æ ‡ç¤º</strong><ul>
<li>æ¶ˆè´¹è€…ç»„ä¼šç»´æŠ¤ä¸€ä¸ªæ ‡ç¤ºï¼Œè®°å½•æœ€åä¸€ä¸ªè¢«å¤„ç†çš„æ¶ˆæ¯ï¼Œå“ªæ€•æ¶ˆè´¹è€…å®•æœºé‡å¯ï¼Œè¿˜ä¼šä»æ ‡ç¤ºä¹‹åè¯»å–æ¶ˆæ¯ã€‚ç¡®ä¿æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½ä¼šè¢«æ¶ˆè´¹</li>
</ul>
</li>
<li><strong>æ¶ˆæ¯ç¡®è®¤</strong><ul>
<li>æ¶ˆè´¹è€…è·å–æ¶ˆæ¯åï¼Œæ¶ˆæ¯å¤„äºpendingçŠ¶æ€ï¼Œå¹¶å­˜å…¥ä¸€ä¸ªpending-listã€‚å½“å¤„ç†å®Œæˆåéœ€è¦é€šè¿‡XACKæ¥ç¡®è®¤æ¶ˆæ¯ï¼Œæ ‡è®°æ¶ˆæ¯ä¸ºå·²å¤„ç†ï¼Œæ‰ä¼šä»pending-listç§»é™¤ã€‚</li>
</ul>
</li>
</ul>
<p><strong>åˆ›å»ºæ¶ˆè´¹è€…ç»„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP CREATE  key groupName ID [MKSTREAM]<br></code></pre></td></tr></table></figure>

<ul>
<li>keyï¼šé˜Ÿåˆ—åç§°</li>
<li>groupNameï¼šæ¶ˆè´¹è€…ç»„åç§°</li>
<li>IDï¼šèµ·å§‹IDæ ‡ç¤ºï¼Œ$ä»£è¡¨é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯ï¼Œ0åˆ™ä»£è¡¨é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯</li>
<li>MKSTREAMï¼šé˜Ÿåˆ—ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»ºé˜Ÿåˆ—</li>
</ul>
<p><strong>åˆ é™¤æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP DESTORY key groupName<br></code></pre></td></tr></table></figure>

<p> <strong>ç»™æŒ‡å®šçš„æ¶ˆè´¹è€…ç»„æ·»åŠ æ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP CREATECONSUMER key groupname consumername<br></code></pre></td></tr></table></figure>

<p> <strong>åˆ é™¤æ¶ˆè´¹è€…ç»„ä¸­çš„æŒ‡å®šæ¶ˆè´¹è€…</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP DELCONSUMER key groupname consumername<br></code></pre></td></tr></table></figure>

<p><strong>ä»æ¶ˆè´¹è€…ç»„è¯»å–æ¶ˆæ¯</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]<br></code></pre></td></tr></table></figure>

<ul>
<li>groupï¼šæ¶ˆè´¹ç»„åç§°</li>
<li>consumerï¼šæ¶ˆè´¹è€…åç§°ï¼Œå¦‚æœæ¶ˆè´¹è€…ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€…</li>
<li>countï¼šæœ¬æ¬¡æŸ¥è¯¢çš„æœ€å¤§æ•°é‡</li>
<li>BLOCK millisecondsï¼šå½“æ²¡æœ‰æ¶ˆæ¯æ—¶æœ€é•¿ç­‰å¾…æ—¶é—´</li>
<li>NOACKï¼šæ— éœ€æ‰‹åŠ¨ACKï¼Œè·å–åˆ°æ¶ˆæ¯åè‡ªåŠ¨ç¡®è®¤</li>
<li>STREAMS keyï¼šæŒ‡å®šé˜Ÿåˆ—åç§°</li>
<li>IDï¼šè·å–æ¶ˆæ¯çš„èµ·å§‹IDï¼š<ul>
<li>â€œ&gt;â€ï¼šä»ä¸‹ä¸€ä¸ªæœªæ¶ˆè´¹çš„æ¶ˆæ¯å¼€å§‹</li>
<li>å…¶å®ƒï¼šæ ¹æ®æŒ‡å®šidä»pending-listä¸­è·å–å·²æ¶ˆè´¹ä½†æœªç¡®è®¤çš„æ¶ˆæ¯ï¼Œä¾‹å¦‚0ï¼Œæ˜¯ä»pending-listä¸­çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯å¼€å§‹</li>
</ul>
</li>
</ul>
<p><strong>æ¶ˆè´¹è€…ç›‘å¬æ¶ˆæ¯çš„åŸºæœ¬æ€è·¯</strong>:</p>
<p><img src="/img/blogs/java/redis/2.5.8.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>STREAMç±»å‹æ¶ˆæ¯é˜Ÿåˆ—çš„XREADGROUPå‘½ä»¤ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>æ¶ˆæ¯å¯å›æº¯</li>
<li>å¯ä»¥å¤šæ¶ˆè´¹è€…äº‰æŠ¢æ¶ˆæ¯ï¼ŒåŠ å¿«æ¶ˆè´¹é€Ÿåº¦</li>
<li>å¯ä»¥é˜»å¡è¯»å–</li>
<li>æ²¡æœ‰æ¶ˆæ¯æ¼è¯»çš„é£é™©</li>
<li>æœ‰æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼Œä¿è¯æ¶ˆæ¯è‡³å°‘è¢«æ¶ˆè´¹ä¸€æ¬¡</li>
</ul>
<p><strong>å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>PubSub</th>
<th>Stream</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong></td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td><strong>é˜»å¡è¯»å–</strong></td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å †ç§¯å¤„ç†</strong></td>
<td>å—é™äºå†…å­˜ç©ºé—´ï¼Œå¯ä»¥åˆ©ç”¨å¤šæ¶ˆè´¹è€…åŠ å¿«å¤„ç†</td>
<td>å—é™äºæ¶ˆè´¹è€…ç¼“å†²åŒº</td>
<td>å—é™äºé˜Ÿåˆ—é•¿åº¦ï¼Œå¯ä»¥åˆ©ç”¨æ¶ˆè´¹è€…ç»„æé«˜æ¶ˆè´¹é€Ÿåº¦ï¼Œå‡å°‘å †ç§¯</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯ç¡®è®¤æœºåˆ¶</strong></td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å›æº¯</strong></td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
</tbody></table>
<h3 id="5-6-åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•"><a href="#5-6-åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•" class="headerlink" title="5.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•"></a>5.6 åŸºäºRedisçš„Streamç»“æ„ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå®ç°å¼‚æ­¥ç§’æ€ä¸‹å•</h3><ul>
<li>åˆ›å»ºä¸€ä¸ªStreamç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåä¸ºstream.orders</li>
<li>ä¿®æ”¹ä¹‹å‰çš„ç§’æ€ä¸‹å•Luaè„šæœ¬ï¼Œåœ¨è®¤å®šæœ‰æŠ¢è´­èµ„æ ¼åï¼Œç›´æ¥å‘stream.ordersä¸­æ·»åŠ æ¶ˆæ¯ï¼Œå†…å®¹åŒ…å«voucherIdã€userIdã€orderId</li>
<li>é¡¹ç›®å¯åŠ¨æ—¶ï¼Œå¼€å¯ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ï¼Œå°è¯•è·å–stream.ordersä¸­çš„æ¶ˆæ¯ï¼Œå®Œæˆä¸‹å•</li>
</ul>
<p><strong>VoucherOrderServiceImpl</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1.è·å–æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>).block(Duration.ofSeconds(<span class="hljs-number">2</span>)),<br>                    StreamOffset.create(<span class="hljs-string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())<br>                );<br>                <span class="hljs-comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span><br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰æ¶ˆæ¯ï¼Œç»§ç»­ä¸‹ä¸€æ¬¡å¾ªç¯</span><br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-comment">// è§£ææ•°æ®</span><br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; value = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 3.åˆ›å»ºè®¢å•</span><br>                createVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span><br>                stringRedisTemplate.opsForStream().acknowledge(<span class="hljs-string">&quot;s1&quot;</span>, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;å¤„ç†è®¢å•å¼‚å¸¸&quot;</span>, e);<br>                <span class="hljs-comment">//å¤„ç†å¼‚å¸¸æ¶ˆæ¯</span><br>                handlePendingList();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePendingList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1.è·å–pending-listä¸­çš„è®¢å•ä¿¡æ¯ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>),<br>                    StreamOffset.create(<span class="hljs-string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="hljs-string">&quot;0&quot;</span>))<br>                );<br>                <span class="hljs-comment">// 2.åˆ¤æ–­è®¢å•ä¿¡æ¯æ˜¯å¦ä¸ºç©º</span><br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// å¦‚æœä¸ºnullï¼Œè¯´æ˜æ²¡æœ‰å¼‚å¸¸æ¶ˆæ¯ï¼Œç»“æŸå¾ªç¯</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">// è§£ææ•°æ®</span><br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; value = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 3.åˆ›å»ºè®¢å•</span><br>                createVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// 4.ç¡®è®¤æ¶ˆæ¯ XACK</span><br>                stringRedisTemplate.opsForStream().acknowledge(<span class="hljs-string">&quot;s1&quot;</span>, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;å¤„ç†penddingè®¢å•å¼‚å¸¸&quot;</span>, e);<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Thread.sleep(<span class="hljs-number">20</span>);<br>                &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-è¾¾äººæ¢åº—"><a href="#6-è¾¾äººæ¢åº—" class="headerlink" title="6. è¾¾äººæ¢åº—"></a>6. è¾¾äººæ¢åº—</h2><h3 id="6-1-å‘å¸ƒæ¢åº—ç¬”è®°"><a href="#6-1-å‘å¸ƒæ¢åº—ç¬”è®°" class="headerlink" title="6.1 å‘å¸ƒæ¢åº—ç¬”è®°"></a>6.1 å‘å¸ƒæ¢åº—ç¬”è®°</h3><p>æ¢åº—ç¬”è®°ç±»ä¼¼ç‚¹è¯„ç½‘ç«™çš„è¯„ä»·ï¼Œå¾€å¾€æ˜¯å›¾æ–‡ç»“åˆã€‚å¯¹åº”çš„è¡¨æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>tb_blogï¼šæ¢åº—ç¬”è®°è¡¨ï¼ŒåŒ…å«ç¬”è®°ä¸­çš„æ ‡é¢˜ã€æ–‡å­—ã€å›¾ç‰‡ç­‰</li>
<li>tb_blog_commentsï¼šå…¶ä»–ç”¨æˆ·å¯¹æ¢åº—ç¬”è®°çš„è¯„ä»·</li>
</ul>
<h4 id="6-1-1-ä¸Šä¼ æ¥å£"><a href="#6-1-1-ä¸Šä¼ æ¥å£" class="headerlink" title="6.1.1 ä¸Šä¼ æ¥å£"></a>6.1.1 ä¸Šä¼ æ¥å£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;upload&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;blog&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">uploadImage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// è·å–åŸå§‹æ–‡ä»¶åç§°</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> image.getOriginalFilename();<br>            <span class="hljs-comment">// ç”Ÿæˆæ–°æ–‡ä»¶å</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> createNewFileName(originalFilename);<br>            <span class="hljs-comment">// ä¿å­˜æ–‡ä»¶</span><br>            image.transferTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));<br>            <span class="hljs-comment">// è¿”å›ç»“æœ</span><br>            log.debug(<span class="hljs-string">&quot;æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œ&#123;&#125;&quot;</span>, fileName);<br>            <span class="hljs-keyword">return</span> Result.ok(fileName);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;æ–‡ä»¶ä¸Šä¼ å¤±è´¥&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-1-2-BlogController"><a href="#6-1-2-BlogController" class="headerlink" title="6.1.2 BlogController"></a>6.1.2 BlogController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/blog&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IBlogService blogService;<br><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Blog blog)</span> &#123;<br>        <span class="hljs-comment">//è·å–ç™»å½•ç”¨æˆ·</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>        blog.setUpdateTime(user.getId());<br>        <span class="hljs-comment">//ä¿å­˜æ¢åº—åšæ–‡</span><br>        blogService.saveBlog(blog);<br>        <span class="hljs-comment">//è¿”å›id</span><br>        <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="6-1-3-BlogServiceImpl"><a href="#6-1-3-BlogServiceImpl" class="headerlink" title="6.1.3 BlogServiceImpl"></a>6.1.3 BlogServiceImpl</h4><p>å®ç°æŸ¥çœ‹å‘å¸ƒæ¢åº—ç¬”è®°çš„æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢blog</span><br>    <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-keyword">if</span> (blog == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ç¬”è®°ä¸å­˜åœ¨ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 2.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span><br>    queryBlogUser(blog);<br>  <br>    <span class="hljs-keyword">return</span> Result.ok(blog);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-2-ç‚¹èµåŠŸèƒ½"><a href="#6-2-ç‚¹èµåŠŸèƒ½" class="headerlink" title="6.2 ç‚¹èµåŠŸèƒ½"></a>6.2 ç‚¹èµåŠŸèƒ½</h3><p>éœ€æ±‚ï¼š</p>
<ul>
<li><strong>åŒä¸€ä¸ªç”¨æˆ·åªèƒ½ç‚¹èµä¸€æ¬¡</strong>ï¼Œå†æ¬¡ç‚¹å‡»åˆ™å–æ¶ˆç‚¹èµ</li>
<li>å¦‚æœå½“å‰ç”¨æˆ·<strong>å·²ç»ç‚¹èµï¼Œåˆ™ç‚¹èµæŒ‰é’®é«˜äº®æ˜¾ç¤º</strong>ï¼ˆå‰ç«¯å·²å®ç°ï¼Œåˆ¤æ–­å­—æ®µBlogç±»çš„isLikeå±æ€§ï¼‰</li>
</ul>
<ul>
<li>ä¸ºä»€ä¹ˆ<strong>é‡‡ç”¨seté›†åˆ</strong>ï¼šå› ä¸ºæˆ‘ä»¬çš„æ•°æ®æ˜¯ä¸èƒ½é‡å¤çš„</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span>&#123;<br>       <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>       <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>       <span class="hljs-comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>       <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>       <span class="hljs-keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;<br>            <span class="hljs-comment">//3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span><br>           <span class="hljs-comment">//3.1 æ•°æ®åº“ç‚¹èµæ•°+1</span><br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>           <span class="hljs-comment">//3.2 ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ</span><br>           <span class="hljs-keyword">if</span>(isSuccess)&#123;<br>               stringRedisTemplate.opsForSet().add(key,userId.toString());<br>           &#125;<br>       &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span><br>           <span class="hljs-comment">//4.1 æ•°æ®åº“ç‚¹èµæ•°-1</span><br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>           <span class="hljs-comment">//4.2 æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span><br>           <span class="hljs-keyword">if</span>(isSuccess)&#123;<br>               stringRedisTemplate.opsForSet().remove(key,userId.toString());<br>           &#125;<br>       &#125;<br></code></pre></td></tr></table></figure>

<p>å®ç°æ­¥éª¤ï¼š</p>
<ul>
<li>ç»™Blogç±»ä¸­æ·»åŠ ä¸€ä¸ªisLikeå­—æ®µï¼Œæ ‡ç¤ºæ˜¯å¦è¢«å½“å‰ç”¨æˆ·ç‚¹èµ</li>
<li>ä¿®æ”¹ç‚¹èµåŠŸèƒ½ï¼Œåˆ©ç”¨Redisçš„seté›†åˆåˆ¤æ–­æ˜¯å¦ç‚¹èµè¿‡ï¼Œæœªç‚¹èµè¿‡åˆ™ç‚¹èµæ•°+1ï¼Œå·²ç‚¹èµè¿‡åˆ™ç‚¹èµæ•°-1</li>
<li>ä¿®æ”¹æ ¹æ®idæŸ¥è¯¢Blogçš„ä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
<li>ä¿®æ”¹åˆ†é¡µæŸ¥è¯¢Blogä¸šåŠ¡ï¼Œåˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦ç‚¹èµè¿‡ï¼Œèµ‹å€¼ç»™isLikeå­—æ®µ</li>
</ul>
<h3 id="6-3-ç‚¹èµæ’è¡Œæ¦œ"><a href="#6-3-ç‚¹èµæ’è¡Œæ¦œ" class="headerlink" title="6.3 ç‚¹èµæ’è¡Œæ¦œ"></a>6.3 ç‚¹èµæ’è¡Œæ¦œ</h3><p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œ</p>
<p>ä¹‹å‰çš„ç‚¹èµæ˜¯æ”¾åˆ°seté›†åˆï¼Œä½†æ˜¯seté›†åˆæ˜¯ä¸èƒ½æ’åºçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥é‡‡ç”¨ä¸€ä¸ªå¯ä»¥æ’åºçš„seté›†åˆï¼Œå°±æ˜¯å’±ä»¬çš„sortedSet</p>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>Set</th>
<th>SortedSet</th>
</tr>
</thead>
<tbody><tr>
<td>æ’åºæ–¹å¼</td>
<td>æŒ‰æ·»åŠ é¡ºåºæ’åº</td>
<td>æ— æ³•æ’åº</td>
<td>æ ¹æ®scoreå€¼æ’åº</td>
</tr>
<tr>
<td>å”¯ä¸€æ€§</td>
<td>ä¸å”¯ä¸€</td>
<td>å”¯ä¸€</td>
<td>å”¯ä¸€</td>
</tr>
<tr>
<td>æŸ¥æ‰¾æ–¹å¼</td>
<td>æŒ‰ç´¢å¼•æŸ¥æ‰¾æˆ–é¦–å°¾æŸ¥æ‰¾</td>
<td>æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
<td>æ ¹æ®å…ƒç´ æŸ¥æ‰¾</td>
</tr>
</tbody></table>
<h4 id="6-3-1-BlogServiceImpl"><a href="#6-3-1-BlogServiceImpl" class="headerlink" title="6.3.1 BlogServiceImpl"></a>6.3.1 BlogServiceImpl</h4><p>ç‚¹èµé€»è¾‘ä»£ç </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span> &#123;<br>     <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>     <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>     <span class="hljs-comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>     <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>     <span class="hljs-keyword">if</span> (score == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// 3.å¦‚æœæœªç‚¹èµï¼Œå¯ä»¥ç‚¹èµ</span><br>         <span class="hljs-comment">// 3.1.æ•°æ®åº“ç‚¹èµæ•° + 1</span><br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>         <span class="hljs-comment">// 3.2.ä¿å­˜ç”¨æˆ·åˆ°Redisçš„seté›†åˆ  zadd key value score</span><br>         <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>             stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br>         &#125;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-comment">// 4.å¦‚æœå·²ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ</span><br>         <span class="hljs-comment">// 4.1.æ•°æ®åº“ç‚¹èµæ•° -1</span><br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>         <span class="hljs-comment">// 4.2.æŠŠç”¨æˆ·ä»Redisçš„seté›†åˆç§»é™¤</span><br>         <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>             stringRedisTemplate.opsForZSet().remove(key, userId.toString());<br>         &#125;<br>     &#125;<br>     <span class="hljs-keyword">return</span> Result.ok();<br> &#125;<br><br><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLiked</span><span class="hljs-params">(Blog blog)</span> &#123;<br>     <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>     <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>     <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// ç”¨æˆ·æœªç™»å½•ï¼Œæ— éœ€æŸ¥è¯¢æ˜¯å¦ç‚¹èµ</span><br>         <span class="hljs-keyword">return</span>;<br>     &#125;<br>     <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> user.getId();<br>     <span class="hljs-comment">// 2.åˆ¤æ–­å½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blog:liked:&quot;</span> + blog.getId();<br>     <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>     blog.setIsLike(score != <span class="hljs-literal">null</span>);<br> &#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-3-2-ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨"><a href="#6-3-2-ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨" class="headerlink" title="6.3.2 ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨"></a>6.3.2 ç‚¹èµåˆ—è¡¨æŸ¥è¯¢åˆ—è¡¨</h4><p><strong>BlogController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br><br>    <span class="hljs-keyword">return</span> blogService.queryBlogLikes(id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>BlogService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ· zrange key 0 4</span><br>    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (top5 == <span class="hljs-literal">null</span> || top5.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 2.è§£æå‡ºå…¶ä¸­çš„ç”¨æˆ·id</span><br>    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    <span class="hljs-comment">// 3.æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢ç”¨æˆ· WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span><br>    List&lt;UserDTO&gt; userDTOS = userService.query()<br>            .in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list()<br>            .stream()<br>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>            .collect(Collectors.toList());<br>    <span class="hljs-comment">// 4.è¿”å›</span><br>    <span class="hljs-keyword">return</span> Result.ok(userDTOS);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-å¥½å‹å…³æ³¨"><a href="#7-å¥½å‹å…³æ³¨" class="headerlink" title="7. å¥½å‹å…³æ³¨"></a>7. å¥½å‹å…³æ³¨</h2><h3 id="7-1-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨"><a href="#7-1-å…³æ³¨å’Œå–æ¶ˆå…³æ³¨" class="headerlink" title="7.1 å…³æ³¨å’Œå–æ¶ˆå…³æ³¨"></a>7.1 å…³æ³¨å’Œå–æ¶ˆå…³æ³¨</h3><p>éœ€æ±‚ï¼šåŸºäºè¯¥è¡¨æ•°æ®ç»“æ„ï¼Œå®ç°ä¸¤ä¸ªæ¥å£ï¼š</p>
<ul>
<li>å…³æ³¨å’Œå–å…³æ¥å£</li>
<li>åˆ¤æ–­æ˜¯å¦å…³æ³¨çš„æ¥å£</li>
</ul>
<p>å…³æ³¨æ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥æ ‡ç¤º</p>
<h4 id="7-1-1-FollowController"><a href="#7-1-1-FollowController" class="headerlink" title="7.1.1 FollowController"></a>7.1.1 FollowController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å…³æ³¨</span><br><span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="hljs-meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;<br>    <span class="hljs-keyword">return</span> followService.follow(followUserId, isFollow);<br>&#125;<br><span class="hljs-comment">//å–æ¶ˆå…³æ³¨</span><br><span class="hljs-meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;<br>      <span class="hljs-keyword">return</span> followService.isFollow(followUserId);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-1-2-FollowService"><a href="#7-1-2-FollowService" class="headerlink" title="7.1.2 FollowService"></a>7.1.2 FollowService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å–æ¶ˆå…³æ³¨service</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(Long followUserId)</span> &#123;<br>        <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.æŸ¥è¯¢æ˜¯å¦å…³æ³¨ select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId).count();<br>        <span class="hljs-comment">// 3.åˆ¤æ–­</span><br>        <span class="hljs-keyword">return</span> Result.ok(count &gt; <span class="hljs-number">0</span>);<br>    &#125;<br><br> <span class="hljs-comment">//å…³æ³¨service</span><br> <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, Boolean isFollow)</span> &#123;<br>        <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>        <span class="hljs-comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span><br>        <span class="hljs-keyword">if</span> (isFollow) &#123;<br>            <span class="hljs-comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span><br>            <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>            follow.setUserId(userId);<br>            follow.setFollowUserId(followUserId);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span><br>            remove(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Follow&gt;()<br>                    .eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId));<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-2-å…±åŒå…³æ³¨"><a href="#7-2-å…±åŒå…³æ³¨" class="headerlink" title="7.2 å…±åŒå…³æ³¨"></a>7.2 å…±åŒå…³æ³¨</h3><p>æƒ³è¦å»çœ‹å…±åŒå…³æ³¨çš„å¥½å‹ï¼Œéœ€è¦é¦–å…ˆè¿›å…¥åˆ°è¿™ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ä¼šå‘èµ·ä¸¤ä¸ªè¯·æ±‚</p>
<ol>
<li>å»æŸ¥è¯¢ç”¨æˆ·çš„è¯¦æƒ…</li>
<li>å»æŸ¥è¯¢ç”¨æˆ·çš„ç¬”è®°</li>
</ol>
<p>éœ€æ±‚ï¼šåˆ©ç”¨Redisä¸­æ°å½“çš„æ•°æ®ç»“æ„ï¼Œå®ç°å…±åŒå…³æ³¨åŠŸèƒ½ã€‚åœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨å‘¢ã€‚</p>
<ul>
<li>å½“ç„¶æ˜¯ä½¿ç”¨æˆ‘ä»¬ä¹‹å‰å­¦ä¹ è¿‡çš„seté›†åˆå’¯ï¼Œ<strong>åœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„api</strong>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä¸¤äººçš„å…³æ³¨çš„äººåˆ†åˆ«æ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ï¼Œç„¶åå†é€šè¿‡apiå»æŸ¥çœ‹è¿™ä¸¤ä¸ªseté›†åˆä¸­çš„äº¤é›†æ•°æ®ã€‚</li>
</ul>
<p><strong>FollowServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, Boolean isFollow)</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>    <span class="hljs-comment">// 1.åˆ¤æ–­åˆ°åº•æ˜¯å…³æ³¨è¿˜æ˜¯å–å…³</span><br>    <span class="hljs-keyword">if</span> (isFollow) &#123;<br>        <span class="hljs-comment">// 2.å…³æ³¨ï¼Œæ–°å¢æ•°æ®</span><br>        <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>        follow.setUserId(userId);<br>        follow.setFollowUserId(followUserId);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idï¼Œæ”¾å…¥redisçš„seté›†åˆ sadd userId followerUserId</span><br>            stringRedisTemplate.opsForSet().add(key, followUserId.toString());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 3.å–å…³ï¼Œåˆ é™¤ delete from tb_follow where user_id = ? and follow_user_id = ?</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> remove(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Follow&gt;()<br>                .eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId));<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// æŠŠå…³æ³¨ç”¨æˆ·çš„idä»Redisé›†åˆä¸­ç§»é™¤</span><br>            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>FollowServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">followCommons</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–å½“å‰ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>    <span class="hljs-comment">// 2.æ±‚äº¤é›†</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + id;<br>    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);<br>    <span class="hljs-keyword">if</span> (intersect == <span class="hljs-literal">null</span> || intersect.isEmpty()) &#123;<br>        <span class="hljs-comment">// æ— äº¤é›†</span><br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 3.è§£æidé›†åˆ</span><br>    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-comment">// 4.æŸ¥è¯¢ç”¨æˆ·</span><br>    List&lt;UserDTO&gt; users = userService.listByIds(ids)<br>            .stream()<br>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>            .collect(Collectors.toList());<br>    <span class="hljs-keyword">return</span> Result.ok(users);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="7-3-å…±åŒæ¨é€-Feedæµå®ç°æ–¹æ¡ˆ"><a href="#7-3-å…±åŒæ¨é€-Feedæµå®ç°æ–¹æ¡ˆ" class="headerlink" title="7.3 å…±åŒæ¨é€-Feedæµå®ç°æ–¹æ¡ˆ"></a>7.3 å…±åŒæ¨é€-Feedæµå®ç°æ–¹æ¡ˆ</h3><p>å…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯</p>
<p><img src="/img/blogs/java/redis/2.7.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="7-3-1-Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼"><a href="#7-3-1-Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼" class="headerlink" title="7.3.1 Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼"></a>7.3.1 Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼</h4><p><strong>Timeline</strong>ï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</p>
<ul>
<li>ä¼˜ç‚¹ï¼šä¿¡æ¯å…¨é¢ï¼Œä¸ä¼šæœ‰ç¼ºå¤±ã€‚å¹¶ä¸”å®ç°ä¹Ÿç›¸å¯¹ç®€å•</li>
<li>ç¼ºç‚¹ï¼šä¿¡æ¯å™ªéŸ³è¾ƒå¤šï¼Œç”¨æˆ·ä¸ä¸€å®šæ„Ÿå…´è¶£ï¼Œå†…å®¹è·å–æ•ˆç‡ä½</li>
</ul>
<p><strong>æ™ºèƒ½æ’åº</strong>ï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·</p>
<ul>
<li>ä¼˜ç‚¹ï¼šæŠ•å–‚ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯ï¼Œç”¨æˆ·ç²˜åº¦å¾ˆé«˜ï¼Œå®¹æ˜“æ²‰è¿·</li>
<li>ç¼ºç‚¹ï¼šå¦‚æœç®—æ³•ä¸ç²¾å‡†ï¼Œå¯èƒ½èµ·åˆ°åä½œç”¨<br>æœ¬ä¾‹ä¸­çš„ä¸ªäººé¡µé¢ï¼Œæ˜¯åŸºäºå…³æ³¨çš„å¥½å‹æ¥åšFeedæµï¼Œå› æ­¤é‡‡ç”¨Timelineçš„æ¨¡å¼ã€‚è¯¥æ¨¡å¼çš„å®ç°æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š</li>
</ul>
<p>æˆ‘ä»¬æœ¬æ¬¡é’ˆå¯¹å¥½å‹çš„æ“ä½œï¼Œé‡‡ç”¨çš„å°±æ˜¯Timelineçš„æ–¹å¼ï¼Œåªéœ€è¦æ‹¿åˆ°æˆ‘ä»¬å…³æ³¨ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŒ‰ç…§æ—¶é—´æ’åºå³å¯</p>
<h4 id="7-3-2-Timelineçš„ä¸‰ç§æ¨¡å¼"><a href="#7-3-2-Timelineçš„ä¸‰ç§æ¨¡å¼" class="headerlink" title="7.3.2 Timelineçš„ä¸‰ç§æ¨¡å¼"></a>7.3.2 Timelineçš„ä¸‰ç§æ¨¡å¼</h4><ul>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ul>
<p><strong>æ‹‰æ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»æ‰©æ•£</p>
<p><img src="/img/blogs/java/redis/2.7.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>æ¨æ¨¡å¼</strong>ï¼šä¹Ÿå«åšå†™æ‰©æ•£ã€‚</p>
<p><img src="/img/blogs/java/redis/2.7.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>æ¨æ‹‰ç»“åˆæ¨¡å¼</strong>ï¼šä¹Ÿå«åšè¯»å†™æ··åˆï¼Œå…¼å…·æ¨å’Œæ‹‰ä¸¤ç§æ¨¡å¼çš„ä¼˜ç‚¹</p>
<p><img src="/img/blogs/java/redis/2.7.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ä¸‰ç§æ¨¡å¼å¯¹æ¯”</strong>ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>æ‹‰æ¨¡å¼</th>
<th>æ¨æ¨¡å¼</th>
<th>æ¨æ‹‰ç»“åˆ</th>
</tr>
</thead>
<tbody><tr>
<td>å†™æ¯”ä¾‹</td>
<td>ä½</td>
<td>é«˜</td>
<td>ä¸­</td>
</tr>
<tr>
<td>è¯»æ¯”ä¾‹</td>
<td>é«˜</td>
<td>ä½</td>
<td>ä¸­</td>
</tr>
<tr>
<td>ç”¨æˆ·è¯»å–å»¶è¿Ÿ</td>
<td>é«˜</td>
<td>ä½</td>
<td>ä½</td>
</tr>
<tr>
<td>å®ç°éš¾åº¦</td>
<td>å¤æ‚</td>
<td>ç®€å•</td>
<td>å¾ˆå¤æ‚</td>
</tr>
<tr>
<td>ä½¿ç”¨åœºæ™¯</td>
<td>å¾ˆå°‘ä½¿ç”¨</td>
<td>ç”¨æˆ·é‡å°‘ã€æ²¡æœ‰å¤§V</td>
<td>è¿‡åƒä¸‡çš„ç”¨æˆ·é‡ï¼Œæœ‰å¤§V</td>
</tr>
</tbody></table>
<h3 id="7-4-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±"><a href="#7-4-æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±" class="headerlink" title="7.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±"></a>7.4 æ¨é€åˆ°ç²‰ä¸æ”¶ä»¶ç®±</h3><p>éœ€æ±‚ï¼š</p>
<ul>
<li>ä¿®æ”¹æ–°å¢æ¢åº—ç¬”è®°çš„ä¸šåŠ¡ï¼Œåœ¨ä¿å­˜blogåˆ°æ•°æ®åº“çš„åŒæ—¶ï¼Œæ¨é€åˆ°ç²‰ä¸çš„æ”¶ä»¶ç®±</li>
<li>æ”¶ä»¶ç®±æ»¡è¶³å¯ä»¥æ ¹æ®æ—¶é—´æˆ³æ’åºï¼Œå¿…é¡»ç”¨Redisçš„æ•°æ®ç»“æ„å®ç°</li>
<li>æŸ¥è¯¢æ”¶ä»¶ç®±æ•°æ®æ—¶ï¼Œå¯ä»¥å®ç°åˆ†é¡µæŸ¥è¯¢</li>
</ul>
<p><strong>Feedæµçš„æ»šåŠ¨åˆ†é¡µ</strong></p>
<ul>
<li>Feedæµä¸­çš„æ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/2.7.5.png" srcset="/img/loading.gif" lazyload></p>
<p>æˆ‘ä»¬åœ¨ä¿å­˜å®Œæ¢åº—ç¬”è®°åï¼Œè·å¾—åˆ°å½“å‰ç¬”è®°çš„ç²‰ä¸ï¼Œç„¶åæŠŠæ•°æ®æ¨é€åˆ°ç²‰ä¸çš„redisä¸­å»ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(Blog blog)</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–ç™»å½•ç”¨æˆ·</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>    blog.setUserId(user.getId());<br>    <span class="hljs-comment">// 2.ä¿å­˜æ¢åº—ç¬”è®°</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(blog);<br>    <span class="hljs-keyword">if</span>(!isSuccess)&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;æ–°å¢ç¬”è®°å¤±è´¥!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.æŸ¥è¯¢ç¬”è®°ä½œè€…çš„æ‰€æœ‰ç²‰ä¸ select * from tb_follow where follow_user_id = ?</span><br>    List&lt;Follow&gt; follows = followService.query().eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, user.getId()).list();<br>    <span class="hljs-comment">// 4.æ¨é€ç¬”è®°idç»™æ‰€æœ‰ç²‰ä¸</span><br>    <span class="hljs-keyword">for</span> (Follow follow : follows) &#123;<br>        <span class="hljs-comment">// 4.1.è·å–ç²‰ä¸id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> follow.getUserId();<br>        <span class="hljs-comment">// 4.2.æ¨é€</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> FEED_KEY + userId;<br>        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());<br>    &#125;<br>    <span class="hljs-comment">// 5.è¿”å›id</span><br>    <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢"><a href="#7-5-å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="7.5 å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢"></a>7.5 å®ç°å…³æ³¨æ¨é€é¡µé¢çš„åˆ†é¡µæŸ¥è¯¢</h3><p>éœ€æ±‚ï¼šåœ¨ä¸ªäººä¸»é¡µçš„â€œå…³æ³¨â€å¡ç‰‡ä¸­ï¼ŒæŸ¥è¯¢å¹¶å±•ç¤ºæ¨é€çš„Blogä¿¡æ¯ï¼š</p>
<ol>
<li>æ¯æ¬¡æŸ¥è¯¢å®Œæˆåï¼Œæˆ‘ä»¬è¦åˆ†æå‡ºæŸ¥è¯¢å‡ºæ•°æ®çš„æœ€å°æ—¶é—´æˆ³ï¼Œè¿™ä¸ªå€¼ä¼šä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶</li>
<li>æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ä½œä¸ºåç§»é‡ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ï¼Œè·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®</li>
</ol>
<ul>
<li>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼š<strong>ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³</strong> å’Œ<strong>åç§»é‡</strong>è¿™ä¸¤ä¸ªå‚æ•°</li>
</ul>
<h4 id="7-5-1-å®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»"><a href="#7-5-1-å®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»" class="headerlink" title="7.5.1 å®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»"></a>7.5.1 å®šä¹‰å‡ºæ¥å…·ä½“çš„è¿”å›å€¼å®ä½“ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollResult</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;?&gt; list;<br>    <span class="hljs-keyword">private</span> Long minTime;<br>    <span class="hljs-keyword">private</span> Integer offset;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-5-2-BlogController"><a href="#7-5-2-BlogController" class="headerlink" title="7.5.2 BlogController"></a>7.5.2 BlogController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/follow&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="hljs-meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;<br>    <span class="hljs-keyword">return</span> blogService.queryBlogOfFollow(max, offset);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-5-3-BlogServiceImpl"><a href="#7-5-3-BlogServiceImpl" class="headerlink" title="7.5.3 BlogServiceImpl"></a>7.5.3 BlogServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(Long max, Integer offset)</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–å½“å‰ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.æŸ¥è¯¢æ”¶ä»¶ç®± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> FEED_KEY + userId;<br>    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()<br>        .reverseRangeByScoreWithScores(key, <span class="hljs-number">0</span>, max, offset, <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// 3.éç©ºåˆ¤æ–­</span><br>    <span class="hljs-keyword">if</span> (typedTuples == <span class="hljs-literal">null</span> || typedTuples.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br>    <span class="hljs-comment">// 4.è§£ææ•°æ®ï¼šblogIdã€minTimeï¼ˆæ—¶é—´æˆ³ï¼‰ã€offset</span><br>    List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(typedTuples.size());<br>    <span class="hljs-type">long</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 2</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class="hljs-comment">// 5 4 4 2 2</span><br>        <span class="hljs-comment">// 4.1.è·å–id</span><br>        ids.add(Long.valueOf(tuple.getValue()));<br>        <span class="hljs-comment">// 4.2.è·å–åˆ†æ•°(æ—¶é—´æˆ³ï¼‰</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> tuple.getScore().longValue();<br>        <span class="hljs-keyword">if</span>(time == minTime)&#123;<br>            os++;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            minTime = time;<br>            os = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>	os = minTime == max ? os : os + offset;<br>    <span class="hljs-comment">// 5.æ ¹æ®idæŸ¥è¯¢blog</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    List&lt;Blog&gt; blogs = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br><br>    <span class="hljs-keyword">for</span> (Blog blog : blogs) &#123;<br>        <span class="hljs-comment">// 5.1.æŸ¥è¯¢blogæœ‰å…³çš„ç”¨æˆ·</span><br>        queryBlogUser(blog);<br>        <span class="hljs-comment">// 5.2.æŸ¥è¯¢blogæ˜¯å¦è¢«ç‚¹èµ</span><br>        isBlogLiked(blog);<br>    &#125;<br><br>    <span class="hljs-comment">// 6.å°è£…å¹¶è¿”å›</span><br>    <span class="hljs-type">ScrollResult</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScrollResult</span>();<br>    r.setList(blogs);<br>    r.setOffset(os);<br>    r.setMinTime(minTime);<br><br>    <span class="hljs-keyword">return</span> Result.ok(r);<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="8-é™„è¿‘å•†æˆ·"><a href="#8-é™„è¿‘å•†æˆ·" class="headerlink" title="8. é™„è¿‘å•†æˆ·"></a>8. é™„è¿‘å•†æˆ·</h2><h3 id="8-1-GEOæ•°æ®ç»“æ„"><a href="#8-1-GEOæ•°æ®ç»“æ„" class="headerlink" title="8.1 GEOæ•°æ®ç»“æ„"></a>8.1 GEOæ•°æ®ç»“æ„</h3><p>GEOå°±æ˜¯Geolocationçš„ç®€å†™å½¢å¼ï¼Œä»£è¡¨åœ°ç†åæ ‡ã€‚Redisåœ¨3.2ç‰ˆæœ¬ä¸­åŠ å…¥äº†å¯¹GEOçš„æ”¯æŒï¼Œå…è®¸å­˜å‚¨åœ°ç†åæ ‡ä¿¡æ¯ï¼Œå¸®åŠ©æˆ‘ä»¬æ ¹æ®ç»çº¬åº¦æ¥æ£€ç´¢æ•°æ®ã€‚å¸¸è§çš„å‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>GEOADDï¼šæ·»åŠ ä¸€ä¸ªåœ°ç†ç©ºé—´ä¿¡æ¯ï¼ŒåŒ…å«ï¼šç»åº¦ï¼ˆlongitudeï¼‰ã€çº¬åº¦ï¼ˆlatitudeï¼‰ã€å€¼ï¼ˆmemberï¼‰</li>
<li>GEODISTï¼šè®¡ç®—æŒ‡å®šçš„ä¸¤ä¸ªç‚¹ä¹‹é—´çš„è·ç¦»å¹¶è¿”å›</li>
<li>GEOHASHï¼šå°†æŒ‡å®šmemberçš„åæ ‡è½¬ä¸ºhashå­—ç¬¦ä¸²å½¢å¼å¹¶è¿”å›</li>
<li>GEOPOSï¼šè¿”å›æŒ‡å®šmemberçš„åæ ‡</li>
<li>GEORADIUSï¼šæŒ‡å®šåœ†å¿ƒã€åŠå¾„ï¼Œæ‰¾åˆ°è¯¥åœ†å†…åŒ…å«çš„æ‰€æœ‰memberï¼Œå¹¶æŒ‰ç…§ä¸åœ†å¿ƒä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚6.ä»¥åå·²åºŸå¼ƒ</li>
<li>GEOSEARCHï¼šåœ¨æŒ‡å®šèŒƒå›´å†…æœç´¢memberï¼Œå¹¶æŒ‰ç…§ä¸æŒ‡å®šç‚¹ä¹‹é—´çš„è·ç¦»æ’åºåè¿”å›ã€‚èŒƒå›´å¯ä»¥æ˜¯åœ†å½¢æˆ–çŸ©å½¢ã€‚6.2.æ–°åŠŸèƒ½</li>
<li>GEOSEARCHSTOREï¼šä¸GEOSEARCHåŠŸèƒ½ä¸€è‡´ï¼Œä¸è¿‡å¯ä»¥æŠŠç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªæŒ‡å®šçš„keyã€‚ 6.2.æ–°åŠŸèƒ½</li>
</ul>
<h3 id="8-2-é™„è¿‘å•†æˆ·æœç´¢"><a href="#8-2-é™„è¿‘å•†æˆ·æœç´¢" class="headerlink" title="8.2 é™„è¿‘å•†æˆ·æœç´¢"></a>8.2 é™„è¿‘å•†æˆ·æœç´¢</h3><h4 id="8-2-1-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"><a href="#8-2-1-å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO" class="headerlink" title="8.2.1 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO"></a>8.2.1 å¯¼å…¥åº—é“ºæ•°æ®åˆ°GEO</h4><ul>
<li>æˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ï¼šå°†æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®å¯¼å…¥åˆ°redisä¸­å»ï¼Œredisä¸­çš„GEOï¼ŒGEOåœ¨redisä¸­å°±ä¸€ä¸ªmenberå’Œä¸€ä¸ªç»çº¬åº¦ï¼Œæˆ‘ä»¬<strong>æŠŠxå’Œyè½´ä¼ å…¥åˆ°redisåšçš„ç»çº¬åº¦ä½ç½®</strong>å»ï¼Œä½†æˆ‘ä»¬ä¸èƒ½æŠŠæ‰€æœ‰çš„æ•°æ®éƒ½æ”¾å…¥åˆ°menberä¸­å»ï¼Œæ¯•ç«Ÿä½œä¸ºredisæ˜¯ä¸€ä¸ªå†…å­˜çº§æ•°æ®åº“ï¼Œå¦‚æœå­˜æµ·é‡æ•°æ®ï¼Œredisè¿˜æ˜¯åŠ›ä¸ä»å¿ƒï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹<strong>å­˜å‚¨ä»–çš„id</strong>å³å¯ã€‚</li>
<li>ä½†æ˜¯è¿™ä¸ªæ—¶å€™è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯åœ¨redisä¸­å¹¶æ²¡æœ‰å­˜å‚¨typeï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•æ ¹æ®typeæ¥å¯¹æ•°æ®è¿›è¡Œç­›é€‰ï¼Œæ‰€ä»¥<strong>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§å•†æˆ·ç±»å‹åšåˆ†ç»„ï¼Œç±»å‹ç›¸åŒçš„å•†æˆ·ä½œä¸ºåŒä¸€ç»„</strong>ï¼Œä»¥typeIdä¸ºkeyå­˜å…¥åŒä¸€ä¸ªGEOé›†åˆä¸­å³å¯</li>
</ul>
<p><strong>HmDianPingApplicationTests</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">loadShopData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢åº—é“ºä¿¡æ¯</span><br>    List&lt;Shop&gt; list = shopService.list();<br>    <span class="hljs-comment">// 2.æŠŠåº—é“ºåˆ†ç»„ï¼ŒæŒ‰ç…§typeIdåˆ†ç»„ï¼ŒtypeIdä¸€è‡´çš„æ”¾åˆ°ä¸€ä¸ªé›†åˆ</span><br>    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));<br>    <span class="hljs-comment">// 3.åˆ†æ‰¹å®Œæˆå†™å…¥Redis</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;<br>        <span class="hljs-comment">// 3.1.è·å–ç±»å‹id</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">typeId</span> <span class="hljs-operator">=</span> entry.getKey();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> SHOP_GEO_KEY + typeId;<br>        <span class="hljs-comment">// 3.2.è·å–åŒç±»å‹çš„åº—é“ºçš„é›†åˆ</span><br>        List&lt;Shop&gt; value = entry.getValue();<br>        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(value.size());<br>        <span class="hljs-comment">// 3.3.å†™å…¥redis GEOADD key ç»åº¦ çº¬åº¦ member</span><br>        <span class="hljs-keyword">for</span> (Shop shop : value) &#123;<br>            <span class="hljs-comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span><br>            locations.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(<br>                    shop.getId().toString(),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(shop.getX(), shop.getY())<br>            ));<br>        &#125;<br>        stringRedisTemplate.opsForGeo().add(key, locations);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="8-2-2-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½"><a href="#8-2-2-å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½" class="headerlink" title="8.2.2 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½"></a>8.2.2 å®ç°é™„è¿‘å•†æˆ·åŠŸèƒ½</h4><p><strong>ShopController</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/type&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span><br><span class="hljs-params">)</span> &#123;<br>   <span class="hljs-keyword">return</span> shopService.queryShopByType(typeId, current, x, y);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ShopServiceImpl</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;<br>        <span class="hljs-comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ ¹æ®åæ ‡æŸ¥è¯¢</span><br>        <span class="hljs-keyword">if</span> (x == <span class="hljs-literal">null</span> || y == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// ä¸éœ€è¦åæ ‡æŸ¥è¯¢ï¼ŒæŒ‰æ•°æ®åº“æŸ¥è¯¢</span><br>            Page&lt;Shop&gt; page = query()<br>                    .eq(<span class="hljs-string">&quot;type_id&quot;</span>, typeId)<br>                    .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<br>            <span class="hljs-comment">// è¿”å›æ•°æ®</span><br>            <span class="hljs-keyword">return</span> Result.ok(page.getRecords());<br>        &#125;<br><br>        <span class="hljs-comment">// 2.è®¡ç®—åˆ†é¡µå‚æ•°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (current - <span class="hljs-number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;<br><br>        <span class="hljs-comment">// 3.æŸ¥è¯¢redisã€æŒ‰ç…§è·ç¦»æ’åºã€åˆ†é¡µã€‚ç»“æœï¼šshopIdã€distance</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> SHOP_GEO_KEY + typeId;<br>        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="hljs-comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span><br>                .search(<br>                        key,<br>                        GeoReference.fromCoordinate(x, y),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Distance</span>(<span class="hljs-number">5000</span>),<br>                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)<br>                );<br>        <span class="hljs-comment">// 4.è§£æå‡ºid</span><br>        <span class="hljs-keyword">if</span> (results == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>        &#125;<br>        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();<br>        <span class="hljs-keyword">if</span> (list.size() &lt;= from) &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰ä¸‹ä¸€é¡µäº†ï¼Œç»“æŸ</span><br>            <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>        &#125;<br>        <span class="hljs-comment">// 4.1.æˆªå– from ~ endçš„éƒ¨åˆ†</span><br>        List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list.size());<br>        Map&lt;String, Distance&gt; distanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(list.size());<br>        list.stream().skip(from).forEach(result -&gt; &#123;<br>            <span class="hljs-comment">// 4.2.è·å–åº—é“ºid</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">shopIdStr</span> <span class="hljs-operator">=</span> result.getContent().getName();<br>            ids.add(Long.valueOf(shopIdStr));<br>            <span class="hljs-comment">// 4.3.è·å–è·ç¦»</span><br>            <span class="hljs-type">Distance</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> result.getDistance();<br>            distanceMap.put(shopIdStr, distance);<br>        &#125;);<br>        <span class="hljs-comment">// 5.æ ¹æ®idæŸ¥è¯¢Shop</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>        List&lt;Shop&gt; shops = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>        <span class="hljs-keyword">for</span> (Shop shop : shops) &#123;<br>            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());<br>        &#125;<br>        <span class="hljs-comment">// 6.è¿”å›</span><br>        <span class="hljs-keyword">return</span> Result.ok(shops);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="9-ç”¨æˆ·ç­¾åˆ°"><a href="#9-ç”¨æˆ·ç­¾åˆ°" class="headerlink" title="9. ç”¨æˆ·ç­¾åˆ°"></a>9. ç”¨æˆ·ç­¾åˆ°</h2><h3 id="9-1-BitMapç”¨æ³•"><a href="#9-1-BitMapç”¨æ³•" class="headerlink" title="9.1 BitMapç”¨æ³•"></a>9.1 BitMapç”¨æ³•</h3><p>æˆ‘ä»¬æŒ‰æœˆæ¥ç»Ÿè®¡ç”¨æˆ·ç­¾åˆ°ä¿¡æ¯ï¼Œç­¾åˆ°è®°å½•ä¸º1ï¼Œæœªç­¾åˆ°åˆ™è®°å½•ä¸º0</p>
<p><img src="/img/blogs/java/redis/2.9.1.png" srcset="/img/loading.gif" lazyload></p>
<p>æŠŠ<strong>æ¯ä¸€ä¸ªbitä½å¯¹åº”å½“æœˆçš„æ¯ä¸€å¤©</strong>ï¼Œå½¢æˆäº†æ˜ å°„å…³ç³»ã€‚ç”¨0å’Œ1æ ‡ç¤ºä¸šåŠ¡çŠ¶æ€ï¼Œè¿™ç§æ€è·¯å°±ç§°ä¸ºä½å›¾ï¼ˆBitMapï¼‰ã€‚è¿™æ ·æˆ‘ä»¬å°±ç”¨æå°çš„ç©ºé—´ï¼Œæ¥å®ç°äº†å¤§é‡æ•°æ®çš„è¡¨ç¤º</p>
<p>BitMapçš„æ“ä½œå‘½ä»¤æœ‰ï¼š</p>
<ul>
<li>SETBITï¼šå‘æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰å­˜å…¥ä¸€ä¸ª0æˆ–1</li>
<li>GETBIT ï¼šè·å–æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„bitå€¼</li>
<li>BITCOUNT ï¼šç»Ÿè®¡BitMapä¸­å€¼ä¸º1çš„bitä½çš„æ•°é‡</li>
<li>BITFIELD ï¼šæ“ä½œï¼ˆæŸ¥è¯¢ã€ä¿®æ”¹ã€è‡ªå¢ï¼‰BitMapä¸­bitæ•°ç»„ä¸­çš„æŒ‡å®šä½ç½®ï¼ˆoffsetï¼‰çš„å€¼</li>
<li>BITFIELD_RO ï¼šè·å–BitMapä¸­bitæ•°ç»„ï¼Œå¹¶ä»¥åè¿›åˆ¶å½¢å¼è¿”å›</li>
<li>BITOP ï¼šå°†å¤šä¸ªBitMapçš„ç»“æœåšä½è¿ç®—ï¼ˆä¸ ã€æˆ–ã€å¼‚æˆ–ï¼‰</li>
<li>BITPOS ï¼šæŸ¥æ‰¾bitæ•°ç»„ä¸­æŒ‡å®šèŒƒå›´å†…ç¬¬ä¸€ä¸ª0æˆ–1å‡ºç°çš„ä½ç½®</li>
</ul>
<h3 id="9-2-å®ç°ç­¾åˆ°åŠŸèƒ½"><a href="#9-2-å®ç°ç­¾åˆ°åŠŸèƒ½" class="headerlink" title="9.2 å®ç°ç­¾åˆ°åŠŸèƒ½"></a>9.2 å®ç°ç­¾åˆ°åŠŸèƒ½</h3><p>éœ€æ±‚ï¼šå®ç°ç­¾åˆ°æ¥å£ï¼Œå°†å½“å‰ç”¨æˆ·å½“å¤©ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ°Redisä¸­</p>
<h4 id="9-2-1-UserController"><a href="#9-2-1-UserController" class="headerlink" title="9.2.1 UserController"></a>9.2.1 UserController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/sign&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span>&#123;<br>   <span class="hljs-keyword">return</span> userService.sign();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="9-2-2-UserServiceImpl"><a href="#9-2-2-UserServiceImpl" class="headerlink" title="9.2.2 UserServiceImpl"></a>9.2.2 UserServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.è·å–æ—¥æœŸ</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-comment">// 3.æ‹¼æ¥key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> USER_SIGN_KEY + userId + keySuffix;<br>    <span class="hljs-comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 5.å†™å…¥Redis SETBIT key offset 1</span><br>    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="9-3-ç­¾åˆ°ç»Ÿè®¡"><a href="#9-3-ç­¾åˆ°ç»Ÿè®¡" class="headerlink" title="9.3 ç­¾åˆ°ç»Ÿè®¡"></a>9.3 ç­¾åˆ°ç»Ÿè®¡</h3><p>éœ€æ±‚ï¼šå®ç°ä¸‹é¢æ¥å£ï¼Œç»Ÿè®¡å½“å‰ç”¨æˆ·æˆªæ­¢å½“å‰æ—¶é—´åœ¨æœ¬æœˆçš„è¿ç»­ç­¾åˆ°å¤©æ•°</p>
<ul>
<li>**é—®é¢˜1ï¼š**ä»€ä¹ˆå«åšè¿ç»­ç­¾åˆ°å¤©æ•°ï¼Ÿ<ul>
<li>ä»æœ€åä¸€æ¬¡ç­¾åˆ°å¼€å§‹å‘å‰ç»Ÿè®¡ï¼Œç›´åˆ°é‡åˆ°ç¬¬ä¸€æ¬¡æœªç­¾åˆ°ä¸ºæ­¢ï¼Œè®¡ç®—æ€»çš„ç­¾åˆ°æ¬¡æ•°ï¼Œå°±æ˜¯è¿ç»­ç­¾åˆ°å¤©æ•°ã€‚</li>
</ul>
</li>
<li>**é—®é¢˜2ï¼š**å¦‚ä½•å¾—åˆ°æœ¬æœˆåˆ°ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰ç­¾åˆ°æ•°æ®ï¼Ÿ<ul>
<li>å‡è®¾ä»Šå¤©æ˜¯10å·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä»å½“å‰æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œè·å¾—åˆ°å½“å‰è¿™ä¸€å¤©çš„ä½æ•°ï¼Œæ˜¯10å·ï¼Œé‚£ä¹ˆå°±æ˜¯10ä½ï¼Œå»æ‹¿è¿™æ®µæ—¶é—´çš„æ•°æ®ï¼Œå°±èƒ½æ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®äº†ï¼Œé‚£ä¹ˆè¿™10å¤©é‡Œè¾¹ç­¾åˆ°äº†å¤šå°‘æ¬¡å‘¢ï¼Ÿç»Ÿè®¡æœ‰å¤šå°‘ä¸ª1å³å¯ã€‚</li>
</ul>
</li>
<li><strong>é—®é¢˜3ï¼šå¦‚ä½•ä»åå‘å‰éå†æ¯ä¸ªbitä½ï¼Ÿ</strong><ul>
<li>æˆ‘ä»¬åªéœ€è¦è®©å¾—åˆ°çš„10è¿›åˆ¶æ•°å­—å’Œ1åšä¸è¿ç®—å°±å¯ä»¥äº†ï¼Œå› ä¸º1åªæœ‰é‡è§1 æ‰æ˜¯1ï¼Œå…¶ä»–æ•°å­—éƒ½æ˜¯0</li>
<li>æˆ‘ä»¬æŠŠç­¾åˆ°ç»“æœå’Œ1è¿›è¡Œä¸æ“ä½œï¼Œæ¯ä¸ä¸€æ¬¡ï¼Œå°±æŠŠç­¾åˆ°ç»“æœå‘å³ç§»åŠ¨ä¸€ä½ï¼Œä¾æ¬¡å†…æ¨ï¼Œæˆ‘ä»¬å°±èƒ½å®Œæˆé€ä¸ªéå†çš„æ•ˆæœäº†ã€‚</li>
</ul>
</li>
</ul>
<h4 id="9-3-1-UserController"><a href="#9-3-1-UserController" class="headerlink" title="9.3.1 UserController"></a>9.3.1 UserController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/sign/count&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> userService.signCount();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="9-3-2-UserServiceImpl"><a href="#9-3-2-UserServiceImpl" class="headerlink" title="9.3.2 UserServiceImpl"></a>9.3.2 UserServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.è·å–å½“å‰ç™»å½•ç”¨æˆ·</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.è·å–æ—¥æœŸ</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-comment">// 3.æ‹¼æ¥key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> USER_SIGN_KEY + userId + keySuffix;<br>    <span class="hljs-comment">// 4.è·å–ä»Šå¤©æ˜¯æœ¬æœˆçš„ç¬¬å‡ å¤©</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 5.è·å–æœ¬æœˆæˆªæ­¢ä»Šå¤©ä¸ºæ­¢çš„æ‰€æœ‰çš„ç­¾åˆ°è®°å½•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªåè¿›åˆ¶çš„æ•°å­— BITFIELD sign:5:202203 GET u14 0</span><br>    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(<br>            key,<br>            BitFieldSubCommands.create()<br>                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="hljs-number">0</span>)<br>    );<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.isEmpty()) &#123;<br>        <span class="hljs-comment">// æ²¡æœ‰ä»»ä½•ç­¾åˆ°ç»“æœ</span><br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">// 6.å¾ªç¯éå†</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// 6.1.è®©è¿™ä¸ªæ•°å­—ä¸1åšä¸è¿ç®—ï¼Œå¾—åˆ°æ•°å­—çš„æœ€åä¸€ä¸ªbitä½  // åˆ¤æ–­è¿™ä¸ªbitä½æ˜¯å¦ä¸º0</span><br>        <span class="hljs-keyword">if</span> ((num &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// å¦‚æœä¸º0ï¼Œè¯´æ˜æœªç­¾åˆ°ï¼Œç»“æŸ</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// å¦‚æœä¸ä¸º0ï¼Œè¯´æ˜å·²ç­¾åˆ°ï¼Œè®¡æ•°å™¨+1</span><br>            count++;<br>        &#125;<br>        <span class="hljs-comment">// æŠŠæ•°å­—å³ç§»ä¸€ä½ï¼ŒæŠ›å¼ƒæœ€åä¸€ä¸ªbitä½ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªbitä½</span><br>        num &gt;&gt;&gt;= <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(count);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="10-UVç»Ÿè®¡-HyperLogLog"><a href="#10-UVç»Ÿè®¡-HyperLogLog" class="headerlink" title="10. UVç»Ÿè®¡-HyperLogLog"></a>10. UVç»Ÿè®¡-HyperLogLog</h2><p>é¦–å…ˆæˆ‘ä»¬ææ‡‚ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>UVï¼šå…¨ç§°Unique Visitorï¼Œä¹Ÿå«ç‹¬ç«‹è®¿å®¢é‡ï¼Œæ˜¯æŒ‡é€šè¿‡äº’è”ç½‘è®¿é—®ã€æµè§ˆè¿™ä¸ªç½‘é¡µçš„è‡ªç„¶äººã€‚1å¤©å†…åŒä¸€ä¸ªç”¨æˆ·å¤šæ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œåªè®°å½•1æ¬¡ã€‚</li>
<li>PVï¼šå…¨ç§°Page Viewï¼Œä¹Ÿå«é¡µé¢è®¿é—®é‡æˆ–ç‚¹å‡»é‡ï¼Œç”¨æˆ·æ¯è®¿é—®ç½‘ç«™çš„ä¸€ä¸ªé¡µé¢ï¼Œè®°å½•1æ¬¡PVï¼Œç”¨æˆ·å¤šæ¬¡æ‰“å¼€é¡µé¢ï¼Œåˆ™è®°å½•å¤šæ¬¡PVã€‚å¾€å¾€ç”¨æ¥è¡¡é‡ç½‘ç«™çš„æµé‡ã€‚</li>
</ul>
<ul>
<li>é€šå¸¸æ¥è¯´UVä¼šæ¯”PVå¤§å¾ˆå¤šï¼Œæ‰€ä»¥è¡¡é‡åŒä¸€ä¸ªç½‘ç«™çš„è®¿é—®é‡ï¼Œæˆ‘ä»¬éœ€è¦ç»¼åˆè€ƒè™‘å¾ˆå¤šå› ç´ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæ˜¯å•çº¯çš„æŠŠè¿™ä¸¤ä¸ªå€¼ä½œä¸ºä¸€ä¸ªå‚è€ƒå€¼</li>
<li>UVç»Ÿè®¡åœ¨æœåŠ¡ç«¯åšä¼šæ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºè¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦å·²ç»ç»Ÿè®¡è¿‡äº†ï¼Œéœ€è¦å°†ç»Ÿè®¡è¿‡çš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜ã€‚ä½†æ˜¯å¦‚æœæ¯ä¸ªè®¿é—®çš„ç”¨æˆ·éƒ½ä¿å­˜åˆ°Redisä¸­ï¼Œæ•°æ®é‡ä¼šéå¸¸ææ€–ï¼Œé‚£æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</li>
</ul>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h4><ul>
<li>Hyperloglog(HLL)æ˜¯ä»Loglogç®—æ³•æ´¾ç”Ÿçš„æ¦‚ç‡ç®—æ³•ï¼Œç”¨äºç¡®å®šéå¸¸å¤§çš„é›†åˆçš„åŸºæ•°ï¼Œè€Œä¸éœ€è¦å­˜å‚¨å…¶æ‰€æœ‰å€¼ã€‚</li>
<li>Redisä¸­çš„HLLæ˜¯åŸºäºstringç»“æ„å®ç°çš„ï¼Œå•ä¸ªHLLçš„å†…å­˜<strong>æ°¸è¿œå°äº16kb</strong>ï¼Œ<strong>å†…å­˜å ç”¨ä½</strong>çš„ä»¤äººå‘æŒ‡ï¼ä½œä¸ºä»£ä»·ï¼Œå…¶æµ‹é‡ç»“æœæ˜¯æ¦‚ç‡æ€§çš„ï¼Œ<strong>æœ‰å°äº0.81ï¼…çš„è¯¯å·®</strong>ã€‚ä¸è¿‡å¯¹äºUVç»Ÿè®¡æ¥è¯´ï¼Œè¿™å®Œå…¨å¯ä»¥å¿½ç•¥ã€‚</li>
</ul>
<h1 id="ä¸‰-Redisé«˜çº§ç¯‡"><a href="#ä¸‰-Redisé«˜çº§ç¯‡" class="headerlink" title="ä¸‰. Redisé«˜çº§ç¯‡"></a>ä¸‰. Redisé«˜çº§ç¯‡</h1><h2 id="1-åˆ†å¸ƒå¼ç¼“å­˜"><a href="#1-åˆ†å¸ƒå¼ç¼“å­˜" class="headerlink" title="1. åˆ†å¸ƒå¼ç¼“å­˜"></a>1. åˆ†å¸ƒå¼ç¼“å­˜</h2><h3 id="1-1-å•ç‚¹Redisçš„é—®é¢˜"><a href="#1-1-å•ç‚¹Redisçš„é—®é¢˜" class="headerlink" title="1.1 å•ç‚¹Redisçš„é—®é¢˜"></a>1.1 å•ç‚¹Redisçš„é—®é¢˜</h3><ul>
<li><p>æ•°æ®ä¸¢å¤±é—®é¢˜</p>
<ul>
<li>Redisæ˜¯å†…å­˜å­˜å‚¨ï¼ŒæœåŠ¡é‡å¯å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</li>
<li>è§£å†³æ–¹æ¡ˆï¼šå®ç°Redisæ•°æ®æŒä¹…åŒ–</li>
</ul>
</li>
<li><p>å¹¶å‘èƒ½åŠ›é—®é¢˜</p>
<ul>
<li>å•èŠ‚ç‚¹Rediså¹¶å‘èƒ½åŠ›è™½ç„¶ä¸é”™ï¼Œä½†ä¹Ÿæ— æ³•æ»¡è¶³å¦‚618è¿™æ ·çš„é«˜å¹¶å‘åœºæ™¯</li>
<li>è§£å†³æ–¹æ¡ˆï¼šæ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»</li>
</ul>
</li>
<li><p>æ•…éšœæ¢å¤é—®é¢˜</p>
<ul>
<li>å¦‚æœRediså®•æœºï¼Œåˆ™æœåŠ¡ä¸å¯ç”¨ï¼Œéœ€è¦ä¸€ç§è‡ªåŠ¨çš„æ•…éšœæ¢å¤æ‰‹æ®µ</li>
<li>è§£å†³æ–¹æ¡ˆï¼šåˆ©ç”¨Rediså“¨å…µï¼Œå®ç°å¥åº·æ£€æµ‹å’Œè‡ªåŠ¨æ¢å¤</li>
</ul>
</li>
<li><p>å­˜å‚¨èƒ½åŠ›é—®é¢˜</p>
<ul>
<li>RedisåŸºäºå†…å­˜ï¼Œå•èŠ‚ç‚¹èƒ½å­˜å‚¨çš„æ•°æ®é‡éš¾ä»¥æ»¡è¶³æµ·é‡æ•°æ®éœ€æ±‚</li>
<li>è§£å†³æ–¹æ¡ˆï¼šæ­å»ºåˆ†ç‰‡é›†ç¾¤ï¼Œåˆ©ç”¨æ’æ§½æœºåˆ¶å®ç°åŠ¨æ€æ‰©å®¹</li>
</ul>
</li>
</ul>
<h3 id="1-2-RedisæŒä¹…åŒ–"><a href="#1-2-RedisæŒä¹…åŒ–" class="headerlink" title="1.2 RedisæŒä¹…åŒ–"></a>1.2 RedisæŒä¹…åŒ–</h3><p>Redisæœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹æ¡ˆï¼š</p>
<ul>
<li>RDBæŒä¹…åŒ–</li>
<li>AOFæŒä¹…åŒ–</li>
</ul>
<h4 id="1-2-1-RDBæŒä¹…åŒ–"><a href="#1-2-1-RDBæŒä¹…åŒ–" class="headerlink" title="1.2.1 RDBæŒä¹…åŒ–"></a>1.2.1 RDBæŒä¹…åŒ–</h4><p>RDBå…¨ç§°Redis Database Backup fileï¼ˆRedisæ•°æ®å¤‡ä»½æ–‡ä»¶ï¼‰ï¼Œä¹Ÿè¢«å«åšRedisæ•°æ®å¿«ç…§ã€‚ç®€å•æ¥è¯´å°±æ˜¯æŠŠå†…å­˜ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½è®°å½•åˆ°ç£ç›˜ä¸­ã€‚å½“Rediså®ä¾‹æ•…éšœé‡å¯åï¼Œä»ç£ç›˜è¯»å–å¿«ç…§æ–‡ä»¶ï¼Œæ¢å¤æ•°æ®ã€‚å¿«ç…§æ–‡ä»¶ç§°ä¸ºRDBæ–‡ä»¶ï¼Œé»˜è®¤æ˜¯ä¿å­˜åœ¨å½“å‰è¿è¡Œç›®å½•ã€‚</p>
<h5 id="1-2-1-1-RDBæŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œï¼š"><a href="#1-2-1-1-RDBæŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œï¼š" class="headerlink" title="1.2.1.1 RDBæŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œï¼š"></a>1.2.1.1 RDBæŒä¹…åŒ–åœ¨å››ç§æƒ…å†µä¸‹ä¼šæ‰§è¡Œï¼š</h5><ul>
<li>æ‰§è¡Œsaveå‘½ä»¤</li>
<li>æ‰§è¡Œbgsaveå‘½ä»¤</li>
<li><strong>Redisåœæœºæ—¶</strong></li>
<li>è§¦å‘RDBæ¡ä»¶æ—¶</li>
</ul>
<h5 id="1-2-1-2-è§¦å‘RDBæ¡ä»¶"><a href="#1-2-1-2-è§¦å‘RDBæ¡ä»¶" class="headerlink" title="1.2.1.2 è§¦å‘RDBæ¡ä»¶"></a>1.2.1.2 è§¦å‘RDBæ¡ä»¶</h5><ul>
<li>Rediså†…éƒ¨æœ‰è§¦å‘RDBçš„æœºåˆ¶ï¼Œå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­æ‰¾åˆ°ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 900ç§’å†…ï¼Œå¦‚æœè‡³å°‘æœ‰1ä¸ªkeyè¢«ä¿®æ”¹ï¼Œåˆ™æ‰§è¡Œbgsave ï¼Œ å¦‚æœæ˜¯save &quot;&quot; åˆ™è¡¨ç¤ºç¦ç”¨RDB</span><br><span class="hljs-attr">save</span> <span class="hljs-string">900 1  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">300 10  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">60 10000 </span><br></code></pre></td></tr></table></figure>

<ul>
<li>RDBçš„å…¶å®ƒé…ç½®ä¹Ÿå¯ä»¥åœ¨redis.confæ–‡ä»¶ä¸­è®¾ç½®ï¼š</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># æ˜¯å¦å‹ç¼© ,å»ºè®®ä¸å¼€å¯ï¼Œå‹ç¼©ä¹Ÿä¼šæ¶ˆè€—cpuï¼Œç£ç›˜çš„è¯ä¸å€¼é’±</span><br><span class="hljs-attr">rdbcompression</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># RDBæ–‡ä»¶åç§°</span><br><span class="hljs-attr">dbfilename</span> <span class="hljs-string">dump.rdb  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># æ–‡ä»¶ä¿å­˜çš„è·¯å¾„ç›®å½•</span><br><span class="hljs-attr">dir</span> <span class="hljs-string">./ </span><br></code></pre></td></tr></table></figure>

<h4 id="1-2-2-RDBåŸç†"><a href="#1-2-2-RDBåŸç†" class="headerlink" title="1.2.2 RDBåŸç†"></a>1.2.2 RDBåŸç†</h4><p>bgsaveå¼€å§‹æ—¶ä¼šforkä¸»è¿›ç¨‹å¾—åˆ°å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹å…±äº«ä¸»è¿›ç¨‹çš„å†…å­˜æ•°æ®ã€‚å®Œæˆforkåè¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥ RDB æ–‡ä»¶ã€‚</p>
<p>forké‡‡ç”¨çš„æ˜¯copy-on-writeæŠ€æœ¯ï¼š</p>
<ul>
<li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œè¯»æ“ä½œæ—¶ï¼Œè®¿é—®å…±äº«å†…å­˜ï¼›</li>
<li>å½“ä¸»è¿›ç¨‹æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œåˆ™ä¼šæ‹·è´ä¸€ä»½æ•°æ®ï¼Œæ‰§è¡Œå†™æ“ä½œã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/3.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="1-2-3-RDBå°ç»“"><a href="#1-2-3-RDBå°ç»“" class="headerlink" title="1.2.3 RDBå°ç»“"></a>1.2.3 RDBå°ç»“</h4><p>RDBæ–¹å¼bgsaveçš„åŸºæœ¬æµç¨‹ï¼Ÿ</p>
<ul>
<li>forkä¸»è¿›ç¨‹å¾—åˆ°ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå…±äº«å†…å­˜ç©ºé—´</li>
<li>å­è¿›ç¨‹è¯»å–å†…å­˜æ•°æ®å¹¶å†™å…¥æ–°çš„RDBæ–‡ä»¶</li>
<li>ç”¨æ–°RDBæ–‡ä»¶æ›¿æ¢æ—§çš„RDBæ–‡ä»¶</li>
</ul>
<p>RDBä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿsave 60 1000ä»£è¡¨ä»€ä¹ˆå«ä¹‰ï¼Ÿ</p>
<ul>
<li>é»˜è®¤æ˜¯æœåŠ¡åœæ­¢æ—¶</li>
<li>ä»£è¡¨60ç§’å†…è‡³å°‘æ‰§è¡Œ1000æ¬¡ä¿®æ”¹åˆ™è§¦å‘RDB</li>
</ul>
<p>RDBçš„ç¼ºç‚¹ï¼Ÿ</p>
<ul>
<li>RDBæ‰§è¡Œé—´éš”æ—¶é—´é•¿ï¼Œä¸¤æ¬¡RDBä¹‹é—´å†™å…¥æ•°æ®æœ‰ä¸¢å¤±çš„é£é™©</li>
<li>forkå­è¿›ç¨‹ã€å‹ç¼©ã€å†™å‡ºRDBæ–‡ä»¶éƒ½æ¯”è¾ƒè€—æ—¶</li>
</ul>
<h4 id="1-2-4-AOFæŒä¹…åŒ–"><a href="#1-2-4-AOFæŒä¹…åŒ–" class="headerlink" title="1.2.4 AOFæŒä¹…åŒ–"></a>1.2.4 AOFæŒä¹…åŒ–</h4><p>AOFå…¨ç§°ä¸ºAppend Only Fileï¼ˆè¿½åŠ æ–‡ä»¶ï¼‰ã€‚Rediså¤„ç†çš„æ¯ä¸€ä¸ªå†™å‘½ä»¤éƒ½ä¼šè®°å½•åœ¨AOFæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åšæ˜¯å‘½ä»¤æ—¥å¿—æ–‡ä»¶ã€‚</p>
<p><img src="/img/blogs/java/redis/3.1.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>AOFé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹redis.confé…ç½®æ–‡ä»¶æ¥å¼€å¯AOFï¼š</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># æ˜¯å¦å¼€å¯AOFåŠŸèƒ½ï¼Œé»˜è®¤æ˜¯no</span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"># AOFæ–‡ä»¶çš„åç§°</span><br><span class="hljs-attr">appendfilename</span> <span class="hljs-string">&quot;appendonly.aof&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>AOFçš„å‘½ä»¤è®°å½•çš„é¢‘ç‡ä¹Ÿå¯ä»¥é€šè¿‡redis.confæ–‡ä»¶æ¥é…ï¼š</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># è¡¨ç¤ºæ¯æ‰§è¡Œä¸€æ¬¡å†™å‘½ä»¤ï¼Œç«‹å³è®°å½•åˆ°AOFæ–‡ä»¶</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">always </span><br><span class="hljs-comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç„¶åè¡¨ç¤ºæ¯éš”1ç§’å°†ç¼“å†²åŒºæ•°æ®å†™åˆ°AOFæ–‡ä»¶ï¼Œæ˜¯é»˜è®¤æ–¹æ¡ˆ</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">everysec </span><br><span class="hljs-comment"># å†™å‘½ä»¤æ‰§è¡Œå®Œå…ˆæ”¾å…¥AOFç¼“å†²åŒºï¼Œç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç£ç›˜</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">no</span><br></code></pre></td></tr></table></figure>


<h4 id="1-2-5-AOFæ–‡ä»¶é‡å†™"><a href="#1-2-5-AOFæ–‡ä»¶é‡å†™" class="headerlink" title="1.2.5 AOFæ–‡ä»¶é‡å†™"></a>1.2.5 AOFæ–‡ä»¶é‡å†™</h4><p>å› ä¸ºæ˜¯è®°å½•å‘½ä»¤ï¼ŒAOFæ–‡ä»¶ä¼šæ¯”RDBæ–‡ä»¶å¤§çš„å¤šã€‚è€Œä¸”AOFä¼šè®°å½•å¯¹åŒä¸€ä¸ªkeyçš„å¤šæ¬¡å†™æ“ä½œï¼Œä½†åªæœ‰æœ€åä¸€æ¬¡å†™æ“ä½œæ‰æœ‰æ„ä¹‰ã€‚é€šè¿‡æ‰§è¡Œbgrewriteaofå‘½ä»¤ï¼Œå¯ä»¥è®©AOFæ–‡ä»¶æ‰§è¡Œé‡å†™åŠŸèƒ½ï¼Œç”¨æœ€å°‘çš„å‘½ä»¤è¾¾åˆ°ç›¸åŒæ•ˆæœã€‚</p>
<p><img src="/img/blogs/java/redis/3.1.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Redisä¹Ÿä¼šåœ¨è§¦å‘é˜ˆå€¼æ—¶è‡ªåŠ¨å»é‡å†™AOFæ–‡ä»¶ã€‚é˜ˆå€¼ä¹Ÿå¯ä»¥åœ¨redis.confä¸­é…ç½®ï¼š</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># AOFæ–‡ä»¶æ¯”ä¸Šæ¬¡æ–‡ä»¶ å¢é•¿è¶…è¿‡å¤šå°‘ç™¾åˆ†æ¯”åˆ™è§¦å‘é‡å†™</span><br><span class="hljs-attr">auto-aof-rewrite-percentage</span> <span class="hljs-string">100</span><br><span class="hljs-comment"># AOFæ–‡ä»¶ä½“ç§¯æœ€å°å¤šå¤§ä»¥ä¸Šæ‰è§¦å‘é‡å†™ </span><br><span class="hljs-attr">auto-aof-rewrite-min-size</span> <span class="hljs-string">64mb </span><br></code></pre></td></tr></table></figure>


<h4 id="1-2-6-RDBä¸AOFå¯¹æ¯”"><a href="#1-2-6-RDBä¸AOFå¯¹æ¯”" class="headerlink" title="1.2.6 RDBä¸AOFå¯¹æ¯”"></a>1.2.6 RDBä¸AOFå¯¹æ¯”</h4><p>RDBå’ŒAOFå„æœ‰è‡ªå·±çš„ä¼˜ç¼ºç‚¹ï¼Œå¦‚æœå¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜ï¼Œåœ¨å®é™…å¼€å‘ä¸­å¾€å¾€ä¼š<strong>ç»“åˆ</strong>ä¸¤è€…æ¥ä½¿ç”¨ã€‚</p>
<table>
<thead>
<tr>
<th></th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æŒä¹…åŒ–æ–¹å¼</strong></td>
<td>å®šæ—¶å¯¹æ•´ä¸ªå†…å­˜åšå¿«ç…§</td>
<td>è®°å½•æ¯ä¸€æ¬¡æ‰§è¡Œçš„å‘½ä»¤</td>
</tr>
<tr>
<td><strong>æ•°æ®å®Œæ•´æ€§</strong></td>
<td>ä¸å®Œæ•´ï¼Œä¸¤æ¬¡å¤‡ä»½ä¹‹é—´ä¼šä¸¢å¤±</td>
<td>ç›¸å¯¹å®Œæ•´ï¼Œå–å†³äºåˆ·ç›˜ç­–ç•¥</td>
</tr>
<tr>
<td><strong>æ–‡ä»¶å¤§å°</strong></td>
<td>ä¼šæœ‰å‹ç¼©ï¼Œæ–‡ä»¶ä½“ç§¯å°</td>
<td>è®°å½•å‘½ä»¤ï¼Œæ–‡ä»¶ä½“ç§¯å¾ˆå¤§</td>
</tr>
<tr>
<td><strong>å®•æœºæ¢å¤é€Ÿåº¦</strong></td>
<td>å¾ˆå¿«</td>
<td>æ…¢</td>
</tr>
<tr>
<td><strong>æ•°æ®æ¢å¤ä¼˜å…ˆçº§</strong></td>
<td>ä½ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§ä¸å¦‚AOF</td>
<td>é«˜ï¼Œå› ä¸ºæ•°æ®å®Œæ•´æ€§æ›´é«˜</td>
</tr>
<tr>
<td><strong>ç³»ç»Ÿèµ„æºå ç”¨</strong></td>
<td>é«˜ï¼Œå¤§é‡CPUå’Œå†…å­˜æ¶ˆè€—</td>
<td>ä½ï¼Œä¸»è¦æ˜¯ç£ç›˜IOèµ„æº<br>ä½†AOFé‡å†™æ—¶ä¼šå ç”¨å¤§é‡CPUå’Œå†…å­˜èµ„æº</td>
</tr>
<tr>
<td><strong>ä½¿ç”¨åœºæ™¯</strong></td>
<td>å¯ä»¥å®¹å¿æ•°åˆ†é’Ÿçš„æ•°æ®ä¸¢å¤±ï¼Œè¿½æ±‚æ›´å¿«çš„å¯åŠ¨é€Ÿåº¦</td>
<td>å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜å¸¸è§</td>
</tr>
</tbody></table>
<h2 id="2-Redisä¸»ä»"><a href="#2-Redisä¸»ä»" class="headerlink" title="2. Redisä¸»ä»"></a>2. Redisä¸»ä»</h2><ul>
<li>Redisä¸»ç»“ç‚¹åªå†™(master)</li>
<li>Redisä»ç»“ç‚¹åªè¯»(slave)</li>
</ul>
<h3 id="2-1-æ­å»ºä¸»ä»æ¶æ„"><a href="#2-1-æ­å»ºä¸»ä»æ¶æ„" class="headerlink" title="2.1 æ­å»ºä¸»ä»æ¶æ„"></a>2.1 æ­å»ºä¸»ä»æ¶æ„</h3><p>å•èŠ‚ç‚¹Redisçš„å¹¶å‘èƒ½åŠ›æ˜¯æœ‰ä¸Šé™çš„ï¼Œè¦è¿›ä¸€æ­¥æé«˜Redisçš„å¹¶å‘èƒ½åŠ›ï¼Œå°±éœ€è¦æ­å»ºä¸»ä»é›†ç¾¤ï¼Œå®ç°è¯»å†™åˆ†ç¦»ã€‚</p>
<p><img src="/img/blogs/java/redis/3.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-ä¸»ä»æ•°æ®åŒæ­¥åŸç†"><a href="#2-2-ä¸»ä»æ•°æ®åŒæ­¥åŸç†" class="headerlink" title="2.2 ä¸»ä»æ•°æ®åŒæ­¥åŸç†"></a>2.2 ä¸»ä»æ•°æ®åŒæ­¥åŸç†</h3><h4 id="2-2-1-å…¨é‡åŒæ­¥"><a href="#2-2-1-å…¨é‡åŒæ­¥" class="headerlink" title="2.2.1 å…¨é‡åŒæ­¥"></a>2.2.1 å…¨é‡åŒæ­¥</h4><p>ä¸»ä»ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šæ‰§è¡Œ<strong>å…¨é‡åŒæ­¥</strong>ï¼Œå°†masterèŠ‚ç‚¹çš„æ‰€æœ‰æ•°æ®éƒ½æ‹·è´ç»™slaveèŠ‚ç‚¹ï¼š</p>
<p><img src="/img/blogs/java/redis/3.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>masterå¦‚ä½•å¾—çŸ¥salveæ˜¯ç¬¬ä¸€æ¬¡æ¥è¿æ¥å‘¢</strong>ï¼Ÿï¼Ÿ<br>æœ‰å‡ ä¸ªæ¦‚å¿µï¼Œå¯ä»¥ä½œä¸ºåˆ¤æ–­ä¾æ®ï¼š</p>
<ul>
<li><p><strong>Replication Id</strong>ï¼šç®€ç§°replidï¼Œæ˜¯æ•°æ®é›†çš„æ ‡è®°ï¼Œidä¸€è‡´åˆ™è¯´æ˜æ˜¯åŒä¸€æ•°æ®é›†ã€‚æ¯ä¸€ä¸ªmasteréƒ½æœ‰å”¯ä¸€çš„replidï¼Œslaveåˆ™ä¼šç»§æ‰¿masterèŠ‚ç‚¹çš„replid</p>
</li>
<li><p><strong>offset</strong>ï¼šåç§»é‡ï¼Œéšç€è®°å½•åœ¨repl_baklogä¸­çš„æ•°æ®å¢å¤šè€Œé€æ¸å¢å¤§ã€‚slaveå®ŒæˆåŒæ­¥æ—¶ä¹Ÿä¼šè®°å½•å½“å‰åŒæ­¥çš„offsetã€‚å¦‚æœslaveçš„offsetå°äºmasterçš„offsetï¼Œè¯´æ˜slaveæ•°æ®è½åäºmasterï¼Œéœ€è¦æ›´æ–°ã€‚</p>
</li>
<li><p>å› æ­¤slaveåšæ•°æ®åŒæ­¥ï¼Œå¿…é¡»å‘masterå£°æ˜è‡ªå·±çš„replication id å’Œoffsetï¼Œmasteræ‰å¯ä»¥åˆ¤æ–­åˆ°åº•éœ€è¦åŒæ­¥å“ªäº›æ•°æ®ã€‚</p>
</li>
</ul>
<p>å› æ­¤ï¼Œ<strong>masteråˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥çš„ä¾æ®ï¼Œå°±æ˜¯çœ‹replidæ˜¯å¦ä¸€è‡´</strong>ã€‚</p>
<p><img src="/img/blogs/java/redis/3.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p>å®Œæ•´æµç¨‹æè¿°ï¼š</p>
<ul>
<li>slaveèŠ‚ç‚¹è¯·æ±‚å¢é‡åŒæ­¥</li>
<li>masterèŠ‚ç‚¹åˆ¤æ–­replidï¼Œå‘ç°ä¸ä¸€è‡´ï¼Œæ‹’ç»å¢é‡åŒæ­¥</li>
<li>masterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slave</li>
<li>slaveæ¸…ç©ºæœ¬åœ°æ•°æ®ï¼ŒåŠ è½½masterçš„RDB</li>
<li>masterå°†RDBæœŸé—´çš„å‘½ä»¤è®°å½•åœ¨repl_baklogï¼Œå¹¶æŒç»­å°†logä¸­çš„å‘½ä»¤å‘é€ç»™slave</li>
<li>slaveæ‰§è¡Œæ¥æ”¶åˆ°çš„å‘½ä»¤ï¼Œä¿æŒä¸masterä¹‹é—´çš„åŒæ­¥</li>
</ul>
<h4 id="2-2-2-å¢é‡åŒæ­¥"><a href="#2-2-2-å¢é‡åŒæ­¥" class="headerlink" title="2.2.2 å¢é‡åŒæ­¥"></a>2.2.2 å¢é‡åŒæ­¥</h4><p>å…¨é‡åŒæ­¥éœ€è¦å…ˆåšRDBï¼Œç„¶åå°†RDBæ–‡ä»¶é€šè¿‡ç½‘ç»œä¼ è¾“ä¸ªslaveï¼Œæˆæœ¬å¤ªé«˜äº†ã€‚å› æ­¤é™¤äº†ç¬¬ä¸€æ¬¡åšå…¨é‡åŒæ­¥ï¼Œå…¶å®ƒå¤§å¤šæ•°æ—¶å€™slaveä¸masteréƒ½æ˜¯åš<strong>å¢é‡åŒæ­¥</strong>ã€‚</p>
<ul>
<li>ä»€ä¹ˆæ˜¯å¢é‡åŒæ­¥ï¼Ÿå°±æ˜¯åªæ›´æ–°slaveä¸masterå­˜åœ¨å·®å¼‚çš„éƒ¨åˆ†æ•°æ®</li>
</ul>
<p><img src="/img/blogs/java/redis/3.2.4.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>repl_baklogä¸­ä¼šè®°å½•Rediså¤„ç†è¿‡çš„å‘½ä»¤æ—¥å¿—åŠoffsetï¼ŒåŒ…æ‹¬masterå½“å‰çš„offsetï¼Œå’Œslaveå·²ç»æ‹·è´åˆ°çš„offsetï¼š<ul>
<li>slaveä¸masterçš„offsetä¹‹é—´çš„å·®å¼‚ï¼Œå°±æ˜¯salveéœ€è¦å¢é‡æ‹·è´çš„æ•°æ®äº†ã€‚</li>
</ul>
</li>
<li>repl_baklogå¤§å°æœ‰ä¸Šé™ï¼Œå†™æ»¡åä¼šè¦†ç›–æœ€æ—©çš„æ•°æ®ã€‚å¦‚æœslaveæ–­å¼€æ—¶é—´è¿‡ä¹…ï¼Œå¯¼è‡´å°šæœªå¤‡ä»½çš„æ•°æ®è¢«è¦†ç›–ï¼Œåˆ™æ— æ³•åŸºäºlogåšå¢é‡åŒæ­¥ï¼Œåªèƒ½å†æ¬¡å…¨é‡åŒæ­¥ã€‚</li>
</ul>
<h4 id="2-2-3-ä¸»ä»åŒæ­¥ä¼˜åŒ–"><a href="#2-2-3-ä¸»ä»åŒæ­¥ä¼˜åŒ–" class="headerlink" title="2.2.3 ä¸»ä»åŒæ­¥ä¼˜åŒ–"></a>2.2.3 ä¸»ä»åŒæ­¥ä¼˜åŒ–</h4><ul>
<li>åœ¨masterä¸­é…ç½®repl-diskless-sync yeså¯ç”¨æ— ç£ç›˜å¤åˆ¶ï¼Œé¿å…å…¨é‡åŒæ­¥æ—¶çš„ç£ç›˜IOã€‚</li>
<li>Rediså•èŠ‚ç‚¹ä¸Šçš„å†…å­˜å ç”¨ä¸è¦å¤ªå¤§ï¼Œå‡å°‘RDBå¯¼è‡´çš„è¿‡å¤šç£ç›˜IO</li>
<li>é€‚å½“æé«˜repl_baklogçš„å¤§å°ï¼Œå‘ç°slaveå®•æœºæ—¶å°½å¿«å®ç°æ•…éšœæ¢å¤ï¼Œå°½å¯èƒ½é¿å…å…¨é‡åŒæ­¥</li>
<li>é™åˆ¶ä¸€ä¸ªmasterä¸Šçš„slaveèŠ‚ç‚¹æ•°é‡ï¼Œå¦‚æœå®åœ¨æ˜¯å¤ªå¤šslaveï¼Œåˆ™å¯ä»¥é‡‡ç”¨ä¸»-ä»-ä»é“¾å¼ç»“æ„ï¼Œå‡å°‘masterå‹åŠ›</li>
</ul>
<p><img src="/img/blogs/java/redis/3.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-2-4-å°ç»“"><a href="#2-2-4-å°ç»“" class="headerlink" title="2.2.4 å°ç»“"></a>2.2.4 å°ç»“</h4><p>ç®€è¿°å…¨é‡åŒæ­¥å’Œå¢é‡åŒæ­¥åŒºåˆ«ï¼Ÿ</p>
<ul>
<li>å…¨é‡åŒæ­¥ï¼šmasterå°†å®Œæ•´å†…å­˜æ•°æ®ç”ŸæˆRDBï¼Œå‘é€RDBåˆ°slaveã€‚åç»­å‘½ä»¤åˆ™è®°å½•åœ¨repl_baklogï¼Œé€ä¸ªå‘é€ç»™slaveã€‚</li>
<li>å¢é‡åŒæ­¥ï¼šslaveæäº¤è‡ªå·±çš„offsetåˆ°masterï¼Œmasterè·å–repl_baklogä¸­ä»offsetä¹‹åçš„å‘½ä»¤ç»™slave</li>
</ul>
<p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå…¨é‡åŒæ­¥ï¼Ÿ</p>
<ul>
<li>slaveèŠ‚ç‚¹ç¬¬ä¸€æ¬¡è¿æ¥masterèŠ‚ç‚¹æ—¶</li>
<li>slaveèŠ‚ç‚¹æ–­å¼€æ—¶é—´å¤ªä¹…ï¼Œrepl_baklogä¸­çš„offsetå·²ç»è¢«è¦†ç›–æ—¶</li>
</ul>
<p>ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå¢é‡åŒæ­¥ï¼Ÿ</p>
<ul>
<li>slaveèŠ‚ç‚¹æ–­å¼€åˆæ¢å¤ï¼Œå¹¶ä¸”åœ¨repl_baklogä¸­èƒ½æ‰¾åˆ°offsetæ—¶</li>
</ul>
<h2 id="3-Rediså“¨å…µ"><a href="#3-Rediså“¨å…µ" class="headerlink" title="3. Rediså“¨å…µ"></a>3. Rediså“¨å…µ</h2><p>Redisæä¾›äº†å“¨å…µï¼ˆSentinelï¼‰æœºåˆ¶æ¥å®ç°ä¸»ä»é›†ç¾¤çš„è‡ªåŠ¨æ•…éšœæ¢å¤</p>
<h3 id="3-1-å“¨å…µçš„ä½œç”¨"><a href="#3-1-å“¨å…µçš„ä½œç”¨" class="headerlink" title="3.1 å“¨å…µçš„ä½œç”¨"></a>3.1 å“¨å…µçš„ä½œç”¨</h3><ul>
<li><strong>ç›‘æ§</strong>ï¼šSentinel ä¼šä¸æ–­æ£€æŸ¥æ‚¨çš„masterå’Œslaveæ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ</li>
<li><strong>è‡ªåŠ¨æ•…éšœæ¢å¤</strong>ï¼šå¦‚æœmasteræ•…éšœï¼ŒSentinelä¼šå°†ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚å½“æ•…éšœå®ä¾‹æ¢å¤åä¹Ÿä»¥æ–°çš„masterä¸ºä¸»</li>
<li><strong>é€šçŸ¥</strong>ï¼šSentinelå……å½“Rediså®¢æˆ·ç«¯çš„æœåŠ¡å‘ç°æ¥æºï¼Œå½“é›†ç¾¤å‘ç”Ÿæ•…éšœè½¬ç§»æ—¶ï¼Œä¼šå°†æœ€æ–°ä¿¡æ¯æ¨é€ç»™Redisçš„å®¢æˆ·ç«¯</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-2-é›†ç¾¤ç›‘æ§åŸç†"><a href="#3-2-é›†ç¾¤ç›‘æ§åŸç†" class="headerlink" title="3.2 é›†ç¾¤ç›‘æ§åŸç†"></a>3.2 é›†ç¾¤ç›‘æ§åŸç†</h3><p>SentinelåŸºäºå¿ƒè·³æœºåˆ¶ç›‘æµ‹æœåŠ¡çŠ¶æ€ï¼Œæ¯éš”1ç§’å‘é›†ç¾¤çš„æ¯ä¸ªå®ä¾‹å‘é€pingå‘½ä»¤ï¼š</p>
<ul>
<li>ä¸»è§‚ä¸‹çº¿ï¼šå¦‚æœæŸsentinelèŠ‚ç‚¹å‘ç°æŸå®ä¾‹æœªåœ¨è§„å®šæ—¶é—´å“åº”ï¼Œåˆ™è®¤ä¸ºè¯¥å®ä¾‹<strong>ä¸»è§‚ä¸‹çº¿</strong>ã€‚</li>
<li>å®¢è§‚ä¸‹çº¿ï¼šè‹¥è¶…è¿‡æŒ‡å®šæ•°é‡ï¼ˆquorumï¼‰çš„sentineléƒ½è®¤ä¸ºè¯¥å®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œåˆ™è¯¥å®ä¾‹<strong>å®¢è§‚ä¸‹çº¿</strong>ã€‚quorumå€¼æœ€å¥½è¶…è¿‡Sentinelå®ä¾‹æ•°é‡çš„ä¸€åŠã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-3-é€‰ä¸¾æ–°çš„master"><a href="#3-3-é€‰ä¸¾æ–°çš„master" class="headerlink" title="3.3 é€‰ä¸¾æ–°çš„master"></a>3.3 é€‰ä¸¾æ–°çš„master</h3><p>ä¸€æ—¦å‘ç°masteræ•…éšœï¼Œsentineléœ€è¦åœ¨salveä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºæ–°çš„masterï¼Œé€‰æ‹©ä¾æ®æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>é¦–å…ˆä¼šåˆ¤æ–­slaveèŠ‚ç‚¹ä¸masterèŠ‚ç‚¹æ–­å¼€æ—¶é—´é•¿çŸ­ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šå€¼ï¼ˆdown-after-milliseconds * 10ï¼‰åˆ™ä¼šæ’é™¤è¯¥slaveèŠ‚ç‚¹</li>
<li>ç„¶ååˆ¤æ–­slaveèŠ‚ç‚¹çš„slave-priorityå€¼ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå¦‚æœæ˜¯0åˆ™æ°¸ä¸å‚ä¸é€‰ä¸¾</li>
<li>å¦‚æœslave-prorityä¸€æ ·ï¼Œåˆ™åˆ¤æ–­slaveèŠ‚ç‚¹çš„offsetå€¼ï¼Œè¶Šå¤§è¯´æ˜æ•°æ®è¶Šæ–°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</li>
<li>æœ€åæ˜¯åˆ¤æ–­slaveèŠ‚ç‚¹çš„è¿è¡Œidå¤§å°ï¼Œè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<h3 id="3-4-å¦‚ä½•å®ç°æ•…éšœè½¬ç§»"><a href="#3-4-å¦‚ä½•å®ç°æ•…éšœè½¬ç§»" class="headerlink" title="3.4 å¦‚ä½•å®ç°æ•…éšœè½¬ç§»"></a>3.4 å¦‚ä½•å®ç°æ•…éšœè½¬ç§»</h3><p>å½“é€‰å‡ºä¸€ä¸ªæ–°çš„masteråï¼Œè¯¥å¦‚ä½•å®ç°åˆ‡æ¢å‘¢ï¼Ÿ</p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>sentinelç»™å¤‡é€‰çš„slave1èŠ‚ç‚¹å‘é€slaveof no oneå‘½ä»¤ï¼Œè®©è¯¥èŠ‚ç‚¹æˆä¸ºmaster</li>
<li>å¹¿æ’­ï¼šsentinelç»™æ‰€æœ‰å…¶å®ƒslaveå‘é€slaveof 192.168.150.101 7002 å‘½ä»¤ï¼Œè®©è¿™äº›slaveæˆä¸ºæ–°masterçš„ä»èŠ‚ç‚¹ï¼Œå¼€å§‹ä»æ–°çš„masterä¸ŠåŒæ­¥æ•°æ®ã€‚</li>
<li>æœ€åï¼Œsentinelå°†æ•…éšœèŠ‚ç‚¹æ ‡è®°ä¸ºslaveï¼Œå½“æ•…éšœèŠ‚ç‚¹æ¢å¤åä¼šè‡ªåŠ¨æˆä¸ºæ–°çš„masterçš„slaveèŠ‚ç‚¹</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-5-å°ç»“"><a href="#3-5-å°ç»“" class="headerlink" title="3.5 å°ç»“"></a>3.5 å°ç»“</h3><p>Sentinelçš„ä¸‰ä¸ªä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ç›‘æ§</li>
<li>æ•…éšœè½¬ç§»</li>
<li>é€šçŸ¥</li>
</ul>
<p>Sentinelå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªrediså®ä¾‹æ˜¯å¦å¥åº·ï¼Ÿ</p>
<ul>
<li>æ¯éš”1ç§’å‘é€ä¸€æ¬¡pingå‘½ä»¤ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰ç›¸å‘åˆ™è®¤ä¸ºæ˜¯ä¸»è§‚ä¸‹çº¿</li>
<li>å¦‚æœå¤§å¤šæ•°sentineléƒ½è®¤ä¸ºå®ä¾‹ä¸»è§‚ä¸‹çº¿ï¼Œåˆ™åˆ¤å®šæœåŠ¡ä¸‹çº¿</li>
</ul>
<p>æ•…éšœè½¬ç§»æ­¥éª¤æœ‰å“ªäº›ï¼Ÿ</p>
<ul>
<li>é¦–å…ˆé€‰å®šä¸€ä¸ªslaveä½œä¸ºæ–°çš„masterï¼Œæ‰§è¡Œslaveof no one</li>
<li>ç„¶åè®©æ‰€æœ‰èŠ‚ç‚¹éƒ½æ‰§è¡Œslaveof æ–°master</li>
<li>ä¿®æ”¹æ•…éšœèŠ‚ç‚¹é…ç½®ï¼Œæ·»åŠ slaveof æ–°master</li>
</ul>
<h3 id="3-6-RedisTemplate"><a href="#3-6-RedisTemplate" class="headerlink" title="3.6 RedisTemplate"></a>3.6 RedisTemplate</h3><p>åœ¨Sentinelé›†ç¾¤ç›‘ç®¡ä¸‹çš„Redisä¸»ä»é›†ç¾¤ï¼Œå…¶èŠ‚ç‚¹ä¼šå› ä¸ºè‡ªåŠ¨æ•…éšœè½¬ç§»è€Œå‘ç”Ÿå˜åŒ–ï¼ŒRedisçš„å®¢æˆ·ç«¯å¿…é¡»æ„ŸçŸ¥è¿™ç§å˜åŒ–ï¼ŒåŠæ—¶æ›´æ–°è¿æ¥ä¿¡æ¯ã€‚Springçš„RedisTemplateåº•å±‚åˆ©ç”¨lettuceå®ç°äº†èŠ‚ç‚¹çš„æ„ŸçŸ¥å’Œè‡ªåŠ¨åˆ‡æ¢ã€‚</p>
<ol>
<li>å¼•å…¥ä¾èµ–<br>åœ¨é¡¹ç›®çš„pomæ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–ï¼š</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>é…ç½®Redisåœ°å€<br>ç„¶ååœ¨é…ç½®æ–‡ä»¶application.ymlä¸­æŒ‡å®šredisçš„sentinelç›¸å…³ä¿¡æ¯ï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  redis:<br>    sentinel:<br>      master: mymaster<br>      nodes:<br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27001</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27002</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27003</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>é…ç½®è¯»å†™åˆ†ç¦»<br>åœ¨é¡¹ç›®çš„å¯åŠ¨ç±»ä¸­ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„beanï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="hljs-title function_">clientConfigurationBuilderCustomizer</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªbeanä¸­é…ç½®çš„å°±æ˜¯è¯»å†™ç­–ç•¥ï¼ŒåŒ…æ‹¬å››ç§ï¼š</p>
<ul>
<li>MASTERï¼šä»ä¸»èŠ‚ç‚¹è¯»å–</li>
<li>MASTER_PREFERREDï¼šä¼˜å…ˆä»masterèŠ‚ç‚¹è¯»å–ï¼Œmasterä¸å¯ç”¨æ‰è¯»å–replica</li>
<li>REPLICAï¼šä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–</li>
<li>REPLICA _PREFERREDï¼šä¼˜å…ˆä»slaveï¼ˆreplicaï¼‰èŠ‚ç‚¹è¯»å–ï¼Œæ‰€æœ‰çš„slaveéƒ½ä¸å¯ç”¨æ‰è¯»å–master</li>
</ul>
<h2 id="4-Redisåˆ†ç‰‡é›†ç¾¤"><a href="#4-Redisåˆ†ç‰‡é›†ç¾¤" class="headerlink" title="4. Redisåˆ†ç‰‡é›†ç¾¤"></a>4. Redisåˆ†ç‰‡é›†ç¾¤</h2><h3 id="4-1-åˆ†ç‰‡é›†ç¾¤"><a href="#4-1-åˆ†ç‰‡é›†ç¾¤" class="headerlink" title="4.1 åˆ†ç‰‡é›†ç¾¤"></a>4.1 åˆ†ç‰‡é›†ç¾¤</h3><p>ä¸»ä»å’Œå“¨å…µå¯ä»¥è§£å†³é«˜å¯ç”¨ã€é«˜å¹¶å‘è¯»çš„é—®é¢˜ã€‚ä½†æ˜¯ä¾ç„¶æœ‰ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰è§£å†³ï¼š</p>
<ul>
<li>æµ·é‡æ•°æ®å­˜å‚¨é—®é¢˜</li>
<li>é«˜å¹¶å‘å†™çš„é—®é¢˜</li>
</ul>
<p>ä½¿ç”¨åˆ†ç‰‡é›†ç¾¤å¯ä»¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œåˆ†ç‰‡é›†ç¾¤ç‰¹å¾ï¼š</p>
<ul>
<li>é›†ç¾¤ä¸­æœ‰å¤šä¸ªmasterï¼Œæ¯ä¸ªmasterä¿å­˜ä¸åŒæ•°æ®</li>
<li>æ¯ä¸ªmasteréƒ½å¯ä»¥æœ‰å¤šä¸ªslaveèŠ‚ç‚¹</li>
<li>masterä¹‹é—´é€šè¿‡pingç›‘æµ‹å½¼æ­¤å¥åº·çŠ¶æ€</li>
<li>å®¢æˆ·ç«¯è¯·æ±‚å¯ä»¥è®¿é—®é›†ç¾¤ä»»æ„èŠ‚ç‚¹ï¼Œæœ€ç»ˆéƒ½ä¼šè¢«è½¬å‘åˆ°æ­£ç¡®èŠ‚ç‚¹</li>
</ul>
<p><img src="/img/blogs/java/redis/3.4.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-2-æ•£åˆ—æ’æ§½"><a href="#4-2-æ•£åˆ—æ’æ§½" class="headerlink" title="4.2 æ•£åˆ—æ’æ§½"></a>4.2 æ•£åˆ—æ’æ§½</h3><p>Redisä¼šæŠŠæ¯ä¸€ä¸ªmasterèŠ‚ç‚¹æ˜ å°„åˆ°0~16383å…±16384ä¸ªæ’æ§½ï¼ˆhash slotï¼‰ä¸Š</p>
<p><img src="/img/blogs/java/redis/3.4.2.png" srcset="/img/loading.gif" lazyload></p>
<p>æ•°æ®keyä¸æ˜¯ä¸èŠ‚ç‚¹ç»‘å®šï¼Œè€Œæ˜¯ä¸æ’æ§½ç»‘å®šã€‚redisä¼šæ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—æ’æ§½å€¼ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>keyä¸­åŒ…å«â€{}â€ï¼Œä¸”â€œ{}â€ä¸­è‡³å°‘åŒ…å«1ä¸ªå­—ç¬¦ï¼Œâ€œ{}â€ä¸­çš„éƒ¨åˆ†æ˜¯æœ‰æ•ˆéƒ¨åˆ†</li>
<li>keyä¸­ä¸åŒ…å«â€œ{}â€ï¼Œæ•´ä¸ªkeyéƒ½æ˜¯æœ‰æ•ˆéƒ¨åˆ†</li>
</ul>
<p>ä¾‹å¦‚ï¼škeyæ˜¯numï¼Œé‚£ä¹ˆå°±æ ¹æ®numè®¡ç®—ï¼Œå¦‚æœæ˜¯{itcast}numï¼Œåˆ™æ ¹æ®itcastè®¡ç®—ã€‚è®¡ç®—æ–¹å¼æ˜¯åˆ©ç”¨CRC16ç®—æ³•å¾—åˆ°ä¸€ä¸ªhashå€¼ï¼Œç„¶åå¯¹16384å–ä½™ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯slotå€¼ã€‚</p>
<p>Rediså¦‚ä½•åˆ¤æ–­æŸä¸ªkeyåº”è¯¥åœ¨å“ªä¸ªå®ä¾‹ï¼Ÿ</p>
<ul>
<li>å°†16384ä¸ªæ’æ§½åˆ†é…åˆ°ä¸åŒçš„å®ä¾‹</li>
<li>æ ¹æ®keyçš„æœ‰æ•ˆéƒ¨åˆ†è®¡ç®—å“ˆå¸Œå€¼ï¼Œå¯¹16384å–ä½™</li>
<li>ä½™æ•°ä½œä¸ºæ’æ§½ï¼Œå¯»æ‰¾æ’æ§½æ‰€åœ¨å®ä¾‹å³å¯</li>
</ul>
<p>å¦‚ä½•å°†åŒä¸€ç±»æ•°æ®å›ºå®šçš„ä¿å­˜åœ¨åŒä¸€ä¸ªRediså®ä¾‹ï¼Ÿ</p>
<ul>
<li>è¿™ä¸€ç±»æ•°æ®ä½¿ç”¨ç›¸åŒçš„æœ‰æ•ˆéƒ¨åˆ†ï¼Œä¾‹å¦‚keyéƒ½ä»¥{typeId}ä¸ºå‰ç¼€</li>
</ul>
<h3 id="4-3-é›†ç¾¤ä¼¸ç¼©"><a href="#4-3-é›†ç¾¤ä¼¸ç¼©" class="headerlink" title="4.3 é›†ç¾¤ä¼¸ç¼©"></a>4.3 é›†ç¾¤ä¼¸ç¼©</h3><p>redis-cli â€“clusteræä¾›äº†å¾ˆå¤šæ“ä½œé›†ç¾¤çš„å‘½ä»¤</p>
<ul>
<li>æ·»åŠ èŠ‚ç‚¹çš„å‘½ä»¤ï¼š</li>
</ul>
<p><img src="/img/blogs/java/redis/3.4.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-4-æ•…éšœè½¬ç§»"><a href="#4-4-æ•…éšœè½¬ç§»" class="headerlink" title="4.4 æ•…éšœè½¬ç§»"></a>4.4 æ•…éšœè½¬ç§»</h3><h4 id="4-4-1-è‡ªåŠ¨æ•…éšœè½¬ç§»"><a href="#4-4-1-è‡ªåŠ¨æ•…éšœè½¬ç§»" class="headerlink" title="4.4.1 è‡ªåŠ¨æ•…éšœè½¬ç§»"></a>4.4.1 è‡ªåŠ¨æ•…éšœè½¬ç§»</h4><p>å½“é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªmasterå®•æœºä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p>ç›´æ¥åœæ­¢ä¸€ä¸ªrediså®ä¾‹ï¼Œä¾‹å¦‚7002ï¼š</p>
<ol>
<li>é¦–å…ˆæ˜¯è¯¥å®ä¾‹ä¸å…¶å®ƒå®ä¾‹å¤±å»è¿æ¥</li>
<li>ç„¶åæ˜¯ç–‘ä¼¼å®•æœºï¼š</li>
<li>æœ€åæ˜¯ç¡®å®šä¸‹çº¿ï¼Œè‡ªåŠ¨æå‡ä¸€ä¸ªslaveä¸ºæ–°çš„master</li>
<li>å½“7002å†æ¬¡å¯åŠ¨ï¼Œå°±ä¼šå˜ä¸ºä¸€ä¸ªslaveèŠ‚ç‚¹äº†</li>
</ol>
<h4 id="4-4-2-æ‰‹åŠ¨æ•…éšœè½¬ç§»"><a href="#4-4-2-æ‰‹åŠ¨æ•…éšœè½¬ç§»" class="headerlink" title="4.4.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»"></a>4.4.2 æ‰‹åŠ¨æ•…éšœè½¬ç§»</h4><p>åˆ©ç”¨cluster failoverå‘½ä»¤å¯ä»¥æ‰‹åŠ¨è®©é›†ç¾¤ä¸­çš„æŸä¸ªmasterå®•æœºï¼Œåˆ‡æ¢åˆ°æ‰§è¡Œcluster failoverå‘½ä»¤çš„è¿™ä¸ªslaveèŠ‚ç‚¹ï¼Œå®ç°æ— æ„ŸçŸ¥çš„æ•°æ®è¿ç§»ã€‚</p>
<h3 id="4-5-RedisTemplateè®¿é—®åˆ†ç‰‡é›†ç¾¤"><a href="#4-5-RedisTemplateè®¿é—®åˆ†ç‰‡é›†ç¾¤" class="headerlink" title="4.5 RedisTemplateè®¿é—®åˆ†ç‰‡é›†ç¾¤"></a>4.5 RedisTemplateè®¿é—®åˆ†ç‰‡é›†ç¾¤</h3><p>RedisTemplateåº•å±‚åŒæ ·åŸºäºlettuceå®ç°äº†åˆ†ç‰‡é›†ç¾¤çš„æ”¯æŒï¼Œè€Œä½¿ç”¨çš„æ­¥éª¤ä¸å“¨å…µæ¨¡å¼åŸºæœ¬ä¸€è‡´ï¼š</p>
<ol>
<li>å¼•å…¥redisçš„starterä¾èµ–</li>
<li>é…ç½®åˆ†ç‰‡é›†ç¾¤åœ°å€</li>
<li>é…ç½®è¯»å†™åˆ†ç¦»</li>
</ol>
<p>ä¸å“¨å…µæ¨¡å¼ç›¸æ¯”ï¼Œå…¶ä¸­åªæœ‰åˆ†ç‰‡é›†ç¾¤çš„é…ç½®æ–¹å¼ç•¥æœ‰å·®å¼‚ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7003</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8003</span><br></code></pre></td></tr></table></figure>


<h2 id="5-å¤šçº§ç¼“å­˜"><a href="#5-å¤šçº§ç¼“å­˜" class="headerlink" title="5. å¤šçº§ç¼“å­˜"></a>5. å¤šçº§ç¼“å­˜</h2><h3 id="5-1-ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜"><a href="#5-1-ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜" class="headerlink" title="5.1 ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜"></a>5.1 ä»€ä¹ˆæ˜¯å¤šçº§ç¼“å­˜</h3><p><strong>ä¼ ç»Ÿçš„ç¼“å­˜</strong>ç­–ç•¥ä¸€èˆ¬æ˜¯è¯·æ±‚åˆ°è¾¾Tomcatåï¼Œå…ˆæŸ¥è¯¢Redisï¼Œå¦‚æœæœªå‘½ä¸­åˆ™æŸ¥è¯¢æ•°æ®åº“</p>
<ul>
<li>è¯·æ±‚è¦ç»è¿‡Tomcatå¤„ç†ï¼ŒTomcatçš„æ€§èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆ</li>
<li>Redisç¼“å­˜å¤±æ•ˆæ—¶ï¼Œä¼šå¯¹æ•°æ®åº“äº§ç”Ÿå†²å‡»</li>
</ul>
<p><img src="/img/blogs/java/redis/3.5.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>å¤šçº§ç¼“å­˜</strong>å°±æ˜¯å……åˆ†åˆ©ç”¨è¯·æ±‚å¤„ç†çš„æ¯ä¸ªç¯èŠ‚ï¼Œåˆ†åˆ«æ·»åŠ ç¼“å­˜ï¼Œå‡è½»Tomcatå‹åŠ›ï¼Œæå‡æœåŠ¡æ€§èƒ½ï¼š</p>
<ul>
<li>æµè§ˆå™¨è®¿é—®é™æ€èµ„æºæ—¶ï¼Œä¼˜å…ˆè¯»å–æµè§ˆå™¨æœ¬åœ°ç¼“å­˜</li>
<li>è®¿é—®éé™æ€èµ„æºï¼ˆajaxæŸ¥è¯¢æ•°æ®ï¼‰æ—¶ï¼Œè®¿é—®æœåŠ¡ç«¯</li>
<li>è¯·æ±‚åˆ°è¾¾Nginxåï¼Œä¼˜å…ˆè¯»å–Nginxæœ¬åœ°ç¼“å­˜</li>
<li>å¦‚æœNginxæœ¬åœ°ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™å»ç›´æ¥æŸ¥è¯¢Redisï¼ˆä¸ç»è¿‡Tomcatï¼‰</li>
<li>å¦‚æœRedisæŸ¥è¯¢æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢Tomcat</li>
<li>è¯·æ±‚è¿›å…¥Tomcatåï¼Œä¼˜å…ˆæŸ¥è¯¢JVMè¿›ç¨‹ç¼“å­˜</li>
<li>å¦‚æœJVMè¿›ç¨‹ç¼“å­˜æœªå‘½ä¸­ï¼Œåˆ™æŸ¥è¯¢æ•°æ®åº“</li>
</ul>
<p><img src="/img/blogs/java/redis/3.5.2.png" srcset="/img/loading.gif" lazyload></p>
<p>å¤šçº§ç¼“å­˜çš„å…³é”®æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯åœ¨nginxä¸­ç¼–å†™ä¸šåŠ¡ï¼Œå®ç°nginxæœ¬åœ°ç¼“å­˜ã€Redisã€Tomcatçš„æŸ¥è¯¢</li>
<li>å¦ä¸€ä¸ªå°±æ˜¯åœ¨Tomcatä¸­å®ç°JVMè¿›ç¨‹ç¼“å­˜</li>
</ul>
<h3 id="5-2-JVMè¿›ç¨‹ç¼“å­˜"><a href="#5-2-JVMè¿›ç¨‹ç¼“å­˜" class="headerlink" title="5.2 JVMè¿›ç¨‹ç¼“å­˜"></a>5.2 JVMè¿›ç¨‹ç¼“å­˜</h3><p><img src="/img/blogs/java/redis/3.5.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="5-2-1-åˆè¯†Caffeine"><a href="#5-2-1-åˆè¯†Caffeine" class="headerlink" title="5.2.1 åˆè¯†Caffeine"></a>5.2.1 åˆè¯†Caffeine</h4><p>ç¼“å­˜åœ¨æ—¥å¸¸å¼€å‘ä¸­å¯åŠ¨è‡³å…³é‡è¦çš„ä½œç”¨ï¼Œç”±äºæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®çš„è¯»å–é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œèƒ½å¤§é‡å‡å°‘å¯¹æ•°æ®åº“çš„è®¿é—®ï¼Œå‡å°‘æ•°æ®åº“çš„å‹åŠ›ã€‚æˆ‘ä»¬æŠŠç¼“å­˜åˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li>åˆ†å¸ƒå¼ç¼“å­˜ï¼Œä¾‹å¦‚Redisï¼š<ul>
<li>ä¼˜ç‚¹ï¼šå­˜å‚¨å®¹é‡æ›´å¤§ã€å¯é æ€§æ›´å¥½ã€å¯ä»¥åœ¨é›†ç¾¤é—´å…±äº«</li>
<li>ç¼ºç‚¹ï¼šè®¿é—®ç¼“å­˜æœ‰ç½‘ç»œå¼€é”€</li>
<li>åœºæ™¯ï¼šç¼“å­˜æ•°æ®é‡è¾ƒå¤§ã€å¯é æ€§è¦æ±‚è¾ƒé«˜ã€éœ€è¦åœ¨é›†ç¾¤é—´å…±äº«</li>
</ul>
</li>
<li>è¿›ç¨‹æœ¬åœ°ç¼“å­˜ï¼Œä¾‹å¦‚HashMapã€GuavaCacheï¼š<ul>
<li>ä¼˜ç‚¹ï¼šè¯»å–æœ¬åœ°å†…å­˜ï¼Œæ²¡æœ‰ç½‘ç»œå¼€é”€ï¼Œé€Ÿåº¦æ›´å¿«</li>
<li>ç¼ºç‚¹ï¼šå­˜å‚¨å®¹é‡æœ‰é™ã€å¯é æ€§è¾ƒä½ã€æ— æ³•å…±äº«</li>
<li>åœºæ™¯ï¼šæ€§èƒ½è¦æ±‚è¾ƒé«˜ï¼Œç¼“å­˜æ•°æ®é‡è¾ƒå°</li>
</ul>
</li>
</ul>
<p>æˆ‘ä»¬ä»Šå¤©ä¼šåˆ©ç”¨Caffeineæ¡†æ¶æ¥å®ç°JVMè¿›ç¨‹ç¼“å­˜</p>
<p><strong>Caffeine</strong>æ˜¯ä¸€ä¸ªåŸºäºJava8å¼€å‘çš„ï¼Œæä¾›äº†è¿‘ä¹æœ€ä½³å‘½ä¸­ç‡çš„é«˜æ€§èƒ½çš„æœ¬åœ°ç¼“å­˜åº“ã€‚ç›®å‰Springå†…éƒ¨çš„ç¼“å­˜ä½¿ç”¨çš„å°±æ˜¯Caffeineã€‚</p>
<ul>
<li>ç¼“å­˜ä½¿ç”¨çš„åŸºæœ¬APIï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testBasicOps</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// æ„å»ºcacheå¯¹è±¡</span><br>    Cache&lt;String, String&gt; cache = Caffeine.newBuilder().build();<br><br>    <span class="hljs-comment">// å­˜æ•°æ®</span><br>    cache.put(<span class="hljs-string">&quot;gf&quot;</span>, <span class="hljs-string">&quot;è¿ªä¸½çƒ­å·´&quot;</span>);<br><br>    <span class="hljs-comment">// å–æ•°æ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> cache.getIfPresent(<span class="hljs-string">&quot;gf&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;gf = &quot;</span> + gf);<br><br>    <span class="hljs-comment">// å–æ•°æ®ï¼ŒåŒ…å«ä¸¤ä¸ªå‚æ•°ï¼š</span><br>    <span class="hljs-comment">// å‚æ•°ä¸€ï¼šç¼“å­˜çš„key</span><br>    <span class="hljs-comment">// å‚æ•°äºŒï¼šLambdaè¡¨è¾¾å¼ï¼Œè¡¨è¾¾å¼å‚æ•°å°±æ˜¯ç¼“å­˜çš„keyï¼Œæ–¹æ³•ä½“æ˜¯æŸ¥è¯¢æ•°æ®åº“çš„é€»è¾‘</span><br>    <span class="hljs-comment">// ä¼˜å…ˆæ ¹æ®keyæŸ¥è¯¢JVMç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œåˆ™æ‰§è¡Œå‚æ•°äºŒçš„Lambdaè¡¨è¾¾å¼</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultGF</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">&quot;defaultGF&quot;</span>, key -&gt; &#123;<br>        <span class="hljs-comment">// æ ¹æ®keyå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;æŸ³å²©&quot;</span>;<br>    &#125;);<br>    System.out.println(<span class="hljs-string">&quot;defaultGF = &quot;</span> + defaultGF);<br>&#125;<br></code></pre></td></tr></table></figure>


<p>Caffeineæ—¢ç„¶æ˜¯ç¼“å­˜çš„ä¸€ç§ï¼Œè‚¯å®šéœ€è¦æœ‰ç¼“å­˜çš„æ¸…é™¤ç­–ç•¥ï¼Œä¸ç„¶çš„è¯å†…å­˜æ€»ä¼šæœ‰è€—å°½çš„æ—¶å€™ã€‚Caffeineæä¾›äº†ä¸‰ç§ç¼“å­˜é©±é€ç­–ç•¥ï¼š</p>
<ul>
<li><p><strong>åŸºäºå®¹é‡</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æ•°é‡ä¸Šé™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>    .maximumSize(<span class="hljs-number">1</span>) <span class="hljs-comment">// è®¾ç½®ç¼“å­˜å¤§å°ä¸Šé™ä¸º 1</span><br>    .build();<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>åŸºäºæ—¶é—´</strong>ï¼šè®¾ç½®ç¼“å­˜çš„æœ‰æ•ˆæ—¶é—´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>    <span class="hljs-comment">// è®¾ç½®ç¼“å­˜æœ‰æ•ˆæœŸä¸º 10 ç§’ï¼Œä»æœ€åä¸€æ¬¡å†™å…¥å¼€å§‹è®¡æ—¶ </span><br>    .expireAfterWrite(Duration.ofSeconds(<span class="hljs-number">10</span>)) <br>    .build();<br><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>åŸºäºå¼•ç”¨</strong>ï¼šè®¾ç½®ç¼“å­˜ä¸ºè½¯å¼•ç”¨æˆ–å¼±å¼•ç”¨ï¼Œåˆ©ç”¨GCæ¥å›æ”¶ç¼“å­˜æ•°æ®ã€‚æ€§èƒ½è¾ƒå·®ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p>
</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç¼“å­˜å…ƒç´ è¿‡æœŸçš„æ—¶å€™ï¼ŒCaffeineä¸ä¼šè‡ªåŠ¨ç«‹å³å°†å…¶æ¸…ç†å’Œé©±é€ã€‚è€Œæ˜¯åœ¨ä¸€æ¬¡è¯»æˆ–å†™æ“ä½œåï¼Œæˆ–è€…åœ¨ç©ºé—²æ—¶é—´å®Œæˆå¯¹å¤±æ•ˆæ•°æ®çš„é©±é€ã€‚</p>
<h4 id="5-2-2-å®ç°JVMè¿›ç¨‹ç¼“å­˜"><a href="#5-2-2-å®ç°JVMè¿›ç¨‹ç¼“å­˜" class="headerlink" title="5.2.2 å®ç°JVMè¿›ç¨‹ç¼“å­˜"></a>5.2.2 å®ç°JVMè¿›ç¨‹ç¼“å­˜</h4><p>åˆ©ç”¨Caffeineå®ç°ä¸‹åˆ—éœ€æ±‚ï¼š</p>
<ul>
<li>ç»™æ ¹æ®idæŸ¥è¯¢å•†å“çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li>
<li>ç»™æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜çš„ä¸šåŠ¡æ·»åŠ ç¼“å­˜ï¼Œç¼“å­˜æœªå‘½ä¸­æ—¶æŸ¥è¯¢æ•°æ®åº“</li>
<li>ç¼“å­˜åˆå§‹å¤§å°ä¸º100</li>
<li>ç¼“å­˜ä¸Šé™ä¸º10000</li>
</ul>
<h5 id="å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚"><a href="#å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚" class="headerlink" title="å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚"></a>å®šä¹‰ä¸¤ä¸ªCaffeineçš„ç¼“å­˜å¯¹è±¡ï¼Œåˆ†åˆ«ä¿å­˜å•†å“ã€åº“å­˜çš„ç¼“å­˜æ•°æ®ã€‚</h5><p>åœ¨item-serviceçš„<code>com.heima.item.config</code>åŒ…ä¸‹å®šä¹‰<code>CaffeineConfig</code>ç±»ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.item.config;<br><br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;<br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.Item;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.ItemStock;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, Item&gt; <span class="hljs-title function_">itemCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, ItemStock&gt; <span class="hljs-title function_">stockCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ItemController"><a href="#ItemController" class="headerlink" title="ItemController"></a>ItemController</h5><p>ä¿®æ”¹item-serviceä¸­çš„<code>com.heima.item.web</code>åŒ…ä¸‹çš„ItemControllerç±»ï¼Œæ·»åŠ ç¼“å­˜é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, ItemStock&gt; stockCache;<br>    <br>    <span class="hljs-comment">// ...å…¶å®ƒç•¥</span><br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Item <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> itemCache.get(id, key -&gt; itemService.query()<br>                .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, key)<br>                .one()<br>        );<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/stock/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ItemStock <span class="hljs-title function_">findStockById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> stockCache.get(id, key -&gt; stockService.getById(key));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-3-Luaè¯­æ³•å…¥é—¨"><a href="#5-3-Luaè¯­æ³•å…¥é—¨" class="headerlink" title="5.3 Luaè¯­æ³•å…¥é—¨"></a>5.3 Luaè¯­æ³•å…¥é—¨</h3><p>Nginxç¼–ç¨‹éœ€è¦ç”¨åˆ°Luaè¯­è¨€</p>
<p><img src="/img/blogs/java/redis/3.5.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="5-3-1-åˆè¯†Lua"><a href="#5-3-1-åˆè¯†Lua" class="headerlink" title="5.3.1 åˆè¯†Lua"></a>5.3.1 åˆè¯†Lua</h4><p>Lua æ˜¯ä¸€ç§è½»é‡å°å·§çš„è„šæœ¬è¯­è¨€ï¼Œç”¨æ ‡å‡†Cè¯­è¨€ç¼–å†™å¹¶ä»¥æºä»£ç å½¢å¼å¼€æ”¾ï¼Œ å…¶è®¾è®¡ç›®çš„æ˜¯ä¸ºäº†åµŒå…¥åº”ç”¨ç¨‹åºä¸­ï¼Œä»è€Œä¸ºåº”ç”¨ç¨‹åºæä¾›çµæ´»çš„æ‰©å±•å’Œå®šåˆ¶åŠŸèƒ½ã€‚</p>
<h4 id="5-3-2-å˜é‡å’Œå¾ªç¯"><a href="#5-3-2-å˜é‡å’Œå¾ªç¯" class="headerlink" title="5.3.2 å˜é‡å’Œå¾ªç¯"></a>5.3.2 å˜é‡å’Œå¾ªç¯</h4><h5 id="Luaçš„æ•°æ®ç±»å‹"><a href="#Luaçš„æ•°æ®ç±»å‹" class="headerlink" title="Luaçš„æ•°æ®ç±»å‹"></a>Luaçš„æ•°æ®ç±»å‹</h5><table>
<thead>
<tr>
<th>æ•°æ®ç±»å‹</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>nil</td>
<td>è¿™ä¸ªæœ€ç®€å•ï¼Œåªæœ‰å€¼nilå±äºè¯¥ç±»ï¼Œè¡¨ç¤ºä¸€ä¸ªæ— æ•ˆå€¼ï¼ˆåœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ç›¸å½“äºfalseï¼‰ã€‚</td>
</tr>
<tr>
<td>boolean</td>
<td>åŒ…å«ä¸¤ä¸ªå€¼ï¼šfalseå’Œtrue</td>
</tr>
<tr>
<td>number</td>
<td>è¡¨ç¤ºåŒç²¾åº¦ç±»å‹çš„å®æµ®ç‚¹æ•°</td>
</tr>
<tr>
<td>string</td>
<td>å­—ç¬¦ä¸²ç”±ä¸€å¯¹åŒå¼•å·æˆ–å•å¼•å·æ¥è¡¨ç¤º</td>
</tr>
<tr>
<td>function</td>
<td>ç”± C æˆ– Lua ç¼–å†™çš„å‡½æ•°</td>
</tr>
<tr>
<td>table</td>
<td>Lua ä¸­çš„è¡¨ï¼ˆtableï¼‰å…¶å®æ˜¯ä¸€ä¸ªâ€å…³è”æ•°ç»„â€ï¼ˆassociative arraysï¼‰ï¼Œæ•°ç»„çš„ç´¢å¼•å¯ä»¥æ˜¯æ•°å­—ã€å­—ç¬¦ä¸²æˆ–è¡¨ç±»å‹ã€‚åœ¨ Lua é‡Œï¼Œtable çš„åˆ›å»ºæ˜¯é€šè¿‡â€æ„é€ è¡¨è¾¾å¼â€æ¥å®Œæˆï¼Œæœ€ç®€å•æ„é€ è¡¨è¾¾å¼æ˜¯{}ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºè¡¨ã€‚</td>
</tr>
</tbody></table>
<ul>
<li>Luaæä¾›äº†type()å‡½æ•°æ¥åˆ¤æ–­ä¸€ä¸ªå˜é‡çš„æ•°æ®ç±»å‹</li>
</ul>
<h5 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h5><p>Luaå£°æ˜å˜é‡çš„æ—¶å€™æ— éœ€æŒ‡å®šæ•°æ®ç±»å‹ï¼Œè€Œæ˜¯ç”¨localæ¥å£°æ˜å˜é‡ä¸ºå±€éƒ¨å˜é‡ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å£°æ˜å­—ç¬¦ä¸²ï¼Œå¯ä»¥ç”¨å•å¼•å·æˆ–åŒå¼•å·ï¼Œ</span><br><span class="hljs-keyword">local</span> str = <span class="hljs-string">&#x27;hello&#x27;</span><br><span class="hljs-comment">-- å­—ç¬¦ä¸²æ‹¼æ¥å¯ä»¥ä½¿ç”¨ ..</span><br><span class="hljs-keyword">local</span> str2 = <span class="hljs-string">&#x27;hello&#x27;</span> .. <span class="hljs-string">&#x27;world&#x27;</span><br><span class="hljs-comment">-- å£°æ˜æ•°å­—</span><br><span class="hljs-keyword">local</span> num = <span class="hljs-number">21</span><br><span class="hljs-comment">-- å£°æ˜å¸ƒå°”ç±»å‹</span><br><span class="hljs-keyword">local</span> flag = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>Luaä¸­çš„tableç±»å‹æ—¢å¯ä»¥ä½œä¸ºæ•°ç»„ï¼Œåˆå¯ä»¥ä½œä¸ºJavaä¸­çš„mapæ¥ä½¿ç”¨ã€‚æ•°ç»„å°±æ˜¯ç‰¹æ®Šçš„tableï¼Œkeyæ˜¯æ•°ç»„è§’æ ‡è€Œå·²ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å£°æ˜æ•°ç»„ ï¼Œkeyä¸ºè§’æ ‡çš„ table</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;python&#x27;</span>, <span class="hljs-string">&#x27;lua&#x27;</span>&#125;<br><span class="hljs-comment">-- å£°æ˜tableï¼Œç±»ä¼¼javaçš„map</span><br><span class="hljs-keyword">local</span> map =  &#123;name=<span class="hljs-string">&#x27;Jack&#x27;</span>, age=<span class="hljs-number">21</span>&#125;<br></code></pre></td></tr></table></figure>

<p>Luaä¸­çš„æ•°ç»„è§’æ ‡æ˜¯ä»1å¼€å§‹ï¼Œè®¿é—®çš„æ—¶å€™ä¸Javaä¸­ç±»ä¼¼ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- è®¿é—®æ•°ç»„ï¼Œluaæ•°ç»„çš„è§’æ ‡ä»1å¼€å§‹</span><br><span class="hljs-built_in">print</span>(arr[<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure>

<p>Luaä¸­çš„tableå¯ä»¥ç”¨keyæ¥è®¿é—®ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- è®¿é—®table</span><br><span class="hljs-built_in">print</span>(map[<span class="hljs-string">&#x27;name&#x27;</span>])<br><span class="hljs-built_in">print</span>(map.name)<br></code></pre></td></tr></table></figure>


<h4 id="5-3-3-å¾ªç¯"><a href="#5-3-3-å¾ªç¯" class="headerlink" title="5.3.3 å¾ªç¯"></a>5.3.3 å¾ªç¯</h4><p>å¯¹äºtableï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨forå¾ªç¯æ¥éå†ã€‚ä¸è¿‡æ•°ç»„å’Œæ™®é€štableéå†ç•¥æœ‰å·®å¼‚ã€‚<br>éå†æ•°ç»„ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å£°æ˜æ•°ç»„ keyä¸ºç´¢å¼•çš„ table</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;python&#x27;</span>, <span class="hljs-string">&#x27;lua&#x27;</span>&#125;<br><span class="hljs-comment">-- éå†æ•°ç»„</span><br><span class="hljs-keyword">for</span> index,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">print</span>(index, value) <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>éå†æ™®é€štable</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å£°æ˜mapï¼Œä¹Ÿå°±æ˜¯table</span><br><span class="hljs-keyword">local</span> map = &#123;name=<span class="hljs-string">&#x27;Jack&#x27;</span>, age=<span class="hljs-number">21</span>&#125;<br><span class="hljs-comment">-- éå†table</span><br><span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(map) <span class="hljs-keyword">do</span><br>   <span class="hljs-built_in">print</span>(key, value) <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-4-å‡½æ•°"><a href="#5-3-4-å‡½æ•°" class="headerlink" title="5.3.4 å‡½æ•°"></a>5.3.4 å‡½æ•°</h4><p>å®šä¹‰å‡½æ•°çš„è¯­æ³•ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> å‡½æ•°å<span class="hljs-params">( argument1, argument2..., argumentn)</span></span><br>    <span class="hljs-comment">-- å‡½æ•°ä½“</span><br>    <span class="hljs-keyword">return</span> è¿”å›å€¼<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ‰“å°æ•°ç»„ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">for</span> index, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-5-æ¡ä»¶æ§åˆ¶"><a href="#5-3-5-æ¡ä»¶æ§åˆ¶" class="headerlink" title="5.3.5 æ¡ä»¶æ§åˆ¶"></a>5.3.5 æ¡ä»¶æ§åˆ¶</h4><p>ç±»ä¼¼Javaçš„æ¡ä»¶æ§åˆ¶ï¼Œä¾‹å¦‚ifã€elseè¯­æ³•ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(å¸ƒå°”è¡¨è¾¾å¼)<br><span class="hljs-keyword">then</span><br>   <span class="hljs-comment">--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º true æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span><br><span class="hljs-keyword">else</span><br>   <span class="hljs-comment">--[ å¸ƒå°”è¡¨è¾¾å¼ä¸º false æ—¶æ‰§è¡Œè¯¥è¯­å¥å— --]</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-6-æ¡ˆä¾‹"><a href="#5-3-6-æ¡ˆä¾‹" class="headerlink" title="5.3.6 æ¡ˆä¾‹"></a>5.3.6 æ¡ˆä¾‹</h4><p>éœ€æ±‚ï¼šè‡ªå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æ‰“å°tableï¼Œå½“å‚æ•°ä¸ºnilæ—¶ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> arr <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;æ•°ç»„ä¸èƒ½ä¸ºç©ºï¼&#x27;</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">for</span> index, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h2 id="6-å®ç°å¤šçº§ç¼“å­˜"><a href="#6-å®ç°å¤šçº§ç¼“å­˜" class="headerlink" title="6. å®ç°å¤šçº§ç¼“å­˜"></a>6. å®ç°å¤šçº§ç¼“å­˜</h2><h3 id="6-1-OpenResty"><a href="#6-1-OpenResty" class="headerlink" title="6.1 OpenResty"></a>6.1 OpenResty</h3><p>å¤šçº§ç¼“å­˜çš„å®ç°ç¦»ä¸å¼€Nginxç¼–ç¨‹ï¼Œè€ŒNginxç¼–ç¨‹åˆç¦»ä¸å¼€OpenResty</p>
<p>OpenRestyÂ® æ˜¯ä¸€ä¸ªåŸºäº Nginxçš„é«˜æ€§èƒ½ Web å¹³å°ï¼Œç”¨äºæ–¹ä¾¿åœ°æ­å»ºèƒ½å¤Ÿå¤„ç†è¶…é«˜å¹¶å‘ã€æ‰©å±•æ€§æé«˜çš„åŠ¨æ€ Web åº”ç”¨ã€Web æœåŠ¡å’ŒåŠ¨æ€ç½‘å…³ã€‚å…·å¤‡ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å…·å¤‡Nginxçš„å®Œæ•´åŠŸèƒ½</li>
<li>åŸºäºLuaè¯­è¨€è¿›è¡Œæ‰©å±•ï¼Œé›†æˆäº†å¤§é‡ç²¾è‰¯çš„ Lua åº“ã€ç¬¬ä¸‰æ–¹æ¨¡å—</li>
<li>å…è®¸ä½¿ç”¨Lua<strong>è‡ªå®šä¹‰ä¸šåŠ¡é€»è¾‘</strong>ã€<strong>è‡ªå®šä¹‰åº“</strong></li>
</ul>
<h3 id="6-2-OpenRestyå¿«é€Ÿå…¥é—¨"><a href="#6-2-OpenRestyå¿«é€Ÿå…¥é—¨" class="headerlink" title="6.2 OpenRestyå¿«é€Ÿå…¥é—¨"></a>6.2 OpenRestyå¿«é€Ÿå…¥é—¨</h3><p>OpenRestyç›‘å¬è¯·æ±‚<br>OpenRestyçš„å¾ˆå¤šåŠŸèƒ½éƒ½ä¾èµ–äºå…¶ç›®å½•ä¸‹çš„Luaåº“ï¼Œéœ€è¦åœ¨nginx.confä¸­æŒ‡å®šä¾èµ–åº“çš„ç›®å½•ï¼Œå¹¶å¯¼å…¥ä¾èµ–ï¼š</p>
<ol>
<li>æ·»åŠ å¯¹OpenRestyçš„Luaæ¨¡å—çš„åŠ è½½<br>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­çš„httpä¸‹é¢ï¼Œæ·»åŠ ä¸‹é¢ä»£ç ï¼š</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#lua æ¨¡å—</span><br><span class="hljs-attribute">lua_package_path</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;<br><span class="hljs-comment">#cæ¨¡å—     </span><br><span class="hljs-attribute">lua_package_cpath</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>ç›‘å¬&#x2F;api&#x2F;itemè·¯å¾„<br>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œåœ¨nginx.confçš„serverä¸‹é¢ï¼Œæ·»åŠ å¯¹&#x2F;api&#x2F;itemè¿™ä¸ªè·¯å¾„çš„ç›‘å¬ï¼š</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span>  /api/item &#123;<br>    <span class="hljs-comment"># é»˜è®¤çš„å“åº”ç±»å‹</span><br>    <span class="hljs-attribute">default_type</span> application/json;<br>    <span class="hljs-comment"># å“åº”ç»“æœç”±lua/item.luaæ–‡ä»¶æ¥å†³å®š</span><br>    <span class="hljs-attribute">content_by_lua_file</span> lua/item.lua;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è¿™ä¸ªç›‘å¬ï¼Œå°±ç±»ä¼¼äºSpringMVCä¸­çš„<code>@GetMapping(&quot;/api/item&quot;)</code>åšè·¯å¾„æ˜ å°„ã€‚<br>è€Œ<code>content_by_lua_file lua/item.lua</code>åˆ™ç›¸å½“äºè°ƒç”¨item.luaè¿™ä¸ªæ–‡ä»¶ï¼Œæ‰§è¡Œå…¶ä¸­çš„ä¸šåŠ¡ï¼ŒæŠŠç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºjavaä¸­è°ƒç”¨serviceã€‚</p>
<ol start="3">
<li>ç¼–å†™item.luaï¼Œè¿”å›å‡æ•°æ®<br>item.luaä¸­ï¼Œåˆ©ç”¨ngx.say()å‡½æ•°è¿”å›æ•°æ®åˆ°Responseä¸­</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">ngx.say(<span class="hljs-string">&#x27;&#123;&quot;id&quot;:10001,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21å¯¸æ‰˜è¿ç®±æ‹‰æ†ç®± SALSA AIRç³»åˆ—æœç»¿è‰² 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;æ‹‰æ†ç®±&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure>


<h3 id="6-3-è¯·æ±‚å‚æ•°å¤„ç†"><a href="#6-3-è¯·æ±‚å‚æ•°å¤„ç†" class="headerlink" title="6.3 è¯·æ±‚å‚æ•°å¤„ç†"></a>6.3 è¯·æ±‚å‚æ•°å¤„ç†</h3><p>è¦è¿”å›çœŸå®æ•°æ®ï¼Œå¿…é¡»æ ¹æ®å‰ç«¯ä¼ é€’æ¥çš„å•†å“idï¼ŒæŸ¥è¯¢å•†å“ä¿¡æ¯æ‰å¯ä»¥ã€‚é‚£ä¹ˆå¦‚ä½•è·å–å‰ç«¯ä¼ é€’çš„å•†å“å‚æ•°å‘¢ï¼Ÿ</p>
<ul>
<li>OpenRestyä¸­æä¾›äº†ä¸€äº›APIç”¨æ¥è·å–ä¸åŒç±»å‹çš„å‰ç«¯è¯·æ±‚å‚æ•°ï¼š</li>
</ul>
<table>
<thead>
<tr>
<th>å‚æ•°æ ¼å¼</th>
<th>å‚æ•°ç¤ºä¾‹</th>
<th>å‚æ•°è§£æä»£ç ç¤ºä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td>è·¯å¾„å ä½ç¬¦</td>
<td><code>/item/1001</code></td>
<td>â€“1.æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…:<br>location ~ &#x2F;item&#x2F;(\d+) {<br>    content_by_lua_file lua&#x2F;item.lua;<br>}<br>â€“ 2. åŒ¹é…åˆ°çš„å‚æ•°ä¼šå­˜å…¥ngx.varæ•°ç»„ä¸­ï¼Œ<br>â€“ å¯ä»¥ç”¨è§’æ ‡è·å–<br>local id &#x3D; ngx.var[1]</td>
</tr>
<tr>
<td>è¯·æ±‚å¤´</td>
<td><code>id: 1001</code></td>
<td>â€“ è·å–è¯·æ±‚å¤´ï¼Œè¿”å›å€¼æ˜¯tableç±»å‹<br>local headers &#x3D; ngx.req.get_headers()</td>
</tr>
<tr>
<td>Getè¯·æ±‚å‚æ•°</td>
<td><code>?id=1001</code></td>
<td>â€“ è·å–GETè¯·æ±‚å‚æ•°ï¼Œè¿”å›å€¼æ˜¯tableç±»å‹<br>local getParams &#x3D; ngx.req.get_url_args()</td>
</tr>
<tr>
<td>Postè¡¨å•å‚æ•°</td>
<td><code>id=1001</code></td>
<td>â€“ è¯»å–è¯·æ±‚ä½“<br>ngx.req.read_body()<br>â€“ è·å–POSTè¡¨å•å‚æ•°ï¼Œè¿”å›å€¼æ˜¯tableç±»å‹<br>local postParams &#x3D; ngx.req.get_post_args()</td>
</tr>
<tr>
<td>JSONå‚æ•°</td>
<td><code>{&quot;id&quot;: 1001}</code></td>
<td>â€“ è¯»å–è¯·æ±‚ä½“<br>ngx.req.read_body()<br>â€“ è·å–bodyä¸­çš„jsonå‚æ•°ï¼Œè¿”å›å€¼æ˜¯stringç±»å‹<br>local jsonBody &#x3D; ngx.req.get_body_data()</td>
</tr>
</tbody></table>
<h3 id="6-4-æŸ¥è¯¢Tomcat"><a href="#6-4-æŸ¥è¯¢Tomcat" class="headerlink" title="6.4 æŸ¥è¯¢Tomcat"></a>6.4 æŸ¥è¯¢Tomcat</h3><p>æ‹¿åˆ°å•†å“IDåï¼Œæœ¬åº”å»ç¼“å­˜ä¸­æŸ¥è¯¢å•†å“ä¿¡æ¯ï¼Œä¸è¿‡ç›®å‰æˆ‘ä»¬è¿˜æœªå»ºç«‹nginxã€redisç¼“å­˜ã€‚å› æ­¤ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ ¹æ®å•†å“idå»tomcatæŸ¥è¯¢å•†å“ä¿¡æ¯</p>
<p><img src="/img/blogs/java/redis/3.6.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="6-4-1-å‘é€httpè¯·æ±‚çš„API"><a href="#6-4-1-å‘é€httpè¯·æ±‚çš„API" class="headerlink" title="6.4.1 å‘é€httpè¯·æ±‚çš„API"></a>6.4.1 å‘é€httpè¯·æ±‚çš„API</h4><p>nginxæä¾›äº†å†…éƒ¨APIç”¨ä»¥å‘é€httpè¯·æ±‚ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-string">&quot;/path&quot;</span>,&#123;<br>    method = ngx.HTTP_GET,   <span class="hljs-comment">-- è¯·æ±‚æ–¹å¼</span><br>    args = &#123;a=<span class="hljs-number">1</span>,b=<span class="hljs-number">2</span>&#125;,  <span class="hljs-comment">-- getæ–¹å¼ä¼ å‚æ•°</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>è¿”å›çš„å“åº”å†…å®¹åŒ…æ‹¬ï¼š</p>
<ul>
<li>resp.statusï¼šå“åº”çŠ¶æ€ç </li>
<li>resp.headerï¼šå“åº”å¤´ï¼Œæ˜¯ä¸€ä¸ªtable</li>
<li>resp.bodyï¼šå“åº”ä½“ï¼Œå°±æ˜¯å“åº”æ•°æ®</li>
</ul>
<h4 id="6-4-2-å°è£…HTTPæŸ¥è¯¢å‡½æ•°"><a href="#6-4-2-å°è£…HTTPæŸ¥è¯¢å‡½æ•°" class="headerlink" title="6.4.2 å°è£…HTTPæŸ¥è¯¢å‡½æ•°"></a>6.4.2 å°è£…HTTPæŸ¥è¯¢å‡½æ•°</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å°è£…å‡½æ•°ï¼Œå‘é€httpè¯·æ±‚ï¼Œå¹¶è§£æå“åº”</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_http</span><span class="hljs-params">(path, params)</span></span><br>    <span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-built_in">path</span>,&#123;<br>        method = ngx.HTTP_GET,<br>        args = params,<br>    &#125;)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- è®°å½•é”™è¯¯ä¿¡æ¯ï¼Œè¿”å›404</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;httpè¯·æ±‚æŸ¥è¯¢å¤±è´¥, path: &quot;</span>, <span class="hljs-built_in">path</span> , <span class="hljs-string">&quot;, args: &quot;</span>, args)<br>        ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">404</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp.body<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- å°†æ–¹æ³•å¯¼å‡º</span><br><span class="hljs-keyword">local</span> _M = &#123;  <br>    read_http = read_http<br>&#125;  <br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure>

<h4 id="6-4-3-å®ç°å•†å“æŸ¥è¯¢"><a href="#6-4-3-å®ç°å•†å“æŸ¥è¯¢" class="headerlink" title="6.4.3 å®ç°å•†å“æŸ¥è¯¢"></a>6.4.3 å®ç°å•†å“æŸ¥è¯¢</h4><p>æœ€åï¼Œæˆ‘ä»¬ä¿®æ”¹<code>/usr/local/openresty/lua/item.lua</code>æ–‡ä»¶ï¼Œåˆ©ç”¨åˆšåˆšå°è£…çš„å‡½æ•°åº“å®ç°å¯¹tomcatçš„æŸ¥è¯¢ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å¼•å…¥è‡ªå®šä¹‰commonå·¥å…·æ¨¡å—ï¼Œè¿”å›å€¼æ˜¯commonä¸­è¿”å›çš„ _M</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;common&quot;</span>)<br><span class="hljs-comment">-- ä» commonä¸­è·å–read_httpè¿™ä¸ªå‡½æ•°</span><br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-comment">-- è·å–è·¯å¾„å‚æ•°</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- æ ¹æ®idæŸ¥è¯¢å•†å“</span><br><span class="hljs-keyword">local</span> itemJSON = read_http(<span class="hljs-string">&quot;/item/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span><br><span class="hljs-keyword">local</span> itemStockJSON = read_http(<span class="hljs-string">&quot;/item/stock/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br></code></pre></td></tr></table></figure>

<h4 id="6-4-4-CJSONå·¥å…·ç±»"><a href="#6-4-4-CJSONå·¥å…·ç±»" class="headerlink" title="6.4.4 CJSONå·¥å…·ç±»"></a>6.4.4 CJSONå·¥å…·ç±»</h4><p>OpenRestyæä¾›äº†ä¸€ä¸ªcjsonçš„æ¨¡å—ç”¨æ¥å¤„ç†JSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<ol>
<li>å¼•å…¥cjsonæ¨¡å—ï¼š</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;cjson&quot;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>åºåˆ—åŒ–ï¼š</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> obj = &#123;<br>    name = <span class="hljs-string">&#x27;jack&#x27;</span>,<br>    age = <span class="hljs-number">21</span><br>&#125;<br><span class="hljs-comment">-- æŠŠ table åºåˆ—åŒ–ä¸º json</span><br><span class="hljs-keyword">local</span> json = cjson.encode(obj)<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ååºåˆ—åŒ–ï¼š</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> json = <span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;jack&quot;, &quot;age&quot;: 21&#125;&#x27;</span><br><span class="hljs-comment">-- ååºåˆ—åŒ– jsonä¸º table</span><br><span class="hljs-keyword">local</span> obj = cjson.decode(json);<br><span class="hljs-built_in">print</span>(obj.name)<br></code></pre></td></tr></table></figure>


<h4 id="6-4-5-å®ç°TomcatæŸ¥è¯¢"><a href="#6-4-5-å®ç°TomcatæŸ¥è¯¢" class="headerlink" title="6.4.5 å®ç°TomcatæŸ¥è¯¢"></a>6.4.5 å®ç°TomcatæŸ¥è¯¢</h4><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¹‹å‰çš„item.luaä¸­çš„ä¸šåŠ¡ï¼Œæ·»åŠ jsonå¤„ç†åŠŸèƒ½ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å¯¼å…¥commonå‡½æ•°åº“</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-comment">-- å¯¼å…¥cjsonåº“</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><span class="hljs-comment">-- è·å–è·¯å¾„å‚æ•°</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- æ ¹æ®idæŸ¥è¯¢å•†å“</span><br><span class="hljs-keyword">local</span> itemJSON = read_http(<span class="hljs-string">&quot;/item/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- æ ¹æ®idæŸ¥è¯¢å•†å“åº“å­˜</span><br><span class="hljs-keyword">local</span> itemStockJSON = read_http(<span class="hljs-string">&quot;/item/stock/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONè½¬åŒ–ä¸ºluaçš„table</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><br><span class="hljs-comment">-- ç»„åˆæ•°æ®</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>


<h4 id="6-4-6-åŸºäºIDè´Ÿè½½å‡è¡¡"><a href="#6-4-6-åŸºäºIDè´Ÿè½½å‡è¡¡" class="headerlink" title="6.4.6 åŸºäºIDè´Ÿè½½å‡è¡¡"></a>6.4.6 åŸºäºIDè´Ÿè½½å‡è¡¡</h4><p>æˆ‘ä»¬çš„tomcatæ˜¯å•æœºéƒ¨ç½²ã€‚è€Œå®é™…å¼€å‘ä¸­ï¼Œtomcatä¸€å®šæ˜¯é›†ç¾¤æ¨¡å¼</p>
<p><img src="/img/blogs/java/redis/3.6.2.png" srcset="/img/loading.gif" lazyload></p>
<p>OpenRestyéœ€è¦å¯¹tomcaté›†ç¾¤åšè´Ÿè½½å‡è¡¡ã€‚</p>
<p>è€Œé»˜è®¤çš„è´Ÿè½½å‡è¡¡è§„åˆ™æ˜¯è½®è¯¢æ¨¡å¼ï¼Œå½“æˆ‘ä»¬æŸ¥è¯¢&#x2F;item&#x2F;10001æ—¶ï¼š</p>
<ul>
<li>ç¬¬ä¸€æ¬¡ä¼šè®¿é—®8081ç«¯å£çš„tomcatæœåŠ¡ï¼Œåœ¨è¯¥æœåŠ¡å†…éƒ¨å°±å½¢æˆäº†JVMè¿›ç¨‹ç¼“å­˜</li>
<li>ç¬¬äºŒæ¬¡ä¼šè®¿é—®8082ç«¯å£çš„tomcatæœåŠ¡ï¼Œè¯¥æœåŠ¡å†…éƒ¨æ²¡æœ‰JVMç¼“å­˜ï¼ˆå› ä¸ºJVMç¼“å­˜æ— æ³•å…±äº«ï¼‰ï¼Œä¼šæŸ¥è¯¢æ•°æ®åº“</li>
</ul>
<h5 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h5><p>ä¿®æ”¹<code>/usr/local/openresty/nginx/conf/nginx.conf</code>æ–‡ä»¶ï¼Œå®ç°åŸºäºIDåšè´Ÿè½½å‡è¡¡ã€‚<br>é¦–å…ˆï¼Œå®šä¹‰tomcaté›†ç¾¤ï¼Œå¹¶è®¾ç½®åŸºäºè·¯å¾„åšè´Ÿè½½å‡è¡¡ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> tomcat-cluster &#123;<br>    <span class="hljs-attribute">hash</span> <span class="hljs-variable">$request_uri</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.150.1:8081</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.150.1:8082</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶åï¼Œä¿®æ”¹å¯¹tomcatæœåŠ¡çš„åå‘ä»£ç†ï¼Œç›®æ ‡æŒ‡å‘tomcaté›†ç¾¤ï¼š</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /item &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://tomcat-cluster;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="6-5-Redisç¼“å­˜é¢„çƒ­"><a href="#6-5-Redisç¼“å­˜é¢„çƒ­" class="headerlink" title="6.5 Redisç¼“å­˜é¢„çƒ­"></a>6.5 Redisç¼“å­˜é¢„çƒ­</h3><p><img src="/img/blogs/java/redis/3.6.3.png" srcset="/img/loading.gif" lazyload></p>
<p>Redisç¼“å­˜ä¼šé¢ä¸´å†·å¯åŠ¨é—®é¢˜ï¼š</p>
<ul>
<li><strong>å†·å¯åŠ¨</strong>ï¼šæœåŠ¡åˆšåˆšå¯åŠ¨æ—¶ï¼ŒRedisä¸­å¹¶æ²¡æœ‰ç¼“å­˜ï¼Œå¦‚æœæ‰€æœ‰å•†å“æ•°æ®éƒ½åœ¨ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ—¶æ·»åŠ ç¼“å­˜ï¼Œå¯èƒ½ä¼šç»™æ•°æ®åº“å¸¦æ¥è¾ƒå¤§å‹åŠ›ã€‚</li>
<li><strong>ç¼“å­˜é¢„çƒ­</strong>ï¼šåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨å¤§æ•°æ®ç»Ÿè®¡ç”¨æˆ·è®¿é—®çš„çƒ­ç‚¹æ•°æ®ï¼Œåœ¨é¡¹ç›®å¯åŠ¨æ—¶å°†è¿™äº›çƒ­ç‚¹æ•°æ®æå‰æŸ¥è¯¢å¹¶ä¿å­˜åˆ°Redisä¸­ã€‚</li>
<li>æˆ‘ä»¬æ•°æ®é‡è¾ƒå°‘ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ç»Ÿè®¡ç›¸å…³åŠŸèƒ½ï¼Œç›®å‰å¯ä»¥åœ¨å¯åŠ¨æ—¶å°†æ‰€æœ‰æ•°æ®éƒ½æ”¾å…¥ç¼“å­˜ä¸­ã€‚</li>
</ul>
<p>ç¼“å­˜é¢„çƒ­éœ€è¦åœ¨é¡¹ç›®å¯åŠ¨æ—¶å®Œæˆï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æ‹¿åˆ°RedisTemplateä¹‹åã€‚<br>è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨InitializingBeanæ¥å£æ¥å®ç°ï¼Œå› ä¸ºInitializingBeanå¯ä»¥åœ¨å¯¹è±¡è¢«Springåˆ›å»ºå¹¶ä¸”æˆå‘˜å˜é‡å…¨éƒ¨æ³¨å…¥åæ‰§è¡Œã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">MAPPER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ–ç¼“å­˜</span><br>        <span class="hljs-comment">// 1.æŸ¥è¯¢å•†å“ä¿¡æ¯</span><br>        List&lt;Item&gt; itemList = itemService.list();<br>        <span class="hljs-comment">// 2.æ”¾å…¥ç¼“å­˜</span><br>        <span class="hljs-keyword">for</span> (Item item : itemList) &#123;<br>            <span class="hljs-comment">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(item);<br>            <span class="hljs-comment">// 2.2.å­˜å…¥redis</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span> + item.getId(), json);<br>        &#125;<br><br>        <span class="hljs-comment">// 3.æŸ¥è¯¢å•†å“åº“å­˜ä¿¡æ¯</span><br>        List&lt;ItemStock&gt; stockList = stockService.list();<br>        <span class="hljs-comment">// 4.æ”¾å…¥ç¼“å­˜</span><br>        <span class="hljs-keyword">for</span> (ItemStock stock : stockList) &#123;<br>            <span class="hljs-comment">// 2.1.itemåºåˆ—åŒ–ä¸ºJSON</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(stock);<br>            <span class="hljs-comment">// 2.2.å­˜å…¥redis</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span> + stock.getId(), json);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="6-6-æŸ¥è¯¢Redisç¼“å­˜"><a href="#6-6-æŸ¥è¯¢Redisç¼“å­˜" class="headerlink" title="6.6 æŸ¥è¯¢Redisç¼“å­˜"></a>6.6 æŸ¥è¯¢Redisç¼“å­˜</h3><p>å½“è¯·æ±‚è¿›å…¥OpenRestyä¹‹åï¼š</p>
<ul>
<li>ä¼˜å…ˆæŸ¥è¯¢Redisç¼“å­˜</li>
<li>å¦‚æœRedisç¼“å­˜æœªå‘½ä¸­ï¼Œå†æŸ¥è¯¢Tomcat</li>
</ul>
<p>ä¿®æ”¹item.luaæ–‡ä»¶ï¼Œå®ç°å¯¹Redisçš„æŸ¥è¯¢ï¼ŒæŸ¥è¯¢é€»è¾‘æ˜¯ï¼š</p>
<ul>
<li>æ ¹æ®idæŸ¥è¯¢Redis</li>
<li>å¦‚æœæŸ¥è¯¢å¤±è´¥åˆ™ç»§ç»­æŸ¥è¯¢Tomcat</li>
<li>å°†æŸ¥è¯¢ç»“æœè¿”å›</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å¯¼å…¥commonå‡½æ•°åº“</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-keyword">local</span> read_redis = common.read_redis<br><span class="hljs-comment">-- å¯¼å…¥cjsonåº“</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><span class="hljs-comment">-- å°è£…æŸ¥è¯¢å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, path, params)</span></span><br>    <span class="hljs-comment">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span><br>    <span class="hljs-keyword">local</span> val = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>    <span class="hljs-comment">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &quot;</span>, key)<br>        <span class="hljs-comment">-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span><br>        val = read_http(<span class="hljs-built_in">path</span>, params)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- è¿”å›æ•°æ®</span><br>    <span class="hljs-keyword">return</span> val<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- è·å–è·¯å¾„å‚æ•°</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span><br><span class="hljs-keyword">local</span> itemJSON = read_data(<span class="hljs-string">&quot;item:id:&quot;</span> .. id,  <span class="hljs-string">&quot;/item/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span><br><span class="hljs-keyword">local</span> stockJSON = read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span> .. id, <span class="hljs-string">&quot;/item/stock/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONè½¬åŒ–ä¸ºluaçš„table</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><span class="hljs-comment">-- ç»„åˆæ•°æ®</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>

<h3 id="6-7-Nginxæœ¬åœ°ç¼“å­˜"><a href="#6-7-Nginxæœ¬åœ°ç¼“å­˜" class="headerlink" title="6.7 Nginxæœ¬åœ°ç¼“å­˜"></a>6.7 Nginxæœ¬åœ°ç¼“å­˜</h3><p><img src="/img/blogs/java/redis/3.6.4.png" srcset="/img/loading.gif" lazyload></p>
<p>OpenRestyä¸ºNginxæä¾›äº†<strong>shard dict</strong>çš„åŠŸèƒ½ï¼Œå¯ä»¥åœ¨nginxçš„å¤šä¸ªworkerä¹‹é—´å…±äº«æ•°æ®ï¼Œå®ç°ç¼“å­˜åŠŸèƒ½ã€‚</p>
<ol>
<li>å¼€å¯å…±äº«å­—å…¸ï¼Œåœ¨nginx.confçš„httpä¸‹æ·»åŠ é…ç½®ï¼š</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># å…±äº«å­—å…¸ï¼Œä¹Ÿå°±æ˜¯æœ¬åœ°ç¼“å­˜ï¼Œåç§°å«åšï¼šitem_cacheï¼Œå¤§å°150m</span><br><span class="hljs-attribute">lua_shared_dict</span> item_cache <span class="hljs-number">150m</span>; <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>æ“ä½œå…±äº«å­—å…¸ï¼š</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- è·å–æœ¬åœ°ç¼“å­˜å¯¹è±¡</span><br><span class="hljs-keyword">local</span> item_cache = ngx.shared.item_cache<br><span class="hljs-comment">-- å­˜å‚¨, æŒ‡å®škeyã€valueã€è¿‡æœŸæ—¶é—´ï¼Œå•ä½sï¼Œé»˜è®¤ä¸º0ä»£è¡¨æ°¸ä¸è¿‡æœŸ</span><br>item_cache:set(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>, <span class="hljs-number">1000</span>)<br><span class="hljs-comment">-- è¯»å–</span><br><span class="hljs-keyword">local</span> val = item_cache:get(<span class="hljs-string">&#x27;key&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h4 id="å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢"><a href="#å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢" class="headerlink" title="å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢"></a>å®ç°æœ¬åœ°ç¼“å­˜æŸ¥è¯¢</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- å¯¼å…¥commonå‡½æ•°åº“</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-keyword">local</span> read_redis = common.read_redis<br><span class="hljs-comment">-- å¯¼å…¥cjsonåº“</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><span class="hljs-comment">-- å¯¼å…¥å…±äº«è¯å…¸ï¼Œæœ¬åœ°ç¼“å­˜</span><br><span class="hljs-keyword">local</span> item_cache = ngx.shared.item_cache<br><br><span class="hljs-comment">-- å°è£…æŸ¥è¯¢å‡½æ•°</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, expire, path, params)</span></span><br>    <span class="hljs-comment">-- æŸ¥è¯¢æœ¬åœ°ç¼“å­˜</span><br>    <span class="hljs-keyword">local</span> val = item_cache:get(key)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;æœ¬åœ°ç¼“å­˜æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢Redisï¼Œ key: &quot;</span>, key)<br>        <span class="hljs-comment">-- æŸ¥è¯¢redis</span><br>        val = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>        <span class="hljs-comment">-- åˆ¤æ–­æŸ¥è¯¢ç»“æœ</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>            ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æŸ¥è¯¢httpï¼Œ key: &quot;</span>, key)<br>            <span class="hljs-comment">-- redisæŸ¥è¯¢å¤±è´¥ï¼Œå»æŸ¥è¯¢http</span><br>            val = read_http(<span class="hljs-built_in">path</span>, params)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- æŸ¥è¯¢æˆåŠŸï¼ŒæŠŠæ•°æ®å†™å…¥æœ¬åœ°ç¼“å­˜</span><br>    item_cache:set(key, val, expire)<br>    <span class="hljs-comment">-- è¿”å›æ•°æ®</span><br>    <span class="hljs-keyword">return</span> val<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- è·å–è·¯å¾„å‚æ•°</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- æŸ¥è¯¢å•†å“ä¿¡æ¯</span><br><span class="hljs-keyword">local</span> itemJSON = read_data(<span class="hljs-string">&quot;item:id:&quot;</span> .. id, <span class="hljs-number">1800</span>,  <span class="hljs-string">&quot;/item/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- æŸ¥è¯¢åº“å­˜ä¿¡æ¯</span><br><span class="hljs-keyword">local</span> stockJSON = read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span> .. id, <span class="hljs-number">60</span>, <span class="hljs-string">&quot;/item/stock/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONè½¬åŒ–ä¸ºluaçš„table</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><span class="hljs-comment">-- ç»„åˆæ•°æ®</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- æŠŠitemåºåˆ—åŒ–ä¸ºjson è¿”å›ç»“æœ</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>

<h2 id="7-ç¼“å­˜åŒæ­¥"><a href="#7-ç¼“å­˜åŒæ­¥" class="headerlink" title="7. ç¼“å­˜åŒæ­¥"></a>7. ç¼“å­˜åŒæ­¥</h2><p>æˆ‘ä»¬å¿…é¡»ä¿è¯æ•°æ®åº“æ•°æ®ã€ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸æ•°æ®åº“çš„åŒæ­¥</p>
<h3 id="7-1-æ•°æ®åŒæ­¥ç­–ç•¥"><a href="#7-1-æ•°æ®åŒæ­¥ç­–ç•¥" class="headerlink" title="7.1 æ•°æ®åŒæ­¥ç­–ç•¥"></a>7.1 æ•°æ®åŒæ­¥ç­–ç•¥</h3><p>ç¼“å­˜æ•°æ®åŒæ­¥çš„å¸¸è§æ–¹å¼æœ‰ä¸‰ç§ï¼š</p>
<p><strong>è®¾ç½®æœ‰æ•ˆæœŸ</strong>ï¼šç»™ç¼“å­˜è®¾ç½®æœ‰æ•ˆæœŸï¼Œåˆ°æœŸåè‡ªåŠ¨åˆ é™¤ã€‚å†æ¬¡æŸ¥è¯¢æ—¶æ›´æ–°</p>
<ul>
<li>ä¼˜åŠ¿ï¼šç®€å•ã€æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§å·®ï¼Œç¼“å­˜è¿‡æœŸä¹‹å‰å¯èƒ½ä¸ä¸€è‡´</li>
<li>åœºæ™¯ï¼šæ›´æ–°é¢‘ç‡è¾ƒä½ï¼Œæ—¶æ•ˆæ€§è¦æ±‚ä½çš„ä¸šåŠ¡</li>
</ul>
<p><strong>åŒæ­¥åŒå†™</strong>ï¼šåœ¨ä¿®æ”¹æ•°æ®åº“çš„åŒæ—¶ï¼Œç›´æ¥ä¿®æ”¹ç¼“å­˜</p>
<ul>
<li>ä¼˜åŠ¿ï¼šæ—¶æ•ˆæ€§å¼ºï¼Œç¼“å­˜ä¸æ•°æ®åº“å¼ºä¸€è‡´</li>
<li>ç¼ºç‚¹ï¼šæœ‰ä»£ç ä¾µå…¥ï¼Œè€¦åˆåº¦é«˜ï¼›</li>
<li>åœºæ™¯ï¼šå¯¹ä¸€è‡´æ€§ã€æ—¶æ•ˆæ€§è¦æ±‚è¾ƒé«˜çš„ç¼“å­˜æ•°æ®</li>
</ul>
<p>**å¼‚æ­¥é€šçŸ¥ï¼š**ä¿®æ”¹æ•°æ®åº“æ—¶å‘é€äº‹ä»¶é€šçŸ¥ï¼Œç›¸å…³æœåŠ¡ç›‘å¬åˆ°é€šçŸ¥åä¿®æ”¹ç¼“å­˜æ•°æ®</p>
<ul>
<li>ä¼˜åŠ¿ï¼šä½è€¦åˆï¼Œå¯ä»¥åŒæ—¶é€šçŸ¥å¤šä¸ªç¼“å­˜æœåŠ¡</li>
<li>ç¼ºç‚¹ï¼šæ—¶æ•ˆæ€§ä¸€èˆ¬ï¼Œå¯èƒ½å­˜åœ¨ä¸­é—´ä¸ä¸€è‡´çŠ¶æ€</li>
<li>åœºæ™¯ï¼šæ—¶æ•ˆæ€§è¦æ±‚ä¸€èˆ¬ï¼Œæœ‰å¤šä¸ªæœåŠ¡éœ€è¦åŒæ­¥</li>
</ul>
<p><strong>å¼‚æ­¥å®ç°ï¼šåŸºäºCanalçš„é€šçŸ¥</strong>ï¼š</p>
<ul>
<li>å•†å“æœåŠ¡å®Œæˆå•†å“ä¿®æ”¹åï¼Œä¸šåŠ¡ç›´æ¥ç»“æŸï¼Œæ²¡æœ‰ä»»ä½•ä»£ç ä¾µå…¥</li>
<li>Canalç›‘å¬MySQLå˜åŒ–ï¼Œå½“å‘ç°å˜åŒ–åï¼Œç«‹å³é€šçŸ¥ç¼“å­˜æœåŠ¡</li>
<li>ç¼“å­˜æœåŠ¡æ¥æ”¶åˆ°canalé€šçŸ¥ï¼Œæ›´æ–°ç¼“å­˜</li>
</ul>
<p><img src="/img/blogs/java/redis/3.7.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="7-2-Canal"><a href="#7-2-Canal" class="headerlink" title="7.2 Canal"></a>7.2 Canal</h3><p><strong>Canal</strong>ï¼Œè¯‘æ„ä¸ºæ°´é“&#x2F;ç®¡é“&#x2F;æ²Ÿæ¸ ï¼Œcanalæ˜¯é˜¿é‡Œå·´å·´æ——ä¸‹çš„ä¸€æ¬¾å¼€æºé¡¹ç›®ï¼ŒåŸºäºJavaå¼€å‘ã€‚åŸºäºæ•°æ®åº“å¢é‡æ—¥å¿—è§£æï¼Œæä¾›å¢é‡æ•°æ®è®¢é˜…&amp;æ¶ˆè´¹ã€‚</p>
<p>Canalæ˜¯åŸºäºmysqlçš„ä¸»ä»åŒæ­¥æ¥å®ç°çš„ï¼ŒMySQLä¸»ä»åŒæ­¥çš„åŸç†å¦‚ä¸‹ï¼š</p>
<p><img src="/img/blogs/java/redis/3.7.2.png" srcset="/img/loading.gif" lazyload></p>
<p>è€ŒCanalå°±æ˜¯æŠŠè‡ªå·±ä¼ªè£…æˆMySQLçš„ä¸€ä¸ªslaveèŠ‚ç‚¹ï¼Œä»è€Œç›‘å¬masterçš„binary logå˜åŒ–ã€‚å†æŠŠå¾—åˆ°çš„å˜åŒ–ä¿¡æ¯é€šçŸ¥ç»™Canalçš„å®¢æˆ·ç«¯ï¼Œè¿›è€Œå®Œæˆå¯¹å…¶å®ƒæ•°æ®åº“çš„åŒæ­¥ã€‚</p>
<h3 id="7-3-ç›‘å¬Canal"><a href="#7-3-ç›‘å¬Canal" class="headerlink" title="7.3 ç›‘å¬Canal"></a>7.3 ç›‘å¬Canal</h3><p>Canalæä¾›äº†å„ç§è¯­è¨€çš„å®¢æˆ·ç«¯ï¼Œå½“Canalç›‘å¬åˆ°binlogå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥Canalçš„å®¢æˆ·ç«¯ã€‚</p>
<p><img src="/img/blogs/java/redis/3.7.3.png" srcset="/img/loading.gif" lazyload></p>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨Canalæä¾›çš„Javaå®¢æˆ·ç«¯ï¼Œç›‘å¬Canalé€šçŸ¥æ¶ˆæ¯ã€‚å½“æ”¶åˆ°å˜åŒ–çš„æ¶ˆæ¯æ—¶ï¼Œå®Œæˆå¯¹ç¼“å­˜çš„æ›´æ–°ã€‚</p>
<h5 id="ç¼–å†™ç›‘å¬å™¨"><a href="#ç¼–å†™ç›‘å¬å™¨" class="headerlink" title="ç¼–å†™ç›‘å¬å™¨"></a>ç¼–å†™ç›‘å¬å™¨</h5><p>é€šè¿‡å®ç°<code>EntryHandler&lt;T&gt;</code>æ¥å£ç¼–å†™ç›‘å¬å™¨ï¼Œç›‘å¬Canalæ¶ˆæ¯ã€‚æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li>å®ç°ç±»é€šè¿‡<code>@CanalTable(&quot;tb_item&quot;)</code>æŒ‡å®šç›‘å¬çš„è¡¨ä¿¡æ¯</li>
<li>EntryHandlerçš„æ³›å‹æ˜¯ä¸è¡¨å¯¹åº”çš„å®ä½“ç±»</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CanalTable(&quot;tb_item&quot;)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntryHandler</span>&lt;Item&gt; &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisHandler redisHandler;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span><br>        itemCache.put(item.getId(), item);<br>        <span class="hljs-comment">// å†™æ•°æ®åˆ°redis</span><br>        redisHandler.saveItem(item);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Item before, Item after)</span> &#123;<br>        <span class="hljs-comment">// å†™æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span><br>        itemCache.put(after.getId(), after);<br>        <span class="hljs-comment">// å†™æ•°æ®åˆ°redis</span><br>        redisHandler.saveItem(after);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// åˆ é™¤æ•°æ®åˆ°JVMè¿›ç¨‹ç¼“å­˜</span><br>        itemCache.invalidate(item.getId());<br>        <span class="hljs-comment">// åˆ é™¤æ•°æ®åˆ°redis</span><br>        redisHandler.deleteItemById(item.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="8-å¤šçº§ç¼“å­˜æ€»ç»“"><a href="#8-å¤šçº§ç¼“å­˜æ€»ç»“" class="headerlink" title="8. å¤šçº§ç¼“å­˜æ€»ç»“"></a>8. å¤šçº§ç¼“å­˜æ€»ç»“</h2><p><img src="/img/blogs/java/redis/3.8.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="9-Redisæœ€ä½³å®è·µ"><a href="#9-Redisæœ€ä½³å®è·µ" class="headerlink" title="9. Redisæœ€ä½³å®è·µ"></a>9. Redisæœ€ä½³å®è·µ</h2><h3 id="9-1-Redisé”®å€¼è®¾è®¡"><a href="#9-1-Redisé”®å€¼è®¾è®¡" class="headerlink" title="9.1 Redisé”®å€¼è®¾è®¡"></a>9.1 Redisé”®å€¼è®¾è®¡</h3><h4 id="9-1-1-ä¼˜é›…çš„keyç»“æ„"><a href="#9-1-1-ä¼˜é›…çš„keyç»“æ„" class="headerlink" title="9.1.1 ä¼˜é›…çš„keyç»“æ„"></a>9.1.1 ä¼˜é›…çš„keyç»“æ„</h4><p>Redisçš„Keyè™½ç„¶å¯ä»¥è‡ªå®šä¹‰ï¼Œä½†æœ€å¥½éµå¾ªä¸‹é¢çš„å‡ ä¸ªæœ€ä½³å®è·µçº¦å®šï¼š</p>
<ul>
<li>éµå¾ªåŸºæœ¬æ ¼å¼ï¼š<code>[ä¸šåŠ¡åç§°]:[æ•°æ®å]:[id]</code></li>
<li>é•¿åº¦ä¸è¶…è¿‡44å­—èŠ‚</li>
<li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li>
</ul>
<p><img src="/img/blogs/java/redis/3.9.1.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™æ ·è®¾è®¡çš„å¥½å¤„ï¼š</p>
<ul>
<li>å¯è¯»æ€§å¼º</li>
<li>é¿å…keyå†²çª</li>
<li>æ–¹ä¾¿ç®¡ç†</li>
<li>æ›´èŠ‚çœå†…å­˜</li>
</ul>
<h4 id="9-1-2-æ‹’ç»BigKey"><a href="#9-1-2-æ‹’ç»BigKey" class="headerlink" title="9.1.2 æ‹’ç»BigKey"></a>9.1.2 æ‹’ç»BigKey</h4><h5 id="9-1-2-1-BigKey"><a href="#9-1-2-1-BigKey" class="headerlink" title="9.1.2.1 BigKey"></a>9.1.2.1 BigKey</h5><p>BigKeyé€šå¸¸ä»¥Keyçš„å¤§å°å’ŒKeyä¸­æˆå‘˜çš„æ•°é‡æ¥ç»¼åˆåˆ¤å®šï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>Keyæœ¬èº«çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªStringç±»å‹çš„Keyï¼Œå®ƒçš„å€¼ä¸º5 MB</li>
<li>Keyä¸­çš„æˆå‘˜æ•°è¿‡å¤šï¼šä¸€ä¸ªZSETç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡ä¸º10,000ä¸ª</li>
<li>Keyä¸­æˆå‘˜çš„æ•°æ®é‡è¿‡å¤§ï¼šä¸€ä¸ªHashç±»å‹çš„Keyï¼Œå®ƒçš„æˆå‘˜æ•°é‡è™½ç„¶åªæœ‰1,000ä¸ªä½†è¿™äº›æˆå‘˜çš„Valueï¼ˆå€¼ï¼‰æ€»å¤§å°ä¸º100 MB</li>
</ul>
<p>æ¨èå€¼ï¼š</p>
<ul>
<li>å•ä¸ªkeyçš„valueå°äº10KB</li>
<li>å¯¹äºé›†åˆç±»å‹çš„keyï¼Œå»ºè®®å…ƒç´ æ•°é‡å°äº1000</li>
</ul>
<h5 id="9-1-2-2-BigKeyçš„å±å®³"><a href="#9-1-2-2-BigKeyçš„å±å®³" class="headerlink" title="9.1.2.2 BigKeyçš„å±å®³"></a>9.1.2.2 BigKeyçš„å±å®³</h5><ul>
<li>ç½‘ç»œé˜»å¡<ul>
<li>å¯¹BigKeyæ‰§è¡Œè¯»è¯·æ±‚æ—¶ï¼Œå°‘é‡çš„QPSå°±å¯èƒ½å¯¼è‡´å¸¦å®½ä½¿ç”¨ç‡è¢«å æ»¡ï¼Œå¯¼è‡´Rediså®ä¾‹ï¼Œä¹ƒè‡³æ‰€åœ¨ç‰©ç†æœºå˜æ…¢</li>
</ul>
</li>
<li>æ•°æ®å€¾æ–œ<ul>
<li>BigKeyæ‰€åœ¨çš„Rediså®ä¾‹å†…å­˜ä½¿ç”¨ç‡è¿œè¶…å…¶ä»–å®ä¾‹ï¼Œæ— æ³•ä½¿æ•°æ®åˆ†ç‰‡çš„å†…å­˜èµ„æºè¾¾åˆ°å‡è¡¡</li>
</ul>
</li>
<li>Redisé˜»å¡<ul>
<li>å¯¹å…ƒç´ è¾ƒå¤šçš„hashã€listã€zsetç­‰åšè¿ç®—ä¼šè€—æ—¶è¾ƒæ—§ï¼Œä½¿ä¸»çº¿ç¨‹è¢«é˜»å¡</li>
</ul>
</li>
<li>CPUå‹åŠ›<ul>
<li>å¯¹BigKeyçš„æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–ä¼šå¯¼è‡´CPUçš„ä½¿ç”¨ç‡é£™å‡ï¼Œå½±å“Rediså®ä¾‹å’Œæœ¬æœºå…¶å®ƒåº”ç”¨</li>
</ul>
</li>
</ul>
<h5 id="9-1-2-3-å¦‚ä½•å‘ç°BigKey"><a href="#9-1-2-3-å¦‚ä½•å‘ç°BigKey" class="headerlink" title="9.1.2.3 å¦‚ä½•å‘ç°BigKey"></a>9.1.2.3 å¦‚ä½•å‘ç°BigKey</h5><ul>
<li><strong>redis-cli â€“bigkeys</strong><ul>
<li>åˆ©ç”¨redis-cliæä¾›çš„â€“bigkeyså‚æ•°ï¼Œå¯ä»¥éå†åˆ†ææ‰€æœ‰keyï¼Œå¹¶è¿”å›Keyçš„æ•´ä½“ç»Ÿè®¡ä¿¡æ¯ä¸æ¯ä¸ªæ•°æ®çš„Top1çš„big key</li>
</ul>
</li>
<li><strong>scanæ‰«æ</strong><ul>
<li>è‡ªå·±ç¼–ç¨‹ï¼Œåˆ©ç”¨scanæ‰«æRedisä¸­çš„æ‰€æœ‰keyï¼Œåˆ©ç”¨strlenã€hlenç­‰å‘½ä»¤åˆ¤æ–­keyçš„é•¿åº¦ï¼ˆæ­¤å¤„ä¸å»ºè®®ä½¿ç”¨MEMORY USAGEï¼‰</li>
</ul>
</li>
<li><strong>ç¬¬ä¸‰æ–¹å·¥å…·</strong><ul>
<li>åˆ©ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå¦‚ Redis-Rdb-Tools åˆ†æRDBå¿«ç…§æ–‡ä»¶ï¼Œå…¨é¢åˆ†æå†…å­˜ä½¿ç”¨æƒ…å†µ</li>
</ul>
</li>
<li><strong>ç½‘ç»œç›‘æ§</strong><ul>
<li>è‡ªå®šä¹‰å·¥å…·ï¼Œç›‘æ§è¿›å‡ºRedisçš„ç½‘ç»œæ•°æ®ï¼Œè¶…å‡ºé¢„è­¦å€¼æ—¶ä¸»åŠ¨å‘Šè­¦</li>
</ul>
</li>
</ul>
<h5 id="9-1-2-4-å¦‚ä½•åˆ é™¤BigKey"><a href="#9-1-2-4-å¦‚ä½•åˆ é™¤BigKey" class="headerlink" title="9.1.2.4 å¦‚ä½•åˆ é™¤BigKey"></a>9.1.2.4 å¦‚ä½•åˆ é™¤BigKey</h5><p>BigKeyå†…å­˜å ç”¨è¾ƒå¤šï¼Œå³ä¾¿æ—¶åˆ é™¤è¿™æ ·çš„keyä¹Ÿéœ€è¦è€—è´¹å¾ˆé•¿æ—¶é—´ï¼Œå¯¼è‡´Redisä¸»çº¿ç¨‹é˜»å¡ï¼Œå¼•å‘ä¸€ç³»åˆ—é—®é¢˜ã€‚</p>
<ul>
<li>redis 3.0 åŠä»¥ä¸‹ç‰ˆæœ¬<ul>
<li>å¦‚æœæ˜¯é›†åˆç±»å‹ï¼Œåˆ™éå†BigKeyçš„å…ƒç´ ï¼Œå…ˆé€ä¸ªåˆ é™¤å­å…ƒç´ ï¼Œæœ€ååˆ é™¤BigKey</li>
</ul>
</li>
<li>Redis 4.0ä»¥å<ul>
<li>Redisåœ¨4.0åæä¾›äº†å¼‚æ­¥åˆ é™¤çš„å‘½ä»¤ï¼šunlink</li>
</ul>
</li>
</ul>
<h4 id="9-1-3-æ°å½“çš„æ•°æ®ç±»å‹"><a href="#9-1-3-æ°å½“çš„æ•°æ®ç±»å‹" class="headerlink" title="9.1.3 æ°å½“çš„æ•°æ®ç±»å‹"></a>9.1.3 æ°å½“çš„æ•°æ®ç±»å‹</h4><h5 id="ä¾‹1ï¼šæ¯”å¦‚å­˜å‚¨ä¸€ä¸ªUserå¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§å­˜å‚¨æ–¹å¼ï¼š"><a href="#ä¾‹1ï¼šæ¯”å¦‚å­˜å‚¨ä¸€ä¸ªUserå¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§å­˜å‚¨æ–¹å¼ï¼š" class="headerlink" title="ä¾‹1ï¼šæ¯”å¦‚å­˜å‚¨ä¸€ä¸ªUserå¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§å­˜å‚¨æ–¹å¼ï¼š"></a>ä¾‹1ï¼šæ¯”å¦‚å­˜å‚¨ä¸€ä¸ªUserå¯¹è±¡ï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§å­˜å‚¨æ–¹å¼ï¼š</h5><ol>
<li>æ–¹å¼ä¸€ï¼šjsonå­—ç¬¦ä¸²</li>
<li>æ–¹å¼äºŒï¼šå­—æ®µæ‰“æ•£</li>
<li>æ–¹å¼ä¸‰ï¼šhashï¼ˆ<strong>æ¨è</strong>ï¼‰</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.2.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="ä¾‹2ï¼šå‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ"><a href="#ä¾‹2ï¼šå‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ" class="headerlink" title="ä¾‹2ï¼šå‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ"></a>ä¾‹2ï¼šå‡å¦‚æœ‰hashç±»å‹çš„keyï¼Œå…¶ä¸­æœ‰100ä¸‡å¯¹fieldå’Œvalueï¼Œfieldæ˜¯è‡ªå¢idï¼Œè¿™ä¸ªkeyå­˜åœ¨ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ</h5><p>å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li>hashçš„entryæ•°é‡è¶…è¿‡500æ—¶ï¼Œä¼šä½¿ç”¨å“ˆå¸Œè¡¨è€Œä¸æ˜¯ZipListï¼Œå†…å­˜å ç”¨è¾ƒå¤š</li>
<li>å¯ä»¥é€šè¿‡hash-max-ziplist-entriesé…ç½®entryä¸Šé™ã€‚ä½†æ˜¯å¦‚æœentryè¿‡å¤šå°±ä¼šå¯¼è‡´BigKeyé—®é¢˜</li>
</ul>
<ol>
<li>æ–¹æ¡ˆä¸€ï¼š æ‹†åˆ†ä¸ºstringç±»å‹</li>
<li>æ–¹æ¡ˆäºŒï¼š æ‹†åˆ†ä¸ºå°çš„hashï¼Œå°† id &#x2F; 100 ä½œä¸ºkeyï¼Œ å°†id % 100 ä½œä¸ºfieldï¼Œè¿™æ ·æ¯100ä¸ªå…ƒç´ ä¸ºä¸€ä¸ªHash(<strong>æ¨è</strong>)</li>
</ol>
<h4 id="9-1-4-æ€»ç»“"><a href="#9-1-4-æ€»ç»“" class="headerlink" title="9.1.4 æ€»ç»“"></a>9.1.4 æ€»ç»“</h4><ul>
<li>Keyçš„æœ€ä½³å®è·µ<ul>
<li>å›ºå®šæ ¼å¼ï¼š<code>[ä¸šåŠ¡å]:[æ•°æ®å]:[id]</code></li>
<li>è¶³å¤Ÿç®€çŸ­ï¼šä¸è¶…è¿‡44å­—èŠ‚</li>
<li>ä¸åŒ…å«ç‰¹æ®Šå­—ç¬¦</li>
</ul>
</li>
<li>Valueçš„æœ€ä½³å®è·µï¼š<ul>
<li>åˆç†çš„æ‹†åˆ†æ•°æ®ï¼Œæ‹’ç»BigKey</li>
<li>é€‰æ‹©åˆé€‚æ•°æ®ç»“æ„</li>
<li>Hashç»“æ„çš„entryæ•°é‡ä¸è¦è¶…è¿‡1000</li>
<li>è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´</li>
</ul>
</li>
</ul>
<h3 id="9-2-æ‰¹å¤„ç†ä¼˜åŒ–"><a href="#9-2-æ‰¹å¤„ç†ä¼˜åŒ–" class="headerlink" title="9.2 æ‰¹å¤„ç†ä¼˜åŒ–"></a>9.2 æ‰¹å¤„ç†ä¼˜åŒ–</h3><h4 id="9-2-1-Pipeline"><a href="#9-2-1-Pipeline" class="headerlink" title="9.2.1 Pipeline"></a>9.2.1 Pipeline</h4><h5 id="9-2-1-1-å®¢æˆ·ç«¯ä¸redisæœåŠ¡å™¨æ˜¯è¿™æ ·äº¤äº’çš„"><a href="#9-2-1-1-å®¢æˆ·ç«¯ä¸redisæœåŠ¡å™¨æ˜¯è¿™æ ·äº¤äº’çš„" class="headerlink" title="9.2.1.1 å®¢æˆ·ç«¯ä¸redisæœåŠ¡å™¨æ˜¯è¿™æ ·äº¤äº’çš„"></a>9.2.1.1 å®¢æˆ·ç«¯ä¸redisæœåŠ¡å™¨æ˜¯è¿™æ ·äº¤äº’çš„</h5><ol>
<li>å•ä¸ªå‘½ä»¤çš„æ‰§è¡Œæµç¨‹<br>ä¸€æ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ &#x3D; 1æ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + 1æ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.3.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>Næ¡å‘½ä»¤ä¾æ¬¡æ‰§è¡Œ<br>Næ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ &#x3D; Næ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + Næ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.4.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>Næ¡å‘½ä»¤æ‰¹é‡æ‰§è¡Œ<br>Næ¬¡å‘½ä»¤çš„å“åº”æ—¶é—´ &#x3D; 1æ¬¡å¾€è¿”çš„ç½‘ç»œä¼ è¾“è€—æ—¶ + Næ¬¡Redisæ‰§è¡Œå‘½ä»¤è€—æ—¶</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.5.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="9-2-1-2-MSet"><a href="#9-2-1-2-MSet" class="headerlink" title="9.2.1.2 MSet"></a>9.2.1.2 MSet</h5><p>Redisæä¾›äº†å¾ˆå¤šMxxxè¿™æ ·çš„å‘½ä»¤ï¼Œå¯ä»¥å®ç°æ‰¹é‡æ’å…¥æ•°æ®ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>mset</li>
<li>hmset</li>
</ul>
<p>åˆ©ç”¨msetæ‰¹é‡æ’å…¥10ä¸‡æ¡æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMxx</span><span class="hljs-params">()</span> &#123;<br>    String[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">2000</span>];<br>    <span class="hljs-type">int</span> j;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100000</span>; i++) &#123;<br>        j = (i % <span class="hljs-number">1000</span>) &lt;&lt; <span class="hljs-number">1</span>;<br>        arr[j] = <span class="hljs-string">&quot;test:key_&quot;</span> + i;<br>        arr[j + <span class="hljs-number">1</span>] = <span class="hljs-string">&quot;value_&quot;</span> + i;<br>        <span class="hljs-keyword">if</span> (j == <span class="hljs-number">0</span>) &#123;<br>            jedis.mset(arr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;time: &quot;</span> + (e - b));<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="9-2-1-3-Pipeline"><a href="#9-2-1-3-Pipeline" class="headerlink" title="9.2.1.3 Pipeline"></a>9.2.1.3 Pipeline</h5><p>MSETè™½ç„¶å¯ä»¥æ‰¹å¤„ç†ï¼Œä½†æ˜¯å´åªèƒ½æ“ä½œéƒ¨åˆ†æ•°æ®ç±»å‹ï¼Œå› æ­¤å¦‚æœæœ‰å¯¹å¤æ‚æ•°æ®ç±»å‹çš„æ‰¹å¤„ç†éœ€è¦ï¼Œå»ºè®®ä½¿ç”¨Pipeline</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPipeline</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// åˆ›å»ºç®¡é“</span><br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> jedis.pipelined();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100000</span>; i++) &#123;<br>        <span class="hljs-comment">// æ”¾å…¥å‘½ä»¤åˆ°ç®¡é“</span><br>        pipeline.set(<span class="hljs-string">&quot;test:key_&quot;</span> + i, <span class="hljs-string">&quot;value_&quot;</span> + i);<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// æ¯æ”¾å…¥1000æ¡å‘½ä»¤ï¼Œæ‰¹é‡æ‰§è¡Œ</span><br>            pipeline.sync();<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;time: &quot;</span> + (e - b));<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="9-2-2-é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†"><a href="#9-2-2-é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†" class="headerlink" title="9.2.2 é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†"></a>9.2.2 é›†ç¾¤ä¸‹çš„æ‰¹å¤„ç†</h4><p>å¦‚MSETæˆ–Pipelineè¿™æ ·çš„æ‰¹å¤„ç†éœ€è¦åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æºå¸¦å¤šæ¡å‘½ä»¤ï¼Œè€Œæ­¤æ—¶å¦‚æœRedisæ˜¯ä¸€ä¸ªé›†ç¾¤ï¼Œé‚£æ‰¹å¤„ç†å‘½ä»¤çš„å¤šä¸ªkeyå¿…é¡»è½åœ¨ä¸€ä¸ªæ’æ§½ä¸­ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ‰§è¡Œå¤±è´¥ã€‚</p>
<table>
<thead>
<tr>
<th></th>
<th>ä¸²è¡Œå‘½ä»¤</th>
<th>ä¸²è¡Œslot</th>
<th>å¹¶è¡Œslot(æ¨è)</th>
<th>hash_tag</th>
</tr>
</thead>
<tbody><tr>
<td>å®ç°æ€è·¯</td>
<td>forå¾ªç¯éå†ï¼Œä¾æ¬¡æ‰§è¡Œæ¯ä¸ªå‘½ä»¤</td>
<td>åœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ªkeyçš„slotï¼Œå°†slotä¸€è‡´åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨Pipelineæ‰¹å¤„ç†ï¼Œä¸²è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</td>
<td>åœ¨å®¢æˆ·ç«¯è®¡ç®—æ¯ä¸ªkeyçš„slotï¼Œå°†slotä¸€è‡´åˆ†ä¸ºä¸€ç»„ï¼Œæ¯ç»„éƒ½åˆ©ç”¨Pipelineæ‰¹å¤„ç†ï¼Œå¹¶è¡Œæ‰§è¡Œå„ç»„å‘½ä»¤</td>
<td>å°†æ‰€æœ‰keyè®¾ç½®ç›¸åŒçš„hash_tagï¼Œåˆ™æ‰€æœ‰keyçš„slotä¸€å®šç›¸åŒ</td>
</tr>
<tr>
<td>è€—æ—¶</td>
<td>Næ¬¡ç½‘ç»œè€—æ—¶ + Næ¬¡å‘½ä»¤è€—æ—¶</td>
<td>mæ¬¡ç½‘ç»œè€—æ—¶ + Næ¬¡å‘½ä»¤è€—æ—¶<br>(m &#x3D; keyçš„slotä¸ªæ•°)</td>
<td>1æ¬¡ç½‘ç»œè€—æ—¶ + Næ¬¡å‘½ä»¤è€—æ—¶</td>
<td>1æ¬¡ç½‘ç»œè€—æ—¶ + Næ¬¡å‘½ä»¤è€—æ—¶</td>
</tr>
<tr>
<td>ä¼˜ç‚¹</td>
<td>å®ç°ç®€å•</td>
<td>è€—æ—¶è¾ƒçŸ­</td>
<td>è€—æ—¶éå¸¸çŸ­</td>
<td>è€—æ—¶éå¸¸çŸ­ã€å®ç°ç®€å•</td>
</tr>
<tr>
<td>ç¼ºç‚¹</td>
<td>è€—æ—¶éå¸¸ä¹…</td>
<td>å®ç°ç¨å¤æ‚</td>
<td>å®ç°å¤æ‚</td>
<td>å®¹æ˜“å‡ºç°æ•°æ®å€¾æ–œ</td>
</tr>
</tbody></table>
<ul>
<li>æ¨èä½¿ç”¨å¹¶è¡Œslot</li>
</ul>
<h3 id="9-3-æœåŠ¡ç«¯ä¼˜åŒ–"><a href="#9-3-æœåŠ¡ç«¯ä¼˜åŒ–" class="headerlink" title="9.3 æœåŠ¡ç«¯ä¼˜åŒ–"></a>9.3 æœåŠ¡ç«¯ä¼˜åŒ–</h3><h4 id="9-3-1-æŒä¹…åŒ–é…ç½®"><a href="#9-3-1-æŒä¹…åŒ–é…ç½®" class="headerlink" title="9.3.1 æŒä¹…åŒ–é…ç½®"></a>9.3.1 æŒä¹…åŒ–é…ç½®</h4><p>Redisçš„æŒä¹…åŒ–è™½ç„¶å¯ä»¥ä¿è¯æ•°æ®å®‰å…¨ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥å¾ˆå¤šé¢å¤–çš„å¼€é”€ï¼Œå› æ­¤æŒä¹…åŒ–è¯·éµå¾ªä¸‹åˆ—å»ºè®®ï¼š</p>
<ul>
<li>ç”¨æ¥åšç¼“å­˜çš„Rediså®ä¾‹å°½é‡ä¸è¦å¼€å¯æŒä¹…åŒ–åŠŸèƒ½</li>
<li>å»ºè®®å…³é—­RDBæŒä¹…åŒ–åŠŸèƒ½ï¼Œ<strong>ä½¿ç”¨AOFæŒä¹…åŒ–</strong></li>
<li>åˆ©ç”¨è„šæœ¬å®šæœŸåœ¨slaveèŠ‚ç‚¹åšRDBï¼Œå®ç°æ•°æ®å¤‡ä»½</li>
<li>è®¾ç½®åˆç†çš„rewriteé˜ˆå€¼ï¼Œé¿å…é¢‘ç¹çš„bgrewrite</li>
<li>é…ç½®no-appendfsync-on-rewrite &#x3D; yesï¼Œç¦æ­¢åœ¨rewriteæœŸé—´åšaofï¼Œé¿å…å› AOFå¼•èµ·çš„é˜»å¡</li>
<li>éƒ¨ç½²æœ‰å…³å»ºè®®ï¼š<ul>
<li>Rediså®ä¾‹çš„ç‰©ç†æœºè¦é¢„ç•™è¶³å¤Ÿå†…å­˜ï¼Œåº”å¯¹forkå’Œrewrite</li>
<li>å•ä¸ªRediså®ä¾‹å†…å­˜ä¸Šé™ä¸è¦å¤ªå¤§ï¼Œä¾‹å¦‚4Gæˆ–8Gã€‚å¯ä»¥åŠ å¿«forkçš„é€Ÿåº¦ã€å‡å°‘ä¸»ä»åŒæ­¥ã€æ•°æ®è¿ç§»å‹åŠ›</li>
<li>ä¸è¦ä¸CPUå¯†é›†å‹åº”ç”¨éƒ¨ç½²åœ¨ä¸€èµ·</li>
<li>ä¸è¦ä¸é«˜ç¡¬ç›˜è´Ÿè½½åº”ç”¨ä¸€èµ·éƒ¨ç½²ã€‚ä¾‹å¦‚ï¼šæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—</li>
</ul>
</li>
</ul>
<h4 id="9-3-2-æ…¢æŸ¥è¯¢ä¼˜åŒ–"><a href="#9-3-2-æ…¢æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="9.3.2 æ…¢æŸ¥è¯¢ä¼˜åŒ–"></a>9.3.2 æ…¢æŸ¥è¯¢ä¼˜åŒ–</h4><p>åœ¨Redisæ‰§è¡Œæ—¶è€—æ—¶è¶…è¿‡æŸä¸ªé˜ˆå€¼çš„å‘½ä»¤ï¼Œç§°ä¸ºæ…¢æŸ¥è¯¢ã€‚</p>
<ul>
<li><p><strong>æ…¢æŸ¥è¯¢çš„å±å®³</strong>ï¼šç”±äºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å½“å®¢æˆ·ç«¯å‘å‡ºæŒ‡ä»¤åï¼Œä»–ä»¬éƒ½ä¼šè¿›å…¥åˆ°redisåº•å±‚çš„queueæ¥æ‰§è¡Œï¼Œå¦‚æœæ­¤æ—¶æœ‰ä¸€äº›æ…¢æŸ¥è¯¢çš„æ•°æ®ï¼Œå°±ä¼šå¯¼è‡´å¤§é‡è¯·æ±‚é˜»å¡ï¼Œä»è€Œå¼•èµ·æŠ¥é”™ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è§£å†³æ…¢æŸ¥è¯¢é—®é¢˜ã€‚</p>
</li>
<li><p>æ…¢æŸ¥è¯¢çš„é˜ˆå€¼å¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p>
<ul>
<li>slowlog-log-slower-thanï¼šæ…¢æŸ¥è¯¢é˜ˆå€¼ï¼Œå•ä½æ˜¯å¾®ç§’ã€‚é»˜è®¤æ˜¯10000ï¼Œå»ºè®®1000</li>
</ul>
</li>
<li><p>æ…¢æŸ¥è¯¢ä¼šè¢«æ”¾å…¥æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ï¼Œæ—¥å¿—çš„é•¿åº¦æœ‰ä¸Šé™ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šï¼š</p>
<ul>
<li>slowlog-max-lenï¼šæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ˆæœ¬è´¨æ˜¯ä¸€ä¸ªé˜Ÿåˆ—ï¼‰çš„é•¿åº¦ã€‚é»˜è®¤æ˜¯128ï¼Œå»ºè®®1000</li>
</ul>
</li>
</ul>
<p>æŸ¥çœ‹æ…¢æŸ¥è¯¢æ—¥å¿—åˆ—è¡¨:</p>
<ul>
<li>slowlog lenï¼šæŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—é•¿åº¦</li>
<li>slowlog get [n]ï¼šè¯»å–næ¡æ…¢æŸ¥è¯¢æ—¥å¿—</li>
<li>slowlog resetï¼šæ¸…ç©ºæ…¢æŸ¥è¯¢åˆ—è¡¨</li>
</ul>
<h4 id="9-3-3-å‘½ä»¤åŠå®‰å…¨é…ç½®"><a href="#9-3-3-å‘½ä»¤åŠå®‰å…¨é…ç½®" class="headerlink" title="9.3.3 å‘½ä»¤åŠå®‰å…¨é…ç½®"></a>9.3.3 å‘½ä»¤åŠå®‰å…¨é…ç½®</h4><p>æ¼æ´å‡ºç°çš„æ ¸å¿ƒçš„åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>Redisæœªè®¾ç½®å¯†ç </li>
<li>åˆ©ç”¨äº†Redisçš„config setå‘½ä»¤åŠ¨æ€ä¿®æ”¹Redisé…ç½®</li>
<li>ä½¿ç”¨äº†Rootè´¦å·æƒé™å¯åŠ¨Redis</li>
</ul>
<p>ä¸ºäº†é¿å…è¿™æ ·çš„æ¼æ´ï¼Œè¿™é‡Œç»™å‡ºä¸€äº›å»ºè®®ï¼š</p>
<ul>
<li>Redisä¸€å®šè¦è®¾ç½®å¯†ç </li>
<li>ç¦æ­¢çº¿ä¸Šä½¿ç”¨ä¸‹é¢å‘½ä»¤ï¼škeysã€flushallã€flushdbã€config setç­‰å‘½ä»¤ã€‚å¯ä»¥åˆ©ç”¨rename-commandç¦ç”¨ã€‚</li>
<li>bindï¼šé™åˆ¶ç½‘å¡ï¼Œç¦æ­¢å¤–ç½‘ç½‘å¡è®¿é—®</li>
<li>å¼€å¯é˜²ç«å¢™</li>
<li>ä¸è¦ä½¿ç”¨Rootè´¦æˆ·å¯åŠ¨Redis</li>
<li>å°½é‡ä¸æ˜¯æœ‰é»˜è®¤çš„ç«¯å£</li>
</ul>
<h4 id="9-3-4-å†…å­˜é…ç½®"><a href="#9-3-4-å†…å­˜é…ç½®" class="headerlink" title="9.3.4 å†…å­˜é…ç½®"></a>9.3.4 å†…å­˜é…ç½®</h4><p>å½“Rediså†…å­˜ä¸è¶³æ—¶ï¼Œå¯èƒ½å¯¼è‡´Keyé¢‘ç¹è¢«åˆ é™¤ã€å“åº”æ—¶é—´å˜é•¿ã€QPSä¸ç¨³å®šç­‰é—®é¢˜ã€‚å½“å†…å­˜ä½¿ç”¨ç‡è¾¾åˆ°90%ä»¥ä¸Šæ—¶å°±éœ€è¦æˆ‘ä»¬è­¦æƒ•ï¼Œå¹¶å¿«é€Ÿå®šä½åˆ°å†…å­˜å ç”¨çš„åŸå› ã€‚</p>
<table>
<thead>
<tr>
<th>å†…å­˜ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>æ•°æ®å†…å­˜</td>
<td>æ˜¯Redisæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå­˜å‚¨Redisçš„é”®å€¼ä¿¡æ¯ã€‚ä¸»è¦é—®é¢˜æ˜¯BigKeyé—®é¢˜ã€å†…å­˜ç¢ç‰‡é—®é¢˜</td>
</tr>
<tr>
<td>è¿›ç¨‹å†…å­˜</td>
<td>Redisä¸»è¿›ç¨‹æœ¬èº«è¿è¡Œè‚¯å®šéœ€è¦å ç”¨å†…å­˜ï¼Œå¦‚ä»£ç ã€å¸¸é‡æ± ç­‰ï¼›è¿™éƒ¨åˆ†å†…å­˜å¤§çº¦å‡ å…†ï¼Œåœ¨å¤§å¤šæ•°ç”Ÿäº§ç¯å¢ƒä¸­ä¸Redisæ•°æ®å ç”¨çš„å†…å­˜ç›¸æ¯”å¯ä»¥å¿½ç•¥</td>
</tr>
<tr>
<td>ç¼“å†²åŒºå†…å­˜</td>
<td>ä¸€èˆ¬åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºã€AOFç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºç­‰ã€‚å®¢æˆ·ç«¯ç¼“å†²åŒºåˆåŒ…æ‹¬è¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºä¸¤ç§ã€‚è¿™éƒ¨åˆ†å†…å­˜å ç”¨æ³¢åŠ¨è¾ƒå¤§ï¼Œä¸å½“ä½¿ç”¨BigKeyå¯èƒ½å¯¼è‡´å†…å­˜æº¢å‡º</td>
</tr>
</tbody></table>
<p>å†…å­˜ç¼“å†²åŒºå¸¸è§çš„æœ‰ä¸‰ç§ï¼š</p>
<ul>
<li>å¤åˆ¶ç¼“å†²åŒºï¼šä¸»ä»å¤åˆ¶çš„repl_backlog_bufï¼Œå¦‚æœå¤ªå°å¯èƒ½å¯¼è‡´é¢‘ç¹çš„å…¨é‡å¤åˆ¶ï¼Œå½±å“æ€§èƒ½ã€‚é€šè¿‡replbacklog-sizeæ¥è®¾ç½®ï¼Œé»˜è®¤1mb</li>
<li>AOFç¼“å†²åŒºï¼šAOFåˆ·ç›˜ä¹‹å‰çš„ç¼“å­˜åŒºåŸŸï¼ŒAOFæ‰§è¡Œrewriteçš„ç¼“å†²åŒºã€‚æ— æ³•è®¾ç½®å®¹é‡ä¸Šé™</li>
<li>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šåˆ†ä¸ºè¾“å…¥ç¼“å†²åŒºå’Œè¾“å‡ºç¼“å†²åŒºï¼Œè¾“å…¥ç¼“å†²åŒºæœ€å¤§1Gä¸”ä¸èƒ½è®¾ç½®ã€‚è¾“å‡ºç¼“å†²åŒºå¯ä»¥è®¾ç½®</li>
</ul>
<h3 id="9-4-é›†ç¾¤æœ€ä½³å®è·µ"><a href="#9-4-é›†ç¾¤æœ€ä½³å®è·µ" class="headerlink" title="9.4 é›†ç¾¤æœ€ä½³å®è·µ"></a>9.4 é›†ç¾¤æœ€ä½³å®è·µ</h3><h4 id="9-4-1-é—®é¢˜1ã€åœ¨Redisçš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ªæ’æ§½ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ï¼š"><a href="#9-4-1-é—®é¢˜1ã€åœ¨Redisçš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ªæ’æ§½ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ï¼š" class="headerlink" title="9.4.1 é—®é¢˜1ã€åœ¨Redisçš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ªæ’æ§½ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ï¼š"></a>9.4.1 é—®é¢˜1ã€åœ¨Redisçš„é»˜è®¤é…ç½®ä¸­ï¼Œå¦‚æœå‘ç°ä»»æ„ä¸€ä¸ªæ’æ§½ä¸å¯ç”¨ï¼Œåˆ™æ•´ä¸ªé›†ç¾¤éƒ½ä¼šåœæ­¢å¯¹å¤–æœåŠ¡ï¼š</h4><ul>
<li>ä¸ºäº†ä¿è¯é«˜å¯ç”¨ç‰¹æ€§ï¼Œè¿™é‡Œå»ºè®®å°† cluster-require-full-coverageé…ç½®ä¸ºfalse</li>
</ul>
<h4 id="9-4-2-é—®é¢˜2ã€é›†ç¾¤å¸¦å®½é—®é¢˜"><a href="#9-4-2-é—®é¢˜2ã€é›†ç¾¤å¸¦å®½é—®é¢˜" class="headerlink" title="9.4.2 é—®é¢˜2ã€é›†ç¾¤å¸¦å®½é—®é¢˜"></a>9.4.2 é—®é¢˜2ã€é›†ç¾¤å¸¦å®½é—®é¢˜</h4><p>é›†ç¾¤èŠ‚ç‚¹ä¹‹é—´ä¼šä¸æ–­çš„äº’ç›¸Pingæ¥ç¡®å®šé›†ç¾¤ä¸­å…¶å®ƒèŠ‚ç‚¹çš„çŠ¶æ€ã€‚æ¯æ¬¡Pingæºå¸¦çš„ä¿¡æ¯è‡³å°‘åŒ…æ‹¬ï¼š</p>
<ul>
<li>æ’æ§½ä¿¡æ¯</li>
<li>é›†ç¾¤çŠ¶æ€ä¿¡æ¯</li>
</ul>
<p>é›†ç¾¤ä¸­èŠ‚ç‚¹è¶Šå¤šï¼Œé›†ç¾¤çŠ¶æ€ä¿¡æ¯æ•°æ®é‡ä¹Ÿè¶Šå¤§ï¼Œ10ä¸ªèŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯å¯èƒ½è¾¾åˆ°1kbï¼Œæ­¤æ—¶æ¯æ¬¡é›†ç¾¤äº’é€šéœ€è¦çš„å¸¦å®½ä¼šéå¸¸é«˜ï¼Œè¿™æ ·ä¼šå¯¼è‡´é›†ç¾¤ä¸­å¤§é‡çš„å¸¦å®½éƒ½ä¼šè¢«pingä¿¡æ¯æ‰€å ç”¨ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å¯æ€•çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»è§£å†³è¿™æ ·çš„é—®é¢˜</p>
<p><strong>è§£å†³é€”å¾„ï¼š</strong></p>
<ul>
<li>é¿å…å¤§é›†ç¾¤ï¼Œé›†ç¾¤èŠ‚ç‚¹æ•°ä¸è¦å¤ªå¤šï¼Œæœ€å¥½å°‘äº1000ï¼Œå¦‚æœä¸šåŠ¡åºå¤§ï¼Œåˆ™å»ºç«‹å¤šä¸ªé›†ç¾¤ã€‚</li>
<li>é¿å…åœ¨å•ä¸ªç‰©ç†æœºä¸­è¿è¡Œå¤ªå¤šRediså®ä¾‹</li>
<li>é…ç½®åˆé€‚çš„cluster-node-timeoutå€¼</li>
</ul>
<h4 id="9-4-3-å…¶ä»–é—®é¢˜"><a href="#9-4-3-å…¶ä»–é—®é¢˜" class="headerlink" title="9.4.3 å…¶ä»–é—®é¢˜"></a>9.4.3 å…¶ä»–é—®é¢˜</h4><ul>
<li>æ•°æ®å€¾æ–œé—®é¢˜</li>
<li>å®¢æˆ·ç«¯æ€§èƒ½é—®é¢˜</li>
<li>å‘½ä»¤çš„é›†ç¾¤å…¼å®¹æ€§é—®é¢˜</li>
<li>luaå’Œäº‹åŠ¡é—®é¢˜</li>
</ul>
<p><strong>é‚£æˆ‘ä»¬åˆ°åº•æ˜¯é›†ç¾¤è¿˜æ˜¯ä¸»ä»</strong></p>
<ul>
<li>å•ä½“Redisï¼ˆä¸»ä»Redisï¼‰å·²ç»èƒ½è¾¾åˆ°ä¸‡çº§åˆ«çš„QPSï¼Œå¹¶ä¸”ä¹Ÿå…·å¤‡å¾ˆå¼ºçš„é«˜å¯ç”¨ç‰¹æ€§ã€‚å¦‚æœä¸»ä»èƒ½æ»¡è¶³ä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œæ‰€ä»¥å¦‚æœä¸æ˜¯åœ¨ä¸‡ä¸å¾—å·²çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸æ­å»ºRedisé›†ç¾¤</li>
</ul>
<h1 id="å››-RedisåŸç†ç¯‡"><a href="#å››-RedisåŸç†ç¯‡" class="headerlink" title="å››. RedisåŸç†ç¯‡"></a>å››. RedisåŸç†ç¯‡</h1><h2 id="1-Redisæ•°æ®ç»“æ„"><a href="#1-Redisæ•°æ®ç»“æ„" class="headerlink" title="1. Redisæ•°æ®ç»“æ„"></a>1. Redisæ•°æ®ç»“æ„</h2><h3 id="1-1-åŠ¨æ€å­—ç¬¦ä¸²SDS"><a href="#1-1-åŠ¨æ€å­—ç¬¦ä¸²SDS" class="headerlink" title="1.1 åŠ¨æ€å­—ç¬¦ä¸²SDS"></a>1.1 åŠ¨æ€å­—ç¬¦ä¸²SDS</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“Redisä¸­ä¿å­˜çš„Keyæ˜¯å­—ç¬¦ä¸²ï¼Œvalueå¾€å¾€æ˜¯å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²çš„é›†åˆã€‚å¯è§å­—ç¬¦ä¸²æ˜¯Redisä¸­æœ€å¸¸ç”¨çš„ä¸€ç§æ•°æ®ç»“æ„ã€‚<br>Redisæ„å»ºäº†ä¸€ç§æ–°çš„å­—ç¬¦ä¸²ç»“æ„ï¼Œç§°ä¸ºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSimple Dynamic Stringï¼‰ï¼Œç®€ç§°SDSã€‚</p>
<ul>
<li>ä¾‹å¦‚ï¼šRediså°†åœ¨åº•å±‚åˆ›å»ºä¸¤ä¸ªSDSï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯åŒ…å«â€œnameâ€çš„SDSï¼Œå¦ä¸€ä¸ªæ˜¯åŒ…å«â€œè™å“¥â€çš„SDSã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p>Redisæ˜¯Cè¯­è¨€å®ç°çš„ï¼Œå…¶ä¸­SDSæ˜¯ä¸€ä¸ªç»“æ„ä½“,æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr8</span> &#123;</span><br>Â  Â  <span class="hljs-type">uint8_t</span> len; <span class="hljs-comment">/* bufå·²ä¿å­˜çš„å­—ç¬¦ä¸²å­—èŠ‚æ•°ï¼Œä¸åŒ…å«ç»“æŸæ ‡ç¤º*/</span><br>Â  Â  <span class="hljs-type">uint8_t</span> alloc; <span class="hljs-comment">/* bufç”³è¯·çš„æ€»çš„å­—èŠ‚æ•°ï¼Œä¸åŒ…å«ç»“æŸæ ‡ç¤º*/</span><br>Â  Â  <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> flags; <span class="hljs-comment">/* ä¸åŒSDSçš„å¤´ç±»å‹ï¼Œç”¨æ¥æ§åˆ¶SDSçš„å¤´å¤§å°</span><br><span class="hljs-comment">Â  Â  char buf[];</span><br><span class="hljs-comment">&#125;;</span><br></code></pre></td></tr></table></figure>

<p>ä¾‹å¦‚ï¼Œä¸€ä¸ªåŒ…å«å­—ç¬¦ä¸²â€œnameâ€çš„sdsç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>SDSä¹‹æ‰€ä»¥å«åšåŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºå®ƒå…·å¤‡åŠ¨æ€æ‰©å®¹çš„èƒ½åŠ›ï¼Œä¾‹å¦‚ä¸€ä¸ªå†…å®¹ä¸ºâ€œhiâ€çš„SDS</li>
<li>å‡å¦‚æˆ‘ä»¬è¦ç»™SDSè¿½åŠ ä¸€æ®µå­—ç¬¦ä¸²â€œ,Amyâ€ï¼Œè¿™é‡Œé¦–å…ˆä¼šç”³è¯·æ–°å†…å­˜ç©ºé—´<ul>
<li>å¦‚æœæ–°å­—ç¬¦ä¸²å°äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸ºæ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦çš„ä¸¤å€+1ï¼›</li>
<li>å¦‚æœæ–°å­—ç¬¦ä¸²å¤§äº1Mï¼Œåˆ™æ–°ç©ºé—´ä¸ºæ‰©å±•åå­—ç¬¦ä¸²é•¿åº¦+1M+1ã€‚ç§°ä¸ºå†…å­˜é¢„åˆ†é…ã€‚</li>
</ul>
</li>
</ul>
<h3 id="1-2-IntSet"><a href="#1-2-IntSet" class="headerlink" title="1.2 IntSet"></a>1.2 IntSet</h3><p>IntSetæ˜¯Redisä¸­seté›†åˆçš„ä¸€ç§å®ç°æ–¹å¼ï¼ŒåŸºäºæ•´æ•°æ•°ç»„æ¥å®ç°ï¼Œå¹¶ä¸”å…·å¤‡é•¿åº¦å¯å˜ã€æœ‰åºç­‰ç‰¹å¾ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intset</span> &#123;</span><br>Â  Â  <span class="hljs-type">uint32_t</span> encoding; <span class="hljs-comment">/* ç¼–ç æ–¹å¼ï¼Œæ”¯æŒå­˜æ”¾16ä½ã€32ä½ã€64ä½æ•´æ•°*/</span><br>Â  Â  <span class="hljs-type">uint32_t</span> length; <span class="hljs-comment">/* å…ƒç´ ä¸ªæ•° */</span><br>Â  Â  <span class="hljs-type">int8_t</span> contents[]; <span class="hljs-comment">/* æ•´æ•°æ•°ç»„ï¼Œä¿å­˜é›†åˆæ•°æ®*/</span><br>&#125; intset;<br></code></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„encodingåŒ…å«ä¸‰ç§æ¨¡å¼ï¼Œè¡¨ç¤ºå­˜å‚¨çš„æ•´æ•°å¤§å°ä¸åŒï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Note that these encodings are ordered, so:</span><br><span class="hljs-comment">Â * INTSET_ENC_INT16 &lt; INTSET_ENC_INT32 &lt; INTSET_ENC_INT64. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t)) <span class="hljs-comment">/* 2å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„short*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t)) <span class="hljs-comment">/* 4å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„int */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t)) <span class="hljs-comment">/* 8å­—èŠ‚æ•´æ•°ï¼ŒèŒƒå›´ç±»ä¼¼javaçš„long */</span></span><br></code></pre></td></tr></table></figure>

<p>ä¸ºäº†æ–¹ä¾¿æŸ¥æ‰¾ï¼ŒRedisä¼šå°†intsetä¸­æ‰€æœ‰çš„æ•´æ•°æŒ‰ç…§å‡åºä¾æ¬¡ä¿å­˜åœ¨contentsæ•°ç»„ä¸­ï¼Œç»“æ„å¦‚å›¾ï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="IntSetå‡çº§"><a href="#IntSetå‡çº§" class="headerlink" title="IntSetå‡çº§"></a>IntSetå‡çº§</h4><p>æˆ‘ä»¬å‘è¯¥å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ•°å­—ï¼š50000ï¼Œè¿™ä¸ªæ•°å­—è¶…å‡ºäº†int16_tçš„èŒƒå›´ï¼Œintsetä¼šè‡ªåŠ¨å‡çº§ç¼–ç æ–¹å¼åˆ°åˆé€‚çš„å¤§å°ã€‚<br>ä»¥å½“å‰æ¡ˆä¾‹æ¥è¯´æµç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>å‡çº§ç¼–ç ä¸ºINTSET_ENC_INT32, æ¯ä¸ªæ•´æ•°å 4å­—èŠ‚ï¼Œå¹¶æŒ‰ç…§æ–°çš„ç¼–ç æ–¹å¼åŠå…ƒç´ ä¸ªæ•°æ‰©å®¹æ•°ç»„</li>
<li>å€’åºä¾æ¬¡å°†æ•°ç»„ä¸­çš„å…ƒç´ æ‹·è´åˆ°æ‰©å®¹åçš„æ­£ç¡®ä½ç½®</li>
<li>å°†å¾…æ·»åŠ çš„å…ƒç´ æ”¾å…¥æ•°ç»„æœ«å°¾</li>
<li>æœ€åï¼Œå°†insetçš„encodingå±æ€§æ”¹ä¸ºINTSET_ENC_INT32ï¼Œå°†lengthå±æ€§æ”¹ä¸º4</li>
</ul>
<p>åŸæœ¬ï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.4.png" srcset="/img/loading.gif" lazyload></p>
<p>æ‰©å®¹åï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.5.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>æ€»ç»“</strong>ï¼šIntsetå¯ä»¥çœ‹åšæ˜¯ç‰¹æ®Šçš„æ•´æ•°æ•°ç»„ï¼Œå…·å¤‡ä¸€äº›ç‰¹ç‚¹ï¼š</p>
<ul>
<li>Redisä¼šç¡®ä¿Intsetä¸­çš„å…ƒç´ å”¯ä¸€ã€æœ‰åº</li>
<li>å…·å¤‡ç±»å‹å‡çº§æœºåˆ¶ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´</li>
<li>åº•å±‚é‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾æ–¹å¼æ¥æŸ¥è¯¢</li>
</ul>
<h3 id="1-3-Dict"><a href="#1-3-Dict" class="headerlink" title="1.3 Dict"></a>1.3 Dict</h3><p>æˆ‘ä»¬çŸ¥é“Redisæ˜¯ä¸€ä¸ªé”®å€¼å‹ï¼ˆKey-Value Pairï¼‰çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®é”®å®ç°å¿«é€Ÿçš„å¢åˆ æ”¹æŸ¥ã€‚è€Œé”®ä¸å€¼çš„æ˜ å°„å…³ç³»æ­£æ˜¯é€šè¿‡Dictæ¥å®ç°çš„ã€‚</p>
<ul>
<li>Dictç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼šå“ˆå¸Œè¡¨ï¼ˆDictHashTableï¼‰ã€å“ˆå¸ŒèŠ‚ç‚¹ï¼ˆDictEntryï¼‰ã€å­—å…¸ï¼ˆDictï¼‰</li>
</ul>
<p>å½“æˆ‘ä»¬å‘Dictæ·»åŠ é”®å€¼å¯¹æ—¶ï¼ŒRedisé¦–å…ˆæ ¹æ®keyè®¡ç®—å‡ºhashå€¼ï¼ˆhï¼‰ï¼Œç„¶å<strong>åˆ©ç”¨ h &amp; sizemaskæ¥è®¡ç®—å…ƒç´ åº”è¯¥å­˜å‚¨åˆ°æ•°ç»„ä¸­çš„å“ªä¸ªç´¢å¼•ä½ç½®</strong>ã€‚</p>
<ul>
<li>æˆ‘ä»¬å­˜å‚¨k1&#x3D;v1ï¼Œå‡è®¾k1çš„å“ˆå¸Œå€¼h &#x3D;1ï¼Œåˆ™1&amp;3 &#x3D;1ï¼Œå› æ­¤k1&#x3D;v1è¦å­˜å‚¨åˆ°æ•°ç»„è§’æ ‡1ä½ç½®ã€‚</li>
</ul>
<h4 id="Dictçš„æ‰©å®¹"><a href="#Dictçš„æ‰©å®¹" class="headerlink" title="Dictçš„æ‰©å®¹"></a>Dictçš„æ‰©å®¹</h4><p>Dictä¸­çš„HashTableå°±æ˜¯æ•°ç»„ç»“åˆå•å‘é“¾è¡¨çš„å®ç°ï¼Œå½“é›†åˆä¸­å…ƒç´ è¾ƒå¤šæ—¶ï¼Œå¿…ç„¶å¯¼è‡´å“ˆå¸Œå†²çªå¢å¤šï¼Œé“¾è¡¨è¿‡é•¿ï¼Œåˆ™æŸ¥è¯¢æ•ˆç‡ä¼šå¤§å¤§é™ä½ã€‚<br>Dictåœ¨æ¯æ¬¡æ–°å¢é”®å€¼å¯¹æ—¶éƒ½ä¼šæ£€æŸ¥è´Ÿè½½å› å­ï¼ˆLoadFactor &#x3D; used&#x2F;sizeï¼‰ ï¼Œæ»¡è¶³ä»¥ä¸‹ä¸¤ç§æƒ…å†µæ—¶ä¼šè§¦å‘å“ˆå¸Œè¡¨æ‰©å®¹ï¼š</p>
<ul>
<li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt;&#x3D; 1ï¼Œå¹¶ä¸”æœåŠ¡å™¨æ²¡æœ‰æ‰§è¡Œ BGSAVE æˆ–è€… BGREWRITEAOF ç­‰åå°è¿›ç¨‹ï¼›</li>
<li>å“ˆå¸Œè¡¨çš„ LoadFactor &gt; 5 ï¼›</li>
</ul>
<h4 id="Dictçš„æ”¶ç¼©"><a href="#Dictçš„æ”¶ç¼©" class="headerlink" title="Dictçš„æ”¶ç¼©"></a>Dictçš„æ”¶ç¼©</h4><p>Dicté™¤äº†æ‰©å®¹ä»¥å¤–ï¼Œæ¯æ¬¡åˆ é™¤å…ƒç´ æ—¶ï¼Œä¹Ÿä¼šå¯¹è´Ÿè½½å› å­åšæ£€æŸ¥ï¼Œå½“LoadFactor &lt; 0.1 æ—¶ï¼Œä¼šåšå“ˆå¸Œè¡¨æ”¶ç¼©</p>
<h4 id="Dictçš„rehash"><a href="#Dictçš„rehash" class="headerlink" title="Dictçš„rehash"></a>Dictçš„rehash</h4><p>ä¸ç®¡æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼Œå¿…å®šä¼šåˆ›å»ºæ–°çš„å“ˆå¸Œè¡¨ï¼Œå¯¼è‡´å“ˆå¸Œè¡¨çš„sizeå’Œsizemaskå˜åŒ–ï¼Œè€Œkeyçš„æŸ¥è¯¢ä¸sizemaskæœ‰å…³ã€‚å› æ­¤å¿…é¡»å¯¹å“ˆå¸Œè¡¨ä¸­çš„æ¯ä¸€ä¸ªkeyé‡æ–°è®¡ç®—ç´¢å¼•ï¼Œæ’å…¥æ–°çš„å“ˆå¸Œè¡¨ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºrehashã€‚è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>è®¡ç®—æ–°hashè¡¨çš„realeSizeï¼Œå€¼å–å†³äºå½“å‰è¦åšçš„æ˜¯æ‰©å®¹è¿˜æ˜¯æ”¶ç¼©ï¼š<ul>
<li>å¦‚æœæ˜¯æ‰©å®¹ï¼Œåˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht[0].used + 1çš„2^n</li>
<li>å¦‚æœæ˜¯æ”¶ç¼©ï¼Œåˆ™æ–°sizeä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºdict.ht[0].usedçš„2^n ï¼ˆä¸å¾—å°äº4ï¼‰</li>
</ul>
</li>
<li>æŒ‰ç…§æ–°çš„realeSizeç”³è¯·å†…å­˜ç©ºé—´ï¼Œåˆ›å»ºdicthtï¼Œå¹¶èµ‹å€¼ç»™dict.ht[1]</li>
<li>è®¾ç½®dict.rehashidx &#x3D; 0ï¼Œæ ‡ç¤ºå¼€å§‹rehash</li>
<li>å°†dict.ht[0]ä¸­çš„æ¯ä¸€ä¸ªdictEntryéƒ½rehashåˆ°dict.ht[1]</li>
<li>å°†dict.ht[1]èµ‹å€¼ç»™dict.ht[0]ï¼Œç»™dict.ht[1]åˆå§‹åŒ–ä¸ºç©ºå“ˆå¸Œè¡¨ï¼Œé‡Šæ”¾åŸæ¥çš„dict.ht[0]çš„å†…å­˜</li>
<li>å°†rehashidxèµ‹å€¼ä¸º-1ï¼Œä»£è¡¨rehashç»“æŸ</li>
<li>åœ¨rehashè¿‡ç¨‹ä¸­ï¼Œæ–°å¢æ“ä½œï¼Œåˆ™ç›´æ¥å†™å…¥ht[1]ï¼ŒæŸ¥è¯¢ã€ä¿®æ”¹å’Œåˆ é™¤åˆ™ä¼šåœ¨dict.ht[0]å’Œdict.ht[1]ä¾æ¬¡æŸ¥æ‰¾å¹¶æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ht[0]çš„æ•°æ®åªå‡ä¸å¢ï¼Œéšç€rehashæœ€ç»ˆä¸ºç©º</li>
</ul>
<h4 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>Dictçš„ç»“æ„ï¼š</p>
<ul>
<li>ç±»ä¼¼javaçš„HashTableï¼Œåº•å±‚æ˜¯æ•°ç»„åŠ é“¾è¡¨æ¥è§£å†³å“ˆå¸Œå†²çª</li>
<li>DictåŒ…å«ä¸¤ä¸ªå“ˆå¸Œè¡¨ï¼Œht[0]å¹³å¸¸ç”¨ï¼Œht[1]ç”¨æ¥rehash</li>
</ul>
<p>Dictçš„ä¼¸ç¼©ï¼š</p>
<ul>
<li>å½“LoadFactorå¤§äº5æˆ–è€…LoadFactorå¤§äº1å¹¶ä¸”æ²¡æœ‰å­è¿›ç¨‹ä»»åŠ¡æ—¶ï¼ŒDictæ‰©å®¹</li>
<li>å½“LoadFactorå°äº0.1æ—¶ï¼ŒDictæ”¶ç¼©</li>
<li>æ‰©å®¹å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused + 1çš„2^n</li>
<li>æ”¶ç¼©å¤§å°ä¸ºç¬¬ä¸€ä¸ªå¤§äºç­‰äºused çš„2^n</li>
<li>Dicté‡‡ç”¨æ¸è¿›å¼rehashï¼Œæ¯æ¬¡è®¿é—®Dictæ—¶æ‰§è¡Œä¸€æ¬¡rehash</li>
<li>rehashæ—¶ht[0]åªå‡ä¸å¢ï¼Œæ–°å¢æ“ä½œåªåœ¨ht[1]æ‰§è¡Œï¼Œå…¶å®ƒæ“ä½œåœ¨ä¸¤ä¸ªå“ˆå¸Œè¡¨</li>
</ul>
<h3 id="1-4-ZipList"><a href="#1-4-ZipList" class="headerlink" title="1.4 ZipList"></a>1.4 ZipList</h3><p>ZipList æ˜¯ä¸€ç§ç‰¹æ®Šçš„â€œåŒç«¯é“¾è¡¨â€ ï¼Œç”±ä¸€ç³»åˆ—ç‰¹æ®Šç¼–ç çš„è¿ç»­å†…å­˜å—ç»„æˆã€‚å¯ä»¥åœ¨ä»»æ„ä¸€ç«¯è¿›è¡Œå‹å…¥&#x2F;å¼¹å‡ºæ“ä½œ, å¹¶ä¸”è¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ã€‚</p>
<p><img src="/img/blogs/java/redis/4.1.6.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th><strong>å±æ€§</strong></th>
<th><strong>ç±»å‹</strong></th>
<th><strong>é•¿åº¦</strong></th>
<th><strong>ç”¨é€”</strong></th>
</tr>
</thead>
<tbody><tr>
<td>zlbytes</td>
<td>uint32_t</td>
<td>4 å­—èŠ‚</td>
<td>è®°å½•æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨çš„å†…å­˜å­—èŠ‚æ•°</td>
</tr>
<tr>
<td>zltail</td>
<td>uint32_t</td>
<td>4 å­—èŠ‚</td>
<td>è®°å½•å‹ç¼©åˆ—è¡¨è¡¨å°¾èŠ‚ç‚¹è·ç¦»å‹ç¼©åˆ—è¡¨çš„èµ·å§‹åœ°å€æœ‰å¤šå°‘å­—èŠ‚ï¼Œé€šè¿‡è¿™ä¸ªåç§»é‡ï¼Œå¯ä»¥ç¡®å®šè¡¨å°¾èŠ‚ç‚¹çš„åœ°å€ã€‚</td>
</tr>
<tr>
<td>zllen</td>
<td>uint16_t</td>
<td>2 å­—èŠ‚</td>
<td>è®°å½•äº†å‹ç¼©åˆ—è¡¨åŒ…å«çš„èŠ‚ç‚¹æ•°é‡ã€‚ æœ€å¤§å€¼ä¸ºUINT16_MAX ï¼ˆ65534ï¼‰ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªå€¼ï¼Œæ­¤å¤„ä¼šè®°å½•ä¸º65535ï¼Œä½†èŠ‚ç‚¹çš„çœŸå®æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è®¡ç®—å¾—å‡ºã€‚</td>
</tr>
<tr>
<td>entry</td>
<td>åˆ—è¡¨èŠ‚ç‚¹</td>
<td>ä¸å®š</td>
<td>å‹ç¼©åˆ—è¡¨åŒ…å«çš„å„ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é•¿åº¦ç”±èŠ‚ç‚¹ä¿å­˜çš„å†…å®¹å†³å®šã€‚</td>
</tr>
<tr>
<td>zlend</td>
<td>uint8_t</td>
<td>1 å­—èŠ‚</td>
<td>ç‰¹æ®Šå€¼ 0xFF ï¼ˆåè¿›åˆ¶ 255 ï¼‰ï¼Œç”¨äºæ ‡è®°å‹ç¼©åˆ—è¡¨çš„æœ«ç«¯ã€‚</td>
</tr>
</tbody></table>
<h4 id="ZipListEntry"><a href="#ZipListEntry" class="headerlink" title="ZipListEntry"></a>ZipListEntry</h4><p>ZipList ä¸­çš„Entryå¹¶ä¸åƒæ™®é€šé“¾è¡¨é‚£æ ·è®°å½•å‰åèŠ‚ç‚¹çš„æŒ‡é’ˆï¼Œå› ä¸ºè®°å½•ä¸¤ä¸ªæŒ‡é’ˆè¦å ç”¨16ä¸ªå­—èŠ‚ï¼Œæµªè´¹å†…å­˜ã€‚è€Œæ˜¯é‡‡ç”¨äº†ä¸‹é¢çš„ç»“æ„ï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.7.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>previous_entry_lengthï¼šå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦ï¼Œå 1ä¸ªæˆ–5ä¸ªå­—èŠ‚ã€‚<ul>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å°äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨1ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼</li>
<li>å¦‚æœå‰ä¸€èŠ‚ç‚¹çš„é•¿åº¦å¤§äº254å­—èŠ‚ï¼Œåˆ™é‡‡ç”¨5ä¸ªå­—èŠ‚æ¥ä¿å­˜è¿™ä¸ªé•¿åº¦å€¼ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º0xfeï¼Œåå››ä¸ªå­—èŠ‚æ‰æ˜¯çœŸå®é•¿åº¦æ•°æ®</li>
</ul>
</li>
<li>encodingï¼šç¼–ç å±æ€§ï¼Œè®°å½•contentçš„æ•°æ®ç±»å‹ï¼ˆå­—ç¬¦ä¸²è¿˜æ˜¯æ•´æ•°ï¼‰ä»¥åŠé•¿åº¦ï¼Œå ç”¨1ä¸ªã€2ä¸ªæˆ–5ä¸ªå­—èŠ‚</li>
<li>contentsï¼šè´Ÿè´£ä¿å­˜èŠ‚ç‚¹çš„æ•°æ®ï¼Œå¯ä»¥æ˜¯å­—ç¬¦ä¸²æˆ–æ•´æ•°</li>
</ul>
<h4 id="ZipListçš„è¿é”æ›´æ–°é—®é¢˜"><a href="#ZipListçš„è¿é”æ›´æ–°é—®é¢˜" class="headerlink" title="ZipListçš„è¿é”æ›´æ–°é—®é¢˜"></a>ZipListçš„è¿é”æ›´æ–°é—®é¢˜</h4><p>ç°åœ¨ï¼Œå‡è®¾æˆ‘ä»¬æœ‰Nä¸ªè¿ç»­çš„ã€é•¿åº¦ä¸º250~253å­—èŠ‚ä¹‹é—´çš„entryï¼Œå› æ­¤entryçš„previous_entry_lengthå±æ€§ç”¨1ä¸ªå­—èŠ‚å³å¯è¡¨ç¤ºï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/img/blogs/java/redis/4.1.8.png" srcset="/img/loading.gif" lazyload></p>
<p>ZipListè¿™ç§ç‰¹æ®Šæƒ…å†µä¸‹äº§ç”Ÿçš„è¿ç»­å¤šæ¬¡ç©ºé—´æ‰©å±•æ“ä½œç§°ä¹‹ä¸ºè¿é”æ›´æ–°ï¼ˆCascade Updateï¼‰ã€‚æ–°å¢ã€åˆ é™¤éƒ½å¯èƒ½å¯¼è‡´è¿é”æ›´æ–°çš„å‘ç”Ÿã€‚</p>
<h4 id="æ€»ç»“-2"><a href="#æ€»ç»“-2" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><strong>ZipListç‰¹æ€§ï¼š</strong></p>
<ul>
<li>å‹ç¼©åˆ—è¡¨çš„å¯ä»¥çœ‹åšä¸€ç§è¿ç»­å†…å­˜ç©ºé—´çš„â€åŒå‘é“¾è¡¨â€</li>
<li>åˆ—è¡¨çš„èŠ‚ç‚¹ä¹‹é—´ä¸æ˜¯é€šè¿‡æŒ‡é’ˆè¿æ¥ï¼Œè€Œæ˜¯è®°å½•ä¸Šä¸€èŠ‚ç‚¹å’Œæœ¬èŠ‚ç‚¹é•¿åº¦æ¥å¯»å€ï¼Œå†…å­˜å ç”¨è¾ƒä½</li>
<li>å¦‚æœåˆ—è¡¨æ•°æ®è¿‡å¤šï¼Œå¯¼è‡´é“¾è¡¨è¿‡é•¿ï¼Œå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½</li>
<li>å¢æˆ–åˆ è¾ƒå¤§æ•°æ®æ—¶æœ‰å¯èƒ½å‘ç”Ÿè¿ç»­æ›´æ–°é—®é¢˜</li>
</ul>
<h3 id="1-5-QuickList"><a href="#1-5-QuickList" class="headerlink" title="1.5 QuickList"></a>1.5 QuickList</h3><ul>
<li><p>é—®é¢˜1ï¼šZipListè™½ç„¶èŠ‚çœå†…å­˜ï¼Œä½†ç”³è¯·å†…å­˜å¿…é¡»æ˜¯è¿ç»­ç©ºé—´ï¼Œå¦‚æœå†…å­˜å ç”¨è¾ƒå¤šï¼Œç”³è¯·å†…å­˜æ•ˆç‡å¾ˆä½ã€‚æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>ç­”ï¼šä¸ºäº†ç¼“è§£è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»é™åˆ¶ZipListçš„é•¿åº¦å’Œentryå¤§å°ã€‚</li>
</ul>
</li>
<li><p>é—®é¢˜2ï¼šä½†æ˜¯æˆ‘ä»¬è¦å­˜å‚¨å¤§é‡æ•°æ®ï¼Œè¶…å‡ºäº†ZipListæœ€ä½³çš„ä¸Šé™è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<ul>
<li>ç­”ï¼šæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªZipListæ¥åˆ†ç‰‡å­˜å‚¨æ•°æ®ã€‚</li>
</ul>
</li>
<li><p>é—®é¢˜3ï¼šæ•°æ®æ‹†åˆ†åæ¯”è¾ƒåˆ†æ•£ï¼Œä¸æ–¹ä¾¿ç®¡ç†å’ŒæŸ¥æ‰¾ï¼Œè¿™å¤šä¸ªZipListå¦‚ä½•å»ºç«‹è”ç³»ï¼Ÿ</p>
<ul>
<li>ç­”ï¼šRedisåœ¨3.2ç‰ˆæœ¬å¼•å…¥äº†æ–°çš„æ•°æ®ç»“æ„QuickListï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒç«¯é“¾è¡¨ï¼Œåªä¸è¿‡é“¾è¡¨ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªZipListã€‚</li>
</ul>
</li>
<li><p>ä¸ºäº†é¿å…QuickListä¸­çš„æ¯ä¸ªZipListä¸­entryè¿‡å¤šï¼ŒRedisæä¾›äº†ä¸€ä¸ªé…ç½®é¡¹ï¼šlist-max-ziplist-sizeæ¥é™åˆ¶ã€‚</p>
</li>
<li><p>é™¤äº†æ§åˆ¶ZipListçš„å¤§å°ï¼ŒQuickListè¿˜å¯ä»¥å¯¹èŠ‚ç‚¹çš„ZipListåšå‹ç¼©ã€‚é€šè¿‡é…ç½®é¡¹list-compress-depthæ¥æ§åˆ¶</p>
</li>
</ul>
<p><strong>QuickListçš„ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ä¸ºZipListçš„åŒç«¯é“¾è¡¨</li>
<li>èŠ‚ç‚¹é‡‡ç”¨ZipListï¼Œè§£å†³äº†ä¼ ç»Ÿé“¾è¡¨çš„å†…å­˜å ç”¨é—®é¢˜</li>
<li>æ§åˆ¶äº†ZipListå¤§å°ï¼Œè§£å†³è¿ç»­å†…å­˜ç©ºé—´ç”³è¯·æ•ˆç‡é—®é¢˜</li>
<li>ä¸­é—´èŠ‚ç‚¹å¯ä»¥å‹ç¼©ï¼Œè¿›ä¸€æ­¥èŠ‚çœäº†å†…å­˜</li>
</ul>
<h3 id="1-6-SkipList"><a href="#1-6-SkipList" class="headerlink" title="1.6 SkipList"></a>1.6 SkipList</h3><p>SkipListï¼ˆè·³è¡¨ï¼‰é¦–å…ˆæ˜¯é“¾è¡¨ï¼Œä½†ä¸ä¼ ç»Ÿé“¾è¡¨ç›¸æ¯”æœ‰å‡ ç‚¹å·®å¼‚ï¼š</p>
<ul>
<li>å…ƒç´ æŒ‰ç…§å‡åºæ’åˆ—å­˜å‚¨</li>
<li>èŠ‚ç‚¹å¯èƒ½åŒ…å«å¤šä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆè·¨åº¦ä¸åŒã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.9.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>SkipListçš„ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½åŒ…å«scoreå’Œeleå€¼</li>
<li>èŠ‚ç‚¹æŒ‰ç…§scoreå€¼æ’åºï¼Œscoreå€¼ä¸€æ ·åˆ™æŒ‰ç…§eleå­—å…¸æ’åº</li>
<li>æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥åŒ…å«å¤šå±‚æŒ‡é’ˆï¼Œå±‚æ•°æ˜¯1åˆ°32ä¹‹é—´çš„éšæœºæ•°</li>
<li>ä¸åŒå±‚æŒ‡é’ˆåˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·¨åº¦ä¸åŒï¼Œå±‚çº§è¶Šé«˜ï¼Œè·¨åº¦è¶Šå¤§</li>
<li>å¢åˆ æ”¹æŸ¥æ•ˆç‡ä¸çº¢é»‘æ ‘åŸºæœ¬ä¸€è‡´ï¼Œå®ç°å´æ›´ç®€å•</li>
</ul>
<h3 id="1-7-RedisObject"><a href="#1-7-RedisObject" class="headerlink" title="1.7 RedisObject"></a>1.7 RedisObject</h3><p>Redisä¸­çš„ä»»æ„æ•°æ®ç±»å‹çš„é”®å’Œå€¼éƒ½ä¼šè¢«å°è£…ä¸ºä¸€ä¸ªRedisObjectï¼Œä¹Ÿå«åšRediså¯¹è±¡</p>
<p><img src="/img/blogs/java/redis/4.1.10.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-8-RedisåŸºæœ¬æ•°æ®ç±»å‹-String"><a href="#1-8-RedisåŸºæœ¬æ•°æ®ç±»å‹-String" class="headerlink" title="1.8 RedisåŸºæœ¬æ•°æ®ç±»å‹-String"></a>1.8 RedisåŸºæœ¬æ•°æ®ç±»å‹-String</h3><p>Stringæ˜¯Redisä¸­æœ€å¸¸è§çš„æ•°æ®å­˜å‚¨ç±»å‹ï¼š</p>
<ul>
<li>å…¶åŸºæœ¬ç¼–ç æ–¹å¼æ˜¯<strong>RAW</strong>ï¼ŒåŸºäºç®€å•åŠ¨æ€å­—ç¬¦ä¸²ï¼ˆSDSï¼‰å®ç°ï¼Œå­˜å‚¨ä¸Šé™ä¸º512mbã€‚</li>
<li>å¦‚æœå­˜å‚¨çš„SDSé•¿åº¦å°äº44å­—èŠ‚ï¼Œåˆ™ä¼šé‡‡ç”¨<strong>EMBSTRç¼–ç </strong>ï¼Œæ­¤æ—¶object headä¸SDSæ˜¯ä¸€æ®µè¿ç»­ç©ºé—´ã€‚ç”³è¯·å†…å­˜æ—¶åªéœ€è¦è°ƒç”¨ä¸€æ¬¡å†…å­˜åˆ†é…å‡½æ•°ï¼Œæ•ˆç‡æ›´é«˜ã€‚</li>
<li>å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²æ˜¯æ•´æ•°å€¼ï¼Œå¹¶ä¸”å¤§å°åœ¨LONG_MAXèŒƒå›´å†…ï¼Œåˆ™ä¼šé‡‡ç”¨<strong>INTç¼–ç </strong>ï¼šç›´æ¥å°†æ•°æ®ä¿å­˜åœ¨RedisObjectçš„ptræŒ‡é’ˆä½ç½®ï¼ˆåˆšå¥½8å­—èŠ‚ï¼‰ï¼Œä¸å†éœ€è¦SDSäº†ã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.11.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-9-RedisåŸºæœ¬æ•°æ®ç±»å‹-List"><a href="#1-9-RedisåŸºæœ¬æ•°æ®ç±»å‹-List" class="headerlink" title="1.9 RedisåŸºæœ¬æ•°æ®ç±»å‹-List"></a>1.9 RedisåŸºæœ¬æ•°æ®ç±»å‹-List</h3><p>Redisçš„Listç±»å‹å¯ä»¥ä»é¦–ã€å°¾æ“ä½œåˆ—è¡¨ä¸­çš„å…ƒç´ ï¼š</p>
<ul>
<li>åœ¨3.2ç‰ˆæœ¬ä¹‹å‰ï¼ŒRedisé‡‡ç”¨ZipListå’ŒLinkedListæ¥å®ç°Listï¼Œå½“å…ƒç´ æ•°é‡å°äº512å¹¶ä¸”å…ƒç´ å¤§å°å°äº64å­—èŠ‚æ—¶é‡‡ç”¨ZipListç¼–ç ï¼Œè¶…è¿‡åˆ™é‡‡ç”¨LinkedListç¼–ç ã€‚</li>
<li>åœ¨3.2ç‰ˆæœ¬ä¹‹åï¼ŒRedisç»Ÿä¸€é‡‡ç”¨QuickListæ¥å®ç°List</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.12.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>LinkedList ï¼šæ™®é€šé“¾è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒé«˜ï¼Œå†…å­˜ç¢ç‰‡è¾ƒå¤š</li>
<li>ZipList ï¼šå‹ç¼©åˆ—è¡¨ï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨ä½ï¼Œå­˜å‚¨ä¸Šé™ä½</li>
<li>QuickListï¼šLinkedList + ZipListï¼Œå¯ä»¥ä»åŒç«¯è®¿é—®ï¼Œå†…å­˜å ç”¨è¾ƒä½ï¼ŒåŒ…å«å¤šä¸ªZipListï¼Œå­˜å‚¨ä¸Šé™é«˜</li>
</ul>
<h3 id="1-10-RedisåŸºæœ¬æ•°æ®ç±»å‹-Set"><a href="#1-10-RedisåŸºæœ¬æ•°æ®ç±»å‹-Set" class="headerlink" title="1.10 RedisåŸºæœ¬æ•°æ®ç±»å‹-Set"></a>1.10 RedisåŸºæœ¬æ•°æ®ç±»å‹-Set</h3><p>Setæ˜¯Redisä¸­çš„å•åˆ—é›†åˆï¼Œæ»¡è¶³ä¸‹åˆ—ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ä¸ä¿è¯æœ‰åºæ€§</li>
<li>ä¿è¯å…ƒç´ å”¯ä¸€</li>
<li>æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†</li>
</ul>
<p>ä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ</p>
<ul>
<li>HashTableï¼Œä¹Ÿå°±æ˜¯Redisä¸­çš„Dictï¼Œä¸è¿‡Dictæ˜¯åŒåˆ—é›†åˆï¼ˆå¯ä»¥å­˜é”®ã€å€¼å¯¹ï¼‰</li>
</ul>
<p>Setæ˜¯Redisä¸­çš„é›†åˆï¼Œä¸ä¸€å®šç¡®ä¿å…ƒç´ æœ‰åºï¼Œå¯ä»¥æ»¡è¶³å…ƒç´ å”¯ä¸€ã€æŸ¥è¯¢æ•ˆç‡è¦æ±‚æé«˜ã€‚</p>
<ul>
<li>ä¸ºäº†æŸ¥è¯¢æ•ˆç‡å’Œå”¯ä¸€æ€§ï¼Œseté‡‡ç”¨HTç¼–ç ï¼ˆDictï¼‰ã€‚Dictä¸­çš„keyç”¨æ¥å­˜å‚¨å…ƒç´ ï¼Œvalueç»Ÿä¸€ä¸ºnullã€‚</li>
<li>å½“å­˜å‚¨çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯æ•´æ•°ï¼Œå¹¶ä¸”å…ƒç´ æ•°é‡ä¸è¶…è¿‡set-max-intset-entriesæ—¶ï¼ŒSetä¼šé‡‡ç”¨IntSetç¼–ç ï¼Œä»¥èŠ‚çœå†…å­˜</li>
</ul>
<h3 id="1-11-RedisåŸºæœ¬æ•°æ®ç±»å‹-ZSet"><a href="#1-11-RedisåŸºæœ¬æ•°æ®ç±»å‹-ZSet" class="headerlink" title="1.11 RedisåŸºæœ¬æ•°æ®ç±»å‹-ZSet"></a>1.11 RedisåŸºæœ¬æ•°æ®ç±»å‹-ZSet</h3><p>ZSetä¹Ÿå°±æ˜¯SortedSetï¼Œå…¶ä¸­æ¯ä¸€ä¸ªå…ƒç´ éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªscoreå€¼å’Œmemberå€¼ï¼š</p>
<ul>
<li>å¯ä»¥æ ¹æ®scoreå€¼æ’åºå</li>
<li>memberå¿…é¡»å”¯ä¸€</li>
<li>å¯ä»¥æ ¹æ®memberæŸ¥è¯¢åˆ†æ•°</li>
</ul>
<p>å› æ­¤ï¼Œzsetåº•å±‚æ•°æ®ç»“æ„å¿…é¡»æ»¡è¶³é”®å€¼å­˜å‚¨ã€é”®å¿…é¡»å”¯ä¸€ã€å¯æ’åºè¿™å‡ ä¸ªéœ€æ±‚ã€‚ä¹‹å‰å­¦ä¹ çš„å“ªç§ç¼–ç ç»“æ„å¯ä»¥æ»¡è¶³ï¼Ÿ</p>
<ul>
<li><strong>SkipList</strong>ï¼šå¯ä»¥æ’åºï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å­˜å‚¨scoreå’Œeleå€¼ï¼ˆmemberï¼‰</li>
<li><strong>HTï¼ˆDictï¼‰</strong>ï¼šå¯ä»¥é”®å€¼å­˜å‚¨ï¼Œå¹¶ä¸”å¯ä»¥æ ¹æ®keyæ‰¾value</li>
</ul>
<p>å½“å…ƒç´ æ•°é‡ä¸å¤šæ—¶ï¼ŒHTå’ŒSkipListçš„ä¼˜åŠ¿ä¸æ˜æ˜¾ï¼Œè€Œä¸”æ›´è€—å†…å­˜ã€‚å› æ­¤zsetè¿˜ä¼šé‡‡ç”¨ZipListç»“æ„æ¥èŠ‚çœå†…å­˜ï¼Œä¸è¿‡éœ€è¦åŒæ—¶æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶ï¼š</p>
<ul>
<li>å…ƒç´ æ•°é‡å°äºzset_max_ziplist_entriesï¼Œé»˜è®¤å€¼128</li>
<li>æ¯ä¸ªå…ƒç´ éƒ½å°äºzset_max_ziplist_valueå­—èŠ‚ï¼Œé»˜è®¤å€¼64</li>
</ul>
<p>ziplistæœ¬èº«æ²¡æœ‰æ’åºåŠŸèƒ½ï¼Œè€Œä¸”æ²¡æœ‰é”®å€¼å¯¹çš„æ¦‚å¿µï¼Œå› æ­¤éœ€è¦æœ‰zseté€šè¿‡ç¼–ç å®ç°ï¼š</p>
<ul>
<li>ZipListæ˜¯è¿ç»­å†…å­˜ï¼Œå› æ­¤scoreå’Œelementæ˜¯ç´§æŒ¨åœ¨ä¸€èµ·çš„ä¸¤ä¸ªentryï¼Œ elementåœ¨å‰ï¼Œscoreåœ¨å</li>
<li>scoreè¶Šå°è¶Šæ¥è¿‘é˜Ÿé¦–ï¼Œscoreè¶Šå¤§è¶Šæ¥è¿‘é˜Ÿå°¾ï¼ŒæŒ‰ç…§scoreå€¼å‡åºæ’åˆ—</li>
</ul>
<h3 id="1-12-RedisåŸºæœ¬æ•°æ®ç±»å‹-Hash"><a href="#1-12-RedisåŸºæœ¬æ•°æ®ç±»å‹-Hash" class="headerlink" title="1.12 RedisåŸºæœ¬æ•°æ®ç±»å‹-Hash"></a>1.12 RedisåŸºæœ¬æ•°æ®ç±»å‹-Hash</h3><p>Hashç»“æ„ä¸Redisä¸­çš„Zsetéå¸¸ç±»ä¼¼ï¼š</p>
<ul>
<li>éƒ½æ˜¯é”®å€¼å­˜å‚¨</li>
<li>éƒ½éœ€æ±‚æ ¹æ®é”®è·å–å€¼</li>
<li>é”®å¿…é¡»å”¯ä¸€</li>
</ul>
<p>åŒºåˆ«å¦‚ä¸‹ï¼š</p>
<ul>
<li>zsetçš„é”®æ˜¯memberï¼Œå€¼æ˜¯scoreï¼›hashçš„é”®å’Œå€¼éƒ½æ˜¯ä»»æ„å€¼</li>
<li>zsetè¦æ ¹æ®scoreæ’åºï¼›hashåˆ™æ— éœ€æ’åº</li>
</ul>
<p>å› æ­¤ï¼ŒHashåº•å±‚é‡‡ç”¨çš„ç¼–ç ä¸Zsetä¹ŸåŸºæœ¬ä¸€è‡´ï¼Œåªéœ€è¦æŠŠæ’åºæœ‰å…³çš„SkipListå»æ‰å³å¯</p>
<ul>
<li>Hashç»“æ„é»˜è®¤é‡‡ç”¨ZipListç¼–ç ï¼Œç”¨ä»¥èŠ‚çœå†…å­˜ã€‚ ZipListä¸­ç›¸é‚»çš„ä¸¤ä¸ªentry åˆ†åˆ«ä¿å­˜fieldå’Œvalue</li>
<li>å½“æ•°æ®é‡è¾ƒå¤§æ—¶ï¼ŒHashç»“æ„ä¼šè½¬ä¸ºHTç¼–ç ï¼Œä¹Ÿå°±æ˜¯Dictï¼Œè§¦å‘æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š<ul>
<li>ZipListä¸­çš„å…ƒç´ æ•°é‡è¶…è¿‡äº†hash-max-ziplist-entriesï¼ˆé»˜è®¤512ï¼‰</li>
<li>ZipListä¸­çš„ä»»æ„entryå¤§å°è¶…è¿‡äº†hash-max-ziplist-valueï¼ˆé»˜è®¤64å­—èŠ‚ï¼‰</li>
</ul>
</li>
</ul>
<h2 id="2-Redisç½‘ç»œæ¨¡å‹"><a href="#2-Redisç½‘ç»œæ¨¡å‹" class="headerlink" title="2. Redisç½‘ç»œæ¨¡å‹"></a>2. Redisç½‘ç»œæ¨¡å‹</h2><h3 id="2-1-ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´"><a href="#2-1-ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´" class="headerlink" title="2.1 ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´"></a>2.1 ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸æ€ç©ºé—´</h3><p>ç”¨æˆ·çš„åº”ç”¨ï¼Œæ¯”å¦‚redisï¼Œmysqlç­‰å…¶å®æ˜¯æ²¡æœ‰åŠæ³•å»æ‰§è¡Œè®¿é—®æˆ‘ä»¬æ“ä½œç³»ç»Ÿçš„ç¡¬ä»¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘è¡Œç‰ˆçš„è¿™ä¸ªå£³å­å»è®¿é—®å†…æ ¸ï¼Œå†é€šè¿‡å†…æ ¸å»è®¿é—®è®¡ç®—æœºç¡¬ä»¶<br>è®¡ç®—æœºç¡¬ä»¶åŒ…æ‹¬ï¼Œå¦‚cpuï¼Œå†…å­˜ï¼Œç½‘å¡ç­‰ç­‰ï¼Œå†…æ ¸ï¼ˆé€šè¿‡å¯»å€ç©ºé—´ï¼‰å¯ä»¥æ“ä½œç¡¬ä»¶çš„ï¼Œä½†æ˜¯å†…æ ¸éœ€è¦ä¸åŒè®¾å¤‡çš„é©±åŠ¨ï¼Œæœ‰äº†è¿™äº›é©±åŠ¨ä¹‹åï¼Œå†…æ ¸å°±å¯ä»¥å»å¯¹è®¡ç®—æœºç¡¬ä»¶å»è¿›è¡Œ å†…å­˜ç®¡ç†ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„ç®¡ç†ï¼Œè¿›ç¨‹çš„ç®¡ç†ç­‰ç­‰</p>
<p><img src="/img/blogs/java/redis/4.2.1.png" srcset="/img/loading.gif" lazyload></p>
<p>ä¸ºäº†é¿å…ç”¨æˆ·åº”ç”¨å¯¼è‡´å†²çªç”šè‡³å†…æ ¸å´©æºƒï¼Œç”¨æˆ·åº”ç”¨ä¸å†…æ ¸æ˜¯åˆ†ç¦»çš„ï¼š</p>
<ul>
<li>è¿›ç¨‹çš„å¯»å€ç©ºé—´åˆ’åˆ†æˆä¸¤éƒ¨åˆ†ï¼š<strong>å†…æ ¸ç©ºé—´ã€ç”¨æˆ·ç©ºé—´</strong></li>
<li>ç”¨æˆ·ç©ºé—´åªèƒ½æ‰§è¡Œå—é™çš„å‘½ä»¤ï¼ˆRing3ï¼‰ï¼Œè€Œä¸”ä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºï¼Œå¿…é¡»é€šè¿‡å†…æ ¸æä¾›çš„æ¥å£æ¥è®¿</li>
<li>å†…æ ¸ç©ºé—´å¯ä»¥æ‰§è¡Œç‰¹æƒå‘½ä»¤ï¼ˆRing0ï¼‰ï¼Œè°ƒç”¨ä¸€åˆ‡ç³»ç»Ÿèµ„æº</li>
</ul>
<p>Linuxç³»ç»Ÿä¸ºäº†æé«˜IOæ•ˆç‡ï¼Œä¼šåœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´éƒ½åŠ å…¥ç¼“å†²åŒºï¼š</p>
<ul>
<li>å†™æ•°æ®æ—¶ï¼Œè¦æŠŠç”¨æˆ·ç¼“å†²æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åå†™å…¥è®¾å¤‡</li>
<li>è¯»æ•°æ®æ—¶ï¼Œè¦ä»è®¾å¤‡è¯»å–æ•°æ®åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-é˜»å¡IO"><a href="#2-2-é˜»å¡IO" class="headerlink" title="2.2 é˜»å¡IO"></a>2.2 é˜»å¡IO</h3><p>æ€»ç»“å½’çº³äº†5ç§IOæ¨¡å‹ï¼š</p>
<ul>
<li>é˜»å¡IOï¼ˆBlocking IOï¼‰</li>
<li>éé˜»å¡IOï¼ˆNonblocking IOï¼‰</li>
<li>IOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexingï¼‰</li>
<li>ä¿¡å·é©±åŠ¨IOï¼ˆSignal Driven IOï¼‰</li>
<li>å¼‚æ­¥IOï¼ˆAsynchronous IOï¼‰</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p>ç”¨æˆ·å»è¯»å–æ•°æ®æ—¶ï¼Œä¼šå»å…ˆå‘èµ·recvformä¸€ä¸ªå‘½ä»¤ï¼Œå»å°è¯•ä»å†…æ ¸ä¸ŠåŠ è½½æ•°æ®ï¼Œå¦‚æœå†…æ ¸æ²¡æœ‰æ•°æ®ï¼Œé‚£ä¹ˆç”¨æˆ·å°±ä¼šç­‰å¾…ï¼Œæ­¤æ—¶å†…æ ¸ä¼šå»ä»ç¡¬ä»¶ä¸Šè¯»å–æ•°æ®ï¼Œå†…æ ¸è¯»å–æ•°æ®ä¹‹åï¼Œä¼šæŠŠæ•°æ®æ‹·è´åˆ°ç”¨æˆ·æ€ï¼Œå¹¶ä¸”è¿”å›okï¼Œæ•´ä¸ªè¿‡ç¨‹ï¼Œéƒ½æ˜¯é˜»å¡ç­‰å¾…çš„ï¼Œè¿™å°±æ˜¯é˜»å¡IO<br>é¡¾åæ€ä¹‰ï¼Œé˜»å¡IOå°±æ˜¯ä¸¤ä¸ªé˜¶æ®µéƒ½å¿…é¡»é˜»å¡ç­‰å¾…ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="/img/blogs/java/redis/4.2.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>é˜¶æ®µä¸€ï¼š</strong></p>
<ul>
<li>ç”¨æˆ·è¿›ç¨‹å°è¯•è¯»å–æ•°æ®ï¼ˆæ¯”å¦‚ç½‘å¡æ•°æ®ï¼‰</li>
<li>æ­¤æ—¶æ•°æ®å°šæœªåˆ°è¾¾ï¼Œå†…æ ¸éœ€è¦ç­‰å¾…æ•°æ®</li>
<li>æ­¤æ—¶ç”¨æˆ·è¿›ç¨‹ä¹Ÿå¤„äºé˜»å¡çŠ¶æ€</li>
</ul>
<p>é˜¶æ®µäºŒï¼š</p>
<ul>
<li>æ•°æ®åˆ°è¾¾å¹¶æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œä»£è¡¨å·²å°±ç»ª</li>
<li>å°†å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li>
<li>æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶é˜»å¡ç­‰å¾…</li>
<li>æ‹·è´å®Œæˆï¼Œç”¨æˆ·è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œå¤„ç†æ•°æ®</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œé˜»å¡IOæ¨¡å‹ä¸­ï¼Œ<strong>ç”¨æˆ·è¿›ç¨‹åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯é˜»å¡çŠ¶æ€</strong>ã€‚</p>
<h3 id="2-3-éé˜»å¡IO"><a href="#2-3-éé˜»å¡IO" class="headerlink" title="2.3 éé˜»å¡IO"></a>2.3 éé˜»å¡IO</h3><p>é¡¾åæ€ä¹‰ï¼Œéé˜»å¡IOçš„recvfromæ“ä½œä¼š<strong>ç«‹å³è¿”å›ç»“æœ</strong>è€Œä¸æ˜¯é˜»å¡ç”¨æˆ·è¿›ç¨‹ã€‚</p>
<p>é˜¶æ®µä¸€ï¼š</p>
<ul>
<li>ç”¨æˆ·è¿›ç¨‹å°è¯•è¯»å–æ•°æ®ï¼ˆæ¯”å¦‚ç½‘å¡æ•°æ®ï¼‰</li>
<li>æ­¤æ—¶æ•°æ®å°šæœªåˆ°è¾¾ï¼Œå†…æ ¸éœ€è¦ç­‰å¾…æ•°æ®</li>
<li>è¿”å›å¼‚å¸¸ç»™ç”¨æˆ·è¿›ç¨‹</li>
<li>ç”¨æˆ·è¿›ç¨‹æ‹¿åˆ°erroråï¼Œå†æ¬¡å°è¯•è¯»å–</li>
<li><strong>å¾ªç¯å¾€å¤ï¼Œç›´åˆ°æ•°æ®å°±ç»ª</strong></li>
</ul>
<p>é˜¶æ®µäºŒï¼š</p>
<ul>
<li>å°†å†…æ ¸æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒº</li>
<li>æ‹·è´è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹ä¾ç„¶é˜»å¡ç­‰å¾…</li>
<li>æ‹·è´å®Œæˆï¼Œç”¨æˆ·è¿›ç¨‹è§£é™¤é˜»å¡ï¼Œå¤„ç†æ•°æ®</li>
<li>å¯ä»¥çœ‹åˆ°ï¼Œéé˜»å¡IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µæ˜¯éé˜»å¡ï¼Œç¬¬äºŒä¸ªé˜¶æ®µæ˜¯é˜»å¡çŠ¶æ€ã€‚è™½ç„¶æ˜¯éé˜»å¡ï¼Œä½†æ€§èƒ½å¹¶æ²¡æœ‰å¾—åˆ°æé«˜ã€‚è€Œä¸”å¿™ç­‰æœºåˆ¶ä¼šå¯¼è‡´CPUç©ºè½¬ï¼ŒCPUä½¿ç”¨ç‡æš´å¢ã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-4-IOå¤šè·¯å¤ç”¨"><a href="#2-4-IOå¤šè·¯å¤ç”¨" class="headerlink" title="2.4 IOå¤šè·¯å¤ç”¨"></a>2.4 IOå¤šè·¯å¤ç”¨</h3><p>æ— è®ºæ˜¯é˜»å¡IOè¿˜æ˜¯éé˜»å¡IOï¼Œç”¨æˆ·åº”ç”¨åœ¨ä¸€é˜¶æ®µéƒ½éœ€è¦è°ƒç”¨recvfromæ¥è·å–æ•°æ®ï¼Œå·®åˆ«åœ¨äºæ— æ•°æ®æ—¶çš„å¤„ç†æ–¹æ¡ˆï¼š</p>
<ul>
<li><p>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æ²¡æœ‰æ•°æ®ï¼Œé˜»å¡IOä¼šä½¿CPUé˜»å¡ï¼Œéé˜»å¡IOä½¿CPUç©ºè½¬ï¼Œéƒ½ä¸èƒ½å……åˆ†å‘æŒ¥CPUçš„ä½œç”¨ã€‚</p>
</li>
<li><p>å¦‚æœè°ƒç”¨recvfromæ—¶ï¼Œæ°å¥½æœ‰æ•°æ®ï¼Œåˆ™ç”¨æˆ·è¿›ç¨‹å¯ä»¥ç›´æ¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œè¯»å–å¹¶å¤„ç†æ•°æ®<br>è€Œåœ¨å•çº¿ç¨‹æƒ…å†µä¸‹ï¼Œåªèƒ½ä¾æ¬¡å¤„ç†IOäº‹ä»¶ï¼Œå¦‚æœæ­£åœ¨å¤„ç†çš„IOäº‹ä»¶æ°å¥½æœªå°±ç»ªï¼ˆæ•°æ®ä¸å¯è¯»æˆ–ä¸å¯å†™ï¼‰ï¼Œçº¿ç¨‹å°±ä¼šè¢«é˜»å¡ï¼Œæ‰€æœ‰IOäº‹ä»¶éƒ½å¿…é¡»ç­‰å¾…ï¼Œæ€§èƒ½è‡ªç„¶ä¼šå¾ˆå·®ã€‚</p>
</li>
<li><p><strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼ˆFile Descriptorï¼‰ï¼šç®€ç§°FDï¼Œæ˜¯ä¸€ä¸ªä»0 å¼€å§‹çš„æ— ç¬¦å·æ•´æ•°ï¼Œç”¨æ¥å…³è”Linuxä¸­çš„ä¸€ä¸ªæ–‡ä»¶ã€‚åœ¨Linuxä¸­ï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼Œä¾‹å¦‚å¸¸è§„æ–‡ä»¶ã€è§†é¢‘ã€ç¡¬ä»¶è®¾å¤‡ç­‰ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬ç½‘ç»œå¥—æ¥å­—ï¼ˆSocketï¼‰ã€‚</p>
</li>
<li><p>IOå¤šè·¯å¤ç”¨ï¼šæ˜¯åˆ©ç”¨å•ä¸ªçº¿ç¨‹æ¥åŒæ—¶ç›‘å¬å¤šä¸ªFDï¼Œå¹¶åœ¨æŸä¸ªFDå¯è¯»ã€å¯å†™æ—¶å¾—åˆ°é€šçŸ¥ï¼Œä»è€Œé¿å…æ— æ•ˆçš„ç­‰å¾…ï¼Œå……åˆ†åˆ©ç”¨CPUèµ„æºã€‚</p>
</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.6.png" srcset="/img/loading.gif" lazyload></p>
<p>é˜¶æ®µä¸€ï¼š</p>
<ul>
<li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨selectï¼ŒæŒ‡å®šè¦ç›‘å¬çš„FDé›†åˆ</li>
<li>æ ¸ç›‘å¬FDå¯¹åº”çš„å¤šä¸ªsocket</li>
<li>ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªsocketæ•°æ®å°±ç»ªåˆ™è¿”å›readable</li>
<li>æ­¤è¿‡ç¨‹ä¸­ç”¨æˆ·è¿›ç¨‹é˜»å¡</li>
</ul>
<p>é˜¶æ®µäºŒï¼š</p>
<ul>
<li>ç”¨æˆ·è¿›ç¨‹æ‰¾åˆ°å°±ç»ªçš„socket</li>
<li>ä¾æ¬¡è°ƒç”¨recvfromè¯»å–æ•°æ®</li>
<li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li>
<li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li>
</ul>
<h4 id="IOå¤šè·¯å¤ç”¨å¸¸è§æ–¹å¼çš„æœ‰ï¼š"><a href="#IOå¤šè·¯å¤ç”¨å¸¸è§æ–¹å¼çš„æœ‰ï¼š" class="headerlink" title="IOå¤šè·¯å¤ç”¨å¸¸è§æ–¹å¼çš„æœ‰ï¼š"></a>IOå¤šè·¯å¤ç”¨å¸¸è§æ–¹å¼çš„æœ‰ï¼š</h4><ul>
<li><p>select</p>
</li>
<li><p>poll</p>
</li>
<li><p>epoll</p>
</li>
<li><p>å…¶ä¸­selectå’Œpoolç›¸å½“äºæ˜¯å½“è¢«ç›‘å¬çš„æ•°æ®å‡†å¤‡å¥½ä¹‹åï¼Œä»–ä¼šæŠŠä½ ç›‘å¬çš„FDæ•´ä¸ªæ•°æ®éƒ½å‘ç»™ä½ ï¼Œä½ éœ€è¦åˆ°æ•´ä¸ªFDä¸­å»æ‰¾ï¼Œå“ªäº›æ˜¯å¤„ç†å¥½äº†çš„ï¼Œéœ€è¦é€šè¿‡éå†çš„æ–¹å¼ï¼Œæ‰€ä»¥æ€§èƒ½ä¹Ÿå¹¶ä¸æ˜¯é‚£ä¹ˆå¥½</p>
</li>
<li><p>è€Œepollï¼Œåˆ™ç›¸å½“äºå†…æ ¸å‡†å¤‡å¥½äº†ä¹‹åï¼Œä»–ä¼šæŠŠå‡†å¤‡å¥½çš„æ•°æ®ï¼Œç›´æ¥å‘ç»™ä½ ï¼Œå’±ä»¬å°±çœå»äº†éå†çš„åŠ¨ä½œã€‚</p>
</li>
</ul>
<h3 id="2-5-IOå¤šè·¯å¤ç”¨çš„ä¸‰ç§æ–¹å¼"><a href="#2-5-IOå¤šè·¯å¤ç”¨çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="2.5 IOå¤šè·¯å¤ç”¨çš„ä¸‰ç§æ–¹å¼"></a>2.5 IOå¤šè·¯å¤ç”¨çš„ä¸‰ç§æ–¹å¼</h3><h4 id="2-5-1-selectæ–¹å¼"><a href="#2-5-1-selectæ–¹å¼" class="headerlink" title="2.5.1 selectæ–¹å¼"></a>2.5.1 selectæ–¹å¼</h4><p><img src="/img/blogs/java/redis/4.2.7.png" srcset="/img/loading.gif" lazyload></p>
<p>selectæ¨¡å¼å­˜åœ¨çš„é—®é¢˜ï¼š</p>
<ul>
<li>éœ€è¦å°†æ•´ä¸ªfd_setä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œselectç»“æŸè¿˜è¦å†æ¬¡æ‹·è´å›ç”¨æˆ·ç©ºé—´</li>
<li>selectæ— æ³•å¾—çŸ¥å…·ä½“æ˜¯å“ªä¸ªfdå°±ç»ªï¼Œéœ€è¦éå†æ•´ä¸ªfd_set</li>
<li>fd_setç›‘å¬çš„fdæ•°é‡ä¸èƒ½è¶…è¿‡1024</li>
</ul>
<h4 id="2-5-2-pollæ¨¡å¼"><a href="#2-5-2-pollæ¨¡å¼" class="headerlink" title="2.5.2 pollæ¨¡å¼"></a>2.5.2 pollæ¨¡å¼</h4><p>pollæ¨¡å¼å¯¹selectæ¨¡å¼åšäº†ç®€å•æ”¹è¿›ï¼Œä½†æ€§èƒ½æå‡ä¸æ˜æ˜¾</p>
<p>IOæµç¨‹ï¼š</p>
<ul>
<li>åˆ›å»ºpollfdæ•°ç»„ï¼Œå‘å…¶ä¸­æ·»åŠ å…³æ³¨çš„fdä¿¡æ¯ï¼Œæ•°ç»„å¤§å°è‡ªå®šä¹‰</li>
<li>è°ƒç”¨pollå‡½æ•°ï¼Œå°†pollfdæ•°ç»„æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼Œè½¬é“¾è¡¨å­˜å‚¨ï¼Œæ— ä¸Šé™</li>
<li>å†…æ ¸éå†fdï¼Œåˆ¤æ–­æ˜¯å¦å°±ç»ª</li>
<li>æ•°æ®å°±ç»ªæˆ–è¶…æ—¶åï¼Œæ‹·è´pollfdæ•°ç»„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè¿”å›å°±ç»ªfdæ•°é‡n</li>
<li>ç”¨æˆ·è¿›ç¨‹åˆ¤æ–­næ˜¯å¦å¤§äº0,å¤§äº0åˆ™éå†pollfdæ•°ç»„ï¼Œæ‰¾åˆ°å°±ç»ªçš„fd</li>
</ul>
<p><strong>ä¸selectå¯¹æ¯”ï¼š</strong></p>
<ul>
<li>selectæ¨¡å¼ä¸­çš„fd_setå¤§å°å›ºå®šä¸º1024ï¼Œè€Œpollfdåœ¨å†…æ ¸ä¸­é‡‡ç”¨é“¾è¡¨ï¼Œç†è®ºä¸Šæ— ä¸Šé™</li>
<li>ç›‘å¬FDè¶Šå¤šï¼Œæ¯æ¬¡éå†æ¶ˆè€—æ—¶é—´ä¹Ÿè¶Šä¹…ï¼Œæ€§èƒ½åè€Œä¼šä¸‹é™</li>
</ul>
<h4 id="2-5-3-epollå‡½æ•°"><a href="#2-5-3-epollå‡½æ•°" class="headerlink" title="2.5.3 epollå‡½æ•°"></a>2.5.3 epollå‡½æ•°</h4><p>epollæ¨¡å¼æ˜¯å¯¹selectå’Œpollçš„æ”¹è¿›ï¼Œå®ƒæä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p>
<ol>
<li>çº¢é»‘æ ‘-&gt; è®°å½•çš„äº‹è¦ç›‘å¬çš„FD</li>
<li>ä¸€ä¸ªæ˜¯é“¾è¡¨-&gt;ä¸€ä¸ªé“¾è¡¨ï¼Œè®°å½•çš„æ˜¯å°±ç»ªçš„FD</li>
</ol>
<ul>
<li>ç´§æ¥ç€è°ƒç”¨epoll_ctlæ“ä½œï¼Œå°†è¦ç›‘å¬çš„æ•°æ®æ·»åŠ åˆ°çº¢é»‘æ ‘ä¸Šå»ï¼Œå¹¶ä¸”ç»™æ¯ä¸ªfdè®¾ç½®ä¸€ä¸ªç›‘å¬å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨fdæ•°æ®å°±ç»ªæ—¶è§¦å‘ï¼Œå°±æ˜¯å‡†å¤‡å¥½äº†ï¼Œç°åœ¨å°±æŠŠfdæŠŠæ•°æ®æ·»åŠ åˆ°list_headä¸­å»</li>
</ul>
<ol start="3">
<li>è°ƒç”¨epoll_waitå‡½æ•°</li>
</ol>
<ul>
<li>å°±å»ç­‰å¾…ï¼Œåœ¨ç”¨æˆ·æ€åˆ›å»ºä¸€ä¸ªç©ºçš„eventsæ•°ç»„ï¼Œå½“å°±ç»ªä¹‹åï¼Œæˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¼šæŠŠæ•°æ®æ·»åŠ åˆ°list_headä¸­å»ï¼Œå½“è°ƒç”¨è¿™ä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œä¼šå»æ£€æŸ¥list_headï¼Œå½“ç„¶è¿™ä¸ªè¿‡ç¨‹éœ€è¦å‚è€ƒé…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œå¯ä»¥ç­‰ä¸€å®šæ—¶é—´ï¼Œä¹Ÿå¯ä»¥ä¸€ç›´ç­‰ï¼Œ å¦‚æœåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥åˆ°äº†list_headä¸­æœ‰æ•°æ®ä¼šå°†æ•°æ®æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œæ­¤æ—¶å°†æ•°æ®æ”¾å…¥åˆ°eventsæ•°ç»„ä¸­ï¼Œå¹¶ä¸”è¿”å›å¯¹åº”çš„æ“ä½œçš„æ•°é‡ï¼Œç”¨æˆ·æ€çš„æ­¤æ—¶æ”¶åˆ°å“åº”åï¼Œä»eventsä¸­æ‹¿åˆ°å¯¹åº”å‡†å¤‡å¥½çš„æ•°æ®çš„èŠ‚ç‚¹ï¼Œå†å»è°ƒç”¨æ–¹æ³•å»æ‹¿æ•°æ®ã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.8.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-5-4-æ€»ç»“"><a href="#2-5-4-æ€»ç»“" class="headerlink" title="2.5.4 æ€»ç»“"></a>2.5.4 æ€»ç»“</h4><p>selectæ¨¡å¼å­˜åœ¨çš„ä¸‰ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>èƒ½ç›‘å¬çš„FDæœ€å¤§ä¸è¶…è¿‡1024</li>
<li>æ¯æ¬¡selectéƒ½éœ€è¦æŠŠæ‰€æœ‰è¦ç›‘å¬çš„FDéƒ½æ‹·è´åˆ°å†…æ ¸ç©ºé—´</li>
<li>æ¯æ¬¡éƒ½è¦éå†æ‰€æœ‰FDæ¥åˆ¤æ–­å°±ç»ªçŠ¶æ€</li>
</ul>
<p>pollæ¨¡å¼çš„é—®é¢˜ï¼š</p>
<ul>
<li>pollåˆ©ç”¨é“¾è¡¨è§£å†³äº†selectä¸­ç›‘å¬FDä¸Šé™çš„é—®é¢˜ï¼Œä½†ä¾ç„¶è¦éå†æ‰€æœ‰FDï¼Œå¦‚æœç›‘å¬è¾ƒå¤šï¼Œæ€§èƒ½ä¼šä¸‹é™</li>
</ul>
<p>epollæ¨¡å¼ä¸­å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ï¼Ÿ</p>
<ul>
<li>åŸºäºepollå®ä¾‹ä¸­çš„çº¢é»‘æ ‘ä¿å­˜è¦ç›‘å¬çš„FDï¼Œç†è®ºä¸Šæ— ä¸Šé™ï¼Œè€Œä¸”å¢åˆ æ”¹æŸ¥æ•ˆç‡éƒ½éå¸¸é«˜</li>
<li>æ¯ä¸ªFDåªéœ€è¦æ‰§è¡Œä¸€æ¬¡epoll_ctlæ·»åŠ åˆ°çº¢é»‘æ ‘ï¼Œä»¥åæ¯æ¬¡epol_waitæ— éœ€ä¼ é€’ä»»ä½•å‚æ•°ï¼Œæ— éœ€é‡å¤æ‹·è´FDåˆ°å†…æ ¸ç©ºé—´</li>
<li>åˆ©ç”¨ep_poll_callbackæœºåˆ¶æ¥ç›‘å¬FDçŠ¶æ€ï¼Œæ— éœ€éå†æ‰€æœ‰FDï¼Œå› æ­¤æ€§èƒ½ä¸ä¼šéšç›‘å¬çš„FDæ•°é‡å¢å¤šè€Œä¸‹é™</li>
</ul>
<h3 id="2-6-IOå¤šè·¯å¤ç”¨-epoll"><a href="#2-6-IOå¤šè·¯å¤ç”¨-epoll" class="headerlink" title="2.6 IOå¤šè·¯å¤ç”¨-epoll"></a>2.6 IOå¤šè·¯å¤ç”¨-epoll</h3><h4 id="2-6-1-æ—¶é—´é€šçŸ¥æœºåˆ¶"><a href="#2-6-1-æ—¶é—´é€šçŸ¥æœºåˆ¶" class="headerlink" title="2.6.1 æ—¶é—´é€šçŸ¥æœºåˆ¶"></a>2.6.1 æ—¶é—´é€šçŸ¥æœºåˆ¶</h4><p>å½“FDæœ‰æ•°æ®å¯è¯»æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨epoll_waitï¼ˆæˆ–è€…selectã€pollï¼‰å¯ä»¥å¾—åˆ°é€šçŸ¥ã€‚ä½†æ˜¯äº‹ä»¶é€šçŸ¥çš„æ¨¡å¼æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>LevelTriggeredï¼šç®€ç§°LTï¼Œä¹Ÿå«åšæ°´å¹³è§¦å‘ã€‚åªè¦æŸä¸ªFDä¸­æœ‰æ•°æ®å¯è¯»ï¼Œæ¯æ¬¡è°ƒç”¨epoll_waitéƒ½ä¼šå¾—åˆ°é€šçŸ¥ã€‚</li>
<li>EdgeTriggeredï¼šç®€ç§°ETï¼Œä¹Ÿå«åšè¾¹æ²¿è§¦å‘ã€‚åªæœ‰åœ¨æŸä¸ªFDæœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼Œè°ƒç”¨epoll_waitæ‰ä¼šè¢«é€šçŸ¥ã€‚</li>
</ul>
<h4 id="2-6-2-åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹"><a href="#2-6-2-åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹" class="headerlink" title="2.6.2 åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹"></a>2.6.2 åŸºäºepollçš„æœåŠ¡å™¨ç«¯æµç¨‹</h4><p>åŸºäºepollæ¨¡å¼çš„webæœåŠ¡çš„åŸºæœ¬æµç¨‹å¦‚å›¾ï¼š</p>
<p><img src="/img/blogs/java/redis/4.2.9.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-ä¿¡å·é©±åŠ¨IO"><a href="#2-7-ä¿¡å·é©±åŠ¨IO" class="headerlink" title="2.7 ä¿¡å·é©±åŠ¨IO"></a>2.7 ä¿¡å·é©±åŠ¨IO</h3><p>ä¿¡å·é©±åŠ¨IOæ˜¯ä¸å†…æ ¸å»ºç«‹SIGIOçš„ä¿¡å·å…³è”å¹¶è®¾ç½®å›è°ƒï¼Œå½“å†…æ ¸æœ‰FDå°±ç»ªæ—¶ï¼Œä¼šå‘å‡ºSIGIOä¿¡å·é€šçŸ¥ç”¨æˆ·ï¼ŒæœŸé—´ç”¨æˆ·åº”ç”¨å¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡ï¼Œæ— éœ€é˜»å¡ç­‰å¾…ã€‚</p>
<p>é˜¶æ®µä¸€ï¼š</p>
<ul>
<li>ç”¨æˆ·è¿›ç¨‹è°ƒç”¨sigactionï¼Œæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°</li>
<li>å†…æ ¸è¿”å›æˆåŠŸï¼Œå¼€å§‹ç›‘å¬FD</li>
<li>ç”¨æˆ·è¿›ç¨‹ä¸é˜»å¡ç­‰å¾…ï¼Œå¯ä»¥æ‰§è¡Œå…¶å®ƒä¸šåŠ¡</li>
<li>å½“å†…æ ¸æ•°æ®å°±ç»ªåï¼Œå›è°ƒç”¨æˆ·è¿›ç¨‹çš„SIGIOå¤„ç†å‡½æ•°</li>
</ul>
<p>é˜¶æ®µäºŒï¼š</p>
<ul>
<li>æ”¶åˆ°SIGIOå›è°ƒä¿¡å·</li>
<li>è°ƒç”¨recvfromï¼Œè¯»å–</li>
<li>å†…æ ¸å°†æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´</li>
<li>ç”¨æˆ·è¿›ç¨‹å¤„ç†æ•°æ®</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.10.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>ç¼ºç‚¹ï¼šå½“æœ‰å¤§é‡IOæ“ä½œæ—¶ï¼Œä¿¡å·è¾ƒå¤šï¼ŒSIGIOå¤„ç†å‡½æ•°ä¸èƒ½åŠæ—¶å¤„ç†å¯èƒ½å¯¼è‡´ä¿¡å·é˜Ÿåˆ—æº¢å‡ºï¼Œè€Œä¸”å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´çš„é¢‘ç¹ä¿¡å·äº¤äº’æ€§èƒ½ä¹Ÿè¾ƒä½ã€‚</li>
</ul>
<h3 id="2-8-å¼‚æ­¥IO"><a href="#2-8-å¼‚æ­¥IO" class="headerlink" title="2.8 å¼‚æ­¥IO"></a>2.8 å¼‚æ­¥IO</h3><p>å¼‚æ­¥IOçš„æ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯éé˜»å¡çš„ï¼Œç”¨æˆ·è¿›ç¨‹è°ƒç”¨å®Œå¼‚æ­¥APIåå°±å¯ä»¥å»åšå…¶å®ƒäº‹æƒ…ï¼Œå†…æ ¸ç­‰å¾…æ•°æ®å°±ç»ªå¹¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´åæ‰ä¼šé€’äº¤ä¿¡å·ï¼Œé€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚</p>
<ul>
<li>å¼‚æ­¥IOæ¨¡å‹ä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨ä¸¤ä¸ªé˜¶æ®µéƒ½æ˜¯éé˜»å¡çŠ¶æ€ã€‚</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.11.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-9-äº”ç§IOæ¨¡å‹å¯¹æ¯”"><a href="#2-9-äº”ç§IOæ¨¡å‹å¯¹æ¯”" class="headerlink" title="2.9 äº”ç§IOæ¨¡å‹å¯¹æ¯”"></a>2.9 äº”ç§IOæ¨¡å‹å¯¹æ¯”</h3><p><img src="/img/blogs/java/redis/4.2.12.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-10-Redisç½‘ç»œæ¨¡å‹"><a href="#2-10-Redisç½‘ç»œæ¨¡å‹" class="headerlink" title="2.10 Redisç½‘ç»œæ¨¡å‹"></a>2.10 Redisç½‘ç»œæ¨¡å‹</h3><h4 id="2-10-1-Redisæ˜¯å•çº¿ç¨‹çš„å—ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹"><a href="#2-10-1-Redisæ˜¯å•çº¿ç¨‹çš„å—ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹" class="headerlink" title="2.10.1 Redisæ˜¯å•çº¿ç¨‹çš„å—ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹"></a>2.10.1 Redisæ˜¯å•çº¿ç¨‹çš„å—ï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹</h4><p><strong>Redisåˆ°åº•æ˜¯å•çº¿ç¨‹è¿˜æ˜¯å¤šçº¿ç¨‹ï¼Ÿ</strong></p>
<ul>
<li>å¦‚æœä»…ä»…èŠRedisçš„æ ¸å¿ƒä¸šåŠ¡éƒ¨åˆ†ï¼ˆå‘½ä»¤å¤„ç†ï¼‰ï¼Œç­”æ¡ˆæ˜¯å•çº¿ç¨‹</li>
<li>å¦‚æœæ˜¯èŠæ•´ä¸ªRedisï¼Œé‚£ä¹ˆç­”æ¡ˆå°±æ˜¯å¤šçº¿ç¨‹</li>
</ul>
<p>åœ¨Redisç‰ˆæœ¬è¿­ä»£è¿‡ç¨‹ä¸­ï¼Œåœ¨ä¸¤ä¸ªé‡è¦çš„æ—¶é—´èŠ‚ç‚¹ä¸Šå¼•å…¥äº†å¤šçº¿ç¨‹çš„æ”¯æŒï¼š</p>
<ul>
<li>Redis v4.0ï¼šå¼•å…¥å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†ä¸€äº›è€—æ—¶è¾ƒæ—§çš„ä»»åŠ¡ï¼Œä¾‹å¦‚å¼‚æ­¥åˆ é™¤å‘½ä»¤unlink</li>
<li>Redis v6.0ï¼šåœ¨æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä¸­å¼•å…¥ å¤šçº¿ç¨‹ï¼Œè¿›ä¸€æ­¥æé«˜å¯¹äºå¤šæ ¸CPUçš„åˆ©ç”¨ç‡</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆRedisè¦é€‰æ‹©å•çº¿ç¨‹ï¼Ÿ</strong></p>
<ul>
<li>æŠ›å¼€æŒä¹…åŒ–ä¸è°ˆï¼ŒRedisæ˜¯çº¯  å†…å­˜æ“ä½œï¼Œæ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ï¼Œå®ƒçš„æ€§èƒ½ç“¶é¢ˆæ˜¯ç½‘ç»œå»¶è¿Ÿè€Œä¸æ˜¯æ‰§è¡Œé€Ÿåº¦ï¼Œå› æ­¤å¤šçº¿ç¨‹å¹¶ä¸ä¼šå¸¦æ¥å·¨å¤§çš„æ€§èƒ½æå‡ã€‚</li>
<li>å¤šçº¿ç¨‹ä¼šå¯¼è‡´è¿‡å¤šçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€</li>
<li>å¼•å…¥å¤šçº¿ç¨‹ä¼šé¢ä¸´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå¿…ç„¶è¦å¼•å…¥çº¿ç¨‹é”è¿™æ ·çš„å®‰å…¨æ‰‹æ®µï¼Œå®ç°å¤æ‚åº¦å¢é«˜ï¼Œè€Œä¸”æ€§èƒ½ä¹Ÿä¼šå¤§æ‰“æŠ˜æ‰£</li>
</ul>
<h4 id="2-10-2-Rediså•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å˜æ›´"><a href="#2-10-2-Rediså•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å˜æ›´" class="headerlink" title="2.10.2 Rediså•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å˜æ›´"></a>2.10.2 Rediså•çº¿ç¨‹å’Œå¤šçº¿ç¨‹ç½‘ç»œæ¨¡å‹å˜æ›´</h4><p>Redisé€šè¿‡<strong>IOå¤šè·¯å¤ç”¨æ¥æé«˜ç½‘ç»œæ€§èƒ½</strong>ï¼Œå¹¶ä¸”æ”¯æŒå„ç§ä¸åŒçš„å¤šè·¯å¤ç”¨å®ç°ï¼Œå¹¶ä¸”å°†è¿™äº›å®ç°è¿›è¡Œå°è£…ï¼Œ æä¾›äº†ç»Ÿä¸€çš„é«˜æ€§èƒ½äº‹ä»¶åº“APIåº“ AE<br>Redis 6.0ç‰ˆæœ¬ä¸­å¼•å…¥äº†å¤šçº¿ç¨‹ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜IOè¯»å†™æ•ˆç‡ã€‚å› æ­¤åœ¨è§£æå®¢æˆ·ç«¯å‘½ä»¤ã€å†™å“åº”ç»“æœæ—¶é‡‡ç”¨äº†å¤šçº¿ç¨‹ã€‚æ ¸å¿ƒçš„å‘½ä»¤æ‰§è¡Œã€IOå¤šè·¯å¤ç”¨æ¨¡å—ä¾ç„¶æ˜¯ç”±ä¸»çº¿ç¨‹æ‰§è¡Œã€‚</p>
<h2 id="3-é€šä¿¡åè®®"><a href="#3-é€šä¿¡åè®®" class="headerlink" title="3. é€šä¿¡åè®®"></a>3. é€šä¿¡åè®®</h2><h3 id="3-1-RESPåè®®"><a href="#3-1-RESPåè®®" class="headerlink" title="3.1 RESPåè®®"></a>3.1 RESPåè®®</h3><p>Redisæ˜¯ä¸€ä¸ªCSæ¶æ„çš„è½¯ä»¶ï¼Œé€šä¿¡ä¸€èˆ¬åˆ†ä¸¤æ­¥ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ï¼ˆclientï¼‰å‘æœåŠ¡ç«¯ï¼ˆserverï¼‰å‘é€ä¸€æ¡å‘½ä»¤</li>
<li>æœåŠ¡ç«¯è§£æå¹¶æ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›å“åº”ç»“æœç»™å®¢æˆ·ç«¯</li>
</ul>
<p>å› æ­¤å®¢æˆ·ç«¯å‘é€å‘½ä»¤çš„æ ¼å¼ã€æœåŠ¡ç«¯å“åº”ç»“æœçš„æ ¼å¼å¿…é¡»æœ‰ä¸€ä¸ªè§„èŒƒï¼Œè¿™ä¸ªè§„èŒƒå°±æ˜¯é€šä¿¡åè®®ã€‚</p>
<ul>
<li>è€Œåœ¨Redisä¸­é‡‡ç”¨çš„æ˜¯RESPï¼ˆRedis Serialization Protocolï¼‰åè®®ï¼š</li>
</ul>
<h4 id="RESPåè®®çš„æ•°æ®ç±»å‹"><a href="#RESPåè®®çš„æ•°æ®ç±»å‹" class="headerlink" title="RESPåè®®çš„æ•°æ®ç±»å‹"></a>RESPåè®®çš„æ•°æ®ç±»å‹</h4><p>åœ¨RESPä¸­ï¼Œé€šè¿‡é¦–å­—èŠ‚çš„å­—ç¬¦æ¥åŒºåˆ†ä¸åŒæ•°æ®ç±»å‹ï¼Œå¸¸ç”¨çš„æ•°æ®ç±»å‹åŒ…æ‹¬5ç§ï¼š</p>
<ol>
<li>å•è¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜+â€™ ï¼Œåé¢è·Ÿä¸Šå•è¡Œå­—ç¬¦ä¸²ï¼Œä»¥CRLFï¼ˆ â€œ\r\nâ€ ï¼‰ç»“å°¾ã€‚ä¾‹å¦‚è¿”å›â€OKâ€ï¼š â€œ+OK\r\nâ€</li>
<li>é”™è¯¯ï¼ˆErrorsï¼‰ï¼šé¦–å­—èŠ‚æ˜¯ â€˜-â€™ ï¼Œä¸å•è¡Œå­—ç¬¦ä¸²æ ¼å¼ä¸€æ ·ï¼Œåªæ˜¯å­—ç¬¦ä¸²æ˜¯å¼‚å¸¸ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼šâ€-Error message\r\nâ€</li>
<li>æ•°å€¼ï¼šé¦–å­—èŠ‚æ˜¯ â€˜:â€™ ï¼Œåé¢è·Ÿä¸Šæ•°å­—æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œä»¥CRLFç»“å°¾ã€‚ä¾‹å¦‚ï¼šâ€:10\r\nâ€</li>
<li>å¤šè¡Œå­—ç¬¦ä¸²ï¼šé¦–å­—èŠ‚æ˜¯ â€˜$â€™ ï¼Œè¡¨ç¤ºäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œæœ€å¤§æ”¯æŒ512MBï¼š<ul>
<li>å¦‚æœå¤§å°ä¸º0ï¼Œåˆ™ä»£è¡¨ç©ºå­—ç¬¦ä¸²ï¼šâ€$0\r\n\r\nâ€</li>
<li>å¦‚æœå¤§å°ä¸º-1ï¼Œåˆ™ä»£è¡¨ä¸å­˜åœ¨ï¼šâ€$-1\r\nâ€</li>
</ul>
</li>
<li>æ•°ç»„ï¼šé¦–å­—èŠ‚æ˜¯ â€˜*â€™ï¼Œåé¢è·Ÿä¸Šæ•°ç»„å…ƒç´ ä¸ªæ•°ï¼Œå†è·Ÿä¸Šå…ƒç´ ï¼Œå…ƒç´ æ•°æ®ç±»å‹ä¸é™:</li>
</ol>
<h3 id="3-2-åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯"><a href="#3-2-åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯" class="headerlink" title="3.2 åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯"></a>3.2 åŸºäºSocketè‡ªå®šä¹‰Redisçš„å®¢æˆ·ç«¯</h3><p>Redisæ”¯æŒTCPé€šä¿¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Socketæ¥æ¨¡æ‹Ÿå®¢æˆ·ç«¯ï¼Œä¸RedisæœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">static</span> Socket s;<br>    <span class="hljs-keyword">static</span> PrintWriter writer;<br>    <span class="hljs-keyword">static</span> BufferedReader reader;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 1.å»ºç«‹è¿æ¥</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.150.101&quot;</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">6379</span>;<br>            s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(host, port);<br>            <span class="hljs-comment">// 2.è·å–è¾“å‡ºæµã€è¾“å…¥æµ</span><br>            writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(s.getOutputStream(), StandardCharsets.UTF_8));<br>            reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(s.getInputStream(), StandardCharsets.UTF_8));<br><br>            <span class="hljs-comment">// 3.å‘å‡ºè¯·æ±‚</span><br>            <span class="hljs-comment">// 3.1.è·å–æˆæƒ auth 123321</span><br>            sendRequest(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;123321&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name è™å“¥</span><br>            sendRequest(<span class="hljs-string">&quot;set&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è™å“¥&quot;</span>);<br>            <span class="hljs-comment">// 4.è§£æå“åº”</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name è™å“¥</span><br>            sendRequest(<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-comment">// 4.è§£æå“åº”</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name è™å“¥</span><br>            sendRequest(<span class="hljs-string">&quot;mget&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;num&quot;</span>, <span class="hljs-string">&quot;msg&quot;</span>);<br>            <span class="hljs-comment">// 4.è§£æå“åº”</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 5.é‡Šæ”¾è¿æ¥</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (reader != <span class="hljs-literal">null</span>) reader.close();<br>                <span class="hljs-keyword">if</span> (writer != <span class="hljs-literal">null</span>) writer.close();<br>                <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) s.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">handleResponse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// è¯»å–é¦–å­—èŠ‚</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> reader.read();<br>        <span class="hljs-comment">// åˆ¤æ–­æ•°æ®ç±»å‹æ ‡ç¤º</span><br>        <span class="hljs-keyword">switch</span> (prefix) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>: <span class="hljs-comment">// å•è¡Œå­—ç¬¦ä¸²ï¼Œç›´æ¥è¯»ä¸€è¡Œ</span><br>                <span class="hljs-keyword">return</span> reader.readLine();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;-&#x27;</span>: <span class="hljs-comment">// å¼‚å¸¸ï¼Œä¹Ÿè¯»ä¸€è¡Œ</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(reader.readLine());<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;:&#x27;</span>: <span class="hljs-comment">// æ•°å­—</span><br>                <span class="hljs-keyword">return</span> Long.parseLong(reader.readLine());<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;$&#x27;</span>: <span class="hljs-comment">// å¤šè¡Œå­—ç¬¦ä¸²</span><br>                <span class="hljs-comment">// å…ˆè¯»é•¿åº¦</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> Integer.parseInt(reader.readLine());<br>                <span class="hljs-keyword">if</span> (len == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>                &#125;<br>                <span class="hljs-comment">// å†è¯»æ•°æ®,è¯»lenä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬å‡è®¾æ²¡æœ‰ç‰¹æ®Šå­—ç¬¦ï¼Œæ‰€ä»¥è¯»ä¸€è¡Œï¼ˆç®€åŒ–ï¼‰</span><br>                <span class="hljs-keyword">return</span> reader.readLine();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;*&#x27;</span>:<br>                <span class="hljs-keyword">return</span> readBulkString();<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;é”™è¯¯çš„æ•°æ®æ ¼å¼ï¼&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">readBulkString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// è·å–æ•°ç»„å¤§å°</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> Integer.parseInt(reader.readLine());<br>        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// å®šä¹‰é›†åˆï¼Œæ¥æ”¶å¤šä¸ªå…ƒç´ </span><br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(len);<br>        <span class="hljs-comment">// éå†ï¼Œä¾æ¬¡è¯»å–æ¯ä¸ªå…ƒç´ </span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>            list.add(handleResponse());<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>    <span class="hljs-comment">// set name è™å“¥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendRequest</span><span class="hljs-params">(String ... args)</span> &#123;<br>        writer.println(<span class="hljs-string">&quot;*&quot;</span> + args.length);<br>        <span class="hljs-keyword">for</span> (String arg : args) &#123;<br>            writer.println(<span class="hljs-string">&quot;$&quot;</span> + arg.getBytes(StandardCharsets.UTF_8).length);<br>            writer.println(arg);<br>        &#125;<br>        writer.flush();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="4-Rediså†…å­˜å›æ”¶"><a href="#4-Rediså†…å­˜å›æ”¶" class="headerlink" title="4. Rediså†…å­˜å›æ”¶"></a>4. Rediså†…å­˜å›æ”¶</h2><p>Redisä¹‹æ‰€ä»¥æ€§èƒ½å¼ºï¼Œæœ€ä¸»è¦çš„åŸå› å°±æ˜¯åŸºäºå†…å­˜å­˜å‚¨ã€‚ç„¶è€Œå•èŠ‚ç‚¹çš„Rediså…¶å†…å­˜å¤§å°ä¸å®œè¿‡å¤§ï¼Œä¼šå½±å“æŒä¹…åŒ–æˆ–ä¸»ä»åŒæ­¥æ€§èƒ½ã€‚<br>å½“å†…å­˜ä½¿ç”¨è¾¾åˆ°ä¸Šé™æ—¶ï¼Œå°±æ— æ³•å­˜å‚¨æ›´å¤šæ•°æ®äº†ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedisæä¾›äº†ä¸€äº›ç­–ç•¥å®ç°å†…å­˜å›æ”¶ï¼š</p>
<ul>
<li>å†…å­˜è¿‡æœŸç­–ç•¥</li>
<li>å†…å­˜æ·˜æ±°ç­–ç•¥</li>
</ul>
<h3 id="4-1-å†…å­˜è¿‡æœŸç­–ç•¥"><a href="#4-1-å†…å­˜è¿‡æœŸç­–ç•¥" class="headerlink" title="4.1 å†…å­˜è¿‡æœŸç­–ç•¥"></a>4.1 å†…å­˜è¿‡æœŸç­–ç•¥</h3><p>åœ¨å­¦ä¹ Redisç¼“å­˜çš„æ—¶å€™æˆ‘ä»¬è¯´è¿‡ï¼Œå¯ä»¥é€šè¿‡expireå‘½ä»¤ç»™Redisçš„keyè®¾ç½®TTLï¼ˆå­˜æ´»æ—¶é—´ï¼‰ï¼š</p>
<ul>
<li>å¯ä»¥å‘ç°ï¼Œå½“keyçš„TTLåˆ°æœŸä»¥åï¼Œå†æ¬¡è®¿é—®nameè¿”å›çš„æ˜¯nilï¼Œè¯´æ˜è¿™ä¸ªkeyå·²ç»ä¸å­˜åœ¨äº†ï¼Œå¯¹åº”çš„å†…å­˜ä¹Ÿå¾—åˆ°é‡Šæ”¾ã€‚ä»è€Œèµ·åˆ°å†…å­˜å›æ”¶çš„ç›®çš„ã€‚</li>
</ul>
<p>Redisæœ¬èº«æ˜¯ä¸€ä¸ªå…¸å‹çš„key-valueå†…å­˜å­˜å‚¨æ•°æ®åº“ï¼Œå› æ­¤æ‰€æœ‰çš„keyã€valueéƒ½ä¿å­˜åœ¨ä¹‹å‰å­¦ä¹ è¿‡çš„Dictç»“æ„ä¸­ã€‚ä¸è¿‡åœ¨å…¶databaseç»“æ„ä½“ä¸­ï¼Œæœ‰ä¸¤ä¸ªDictï¼šä¸€ä¸ªç”¨æ¥è®°å½•key-valueï¼›å¦ä¸€ä¸ªç”¨æ¥è®°å½•key-TTLã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisDb</span> &#123;</span><br>Â  Â  dict *dict; Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-comment">/* å­˜æ”¾æ‰€æœ‰keyåŠvalueçš„åœ°æ–¹ï¼Œä¹Ÿè¢«ç§°ä¸ºkeyspace*/</span><br>Â  Â  dict *expires; Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">/* å­˜æ”¾æ¯ä¸€ä¸ªkeyåŠå…¶å¯¹åº”çš„TTLå­˜æ´»æ—¶é—´ï¼ŒåªåŒ…å«è®¾ç½®äº†TTLçš„key*/</span><br>Â  Â  dict *blocking_keys; Â  Â  Â  Â <span class="hljs-comment">/* Keys with clients waiting for data (BLPOP)*/</span><br>Â  Â  dict *ready_keys; Â  Â  Â  Â  Â  <span class="hljs-comment">/* Blocked keys that received a PUSH */</span><br>Â  Â  dict *watched_keys; Â  Â  Â  Â  <span class="hljs-comment">/* WATCHED keys for MULTI/EXEC CAS */</span><br>Â  Â  <span class="hljs-type">int</span> id; Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-comment">/* Database IDï¼Œ0~15 */</span><br>Â  Â  <span class="hljs-type">long</span> <span class="hljs-type">long</span> avg_ttl; Â  Â  Â  Â  Â <span class="hljs-comment">/* è®°å½•å¹³å‡TTLæ—¶é•¿ */</span><br>Â  Â  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> expires_cursor; <span class="hljs-comment">/* expireæ£€æŸ¥æ—¶åœ¨dictä¸­æŠ½æ ·çš„ç´¢å¼•ä½ç½®. */</span><br>Â  Â  <span class="hljs-built_in">list</span> *defrag_later; Â  Â  Â  Â  <span class="hljs-comment">/* ç­‰å¾…ç¢ç‰‡æ•´ç†çš„keyåˆ—è¡¨. */</span><br>&#125; redisDb;<br></code></pre></td></tr></table></figure>

<p>Redisæ˜¯å¦‚ä½•çŸ¥é“ä¸€ä¸ªkeyæ˜¯å¦è¿‡æœŸå‘¢ï¼Ÿ</p>
<ul>
<li>åˆ©ç”¨ä¸¤ä¸ªDictåˆ†åˆ«è®°å½•key-valueå¯¹åŠkey-ttlå¯¹</li>
</ul>
<h4 id="æ˜¯ä¸æ˜¯TTLåˆ°æœŸå°±ç«‹å³åˆ é™¤äº†å‘¢ï¼Ÿ"><a href="#æ˜¯ä¸æ˜¯TTLåˆ°æœŸå°±ç«‹å³åˆ é™¤äº†å‘¢ï¼Ÿ" class="headerlink" title="æ˜¯ä¸æ˜¯TTLåˆ°æœŸå°±ç«‹å³åˆ é™¤äº†å‘¢ï¼Ÿ"></a>æ˜¯ä¸æ˜¯TTLåˆ°æœŸå°±ç«‹å³åˆ é™¤äº†å‘¢ï¼Ÿ</h4><p><strong>æƒ°æ€§åˆ é™¤</strong><br>æƒ°æ€§åˆ é™¤ï¼šé¡¾æ˜æ€è®®å¹¶ä¸æ˜¯åœ¨TTLåˆ°æœŸåå°±ç«‹åˆ»åˆ é™¤ï¼Œè€Œæ˜¯åœ¨è®¿é—®ä¸€ä¸ªkeyçš„æ—¶å€™ï¼Œæ£€æŸ¥è¯¥keyçš„å­˜æ´»æ—¶é—´ï¼Œå¦‚æœå·²ç»è¿‡æœŸæ‰æ‰§è¡Œåˆ é™¤ã€‚</p>
<p><strong>å‘¨æœŸåˆ é™¤</strong><br>å‘¨æœŸåˆ é™¤ï¼šé¡¾æ˜æ€è®®æ˜¯é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå‘¨æœŸæ€§çš„<strong>æŠ½æ ·éƒ¨åˆ†è¿‡æœŸçš„key</strong>ï¼Œç„¶åæ‰§è¡Œåˆ é™¤ã€‚æ‰§è¡Œå‘¨æœŸæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>RedisæœåŠ¡åˆå§‹åŒ–å‡½æ•°initServer()ä¸­è®¾ç½®å®šæ—¶ä»»åŠ¡ï¼ŒæŒ‰ç…§server.hzçš„é¢‘ç‡æ¥æ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸ºSLOW</li>
<li>Redisçš„æ¯ä¸ªäº‹ä»¶å¾ªç¯å‰ä¼šè°ƒç”¨beforeSleep()å‡½æ•°ï¼Œæ‰§è¡Œè¿‡æœŸkeyæ¸…ç†ï¼Œæ¨¡å¼ä¸ºFAST</li>
</ul>
<p>SLOWæ¨¡å¼è§„åˆ™ï¼š</p>
<ul>
<li>æ‰§è¡Œé¢‘ç‡å—server.hzå½±å“ï¼Œé»˜è®¤ä¸º10ï¼Œå³æ¯ç§’æ‰§è¡Œ10æ¬¡ï¼Œæ¯ä¸ªæ‰§è¡Œå‘¨æœŸ100msã€‚</li>
<li>æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡ä¸€æ¬¡æ‰§è¡Œå‘¨æœŸçš„25%.é»˜è®¤slowæ¨¡å¼è€—æ—¶ä¸è¶…è¿‡25ms</li>
<li>é€ä¸ªéå†dbï¼Œé€ä¸ªéå†dbä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ</li>
<li>å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ25msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸ</li>
</ul>
<p>FASTæ¨¡å¼è§„åˆ™ï¼ˆè¿‡æœŸkeyæ¯”ä¾‹å°äº10%ä¸æ‰§è¡Œ ï¼‰ï¼š</p>
<ul>
<li>æ‰§è¡Œé¢‘ç‡å—beforeSleep()è°ƒç”¨é¢‘ç‡å½±å“ï¼Œä½†ä¸¤æ¬¡FASTæ¨¡å¼é—´éš”ä¸ä½äº2ms</li>
<li>æ‰§è¡Œæ¸…ç†è€—æ—¶ä¸è¶…è¿‡1ms</li>
<li>é€ä¸ªéå†dbï¼Œé€ä¸ªéå†dbä¸­çš„bucketï¼ŒæŠ½å–20ä¸ªkeyåˆ¤æ–­æ˜¯å¦è¿‡æœŸ<br>å¦‚æœæ²¡è¾¾åˆ°æ—¶é—´ä¸Šé™ï¼ˆ1msï¼‰å¹¶ä¸”è¿‡æœŸkeyæ¯”ä¾‹å¤§äº10%ï¼Œå†è¿›è¡Œä¸€æ¬¡æŠ½æ ·ï¼Œå¦åˆ™ç»“æŸ</li>
</ul>
<h4 id="æ€»ç»“-3"><a href="#æ€»ç»“-3" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>RedisKeyçš„TTLè®°å½•æ–¹å¼ï¼š</p>
<ul>
<li>åœ¨RedisDBä¸­é€šè¿‡ä¸€ä¸ªDictè®°å½•æ¯ä¸ªKeyçš„TTLæ—¶é—´</li>
</ul>
<p>è¿‡æœŸkeyçš„åˆ é™¤ç­–ç•¥ï¼š</p>
<ul>
<li>æƒ°æ€§æ¸…ç†ï¼šæ¯æ¬¡æŸ¥æ‰¾keyæ—¶åˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤</li>
<li>å®šæœŸæ¸…ç†ï¼šå®šæœŸæŠ½æ ·éƒ¨åˆ†keyï¼Œåˆ¤æ–­æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤ã€‚</li>
</ul>
<p>å®šæœŸæ¸…ç†çš„ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>SLOWæ¨¡å¼æ‰§è¡Œé¢‘ç‡é»˜è®¤ä¸º10ï¼Œæ¯æ¬¡ä¸è¶…è¿‡25ms</li>
<li>FASTæ¨¡å¼æ‰§è¡Œé¢‘ç‡ä¸å›ºå®šï¼Œä½†ä¸¤æ¬¡é—´éš”ä¸ä½äº2msï¼Œæ¯æ¬¡è€—æ—¶ä¸è¶…è¿‡1ms</li>
</ul>
<h3 id="4-2-å†…å­˜æ·˜æ±°ç­–ç•¥"><a href="#4-2-å†…å­˜æ·˜æ±°ç­–ç•¥" class="headerlink" title="4.2 å†…å­˜æ·˜æ±°ç­–ç•¥"></a>4.2 å†…å­˜æ·˜æ±°ç­–ç•¥</h3><p>å†…å­˜æ·˜æ±°ï¼šå°±æ˜¯å½“Rediså†…å­˜ä½¿ç”¨è¾¾åˆ°è®¾ç½®çš„ä¸Šé™æ—¶ï¼Œä¸»åŠ¨æŒ‘é€‰éƒ¨åˆ†keyåˆ é™¤ä»¥é‡Šæ”¾æ›´å¤šå†…å­˜çš„æµç¨‹ã€‚<br>Redisä¼šåœ¨å¤„ç†å®¢æˆ·ç«¯å‘½ä»¤çš„æ–¹æ³•processCommand()ä¸­å°è¯•åšå†…å­˜æ·˜æ±°</p>
<p>Redisæ”¯æŒ8ç§ä¸åŒç­–ç•¥æ¥é€‰æ‹©è¦åˆ é™¤çš„keyï¼š</p>
<ul>
<li>noevictionï¼š ä¸æ·˜æ±°ä»»ä½•keyï¼Œä½†æ˜¯å†…å­˜æ»¡æ—¶ä¸å…è®¸å†™å…¥æ–°æ•°æ®ï¼Œé»˜è®¤å°±æ˜¯è¿™ç§ç­–ç•¥ã€‚</li>
<li>volatile-ttlï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼Œæ¯”è¾ƒkeyçš„å‰©ä½™TTLå€¼ï¼ŒTTLè¶Šå°è¶Šå…ˆè¢«æ·˜æ±°</li>
<li>allkeys-randomï¼šå¯¹å…¨ä½“key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚ä¹Ÿå°±æ˜¯ç›´æ¥ä»db-&gt;dictä¸­éšæœºæŒ‘é€‰</li>
<li>volatile-randomï¼šå¯¹è®¾ç½®äº†TTLçš„key ï¼Œéšæœºè¿›è¡Œæ·˜æ±°ã€‚ä¹Ÿå°±æ˜¯ä»db-&gt;expiresä¸­éšæœºæŒ‘é€‰ã€‚</li>
<li>allkeys-lruï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°</li>
<li>volatile-lruï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLRUç®—æ³•è¿›è¡Œæ·˜æ±°</li>
<li>allkeys-lfuï¼š å¯¹å…¨ä½“keyï¼ŒåŸºäºLFUç®—æ³•è¿›è¡Œæ·˜æ±°</li>
<li>volatile-lfuï¼š å¯¹è®¾ç½®äº†TTLçš„keyï¼ŒåŸºäºLFIç®—æ³•è¿›è¡Œæ·˜æ±°</li>
</ul>
<p>æ¯”è¾ƒå®¹æ˜“æ··æ·†çš„æœ‰ä¸¤ä¸ªï¼š</p>
<ul>
<li>LRUï¼ˆLeast Recently Usedï¼‰ï¼Œæœ€å°‘æœ€è¿‘ä½¿ç”¨ã€‚ç”¨å½“å‰æ—¶é—´å‡å»æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œè¿™ä¸ªå€¼è¶Šå¤§åˆ™æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
<li>LFUï¼ˆLeast Frequently Usedï¼‰ï¼Œæœ€å°‘é¢‘ç‡ä½¿ç”¨ã€‚ä¼šç»Ÿè®¡æ¯ä¸ªkeyçš„è®¿é—®é¢‘ç‡ï¼Œå€¼è¶Šå°æ·˜æ±°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
</ul>
<p>Redisçš„æ•°æ®éƒ½ä¼šè¢«å°è£…ä¸ºRedisObjectç»“æ„ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisObject</span> &#123;</span><br>Â  Â  <span class="hljs-type">unsigned</span> type:<span class="hljs-number">4</span>; Â  Â  Â  Â <span class="hljs-comment">// å¯¹è±¡ç±»å‹</span><br>Â  Â  <span class="hljs-type">unsigned</span> encoding:<span class="hljs-number">4</span>; Â  Â <span class="hljs-comment">// ç¼–ç æ–¹å¼</span><br>Â  Â  <span class="hljs-type">unsigned</span> lru:LRU_BITS; Â <span class="hljs-comment">// LRUï¼šä»¥ç§’ä¸ºå•ä½è®°å½•æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œé•¿åº¦24bit</span><br>              <span class="hljs-comment">// LFUï¼šé«˜16ä½ä»¥åˆ†é’Ÿä¸ºå•ä½è®°å½•æœ€è¿‘ä¸€æ¬¡è®¿é—®æ—¶é—´ï¼Œä½8ä½è®°å½•é€»è¾‘è®¿é—®æ¬¡æ•°</span><br>Â  Â  <span class="hljs-type">int</span> refcount; Â  Â  Â  Â  Â  <span class="hljs-comment">// å¼•ç”¨è®¡æ•°ï¼Œè®¡æ•°ä¸º0åˆ™å¯ä»¥å›æ”¶</span><br>Â  Â  <span class="hljs-type">void</span> *ptr; Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">// æ•°æ®æŒ‡é’ˆï¼ŒæŒ‡å‘çœŸå®æ•°æ®</span><br>&#125; robj;<br></code></pre></td></tr></table></figure>

<p>LFUçš„è®¿é—®æ¬¡æ•°ä¹‹æ‰€ä»¥å«åš<strong>é€»è¾‘è®¿é—®æ¬¡æ•°</strong>ï¼Œæ˜¯å› ä¸ºå¹¶ä¸æ˜¯æ¯æ¬¡keyè¢«è®¿é—®éƒ½è®¡æ•°ï¼Œè€Œæ˜¯é€šè¿‡è¿ç®—ï¼š</p>
<ul>
<li>ç”Ÿæˆ0~1ä¹‹é—´çš„éšæœºæ•°R</li>
<li>è®¡ç®— (æ—§æ¬¡æ•° * lfu_log_factor + 1)ï¼Œè®°å½•ä¸ºP</li>
<li>å¦‚æœ R &lt; P ï¼Œåˆ™è®¡æ•°å™¨ + 1ï¼Œä¸”æœ€å¤§ä¸è¶…è¿‡255</li>
<li>è®¿é—®æ¬¡æ•°ä¼šéšæ—¶é—´è¡°å‡ï¼Œè·ç¦»ä¸Šä¸€æ¬¡è®¿é—®æ—¶é—´æ¯éš” lfu_decay_time åˆ†é’Ÿï¼Œè®¡æ•°å™¨ -1</li>
</ul>
<p><img src="/img/blogs/java/redis/4.4.1.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<hr>
<hr>
<h1 id="äº”-é»‘é©¬ç‚¹è¯„ç®€å†"><a href="#äº”-é»‘é©¬ç‚¹è¯„ç®€å†" class="headerlink" title="äº”. é»‘é©¬ç‚¹è¯„ç®€å†"></a>äº”. é»‘é©¬ç‚¹è¯„ç®€å†</h1><p><strong>é¡¹ç›®äº®ç‚¹ï¼š</strong></p>
<ol>
<li>é‡‡ç”¨ Redis å¯¹é«˜é¢‘è®¿é—®çš„å•†æˆ·ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢çš„å‹åŠ›ï¼Œè§£å†³äº†ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿é—®é¢˜</li>
<li>é€šè¿‡ ThreadLocal ä¿å­˜å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œåç§»é™¤ï¼Œé¿å…å†…å­˜æ³„éœ²ä¸èµ„æºæµªè´¹</li>
<li>åˆ©ç”¨ Redisson åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œç»“åˆä¹è§‚é”æœºåˆ¶é˜²æ­¢ç§’æ€è¶…å–é—®é¢˜</li>
<li>åŸºäº Redis å®ç°åˆ†å¸ƒå¼ Session å…±äº«ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°</li>
<li>å®ç°åŸºäºæ¨æ¨¡å¼çš„ Feed æµåŠŸèƒ½ï¼Œé‡‡ç”¨æ»šåŠ¨åˆ†é¡µï¼Œç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>å€ŸåŠ© Redis çš„ ZSet å®ç°ç‚¹èµæ’è¡Œæ¦œï¼Œåˆ©ç”¨ Set æ•°æ®ç»“æ„æ”¯æŒç”¨æˆ·å…³æ³¨ä¸å…±åŒå…³æ³¨åŠŸèƒ½</li>
</ol>
<h2 id="é¡¹ç›®äº®ç‚¹è¯¦è§£"><a href="#é¡¹ç›®äº®ç‚¹è¯¦è§£" class="headerlink" title="é¡¹ç›®äº®ç‚¹è¯¦è§£"></a>é¡¹ç›®äº®ç‚¹è¯¦è§£</h2><h3 id="1-é‡‡ç”¨-Redis-å¯¹é«˜é¢‘è®¿é—®çš„å•†æˆ·ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢çš„å‹åŠ›ï¼Œè§£å†³äº†ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿é—®é¢˜"><a href="#1-é‡‡ç”¨-Redis-å¯¹é«˜é¢‘è®¿é—®çš„å•†æˆ·ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢çš„å‹åŠ›ï¼Œè§£å†³äº†ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿é—®é¢˜" class="headerlink" title="1. é‡‡ç”¨ Redis å¯¹é«˜é¢‘è®¿é—®çš„å•†æˆ·ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢çš„å‹åŠ›ï¼Œè§£å†³äº†ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿é—®é¢˜"></a>1. é‡‡ç”¨ Redis å¯¹é«˜é¢‘è®¿é—®çš„å•†æˆ·ä¿¡æ¯è¿›è¡Œç¼“å­˜ï¼Œé™ä½äº†æ•°æ®åº“æŸ¥è¯¢çš„å‹åŠ›ï¼Œè§£å†³äº†ç¼“å­˜ç©¿é€ã€é›ªå´©ã€å‡»ç©¿é—®é¢˜</h3><p><a href="#2-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98">è·³è½¬åˆ°å•†æˆ·æŸ¥è¯¢ç¼“å­˜è¿™ä¸€èŠ‚</a></p>
<h4 id="1-1-ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ«ï¼Ÿ"><a href="#1-1-ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="1.1 ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ«ï¼Ÿ"></a>1.1 ç¼“å­˜å’Œå†…å­˜çš„åŒºåˆ«ï¼Ÿ</h4><table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th>ç¼“å­˜ï¼ˆCacheï¼‰</th>
<th>å†…å­˜ï¼ˆMemoryï¼Œä¹Ÿå«ä¸»å­˜ï¼ŒRAMï¼‰</th>
</tr>
</thead>
<tbody><tr>
<td>å®šä¹‰</td>
<td><strong>CPUä¸å†…å­˜ä¹‹é—´</strong>çš„é«˜é€Ÿç¼“å­˜ï¼Œç”¨äº<strong>å­˜æ”¾è¿‘æœŸä½¿ç”¨çš„çƒ­ç‚¹æ•°æ®</strong></td>
<td>è®¡ç®—æœºçš„ä¸»å†…å­˜ï¼Œç”¨äº<strong>å­˜å‚¨å½“å‰è¿è¡Œä¸­çš„ç¨‹åºå’Œæ•°æ®</strong></td>
</tr>
<tr>
<td>ä½œç”¨</td>
<td>æé«˜CPUè®¿é—®æ•°æ®çš„é€Ÿåº¦ï¼Œå‡å°‘å¯¹å†…å­˜çš„è®¿é—®é¢‘ç‡</td>
<td>æä¾›è¿è¡Œç¨‹åºæ—¶æ‰€éœ€çš„æ•°æ®ç©ºé—´</td>
</tr>
</tbody></table>
<ul>
<li>Redis æ˜¯ä¸€ç§å¸¸ç”¨çš„ç¼“å­˜æŠ€æœ¯ï¼šç”¨æ¥ç¼“å­˜çƒ­ç‚¹æ•°æ®ã€é¡µé¢ã€Session ç­‰ï¼Œå‡è½»æ•°æ®åº“å‹åŠ›(<strong>åŸºäºå†…å­˜ï¼Œè®¿é—®é€Ÿåº¦éå¸¸å¿«</strong>)</li>
</ul>
<h4 id="1-2-ä½¿ç”¨Redisæ·»åŠ å•†æˆ·ç¼“å­˜çš„æµç¨‹"><a href="#1-2-ä½¿ç”¨Redisæ·»åŠ å•†æˆ·ç¼“å­˜çš„æµç¨‹" class="headerlink" title="1.2 ä½¿ç”¨Redisæ·»åŠ å•†æˆ·ç¼“å­˜çš„æµç¨‹"></a>1.2 ä½¿ç”¨Redisæ·»åŠ å•†æˆ·ç¼“å­˜çš„æµç¨‹</h4><ul>
<li>æŸ¥è¯¢æ•°æ®åº“ä¹‹å‰å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œå¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ï¼Œåˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦‚æœç¼“å­˜æ•°æ®ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶åå°†æ•°æ®å­˜å…¥redis</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.ä»redisæŸ¥è¯¢å•†é“ºç¼“å­˜</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-comment">// 3.å­˜åœ¨,ç›´æ¥è¿”å›</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>    <span class="hljs-comment">// 4.ä¸å­˜åœ¨,æ ¹æ®idæŸ¥è¯¢æ•°æ®åº“</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 5.ä¸å­˜åœ¨,è¿”å›é”™è¯¯</span><br>    <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;åº—é“ºä¸å­˜åœ¨!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.å­˜åœ¨,å†™å…¥redis</span><br>    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));<br>    <span class="hljs-comment">// 7.è¿”å›</span><br>    <span class="hljs-keyword">return</span> Result.ok(shop);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-å¦‚ä½•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜çš„ä¸€è‡´æ€§ï¼Ÿ"><a href="#1-3-å¦‚ä½•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜çš„ä¸€è‡´æ€§ï¼Ÿ" class="headerlink" title="1.3 å¦‚ä½•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜çš„ä¸€è‡´æ€§ï¼Ÿ"></a>1.3 å¦‚ä½•ä¿è¯æ•°æ®åº“å’Œç¼“å­˜çš„ä¸€è‡´æ€§ï¼Ÿ</h4><p><a href="#23-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">è·³è½¬åˆ°ç¼“å­˜æ›´æ–°ç­–ç•¥è¿™ä¸€èŠ‚</a></p>
<p>å¦‚æœæ›´æ–°äº†æ•°æ®åº“ï¼Œå¯¼è‡´æ•°æ®åº“ä¸­çš„æ•°æ®å†…å®¹å’Œå½“å‰ç¼“å­˜ä¸­ä¿ç•™çš„ä»¥å‰çš„å†…å®¹ä¸ä¸€è‡´ã€‚å¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ</p>
<ul>
<li>æ•°æ®åº“æ˜¯æ–°çš„ï¼Œç¼“å­˜æ˜¯æ—§çš„ â€”â€” æ•°æ®è„è¯»</li>
</ul>
<ol>
<li>å…ˆæ›´æ–°æ•°æ®åº“</li>
<li>å†åˆ é™¤ç¼“å­˜</li>
<li>ä¸‹æ¬¡è¯·æ±‚è¯»ç¼“å­˜ -&gt; å‘ç°æ²¡äº† -&gt; è¯»æ•°æ®åº“ -&gt; å†å†™å…¥ç¼“å­˜</li>
</ol>
<p>å¦‚ä½•ä¿è¯ç¼“å­˜ä¸æ•°æ®åº“çš„æ“ä½œçš„åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ï¼Ÿ</p>
<ul>
<li>å•ä½“ç³»ç»Ÿï¼Œå°†ç¼“å­˜ä¸æ•°æ®åº“æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡</li>
<li>åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œåˆ©ç”¨TCCç­‰åˆ†å¸ƒå¼äº‹åŠ¡æ–¹æ¡ˆ</li>
</ul>
<h4 id="1-4-å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ï¼Ÿ"><a href="#1-4-å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ï¼Ÿ" class="headerlink" title="1.4 å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ï¼Ÿ"></a>1.4 å¦‚ä½•è§£å†³ç¼“å­˜ç©¿é€ï¼Ÿ</h4><p><a href="#25-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">è·³è½¬åˆ°ç¼“å­˜ç©¿é€è¿™ä¸€èŠ‚</a></p>
<ul>
<li>ç¼“å­˜ç©¿é€æ˜¯æŒ‡å®¢æˆ·ç«¯<strong>è¯·æ±‚çš„æ•°æ®åœ¨ç¼“å­˜ä¸­å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨</strong>ï¼Œè¿™æ ·ç¼“å­˜æ°¸è¿œä¸ä¼šç”Ÿæ•ˆï¼Œè¿™äº›è¯·æ±‚éƒ½ä¼šæ‰“åˆ°æ•°æ®åº“</li>
</ul>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>ç¼“å­˜ç©ºå¯¹è±¡</li>
<li>å¸ƒéš†è¿‡æ»¤å™¨</li>
</ul>
<p><strong>å¦‚ä½•ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è§£å†³ç¼“å­˜ç©¿é€é—®é¢˜ï¼Ÿ</strong><br>ç”¨å¸ƒéš†è¿‡æ»¤å™¨æå‰è®°å½• æ‰€æœ‰åˆæ³•çš„ keyï¼ˆæ¯”å¦‚ç”¨æˆ· IDã€å•†å“ IDï¼‰</p>
<ul>
<li>è¯·æ±‚è¿›æ¥å…ˆæŸ¥å¸ƒéš†è¿‡æ»¤å™¨</li>
<li>å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨é‡Œéƒ½æ²¡æœ‰ï¼Œé‚£å°±<strong>ç›´æ¥æ‹¦æˆª</strong>ï¼Œä¸ç”¨æŸ¥ Redisã€æ•°æ®åº“äº†ã€‚</li>
</ul>
<p>å¸ƒéš†è¿‡æ»¤å™¨é€šè¿‡è®°å½•æ‰€æœ‰â€œåˆæ³• keyâ€ï¼Œ<strong>åœ¨è®¿é—®ç¼“å­˜å‰å¿«é€Ÿæ‹¦æˆªæ‰éæ³•è¯·æ±‚</strong>ï¼Œä»è€Œè§£å†³ç¼“å­˜ç©¿é€é—®é¢˜</p>
<p><strong>å¸ƒéš†è¿‡æ»¤ï¼š<strong>å¸ƒéš†è¿‡æ»¤å™¨å…¶å®é‡‡ç”¨çš„æ˜¯</strong>å“ˆå¸Œæ€æƒ³</strong>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡ä¸€ä¸ªåºå¤§çš„äºŒè¿›åˆ¶æ•°ç»„ï¼Œèµ°å“ˆå¸Œæ€æƒ³å»åˆ¤æ–­å½“å‰è¿™ä¸ªè¦æŸ¥è¯¢çš„è¿™ä¸ªæ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­å­˜åœ¨ï¼Œåˆ™æ”¾è¡Œï¼Œè¿™ä¸ªè¯·æ±‚ä¼šå»è®¿é—®redisï¼Œå“ªæ€•æ­¤æ—¶redisä¸­çš„æ•°æ®è¿‡æœŸäº†ï¼Œä½†æ˜¯æ•°æ®åº“ä¸­ä¸€å®šå­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œåœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥è¿™ä¸ªæ•°æ®åï¼Œå†å°†å…¶æ”¾å…¥åˆ°redisä¸­ï¼Œ</p>
<p>å‡è®¾å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­è¿™ä¸ªæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</p>
<p>è¿™ç§æ–¹å¼ä¼˜ç‚¹åœ¨äºèŠ‚çº¦å†…å­˜ç©ºé—´ï¼Œå­˜åœ¨è¯¯åˆ¤ï¼Œè¯¯åˆ¤åŸå› åœ¨äºï¼š<strong>å¸ƒéš†è¿‡æ»¤å™¨èµ°çš„æ˜¯å“ˆå¸Œæ€æƒ³ï¼Œåªè¦å“ˆå¸Œæ€æƒ³ï¼Œå°±å¯èƒ½å­˜åœ¨å“ˆå¸Œå†²çª</strong></p>
<ul>
<li>æœ‰ä¸€å®šè¯¯åˆ¤ç‡ï¼šå¯èƒ½ä¼šè¯¯åˆ¤ä¸ºå­˜åœ¨ï¼Œä½†ä¸ä¼šè¯¯åˆ¤ä¸ºä¸å­˜åœ¨</li>
</ul>
<h4 id="1-5-å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©ï¼Ÿ"><a href="#1-5-å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©ï¼Ÿ" class="headerlink" title="1.5 å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©ï¼Ÿ"></a>1.5 å¦‚ä½•è§£å†³ç¼“å­˜é›ªå´©ï¼Ÿ</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_52031708/article/details/142862864?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171eed587531abcfcf154d766791ee79%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=171eed587531abcfcf154d766791ee79&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-5-142862864-null-null.142%5Ev102%5Epc_search_result_base2&utm_term=caffeine%20redis%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98&spm=1018.2226.3001.4187">ä½¿ç”¨Caffeine+Rediså®ç°åº”ç”¨çº§äºŒå±‚ç¼“å­˜</a></p>
<p>ç¼“å­˜é›ªå´©æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…<strong>RedisæœåŠ¡å®•æœº</strong>ï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚åˆ°è¾¾æ•°æ®åº“ï¼Œå¸¦æ¥å·¨å¤§å‹åŠ›ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>ç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼ï¼ˆåŒä¸€æ—¶æ®µï¼Œç»™ä¸åŒkeyè®¾ç½®ä¸åŒçš„TTLï¼‰</li>
<li>åˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§</li>
<li>ç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥ï¼ˆå¾®æœåŠ¡ï¼‰</li>
<li>ç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜</li>
</ul>
<p>è¿™é‡Œæˆ‘é‡‡ç”¨<strong>å¤šçº§ç¼“å­˜</strong>çš„æ–¹å¼è§£å†³ç¼“å­˜é›ªå´©é—®é¢˜<br>å¤šçº§ç¼“å­˜ &#x3D; æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰ + åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰</p>
<p>ä½¿ç”¨æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆä»ä¸€çº§ç¼“å­˜ï¼ˆcaffeine-æœ¬åœ°åº”ç”¨å†…ï¼‰ä¸­æŸ¥æ‰¾æ•°æ®ï¼›</li>
<li>å¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ™ä»äºŒçº§ç¼“å­˜ï¼ˆredis-å†…å­˜ï¼‰ä¸­æŸ¥æ‰¾æ•°æ®ï¼›</li>
<li>å¦‚æœè¿˜æ˜¯æ²¡æœ‰çš„è¯ï¼Œå†ä»æ•°æ®åº“ï¼ˆæ•°æ®åº“-ç£ç›˜ï¼‰ä¸­æŸ¥æ‰¾æ•°æ®ï¼›</li>
</ol>
<h4 id="1-6-å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿ï¼Ÿ"><a href="#1-6-å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿ï¼Ÿ" class="headerlink" title="1.6 å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿ï¼Ÿ"></a>1.6 å¦‚ä½•è§£å†³ç¼“å­˜å‡»ç©¿ï¼Ÿ</h4><p>æŸä¸ªçƒ­ç‚¹ key åœ¨ç¬é—´å¤±æ•ˆï¼Œå¤§é‡å¹¶å‘è¯·æ±‚åŒæ—¶è®¿é—®è¿™ä¸ª keyï¼Œç¼“å­˜æ²¡å‘½ä¸­ï¼Œå¯¼è‡´å¹¶å‘æ‰“åˆ°æ•°æ®åº“ã€‚</p>
<p><a href="#27-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF">è·³è½¬åˆ°ç¼“å­˜å‡»ç©¿è¿™ä¸€èŠ‚</a></p>
<p><strong>è¿™é‡Œæˆ‘ç”¨çš„æ˜¯äº’æ–¥é”çš„æ–¹å¼è§£å†³ç¼“å­˜å‡»ç©¿</strong></p>
<p>å¸¸è§çš„è§£å†³æ–¹æ¡ˆæœ‰ï¼š</p>
<ul>
<li><strong>äº’æ–¥é”</strong>: å½“ç¼“å­˜å¤±æ•ˆæ—¶ï¼Œç¬¬ä¸€ä¸ªçº¿ç¨‹è·å–é”å¹¶æŸ¥è¯¢æ•°æ®åº“ï¼Œå…¶å®ƒçº¿ç¨‹ç­‰å¾…ã€‚</li>
<li>è®¾ç½®æ°¸ä¸è¿‡æœŸ + åå°å®šæ—¶å¼‚æ­¥æ›´æ–°ç¼“å­˜(å½“çƒ­ç‚¹keyçš„æ•°é‡å°‘ï¼Œå ç”¨å†…å­˜å°‘çš„æ—¶å€™)</li>
<li>é€»è¾‘è¿‡æœŸ</li>
</ul>
<p><strong>è®¾ç½®æ°¸ä¸è¿‡æœŸ + åå°å®šæ—¶å¼‚æ­¥æ›´æ–°ç¼“å­˜</strong></p>
<ul>
<li>ä½ ä¸è®©ç¼“å­˜è‡ªç„¶è¿‡æœŸï¼Œè€Œæ˜¯ç”¨ ä¸»åŠ¨åˆ·æ–° æ¥ç»´æŒæ•°æ®ä¸€è‡´æ€§</li>
<li>ä¸ä¼šå¤±æ•ˆï¼Œè‡ªç„¶ä¹Ÿä¸ä¼šå‡»ç©¿</li>
</ul>
<p><strong>é€»è¾‘è¿‡æœŸ</strong></p>
<ul>
<li>æˆ‘ä»¬æŠŠè¿‡æœŸæ—¶é—´è®¾ç½®åœ¨ redisçš„valueä¸­ï¼Œæ³¨æ„ï¼šè¿™ä¸ªè¿‡æœŸæ—¶é—´å¹¶ä¸ä¼šç›´æ¥ä½œç”¨äºredisï¼Œè€Œæ˜¯æˆ‘ä»¬åç»­é€šè¿‡é€»è¾‘å»å¤„ç†</li>
<li>å‡è®¾çº¿ç¨‹1å»æŸ¥è¯¢ç¼“å­˜ï¼Œç„¶åä»valueä¸­åˆ¤æ–­å‡ºæ¥å½“å‰çš„æ•°æ®å·²ç»è¿‡æœŸäº†ï¼Œæ­¤æ—¶çº¿ç¨‹1å»è·å¾—äº’æ–¥é”ï¼Œé‚£ä¹ˆå…¶ä»–çº¿ç¨‹ä¼šè¿›è¡Œé˜»å¡</li>
<li>è·å¾—äº†é”çš„çº¿ç¨‹ä»–ä¼šå¼€å¯ä¸€ä¸ª çº¿ç¨‹å»è¿›è¡Œ ä»¥å‰çš„é‡æ„æ•°æ®çš„é€»è¾‘ï¼Œç›´åˆ°æ–°å¼€çš„çº¿ç¨‹å®Œæˆè¿™ä¸ªé€»è¾‘åï¼Œæ‰é‡Šæ”¾é”ï¼Œ è€Œçº¿ç¨‹1ç›´æ¥è¿›è¡Œè¿”å›</li>
<li>å‡è®¾ç°åœ¨çº¿ç¨‹3è¿‡æ¥è®¿é—®ï¼Œç”±äºçº¿ç¨‹çº¿ç¨‹2æŒæœ‰ç€é”ï¼Œæ‰€ä»¥çº¿ç¨‹3æ— æ³•è·å¾—é”ï¼Œçº¿ç¨‹3ä¹Ÿç›´æ¥è¿”å›æ•°æ®</li>
<li>åªæœ‰ç­‰åˆ°æ–°å¼€çš„çº¿ç¨‹2æŠŠé‡å»ºæ•°æ®æ„å»ºå®Œåï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½èµ°è¿”å›æ­£ç¡®çš„æ•°æ®ã€‚</li>
</ul>
<h3 id="2-é€šè¿‡-ThreadLocal-ä¿å­˜å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œåç§»é™¤ï¼Œé¿å…å†…å­˜æ³„éœ²ä¸èµ„æºæµªè´¹"><a href="#2-é€šè¿‡-ThreadLocal-ä¿å­˜å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œåç§»é™¤ï¼Œé¿å…å†…å­˜æ³„éœ²ä¸èµ„æºæµªè´¹" class="headerlink" title="2. é€šè¿‡ ThreadLocal ä¿å­˜å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œåç§»é™¤ï¼Œé¿å…å†…å­˜æ³„éœ²ä¸èµ„æºæµªè´¹"></a>2. é€šè¿‡ ThreadLocal ä¿å­˜å·²ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·æ±‚å¤„ç†å®Œåç§»é™¤ï¼Œé¿å…å†…å­˜æ³„éœ²ä¸èµ„æºæµªè´¹</h3><h4 id="2-1-ä¸ºä»€ä¹ˆä¸ä½¿ç”¨sessionå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼Ÿ"><a href="#2-1-ä¸ºä»€ä¹ˆä¸ä½¿ç”¨sessionå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼Ÿ" class="headerlink" title="2.1 ä¸ºä»€ä¹ˆä¸ä½¿ç”¨sessionå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼Ÿ"></a>2.1 ä¸ºä»€ä¹ˆä¸ä½¿ç”¨sessionå­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œæ˜¯ä½¿ç”¨ThreadLocalå­˜æ”¾ç”¨æˆ·ä¿¡æ¯ï¼Ÿ</h4><ol>
<li>Session ä¾èµ–æœåŠ¡ç«¯çŠ¶æ€ï¼Œä¸é€‚åˆåˆ†å¸ƒå¼åœºæ™¯(Sessionå…±äº«é—®é¢˜)<ul>
<li>HttpSession æ˜¯æœåŠ¡ç«¯çŠ¶æ€ï¼Œä¼šè¯ä¿¡æ¯é»˜è®¤ä¿å­˜åœ¨æœåŠ¡ç«¯å†…å­˜ä¸­ï¼ˆå¦‚ Tomcat å†…éƒ¨ï¼‰ã€‚</li>
<li>åœ¨<strong>åˆ†å¸ƒå¼éƒ¨ç½²</strong>æ—¶ï¼Œå¦‚æœæ²¡æœ‰åš Session å…±äº«ï¼ˆå¦‚ä½¿ç”¨ Redis Sessionï¼‰ï¼Œ<strong>ç”¨æˆ·å¯èƒ½æ¯æ¬¡è¯·æ±‚ä¼šæ‰“åˆ°ä¸åŒçš„æœåŠ¡èŠ‚ç‚¹ï¼Œå¯¼è‡´ Session ä¸¢å¤±</strong>ã€‚</li>
</ul>
</li>
<li>å¦‚æœé‡åˆ°<strong>é«˜å¹¶å‘</strong>ï¼Œå¤šäººåŒæ—¶ç™»å½•ç³»ç»Ÿæ—¶ï¼Œä¼šå‡ºç°sessionæ··ä¹±</li>
<li>ThreadLocal ä¸ºæ¯ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªç‹¬ç«‹å‰¯æœ¬ï¼Œå¤©ç„¶çº¿ç¨‹éš”ç¦»ï¼Œé¿å…å¹¶å‘è®¿é—®å¸¦æ¥çš„æ•°æ®å®‰å…¨é—®é¢˜</li>
<li>æˆ‘ä»¬å¯ä»¥å€ŸåŠ©è¿™ä¸ªThreadLocalæ¥å­˜å‚¨ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼Œ<strong>åœ¨ä¸€ä¸ªè¯·æ±‚ä¸­ï¼Œæ‰€æœ‰è°ƒç”¨çš„æ–¹æ³•éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­å»å¤„ç†</strong>ï¼Œè¿™æ ·å°±å®ç°äº†<strong>åœ¨ä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è·å–åˆ°ç”¨æˆ·ä¿¡æ¯</strong>äº†ã€‚</li>
<li><strong>æ”¾åˆ° ThreadLocal å°±å¯ä»¥ä¸ç”¨æ¯æ¬¡éƒ½æŸ¥ Redis</strong>ã€‚å¦‚æœä½ æŠŠè¿™ä¸ª UserDTO å­˜åˆ° ThreadLocal ä¸­ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸€è¯·æ±‚ç”Ÿå‘½å‘¨æœŸå†…ï¼Œåç»­ä»»ä½•åœ°æ–¹å°±<strong>å¯ä»¥ç›´æ¥ä» ThreadLocal å–å‡ºç”¨æˆ·ä¿¡æ¯</strong>ï¼Œè€Œä¸ç”¨é‡å¤ä» Redis æŸ¥è¯¢æˆ–å¤šå±‚ä¼ å‚ã€‚</li>
</ol>
<h4 id="2-2-å®Œæ•´çš„ç”¨æˆ·ç™»å½•-æ‹¦æˆªå™¨é‰´æƒ-ThreadLocal-ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†"><a href="#2-2-å®Œæ•´çš„ç”¨æˆ·ç™»å½•-æ‹¦æˆªå™¨é‰´æƒ-ThreadLocal-ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†" class="headerlink" title="2.2 å®Œæ•´çš„ç”¨æˆ·ç™»å½• + æ‹¦æˆªå™¨é‰´æƒ + ThreadLocal ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†"></a>2.2 å®Œæ•´çš„ç”¨æˆ·ç™»å½• + æ‹¦æˆªå™¨é‰´æƒ + ThreadLocal ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">â”œâ”€â”€ config<br>â”‚   â””â”€â”€ LoginInterceptor.java      <span class="hljs-comment">// ç™»å½•æ‹¦æˆªå™¨</span><br>â”œâ”€â”€ dto<br>â”‚   â””â”€â”€ UserDTO.java               <span class="hljs-comment">// ç™»å½•ç”¨æˆ·ä¿¡æ¯ç®€åŒ–å°è£…</span><br>â”œâ”€â”€ utils<br>â”‚   â””â”€â”€ UserHolder.java           <span class="hljs-comment">// ThreadLocal ç”¨æˆ·ä¸Šä¸‹æ–‡ç®¡ç†</span><br>â”œâ”€â”€ controller<br>â”‚   â””â”€â”€ UserController.java        <span class="hljs-comment">// ç™»å½•ç›¸å…³æ¥å£</span><br>â”œâ”€â”€ service<br>â”‚   â””â”€â”€ UserService.java           <span class="hljs-comment">// ç™»å½•é€»è¾‘ï¼ˆå«Redis tokenæ ¡éªŒï¼‰</span><br>â””â”€â”€ ...<br></code></pre></td></tr></table></figure>


<ol>
<li>å®šä¹‰ç”¨æˆ·å®ä½“ï¼š<code>UserDTO</code>(ç”¨äºå­˜å‚¨ç™»å½•ç”¨æˆ·çš„ç®€åŒ–ä¿¡æ¯)</li>
<li>å®šä¹‰å·¥å…·ç±»<code>UserHolder</code>æ“ä½œThreadLocalï¼ˆå­˜æ”¾ï¼Œè·å–ï¼Œåˆ é™¤ç”¨æˆ·ä¿¡æ¯ï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHolder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-comment">//ä¿å­˜ç”¨æˆ·ä¿¡æ¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(UserDTO user)</span>&#123;<br>        tl.set(user);<br>    &#125;<br><br>    <span class="hljs-comment">//è·å–ç”¨æˆ·ä¿¡æ¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserDTO <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> tl.get();<br>    &#125;<br><br>    <span class="hljs-comment">//åˆ é™¤ç”¨æˆ·ä¿¡æ¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUser</span><span class="hljs-params">()</span>&#123;<br>        tl.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ç™»å½•æ‹¦æˆªå™¨ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰<ul>
<li>è®¿é—®æ¥å£æ—¶å°†ç”¨æˆ·ä¿¡æ¯æ”¾å…¥ThreadLocal</li>
<li>è®¿é—®ç»“æŸæ—¶å€™åˆ é™¤ThreadLocalä¸­ä¿¡æ¯ï¼ˆçº¿ç¨‹æ”¾å…¥çº¿ç¨‹æ± å¹¶ä¸ä¸€å®šä¼šé”€æ¯ï¼‰</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.åˆ¤æ–­æ˜¯å¦éœ€è¦æ‹¦æˆªï¼ˆThreadLocalä¸­æ˜¯å¦æœ‰ç”¨æˆ·ï¼‰</span><br>        <span class="hljs-keyword">if</span> (UserHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// æ²¡æœ‰ï¼Œéœ€è¦æ‹¦æˆªï¼Œè®¾ç½®çŠ¶æ€ç </span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-comment">// æ‹¦æˆª</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// æœ‰ç”¨æˆ·ï¼Œåˆ™æ”¾è¡Œ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>é…ç½®æ‹¦æˆªå™¨ï¼Œè®©æ‹¦æˆªå™¨ç”Ÿæ•ˆ(æ‹¦æˆªéœ€è¦ç™»å½•çš„æ¥å£)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoginInterceptor loginInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// æ‹¦æˆªéœ€è¦ç™»å½•çš„æ¥å£</span><br>        registry.addInterceptor(loginInterceptor)<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">// å¯ç»†åŒ–è·¯å¾„</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/user/register&quot;</span>, <span class="hljs-string">&quot;/static/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-ä¸ºä»€ä¹ˆè¯·æ±‚å¤„ç†å®Œåè¦ç§»é™¤-ThreadLocal-çš„å€¼ï¼Ÿ"><a href="#2-3-ä¸ºä»€ä¹ˆè¯·æ±‚å¤„ç†å®Œåè¦ç§»é™¤-ThreadLocal-çš„å€¼ï¼Ÿ" class="headerlink" title="2.3 ä¸ºä»€ä¹ˆè¯·æ±‚å¤„ç†å®Œåè¦ç§»é™¤ ThreadLocal çš„å€¼ï¼Ÿ"></a>2.3 ä¸ºä»€ä¹ˆè¯·æ±‚å¤„ç†å®Œåè¦ç§»é™¤ ThreadLocal çš„å€¼ï¼Ÿ</h4><p>ç›®çš„ï¼š<strong>é¿å…å†…å­˜æ³„æ¼ä¸èµ„æºæµªè´¹</strong></p>
<p><strong>åŸå› </strong>ï¼š</p>
<ol>
<li>ThreadLocalMap çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œvalue æ˜¯å¼ºå¼•ç”¨<ul>
<li>å½“ ThreadLocal å®ä¾‹ï¼ˆkeyï¼‰è¢« GC å›æ”¶åï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨ remove()ï¼Œå®ƒå¯¹åº”çš„ <strong>value ä¼šâ€œæ‚¬æŒ‚â€åœ¨å†…å­˜ä¸­</strong>ï¼Œè€Œ ThreadLocalMap æ˜¯æŒ‚åœ¨ Thread å¯¹è±¡ä¸Šçš„ï¼Œ<strong>çº¿ç¨‹ä¸æ­»ï¼Œvalue å°±ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„æ¼</strong>ã€‚</li>
</ul>
</li>
<li>çº¿ç¨‹æ± å¤ç”¨çº¿ç¨‹ï¼šçº¿ç¨‹æ± å¯¼è‡´çº¿ç¨‹é•¿æœŸå­˜æ´»ï¼ŒåŠ å‰§æ³„æ¼é—®é¢˜<ul>
<li>å¦‚æœä½ åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨äº† ThreadLocal ä½†æ²¡è°ƒç”¨ <strong>remove()</strong>ï¼Œä¸Šä¸€ä¸ªè¯·æ±‚çš„æ•°æ®å°±å¯èƒ½<strong>è¢«ä¸‹ä¸€ä¸ªè¯·æ±‚å¤ç”¨çš„çº¿ç¨‹è¯¯ç”¨</strong>ï¼Œé€ æˆ<strong>æ•°æ®æ³„æ¼å’Œå®‰å…¨é£é™©ã€‚</strong></li>
</ul>
</li>
</ol>
<ul>
<li><strong>ThreadLocal çš„ key æ˜¯å¼±å¼•ç”¨ï¼Œè‹¥ä¸åŠæ—¶è°ƒç”¨ remove() æ¸…é™¤ç»‘å®šæ•°æ®ï¼Œå¯èƒ½å› çº¿ç¨‹æ± å¤ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ä¸ç”¨æˆ·æ•°æ®é”™ä¹±</strong>ï¼Œå°¤å…¶åœ¨é«˜å¹¶å‘ç³»ç»Ÿä¸­å±å®³æ›´æ˜æ˜¾ã€‚</li>
</ul>
<h4 id="2-4-ThreadLocalåŸç†-é‡ç‚¹"><a href="#2-4-ThreadLocalåŸç†-é‡ç‚¹" class="headerlink" title="2.4 ThreadLocalåŸç†(é‡ç‚¹)"></a>2.4 ThreadLocalåŸç†(é‡ç‚¹)</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44184990/article/details/122279854?ops_request_misc=%257B%2522request%255Fid%2522%253A%25224d0490e493964472613e577c3e94bd9f%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=4d0490e493964472613e577c3e94bd9f&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-122279854-null-null.142%5Ev102%5Epc_search_result_base2&utm_term=ThreadLocal%E5%8E%9F%E7%90%86&spm=1018.2226.3001.4187">ThreadLocalåŸç†</a></p>
<h3 id="3-åˆ©ç”¨-Redisson-åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œç»“åˆä¹è§‚é”æœºåˆ¶é˜²æ­¢ç§’æ€è¶…å–é—®é¢˜"><a href="#3-åˆ©ç”¨-Redisson-åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œç»“åˆä¹è§‚é”æœºåˆ¶é˜²æ­¢ç§’æ€è¶…å–é—®é¢˜" class="headerlink" title="3. åˆ©ç”¨ Redisson åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œç»“åˆä¹è§‚é”æœºåˆ¶é˜²æ­¢ç§’æ€è¶…å–é—®é¢˜"></a>3. åˆ©ç”¨ Redisson åˆ†å¸ƒå¼é”è§£å†³é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œç»“åˆä¹è§‚é”æœºåˆ¶é˜²æ­¢ç§’æ€è¶…å–é—®é¢˜</h3><h4 id="3-1-ä»€ä¹ˆæ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ"><a href="#3-1-ä»€ä¹ˆæ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ" class="headerlink" title="3.1 ä»€ä¹ˆæ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ"></a>3.1 ä»€ä¹ˆæ˜¯é›†ç¾¤ç¯å¢ƒä¸‹çš„å¹¶å‘å®‰å…¨é—®é¢˜ï¼Ÿ</h4><p><a href="#35-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E7%9A%84%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98">è·³è½¬åˆ°é›†ç¾¤ç¯å¢ƒä¸‹ä¸€äººä¸€å•çš„å¹¶å‘å®‰å…¨é—®é¢˜</a></p>
<ul>
<li><strong>ä¸€äººä¸€å•</strong>ï¼šç§’æ€ä¸šåŠ¡è¦æ±‚<strong>åŒä¸€ä¸ªä¼˜æƒ åˆ¸ï¼Œä¸€ä¸ªç”¨æˆ·åªèƒ½ä¸‹ä¸€å•</strong></li>
<li><strong>é›†ç¾¤ç¯å¢ƒä¸‹çš„ä¸€äººä¸€å•</strong>ï¼š<ul>
<li>é€šè¿‡åŠ é”å¯ä»¥è§£å†³åœ¨å•æœºæƒ…å†µä¸‹çš„ä¸€äººä¸€å•å®‰å…¨é—®é¢˜ï¼Œä½†æ˜¯<strong>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹å°±ä¸è¡Œäº†</strong></li>
<li><strong>æ¯ä¸ªtomcatéƒ½æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„jvm</strong>ï¼Œ<strong>æ¯ä¸ªJVMéƒ½æœ‰å„è‡ªçš„é”ç›‘è§†å™¨ï¼Œå¯¼è‡´ä¸åŒJVMçš„é”åœ¨ä¸åŒçš„é”ç›‘è§†å™¨ä¸­</strong></li>
<li>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼ŒåŠ é”åªæ˜¯å¯¹è¯¥ JVM ç»™å½“å‰è¿™å°æœåŠ¡å™¨çš„è¯·æ±‚çš„åŠ é”ï¼Œè€Œ<strong>é›†ç¾¤æ˜¯å¤šå°æœåŠ¡å™¨ï¼Œæ‰€ä»¥è¦ä½¿ç”¨åˆ†å¸ƒå¼é”</strong>ï¼Œæ»¡è¶³é›†ç¾¤æ¨¡å¼ä¸‹å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”ã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-2-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ"><a href="#3-2-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ" class="headerlink" title="3.2 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ"></a>3.2 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”ï¼Ÿ</h4><p><a href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">è·³è½¬åˆ°åˆ†å¸ƒå¼é”</a></p>
<p>åˆ†å¸ƒå¼é”ï¼šæ»¡è¶³åˆ†å¸ƒå¼ç³»ç»Ÿæˆ–é›†ç¾¤æ¨¡å¼ä¸‹<strong>å¤šè¿›ç¨‹å¯è§å¹¶ä¸”äº’æ–¥çš„é”</strong>ã€‚</p>
<ul>
<li>åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯è®©å¤§å®¶éƒ½ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œåªè¦å¤§å®¶ä½¿ç”¨çš„æ˜¯åŒä¸€æŠŠé”ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±èƒ½é”ä½çº¿ç¨‹ï¼Œä¸è®©çº¿ç¨‹è¿›è¡Œï¼Œè®©ç¨‹åºä¸²è¡Œæ‰§è¡Œï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”çš„æ ¸å¿ƒæ€è·¯</li>
</ul>
<h4 id="3-3-Redissonåˆ†å¸ƒå¼é”çš„åŸç†å’Œä½¿ç”¨"><a href="#3-3-Redissonåˆ†å¸ƒå¼é”çš„åŸç†å’Œä½¿ç”¨" class="headerlink" title="3.3 Redissonåˆ†å¸ƒå¼é”çš„åŸç†å’Œä½¿ç”¨"></a>3.3 Redissonåˆ†å¸ƒå¼é”çš„åŸç†å’Œä½¿ç”¨</h4><p><a href="#49-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">è·³è½¬åˆ°Redissonåˆ†å¸ƒå¼é”</a></p>
<p>Redisson æ˜¯ä¸€ä¸ª Java å®¢æˆ·ç«¯æ¡†æ¶ï¼ŒåŸºäº Redis å®ç°äº†åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼é›†åˆã€åˆ†å¸ƒå¼å¯¹è±¡ç­‰é«˜é˜¶åŠŸèƒ½</p>
<p><strong>Redisson åˆ†å¸ƒå¼é”çš„åŸç†ï¼š</strong></p>
<ol>
<li><strong>åŠ é”åŸç†</strong>ï¼šRedisson ä½¿ç”¨ Redis çš„ <code>SET key value NX PX</code> å‘½ä»¤åŠ é”<ul>
<li>key æ˜¯é”åï¼Œvalue æ˜¯å”¯ä¸€æ ‡è¯†ï¼ˆUUID+çº¿ç¨‹IDï¼‰</li>
<li>è®¾ç½® 30 ç§’è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤å€¼ï¼Œå¯é…ç½®ï¼‰</li>
</ul>
</li>
<li><strong>çœ‹é—¨ç‹—æœºåˆ¶ï¼ˆWatchdogï¼‰</strong><ul>
<li>å¦‚æœä½¿ç”¨ lock() åŠ é”ï¼ˆä¸å¸¦è¶…æ—¶æ—¶é—´ï¼‰ï¼ŒRedisson ä¼šå¯åŠ¨ä¸€ä¸ªåå°å®šæ—¶ä»»åŠ¡ï¼Œæ¯éš” 10 ç§’è‡ªåŠ¨ç»­æœŸï¼Œå°†é”çš„è¿‡æœŸæ—¶é—´ç»­ä¸º 30 ç§’ï¼›</li>
<li>å¦‚æœä½ ä¸»åŠ¨è®¾ç½®äº†é”çš„è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚ lock(10, TimeUnit.SECONDS)ï¼Œåˆ™ä¸ä¼šè‡ªåŠ¨ç»­æœŸï¼Œ10 ç§’åè‡ªåŠ¨é‡Šæ”¾ï¼›</li>
</ul>
</li>
<li><strong>è§£é”åŸç†</strong><ul>
<li>Redisson ä¼šéªŒè¯å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯é”çš„æ‹¥æœ‰è€…ï¼ˆæ ¹æ® UUID+çº¿ç¨‹ID åˆ¤æ–­ï¼‰</li>
<li>æ˜¯çš„è¯æ‰§è¡Œ Lua è„šæœ¬åˆ é™¤é”ï¼Œé˜²æ­¢è¯¯åˆ å…¶ä»–çº¿ç¨‹çš„é”ï¼ˆåŸå­æ“ä½œï¼‰</li>
</ul>
</li>
<li><strong>æ”¯æŒå¤šç§æ¨¡å¼</strong><ul>
<li>å…¬å¹³é”ï¼šæ’é˜Ÿæœºåˆ¶ï¼Œå…ˆæ¥å…ˆå¾—ï¼ˆé€‚ç”¨äºé«˜å¹¶å‘ä¸‹å…¬å¹³è®¿é—®èµ„æºçš„åœºæ™¯ï¼‰</li>
<li>å¯é‡å…¥é”ï¼šåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€æŠŠé”</li>
</ul>
</li>
</ol>
<p><strong>ä½¿ç”¨Redissionçš„åˆ†å¸ƒå¼é”ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissionClient redissonClient;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//è·å–é”(å¯é‡å…¥)ï¼ŒæŒ‡å®šé”çš„åç§°</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br>    <span class="hljs-comment">//å°è¯•è·å–é”ï¼Œå‚æ•°åˆ†åˆ«æ˜¯ï¼šè·å–é”çš„æœ€å¤§ç­‰å¾…æ—¶é—´(æœŸé—´ä¼šé‡è¯•)ï¼Œé”è‡ªåŠ¨é‡Šæ”¾æ—¶é—´ï¼Œæ—¶é—´å•ä½</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>    <span class="hljs-comment">//åˆ¤æ–­è·å–é”æˆåŠŸ</span><br>    <span class="hljs-keyword">if</span>(isLock)&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;æ‰§è¡Œä¸šåŠ¡&quot;</span>);          <br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            <span class="hljs-comment">//é‡Šæ”¾é”</span><br>            lock.unlock();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="3-4-ä¸ºä»€ä¹ˆä¼šå‡ºç°è¶…å–ï¼Ÿ"><a href="#3-4-ä¸ºä»€ä¹ˆä¼šå‡ºç°è¶…å–ï¼Ÿ" class="headerlink" title="3.4 ä¸ºä»€ä¹ˆä¼šå‡ºç°è¶…å–ï¼Ÿ"></a>3.4 ä¸ºä»€ä¹ˆä¼šå‡ºç°è¶…å–ï¼Ÿ</h4><p>ä¸»è¦æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹å¹¶å‘æ§åˆ¶ä¸å½“é€ æˆçš„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå…¸å‹æµç¨‹ï¼š</p>
<ol>
<li>å¤šä¸ªç”¨æˆ·åŒæ—¶æŸ¥è¯¢åº“å­˜ï¼ˆæ¯”å¦‚æŸ¥åˆ°å½“å‰åº“å­˜ä¸º 5ï¼‰</li>
<li>å¤šä¸ªç”¨æˆ·å‡ ä¹åŒæ—¶å‘èµ·ä¸‹å•è¯·æ±‚</li>
<li>ç³»ç»Ÿæ¥ä¸åŠâ€œåŒæ­¥æ›´æ–°â€åº“å­˜ï¼Œå¯¼è‡´å¤šä¸ªè¯·æ±‚éƒ½æˆåŠŸäº† âœ åº“å­˜å˜è´Ÿæ•°<br><strong>å–å‡ºå»çš„æ•°é‡è¶…è¿‡äº†å®é™…åº“å­˜</strong>ã€‚</li>
</ol>
<h4 id="3-5-ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ"><a href="#3-5-ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ" class="headerlink" title="3.5 ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ"></a>3.5 ä»€ä¹ˆæ˜¯ä¹è§‚é”ï¼Ÿ</h4><p><strong>æ‚²è§‚é”ï¼š</strong></p>
<ul>
<li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤<strong>åœ¨æ“ä½œæ•°æ®ä¹‹å‰å…ˆè·å–é”</strong>ï¼Œç¡®ä¿çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œã€‚</li>
<li>ä¾‹å¦‚Synchronizedã€Lockéƒ½å±äºæ‚²è§‚é”</li>
</ul>
<p><strong>ä¹è§‚é”(CAS)ï¼š</strong></p>
<ul>
<li>è®¤ä¸ºçº¿ç¨‹å®‰å…¨é—®é¢˜ä¸ä¸€å®šä¼šå‘ç”Ÿï¼Œå› æ­¤ä¸åŠ é”ï¼Œ<strong>åªæ˜¯åœ¨æ›´æ–°æ•°æ®æ—¶å»åˆ¤æ–­æœ‰æ²¡æœ‰å…¶å®ƒçº¿ç¨‹å¯¹æ•°æ®åšäº†ä¿®æ”¹</strong>ã€‚</li>
<li>å¦‚æœæ²¡æœ‰ä¿®æ”¹åˆ™è®¤ä¸ºæ˜¯å®‰å…¨çš„ï¼Œè‡ªå·±æ‰æ›´æ–°æ•°æ®ã€‚</li>
<li>å¦‚æœå·²ç»è¢«å…¶å®ƒçº¿ç¨‹ä¿®æ”¹è¯´æ˜å‘ç”Ÿäº†å®‰å…¨é—®é¢˜ï¼Œæ­¤æ—¶å¯ä»¥é‡è¯•æˆ–å¼‚å¸¸</li>
</ul>
<h4 id="3-6-å¦‚ä½•ä½¿ç”¨ä¹è§‚é”-CAS-è§£å†³è¶…å–é—®é¢˜ï¼Ÿ"><a href="#3-6-å¦‚ä½•ä½¿ç”¨ä¹è§‚é”-CAS-è§£å†³è¶…å–é—®é¢˜ï¼Ÿ" class="headerlink" title="3.6 å¦‚ä½•ä½¿ç”¨ä¹è§‚é”(CAS)è§£å†³è¶…å–é—®é¢˜ï¼Ÿ"></a>3.6 å¦‚ä½•ä½¿ç”¨ä¹è§‚é”(CAS)è§£å†³è¶…å–é—®é¢˜ï¼Ÿ</h4><p><a href="#332-%E5%9F%BA%E4%BA%8E%E4%B9%90%E8%A7%82%E9%94%81cas%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">è·³è½¬åˆ°ä¹è§‚é”è§£å†³æ–¹æ¡ˆ</a></p>
<p><strong>åªè¦æˆ‘æ‰£å‡åº“å­˜æ—¶çš„åº“å­˜å’Œä¹‹å‰æˆ‘æŸ¥è¯¢åˆ°çš„åº“å­˜æ˜¯ä¸€æ ·çš„ï¼Œå°±æ„å‘³ç€æ²¡æœ‰äººåœ¨ä¸­é—´ä¿®æ”¹è¿‡åº“å­˜ï¼Œé‚£ä¹ˆæ­¤æ—¶å°±æ˜¯å®‰å…¨çš„</strong><br>æˆ‘ä»¬çš„ä¹è§‚é”éœ€è¦å˜ä¸€ä¸‹ï¼Œæ”¹æˆstockå¤§äº0 å³å¯</p>
<ul>
<li><strong>åªè¦åº“å­˜å¤§äº0ï¼Œå°±å¯ä»¥ä¹°ï¼Œä¸ä¼šè¶…å–</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="hljs-string">&quot;stock&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">//where id = ? and stock &gt; 0</span><br></code></pre></td></tr></table></figure>



<h3 id="4-ä½¿ç”¨-Redis-è§£å†³äº†åœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„-Session-å…±äº«é—®é¢˜ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°"><a href="#4-ä½¿ç”¨-Redis-è§£å†³äº†åœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„-Session-å…±äº«é—®é¢˜ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°" class="headerlink" title="4. ä½¿ç”¨ Redis è§£å†³äº†åœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„ Session å…±äº«é—®é¢˜ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°"></a>4. ä½¿ç”¨ Redis è§£å†³äº†åœ¨é›†ç¾¤æ¨¡å¼ä¸‹çš„ Session å…±äº«é—®é¢˜ï¼Œä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°</h3><p><a target="_blank" rel="noopener" href="https://kneegcyao.github.io/posts/bbf9fa63.html">é»‘é©¬ç‚¹è¯„é‡ç‚¹é¢è¯•é—®é¢˜</a></p>
<h4 id="4-1-ä»€ä¹ˆæ˜¯Sessionå…±äº«é—®é¢˜ï¼Ÿ"><a href="#4-1-ä»€ä¹ˆæ˜¯Sessionå…±äº«é—®é¢˜ï¼Ÿ" class="headerlink" title="4.1 ä»€ä¹ˆæ˜¯Sessionå…±äº«é—®é¢˜ï¼Ÿ"></a>4.1 ä»€ä¹ˆæ˜¯Sessionå…±äº«é—®é¢˜ï¼Ÿ</h4><p><a href="#15-session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98">è·³è½¬åˆ°sessionå…±äº«é—®é¢˜</a></p>
<p><strong>å¤šå° Tomct å¹¶ä¸å…±äº« session å­˜å‚¨ç©ºé—´ï¼Œå½“è¯·æ±‚åˆ‡æ¢åˆ°ä¸åŒ tomcat æœåŠ¡æ—¶å¯¼è‡´æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚</strong></p>
<p><strong>æ¯ä¸ªtomcatä¸­éƒ½æœ‰ä¸€ä»½å±äºè‡ªå·±çš„session</strong>,å‡è®¾ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®ç¬¬ä¸€å°tomcatï¼Œå¹¶ä¸”æŠŠè‡ªå·±çš„ä¿¡æ¯å­˜æ”¾åˆ°ç¬¬ä¸€å°æœåŠ¡å™¨çš„sessionä¸­ï¼Œä½†æ˜¯ç¬¬äºŒæ¬¡è¿™ä¸ªç”¨æˆ·è®¿é—®åˆ°äº†ç¬¬äºŒå°tomcatï¼Œé‚£ä¹ˆ<strong>åœ¨ç¬¬äºŒå°æœåŠ¡å™¨ä¸Šï¼Œè‚¯å®šæ²¡æœ‰ç¬¬ä¸€å°æœåŠ¡å™¨å­˜æ”¾çš„session</strong>ï¼Œæ‰€ä»¥æ­¤æ—¶ æ•´ä¸ªç™»å½•æ‹¦æˆªåŠŸèƒ½å°±ä¼šå‡ºç°é—®é¢˜</p>
<p>æˆ‘ä»¬èƒ½å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ<strong>æ—©æœŸçš„æ–¹æ¡ˆæ˜¯sessionæ‹·è´</strong>ï¼Œå°±æ˜¯è¯´è™½ç„¶æ¯ä¸ªtomcatä¸Šéƒ½æœ‰ä¸åŒçš„sessionï¼Œä½†æ˜¯æ¯å½“<strong>ä»»æ„ä¸€å°æœåŠ¡å™¨çš„sessionä¿®æ”¹æ—¶ï¼Œéƒ½ä¼šåŒæ­¥ç»™å…¶ä»–çš„TomcatæœåŠ¡å™¨çš„session</strong>ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°sessionçš„å…±äº«äº†</p>
<p>åæ¥é‡‡ç”¨çš„æ–¹æ¡ˆéƒ½æ˜¯åŸºäºredisæ¥å®Œæˆï¼Œæˆ‘ä»¬<strong>æŠŠsessionæ¢æˆredis</strong>ï¼Œ<strong>redisæ•°æ®æœ¬èº«å°±æ˜¯å…±äº«çš„ï¼Œå°±å¯ä»¥é¿å…sessionå…±äº«</strong>çš„é—®é¢˜äº†</p>
<h4 id="4-2-å¦‚ä½•åœ¨ç™»å½•è¿‡ç¨‹ä¸­ç”¨Redisä»£æ›¿Sessionçš„ï¼Ÿ"><a href="#4-2-å¦‚ä½•åœ¨ç™»å½•è¿‡ç¨‹ä¸­ç”¨Redisä»£æ›¿Sessionçš„ï¼Ÿ" class="headerlink" title="4.2 å¦‚ä½•åœ¨ç™»å½•è¿‡ç¨‹ä¸­ç”¨Redisä»£æ›¿Sessionçš„ï¼Ÿ"></a>4.2 å¦‚ä½•åœ¨ç™»å½•è¿‡ç¨‹ä¸­ç”¨Redisä»£æ›¿Sessionçš„ï¼Ÿ</h4><p><a href="#16-redis%E4%BB%A3%E6%9B%BFsession%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B">è·³è½¬åˆ°Redisä»£æ›¿sessionçš„ä¸šåŠ¡æµç¨‹</a></p>
<p><strong>ç™»å½•æµç¨‹ï¼š</strong></p>
<ol>
<li><strong>å‘é€çŸ­ä¿¡éªŒè¯ç </strong>ï¼šå°†éªŒè¯ç ä¿å­˜åˆ°Redisé‡Œé¢ï¼Œè€Œä¸æ˜¯session</li>
<li><strong>ç™»å½•è¿‡ç¨‹</strong>ï¼šæ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™æ–°å»ºï¼Œæœ€åå°†ç”¨æˆ·æ•°æ®ä¿å­˜åˆ°redis(ä½œä¸ºå€¼)ï¼Œå¹¶ä¸”ç”Ÿæˆtokenä½œä¸ºredisçš„key</li>
<li><strong>æ ¡éªŒç™»å½•çŠ¶æ€</strong>ï¼šå½“æˆ‘ä»¬æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»å½•æ—¶ï¼Œä¼šå»<strong>æºå¸¦ç€tokenè¿›è¡Œè®¿é—®</strong>ï¼Œä»redisä¸­å–å‡ºtokenå¯¹åº”çš„valueï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¿™ä¸ªæ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ‹¦æˆªï¼Œå¦‚æœå­˜åœ¨åˆ™å°†å…¶ä¿å­˜åˆ°threadLocalä¸­ï¼Œå¹¶ä¸”æ”¾è¡Œã€‚</li>
</ol>
<h4 id="4-3-è¿˜æœ‰å…¶ä»–è§£å†³æ–¹æ³•å—ï¼Ÿ"><a href="#4-3-è¿˜æœ‰å…¶ä»–è§£å†³æ–¹æ³•å—ï¼Ÿ" class="headerlink" title="4.3 è¿˜æœ‰å…¶ä»–è§£å†³æ–¹æ³•å—ï¼Ÿ"></a>4.3 è¿˜æœ‰å…¶ä»–è§£å†³æ–¹æ³•å—ï¼Ÿ</h4><ul>
<li><strong>åŸºäº Cookie çš„ Token æœºåˆ¶</strong>ï¼Œä¸å†ä½¿ç”¨æœåŠ¡å™¨ç«¯ä¿å­˜ Sessionï¼Œè€Œæ˜¯é€šè¿‡<strong>å®¢æˆ·ç«¯ä¿å­˜ Token</strong>ï¼ˆå¦‚ JWTï¼‰ã€‚</li>
<li>Token åŒ…å«ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ· IDã€æƒé™ç­‰ï¼‰ï¼Œå¹¶é€šè¿‡ç­¾åéªŒè¯å…¶å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚</li>
<li>æ¯æ¬¡è¯·æ±‚ï¼Œ<strong>å®¢æˆ·ç«¯å°† Token æ”¾åœ¨ Cookie æˆ– HTTP å¤´ä¸­å‘é€åˆ°æœåŠ¡</strong>ï¼Œè¿›è¡ŒéªŒè¯</li>
</ul>
<h4 id="4-4-å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°ï¼Ÿ"><a href="#4-4-å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°ï¼Ÿ" class="headerlink" title="4.4 å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°ï¼Ÿ"></a>4.4 å¦‚ä½•ä½¿ç”¨æ‹¦æˆªå™¨å®ç°ç”¨æˆ·çš„ç™»å½•æ ¡éªŒå’Œæƒé™åˆ·æ–°ï¼Ÿ</h4><p><a href="#18-%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98">è·³è½¬åˆ°æ‹¦æˆªå™¨</a></p>
<p><strong>é—®é¢˜æ‰€åœ¨ï¼š</strong></p>
<ul>
<li>åŸå§‹æ–¹æ¡ˆç¡®å®å¯ä»¥ä½¿ç”¨å¯¹åº”è·¯å¾„çš„æ‹¦æˆªï¼ŒåŒæ—¶åˆ·æ–°ç™»å½•tokenä»¤ç‰Œçš„å­˜æ´»æ—¶é—´ï¼Œä½†æ˜¯ç°åœ¨è¿™ä¸ªæ‹¦æˆªå™¨ä»–<strong>åªæ˜¯æ‹¦æˆªéœ€è¦è¢«æ‹¦æˆªçš„è·¯å¾„</strong></li>
<li>å‡è®¾<strong>å½“å‰ç”¨æˆ·è®¿é—®äº†ä¸€äº›ä¸éœ€è¦æ‹¦æˆªçš„è·¯å¾„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹¦æˆªå™¨å°±ä¸ä¼šç”Ÿæ•ˆ</strong>ï¼Œæ‰€ä»¥æ­¤æ—¶<strong>ä»¤ç‰Œåˆ·æ–°çš„åŠ¨ä½œå®é™…ä¸Šå°±ä¸ä¼šæ‰§è¡Œ</strong>ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ¡ˆä»–æ˜¯å­˜åœ¨é—®é¢˜çš„</li>
</ul>
<p><strong>å®ç°æ–¹æ¡ˆï¼š</strong></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥æ·»åŠ ä¸€ä¸ªæ‹¦æˆªå™¨</li>
</ul>
<ol>
<li>åœ¨<strong>ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æ‹¦æˆªæ‰€æœ‰çš„è·¯å¾„</strong>ï¼ŒæŠŠç¬¬äºŒä¸ªæ‹¦æˆªå™¨åšçš„äº‹æƒ…æ”¾å…¥åˆ°ç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨ä¸­ï¼ŒåŒæ—¶<strong>åˆ·æ–°ä»¤ç‰Œ</strong></li>
<li>å› ä¸ºç¬¬ä¸€ä¸ªæ‹¦æˆªå™¨æœ‰äº†ThreadLocalçš„æ•°æ®ï¼Œæ‰€ä»¥æ­¤æ—¶<strong>ç¬¬äºŒä¸ªæ‹¦æˆªå™¨åªéœ€è¦åˆ¤æ–­æ‹¦æˆªå™¨ä¸­çš„userå¯¹è±¡æ˜¯å¦å­˜åœ¨å³å¯</strong>ï¼Œå®Œæˆæ•´ä½“åˆ·æ–°åŠŸèƒ½ã€‚</li>
</ol>
<ul>
<li>ç¬¬ä¸€å±‚æ‹¦æˆªå™¨æ˜¯åš<strong>å…¨å±€å¤„ç†</strong>ï¼Œä¾‹å¦‚è·å– Tokenï¼ŒæŸ¥è¯¢ Redis ä¸­çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåˆ·æ–° Token æœ‰æ•ˆæœŸç­‰é€šç”¨æ“ä½œã€‚</li>
<li>ç¬¬äºŒå±‚æ‹¦æˆªå™¨ä¸“æ³¨äº<strong>éªŒè¯ç”¨æˆ·ç™»å½•</strong>çš„é€»è¾‘ï¼Œå¦‚æœè·¯å¾„éœ€è¦ç™»å½•ï¼Œä½†ç”¨æˆ·æœªç™»å½•ï¼Œåˆ™ç›´æ¥æ‹¦æˆªè¯·æ±‚ã€‚<strong>ä½œç”¨æ˜¯æ‹¦æˆªæœªç™»å½•çš„ç”¨æˆ·</strong></li>
</ul>
<p><strong>å¥½å¤„ï¼š</strong></p>
<ul>
<li>èŒè´£åˆ†ç¦»ï¼šè¿™ç§åˆ†å±‚è®¾è®¡è®©æ¯ä¸ªæ‹¦æˆªå™¨çš„èŒè´£æ›´åŠ å•ä¸€ï¼Œä»£ç æ›´åŠ æ¸…æ™°ã€æ˜“äºç»´æŠ¤</li>
<li>æå‡æ€§èƒ½</li>
</ul>
<h3 id="5-å®ç°åŸºäºæ¨æ¨¡å¼çš„-Feed-æµåŠŸèƒ½ï¼Œé‡‡ç”¨æ»šåŠ¨åˆ†é¡µï¼Œç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—"><a href="#5-å®ç°åŸºäºæ¨æ¨¡å¼çš„-Feed-æµåŠŸèƒ½ï¼Œé‡‡ç”¨æ»šåŠ¨åˆ†é¡µï¼Œç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="5. å®ç°åŸºäºæ¨æ¨¡å¼çš„ Feed æµåŠŸèƒ½ï¼Œé‡‡ç”¨æ»šåŠ¨åˆ†é¡µï¼Œç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—"></a>5. å®ç°åŸºäºæ¨æ¨¡å¼çš„ Feed æµåŠŸèƒ½ï¼Œé‡‡ç”¨æ»šåŠ¨åˆ†é¡µï¼Œç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—</h3><p><a href="#73-%E5%85%B1%E5%90%8C%E6%8E%A8%E9%80%81-feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88">è·³è½¬åˆ°å…±åŒæ¨é€-Feeedæµå®ç°æ–¹æ¡ˆ</a></p>
<h4 id="5-1-ä»€ä¹ˆæ˜¯æ¨æ¨¡å¼çš„Feedæµï¼Ÿ"><a href="#5-1-ä»€ä¹ˆæ˜¯æ¨æ¨¡å¼çš„Feedæµï¼Ÿ" class="headerlink" title="5.1 ä»€ä¹ˆæ˜¯æ¨æ¨¡å¼çš„Feedæµï¼Ÿ"></a>5.1 ä»€ä¹ˆæ˜¯æ¨æ¨¡å¼çš„Feedæµï¼Ÿ</h4><ul>
<li><strong>å…³æ³¨æ¨é€ä¹Ÿå«åšFeedæµ</strong>ï¼Œç›´è¯‘ä¸ºæŠ•å–‚ã€‚ä¸ºç”¨æˆ·æŒç»­çš„æä¾›â€œæ²‰æµ¸å¼â€çš„ä½“éªŒï¼Œé€šè¿‡æ— é™ä¸‹æ‹‰åˆ·æ–°è·å–æ–°çš„ä¿¡æ¯</li>
</ul>
<p>Feedæµäº§å“æœ‰ä¸¤ç§å¸¸è§æ¨¡å¼</p>
<ul>
<li><strong>Timeline</strong>ï¼šä¸åšå†…å®¹ç­›é€‰ï¼Œç®€å•çš„æŒ‰ç…§å†…å®¹å‘å¸ƒæ—¶é—´æ’åºï¼Œå¸¸ç”¨äºå¥½å‹æˆ–å…³æ³¨ã€‚ä¾‹å¦‚æœ‹å‹åœˆ</li>
<li><strong>æ™ºèƒ½æ’åº</strong>ï¼šåˆ©ç”¨æ™ºèƒ½ç®—æ³•å±è”½æ‰è¿è§„çš„ã€ç”¨æˆ·ä¸æ„Ÿå…´è¶£çš„å†…å®¹ã€‚æ¨é€ç”¨æˆ·æ„Ÿå…´è¶£ä¿¡æ¯æ¥å¸å¼•ç”¨æˆ·(æŠ–éŸ³)</li>
</ul>
<p><strong>Timelineçš„ä¸‰ç§æ¨¡å¼</strong><br><a href="#73-%E5%85%B1%E5%90%8C%E6%8E%A8%E9%80%81-feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88">è·³è½¬åˆ°å…±åŒæ¨é€æŸ¥çœ‹</a></p>
<ul>
<li>æ‹‰æ¨¡å¼</li>
<li>æ¨æ¨¡å¼ï¼šä¹Ÿå«å†™æ‰©æ•£</li>
<li>æ¨æ‹‰ç»“åˆ</li>
</ul>
<p><strong>æ¨æ¨¡å¼çš„Feedæµ</strong></p>
<ul>
<li>å½“å¼ ä¸‰å†™äº†ä¸€ä¸ªå†…å®¹ï¼Œæ­¤æ—¶ä¼š<strong>ä¸»åŠ¨çš„æŠŠå¼ ä¸‰å†™çš„å†…å®¹å‘é€åˆ°ä»–çš„ç²‰ä¸æ”¶ä»¶ç®±</strong>ä¸­å»ï¼Œå‡è®¾æ­¤æ—¶æå››å†æ¥è¯»å–ï¼Œå°±ä¸ç”¨å†å»ä¸´æ—¶æ‹‰å–äº†ï¼ˆåƒæœ‹å‹åœˆçš„æ–¹å¼ï¼‰</li>
<li><strong>ç”¨æˆ·å‘å¸ƒç¬”è®°æ—¶å®æ—¶æ¨é€è‡³ç²‰ä¸æ¶ˆæ¯é˜Ÿåˆ—</strong></li>
</ul>
<h4 id="5-2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ»šåŠ¨åˆ†é¡µï¼Ÿ"><a href="#5-2-ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ»šåŠ¨åˆ†é¡µï¼Ÿ" class="headerlink" title="5.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ»šåŠ¨åˆ†é¡µï¼Ÿ"></a>5.2 ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ»šåŠ¨åˆ†é¡µï¼Ÿ</h4><p>Feedæµä¸­çš„<strong>æ•°æ®ä¼šä¸æ–­æ›´æ–°</strong>ï¼Œæ‰€ä»¥æ•°æ®çš„è§’æ ‡ä¹Ÿåœ¨å˜åŒ–ï¼Œå› æ­¤ä¸èƒ½é‡‡ç”¨ä¼ ç»Ÿçš„åˆ†é¡µæ¨¡å¼ã€‚</p>
<ul>
<li>å¦‚ä½•å®ç°Feedæµçš„åˆ†é¡µåŠŸèƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ï¼Œå¦‚æœé‡‡ç”¨MyBatisä¸­çš„åˆ†é¡µæ’ä»¶æ˜¯ä¸èƒ½æ»¡è¶³åˆ†é¡µåŠŸèƒ½çš„ï¼Œ<strong>å› ä¸ºFeedæµæ˜¯ä¸€ä¸ªåŠ¨æ€çš„ï¼Œæ•°æ®ä¼šä¸æ–­æ›´æ–°ï¼Œå› æ­¤æ•°æ®çš„è§’æ ‡ä¼šä¸åœæ›´æ–°</strong>ï¼Œå½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢ç¬¬5-10æ¡çš„æ•°æ®æ—¶ï¼Œå¯èƒ½åˆä¿å­˜äº†ä¸€ä¸ªæ–°çš„æ•°æ®åˆ°æ•°æ®åº“ï¼Œä»è€Œ<strong>å¯¼è‡´æˆ‘ä»¬åˆ†é¡µæŸ¥æ‰¾çš„æ•°æ®å­˜åœ¨ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æ•°æ®é‡å¤çš„é—®é¢˜</strong></li>
</ul>
<h4 id="5-3-å¦‚ä½•å®ç°æ»šåŠ¨åˆ†é¡µï¼Ÿ"><a href="#5-3-å¦‚ä½•å®ç°æ»šåŠ¨åˆ†é¡µï¼Ÿ" class="headerlink" title="5.3 å¦‚ä½•å®ç°æ»šåŠ¨åˆ†é¡µï¼Ÿ"></a>5.3 å¦‚ä½•å®ç°æ»šåŠ¨åˆ†é¡µï¼Ÿ</h4><p>æ»šåŠ¨åˆ†é¡µå°±æ˜¯æ¯æ¬¡æŸ¥è¯¢è¿‡æ•°æ®åº“åï¼Œæˆ‘ä»¬éœ€è¦<strong>è®°å½•è¿™ä¸€æ¬¡æŸ¥è¯¢ç»“æœçš„æœ€åä¸€æ¡æ•°æ®ï¼Œä¸‹ä¸€æ¬¡æŸ¥è¯¢æ—¶ï¼Œä»è¿™ä¸ªä½ç½®å¼€å§‹å»è¯»å–æ•°æ®</strong></p>
<ol>
<li>æ¯æ¬¡æŸ¥è¯¢å®Œæˆåï¼Œæˆ‘ä»¬è¦åˆ†æå‡º<strong>æŸ¥è¯¢å‡ºæ•°æ®çš„æœ€å°æ—¶é—´æˆ³</strong>ï¼Œè¿™ä¸ªå€¼ä¼š<strong>ä½œä¸ºä¸‹ä¸€æ¬¡æŸ¥è¯¢çš„æ¡ä»¶</strong></li>
<li>æˆ‘ä»¬éœ€è¦<strong>æ‰¾åˆ°ä¸ä¸Šä¸€æ¬¡æŸ¥è¯¢ç›¸åŒçš„æŸ¥è¯¢ä¸ªæ•°ä½œä¸ºåç§»é‡</strong>ï¼Œä¸‹æ¬¡æŸ¥è¯¢æ—¶ï¼Œ<strong>è·³è¿‡è¿™äº›æŸ¥è¯¢è¿‡çš„æ•°æ®ï¼Œæ‹¿åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®</strong></li>
</ol>
<ul>
<li>ç»¼ä¸Šï¼šæˆ‘ä»¬çš„è¯·æ±‚å‚æ•°ä¸­å°±éœ€è¦æºå¸¦ lastIdï¼š<strong>ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„æœ€å°æ—¶é—´æˆ³</strong> å’Œ<strong>åç§»é‡</strong>è¿™ä¸¤ä¸ªå‚æ•°</li>
</ul>
<h3 id="6-å€ŸåŠ©-Redis-çš„-ZSet-å®ç°ç‚¹èµæ’è¡Œæ¦œï¼Œåˆ©ç”¨-Set-æ•°æ®ç»“æ„æ”¯æŒç”¨æˆ·å…³æ³¨ä¸å…±åŒå…³æ³¨åŠŸèƒ½"><a href="#6-å€ŸåŠ©-Redis-çš„-ZSet-å®ç°ç‚¹èµæ’è¡Œæ¦œï¼Œåˆ©ç”¨-Set-æ•°æ®ç»“æ„æ”¯æŒç”¨æˆ·å…³æ³¨ä¸å…±åŒå…³æ³¨åŠŸèƒ½" class="headerlink" title="6. å€ŸåŠ© Redis çš„ ZSet å®ç°ç‚¹èµæ’è¡Œæ¦œï¼Œåˆ©ç”¨ Set æ•°æ®ç»“æ„æ”¯æŒç”¨æˆ·å…³æ³¨ä¸å…±åŒå…³æ³¨åŠŸèƒ½"></a>6. å€ŸåŠ© Redis çš„ ZSet å®ç°ç‚¹èµæ’è¡Œæ¦œï¼Œåˆ©ç”¨ Set æ•°æ®ç»“æ„æ”¯æŒç”¨æˆ·å…³æ³¨ä¸å…±åŒå…³æ³¨åŠŸèƒ½</h3><h4 id="6-1-ä¸ºä»€ä¹ˆä½¿ç”¨ZSetå®ç°ç‚¹èµæ’è¡Œæ¦œï¼Ÿ"><a href="#6-1-ä¸ºä»€ä¹ˆä½¿ç”¨ZSetå®ç°ç‚¹èµæ’è¡Œæ¦œï¼Ÿ" class="headerlink" title="6.1 ä¸ºä»€ä¹ˆä½¿ç”¨ZSetå®ç°ç‚¹èµæ’è¡Œæ¦œï¼Ÿ"></a>6.1 ä¸ºä»€ä¹ˆä½¿ç”¨ZSetå®ç°ç‚¹èµæ’è¡Œæ¦œï¼Ÿ</h4><p><a href="#63-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C">è·³è½¬åˆ°ç‚¹èµæ’è¡Œæ¦œ</a></p>
<p>åœ¨æ¢åº—ç¬”è®°çš„è¯¦æƒ…é¡µé¢ï¼Œåº”è¯¥æŠŠç»™è¯¥ç¬”è®°ç‚¹èµçš„äººæ˜¾ç¤ºå‡ºæ¥ï¼Œæ¯”å¦‚æœ€æ—©ç‚¹èµçš„TOP5ï¼Œå½¢æˆç‚¹èµæ’è¡Œæ¦œ</p>
<ul>
<li><strong>ç‚¹èµåŠŸèƒ½</strong>ï¼šä½¿ç”¨seté›†åˆï¼Œå› ä¸ºç‚¹èµæ˜¯ä¸èƒ½é‡å¤çš„</li>
<li><strong>ç‚¹èµæ’è¡Œæ¦œåŠŸèƒ½</strong>ï¼šä½¿ç”¨sortedSet(ZSet)ï¼Œå› ä¸ºéœ€è¦é‡‡ç”¨ä¸€ä¸ª<strong>å¯ä»¥æ’åºçš„seté›†åˆ</strong></li>
</ul>
<p>ZSetï¼šä¿å­˜ç”¨æˆ·IDä¸ºé”®ï¼Œç”¨æˆ·ç‚¹èµæ—¶é—´ä½œä¸ºscoreè¿›è¡Œæ’åº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br></code></pre></td></tr></table></figure>

<p>æŸ¥è¯¢top5çš„ç‚¹èµç”¨æˆ·: <code>zrange key 0 4</code></p>
<h4 id="6-2-å¦‚ä½•åˆ©ç”¨Setå®ç°ç”¨æˆ·å…³æ³¨å’Œå…±åŒå…³æ³¨ï¼Ÿ"><a href="#6-2-å¦‚ä½•åˆ©ç”¨Setå®ç°ç”¨æˆ·å…³æ³¨å’Œå…±åŒå…³æ³¨ï¼Ÿ" class="headerlink" title="6.2 å¦‚ä½•åˆ©ç”¨Setå®ç°ç”¨æˆ·å…³æ³¨å’Œå…±åŒå…³æ³¨ï¼Ÿ"></a>6.2 å¦‚ä½•åˆ©ç”¨Setå®ç°ç”¨æˆ·å…³æ³¨å’Œå…±åŒå…³æ³¨ï¼Ÿ</h4><p><a href="#72-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8">è·³è½¬åˆ°å…³æ³¨å’Œå…±åŒå…³æ³¨</a></p>
<p><strong>ç”¨æˆ·å…³æ³¨</strong>ï¼šæ˜¯Userä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯åšä¸»ä¸ç²‰ä¸çš„å…³ç³»ï¼Œæ•°æ®åº“ä¸­æœ‰ä¸€å¼ tb_followè¡¨æ¥è¡¨ç¤º</p>
<ul>
<li>è¡¨çš„ä¸»é”®æ˜¯å½“å‰ç”¨æˆ·IDï¼Œæœ‰ä¸€ä¸ªFollowedIDè¡¨ç¤ºå…³æ³¨çš„ç”¨æˆ·ID</li>
</ul>
<p><strong>å…±åŒå…³æ³¨</strong>ï¼šåœ¨åšä¸»ä¸ªäººé¡µé¢å±•ç¤ºå‡ºå½“å‰ç”¨æˆ·ä¸åšä¸»çš„å…±åŒå…³æ³¨å‘¢</p>
<ul>
<li>ä½¿ç”¨seté›†åˆï¼Œ<strong>åœ¨seté›†åˆä¸­ï¼Œæœ‰äº¤é›†å¹¶é›†è¡¥é›†çš„api</strong></li>
<li>æˆ‘ä»¬å¯ä»¥æŠŠä¸¤äººçš„å…³æ³¨çš„äººåˆ†åˆ«æ”¾å…¥åˆ°ä¸€ä¸ªseté›†åˆä¸­ï¼Œç„¶åå†é€šè¿‡apiå»æŸ¥çœ‹è¿™ä¸¤ä¸ªseté›†åˆä¸­çš„äº¤é›†æ•°æ®ã€‚</li>
</ul>
<h4 id="6-3-ä»‹ç»Setæ•°æ®ç»“æ„å’Œåº•å±‚åŸç†"><a href="#6-3-ä»‹ç»Setæ•°æ®ç»“æ„å’Œåº•å±‚åŸç†" class="headerlink" title="6.3 ä»‹ç»Setæ•°æ®ç»“æ„å’Œåº•å±‚åŸç†"></a>6.3 ä»‹ç»Setæ•°æ®ç»“æ„å’Œåº•å±‚åŸç†</h4><p><a href="#26-set%E7%B1%BB%E5%9E%8B">è·³è½¬åˆ°Setæ•°æ®ç»“æ„</a></p>
<p><a href="#27-sortedset%E7%B1%BB%E5%9E%8B">è·³è½¬åˆ°ZSetæ•°æ®ç»“æ„</a></p>
<p><a href="#110-redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-set">è·³è½¬åˆ°Setæ•°æ®ç»“æ„åº•å±‚åŸç†</a></p>
<p><a href="#111-redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-zset">è·³è½¬åˆ°ZSetæ•°æ®ç»“æ„åº•å±‚åŸç†</a></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/JAVA/" class="category-chain-item">JAVA</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="print-no-link">#å­¦ä¹ </a>
      
        <a href="/tags/JAVA/" class="print-no-link">#JAVA</a>
      
        <a href="/tags/Redis/" class="print-no-link">#Redis</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/12/JAVA/JUC/" title="JUCå¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JUCå¹¶å‘ç¼–ç¨‹å­¦ä¹ ç¬”è®°</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/04/JAVA/SpringCloud/SpringCloud/" title="SpringCloudå­¦ä¹ ç¬”è®°">
                        <span class="hidden-mobile">SpringCloudå­¦ä¹ ç¬”è®°</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"sj2tGuxMGSDhkN5hNuOIVta1-gzGzoHsz","appKey":"ysR5OTuTzoby2oNvNyGOtXFQ","path":"window.location.pathname","placeholder":"å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>AI</span> <i class="iconfont icon-love"></i> <span>CPP</span> <i class="iconfont icon-love"></i> <span>JAVA</span> <i class="iconfont icon-love"></i> <span>CyberSec</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>
<script src="/js/bubble.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
</body>
</html>
