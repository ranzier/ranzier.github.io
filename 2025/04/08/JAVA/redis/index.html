

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/about/dogs.jpg">
  <link rel="icon" href="/img/about/dogs.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ranzier">
  <meta name="keywords" content="">
  
    <meta name="description" content="RedisÂ≠¶‰π†Á¨îËÆ∞   ‰∏Ä. RedisÂø´ÈÄüÂÖ•Èó®1. ÂàùËØÜRedis RedisÊòØ‰∏ÄÁßçÈîÆÂÄºÂûãÁöÑNoSqlÊï∞ÊçÆÂ∫ì ÂÖ®Áß∞ÊòØRemote  Dictionary Server ËøúÁ®ãËØçÂÖ∏ÊúçÂä°Âô®ÔºåÊòØ‰∏Ä‰∏™Âü∫‰∫éÂÜÖÂ≠òÁöÑÈîÆÂÄºÂûãNoSQLÊï∞ÊçÆÂ∫ì„ÄÇ  ÁâπÂæÅÔºö  ÈîÆÂÄºÔºàkey-valueÔºâÂûãÔºåvalueÊîØÊåÅÂ§öÁßç‰∏çÂêåÊï∞ÊçÆÁªìÊûÑÔºåÂäüËÉΩ‰∏∞ÂØå ÂçïÁ∫øÁ®ãÔºåÊØè‰∏™ÂëΩ‰ª§ÂÖ∑Â§áÂéüÂ≠êÊÄß ‰ΩéÂª∂ËøüÔºåÈÄüÂ∫¶Âø´ÔºàÂü∫‰∫éÂÜÖÂ≠ò„ÄÅIOÂ§öË∑ØÂ§çÁî®„ÄÅËâØÂ•ΩÁöÑÁºñÁ†ÅÔºâ„ÄÇ ÊîØÊåÅ">
<meta property="og:type" content="article">
<meta property="og:title" content="RedisÂ≠¶‰π†Á¨îËÆ∞ÂèäÈù¢ËØïÈóÆÈ¢òÂàÜÊûê">
<meta property="og:url" content="http://example.com/2025/04/08/JAVA/redis/index.html">
<meta property="og:site_name" content="RANZIER">
<meta property="og:description" content="RedisÂ≠¶‰π†Á¨îËÆ∞   ‰∏Ä. RedisÂø´ÈÄüÂÖ•Èó®1. ÂàùËØÜRedis RedisÊòØ‰∏ÄÁßçÈîÆÂÄºÂûãÁöÑNoSqlÊï∞ÊçÆÂ∫ì ÂÖ®Áß∞ÊòØRemote  Dictionary Server ËøúÁ®ãËØçÂÖ∏ÊúçÂä°Âô®ÔºåÊòØ‰∏Ä‰∏™Âü∫‰∫éÂÜÖÂ≠òÁöÑÈîÆÂÄºÂûãNoSQLÊï∞ÊçÆÂ∫ì„ÄÇ  ÁâπÂæÅÔºö  ÈîÆÂÄºÔºàkey-valueÔºâÂûãÔºåvalueÊîØÊåÅÂ§öÁßç‰∏çÂêåÊï∞ÊçÆÁªìÊûÑÔºåÂäüËÉΩ‰∏∞ÂØå ÂçïÁ∫øÁ®ãÔºåÊØè‰∏™ÂëΩ‰ª§ÂÖ∑Â§áÂéüÂ≠êÊÄß ‰ΩéÂª∂ËøüÔºåÈÄüÂ∫¶Âø´ÔºàÂü∫‰∫éÂÜÖÂ≠ò„ÄÅIOÂ§öË∑ØÂ§çÁî®„ÄÅËâØÂ•ΩÁöÑÁºñÁ†ÅÔºâ„ÄÇ ÊîØÊåÅ">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg/33.jpg">
<meta property="article:published_time" content="2025-04-08T12:33:09.000Z">
<meta property="article:modified_time" content="2025-10-14T06:51:04.608Z">
<meta property="article:author" content="ranzier">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Â≠¶‰π†">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/bg/33.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>RedisÂ≠¶‰π†Á¨îËÆ∞ÂèäÈù¢ËØïÈóÆÈ¢òÂàÜÊûê - RANZIER</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ‰∏ªÈ¢ò‰æùËµñÁöÑÂõæÊ†áÂ∫ìÔºå‰∏çË¶ÅËá™Ë°å‰øÆÊîπ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">
<link rel="stylesheet" href="/css/bubble.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"üåü","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RANZIER</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>È¶ñÈ°µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>ÂΩíÊ°£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>ÂàÜÁ±ª</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Ê†áÁ≠æ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>ÂÖ≥‰∫é</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.35)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="RedisÂ≠¶‰π†Á¨îËÆ∞ÂèäÈù¢ËØïÈóÆÈ¢òÂàÜÊûê"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-08 20:33" pubdate>
          2025Âπ¥4Êúà8Êó• Êôö‰∏ä
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          46k Â≠ó
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          231 ÂàÜÈíü
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          Êú¨ÊñáÈòÖËØªÊ¨°Êï∞Ôºö<span id="busuanzi_value_page_pv"></span> Ê¨°
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">RedisÂ≠¶‰π†Á¨îËÆ∞ÂèäÈù¢ËØïÈóÆÈ¢òÂàÜÊûê</h1>
            
            
              <div class="markdown-body">
                
                <h1 align="center">RedisÂ≠¶‰π†Á¨îËÆ∞</h1>


<h1 id="‰∏Ä-RedisÂø´ÈÄüÂÖ•Èó®"><a href="#‰∏Ä-RedisÂø´ÈÄüÂÖ•Èó®" class="headerlink" title="‰∏Ä. RedisÂø´ÈÄüÂÖ•Èó®"></a>‰∏Ä. RedisÂø´ÈÄüÂÖ•Èó®</h1><h2 id="1-ÂàùËØÜRedis"><a href="#1-ÂàùËØÜRedis" class="headerlink" title="1. ÂàùËØÜRedis"></a>1. ÂàùËØÜRedis</h2><ul>
<li>RedisÊòØ‰∏ÄÁßç<strong>ÈîÆÂÄºÂûã</strong>ÁöÑ<strong>NoSqlÊï∞ÊçÆÂ∫ì</strong></li>
<li>ÂÖ®Áß∞ÊòØ<strong>Re</strong>mote  <strong>D</strong>ictionary <strong>S</strong>erver ËøúÁ®ãËØçÂÖ∏ÊúçÂä°Âô®ÔºåÊòØ‰∏Ä‰∏™Âü∫‰∫éÂÜÖÂ≠òÁöÑÈîÆÂÄºÂûãNoSQLÊï∞ÊçÆÂ∫ì„ÄÇ</li>
</ul>
<p><strong>ÁâπÂæÅ</strong>Ôºö</p>
<ul>
<li>ÈîÆÂÄºÔºàkey-valueÔºâÂûãÔºåvalueÊîØÊåÅÂ§öÁßç‰∏çÂêåÊï∞ÊçÆÁªìÊûÑÔºåÂäüËÉΩ‰∏∞ÂØå</li>
<li>ÂçïÁ∫øÁ®ãÔºåÊØè‰∏™ÂëΩ‰ª§ÂÖ∑Â§áÂéüÂ≠êÊÄß</li>
<li>‰ΩéÂª∂ËøüÔºåÈÄüÂ∫¶Âø´ÔºàÂü∫‰∫éÂÜÖÂ≠ò„ÄÅIOÂ§öË∑ØÂ§çÁî®„ÄÅËâØÂ•ΩÁöÑÁºñÁ†ÅÔºâ„ÄÇ</li>
<li>ÊîØÊåÅÊï∞ÊçÆÊåÅ‰πÖÂåñ</li>
<li>ÊîØÊåÅ‰∏ª‰ªéÈõÜÁæ§„ÄÅÂàÜÁâáÈõÜÁæ§</li>
<li>ÊîØÊåÅÂ§öËØ≠Ë®ÄÂÆ¢Êà∑Á´Ø</li>
</ul>
<h2 id="2-RedisÂ∏∏ËßÅÂëΩ‰ª§"><a href="#2-RedisÂ∏∏ËßÅÂëΩ‰ª§" class="headerlink" title="2. RedisÂ∏∏ËßÅÂëΩ‰ª§"></a>2. RedisÂ∏∏ËßÅÂëΩ‰ª§</h2><p>RedisÊòØÂÖ∏ÂûãÁöÑkey-valueÊï∞ÊçÆÂ∫ìÔºåkey‰∏ÄËà¨ÊòØÂ≠óÁ¨¶‰∏≤ÔºåËÄåvalueÂåÖÂê´ÂæàÂ§ö‰∏çÂêåÁöÑÊï∞ÊçÆÁ±ªÂûã</p>
<p><img src="/img/blogs/java/redis/1.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-1-RedisÈÄöÁî®ÂëΩ‰ª§"><a href="#2-1-RedisÈÄöÁî®ÂëΩ‰ª§" class="headerlink" title="2.1 RedisÈÄöÁî®ÂëΩ‰ª§"></a>2.1 RedisÈÄöÁî®ÂëΩ‰ª§</h3><p>ÈÉΩÂèØ‰ª•‰ΩøÁî®ÁöÑÊåá‰ª§ÔºåÂ∏∏ËßÅÁöÑÊúâÔºö</p>
<ul>
<li>KEYSÔºöÊü•ÁúãÁ¨¶ÂêàÊ®°ÊùøÁöÑÊâÄÊúâkey</li>
<li>DELÔºöÂà†Èô§‰∏Ä‰∏™ÊåáÂÆöÁöÑkey</li>
<li>EXISTSÔºöÂà§Êñ≠keyÊòØÂê¶Â≠òÂú®</li>
<li>EXPIREÔºöÁªô‰∏Ä‰∏™key<strong>ËÆæÁΩÆÊúâÊïàÊúü</strong>ÔºåÊúâÊïàÊúüÂà∞ÊúüÊó∂ËØ•key‰ºöË¢´Ëá™Âä®Âà†Èô§</li>
<li>TTLÔºöÊü•Áúã‰∏Ä‰∏™KEYÁöÑ<strong>Ââ©‰ΩôÊúâÊïàÊúü</strong></li>
</ul>
<h3 id="2-2-StringÁ±ªÂûã"><a href="#2-2-StringÁ±ªÂûã" class="headerlink" title="2.2 StringÁ±ªÂûã"></a>2.2 StringÁ±ªÂûã</h3><p>ÂÖ∂valueÊòØÂ≠óÁ¨¶‰∏≤Ôºå‰∏çËøáÊ†πÊçÆÂ≠óÁ¨¶‰∏≤ÁöÑÊ†ºÂºè‰∏çÂêåÔºåÂèàÂèØ‰ª•ÂàÜ‰∏∫3Á±ª:</p>
<ul>
<li>stringÔºöÊôÆÈÄöÂ≠óÁ¨¶‰∏≤</li>
<li>intÔºöÊï¥Êï∞Á±ªÂûãÔºåÂèØ‰ª•ÂÅöËá™Â¢û„ÄÅËá™ÂáèÊìç‰Ωú</li>
<li>floatÔºöÊµÆÁÇπÁ±ªÂûãÔºåÂèØ‰ª•ÂÅöËá™Â¢û„ÄÅËá™ÂáèÊìç‰Ωú</li>
</ul>
<p><strong>StringÁöÑÂ∏∏ËßÅÂëΩ‰ª§Êúâ</strong>Ôºö</p>
<ul>
<li>SETÔºöÊ∑ªÂä†ÊàñËÄÖ‰øÆÊîπÂ∑≤ÁªèÂ≠òÂú®ÁöÑ‰∏Ä‰∏™StringÁ±ªÂûãÁöÑÈîÆÂÄºÂØπ</li>
<li>GETÔºöÊ†πÊçÆkeyËé∑ÂèñStringÁ±ªÂûãÁöÑvalue</li>
<li>MSETÔºöÊâπÈáèÊ∑ªÂä†Â§ö‰∏™StringÁ±ªÂûãÁöÑÈîÆÂÄºÂØπ</li>
<li>MGETÔºöÊ†πÊçÆÂ§ö‰∏™keyËé∑ÂèñÂ§ö‰∏™StringÁ±ªÂûãÁöÑvalue</li>
<li>INCRÔºöËÆ©‰∏Ä‰∏™Êï¥ÂûãÁöÑkeyËá™Â¢û1</li>
<li>INCRBY:ËÆ©‰∏Ä‰∏™Êï¥ÂûãÁöÑkeyËá™Â¢ûÂπ∂ÊåáÂÆöÊ≠•ÈïøÔºå‰æãÂ¶ÇÔºöincrby num 2 ËÆ©numÂÄºËá™Â¢û2</li>
<li>INCRBYFLOATÔºöËÆ©‰∏Ä‰∏™ÊµÆÁÇπÁ±ªÂûãÁöÑÊï∞Â≠óËá™Â¢ûÂπ∂ÊåáÂÆöÊ≠•Èïø</li>
<li>SETNXÔºöÊ∑ªÂä†‰∏Ä‰∏™StringÁ±ªÂûãÁöÑÈîÆÂÄºÂØπÔºåÂâçÊèêÊòØËøô‰∏™key‰∏çÂ≠òÂú®ÔºåÂê¶Âàô‰∏çÊâßË°å</li>
<li>SETEXÔºöÊ∑ªÂä†‰∏Ä‰∏™StringÁ±ªÂûãÁöÑÈîÆÂÄºÂØπÔºåÂπ∂‰∏îÊåáÂÆöÊúâÊïàÊúü</li>
</ul>
<h3 id="2-3-KeyÁªìÊûÑ"><a href="#2-3-KeyÁªìÊûÑ" class="headerlink" title="2.3 KeyÁªìÊûÑ"></a>2.3 KeyÁªìÊûÑ</h3><p>ÈÄöËøáÁªôkeyÊ∑ªÂä†ÂâçÁºÄÂä†‰ª•Âå∫ÂàÜ,RedisÁöÑkeyÂÖÅËÆ∏ÊúâÂ§ö‰∏™ÂçïËØçÂΩ¢Êàê<strong>Â±ÇÁ∫ßÁªìÊûÑ</strong>ÔºåÂ§ö‰∏™ÂçïËØç‰πãÈó¥Áî®‚Äô:‚ÄôÈöîÂºÄÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">È°πÁõÆÂêç:‰∏öÂä°Âêç:Á±ªÂûã:<span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure>

<p>‰æãÂ¶ÇÊàë‰ª¨ÁöÑÈ°πÁõÆÂêçÁß∞Âè´ heimaÔºåÊúâuserÂíåproduct‰∏§Áßç‰∏çÂêåÁ±ªÂûãÁöÑÊï∞ÊçÆÔºåÊàë‰ª¨ÂèØ‰ª•ËøôÊ†∑ÂÆö‰πâkeyÔºö</p>
<ul>
<li>userÁõ∏ÂÖ≥ÁöÑkeyÔºö<strong>heima:user:1</strong></li>
<li>productÁõ∏ÂÖ≥ÁöÑkeyÔºö<strong>heima:product:1</strong></li>
</ul>
<h3 id="2-4-HashÁ±ªÂûã"><a href="#2-4-HashÁ±ªÂûã" class="headerlink" title="2.4 HashÁ±ªÂûã"></a>2.4 HashÁ±ªÂûã</h3><p>HashÁ±ªÂûãÔºå‰πüÂè´Êï£ÂàóÔºåÂÖ∂valueÊòØ‰∏Ä‰∏™Êó†Â∫èÂ≠óÂÖ∏ÔºåÁ±ª‰ºº‰∫éJava‰∏≠ÁöÑHashMapÁªìÊûÑ„ÄÇ</p>
<p><img src="/img/blogs/java/redis/1.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>HashÁöÑÂ∏∏ËßÅÂëΩ‰ª§Êúâ</strong>Ôºö</p>
<ul>
<li>HSET key field valueÔºöÊ∑ªÂä†ÊàñËÄÖ‰øÆÊîπhashÁ±ªÂûãkeyÁöÑfieldÁöÑÂÄº</li>
<li>HGET key fieldÔºöËé∑Âèñ‰∏Ä‰∏™hashÁ±ªÂûãkeyÁöÑfieldÁöÑÂÄº</li>
<li>HMSETÔºöÊâπÈáèÊ∑ªÂä†Â§ö‰∏™hashÁ±ªÂûãkeyÁöÑfieldÁöÑÂÄº</li>
<li>HMGETÔºöÊâπÈáèËé∑ÂèñÂ§ö‰∏™hashÁ±ªÂûãkeyÁöÑfieldÁöÑÂÄº</li>
<li>HGETALLÔºöËé∑Âèñ‰∏Ä‰∏™hashÁ±ªÂûãÁöÑkey‰∏≠ÁöÑÊâÄÊúâÁöÑfieldÂíåvalue</li>
<li>HKEYSÔºöËé∑Âèñ‰∏Ä‰∏™hashÁ±ªÂûãÁöÑkey‰∏≠ÁöÑÊâÄÊúâÁöÑfield</li>
<li>HINCRBY:ËÆ©‰∏Ä‰∏™hashÁ±ªÂûãkeyÁöÑÂ≠óÊÆµÂÄºËá™Â¢ûÂπ∂ÊåáÂÆöÊ≠•Èïø</li>
<li>HSETNXÔºöÊ∑ªÂä†‰∏Ä‰∏™hashÁ±ªÂûãÁöÑkeyÁöÑfieldÂÄºÔºåÂâçÊèêÊòØËøô‰∏™field‰∏çÂ≠òÂú®ÔºåÂê¶Âàô‰∏çÊâßË°å</li>
</ul>
<h3 id="2-5-ListÁ±ªÂûã"><a href="#2-5-ListÁ±ªÂûã" class="headerlink" title="2.5 ListÁ±ªÂûã"></a>2.5 ListÁ±ªÂûã</h3><p>Redis‰∏≠ÁöÑListÁ±ªÂûã‰∏éJava‰∏≠ÁöÑ<strong>LinkedList</strong>Á±ª‰ººÔºåÂèØ‰ª•ÁúãÂÅöÊòØ‰∏Ä‰∏™<strong>ÂèåÂêëÈìæË°®</strong>ÁªìÊûÑ„ÄÇÊó¢ÂèØ‰ª•ÊîØÊåÅÊ≠£ÂêëÊ£ÄÁ¥¢Âíå‰πüÂèØ‰ª•ÊîØÊåÅÂèçÂêëÊ£ÄÁ¥¢</p>
<p>ÁâπÂæÅ‰πü‰∏éLinkedListÁ±ª‰ººÔºö</p>
<ul>
<li>ÊúâÂ∫è</li>
<li>ÂÖÉÁ¥†ÂèØ‰ª•ÈáçÂ§ç</li>
<li>ÊèíÂÖ•ÂíåÂà†Èô§Âø´</li>
<li>Êü•ËØ¢ÈÄüÂ∫¶‰∏ÄËà¨</li>
</ul>
<p>Â∏∏Áî®Êù•Â≠òÂÇ®‰∏Ä‰∏™ÊúâÂ∫èÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºöÊúãÂèãÂúàÁÇπËµûÂàóË°®ÔºåËØÑËÆ∫ÂàóË°®Á≠â„ÄÇ</p>
<p>ListÁöÑÂ∏∏ËßÅÂëΩ‰ª§ÊúâÔºö</p>
<ul>
<li>LPUSH key element ‚Ä¶ ÔºöÂêëÂàóË°®Â∑¶‰æßÊèíÂÖ•‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂÖÉÁ¥†</li>
<li>LPOP keyÔºöÁßªÈô§Âπ∂ËøîÂõûÂàóË°®Â∑¶‰æßÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÔºåÊ≤°ÊúâÂàôËøîÂõûnil</li>
<li>RPUSH key element ‚Ä¶ ÔºöÂêëÂàóË°®Âè≥‰æßÊèíÂÖ•‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂÖÉÁ¥†</li>
<li>RPOP keyÔºöÁßªÈô§Âπ∂ËøîÂõûÂàóË°®Âè≥‰æßÁöÑÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†</li>
<li>LRANGE key star endÔºöËøîÂõû‰∏ÄÊÆµËßíÊ†áËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÂÖÉÁ¥†</li>
<li>BLPOPÂíåBRPOPÔºö‰∏éLPOPÂíåRPOPÁ±ª‰ººÔºåÂè™‰∏çËøáÂú®Ê≤°ÊúâÂÖÉÁ¥†Êó∂Á≠âÂæÖÊåáÂÆöÊó∂Èó¥ÔºåËÄå‰∏çÊòØÁõ¥Êé•ËøîÂõûnil</li>
</ul>
<h3 id="2-6-SetÁ±ªÂûã"><a href="#2-6-SetÁ±ªÂûã" class="headerlink" title="2.6 SetÁ±ªÂûã"></a>2.6 SetÁ±ªÂûã</h3><p>RedisÁöÑSetÁªìÊûÑ‰∏éJava‰∏≠ÁöÑHashSetÁ±ª‰ººÔºåÂèØ‰ª•ÁúãÂÅöÊòØ‰∏Ä‰∏™value‰∏∫nullÁöÑHashMap</p>
<p>SetÁöÑÂ∏∏ËßÅÂëΩ‰ª§ÊúâÔºö</p>
<ul>
<li>SADD key member ‚Ä¶ ÔºöÂêëset‰∏≠Ê∑ªÂä†‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂÖÉÁ¥†</li>
<li>SREM key member ‚Ä¶ : ÁßªÈô§set‰∏≠ÁöÑÊåáÂÆöÂÖÉÁ¥†</li>
<li>SCARD keyÔºö ËøîÂõûset‰∏≠ÂÖÉÁ¥†ÁöÑ‰∏™Êï∞</li>
<li>SISMEMBER key memberÔºöÂà§Êñ≠‰∏Ä‰∏™ÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®‰∫éset‰∏≠</li>
<li>SMEMBERSÔºöËé∑Âèñset‰∏≠ÁöÑÊâÄÊúâÂÖÉÁ¥†</li>
<li>SINTER key1 key2 ‚Ä¶ ÔºöÊ±Çkey1‰∏ékey2ÁöÑ‰∫§ÈõÜ</li>
</ul>
<h3 id="2-7-SortedSetÁ±ªÂûã"><a href="#2-7-SortedSetÁ±ªÂûã" class="headerlink" title="2.7 SortedSetÁ±ªÂûã"></a>2.7 SortedSetÁ±ªÂûã</h3><p>RedisÁöÑSortedSetÊòØ‰∏Ä‰∏™ÂèØÊéíÂ∫èÁöÑsetÈõÜÂêà</p>
<p>SortedSetÂÖ∑Â§á‰∏ãÂàóÁâπÊÄßÔºö</p>
<ul>
<li>ÂèØÊéíÂ∫è</li>
<li>ÂÖÉÁ¥†‰∏çÈáçÂ§ç</li>
<li>Êü•ËØ¢ÈÄüÂ∫¶Âø´</li>
</ul>
<p>Âõ†‰∏∫SortedSetÁöÑ<strong>ÂèØÊéíÂ∫èÁâπÊÄß</strong>ÔºåÁªèÂ∏∏Ë¢´Áî®Êù•ÂÆûÁé∞ÊéíË°åÊ¶úËøôÊ†∑ÁöÑÂäüËÉΩ„ÄÇ</p>
<p>SortedSetÁöÑÂ∏∏ËßÅÂëΩ‰ª§ÊúâÔºö</p>
<ul>
<li>ZADD key score memberÔºöÊ∑ªÂä†‰∏Ä‰∏™ÊàñÂ§ö‰∏™ÂÖÉÁ¥†Âà∞sorted set ÔºåÂ¶ÇÊûúÂ∑≤ÁªèÂ≠òÂú®ÂàôÊõ¥Êñ∞ÂÖ∂scoreÂÄº</li>
<li>ZREM key memberÔºöÂà†Èô§sorted set‰∏≠ÁöÑ‰∏Ä‰∏™ÊåáÂÆöÂÖÉÁ¥†</li>
<li>ZSCORE key member : Ëé∑Âèñsorted set‰∏≠ÁöÑÊåáÂÆöÂÖÉÁ¥†ÁöÑscoreÂÄº</li>
<li>ZRANK key memberÔºöËé∑Âèñsorted set ‰∏≠ÁöÑÊåáÂÆöÂÖÉÁ¥†ÁöÑÊéíÂêç</li>
<li>ZCARD keyÔºöËé∑Âèñsorted set‰∏≠ÁöÑÂÖÉÁ¥†‰∏™Êï∞</li>
<li>ZCOUNT key min maxÔºöÁªüËÆ°scoreÂÄºÂú®ÁªôÂÆöËåÉÂõ¥ÂÜÖÁöÑÊâÄÊúâÂÖÉÁ¥†ÁöÑ‰∏™Êï∞</li>
<li>ZINCRBY key increment memberÔºöËÆ©sorted set‰∏≠ÁöÑÊåáÂÆöÂÖÉÁ¥†Ëá™Â¢ûÔºåÊ≠•Èïø‰∏∫ÊåáÂÆöÁöÑincrementÂÄº</li>
<li>ZRANGE key min maxÔºöÊåâÁÖßscoreÊéíÂ∫èÂêéÔºåËé∑ÂèñÊåáÂÆöÊéíÂêçËåÉÂõ¥ÂÜÖÁöÑÂÖÉÁ¥†</li>
<li>ZRANGEBYSCORE key min maxÔºöÊåâÁÖßscoreÊéíÂ∫èÂêéÔºåËé∑ÂèñÊåáÂÆöscoreËåÉÂõ¥ÂÜÖÁöÑÂÖÉÁ¥†</li>
<li>ZDIFF„ÄÅZINTER„ÄÅZUNIONÔºöÊ±ÇÂ∑ÆÈõÜ„ÄÅ‰∫§ÈõÜ„ÄÅÂπ∂ÈõÜ</li>
</ul>
<p>Ê≥®ÊÑèÔºöÊâÄÊúâÁöÑÊéíÂêçÈªòËÆ§ÈÉΩÊòØÂçáÂ∫èÔºåÂ¶ÇÊûúË¶ÅÈôçÂ∫èÂàôÂú®ÂëΩ‰ª§ÁöÑZÂêéÈù¢Ê∑ªÂä†REVÂç≥ÂèØ</p>
<h2 id="3-RedisÁöÑJavaÂÆ¢Êà∑Á´Ø"><a href="#3-RedisÁöÑJavaÂÆ¢Êà∑Á´Ø" class="headerlink" title="3. RedisÁöÑJavaÂÆ¢Êà∑Á´Ø"></a>3. RedisÁöÑJavaÂÆ¢Êà∑Á´Ø</h2><ul>
<li>JedisÂíåLettuceÔºöËøô‰∏§‰∏™‰∏ªË¶ÅÊòØÊèê‰æõ‰∫ÜRedisÂëΩ‰ª§ÂØπÂ∫îÁöÑAPIÔºåÊñπ‰æøÊàë‰ª¨Êìç‰ΩúRedisÔºåËÄåSpringDataRedisÂèàÂØπËøô‰∏§ÁßçÂÅö‰∫ÜÊäΩË±°ÂíåÂ∞ÅË£ÖÔºåÂõ†Ê≠§Êàë‰ª¨ÂêéÊúü‰ºöÁõ¥Êé•‰ª•SpringDataRedisÊù•Â≠¶‰π†„ÄÇ</li>
<li>RedissonÔºöÊòØÂú®RedisÂü∫Á°Ä‰∏äÂÆûÁé∞‰∫ÜÂàÜÂ∏ÉÂºèÁöÑÂèØ‰º∏Áº©ÁöÑjavaÊï∞ÊçÆÁªìÊûÑÔºå‰æãÂ¶ÇMap„ÄÅQueueÁ≠âÔºåËÄå‰∏îÊîØÊåÅË∑®ËøõÁ®ãÁöÑÂêåÊ≠•Êú∫Âà∂ÔºöLock„ÄÅSemaphoreÁ≠âÂæÖÔºåÊØîËæÉÈÄÇÂêàÁî®Êù•ÂÆûÁé∞ÁâπÊÆäÁöÑÂäüËÉΩÈúÄÊ±Ç„ÄÇ</li>
</ul>
<h3 id="3-1-JedisÂÆ¢Êà∑Á´Ø"><a href="#3-1-JedisÂÆ¢Êà∑Á´Ø" class="headerlink" title="3.1 JedisÂÆ¢Êà∑Á´Ø"></a>3.1 JedisÂÆ¢Êà∑Á´Ø</h3><h4 id="3-1-1-Âø´ÈÄüÂÖ•Èó®"><a href="#3-1-1-Âø´ÈÄüÂÖ•Èó®" class="headerlink" title="3.1.1 Âø´ÈÄüÂÖ•Èó®"></a>3.1.1 Âø´ÈÄüÂÖ•Èó®</h4><ol>
<li>ÂºïÂÖ•‰æùËµñÔºö</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--jedis--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>Âª∫Á´ãËøûÊé•<br>Êñ∞Âª∫‰∏Ä‰∏™ÂçïÂÖÉÊµãËØïÁ±ªÔºåÂÜÖÂÆπÂ¶Ç‰∏ãÔºö</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Jedis jedis;<br><br><span class="hljs-meta">@BeforeEach</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.Âª∫Á´ãËøûÊé•</span><br>    <span class="hljs-comment">// jedis = new Jedis(&quot;192.168.150.101&quot;, 6379);</span><br>    jedis = JedisConnectionFactory.getJedis();<br>    <span class="hljs-comment">// 2.ËÆæÁΩÆÂØÜÁ†Å</span><br>    jedis.auth(<span class="hljs-string">&quot;123321&quot;</span>);<br>    <span class="hljs-comment">// 3.ÈÄâÊã©Â∫ì</span><br>    jedis.select(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ÊµãËØïÔºö</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Â≠òÂÖ•Êï∞ÊçÆ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;ËôéÂì•&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;result = &quot;</span> + result);<br>    <span class="hljs-comment">// Ëé∑ÂèñÊï∞ÊçÆ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> jedis.get(<span class="hljs-string">&quot;name&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;name = &quot;</span> + name);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ÈáäÊîæËµÑÊ∫ê</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AfterEach</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">tearDown</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (jedis != <span class="hljs-literal">null</span>) &#123;<br>        jedis.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-ËøûÊé•Ê±†"><a href="#3-1-2-ËøûÊé•Ê±†" class="headerlink" title="3.1.2 ËøûÊé•Ê±†"></a>3.1.2 ËøûÊé•Ê±†</h4><p>JedisÊú¨Ë∫´ÊòØÁ∫øÁ®ã‰∏çÂÆâÂÖ®ÁöÑÔºåÂπ∂‰∏îÈ¢ëÁπÅÁöÑÂàõÂª∫ÂíåÈîÄÊØÅËøûÊé•‰ºöÊúâÊÄßËÉΩÊçüËÄóÔºåÂõ†Ê≠§Êàë‰ª¨<strong>‰ΩøÁî®JedisËøûÊé•Ê±†‰ª£ÊõøJedisÁöÑÁõ¥ËøûÊñπÂºè</strong>„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JedisConnectionFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> JedisPool jedisPool;<br><br>    <span class="hljs-keyword">static</span> &#123;<br>        <span class="hljs-comment">// ÈÖçÁΩÆËøûÊé•Ê±†</span><br>        <span class="hljs-type">JedisPoolConfig</span> <span class="hljs-variable">poolConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPoolConfig</span>();<br>        poolConfig.setMaxTotal(<span class="hljs-number">8</span>);<br>        poolConfig.setMaxIdle(<span class="hljs-number">8</span>);<br>        poolConfig.setMinIdle(<span class="hljs-number">0</span>);<br>        poolConfig.setMaxWaitMillis(<span class="hljs-number">1000</span>);<br>        <span class="hljs-comment">// ÂàõÂª∫ËøûÊé•Ê±†ÂØπË±°ÔºåÂèÇÊï∞ÔºöËøûÊé•Ê±†ÈÖçÁΩÆ„ÄÅÊúçÂä°Á´Øip„ÄÅÊúçÂä°Á´ØÁ´ØÂè£„ÄÅË∂ÖÊó∂Êó∂Èó¥„ÄÅÂØÜÁ†Å</span><br>        jedisPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JedisPool</span>(poolConfig, <span class="hljs-string">&quot;192.168.150.101&quot;</span>, <span class="hljs-number">6379</span>, <span class="hljs-number">1000</span>, <span class="hljs-string">&quot;123321&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Jedis <span class="hljs-title function_">getJedis</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> jedisPool.getResource();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-SpringDataRedisÂÆ¢Êà∑Á´Ø"><a href="#3-2-SpringDataRedisÂÆ¢Êà∑Á´Ø" class="headerlink" title="3.2 SpringDataRedisÂÆ¢Êà∑Á´Ø"></a>3.2 SpringDataRedisÂÆ¢Êà∑Á´Ø</h3><p>SpringDataÊòØSpring‰∏≠Êï∞ÊçÆÊìç‰ΩúÁöÑÊ®°ÂùóÔºåÂåÖÂê´ÂØπÂêÑÁßçÊï∞ÊçÆÂ∫ìÁöÑÈõÜÊàêÔºåÂÖ∂‰∏≠<strong>ÂØπRedisÁöÑÈõÜÊàêÊ®°ÂùóÂ∞±Âè´ÂÅöSpringDataRedis</strong></p>
<ul>
<li>Êèê‰æõ‰∫Ü<strong>ÂØπ‰∏çÂêåRedisÂÆ¢Êà∑Á´ØÁöÑÊï¥ÂêàÔºàLettuceÂíåJedisÔºâ</strong></li>
<li>Êèê‰æõ‰∫ÜRedisTemplateÁªü‰∏ÄAPIÊù•Êìç‰ΩúRedis</li>
<li>ÊîØÊåÅRedisÁöÑÂèëÂ∏ÉËÆ¢ÈòÖÊ®°Âûã</li>
<li>ÊîØÊåÅRedisÂì®ÂÖµÂíåRedisÈõÜÁæ§</li>
<li>ÊîØÊåÅÂü∫‰∫éLettuceÁöÑÂìçÂ∫îÂºèÁºñÁ®ã</li>
<li>ÊîØÊåÅÂü∫‰∫éJDK„ÄÅJSON„ÄÅÂ≠óÁ¨¶‰∏≤„ÄÅSpringÂØπË±°ÁöÑÊï∞ÊçÆÂ∫èÂàóÂåñÂèäÂèçÂ∫èÂàóÂåñ</li>
<li>ÊîØÊåÅÂü∫‰∫éRedisÁöÑJDKCollectionÂÆûÁé∞</li>
</ul>
<p>SpringDataRedis‰∏≠Êèê‰æõ‰∫ÜRedisTemplateÂ∑•ÂÖ∑Á±ªÔºåÂÖ∂‰∏≠Â∞ÅË£Ö‰∫ÜÂêÑÁßçÂØπRedisÁöÑÊìç‰Ωú„ÄÇÂπ∂‰∏îÂ∞Ü‰∏çÂêåÊï∞ÊçÆÁ±ªÂûãÁöÑÊìç‰ΩúAPIÂ∞ÅË£ÖÂà∞‰∫Ü‰∏çÂêåÁöÑÁ±ªÂûã‰∏≠Ôºö</p>
<p><img src="/img/blogs/java/redis/1.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-1-Âø´ÈÄüÂÖ•Èó®"><a href="#3-2-1-Âø´ÈÄüÂÖ•Èó®" class="headerlink" title="3.2.1 Âø´ÈÄüÂÖ•Èó®"></a>3.2.1 Âø´ÈÄüÂÖ•Èó®</h4><ol>
<li>ÂºïÂÖ•‰æùËµñ</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--redis‰æùËµñ--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-comment">&lt;!--common-pool--&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-pool2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>ÈÖçÁΩÆRedis</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123321</span><br>    <span class="hljs-attr">lettuce:</span><br>      <span class="hljs-attr">pool:</span><br>        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span><br>        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">0</span><br>        <span class="hljs-attr">max-wait:</span> <span class="hljs-string">100ms</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>Ê≥®ÂÖ•RedisTemplate</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStringTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ÁºñÂÜôÊµãËØï</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisStringTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate edisTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// ÂÜôÂÖ•‰∏ÄÊù°StringÊï∞ÊçÆ</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;ËôéÂì•&quot;</span>);<br>        <span class="hljs-comment">// Ëé∑ÂèñstringÊï∞ÊçÆ</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;name&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;name = &quot;</span> + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-Ëá™ÂÆö‰πâÂ∫èÂàóÂåñ"><a href="#3-2-2-Ëá™ÂÆö‰πâÂ∫èÂàóÂåñ" class="headerlink" title="3.2.2 Ëá™ÂÆö‰πâÂ∫èÂàóÂåñ"></a>3.2.2 Ëá™ÂÆö‰πâÂ∫èÂàóÂåñ</h4><p>RedisTemplateÂèØ‰ª•Êé•Êî∂‰ªªÊÑèObject‰Ωú‰∏∫ÂÄºÂÜôÂÖ•RedisÔºö<br>Âè™‰∏çËøáÂÜôÂÖ•Ââç‰ºöÊääObjectÂ∫èÂàóÂåñ‰∏∫Â≠óËäÇÂΩ¢ÂºèÔºåÈªòËÆ§ÊòØÈááÁî®JDKÂ∫èÂàóÂåñÔºåÂæóÂà∞ÁöÑÁªìÊûúÊòØÂ∫èÂàóÂåñ‰πãÂêéÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÂèØËØªÊÄßÂ∑ÆÔºåÂÜÖÂ≠òÂç†Áî®ËæÉÂ§ß„ÄÇ</p>
<p>Êàë‰ª¨ÂèØ‰ª•Ëá™ÂÆö‰πâRedisTemplateÁöÑÂ∫èÂàóÂåñÊñπÂºèÔºå‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory connectionFactory)</span>&#123;<br>        <span class="hljs-comment">// ÂàõÂª∫RedisTemplateÂØπË±°</span><br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        <span class="hljs-comment">// ËÆæÁΩÆËøûÊé•Â∑•ÂéÇ</span><br>        template.setConnectionFactory(connectionFactory);<br>        <span class="hljs-comment">// ÂàõÂª∫JSONÂ∫èÂàóÂåñÂ∑•ÂÖ∑</span><br>        <span class="hljs-type">GenericJackson2JsonRedisSerializer</span> <span class="hljs-variable">jsonRedisSerializer</span> <span class="hljs-operator">=</span> <br>            							<span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericJackson2JsonRedisSerializer</span>();<br>        <span class="hljs-comment">// ËÆæÁΩÆKeyÁöÑÂ∫èÂàóÂåñ</span><br>        template.setKeySerializer(RedisSerializer.string());<br>        template.setHashKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// ËÆæÁΩÆValueÁöÑÂ∫èÂàóÂåñ</span><br>        template.setValueSerializer(jsonRedisSerializer);<br>        template.setHashValueSerializer(jsonRedisSerializer);<br>        <span class="hljs-comment">// ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-3-StringRedisTemplate"><a href="#3-2-3-StringRedisTemplate" class="headerlink" title="3.2.3 StringRedisTemplate"></a>3.2.3 StringRedisTemplate</h4><p>‰∏∫‰∫ÜËäÇÁúÅÂÜÖÂ≠òÁ©∫Èó¥ÔºåÊàë‰ª¨ÂèØ‰ª•‰∏ç‰ΩøÁî®JSONÂ∫èÂàóÂåñÂô®Êù•Â§ÑÁêÜvalueÔºåËÄåÊòØÁªü‰∏Ä‰ΩøÁî®StringÂ∫èÂàóÂåñÂô®ÔºåË¶ÅÊ±ÇÂè™ËÉΩÂ≠òÂÇ®StringÁ±ªÂûãÁöÑkeyÂíåvalue„ÄÇÂΩìÈúÄË¶ÅÂ≠òÂÇ®JavaÂØπË±°Êó∂ÔºåÊâãÂä®ÂÆåÊàêÂØπË±°ÁöÑÂ∫èÂàóÂåñÂíåÂèçÂ∫èÂàóÂåñ„ÄÇ</p>
<p><img src="/img/blogs/java/redis/1.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p>StringRedisTemplateÔºåÂÆÉÁöÑkeyÂíåvalueÁöÑÂ∫èÂàóÂåñÊñπÂºèÈªòËÆ§Â∞±ÊòØStringÊñπÂºè„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><span class="hljs-comment">// JSONÂ∫èÂàóÂåñÂ∑•ÂÖ∑</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testSaveUser</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> JsonProcessingException &#123;<br>    <span class="hljs-comment">// ÂàõÂª∫ÂØπË±°</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;ËôéÂì•&quot;</span>, <span class="hljs-number">21</span>);<br>    <span class="hljs-comment">// ÊâãÂä®Â∫èÂàóÂåñ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> mapper.writeValueAsString(user);<br>    <span class="hljs-comment">// ÂÜôÂÖ•Êï∞ÊçÆ</span><br>    stringRedisTemplate.opsForValue().set(<span class="hljs-string">&quot;user:200&quot;</span>, json);<br><br>    <span class="hljs-comment">// Ëé∑ÂèñÊï∞ÊçÆ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">jsonUser</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;user:200&quot;</span>);<br>    <span class="hljs-comment">// ÊâãÂä®ÂèçÂ∫èÂàóÂåñ</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> mapper.readValue(jsonUser, User.class);<br>    System.out.println(<span class="hljs-string">&quot;user1 = &quot;</span> + user1);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="‰∫å-ÂÆûÊàòÁØá-ÈªëÈ©¨ÁÇπËØÑ"><a href="#‰∫å-ÂÆûÊàòÁØá-ÈªëÈ©¨ÁÇπËØÑ" class="headerlink" title="‰∫å. ÂÆûÊàòÁØá-ÈªëÈ©¨ÁÇπËØÑ"></a>‰∫å. ÂÆûÊàòÁØá-ÈªëÈ©¨ÁÇπËØÑ</h1><p><img src="/img/blogs/java/redis/2.0.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="1-Áü≠‰ø°ÁôªÂΩï"><a href="#1-Áü≠‰ø°ÁôªÂΩï" class="headerlink" title="1. Áü≠‰ø°ÁôªÂΩï"></a>1. Áü≠‰ø°ÁôªÂΩï</h2><h3 id="1-1-Âü∫‰∫éSessionÂÆûÁé∞ÁôªÂΩïÊµÅÁ®ã"><a href="#1-1-Âü∫‰∫éSessionÂÆûÁé∞ÁôªÂΩïÊµÅÁ®ã" class="headerlink" title="1.1 Âü∫‰∫éSessionÂÆûÁé∞ÁôªÂΩïÊµÅÁ®ã"></a>1.1 Âü∫‰∫éSessionÂÆûÁé∞ÁôªÂΩïÊµÅÁ®ã</h3><p><img src="/img/blogs/java/redis/2.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ÂèëÈÄÅÈ™åËØÅÁ†ÅÔºö</strong></p>
<p>Áî®Êà∑Âú®Êèê‰∫§ÊâãÊú∫Âè∑ÂêéÔºå‰ºöÊ†°È™åÊâãÊú∫Âè∑ÊòØÂê¶ÂêàÊ≥ïÔºåÂ¶ÇÊûú‰∏çÂêàÊ≥ïÔºåÂàôË¶ÅÊ±ÇÁî®Êà∑ÈáçÊñ∞ËæìÂÖ•ÊâãÊú∫Âè∑</p>
<p>Â¶ÇÊûúÊâãÊú∫Âè∑ÂêàÊ≥ïÔºåÂêéÂè∞Ê≠§Êó∂ÁîüÊàêÂØπÂ∫îÁöÑÈ™åËØÅÁ†ÅÔºåÂêåÊó∂Â∞ÜÈ™åËØÅÁ†ÅËøõË°å‰øùÂ≠òÔºåÁÑ∂ÂêéÂÜçÈÄöËøáÁü≠‰ø°ÁöÑÊñπÂºèÂ∞ÜÈ™åËØÅÁ†ÅÂèëÈÄÅÁªôÁî®Êà∑</p>
<p><strong>Áü≠‰ø°È™åËØÅÁ†ÅÁôªÂΩï„ÄÅÊ≥®ÂÜåÔºö</strong></p>
<p>Áî®Êà∑Â∞ÜÈ™åËØÅÁ†ÅÂíåÊâãÊú∫Âè∑ËøõË°åËæìÂÖ•ÔºåÂêéÂè∞‰ªésession‰∏≠ÊãøÂà∞ÂΩìÂâçÈ™åËØÅÁ†ÅÔºåÁÑ∂ÂêéÂíåÁî®Êà∑ËæìÂÖ•ÁöÑÈ™åËØÅÁ†ÅËøõË°åÊ†°È™åÔºåÂ¶ÇÊûú‰∏ç‰∏ÄËá¥ÔºåÂàôÊó†Ê≥ïÈÄöËøáÊ†°È™åÔºåÂ¶ÇÊûú‰∏ÄËá¥ÔºåÂàôÂêéÂè∞Ê†πÊçÆÊâãÊú∫Âè∑Êü•ËØ¢Áî®Êà∑ÔºåÂ¶ÇÊûúÁî®Êà∑‰∏çÂ≠òÂú®ÔºåÂàô‰∏∫Áî®Êà∑ÂàõÂª∫Ë¥¶Âè∑‰ø°ÊÅØÔºå‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÊó†ËÆ∫ÊòØÂê¶Â≠òÂú®ÔºåÈÉΩ‰ºöÂ∞ÜÁî®Êà∑‰ø°ÊÅØ‰øùÂ≠òÂà∞session‰∏≠ÔºåÊñπ‰æøÂêéÁª≠Ëé∑ÂæóÂΩìÂâçÁôªÂΩï‰ø°ÊÅØ</p>
<p><strong>Ê†°È™åÁôªÂΩïÁä∂ÊÄÅ:</strong></p>
<p>Áî®Êà∑Âú®ËØ∑Ê±ÇÊó∂ÂÄôÔºå‰ºö‰ªécookie‰∏≠Êê∫Â∏¶ËÄÖJsessionIdÂà∞ÂêéÂè∞ÔºåÂêéÂè∞ÈÄöËøáJsessionId‰ªésession‰∏≠ÊãøÂà∞Áî®Êà∑‰ø°ÊÅØÔºåÂ¶ÇÊûúÊ≤°Êúâsession‰ø°ÊÅØÔºåÂàôËøõË°åÊã¶Êà™ÔºåÂ¶ÇÊûúÊúâsession‰ø°ÊÅØÔºåÂàôÂ∞ÜÁî®Êà∑‰ø°ÊÅØ‰øùÂ≠òÂà∞threadLocal‰∏≠ÔºåÂπ∂‰∏îÊîæË°å</p>
<h3 id="1-2-ÂÆûÁé∞ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†ÅÂäüËÉΩ"><a href="#1-2-ÂÆûÁé∞ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†ÅÂäüËÉΩ" class="headerlink" title="1.2 ÂÆûÁé∞ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†ÅÂäüËÉΩ"></a>1.2 ÂÆûÁé∞ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†ÅÂäüËÉΩ</h3><ul>
<li><strong>ÂèëÈÄÅÈ™åËØÅÁ†Å</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sendCode</span><span class="hljs-params">(String phone, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.Ê†°È™åÊâãÊú∫Âè∑</span><br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.Â¶ÇÊûú‰∏çÁ¨¶ÂêàÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ÊâãÊú∫Âè∑Ê†ºÂºèÈîôËØØÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.Á¨¶ÂêàÔºåÁîüÊàêÈ™åËØÅÁ†Å</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> RandomUtil.randomNumbers(<span class="hljs-number">6</span>);<br><br>    <span class="hljs-comment">// 4.‰øùÂ≠òÈ™åËØÅÁ†ÅÂà∞ session</span><br>    session.setAttribute(<span class="hljs-string">&quot;code&quot;</span>,code);<br>    <span class="hljs-comment">// 5.ÂèëÈÄÅÈ™åËØÅÁ†Å</span><br>    log.debug(<span class="hljs-string">&quot;ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†ÅÊàêÂäüÔºåÈ™åËØÅÁ†ÅÔºö&#123;&#125;&quot;</span>, code);<br>    <span class="hljs-comment">// ËøîÂõûok</span><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>ÁôªÂΩï</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.Ê†°È™åÊâãÊú∫Âè∑</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.Â¶ÇÊûú‰∏çÁ¨¶ÂêàÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ÊâãÊú∫Âè∑Ê†ºÂºèÈîôËØØÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.Ê†°È™åÈ™åËØÅÁ†Å</span><br>    <span class="hljs-type">Object</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;code&quot;</span>);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span>(cacheCode == <span class="hljs-literal">null</span> || !cacheCode.toString().equals(code))&#123;<br>         <span class="hljs-comment">//3.‰∏ç‰∏ÄËá¥ÔºåÊä•Èîô</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;È™åËØÅÁ†ÅÈîôËØØ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//‰∏ÄËá¥ÔºåÊ†πÊçÆÊâãÊú∫Âè∑Êü•ËØ¢Áî®Êà∑</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br><br>    <span class="hljs-comment">//5.Âà§Êñ≠Áî®Êà∑ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-comment">//‰∏çÂ≠òÂú®ÔºåÂàôÂàõÂª∫</span><br>        user =  createUserWithPhone(phone);<br>    &#125;<br>    <span class="hljs-comment">//7.‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞session‰∏≠</span><br>    session.setAttribute(<span class="hljs-string">&quot;user&quot;</span>,user);<br><br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-3-ÂÆûÁé∞ÁôªÂΩïÊã¶Êà™ÂäüËÉΩ"><a href="#1-3-ÂÆûÁé∞ÁôªÂΩïÊã¶Êà™ÂäüËÉΩ" class="headerlink" title="1.3 ÂÆûÁé∞ÁôªÂΩïÊã¶Êà™ÂäüËÉΩ"></a>1.3 ÂÆûÁé∞ÁôªÂΩïÊã¶Êà™ÂäüËÉΩ</h3><p><img src="/img/blogs/java/redis/2.1.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Êã¶Êà™Âô®‰ª£Á†Å</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>       <span class="hljs-comment">//1.Ëé∑Âèñsession</span><br>        <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> request.getSession();<br>        <span class="hljs-comment">//2.Ëé∑Âèñsession‰∏≠ÁöÑÁî®Êà∑</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>        <span class="hljs-comment">//3.Âà§Êñ≠Áî®Êà∑ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span>(user == <span class="hljs-literal">null</span>)&#123;<br>              <span class="hljs-comment">//4.‰∏çÂ≠òÂú®ÔºåÊã¶Êà™ÔºåËøîÂõû401Áä∂ÊÄÅÁ†Å</span><br>              response.setStatus(<span class="hljs-number">401</span>);<br>              <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">//5.Â≠òÂú®Ôºå‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞Threadlocal</span><br>        UserHolder.saveUser((User)user);<br>        <span class="hljs-comment">//6.ÊîæË°å</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ËÆ©Êã¶Êà™Âô®ÁîüÊïà</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// ÁôªÂΩïÊã¶Êà™Âô®</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>                .excludePathPatterns(<br>                        <span class="hljs-string">&quot;/shop/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/voucher/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/shop-type/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/upload/**&quot;</span>,<br>                        <span class="hljs-string">&quot;/blog/hot&quot;</span>,<br>                        <span class="hljs-string">&quot;/user/code&quot;</span>,<br>                        <span class="hljs-string">&quot;/user/login&quot;</span><br>                ).order(<span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// tokenÂà∑Êñ∞ÁöÑÊã¶Êà™Âô®</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>).order(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-4-ÈöêËóèÁî®Êà∑ÊïèÊÑü‰ø°ÊÅØ"><a href="#1-4-ÈöêËóèÁî®Êà∑ÊïèÊÑü‰ø°ÊÅØ" class="headerlink" title="1.4 ÈöêËóèÁî®Êà∑ÊïèÊÑü‰ø°ÊÅØ"></a>1.4 ÈöêËóèÁî®Êà∑ÊïèÊÑü‰ø°ÊÅØ</h3><p>Êàë‰ª¨ÈÄöËøáÊµèËßàÂô®ËßÇÂØüÂà∞Ê≠§Êó∂Áî®Êà∑ÁöÑÂÖ®ÈÉ®‰ø°ÊÅØÈÉΩÂú®ÔºåËøôÊ†∑ÊûÅ‰∏∫‰∏çÈù†Ë∞±ÔºåÊâÄ‰ª•Êàë‰ª¨Â∫îÂΩìÂú®ËøîÂõûÁî®Êà∑‰ø°ÊÅØ‰πãÂâçÔºåÂ∞ÜÁî®Êà∑ÁöÑÊïèÊÑü‰ø°ÊÅØËøõË°åÈöêËóèÔºåÈááÁî®ÁöÑÊ†∏ÂøÉÊÄùË∑ØÂ∞±ÊòØ‰π¶ÂÜô‰∏Ä‰∏™UserDTOÂØπË±°ÔºåËøô‰∏™UserDTOÂØπË±°Â∞±Ê≤°ÊúâÊïèÊÑü‰ø°ÊÅØ‰∫ÜÔºåÊàë‰ª¨Âú®ËøîÂõûÂâçÔºå<strong>Â∞ÜÊúâÁî®Êà∑ÊïèÊÑü‰ø°ÊÅØÁöÑUserÂØπË±°ËΩ¨ÂåñÊàêÊ≤°ÊúâÊïèÊÑü‰ø°ÊÅØÁöÑUserDTOÂØπË±°</strong>ÔºåÈÇ£‰πàÂ∞±ËÉΩÂ§üÈÅøÂÖçËøô‰∏™Â∞¥Â∞¨ÁöÑÈóÆÈ¢ò‰∫Ü</p>
<h3 id="1-5-sessionÂÖ±‰∫´ÈóÆÈ¢ò"><a href="#1-5-sessionÂÖ±‰∫´ÈóÆÈ¢ò" class="headerlink" title="1.5 sessionÂÖ±‰∫´ÈóÆÈ¢ò"></a>1.5 sessionÂÖ±‰∫´ÈóÆÈ¢ò</h3><p>sessionÂÖ±‰∫´ÈóÆÈ¢ò:Â§öÂè∞TomcatÂπ∂‰∏çÂÖ±‰∫´sessionÂ≠òÂÇ®Á©∫Èó¥,ÂΩìËØ∑Ê±ÇÂàáÊç¢Âà∞‰∏çÂêåtomcatÊúçÂä°Êó∂ÂØºËá¥Êï∞ÊçÆ‰∏¢Â§±ÁöÑÈóÆÈ¢ò</p>
<p><img src="/img/blogs/java/redis/2.1.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>ÊØè‰∏™tomcat‰∏≠ÈÉΩÊúâ‰∏Ä‰ªΩÂ±û‰∫éËá™Â∑±ÁöÑsession</li>
<li>ÂÅáËÆæÁî®Êà∑Á¨¨‰∏ÄÊ¨°ËÆøÈóÆÁ¨¨‰∏ÄÂè∞tomcatÔºåÂπ∂‰∏îÊääËá™Â∑±ÁöÑ‰ø°ÊÅØÂ≠òÊîæÂà∞Á¨¨‰∏ÄÂè∞ÊúçÂä°Âô®ÁöÑsession‰∏≠</li>
<li>‰ΩÜÊòØÁ¨¨‰∫åÊ¨°Ëøô‰∏™Áî®Êà∑ËÆøÈóÆÂà∞‰∫ÜÁ¨¨‰∫åÂè∞tomcatÔºåÈÇ£‰πàÂú®Á¨¨‰∫åÂè∞ÊúçÂä°Âô®‰∏äÔºåËÇØÂÆöÊ≤°ÊúâÁ¨¨‰∏ÄÂè∞ÊúçÂä°Âô®Â≠òÊîæÁöÑsession</li>
</ul>
<p><strong>Ëß£ÂÜ≥ÊñπÊ≥ï</strong>Ôºö</p>
<p>ÊâÄ‰ª•Âí±‰ª¨ÂêéÊù•ÈááÁî®ÁöÑÊñπÊ°àÈÉΩÊòØÂü∫‰∫éredisÊù•ÂÆåÊàêÔºåÊàë‰ª¨<strong>ÊääsessionÊç¢Êàêredis</strong>Ôºå<strong>redisÊï∞ÊçÆÊú¨Ë∫´Â∞±ÊòØÂÖ±‰∫´ÁöÑÔºåÂ∞±ÂèØ‰ª•ÈÅøÂÖçsessionÂÖ±‰∫´</strong>ÁöÑÈóÆÈ¢ò‰∫Ü</p>
<h3 id="1-6-Redis‰ª£ÊõøsessionÁöÑ‰∏öÂä°ÊµÅÁ®ã"><a href="#1-6-Redis‰ª£ÊõøsessionÁöÑ‰∏öÂä°ÊµÅÁ®ã" class="headerlink" title="1.6 Redis‰ª£ÊõøsessionÁöÑ‰∏öÂä°ÊµÅÁ®ã"></a>1.6 Redis‰ª£ÊõøsessionÁöÑ‰∏öÂä°ÊµÅÁ®ã</h3><p><img src="/img/blogs/java/redis/2.1.4.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.1.5.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>ÂΩìÊ≥®ÂÜåÂÆåÊàêÂêéÔºåÁî®Êà∑ÂéªÁôªÂΩï‰ºöÂéªÊ†°È™åÁî®Êà∑Êèê‰∫§ÁöÑÊâãÊú∫Âè∑ÂíåÈ™åËØÅÁ†ÅÔºåÊòØÂê¶‰∏ÄËá¥ÔºåÂ¶ÇÊûú‰∏ÄËá¥ÔºåÂàôÊ†πÊçÆÊâãÊú∫Âè∑Êü•ËØ¢Áî®Êà∑‰ø°ÊÅØÔºå‰∏çÂ≠òÂú®ÂàôÊñ∞Âª∫„ÄÇÊúÄÂêéÂ∞ÜÁî®Êà∑Êï∞ÊçÆ‰øùÂ≠òÂà∞redisÔºåÂπ∂‰∏îÁîüÊàêtoken‰Ωú‰∏∫redisÁöÑkey</li>
<li>ÂΩìÊàë‰ª¨Ê†°È™åÁî®Êà∑ÊòØÂê¶ÁôªÂΩïÊó∂Ôºå‰ºöÂéªÊê∫Â∏¶ÁùÄtokenËøõË°åËÆøÈóÆÔºå‰ªéredis‰∏≠ÂèñÂá∫tokenÂØπÂ∫îÁöÑvalueÔºåÂà§Êñ≠ÊòØÂê¶Â≠òÂú®Ëøô‰∏™Êï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊã¶Êà™ÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôÂ∞ÜÂÖ∂‰øùÂ≠òÂà∞ThreadLocal‰∏≠ÔºåÂπ∂‰∏îÊîæË°å„ÄÇ</li>
</ol>
<h3 id="1-7-Âü∫‰∫éRedisÂÆûÁé∞Áü≠‰ø°ÁôªÂΩï"><a href="#1-7-Âü∫‰∫éRedisÂÆûÁé∞Áü≠‰ø°ÁôªÂΩï" class="headerlink" title="1.7 Âü∫‰∫éRedisÂÆûÁé∞Áü≠‰ø°ÁôªÂΩï"></a>1.7 Âü∫‰∫éRedisÂÆûÁé∞Áü≠‰ø°ÁôªÂΩï</h3><p><strong>UserServiceImpl‰ª£Á†Å</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">login</span><span class="hljs-params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 1.Ê†°È™åÊâãÊú∫Âè∑</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> loginForm.getPhone();<br>    <span class="hljs-keyword">if</span> (RegexUtils.isPhoneInvalid(phone)) &#123;<br>        <span class="hljs-comment">// 2.Â¶ÇÊûú‰∏çÁ¨¶ÂêàÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ÊâãÊú∫Âè∑Ê†ºÂºèÈîôËØØÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.‰ªéredisËé∑ÂèñÈ™åËØÅÁ†ÅÂπ∂Ê†°È™å</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">cacheCode</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(LOGIN_CODE_KEY + phone);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> loginForm.getCode();<br>    <span class="hljs-keyword">if</span> (cacheCode == <span class="hljs-literal">null</span> || !cacheCode.equals(code)) &#123;<br>        <span class="hljs-comment">// ‰∏ç‰∏ÄËá¥ÔºåÊä•Èîô</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;È™åËØÅÁ†ÅÈîôËØØ&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 4.‰∏ÄËá¥ÔºåÊ†πÊçÆÊâãÊú∫Âè∑Êü•ËØ¢Áî®Êà∑ select * from tb_user where phone = ?</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;phone&quot;</span>, phone).one();<br><br>    <span class="hljs-comment">// 5.Âà§Êñ≠Áî®Êà∑ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// 6.‰∏çÂ≠òÂú®ÔºåÂàõÂª∫Êñ∞Áî®Êà∑Âπ∂‰øùÂ≠ò</span><br>        user = createUserWithPhone(phone);<br>    &#125;<br><br>    <span class="hljs-comment">// 7.‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞ redis‰∏≠</span><br>    <span class="hljs-comment">// 7.1.ÈöèÊú∫ÁîüÊàêtokenÔºå‰Ωú‰∏∫ÁôªÂΩï‰ª§Áâå</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>);<br>    <span class="hljs-comment">// 7.2.Â∞ÜUserÂØπË±°ËΩ¨‰∏∫HashMapÂ≠òÂÇ®</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(user, UserDTO.class);<br>    Map&lt;String, Object&gt; userMap = BeanUtil.beanToMap(userDTO, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(),<br>            CopyOptions.create()<br>                    .setIgnoreNullValue(<span class="hljs-literal">true</span>)<br>                    .setFieldValueEditor((fieldName, fieldValue) -&gt; fieldValue.toString()));<br>    <span class="hljs-comment">// 7.3.Â≠òÂÇ®</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">tokenKey</span> <span class="hljs-operator">=</span> LOGIN_USER_KEY + token;<br>    stringRedisTemplate.opsForHash().putAll(tokenKey, userMap);<br>    <span class="hljs-comment">// 7.4.ËÆæÁΩÆtokenÊúâÊïàÊúü</span><br>    stringRedisTemplate.expire(tokenKey, LOGIN_USER_TTL, TimeUnit.MINUTES);<br><br>    <span class="hljs-comment">// 8.ËøîÂõûtoken</span><br>    <span class="hljs-keyword">return</span> Result.ok(token);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="1-8-Ëß£ÂÜ≥Áä∂ÊÄÅÁôªÂΩïÂà∑Êñ∞ÈóÆÈ¢ò"><a href="#1-8-Ëß£ÂÜ≥Áä∂ÊÄÅÁôªÂΩïÂà∑Êñ∞ÈóÆÈ¢ò" class="headerlink" title="1.8 Ëß£ÂÜ≥Áä∂ÊÄÅÁôªÂΩïÂà∑Êñ∞ÈóÆÈ¢ò"></a>1.8 Ëß£ÂÜ≥Áä∂ÊÄÅÁôªÂΩïÂà∑Êñ∞ÈóÆÈ¢ò</h3><ul>
<li>ÂéüÂßãÊã¶Êà™Âô®Á°ÆÂÆûÂèØ‰ª•‰ΩøÁî®ÂØπÂ∫îË∑ØÂæÑÁöÑÊã¶Êà™ÔºåÂêåÊó∂Âà∑Êñ∞ÁôªÂΩïtoken‰ª§ÁâåÁöÑÂ≠òÊ¥ªÊó∂Èó¥Ôºå‰ΩÜÊòØÁé∞Âú®Ëøô‰∏™Êã¶Êà™Âô®‰ªñÂè™ÊòØÊã¶Êà™ÈúÄË¶ÅË¢´Êã¶Êà™ÁöÑË∑ØÂæÑ</li>
<li>ÂÅáËÆæÂΩìÂâçÁî®Êà∑ËÆøÈóÆ‰∫Ü‰∏Ä‰∫õ‰∏çÈúÄË¶ÅÊã¶Êà™ÁöÑË∑ØÂæÑÔºåÈÇ£‰πàËøô‰∏™Êã¶Êà™Âô®Â∞±‰∏ç‰ºöÁîüÊïàÔºåÊâÄ‰ª•Ê≠§Êó∂‰ª§ÁâåÂà∑Êñ∞ÁöÑÂä®‰ΩúÂÆûÈôÖ‰∏äÂ∞±‰∏ç‰ºöÊâßË°å</li>
</ul>
<p><img src="/img/blogs/java/redis/2.1.6.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Êàë‰ª¨ÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™Êã¶Êà™Âô®ÔºåÂú®<strong>Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®‰∏≠Êã¶Êà™ÊâÄÊúâÁöÑË∑ØÂæÑ</strong>ÔºåÊääÁ¨¨‰∫å‰∏™Êã¶Êà™Âô®ÂÅöÁöÑ‰∫ãÊÉÖÊîæÂÖ•Âà∞Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®‰∏≠ÔºåÂêåÊó∂Âà∑Êñ∞‰ª§ÁâåÔºåÂõ†‰∏∫Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®Êúâ‰∫ÜthreadLocalÁöÑÊï∞ÊçÆÔºåÊâÄ‰ª•Ê≠§Êó∂<strong>Á¨¨‰∫å‰∏™Êã¶Êà™Âô®Âè™ÈúÄË¶ÅÂà§Êñ≠Êã¶Êà™Âô®‰∏≠ÁöÑuserÂØπË±°ÊòØÂê¶Â≠òÂú®Âç≥ÂèØ</strong>ÔºåÂÆåÊàêÊï¥‰ΩìÂà∑Êñ∞ÂäüËÉΩ„ÄÇ</li>
</ul>
<p><strong>RefreshTokenInterceptor</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshTokenInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RefreshTokenInterceptor</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.Ëé∑ÂèñËØ∑Ê±ÇÂ§¥‰∏≠ÁöÑtoken</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">token</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;authorization&quot;</span>);<br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(token)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 2.Âü∫‰∫éTOKENËé∑Âèñredis‰∏≠ÁöÑÁî®Êà∑</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span>  <span class="hljs-operator">=</span> LOGIN_USER_KEY + token;<br>        Map&lt;Object, Object&gt; userMap = stringRedisTemplate.opsForHash().entries(key);<br>        <span class="hljs-comment">// 3.Âà§Êñ≠Áî®Êà∑ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span> (userMap.isEmpty()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-comment">// 5.Â∞ÜÊü•ËØ¢Âà∞ÁöÑhashÊï∞ÊçÆËΩ¨‰∏∫UserDTO</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">userDTO</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(userMap, <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDTO</span>(), <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">// 6.Â≠òÂú®Ôºå‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØÂà∞ ThreadLocal</span><br>        UserHolder.saveUser(userDTO);<br>        <span class="hljs-comment">// 7.Âà∑Êñ∞tokenÊúâÊïàÊúü</span><br>        stringRedisTemplate.expire(key, LOGIN_USER_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">// 8.ÊîæË°å</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ÁßªÈô§Áî®Êà∑</span><br>        UserHolder.removeUser();<br>    &#125;<br>&#125;<br>	<br></code></pre></td></tr></table></figure>

<p><strong>LoginInterceptor</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊã¶Êà™ÔºàThreadLocal‰∏≠ÊòØÂê¶ÊúâÁî®Êà∑Ôºâ</span><br>        <span class="hljs-keyword">if</span> (UserHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// Ê≤°ÊúâÔºåÈúÄË¶ÅÊã¶Êà™ÔºåËÆæÁΩÆÁä∂ÊÄÅÁ†Å</span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-comment">// Êã¶Êà™</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// ÊúâÁî®Êà∑ÔºåÂàôÊîæË°å</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>MvcConfig</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>       <span class="hljs-comment">// ÁôªÂΩïÊã¶Êà™Âô®</span><br>       registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginInterceptor</span>())<br>               .excludePathPatterns(<br>                       <span class="hljs-string">&quot;/shop/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/voucher/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/shop-type/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/upload/**&quot;</span>,<br>                       <span class="hljs-string">&quot;/blog/hot&quot;</span>,<br>                       <span class="hljs-string">&quot;/user/code&quot;</span>,<br>                       <span class="hljs-string">&quot;/user/login&quot;</span><br>               ).order(<span class="hljs-number">1</span>);<br>       <span class="hljs-comment">// tokenÂà∑Êñ∞ÁöÑÊã¶Êà™Âô®</span><br>       registry.addInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefreshTokenInterceptor</span>(stringRedisTemplate)).addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>).order(<span class="hljs-number">0</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>


<h2 id="2-ÂïÜÊà∑Êü•ËØ¢ÁºìÂ≠ò"><a href="#2-ÂïÜÊà∑Êü•ËØ¢ÁºìÂ≠ò" class="headerlink" title="2. ÂïÜÊà∑Êü•ËØ¢ÁºìÂ≠ò"></a>2. ÂïÜÊà∑Êü•ËØ¢ÁºìÂ≠ò</h2><h3 id="2-1-‰ªÄ‰πàÊòØÁºìÂ≠ò"><a href="#2-1-‰ªÄ‰πàÊòØÁºìÂ≠ò" class="headerlink" title="2.1 ‰ªÄ‰πàÊòØÁºìÂ≠ò?"></a>2.1 ‰ªÄ‰πàÊòØÁºìÂ≠ò?</h3><p>ÁºìÂ≠òÂ∞±ÊòØÊï∞ÊçÆ‰∫§Êç¢ÁöÑÁºìÂÜ≤Âå∫ÔºàÁß∞‰ΩúCacheÔºâÔºåÊòØÂ≠òË¥ÆÊï∞ÊçÆÁöÑ‰∏¥Êó∂Âú∞ÊñπÔºå‰∏ÄËà¨ËØªÂÜôÊÄßËÉΩËæÉÈ´ò„ÄÇ</p>
<ul>
<li><p><strong>ÁºìÂ≠ò(<strong>Cache),Â∞±ÊòØÊï∞ÊçÆ‰∫§Êç¢ÁöÑ</strong>ÁºìÂÜ≤Âå∫</strong>,‰øóÁß∞ÁöÑÁºìÂ≠òÂ∞±ÊòØ<strong>ÁºìÂÜ≤Âå∫ÂÜÖÁöÑÊï∞ÊçÆ</strong>,‰∏ÄËà¨‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Ëé∑Âèñ,Â≠òÂÇ®‰∫éÊú¨Âú∞‰ª£Á†Å</p>
</li>
<li><p>‰∏∫‰ªÄ‰πà‰ΩøÁî®ÁºìÂ≠òÔºü</p>
<ul>
<li><strong>ÈÄüÂ∫¶Âø´,Â•ΩÁî®</strong></li>
<li>ÁºìÂ≠òÊï∞ÊçÆÂ≠òÂÇ®‰∫é‰ª£Á†Å‰∏≠,ËÄå‰ª£Á†ÅËøêË°åÂú®ÂÜÖÂ≠ò‰∏≠,ÂÜÖÂ≠òÁöÑËØªÂÜôÊÄßËÉΩËøúÈ´ò‰∫éÁ£ÅÁõò,ÁºìÂ≠òÂèØ‰ª•Â§ßÂ§ßÈôç‰Ωé<strong>Áî®Êà∑ËÆøÈóÆÂπ∂ÂèëÈáèÂ∏¶Êù•ÁöÑ</strong>ÊúçÂä°Âô®ËØªÂÜôÂéãÂäõ</li>
</ul>
</li>
<li><p>‰ΩÜÊòØÁºìÂ≠ò‰πü‰ºöÂ¢ûÂä†‰ª£Á†ÅÂ§çÊùÇÂ∫¶ÂíåËøêËê•ÁöÑÊàêÊú¨</p>
</li>
</ul>
<h3 id="2-2-Ê∑ªÂä†ÂïÜÊà∑ÁºìÂ≠ò"><a href="#2-2-Ê∑ªÂä†ÂïÜÊà∑ÁºìÂ≠ò" class="headerlink" title="2.2 Ê∑ªÂä†ÂïÜÊà∑ÁºìÂ≠ò"></a>2.2 Ê∑ªÂä†ÂïÜÊà∑ÁºìÂ≠ò</h3><p><img src="/img/blogs/java/redis/2.2.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Êü•ËØ¢Êï∞ÊçÆÂ∫ì‰πãÂâçÂÖàÊü•ËØ¢ÁºìÂ≠òÔºåÂ¶ÇÊûúÁºìÂ≠òÊï∞ÊçÆÂ≠òÂú®ÔºåÂàôÁõ¥Êé•‰ªéÁºìÂ≠ò‰∏≠ËøîÂõûÔºåÂ¶ÇÊûúÁºìÂ≠òÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÂÜçÊü•ËØ¢Êï∞ÊçÆÂ∫ìÔºåÁÑ∂ÂêéÂ∞ÜÊï∞ÊçÆÂ≠òÂÖ•redis</li>
</ul>
<p><strong>ShopServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-comment">// 3.Â≠òÂú®,Áõ¥Êé•ËøîÂõû</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>    <span class="hljs-comment">// 4.‰∏çÂ≠òÂú®,Ê†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®,ËøîÂõûÈîôËØØ</span><br>    <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Â∫óÈì∫‰∏çÂ≠òÂú®!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.Â≠òÂú®,ÂÜôÂÖ•redis</span><br>    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));<br>    <span class="hljs-comment">// 7.ËøîÂõû</span><br>    <span class="hljs-keyword">return</span> Result.ok(shop);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="2-3-ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•"><a href="#2-3-ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•" class="headerlink" title="2.3 ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•"></a>2.3 ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•</h3><p>redis‰ºöÂØπÈÉ®ÂàÜÊï∞ÊçÆËøõË°åÊõ¥Êñ∞ÔºåÊàñËÄÖÊää‰ªñÂè´‰∏∫Ê∑òÊ±∞<br>Êúâ‰ª•‰∏ã‰∏âÁßçÊõ¥Êñ∞Á≠ñÁï•Ôºö</p>
<table>
<thead>
<tr>
<th></th>
<th>ÂÜÖÂ≠òÊ∑òÊ±∞</th>
<th>Ë∂ÖÊó∂Âà†Èô§</th>
<th>‰∏ªÂä®Êõ¥Êñ∞</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ËØ¥Êòé</strong></td>
<td>‰∏çÁî®Ëá™Â∑±Áª¥Êä§ÔºåÂà©Áî®RedisÁöÑÂÜÖÂ≠òÊ∑òÊ±∞Êú∫Âà∂ÔºåÂΩìÂÜÖÂ≠ò‰∏çË∂≥Êó∂Ëá™Âä®Ê∑òÊ±∞ÈÉ®ÂàÜÊï∞ÊçÆ„ÄÇ‰∏ãÊ¨°Êü•ËØ¢Êó∂Êõ¥Êñ∞ÁºìÂ≠ò„ÄÇ</td>
<td>ÁªôÁºìÂ≠òÊï∞ÊçÆÊ∑ªÂä†TTLÊó∂Èó¥ÔºåÂà∞ÊúüÂêéËá™Âä®Âà†Èô§ÁºìÂ≠ò„ÄÇ‰∏ãÊ¨°Êü•ËØ¢Êó∂Êõ¥Êñ∞ÁºìÂ≠ò„ÄÇ</td>
<td>ÁºñÂÜô‰∏öÂä°ÈÄªËæëÔºåÂú®‰øÆÊîπÊï∞ÊçÆÂ∫ìÁöÑÂêåÊó∂ÔºåÊõ¥Êñ∞ÁºìÂ≠ò„ÄÇ</td>
</tr>
<tr>
<td><strong>‰∏ÄËá¥ÊÄß</strong></td>
<td>Â∑Æ</td>
<td>‰∏ÄËà¨</td>
<td>Â•Ω</td>
</tr>
<tr>
<td><strong>Áª¥Êä§ÊàêÊú¨</strong></td>
<td>Êó†</td>
<td>‰Ωé</td>
<td>È´ò</td>
</tr>
</tbody></table>
<p>‰∏öÂä°Âú∫ÊôØÔºö</p>
<ul>
<li>‰Ωé‰∏ÄËá¥ÊÄßÈúÄÊ±ÇÔºö‰ΩøÁî®ÂÜÖÂ≠òÊ∑òÊ±∞Êú∫Âà∂„ÄÇ‰æãÂ¶ÇÂ∫óÈì∫Á±ªÂûãÁöÑÊü•ËØ¢ÁºìÂ≠ò</li>
<li>È´ò‰∏ÄËá¥ÊÄßÈúÄÊ±ÇÔºö‰∏ªÂä®Êõ¥Êñ∞ÔºåÂπ∂‰ª•Ë∂ÖÊó∂ÂâîÈô§‰Ωú‰∏∫ÂÖúÂ∫ïÊñπÊ°à„ÄÇ‰æãÂ¶ÇÂ∫óÈì∫ËØ¶ÊÉÖÊü•ËØ¢ÁöÑÁºìÂ≠ò</li>
</ul>
<p><strong>Êï∞ÊçÆÂ∫ìÂíåÁºìÂ≠ò‰∏ç‰∏ÄËá¥ÈááÁî®‰ªÄ‰πàÊñπÊ°à</strong>Ôºü<br>‰∫∫Â∑•ÁºñÁ†ÅÊñπÂºèÔºö<strong>ÁºìÂ≠òË∞ÉÁî®ËÄÖÂú®Êõ¥Êñ∞ÂÆåÊï∞ÊçÆÂ∫ìÂêéÂÜçÂéªÊõ¥Êñ∞ÁºìÂ≠ò</strong>Ôºå‰πüÁß∞‰πã‰∏∫ÂèåÂÜôÊñπÊ°à</p>
<ul>
<li><p>Âà†Èô§ÁºìÂ≠òËøòÊòØÊõ¥Êñ∞ÁºìÂ≠òÔºü(<strong>ÈÄâÊã©Âà†Èô§ÁºìÂ≠ò</strong>)</p>
<ul>
<li>Êõ¥Êñ∞ÁºìÂ≠òÔºöÊØèÊ¨°Êõ¥Êñ∞Êï∞ÊçÆÂ∫ìÈÉΩÊõ¥Êñ∞ÁºìÂ≠òÔºåÊó†ÊïàÂÜôÊìç‰ΩúËæÉÂ§ö</li>
<li>Âà†Èô§ÁºìÂ≠òÔºöÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÊó∂ËÆ©ÁºìÂ≠òÂ§±ÊïàÔºåÊü•ËØ¢Êó∂ÂÜçÊõ¥Êñ∞ÁºìÂ≠ò</li>
</ul>
</li>
<li><p>Â¶Ç‰Ωï‰øùËØÅÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÁöÑÊìç‰ΩúÁöÑÂêåÊó∂ÊàêÂäüÊàñÂ§±Ë¥•Ôºü</p>
<ul>
<li>Âçï‰ΩìÁ≥ªÁªüÔºåÂ∞ÜÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÊìç‰ΩúÊîæÂú®‰∏Ä‰∏™‰∫ãÂä°</li>
<li>ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÔºåÂà©Áî®TCCÁ≠âÂàÜÂ∏ÉÂºè‰∫ãÂä°ÊñπÊ°à</li>
</ul>
</li>
<li><p>ÂÖàÊìç‰ΩúÁºìÂ≠òËøòÊòØÂÖàÊìç‰ΩúÊï∞ÊçÆÂ∫ìÔºü(<strong>ÂÖàÊìç‰ΩúÊï∞ÊçÆÂ∫ìÔºåÂÜçÂà†Èô§ÁºìÂ≠ò</strong>)</p>
<ul>
<li>ÂÖàÂà†Èô§ÁºìÂ≠òÔºåÂÜçÊìç‰ΩúÊï∞ÊçÆÂ∫ì</li>
<li>ÂÖàÊìç‰ΩúÊï∞ÊçÆÂ∫ìÔºåÂÜçÂà†Èô§ÁºìÂ≠ò</li>
</ul>
</li>
</ul>
<h3 id="2-4-ÂÆûÁé∞ÂïÜÈì∫ÂíåÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÂèåÂÜô‰∏ÄËá¥"><a href="#2-4-ÂÆûÁé∞ÂïÜÈì∫ÂíåÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÂèåÂÜô‰∏ÄËá¥" class="headerlink" title="2.4 ÂÆûÁé∞ÂïÜÈì∫ÂíåÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÂèåÂÜô‰∏ÄËá¥"></a>2.4 ÂÆûÁé∞ÂïÜÈì∫ÂíåÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÂèåÂÜô‰∏ÄËá¥</h3><p>‰øÆÊîπShopController‰∏≠ÁöÑ‰∏öÂä°ÈÄªËæëÔºåÊª°Ë∂≥‰∏ãÈù¢ÁöÑÈúÄÊ±ÇÔºö</p>
<ul>
<li>Ê†πÊçÆidÊü•ËØ¢Â∫óÈì∫Êó∂ÔºåÂ¶ÇÊûúÁºìÂ≠òÊú™ÂëΩ‰∏≠ÔºåÂàôÊü•ËØ¢Êï∞ÊçÆÂ∫ìÔºåÂ∞ÜÊï∞ÊçÆÂ∫ìÁªìÊûúÂÜôÂÖ•ÁºìÂ≠òÔºåÂπ∂<strong>ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥</strong></li>
<li>Ê†πÊçÆid‰øÆÊîπÂ∫óÈì∫Êó∂Ôºå<strong>ÂÖà‰øÆÊîπÊï∞ÊçÆÂ∫ìÔºåÂÜçÂà†Èô§ÁºìÂ≠ò</strong></li>
</ul>
<h3 id="2-5-ÁºìÂ≠òÁ©øÈÄè"><a href="#2-5-ÁºìÂ≠òÁ©øÈÄè" class="headerlink" title="2.5 ÁºìÂ≠òÁ©øÈÄè"></a>2.5 ÁºìÂ≠òÁ©øÈÄè</h3><p>ÁºìÂ≠òÁ©øÈÄè ÔºöÁºìÂ≠òÁ©øÈÄèÊòØÊåáÂÆ¢Êà∑Á´Ø<strong>ËØ∑Ê±ÇÁöÑÊï∞ÊçÆÂú®ÁºìÂ≠ò‰∏≠ÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÈÉΩ‰∏çÂ≠òÂú®</strong>ÔºåËøôÊ†∑ÁºìÂ≠òÊ∞∏Ëøú‰∏ç‰ºöÁîüÊïàÔºåËøô‰∫õËØ∑Ê±ÇÈÉΩ‰ºöÊâìÂà∞Êï∞ÊçÆÂ∫ì„ÄÇ</p>
<p>Â∏∏ËßÅÁöÑËß£ÂÜ≥ÊñπÊ°àÊúâ‰∏§ÁßçÔºö</p>
<ul>
<li>ÁºìÂ≠òÁ©∫ÂØπË±°<ul>
<li>‰ºòÁÇπÔºöÂÆûÁé∞ÁÆÄÂçïÔºåÁª¥Êä§Êñπ‰æø</li>
<li>Áº∫ÁÇπÔºö<ul>
<li>È¢ùÂ§ñÁöÑÂÜÖÂ≠òÊ∂àËÄó</li>
<li>ÂèØËÉΩÈÄ†ÊàêÁü≠ÊúüÁöÑ‰∏ç‰∏ÄËá¥</li>
</ul>
</li>
</ul>
</li>
<li>Â∏ÉÈöÜËøáÊª§<ul>
<li>‰ºòÁÇπÔºöÂÜÖÂ≠òÂç†Áî®ËæÉÂ∞ëÔºåÊ≤°ÊúâÂ§ö‰Ωôkey</li>
<li>Áº∫ÁÇπÔºö<ul>
<li>ÂÆûÁé∞Â§çÊùÇ</li>
<li>Â≠òÂú®ËØØÂà§ÂèØËÉΩ</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ÁºñÁ†ÅËß£ÂÜ≥ÂïÜÂìÅÊü•ËØ¢ÁöÑÁºìÂ≠òÁ©øÈÄèÈóÆÈ¢ò</strong>Ôºö</p>
<ul>
<li>ÂéüÊù•ÁöÑÈÄªËæë‰∏≠ÔºåÊàë‰ª¨Â¶ÇÊûúÂèëÁé∞Ëøô‰∏™<strong>Êï∞ÊçÆÂú®mysql‰∏≠‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Â∞±ËøîÂõû404</strong>‰∫ÜÔºåËøôÊ†∑ÊòØ‰ºöÂ≠òÂú®ÁºìÂ≠òÁ©øÈÄèÈóÆÈ¢òÁöÑ</li>
<li>Áé∞Âú®ÁöÑÈÄªËæë‰∏≠ÔºöÂ¶ÇÊûúËøô‰∏™Êï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÊàë‰ª¨‰∏ç‰ºöËøîÂõû404 <ul>
<li>ËÄåÊòØ<strong>‰ºöÊääËøô‰∏™Êï∞ÊçÆÂÜôÂÖ•Âà∞Redis‰∏≠ÔºåÂπ∂‰∏îÂ∞ÜvalueËÆæÁΩÆ‰∏∫Á©∫</strong></li>
<li>ÂΩìÂÜçÊ¨°ÂèëËµ∑Êü•ËØ¢Êó∂ÔºåÊàë‰ª¨Â¶ÇÊûúÂèëÁé∞ÂëΩ‰∏≠‰πãÂêéÔºå<strong>Âà§Êñ≠Ëøô‰∏™valueÊòØÂê¶ÊòØnull</strong>ÔºåÂ¶ÇÊûúÊòØnullÔºåÂàôÊòØ‰πãÂâçÂÜôÂÖ•ÁöÑÊï∞ÊçÆÔºåËØÅÊòéÊòØÁºìÂ≠òÁ©øÈÄèÊï∞ÊçÆÔºåÂ¶ÇÊûú‰∏çÊòØÔºåÂàôÁõ¥Êé•ËøîÂõûÊï∞ÊçÆ„ÄÇ</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>CacheClient</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> &lt;R,ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(</span><br><span class="hljs-params">        String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span>&#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>    <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>        <span class="hljs-comment">// 3.Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>    &#125;<br>    <span class="hljs-comment">// Âà§Êñ≠ÂëΩ‰∏≠ÁöÑÊòØÂê¶ÊòØÁ©∫ÂÄº</span><br>    <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// ËøîÂõû‰∏Ä‰∏™ÈîôËØØ‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 4.‰∏çÂ≠òÂú®ÔºåÊ†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>    <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>    <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®ÔºåËøîÂõûÈîôËØØ</span><br>    <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// Â∞ÜÁ©∫ÂÄºÂÜôÂÖ•redis</span><br>        stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>        <span class="hljs-comment">// ËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 6.Â≠òÂú®ÔºåÂÜôÂÖ•redis</span><br>    <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>    <span class="hljs-keyword">return</span> r;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-6-ÁºìÂ≠òÈõ™Â¥©"><a href="#2-6-ÁºìÂ≠òÈõ™Â¥©" class="headerlink" title="2.6 ÁºìÂ≠òÈõ™Â¥©"></a>2.6 ÁºìÂ≠òÈõ™Â¥©</h3><p>ÁºìÂ≠òÈõ™Â¥©ÊòØÊåáÂú®Âêå‰∏ÄÊó∂ÊÆµÂ§ßÈáèÁöÑÁºìÂ≠òkeyÂêåÊó∂Â§±ÊïàÊàñËÄÖRedisÊúçÂä°ÂÆïÊú∫ÔºåÂØºËá¥Â§ßÈáèËØ∑Ê±ÇÂà∞ËææÊï∞ÊçÆÂ∫ìÔºåÂ∏¶Êù•Â∑®Â§ßÂéãÂäõ„ÄÇ</p>
<p>Ëß£ÂÜ≥ÊñπÊ°àÔºö</p>
<ul>
<li>Áªô‰∏çÂêåÁöÑKeyÁöÑTTLÊ∑ªÂä†ÈöèÊú∫ÂÄº</li>
<li>Âà©Áî®RedisÈõÜÁæ§ÊèêÈ´òÊúçÂä°ÁöÑÂèØÁî®ÊÄß</li>
<li>ÁªôÁºìÂ≠ò‰∏öÂä°Ê∑ªÂä†ÈôçÁ∫ßÈôêÊµÅÁ≠ñÁï•</li>
<li>Áªô‰∏öÂä°Ê∑ªÂä†Â§öÁ∫ßÁºìÂ≠ò</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.4.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-ÁºìÂ≠òÂáªÁ©ø"><a href="#2-7-ÁºìÂ≠òÂáªÁ©ø" class="headerlink" title="2.7 ÁºìÂ≠òÂáªÁ©ø"></a>2.7 ÁºìÂ≠òÂáªÁ©ø</h3><p>ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò‰πüÂè´ÁÉ≠ÁÇπKeyÈóÆÈ¢òÔºåÂ∞±ÊòØ‰∏Ä‰∏™<strong>Ë¢´È´òÂπ∂ÂèëËÆøÈóÆÂπ∂‰∏îÁºìÂ≠òÈáçÂª∫‰∏öÂä°ËæÉÂ§çÊùÇÁöÑkeyÁ™ÅÁÑ∂Â§±Êïà‰∫Ü</strong>ÔºåÊó†Êï∞ÁöÑËØ∑Ê±ÇËÆøÈóÆ‰ºöÂú®Áû¨Èó¥ÁªôÊï∞ÊçÆÂ∫ìÂ∏¶Êù•Â∑®Â§ßÁöÑÂÜ≤Âáª„ÄÇ</p>
<p>Â∏∏ËßÅÁöÑËß£ÂÜ≥ÊñπÊ°àÊúâ‰∏§ÁßçÔºö</p>
<ul>
<li>‰∫íÊñ•ÈîÅ</li>
<li>ÈÄªËæëËøáÊúü</li>
</ul>
<p><img src="/img/blogs/java/redis/2.2.5.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.2.6.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th>Ëß£ÂÜ≥ÊñπÊ°à</th>
<th>‰ºòÁÇπ</th>
<th>Áº∫ÁÇπ</th>
</tr>
</thead>
<tbody><tr>
<td>‰∫íÊñ•ÈîÅ</td>
<td>- Ê≤°ÊúâÈ¢ùÂ§ñÁöÑÂÜÖÂ≠òÊ∂àËÄó<br>- ‰øùËØÅ‰∏ÄËá¥ÊÄß<br>- ÂÆûÁé∞ÁÆÄÂçï</td>
<td>- Á∫øÁ®ãÈúÄË¶ÅÁ≠âÂæÖÔºåÊÄßËÉΩÂèóÂΩ±Âìç<br>- ÂèØËÉΩÊúâÊ≠ªÈîÅÈ£éÈô©</td>
</tr>
<tr>
<td>ÈÄªËæëËøáÊúü</td>
<td>- Á∫øÁ®ãÊó†ÈúÄÁ≠âÂæÖÔºåÊÄßËÉΩËæÉÂ•Ω</td>
<td>- ‰∏ç‰øùËØÅ‰∏ÄËá¥ÊÄß<br>- ÊúâÈ¢ùÂ§ñÂÜÖÂ≠òÊ∂àËÄó<br>- ÂÆûÁé∞Â§çÊùÇ</td>
</tr>
</tbody></table>
<h4 id="2-7-1-Âà©Áî®‰∫íÊñ•ÈîÅËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò"><a href="#2-7-1-Âà©Áî®‰∫íÊñ•ÈîÅËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò" class="headerlink" title="2.7.1 Âà©Áî®‰∫íÊñ•ÈîÅËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò"></a>2.7.1 Âà©Áî®‰∫íÊñ•ÈîÅËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò</h4><p><img src="/img/blogs/java/redis/2.2.7.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ShopServiceImpl</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(Long id)</span>  &#123;<br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>       <span class="hljs-comment">// 1„ÄÅ‰ªéredis‰∏≠Êü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(<span class="hljs-string">&quot;key&quot;</span>);<br>       <span class="hljs-comment">// 2„ÄÅÂà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>       <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>           <span class="hljs-comment">// Â≠òÂú®,Áõ¥Êé•ËøîÂõû</span><br>           <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, Shop.class);<br>       &#125;<br>       <span class="hljs-comment">//Âà§Êñ≠ÂëΩ‰∏≠ÁöÑÂÄºÊòØÂê¶ÊòØÁ©∫ÂÄº</span><br>       <span class="hljs-keyword">if</span> (shopJson != <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-comment">//ËøîÂõû‰∏Ä‰∏™ÈîôËØØ‰ø°ÊÅØ</span><br>           <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>       &#125;<br>       <span class="hljs-comment">// 4.ÂÆûÁé∞ÁºìÂ≠òÈáçÊûÑ</span><br>       <span class="hljs-comment">//4.1 Ëé∑Âèñ‰∫íÊñ•ÈîÅ</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;lock:shop:&quot;</span> + id;<br>       <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>       <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>           <span class="hljs-comment">// 4.2 Âà§Êñ≠Âê¶Ëé∑ÂèñÊàêÂäü</span><br>           <span class="hljs-keyword">if</span>(!isLock)&#123;<br>               <span class="hljs-comment">//4.3 Â§±Ë¥•ÔºåÂàô‰ºëÁú†ÈáçËØï</span><br>               Thread.sleep(<span class="hljs-number">50</span>);<br>               <span class="hljs-keyword">return</span> queryWithMutex(id);<br>           &#125;<br>           <span class="hljs-comment">//4.4 ÊàêÂäüÔºåÊ†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>            shop = getById(id);<br>           <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®ÔºåËøîÂõûÈîôËØØ</span><br>           <span class="hljs-keyword">if</span>(shop == <span class="hljs-literal">null</span>)&#123;<br>                <span class="hljs-comment">//Â∞ÜÁ©∫ÂÄºÂÜôÂÖ•redis</span><br>               stringRedisTemplate.opsForValue().set(key,<span class="hljs-string">&quot;&quot;</span>,CACHE_NULL_TTL,TimeUnit.MINUTES);<br>               <span class="hljs-comment">//ËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>               <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>           &#125;<br>           <span class="hljs-comment">//6.ÂÜôÂÖ•redis</span><br>           stringRedisTemplate.opsForValue().set(key,JSONUtil.toJsonStr(shop),CACHE_NULL_TTL,TimeUnit.MINUTES);<br><br>       &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>       &#125;<br>       <span class="hljs-keyword">finally</span> &#123;<br>           <span class="hljs-comment">//7.ÈáäÊîæ‰∫íÊñ•ÈîÅ</span><br>           unlock(lockKey);<br>       &#125;<br>       <span class="hljs-keyword">return</span> shop;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-7-2-Âà©Áî®ÈÄªËæëËøáÊúüËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò"><a href="#2-7-2-Âà©Áî®ÈÄªËæëËøáÊúüËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò" class="headerlink" title="2.7.2 Âà©Áî®ÈÄªËæëËøáÊúüËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò"></a>2.7.2 Âà©Áî®ÈÄªËæëËøáÊúüËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò</h4><p>‰øÆÊîπÊ†πÊçÆidÊü•ËØ¢ÂïÜÈì∫ÁöÑ‰∏öÂä°ÔºåÂü∫‰∫éÈÄªËæëËøáÊúüÊñπÂºèÊù•Ëß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò</p>
<p><img src="/img/blogs/java/redis/2.2.8.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ShopServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><span class="hljs-keyword">public</span> Shop <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">( Long id )</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>        <span class="hljs-comment">// 3.Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 4.ÂëΩ‰∏≠ÔºåÈúÄË¶ÅÂÖàÊääjsonÂèçÂ∫èÂàóÂåñ‰∏∫ÂØπË±°</span><br>    <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), Shop.class);<br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>    <span class="hljs-comment">// 5.Âà§Êñ≠ÊòØÂê¶ËøáÊúü</span><br>    <span class="hljs-keyword">if</span>(expireTime.isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// 5.1.Êú™ËøáÊúüÔºåÁõ¥Êé•ËøîÂõûÂ∫óÈì∫‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> shop;<br>    &#125;<br>    <span class="hljs-comment">// 5.2.Â∑≤ËøáÊúüÔºåÈúÄË¶ÅÁºìÂ≠òÈáçÂª∫</span><br>    <span class="hljs-comment">// 6.ÁºìÂ≠òÈáçÂª∫</span><br>    <span class="hljs-comment">// 6.1.Ëé∑Âèñ‰∫íÊñ•ÈîÅ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>    <span class="hljs-comment">// 6.2.Âà§Êñ≠ÊòØÂê¶Ëé∑ÂèñÈîÅÊàêÂäü</span><br>    <span class="hljs-keyword">if</span> (isLock)&#123;<br>        CACHE_REBUILD_EXECUTOR.submit( ()-&gt;&#123;<br><br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-comment">//ÈáçÂª∫ÁºìÂ≠ò</span><br>                <span class="hljs-built_in">this</span>.saveShop2Redis(id,<span class="hljs-number">20L</span>);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>            &#125;<span class="hljs-keyword">finally</span> &#123;<br>                unlock(lockKey);<br>            &#125;<br>        &#125;);<br>    &#125;<br>    <span class="hljs-comment">// 6.4.ËøîÂõûËøáÊúüÁöÑÂïÜÈì∫‰ø°ÊÅØ</span><br>    <span class="hljs-keyword">return</span> shop;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-8-Â∞ÅË£ÖRedisÂ∑•ÂÖ∑Á±ª"><a href="#2-8-Â∞ÅË£ÖRedisÂ∑•ÂÖ∑Á±ª" class="headerlink" title="2.8 Â∞ÅË£ÖRedisÂ∑•ÂÖ∑Á±ª"></a>2.8 Â∞ÅË£ÖRedisÂ∑•ÂÖ∑Á±ª</h3><p>Âü∫‰∫éStringRedisTemplateÂ∞ÅË£Ö‰∏Ä‰∏™ÁºìÂ≠òÂ∑•ÂÖ∑Á±ªÔºåÊª°Ë∂≥‰∏ãÂàóÈúÄÊ±ÇÔºö</p>
<ul>
<li>ÊñπÊ≥ï1ÔºöÂ∞Ü‰ªªÊÑèJavaÂØπË±°Â∫èÂàóÂåñ‰∏∫jsonÂπ∂Â≠òÂÇ®Âú®stringÁ±ªÂûãÁöÑkey‰∏≠ÔºåÂπ∂‰∏îÂèØ‰ª•ËÆæÁΩÆTTLËøáÊúüÊó∂Èó¥</li>
<li>ÊñπÊ≥ï2ÔºöÂ∞Ü‰ªªÊÑèJavaÂØπË±°Â∫èÂàóÂåñ‰∏∫jsonÂπ∂Â≠òÂÇ®Âú®stringÁ±ªÂûãÁöÑkey‰∏≠ÔºåÂπ∂‰∏îÂèØ‰ª•ËÆæÁΩÆÈÄªËæëËøáÊúüÊó∂Èó¥ÔºåÁî®‰∫éÂ§ÑÁêÜÁºìÂ≠òÂáªÁ©øÈóÆÈ¢ò</li>
<li>ÊñπÊ≥ï3ÔºöÊ†πÊçÆÊåáÂÆöÁöÑkeyÊü•ËØ¢ÁºìÂ≠òÔºåÂπ∂ÂèçÂ∫èÂàóÂåñ‰∏∫ÊåáÂÆöÁ±ªÂûãÔºåÂà©Áî®ÁºìÂ≠òÁ©∫ÂÄºÁöÑÊñπÂºèËß£ÂÜ≥<strong>ÁºìÂ≠òÁ©øÈÄè</strong>ÈóÆÈ¢ò</li>
<li>ÊñπÊ≥ï4ÔºöÊ†πÊçÆÊåáÂÆöÁöÑkeyÊü•ËØ¢ÁºìÂ≠òÔºåÂπ∂ÂèçÂ∫èÂàóÂåñ‰∏∫ÊåáÂÆöÁ±ªÂûãÔºåÈúÄË¶ÅÂà©Áî®ÈÄªËæëËøáÊúüËß£ÂÜ≥<strong>ÁºìÂ≠òÂáªÁ©ø</strong>ÈóÆÈ¢ò</li>
</ul>
<p><strong>Â∞ÅË£ÖÊàêCacheClientÁ±ª</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheClient</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">CACHE_REBUILD_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">CacheClient</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">set</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), time, unit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWithLogicalExpire</span><span class="hljs-params">(String key, Object value, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-comment">// ËÆæÁΩÆÈÄªËæëËøáÊúü</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisData</span>();<br>        redisData.setData(value);<br>        redisData.setExpireTime(LocalDateTime.now().plusSeconds(unit.toSeconds(time)));<br>        <span class="hljs-comment">// ÂÜôÂÖ•Redis</span><br>        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(redisData));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithPassThrough</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(json)) &#123;<br>            <span class="hljs-comment">// 3.Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû</span><br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(json, type);<br>        &#125;<br>        <span class="hljs-comment">// Âà§Êñ≠ÂëΩ‰∏≠ÁöÑÊòØÂê¶ÊòØÁ©∫ÂÄº</span><br>        <span class="hljs-keyword">if</span> (json != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// ËøîÂõû‰∏Ä‰∏™ÈîôËØØ‰ø°ÊÅØ</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 4.‰∏çÂ≠òÂú®ÔºåÊ†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>        <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®ÔºåËøîÂõûÈîôËØØ</span><br>        <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// Â∞ÜÁ©∫ÂÄºÂÜôÂÖ•redis</span><br>            stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>            <span class="hljs-comment">// ËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 6.Â≠òÂú®ÔºåÂÜôÂÖ•redis</span><br>        <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithLogicalExpire</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isBlank(json)) &#123;<br>            <span class="hljs-comment">// 3.Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// 4.ÂëΩ‰∏≠ÔºåÈúÄË¶ÅÂÖàÊääjsonÂèçÂ∫èÂàóÂåñ‰∏∫ÂØπË±°</span><br>        <span class="hljs-type">RedisData</span> <span class="hljs-variable">redisData</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, RedisData.class);<br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> JSONUtil.toBean((JSONObject) redisData.getData(), type);<br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">expireTime</span> <span class="hljs-operator">=</span> redisData.getExpireTime();<br>        <span class="hljs-comment">// 5.Âà§Êñ≠ÊòØÂê¶ËøáÊúü</span><br>        <span class="hljs-keyword">if</span> (expireTime.isAfter(LocalDateTime.now())) &#123;<br>            <span class="hljs-comment">// 5.1.Êú™ËøáÊúüÔºåÁõ¥Êé•ËøîÂõûÂ∫óÈì∫‰ø°ÊÅØ</span><br>            <span class="hljs-keyword">return</span> r;<br>        &#125;<br>        <span class="hljs-comment">// 5.2.Â∑≤ËøáÊúüÔºåÈúÄË¶ÅÁºìÂ≠òÈáçÂª∫</span><br>        <span class="hljs-comment">// 6.ÁºìÂ≠òÈáçÂª∫</span><br>        <span class="hljs-comment">// 6.1.Ëé∑Âèñ‰∫íÊñ•ÈîÅ</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>        <span class="hljs-comment">// 6.2.Âà§Êñ≠ÊòØÂê¶Ëé∑ÂèñÈîÅÊàêÂäü</span><br>        <span class="hljs-keyword">if</span> (isLock) &#123;<br>            <span class="hljs-comment">// 6.3.ÊàêÂäüÔºåÂºÄÂêØÁã¨Á´ãÁ∫øÁ®ãÔºåÂÆûÁé∞ÁºìÂ≠òÈáçÂª∫</span><br>            CACHE_REBUILD_EXECUTOR.submit(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// Êü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>                    <span class="hljs-type">R</span> <span class="hljs-variable">newR</span> <span class="hljs-operator">=</span> dbFallback.apply(id);<br>                    <span class="hljs-comment">// ÈáçÂª∫ÁºìÂ≠ò</span><br>                    <span class="hljs-built_in">this</span>.setWithLogicalExpire(key, newR, time, unit);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    <span class="hljs-comment">// ÈáäÊîæÈîÅ</span><br>                    unlock(lockKey);<br>                &#125;<br>            &#125;);<br>        &#125;<br>        <span class="hljs-comment">// 6.4.ËøîÂõûËøáÊúüÁöÑÂïÜÈì∫‰ø°ÊÅØ</span><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> &lt;R, ID&gt; R <span class="hljs-title function_">queryWithMutex</span><span class="hljs-params">(</span><br><span class="hljs-params">            String keyPrefix, ID id, Class&lt;R&gt; type, Function&lt;ID, R&gt; dbFallback, Long time, TimeUnit unit)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> keyPrefix + id;<br>        <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>        <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>            <span class="hljs-comment">// 3.Â≠òÂú®ÔºåÁõ¥Êé•ËøîÂõû</span><br>            <span class="hljs-keyword">return</span> JSONUtil.toBean(shopJson, type);<br>        &#125;<br>        <span class="hljs-comment">// Âà§Êñ≠ÂëΩ‰∏≠ÁöÑÊòØÂê¶ÊòØÁ©∫ÂÄº</span><br>        <span class="hljs-keyword">if</span> (shopJson != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// ËøîÂõû‰∏Ä‰∏™ÈîôËØØ‰ø°ÊÅØ</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 4.ÂÆûÁé∞ÁºìÂ≠òÈáçÂª∫</span><br>        <span class="hljs-comment">// 4.1.Ëé∑Âèñ‰∫íÊñ•ÈîÅ</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> LOCK_SHOP_KEY + id;<br>        <span class="hljs-type">R</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> tryLock(lockKey);<br>            <span class="hljs-comment">// 4.2.Âà§Êñ≠ÊòØÂê¶Ëé∑ÂèñÊàêÂäü</span><br>            <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                <span class="hljs-comment">// 4.3.Ëé∑ÂèñÈîÅÂ§±Ë¥•Ôºå‰ºëÁú†Âπ∂ÈáçËØï</span><br>                Thread.sleep(<span class="hljs-number">50</span>);<br>                <span class="hljs-keyword">return</span> queryWithMutex(keyPrefix, id, type, dbFallback, time, unit);<br>            &#125;<br>            <span class="hljs-comment">// 4.4.Ëé∑ÂèñÈîÅÊàêÂäüÔºåÊ†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>            r = dbFallback.apply(id);<br>            <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®ÔºåËøîÂõûÈîôËØØ</span><br>            <span class="hljs-keyword">if</span> (r == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Â∞ÜÁ©∫ÂÄºÂÜôÂÖ•redis</span><br>                stringRedisTemplate.opsForValue().set(key, <span class="hljs-string">&quot;&quot;</span>, CACHE_NULL_TTL, TimeUnit.MINUTES);<br>                <span class="hljs-comment">// ËøîÂõûÈîôËØØ‰ø°ÊÅØ</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-comment">// 6.Â≠òÂú®ÔºåÂÜôÂÖ•redis</span><br>            <span class="hljs-built_in">this</span>.set(key, r, time, unit);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 7.ÈáäÊîæÈîÅ</span><br>            unlock(lockKey);<br>        &#125;<br>        <span class="hljs-comment">// 8.ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String key)</span> &#123;<br>        <span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().setIfAbsent(key, <span class="hljs-string">&quot;1&quot;</span>, <span class="hljs-number">10</span>, TimeUnit.SECONDS);<br>        <span class="hljs-keyword">return</span> BooleanUtil.isTrue(flag);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String key)</span> &#123;<br>        stringRedisTemplate.delete(key);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="3-‰ºòÊÉ†Âà∏ÁßíÊùÄ"><a href="#3-‰ºòÊÉ†Âà∏ÁßíÊùÄ" class="headerlink" title="3. ‰ºòÊÉ†Âà∏ÁßíÊùÄ"></a>3. ‰ºòÊÉ†Âà∏ÁßíÊùÄ</h2><h3 id="3-1-ÂÖ®Â±ÄÂîØ‰∏ÄID"><a href="#3-1-ÂÖ®Â±ÄÂîØ‰∏ÄID" class="headerlink" title="3.1 ÂÖ®Â±ÄÂîØ‰∏ÄID"></a>3.1 ÂÖ®Â±ÄÂîØ‰∏ÄID</h3><p>ÂΩìÁî®Êà∑Êä¢Ë¥≠Êó∂ÔºåÂ∞±‰ºöÁîüÊàêËÆ¢ÂçïÂπ∂‰øùÂ≠òÂà∞tb_voucher_orderËøôÂº†Ë°®‰∏≠ÔºåËÄåËÆ¢ÂçïË°®Â¶ÇÊûú‰ΩøÁî®Êï∞ÊçÆÂ∫ìËá™Â¢ûIDÂ∞±Â≠òÂú®‰∏Ä‰∫õÈóÆÈ¢òÔºö</p>
<ul>
<li>idÁöÑËßÑÂæãÊÄßÂ§™ÊòéÊòæ</li>
<li>ÂèóÂçïË°®Êï∞ÊçÆÈáèÁöÑÈôêÂà∂</li>
</ul>
<p><strong>ÂÖ®Â±ÄIDÁîüÊàêÂô®</strong>ÔºåÊòØ‰∏ÄÁßçÂú®ÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰∏ãÁî®Êù•ÁîüÊàêÂÖ®Â±ÄÂîØ‰∏ÄIDÁöÑÂ∑•ÂÖ∑Ôºå‰∏ÄËà¨Ë¶ÅÊª°Ë∂≥‰∏ãÂàóÁâπÊÄßÔºö</p>
<ul>
<li>ÂîØ‰∏ÄÊÄß</li>
<li>È´òÂèØÁî®</li>
<li>È´òÊÄßËÉΩ</li>
<li>ÈÄíÂ¢ûÊÄß</li>
<li>ÂÆâÂÖ®ÊÄß</li>
</ul>
<ul>
<li>‰∏∫‰∫ÜÂ¢ûÂä†IDÁöÑÂÆâÂÖ®ÊÄßÔºåÊàë‰ª¨ÂèØ‰ª•‰∏çÁõ¥Êé•‰ΩøÁî®RedisËá™Â¢ûÁöÑÊï∞ÂÄºÔºåËÄåÊòØÊãºÊé•‰∏Ä‰∫õÂÖ∂ÂÆÉ‰ø°ÊÅØÔºö<ul>
<li>IDÁöÑÁªÑÊàêÈÉ®ÂàÜÔºöÁ¨¶Âè∑‰ΩçÔºö1bitÔºåÊ∞∏Ëøú‰∏∫0</li>
<li>Êó∂Èó¥Êà≥Ôºö31bitÔºå‰ª•Áßí‰∏∫Âçï‰ΩçÔºåÂèØ‰ª•‰ΩøÁî®69Âπ¥</li>
<li>Â∫èÂàóÂè∑Ôºö32bitÔºåÁßíÂÜÖÁöÑËÆ°Êï∞Âô®ÔºåÊîØÊåÅÊØèÁßí‰∫ßÁîü2^32‰∏™‰∏çÂêåID</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/redis/2.3.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>RedisÂÆûÁé∞ÂÖ®Â±ÄÂîØ‰∏ÄId</strong>Ôºö </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisIdWorker</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ÂºÄÂßãÊó∂Èó¥Êà≥</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">BEGIN_TIMESTAMP</span> <span class="hljs-operator">=</span> <span class="hljs-number">1640995200L</span>;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Â∫èÂàóÂè∑ÁöÑ‰ΩçÊï∞</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">COUNT_BITS</span> <span class="hljs-operator">=</span> <span class="hljs-number">32</span>;<br><br>    <span class="hljs-keyword">private</span> StringRedisTemplate stringRedisTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisIdWorker</span><span class="hljs-params">(StringRedisTemplate stringRedisTemplate)</span> &#123;<br>        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">nextId</span><span class="hljs-params">(String keyPrefix)</span> &#123;<br>        <span class="hljs-comment">// 1.ÁîüÊàêÊó∂Èó¥Êà≥</span><br>        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">nowSecond</span> <span class="hljs-operator">=</span> now.toEpochSecond(ZoneOffset.UTC);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> nowSecond - BEGIN_TIMESTAMP;<br><br>        <span class="hljs-comment">// 2.ÁîüÊàêÂ∫èÂàóÂè∑</span><br>        <span class="hljs-comment">// 2.1.Ëé∑ÂèñÂΩìÂâçÊó•ÊúüÔºåÁ≤æÁ°ÆÂà∞Â§©</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">date</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;yyyy:MM:dd&quot;</span>));<br>        <span class="hljs-comment">// 2.2.Ëá™Â¢ûÈïø</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().increment(<span class="hljs-string">&quot;icr:&quot;</span> + keyPrefix + <span class="hljs-string">&quot;:&quot;</span> + date);<br><br>        <span class="hljs-comment">// 3.ÊãºÊé•Âπ∂ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> timestamp &lt;&lt; COUNT_BITS | count;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-2-Ê∑ªÂä†‰ºòÊÉ†Âà∏-ÂÆûÁé∞ÁßíÊùÄ‰∏ãÂçï"><a href="#3-2-Ê∑ªÂä†‰ºòÊÉ†Âà∏-ÂÆûÁé∞ÁßíÊùÄ‰∏ãÂçï" class="headerlink" title="3.2 Ê∑ªÂä†‰ºòÊÉ†Âà∏&amp;ÂÆûÁé∞ÁßíÊùÄ‰∏ãÂçï"></a>3.2 Ê∑ªÂä†‰ºòÊÉ†Âà∏&amp;ÂÆûÁé∞ÁßíÊùÄ‰∏ãÂçï</h3><p>ÊØè‰∏™Â∫óÈì∫ÈÉΩÂèØ‰ª•ÂèëÂ∏É‰ºòÊÉ†Âà∏ÔºåÂàÜ‰∏∫Âπ≥‰ª∑Âà∏ÂíåÁâπ‰ª∑Âà∏„ÄÇÂπ≥‰ª∑Âà∏ÂèØ‰ª•‰ªªÊÑèË¥≠‰π∞ÔºåËÄåÁâπ‰ª∑Âà∏ÈúÄË¶ÅÁßíÊùÄÊä¢Ë¥≠Ôºö</p>
<p><img src="/img/blogs/java/redis/2.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ÂÆûÁé∞ÁßíÊùÄ‰∏ãÂçï</strong>Ôºö</p>
<p><img src="/img/blogs/java/redis/2.3.3.png" srcset="/img/loading.gif" lazyload></p>
<p>‰∏ãÂçïÊó∂ÈúÄË¶ÅÂà§Êñ≠‰∏§ÁÇπÔºö</p>
<ul>
<li>ÁßíÊùÄÊòØÂê¶ÂºÄÂßãÊàñÁªìÊùüÔºåÂ¶ÇÊûúÂ∞öÊú™ÂºÄÂßãÊàñÂ∑≤ÁªèÁªìÊùüÂàôÊó†Ê≥ï‰∏ãÂçï</li>
<li>Â∫ìÂ≠òÊòØÂê¶ÂÖÖË∂≥Ôºå‰∏çË∂≥ÂàôÊó†Ê≥ï‰∏ãÂçï</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">// 1.Êü•ËØ¢‰ºòÊÉ†Âà∏</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">voucher</span> <span class="hljs-operator">=</span> seckillVoucherService.getById(voucherId);<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÁßíÊùÄÊòØÂê¶ÂºÄÂßã</span><br>    <span class="hljs-keyword">if</span> (voucher.getBeginTime().isAfter(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// Â∞öÊú™ÂºÄÂßã</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ÁßíÊùÄÂ∞öÊú™ÂºÄÂßãÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.Âà§Êñ≠ÁßíÊùÄÊòØÂê¶Â∑≤ÁªèÁªìÊùü</span><br>    <span class="hljs-keyword">if</span> (voucher.getEndTime().isBefore(LocalDateTime.now())) &#123;<br>        <span class="hljs-comment">// Â∞öÊú™ÂºÄÂßã</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;ÁßíÊùÄÂ∑≤ÁªèÁªìÊùüÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 4.Âà§Êñ≠Â∫ìÂ≠òÊòØÂê¶ÂÖÖË∂≥</span><br>    <span class="hljs-keyword">if</span> (voucher.getStock() &lt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// Â∫ìÂ≠ò‰∏çË∂≥</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Â∫ìÂ≠ò‰∏çË∂≥ÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//5ÔºåÊâ£ÂáèÂ∫ìÂ≠ò</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update();<br>    <span class="hljs-keyword">if</span> (!success) &#123;<br>        <span class="hljs-comment">//Êâ£ÂáèÂ∫ìÂ≠ò</span><br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Â∫ìÂ≠ò‰∏çË∂≥ÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.ÂàõÂª∫ËÆ¢Âçï</span><br>    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>    <span class="hljs-comment">// 6.1.ËÆ¢Âçïid</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    voucherOrder.setId(orderId);<br>    <span class="hljs-comment">// 6.2.Áî®Êà∑id</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    voucherOrder.setUserId(userId);<br>    <span class="hljs-comment">// 6.3.‰ª£ÈáëÂà∏id</span><br>    voucherOrder.setVoucherId(voucherId);<br>    save(voucherOrder);<br><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-3-Â∫ìÂ≠òË∂ÖÂçñÈóÆÈ¢ò-Â§öÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò"><a href="#3-3-Â∫ìÂ≠òË∂ÖÂçñÈóÆÈ¢ò-Â§öÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò" class="headerlink" title="3.3 Â∫ìÂ≠òË∂ÖÂçñÈóÆÈ¢ò(Â§öÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò)"></a>3.3 Â∫ìÂ≠òË∂ÖÂçñÈóÆÈ¢ò(Â§öÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò)</h3><p>ÂÅáËÆæÁ∫øÁ®ã1ËøáÊù•Êü•ËØ¢Â∫ìÂ≠òÔºåÂà§Êñ≠Âá∫Êù•Â∫ìÂ≠òÂ§ß‰∫é1ÔºåÊ≠£ÂáÜÂ§áÂéªÊâ£ÂáèÂ∫ìÂ≠òÔºå‰ΩÜÊòØËøòÊ≤°ÊúâÊù•ÂæóÂèäÂéªÊâ£ÂáèÔºåÊ≠§Êó∂Á∫øÁ®ã2ËøáÊù•ÔºåÁ∫øÁ®ã2‰πüÂéªÊü•ËØ¢Â∫ìÂ≠òÔºåÂèëÁé∞Ëøô‰∏™Êï∞Èáè‰∏ÄÂÆö‰πüÂ§ß‰∫é1ÔºåÈÇ£‰πàËøô‰∏§‰∏™Á∫øÁ®ãÈÉΩ‰ºöÂéªÊâ£ÂáèÂ∫ìÂ≠òÔºåÊúÄÁªàÂ§ö‰∏™Á∫øÁ®ãÁõ∏ÂΩì‰∫é‰∏ÄËµ∑ÂéªÊâ£ÂáèÂ∫ìÂ≠òÔºåÊ≠§Êó∂Â∞±‰ºöÂá∫Áé∞Â∫ìÂ≠òÁöÑË∂ÖÂçñÈóÆÈ¢ò„ÄÇ</p>
<p><img src="/img/blogs/java/redis/2.3.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-3-1-Ëß£ÂÜ≥ÊñπÊ°à-Âä†ÈîÅ"><a href="#3-3-1-Ëß£ÂÜ≥ÊñπÊ°à-Âä†ÈîÅ" class="headerlink" title="3.3.1 Ëß£ÂÜ≥ÊñπÊ°à(Âä†ÈîÅ)"></a>3.3.1 Ëß£ÂÜ≥ÊñπÊ°à(Âä†ÈîÅ)</h4><p><strong>ÊÇ≤ËßÇÈîÅÔºö</strong></p>
<ul>
<li>ËÆ§‰∏∫Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò‰∏ÄÂÆö‰ºöÂèëÁîüÔºåÂõ†Ê≠§Âú®Êìç‰ΩúÊï∞ÊçÆ‰πãÂâçÂÖàËé∑ÂèñÈîÅÔºåÁ°Æ‰øùÁ∫øÁ®ã‰∏≤Ë°åÊâßË°å„ÄÇ</li>
<li>‰æãÂ¶ÇSynchronized„ÄÅLockÈÉΩÂ±û‰∫éÊÇ≤ËßÇÈîÅ</li>
</ul>
<p><strong>‰πêËßÇÈîÅÔºö</strong></p>
<ul>
<li>ËÆ§‰∏∫Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò‰∏ç‰∏ÄÂÆö‰ºöÂèëÁîüÔºåÂõ†Ê≠§‰∏çÂä†ÈîÅÔºåÂè™ÊòØÂú®Êõ¥Êñ∞Êï∞ÊçÆÊó∂ÂéªÂà§Êñ≠ÊúâÊ≤°ÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÂØπÊï∞ÊçÆÂÅö‰∫Ü‰øÆÊîπ„ÄÇ</li>
<li>Â¶ÇÊûúÊ≤°Êúâ‰øÆÊîπÂàôËÆ§‰∏∫ÊòØÂÆâÂÖ®ÁöÑÔºåËá™Â∑±ÊâçÊõ¥Êñ∞Êï∞ÊçÆ„ÄÇ</li>
<li>Â¶ÇÊûúÂ∑≤ÁªèË¢´ÂÖ∂ÂÆÉÁ∫øÁ®ã‰øÆÊîπËØ¥ÊòéÂèëÁîü‰∫ÜÂÆâÂÖ®ÈóÆÈ¢òÔºåÊ≠§Êó∂ÂèØ‰ª•ÈáçËØïÊàñÂºÇÂ∏∏</li>
</ul>
<h4 id="3-3-2-Âü∫‰∫é‰πêËßÇÈîÅ-CAS-ÁöÑËß£ÂÜ≥ÊñπÊ°à"><a href="#3-3-2-Âü∫‰∫é‰πêËßÇÈîÅ-CAS-ÁöÑËß£ÂÜ≥ÊñπÊ°à" class="headerlink" title="3.3.2 Âü∫‰∫é‰πêËßÇÈîÅ(CAS)ÁöÑËß£ÂÜ≥ÊñπÊ°à"></a>3.3.2 Âü∫‰∫é‰πêËßÇÈîÅ(CAS)ÁöÑËß£ÂÜ≥ÊñπÊ°à</h4><p><img src="/img/blogs/java/redis/2.3.5.png" srcset="/img/loading.gif" lazyload></p>
<p>Âè™Ë¶ÅÊàëÊâ£ÂáèÂ∫ìÂ≠òÊó∂ÁöÑÂ∫ìÂ≠òÂíå‰πãÂâçÊàëÊü•ËØ¢Âà∞ÁöÑÂ∫ìÂ≠òÊòØ‰∏ÄÊ†∑ÁöÑÔºåÂ∞±ÊÑèÂë≥ÁùÄÊ≤°Êúâ‰∫∫Âú®‰∏≠Èó¥‰øÆÊîπËøáÂ∫ìÂ≠òÔºåÈÇ£‰πàÊ≠§Êó∂Â∞±ÊòØÂÆâÂÖ®ÁöÑ„ÄÇÊàë‰ª¨ÁöÑ‰πêËßÇÈîÅÈúÄË¶ÅÂèò‰∏Ä‰∏ãÔºåÊîπÊàêstockÂ§ß‰∫é0 Âç≥ÂèØ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="hljs-string">&quot;stock&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">//where id = ? and stock &gt; 0</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-ÊÄªÁªì"><a href="#3-3-3-ÊÄªÁªì" class="headerlink" title="3.3.3 ÊÄªÁªì"></a>3.3.3 ÊÄªÁªì</h4><p>Ë∂ÖÂçñËøôÊ†∑ÁöÑÁ∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºåËß£ÂÜ≥ÊñπÊ°àÊúâÂì™‰∫õÔºü</p>
<ul>
<li>ÊÇ≤ËßÇÈîÅÔºöÊ∑ªÂä†ÂêåÊ≠•ÈîÅÔºåËÆ©Á∫øÁ®ã‰∏≤Ë°åÊâßË°å<ul>
<li>‰ºòÁÇπÔºöÁÆÄÂçïÁ≤óÊö¥</li>
<li>Áº∫ÁÇπÔºöÊÄßËÉΩ‰∏ÄËà¨</li>
</ul>
</li>
<li>‰πêËßÇÈîÅÔºö‰∏çÂä†ÈîÅÔºåÂú®Êõ¥Êñ∞Êó∂Âà§Êñ≠ÊòØÂê¶ÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÂú®‰øÆÊîπ<ul>
<li>‰ºòÁÇπÔºöÊÄßËÉΩÂ•Ω</li>
<li>Áº∫ÁÇπÔºöÂ≠òÂú®ÊàêÂäüÁéá‰ΩéÁöÑÈóÆÈ¢ò</li>
</ul>
</li>
</ul>
<h3 id="3-4-‰∏Ä‰∫∫‰∏ÄÂçï"><a href="#3-4-‰∏Ä‰∫∫‰∏ÄÂçï" class="headerlink" title="3.4 ‰∏Ä‰∫∫‰∏ÄÂçï"></a>3.4 ‰∏Ä‰∫∫‰∏ÄÂçï</h3><p>‰øÆÊîπÁßíÊùÄ‰∏öÂä°ÔºåË¶ÅÊ±Ç<strong>Âêå‰∏Ä‰∏™‰ºòÊÉ†Âà∏Ôºå‰∏Ä‰∏™Áî®Êà∑Âè™ËÉΩ‰∏ã‰∏ÄÂçï</strong></p>
<p><img src="/img/blogs/java/redis/2.3.6.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 5.1.Êü•ËØ¢ËÆ¢Âçï</span><br>   <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).count();<br>   <span class="hljs-comment">// 5.2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>   <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>       <span class="hljs-comment">// Áî®Êà∑Â∑≤ÁªèË¥≠‰π∞Ëøá‰∫Ü</span><br>       <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Áî®Êà∑Â∑≤ÁªèË¥≠‰π∞Ëøá‰∏ÄÊ¨°ÔºÅ&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>‰∏∫‰∫ÜÁ°Æ‰øùÁ∫øÁ®ãÂÆâÂÖ®ÔºåÂú®ÊñπÊ≥ï‰∏äÊ∑ªÂä†‰∫Ü‰∏ÄÊääsynchronized ÈîÅ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> Result <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(Long voucherId)</span> &#123;&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-5-ÈõÜÁæ§ÁéØÂ¢É‰∏ã‰∏Ä‰∫∫‰∏ÄÂçïÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢ò"><a href="#3-5-ÈõÜÁæ§ÁéØÂ¢É‰∏ã‰∏Ä‰∫∫‰∏ÄÂçïÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢ò" class="headerlink" title="3.5 ÈõÜÁæ§ÁéØÂ¢É‰∏ã‰∏Ä‰∫∫‰∏ÄÂçïÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢ò"></a>3.5 ÈõÜÁæ§ÁéØÂ¢É‰∏ã‰∏Ä‰∫∫‰∏ÄÂçïÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢ò</h3><p>ÈÄöËøáÂä†ÈîÅÂèØ‰ª•Ëß£ÂÜ≥Âú®ÂçïÊú∫ÊÉÖÂÜµ‰∏ãÁöÑ‰∏Ä‰∫∫‰∏ÄÂçïÂÆâÂÖ®ÈóÆÈ¢òÔºå‰ΩÜÊòØ<strong>Âú®ÈõÜÁæ§Ê®°Âºè‰∏ãÂ∞±‰∏çË°å‰∫Ü</strong></p>
<p>Áî±‰∫éÁé∞Âú®Êàë‰ª¨ÈÉ®ÁΩ≤‰∫ÜÂ§ö‰∏™tomcatÔºå<strong>ÊØè‰∏™tomcatÈÉΩÊúâ‰∏Ä‰∏™Â±û‰∫éËá™Â∑±ÁöÑjvm</strong>Ôºå<strong>ÊØè‰∏™JVMÈÉΩÊúâÂêÑËá™ÁöÑÈîÅÁõëËßÜÂô®ÔºåÂØºËá¥‰∏çÂêåJVMÁöÑÈîÅÂú®‰∏çÂêåÁöÑÈîÅÁõëËßÜÂô®‰∏≠</strong>„ÄÇÈÇ£‰πàÂÅáËÆæÂú®ÊúçÂä°Âô®AÁöÑtomcatÂÜÖÈÉ®ÔºåÊúâ‰∏§‰∏™Á∫øÁ®ãÔºåËøô‰∏§‰∏™Á∫øÁ®ãÁî±‰∫é‰ΩøÁî®ÁöÑÊòØÂêå‰∏Ä‰ªΩ‰ª£Á†ÅÔºåÈÇ£‰πà‰ªñ‰ª¨ÁöÑÈîÅÂØπË±°ÊòØÂêå‰∏Ä‰∏™ÔºåÊòØÂèØ‰ª•ÂÆûÁé∞‰∫íÊñ•ÁöÑÔºå‰ΩÜÊòØÂ¶ÇÊûúÁé∞Âú®ÊòØÊúçÂä°Âô®BÁöÑtomcatÂÜÖÈÉ®ÔºåÂèàÊúâ‰∏§‰∏™Á∫øÁ®ãÔºå‰ΩÜÊòØ‰ªñ‰ª¨ÁöÑÈîÅÂØπË±°ÂÜôÁöÑËôΩÁÑ∂ÂíåÊúçÂä°Âô®A‰∏ÄÊ†∑Ôºå‰ΩÜÊòØÈîÅÂØπË±°Âç¥‰∏çÊòØÂêå‰∏Ä‰∏™ÔºåÊâÄ‰ª•Á∫øÁ®ã3ÂíåÁ∫øÁ®ã4ÂèØ‰ª•ÂÆûÁé∞‰∫íÊñ•Ôºå‰ΩÜÊòØÂç¥Êó†Ê≥ïÂíåÁ∫øÁ®ã1ÂíåÁ∫øÁ®ã2ÂÆûÁé∞‰∫íÊñ•ÔºåËøôÂ∞±ÊòØ ÈõÜÁæ§ÁéØÂ¢É‰∏ãÔºåsynÈîÅÂ§±ÊïàÁöÑÂéüÂõ†ÔºåÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÊàë‰ª¨Â∞±ÈúÄË¶Å‰ΩøÁî®ÂàÜÂ∏ÉÂºèÈîÅÊù•Ëß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢ò„ÄÇ</p>
<p><img src="/img/blogs/java/redis/2.3.7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-6-ÁßíÊùÄ‰ºòÂåñ-ÂºÇÊ≠•ÁßíÊùÄ"><a href="#3-6-ÁßíÊùÄ‰ºòÂåñ-ÂºÇÊ≠•ÁßíÊùÄ" class="headerlink" title="3.6 ÁßíÊùÄ‰ºòÂåñ-ÂºÇÊ≠•ÁßíÊùÄ"></a>3.6 ÁßíÊùÄ‰ºòÂåñ-ÂºÇÊ≠•ÁßíÊùÄ</h3><ul>
<li>Êàë‰ª¨Â∞ÜËÄóÊó∂ÊØîËæÉÁü≠ÁöÑÈÄªËæëÂà§Êñ≠ÊîæÂÖ•Âà∞redis‰∏≠ÔºåÊØîÂ¶ÇÊòØÂê¶Â∫ìÂ≠òË∂≥Â§üÔºåÊØîÂ¶ÇÊòØÂê¶‰∏Ä‰∫∫‰∏ÄÂçïÔºåËøôÊ†∑ÁöÑÊìç‰ΩúÔºåÂè™Ë¶ÅËøôÁßçÈÄªËæëÂèØ‰ª•ÂÆåÊàêÔºåÂ∞±ÊÑèÂë≥ÁùÄÊàë‰ª¨ÊòØ‰∏ÄÂÆöÂèØ‰ª•‰∏ãÂçïÂÆåÊàêÁöÑÔºåÊàë‰ª¨Âè™ÈúÄË¶ÅËøõË°åÂø´ÈÄüÁöÑÈÄªËæëÂà§Êñ≠ÔºåÊ†πÊú¨Â∞±‰∏çÁî®Á≠â‰∏ãÂçïÈÄªËæëËµ∞ÂÆåÔºåÊàë‰ª¨Áõ¥Êé•ÁªôÁî®Êà∑ËøîÂõûÊàêÂäü</li>
<li>ÂÜçÂú®ÂêéÂè∞ÂºÄ‰∏Ä‰∏™Á∫øÁ®ãÔºåÂêéÂè∞Á∫øÁ®ãÊÖ¢ÊÖ¢ÁöÑÂéªÊâßË°åqueueÈáåËæπÁöÑÊ∂àÊÅØ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.3.8.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/redis/2.3.9.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li><p>ÂΩìÁî®Êà∑‰∏ãÂçï‰πãÂêéÔºåÂà§Êñ≠Â∫ìÂ≠òÊòØÂê¶ÂÖÖË∂≥Âè™ÈúÄË¶ÅÂØºredis‰∏≠ÂéªÊ†πÊçÆkeyÊâæÂØπÂ∫îÁöÑvalueÊòØÂê¶Â§ß‰∫é0Âç≥ÂèØÔºåÂ¶ÇÊûú‰∏çÂÖÖË∂≥ÔºåÂàôÁõ¥Êé•ÁªìÊùüÔºåÂ¶ÇÊûúÂÖÖË∂≥ÔºåÁªßÁª≠Âú®redis‰∏≠Âà§Êñ≠Áî®Êà∑ÊòØÂê¶ÂèØ‰ª•‰∏ãÂçïÔºåÂ¶ÇÊûúsetÈõÜÂêà‰∏≠Ê≤°ÊúâËøôÊù°Êï∞ÊçÆÔºåËØ¥Êòé‰ªñÂèØ‰ª•‰∏ãÂçïÔºåÂ¶ÇÊûúsetÈõÜÂêà‰∏≠Ê≤°ÊúâËøôÊù°ËÆ∞ÂΩïÔºåÂàôÂ∞ÜuserIdÂíå‰ºòÊÉ†Âç∑Â≠òÂÖ•Âà∞redis‰∏≠ÔºåÂπ∂‰∏îËøîÂõû0ÔºåÊï¥‰∏™ËøáÁ®ãÈúÄË¶Å‰øùËØÅÊòØÂéüÂ≠êÊÄßÁöÑÔºåÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®luaÊù•Êìç‰Ωú</p>
</li>
<li><p>ÂΩì‰ª•‰∏äÂà§Êñ≠ÈÄªËæëËµ∞ÂÆå‰πãÂêéÔºåÊàë‰ª¨ÂèØ‰ª•Âà§Êñ≠ÂΩìÂâçredis‰∏≠ËøîÂõûÁöÑÁªìÊûúÊòØÂê¶ÊòØ0 ÔºåÂ¶ÇÊûúÊòØ0ÔºåÂàôË°®Á§∫ÂèØ‰ª•‰∏ãÂçïÔºåÂàôÂ∞Ü‰πãÂâçËØ¥ÁöÑ‰ø°ÊÅØÂ≠òÂÖ•Âà∞Âà∞queue‰∏≠ÂéªÔºåÁÑ∂ÂêéËøîÂõûÔºåÁÑ∂ÂêéÂÜçÊù•‰∏™Á∫øÁ®ãÂºÇÊ≠•ÁöÑ‰∏ãÂçïÔºåÂâçÁ´ØÂèØ‰ª•ÈÄöËøáËøîÂõûÁöÑËÆ¢ÂçïidÊù•Âà§Êñ≠ÊòØÂê¶‰∏ãÂçïÊàêÂäü„ÄÇ</p>
</li>
</ol>
<h3 id="3-7-ÁßíÊùÄ‰ºòÂåñ-RedisÂÆåÊàêÁßíÊùÄËµÑÊ†ºÂà§Êñ≠"><a href="#3-7-ÁßíÊùÄ‰ºòÂåñ-RedisÂÆåÊàêÁßíÊùÄËµÑÊ†ºÂà§Êñ≠" class="headerlink" title="3.7 ÁßíÊùÄ‰ºòÂåñ-RedisÂÆåÊàêÁßíÊùÄËµÑÊ†ºÂà§Êñ≠"></a>3.7 ÁßíÊùÄ‰ºòÂåñ-RedisÂÆåÊàêÁßíÊùÄËµÑÊ†ºÂà§Êñ≠</h3><p>ÈúÄÊ±ÇÔºö</p>
<ol>
<li><p>Êñ∞Â¢ûÁßíÊùÄ‰ºòÊÉ†Âà∏ÁöÑÂêåÊó∂ÔºåÂ∞Ü‰ºòÊÉ†Âà∏‰ø°ÊÅØ‰øùÂ≠òÂà∞Redis‰∏≠</p>
</li>
<li><p>Âü∫‰∫éLuaËÑöÊú¨ÔºåÂà§Êñ≠ÁßíÊùÄÂ∫ìÂ≠ò„ÄÅ‰∏Ä‰∫∫‰∏ÄÂçïÔºåÂÜ≥ÂÆöÁî®Êà∑ÊòØÂê¶Êä¢Ë¥≠ÊàêÂäü</p>
</li>
<li><p>Â¶ÇÊûúÊä¢Ë¥≠ÊàêÂäüÔºåÂ∞Ü‰ºòÊÉ†Âà∏idÂíåÁî®Êà∑idÂ∞ÅË£ÖÂêéÂ≠òÂÖ•ÈòªÂ°ûÈòüÂàó</p>
</li>
<li><p>ÂºÄÂêØÁ∫øÁ®ã‰ªªÂä°Ôºå‰∏çÊñ≠‰ªéÈòªÂ°ûÈòüÂàó‰∏≠Ëé∑Âèñ‰ø°ÊÅØÔºåÂÆûÁé∞ÂºÇÊ≠•‰∏ãÂçïÂäüËÉΩ</p>
</li>
<li><p>Êñ∞Â¢ûÁßíÊùÄ‰ºòÊÉ†Âà∏ÁöÑÂêåÊó∂ÔºåÂ∞Ü‰ºòÊÉ†Âà∏‰ø°ÊÅØ‰øùÂ≠òÂà∞Redis‰∏≠</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addSeckillVoucher</span><span class="hljs-params">(Voucher voucher)</span> &#123;<br>    <span class="hljs-comment">// ‰øùÂ≠ò‰ºòÊÉ†Âà∏</span><br>    save(voucher);<br>    <span class="hljs-comment">// ‰øùÂ≠òÁßíÊùÄ‰ø°ÊÅØ</span><br>    <span class="hljs-type">SeckillVoucher</span> <span class="hljs-variable">seckillVoucher</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeckillVoucher</span>();<br>    seckillVoucher.setVoucherId(voucher.getId());<br>    seckillVoucher.setStock(voucher.getStock());<br>    seckillVoucher.setBeginTime(voucher.getBeginTime());<br>    seckillVoucher.setEndTime(voucher.getEndTime());<br>    seckillVoucherService.save(seckillVoucher);<br>    <span class="hljs-comment">// ‰øùÂ≠òÁßíÊùÄÂ∫ìÂ≠òÂà∞Redis‰∏≠</span><br>    <span class="hljs-comment">//SECKILL_STOCK_KEY Ëøô‰∏™ÂèòÈáèÂÆö‰πâÂú®RedisConstans‰∏≠</span><br>    <span class="hljs-comment">//private static final String SECKILL_STOCK_KEY =&quot;seckill:stock:&quot;</span><br>    stringRedisTemplate.opsForValue().set(SECKILL_STOCK_KEY + voucher.getId(), voucher.getStock().toString());<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>Âü∫‰∫éLuaËÑöÊú¨ÔºåÂà§Êñ≠ÁßíÊùÄÂ∫ìÂ≠ò„ÄÅ‰∏Ä‰∫∫‰∏ÄÂçïÔºåÂÜ≥ÂÆöÁî®Êà∑ÊòØÂê¶Êä¢Ë¥≠ÊàêÂäü</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- 1.ÂèÇÊï∞ÂàóË°®</span><br><span class="hljs-comment">-- 1.1.‰ºòÊÉ†Âà∏id</span><br><span class="hljs-keyword">local</span> voucherId = ARGV[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- 1.2.Áî®Êà∑id</span><br><span class="hljs-keyword">local</span> userId = ARGV[<span class="hljs-number">2</span>]<br><span class="hljs-comment">-- 1.3.ËÆ¢Âçïid</span><br><span class="hljs-keyword">local</span> orderId = ARGV[<span class="hljs-number">3</span>]<br><br><span class="hljs-comment">-- 2.Êï∞ÊçÆkey</span><br><span class="hljs-comment">-- 2.1.Â∫ìÂ≠òkey</span><br><span class="hljs-keyword">local</span> stockKey = <span class="hljs-string">&#x27;seckill:stock:&#x27;</span> .. voucherId<br><span class="hljs-comment">-- 2.2.ËÆ¢Âçïkey</span><br><span class="hljs-keyword">local</span> orderKey = <span class="hljs-string">&#x27;seckill:order:&#x27;</span> .. voucherId<br><br><span class="hljs-comment">-- 3.ËÑöÊú¨‰∏öÂä°</span><br><span class="hljs-comment">-- 3.1.Âà§Êñ≠Â∫ìÂ≠òÊòØÂê¶ÂÖÖË∂≥ get stockKey</span><br><span class="hljs-keyword">if</span>(<span class="hljs-built_in">tonumber</span>(redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, stockKey)) &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 3.2.Â∫ìÂ≠ò‰∏çË∂≥ÔºåËøîÂõû1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.2.Âà§Êñ≠Áî®Êà∑ÊòØÂê¶‰∏ãÂçï SISMEMBER orderKey userId</span><br><span class="hljs-keyword">if</span>(redis.call(<span class="hljs-string">&#x27;sismember&#x27;</span>, orderKey, userId) == <span class="hljs-number">1</span>) <span class="hljs-keyword">then</span><br>    <span class="hljs-comment">-- 3.3.Â≠òÂú®ÔºåËØ¥ÊòéÊòØÈáçÂ§ç‰∏ãÂçïÔºåËøîÂõû2</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">2</span><br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- 3.4.Êâ£Â∫ìÂ≠ò incrby stockKey -1</span><br>redis.call(<span class="hljs-string">&#x27;incrby&#x27;</span>, stockKey, <span class="hljs-number">-1</span>)<br><span class="hljs-comment">-- 3.5.‰∏ãÂçïÔºà‰øùÂ≠òÁî®Êà∑Ôºâsadd orderKey userId</span><br>redis.call(<span class="hljs-string">&#x27;sadd&#x27;</span>, orderKey, userId)<br><span class="hljs-comment">-- 3.6.ÂèëÈÄÅÊ∂àÊÅØÂà∞ÈòüÂàó‰∏≠Ôºå XADD stream.orders * k1 v1 k2 v2 ...</span><br>redis.call(<span class="hljs-string">&#x27;xadd&#x27;</span>, <span class="hljs-string">&#x27;stream.orders&#x27;</span>, <span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-string">&#x27;userId&#x27;</span>, userId, <span class="hljs-string">&#x27;voucherId&#x27;</span>, voucherId, <span class="hljs-string">&#x27;id&#x27;</span>, orderId)<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>

<p><strong>VoucherOrderServiceImpl</strong>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>    <span class="hljs-comment">//Ëé∑ÂèñÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>    <span class="hljs-comment">// 1.ÊâßË°åluaËÑöÊú¨</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>            SECKILL_SCRIPT,<br>            Collections.emptyList(),<br>            voucherId.toString(), userId.toString(), String.valueOf(orderId)<br>    );<br>    <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÁªìÊûúÊòØÂê¶‰∏∫0</span><br>    <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// 2.1.‰∏ç‰∏∫0 Ôºå‰ª£Ë°®Ê≤°ÊúâË¥≠‰π∞ËµÑÊ†º</span><br>        <span class="hljs-keyword">return</span> Result.fail(r == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;Â∫ìÂ≠ò‰∏çË∂≥&quot;</span> : <span class="hljs-string">&quot;‰∏çËÉΩÈáçÂ§ç‰∏ãÂçï&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//TODO ‰øùÂ≠òÈòªÂ°ûÈòüÂàó</span><br>    <span class="hljs-comment">// 3.ËøîÂõûËÆ¢Âçïid</span><br>    <span class="hljs-keyword">return</span> Result.ok(orderId);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-8-ÁßíÊùÄ‰ºòÂåñ-Âü∫‰∫éÈòªÂ°ûÈòüÂàóÂÆûÁé∞ÁßíÊùÄ‰ºòÂåñ"><a href="#3-8-ÁßíÊùÄ‰ºòÂåñ-Âü∫‰∫éÈòªÂ°ûÈòüÂàóÂÆûÁé∞ÁßíÊùÄ‰ºòÂåñ" class="headerlink" title="3.8 ÁßíÊùÄ‰ºòÂåñ-Âü∫‰∫éÈòªÂ°ûÈòüÂàóÂÆûÁé∞ÁßíÊùÄ‰ºòÂåñ"></a>3.8 ÁßíÊùÄ‰ºòÂåñ-Âü∫‰∫éÈòªÂ°ûÈòüÂàóÂÆûÁé∞ÁßíÊùÄ‰ºòÂåñ</h3><ol start="3">
<li>Â¶ÇÊûúÊä¢Ë¥≠ÊàêÂäüÔºåÂ∞Ü‰ºòÊÉ†Âà∏idÂíåÁî®Êà∑idÂ∞ÅË£ÖÂêéÂ≠òÂÖ•ÈòªÂ°ûÈòüÂàó</li>
<li>ÂºÄÂêØÁ∫øÁ®ã‰ªªÂä°Ôºå‰∏çÊñ≠‰ªéÈòªÂ°ûÈòüÂàó‰∏≠Ëé∑Âèñ‰ø°ÊÅØÔºåÂÆûÁé∞ÂºÇÊ≠•‰∏ãÂçïÂäüËÉΩ</li>
</ol>
<p>‰øÆÊîπ‰∏ãÂçïÂä®‰ΩúÔºåÁé∞Âú®Êàë‰ª¨Âéª‰∏ãÂçïÊó∂ÔºåÊòØÈÄöËøáluaË°®ËææÂºèÂéªÂéüÂ≠êÊâßË°åÂà§Êñ≠ÈÄªËæëÔºåÂ¶ÇÊûúÂà§Êñ≠ÊàëÂá∫Êù•‰∏ç‰∏∫0 ÔºåÂàôË¶Å‰πàÊòØÂ∫ìÂ≠ò‰∏çË∂≥ÔºåË¶Å‰πàÊòØÈáçÂ§ç‰∏ãÂçïÔºåËøîÂõûÈîôËØØ‰ø°ÊÅØÔºåÂ¶ÇÊûúÊòØ0ÔºåÂàôÊää‰∏ãÂçïÁöÑÈÄªËæë‰øùÂ≠òÂà∞ÈòüÂàó‰∏≠ÂéªÔºåÁÑ∂ÂêéÂºÇÊ≠•ÊâßË°å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ÂºÇÊ≠•Â§ÑÁêÜÁ∫øÁ®ãÊ±†</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">SECKILL_ORDER_EXECUTOR</span> <span class="hljs-operator">=</span> Executors.newSingleThreadExecutor();<br><br><span class="hljs-comment">//Âú®Á±ªÂàùÂßãÂåñ‰πãÂêéÊâßË°åÔºåÂõ†‰∏∫ÂΩìËøô‰∏™Á±ªÂàùÂßãÂåñÂ•Ω‰∫Ü‰πãÂêéÔºåÈöèÊó∂ÈÉΩÊòØÊúâÂèØËÉΩË¶ÅÊâßË°åÁöÑ</span><br><span class="hljs-meta">@PostConstruct</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>   SECKILL_ORDER_EXECUTOR.submit(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrderHandler</span>());<br>&#125;<br><span class="hljs-comment">// Áî®‰∫éÁ∫øÁ®ãÊ±†Â§ÑÁêÜÁöÑ‰ªªÂä°</span><br><span class="hljs-comment">// ÂΩìÂàùÂßãÂåñÂÆåÊØïÂêéÔºåÂ∞±‰ºöÂéª‰ªéÂØπÂàó‰∏≠ÂéªÊãø‰ø°ÊÅØ</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>)&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 1.Ëé∑ÂèñÈòüÂàó‰∏≠ÁöÑËÆ¢Âçï‰ø°ÊÅØ</span><br>                    <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> orderTasks.take();<br>                    <span class="hljs-comment">// 2.ÂàõÂª∫ËÆ¢Âçï</span><br>                    handleVoucherOrder(voucherOrder);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    log.error(<span class="hljs-string">&quot;Â§ÑÁêÜËÆ¢ÂçïÂºÇÂ∏∏&quot;</span>, e);<br>                &#125;<br>          	 &#125;<br>        &#125;<br>     <br>       <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>            <span class="hljs-comment">//1.Ëé∑ÂèñÁî®Êà∑</span><br>            <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>            <span class="hljs-comment">// 2.ÂàõÂª∫ÈîÅÂØπË±°</span><br>            <span class="hljs-type">RLock</span> <span class="hljs-variable">redisLock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock:order:&quot;</span> + userId);<br>            <span class="hljs-comment">// 3.Â∞ùËØïËé∑ÂèñÈîÅ</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> redisLock.lock();<br>            <span class="hljs-comment">// 4.Âà§Êñ≠ÊòØÂê¶Ëé∑ÂæóÈîÅÊàêÂäü</span><br>            <span class="hljs-keyword">if</span> (!isLock) &#123;<br>                <span class="hljs-comment">// Ëé∑ÂèñÈîÅÂ§±Ë¥•ÔºåÁõ¥Êé•ËøîÂõûÂ§±Ë¥•ÊàñËÄÖÈáçËØï</span><br>                log.error(<span class="hljs-string">&quot;‰∏çÂÖÅËÆ∏ÈáçÂ§ç‰∏ãÂçïÔºÅ&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-comment">//Ê≥®ÊÑèÔºöÁî±‰∫éÊòØspringÁöÑ‰∫ãÂä°ÊòØÊîæÂú®threadLocal‰∏≠ÔºåÊ≠§Êó∂ÁöÑÊòØÂ§öÁ∫øÁ®ãÔºå‰∫ãÂä°‰ºöÂ§±Êïà</span><br>                proxy.createVoucherOrder(voucherOrder);<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// ÈáäÊîæÈîÅ</span><br>                redisLock.unlock();<br>            &#125;<br>    &#125;<br>     <span class="hljs-comment">//a</span><br>	<span class="hljs-keyword">private</span> BlockingQueue&lt;VoucherOrder&gt; orderTasks =<span class="hljs-keyword">new</span>  <span class="hljs-title class_">ArrayBlockingQueue</span>&lt;&gt;(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">seckillVoucher</span><span class="hljs-params">(Long voucherId)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>        <span class="hljs-comment">// 1.ÊâßË°åluaËÑöÊú¨</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(<br>                SECKILL_SCRIPT,<br>                Collections.emptyList(),<br>                voucherId.toString(), userId.toString(), String.valueOf(orderId)<br>        );<br>        <span class="hljs-type">int</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> result.intValue();<br>        <span class="hljs-comment">// 2.Âà§Êñ≠ÁªìÊûúÊòØÂê¶‰∏∫0</span><br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// 2.1.‰∏ç‰∏∫0 Ôºå‰ª£Ë°®Ê≤°ÊúâË¥≠‰π∞ËµÑÊ†º</span><br>            <span class="hljs-keyword">return</span> Result.fail(r == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot;Â∫ìÂ≠ò‰∏çË∂≥&quot;</span> : <span class="hljs-string">&quot;‰∏çËÉΩÈáçÂ§ç‰∏ãÂçï&quot;</span>);<br>        &#125;<br>        <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>();<br>        <span class="hljs-comment">// 2.3.ËÆ¢Âçïid</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> redisIdWorker.nextId(<span class="hljs-string">&quot;order&quot;</span>);<br>        voucherOrder.setId(orderId);<br>        <span class="hljs-comment">// 2.4.Áî®Êà∑id</span><br>        voucherOrder.setUserId(userId);<br>        <span class="hljs-comment">// 2.5.‰ª£ÈáëÂà∏id</span><br>        voucherOrder.setVoucherId(voucherId);<br>        <span class="hljs-comment">// 2.6.ÊîæÂÖ•ÈòªÂ°ûÈòüÂàó</span><br>        orderTasks.add(voucherOrder);<br>        <span class="hljs-comment">//3.Ëé∑Âèñ‰ª£ÁêÜÂØπË±°</span><br>         proxy = (IVoucherOrderService)AopContext.currentProxy();<br>        <span class="hljs-comment">//4.ËøîÂõûËÆ¢Âçïid</span><br>        <span class="hljs-keyword">return</span> Result.ok(orderId);<br>    &#125;<br>     <br>      <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">createVoucherOrder</span><span class="hljs-params">(VoucherOrder voucherOrder)</span> &#123;<br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> voucherOrder.getUserId();<br>        <span class="hljs-comment">// 5.1.Êü•ËØ¢ËÆ¢Âçï</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).count();<br>        <span class="hljs-comment">// 5.2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>        <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// Áî®Êà∑Â∑≤ÁªèË¥≠‰π∞Ëøá‰∫Ü</span><br>           log.error(<span class="hljs-string">&quot;Áî®Êà∑Â∑≤ÁªèË¥≠‰π∞Ëøá‰∫Ü&quot;</span>);<br>           <span class="hljs-keyword">return</span> ;<br>        &#125;<br><br>        <span class="hljs-comment">// 6.Êâ£ÂáèÂ∫ìÂ≠ò</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>                .setSql(<span class="hljs-string">&quot;stock = stock - 1&quot;</span>) <span class="hljs-comment">// set stock = stock - 1</span><br>                .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherOrder.getVoucherId()).gt(<span class="hljs-string">&quot;stock&quot;</span>, <span class="hljs-number">0</span>) <span class="hljs-comment">// where id = ? and stock &gt; 0</span><br>                .update();<br>        <span class="hljs-keyword">if</span> (!success) &#123;<br>            <span class="hljs-comment">// Êâ£ÂáèÂ§±Ë¥•</span><br>            log.error(<span class="hljs-string">&quot;Â∫ìÂ≠ò‰∏çË∂≥&quot;</span>);<br>            <span class="hljs-keyword">return</span> ;<br>        &#125;<br>        save(voucherOrder);<br> <br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>Â∞èÊÄªÁªìÔºö</strong></p>
<p>ÁßíÊùÄ‰∏öÂä°ÁöÑ‰ºòÂåñÊÄùË∑ØÊòØ‰ªÄ‰πàÔºü</p>
<ul>
<li>ÂÖàÂà©Áî®RedisÂÆåÊàêÂ∫ìÂ≠ò‰ΩôÈáè„ÄÅ‰∏Ä‰∫∫‰∏ÄÂçïÂà§Êñ≠ÔºåÂÆåÊàêÊä¢Âçï‰∏öÂä°</li>
<li>ÂÜçÂ∞Ü‰∏ãÂçï‰∏öÂä°ÊîæÂÖ•ÈòªÂ°ûÈòüÂàóÔºåÂà©Áî®Áã¨Á´ãÁ∫øÁ®ãÂºÇÊ≠•‰∏ãÂçï</li>
<li>Âü∫‰∫éÈòªÂ°ûÈòüÂàóÁöÑÂºÇÊ≠•ÁßíÊùÄÂ≠òÂú®Âì™‰∫õÈóÆÈ¢òÔºü<ul>
<li>ÂÜÖÂ≠òÈôêÂà∂ÈóÆÈ¢ò</li>
<li>Êï∞ÊçÆÂÆâÂÖ®ÈóÆÈ¢ò</li>
</ul>
</li>
</ul>
<h2 id="4-ÂàÜÂ∏ÉÂºèÈîÅ"><a href="#4-ÂàÜÂ∏ÉÂºèÈîÅ" class="headerlink" title="4. ÂàÜÂ∏ÉÂºèÈîÅ"></a>4. ÂàÜÂ∏ÉÂºèÈîÅ</h2><h3 id="4-1-Âü∫Êú¨ÂéüÁêÜÂíåÂÆûÁé∞ÊñπÂºèÂØπÊØî"><a href="#4-1-Âü∫Êú¨ÂéüÁêÜÂíåÂÆûÁé∞ÊñπÂºèÂØπÊØî" class="headerlink" title="4.1 Âü∫Êú¨ÂéüÁêÜÂíåÂÆûÁé∞ÊñπÂºèÂØπÊØî"></a>4.1 Âü∫Êú¨ÂéüÁêÜÂíåÂÆûÁé∞ÊñπÂºèÂØπÊØî</h3><p>ÂàÜÂ∏ÉÂºèÈîÅÔºöÊª°Ë∂≥ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÊàñÈõÜÁæ§Ê®°Âºè‰∏ãÂ§öËøõÁ®ãÂèØËßÅÂπ∂‰∏î‰∫íÊñ•ÁöÑÈîÅ„ÄÇ<br>ÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ†∏ÂøÉÊÄùÊÉ≥Â∞±ÊòØËÆ©Â§ßÂÆ∂ÈÉΩ‰ΩøÁî®Âêå‰∏ÄÊääÈîÅÔºåÂè™Ë¶ÅÂ§ßÂÆ∂‰ΩøÁî®ÁöÑÊòØÂêå‰∏ÄÊääÈîÅÔºåÈÇ£‰πàÊàë‰ª¨Â∞±ËÉΩÈîÅ‰ΩèÁ∫øÁ®ãÔºå‰∏çËÆ©Á∫øÁ®ãËøõË°åÔºåËÆ©Á®ãÂ∫è‰∏≤Ë°åÊâßË°åÔºåËøôÂ∞±ÊòØÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ†∏ÂøÉÊÄùË∑Ø</p>
<p><img src="/img/blogs/java/redis/2.4.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>ÂàÜÂ∏ÉÂºèÈîÅÈúÄË¶ÅÊª°Ë∂≥ÁöÑÊù°‰ª∂<ul>
<li>ÂèØËßÅÊÄß</li>
<li>‰∫íÊñ•</li>
<li>È´òÂèØÁî®</li>
<li>È´òÊÄßËÉΩ</li>
<li>ÂÆâÂÖ®ÊÄß</li>
</ul>
</li>
</ul>
<p><strong>Â∏∏ËßÅÁöÑÂàÜÂ∏ÉÂºèÈîÅÊúâ‰∏âÁßç</strong>Ôºö</p>
<table>
<thead>
<tr>
<th></th>
<th>MySQL</th>
<th>Redis</th>
<th>Zookeeper</th>
</tr>
</thead>
<tbody><tr>
<td>‰∫íÊñ•</td>
<td>Âà©Áî®MySQLÊú¨Ë∫´ÁöÑ‰∫íÊñ•ÈîÅÊú∫Âà∂</td>
<td>Âà©Áî®setnxËøôÊ†∑ÁöÑ‰∫íÊñ•ÂëΩ‰ª§</td>
<td>Âà©Áî®ËäÇÁÇπÁöÑÂîØ‰∏ÄÊÄßÂíåÊúâÂ∫èÊÄßÂÆûÁé∞‰∫íÊñ•</td>
</tr>
<tr>
<td>È´òÂèØÁî®</td>
<td>Â•Ω</td>
<td>Â•Ω</td>
<td>Â•Ω</td>
</tr>
<tr>
<td>È´òÊÄßËÉΩ</td>
<td>‰∏ÄËà¨</td>
<td>Â•Ω</td>
<td>‰∏ÄËà¨</td>
</tr>
<tr>
<td>ÂÆâÂÖ®ÊÄß</td>
<td>Êñ≠ÂºÄËøûÊé•ÔºåËá™Âä®ÈáäÊîæÈîÅ</td>
<td>Âà©Áî®ÈîÅË∂ÖÊó∂Êó∂Èó¥ÔºåÂà∞ÊúüÈáäÊîæ</td>
<td>‰∏¥Êó∂ËäÇÁÇπÔºåÊñ≠ÂºÄËøûÊé•Ëá™Âä®ÈáäÊîæ</td>
</tr>
</tbody></table>
<h3 id="4-2-Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅ"><a href="#4-2-Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅ" class="headerlink" title="4.2 Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅ"></a>4.2 Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅ</h3><p>ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅÊó∂ÈúÄË¶ÅÂÆûÁé∞ÁöÑ‰∏§‰∏™Âü∫Êú¨ÊñπÊ≥ïÔºö</p>
<ul>
<li>Ëé∑ÂèñÈîÅÔºö<ul>
<li>‰∫íÊñ•ÔºöÁ°Æ‰øùÂè™ËÉΩÊúâ‰∏Ä‰∏™Á∫øÁ®ãËé∑ÂèñÈîÅ</li>
<li>ÈùûÈòªÂ°ûÔºöÂ∞ùËØï‰∏ÄÊ¨°ÔºåÊàêÂäüËøîÂõûtrueÔºåÂ§±Ë¥•ËøîÂõûfalse</li>
</ul>
</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-comment"># Ê∑ªÂä†ÈîÅÔºåNXÊòØ‰∫íÊñ•„ÄÅEXÊòØËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥</span><br>SET lock thread1 NX EX <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>

<ul>
<li>ÈáäÊîæÈîÅÔºö<ul>
<li>ÊâãÂä®ÈáäÊîæ</li>
<li>Ë∂ÖÊó∂ÈáäÊîæÔºöËé∑ÂèñÈîÅÊó∂Ê∑ªÂä†‰∏Ä‰∏™Ë∂ÖÊó∂Êó∂Èó¥</li>
</ul>
</li>
</ul>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs r"><span class="hljs-comment"># ÈáäÊîæÈîÅÔºåÂà†Èô§Âç≥ÂèØ</span><br>DEL key<br></code></pre></td></tr></table></figure>

<p><img src="/img/blogs/java/redis/2.4.2.png" srcset="/img/loading.gif" lazyload></p>
<p>Êàë‰ª¨Âà©Áî®redis ÁöÑsetNx ÊñπÊ≥ïÔºåÂΩìÊúâÂ§ö‰∏™Á∫øÁ®ãËøõÂÖ•Êó∂ÔºåÊàë‰ª¨Â∞±Âà©Áî®ËØ•ÊñπÊ≥ïÔºåÁ¨¨‰∏Ä‰∏™Á∫øÁ®ãËøõÂÖ•Êó∂Ôºåredis ‰∏≠Â∞±ÊúâËøô‰∏™key ‰∫ÜÔºåËøîÂõû‰∫Ü1ÔºåÂ¶ÇÊûúÁªìÊûúÊòØ1ÔºåÂàôË°®Á§∫‰ªñÊä¢Âà∞‰∫ÜÈîÅÔºåÈÇ£‰πà‰ªñÂéªÊâßË°å‰∏öÂä°ÔºåÁÑ∂ÂêéÂÜçÂà†Èô§ÈîÅÔºåÈÄÄÂá∫ÈîÅÈÄªËæëÔºåÊ≤°ÊúâÊä¢Âà∞ÈîÅÁöÑÂì•‰ª¨ÔºåÁ≠âÂæÖ‰∏ÄÂÆöÊó∂Èó¥ÂêéÈáçËØïÂç≥ÂèØ</p>
<h3 id="4-3-ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅ-ÁâàÊú¨‰∏Ä"><a href="#4-3-ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅ-ÁâàÊú¨‰∏Ä" class="headerlink" title="4.3 ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅ(ÁâàÊú¨‰∏Ä)"></a>4.3 ÂÆûÁé∞ÂàÜÂ∏ÉÂºèÈîÅ(ÁâàÊú¨‰∏Ä)</h3><ul>
<li>Âà©Áî®setnxÊñπÊ≥ïËøõË°åÂä†ÈîÅÔºåÂêåÊó∂Â¢ûÂä†ËøáÊúüÊó∂Èó¥ÔºåÈò≤Ê≠¢Ê≠ªÈîÅÔºåÊ≠§ÊñπÊ≥ïÂèØ‰ª•‰øùËØÅÂä†ÈîÅÂíåÂ¢ûÂä†ËøáÊúüÊó∂Èó¥ÂÖ∑ÊúâÂéüÂ≠êÊÄß</li>
<li>ÈáäÊîæÈîÅÈÄªËæë<ul>
<li>ÈáäÊîæÈîÅÔºåÈò≤Ê≠¢Âà†Èô§Âà´‰∫∫ÁöÑÈîÅ</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String KEY_PREFIX=<span class="hljs-string">&quot;lock:&quot;</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>    <span class="hljs-comment">// Ëé∑ÂèñÁ∫øÁ®ãÊ†áÁ§∫</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> Thread.currentThread().getId()<br>    <span class="hljs-comment">// Ëé∑ÂèñÈîÅ</span><br>    <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>            .setIfAbsent(KEY_PREFIX + name, threadId + <span class="hljs-string">&quot;&quot;</span>, timeoutSec, TimeUnit.SECONDS);<br>    <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">//ÈÄöËøádelÂà†Èô§ÈîÅ</span><br>    stringRedisTemplate.delete(KEY_PREFIX + name);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>‰øÆÊîπ‰∏öÂä°‰ª£Á†Å:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">      <span class="hljs-comment">//ÂàõÂª∫ÈîÅÂØπË±°(Êñ∞Â¢û‰ª£Á†Å)</span><br>      <span class="hljs-type">SimpleRedisLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRedisLock</span>(<span class="hljs-string">&quot;order:&quot;</span> + userId, stringRedisTemplate);<br>      <span class="hljs-comment">//Ëé∑ÂèñÈîÅÂØπË±°</span><br>      <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1200</span>);<br><span class="hljs-comment">//Âä†ÈîÅÂ§±Ë¥•</span><br>      <span class="hljs-keyword">if</span> (!isLock) &#123;<br>          <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;‰∏çÂÖÅËÆ∏ÈáçÂ§ç‰∏ãÂçï&quot;</span>);<br>      &#125;<br>      <span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">//Ëé∑Âèñ‰ª£ÁêÜÂØπË±°(‰∫ãÂä°)</span><br>          <span class="hljs-type">IVoucherOrderService</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IVoucherOrderService) AopContext.currentProxy();<br>          <span class="hljs-keyword">return</span> proxy.createVoucherOrder(voucherId);<br>      &#125; <span class="hljs-keyword">finally</span> &#123;<br>          <span class="hljs-comment">//ÈáäÊîæÈîÅ</span><br>          lock.unlock();<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÊÉÖÂÜµ"><a href="#4-4-RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÊÉÖÂÜµ" class="headerlink" title="4.4 RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÊÉÖÂÜµ"></a>4.4 RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÊÉÖÂÜµ</h3><p>ÊåÅÊúâÈîÅÁöÑÁ∫øÁ®ãÂú®ÈîÅÁöÑÂÜÖÈÉ®Âá∫Áé∞‰∫ÜÈòªÂ°ûÔºåÂØºËá¥‰ªñÁöÑÈîÅËá™Âä®ÈáäÊîæÔºåËøôÊó∂ÂÖ∂‰ªñÁ∫øÁ®ãÔºåÁ∫øÁ®ã2Êù•Â∞ùËØïËé∑ÂæóÈîÅÔºåÂ∞±ÊãøÂà∞‰∫ÜËøôÊääÈîÅÔºåÁÑ∂ÂêéÁ∫øÁ®ã2Âú®ÊåÅÊúâÈîÅÊâßË°åËøáÁ®ã‰∏≠ÔºåÁ∫øÁ®ã1ÂèçÂ∫îËøáÊù•ÔºåÁªßÁª≠ÊâßË°åÔºåËÄåÁ∫øÁ®ã1ÊâßË°åËøáÁ®ã‰∏≠Ôºå<strong>Ëµ∞Âà∞‰∫ÜÂà†Èô§ÈîÅÈÄªËæëÔºåÊ≠§Êó∂Â∞±‰ºöÊääÊú¨Â∫îËØ•Â±û‰∫éÁ∫øÁ®ã2ÁöÑÈîÅËøõË°åÂà†Èô§</strong>ÔºåËøôÂ∞±ÊòØËØØÂà†Âà´‰∫∫ÈîÅÁöÑÊÉÖÂÜµËØ¥Êòé</p>
<p><img src="/img/blogs/java/redis/2.4.3.png" srcset="/img/loading.gif" lazyload></p>
<p>Ëß£ÂÜ≥ÊñπÊ°àÂ∞±ÊòØÂú®ÊØè‰∏™Á∫øÁ®ã<strong>ÈáäÊîæÈîÅÁöÑÊó∂ÂÄôÔºåÂéªÂà§Êñ≠‰∏Ä‰∏ãÂΩìÂâçËøôÊääÈîÅÊòØÂê¶Â±û‰∫éËá™Â∑±</strong>ÔºåÂ¶ÇÊûúÂ±û‰∫éËá™Â∑±ÔºåÂàô‰∏çËøõË°åÈîÅÁöÑÂà†Èô§</p>
<p><img src="/img/blogs/java/redis/2.4.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="Ëß£ÂÜ≥RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÈóÆÈ¢ò"><a href="#Ëß£ÂÜ≥RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÈóÆÈ¢ò" class="headerlink" title="Ëß£ÂÜ≥RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÈóÆÈ¢ò"></a>Ëß£ÂÜ≥RedisÂàÜÂ∏ÉÂºèÈîÅËØØÂà†ÈóÆÈ¢ò</h4><p><img src="/img/blogs/java/redis/2.4.5.png" srcset="/img/loading.gif" lazyload></p>
<p>ÈúÄÊ±ÇÔºö‰øÆÊîπ‰πãÂâçÁöÑÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÔºåÊª°Ë∂≥Ôºö</p>
<ul>
<li>Âú®Ëé∑ÂèñÈîÅÊó∂Â≠òÂÖ•Á∫øÁ®ãÊ†áÁ§∫ÔºàÂèØ‰ª•Áî®UUIDË°®Á§∫Ôºâ</li>
<li>Âú®ÈáäÊîæÈîÅÊó∂ÂÖàËé∑ÂèñÈîÅ‰∏≠ÁöÑÁ∫øÁ®ãÊ†áÁ§∫ÔºåÂà§Êñ≠ÊòØÂê¶‰∏éÂΩìÂâçÁ∫øÁ®ãÊ†áÁ§∫‰∏ÄËá¥<ul>
<li>Â¶ÇÊûú‰∏ÄËá¥ÂàôÈáäÊîæÈîÅ</li>
<li>Â¶ÇÊûú‰∏ç‰∏ÄËá¥Âàô‰∏çÈáäÊîæÈîÅ</li>
</ul>
</li>
</ul>
<p><strong>Âä†ÈîÅ</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ID_PREFIX</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString(<span class="hljs-literal">true</span>) + <span class="hljs-string">&quot;-&quot;</span>;<br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(<span class="hljs-type">long</span> timeoutSec)</span> &#123;<br>   <span class="hljs-comment">// Ëé∑ÂèñÁ∫øÁ®ãÊ†áÁ§∫</span><br>   <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();<br>   <span class="hljs-comment">// Ëé∑ÂèñÈîÅ</span><br>   <span class="hljs-type">Boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue()<br>                .setIfAbsent(KEY_PREFIX + name, threadId, timeoutSec, TimeUnit.SECONDS);<br>   <span class="hljs-keyword">return</span> Boolean.TRUE.equals(success);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ÈáäÊîæÈîÅ</strong>Ôºö<strong>ÂÖàÂà§Êñ≠ÔºåÂÜçÈáäÊîæ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Ëé∑ÂèñÁ∫øÁ®ãÊ†áÁ§∫</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">threadId</span> <span class="hljs-operator">=</span> ID_PREFIX + Thread.currentThread().getId();<br>    <span class="hljs-comment">// Ëé∑ÂèñÈîÅ‰∏≠ÁöÑÊ†áÁ§∫</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(KEY_PREFIX + name);<br>    <span class="hljs-comment">// Âà§Êñ≠Ê†áÁ§∫ÊòØÂê¶‰∏ÄËá¥</span><br>    <span class="hljs-keyword">if</span>(threadId.equals(id)) &#123;<br>        <span class="hljs-comment">// ÈáäÊîæÈîÅ</span><br>        stringRedisTemplate.delete(KEY_PREFIX + name);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="4-5-ÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢ò"><a href="#4-5-ÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢ò" class="headerlink" title="4.5 ÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢ò"></a>4.5 ÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢ò</h3><p>Á∫øÁ®ã1Áé∞Âú®ÊåÅÊúâÈîÅ‰πãÂêéÔºåÂú®ÊâßË°å‰∏öÂä°ÈÄªËæëËøáÁ®ã‰∏≠Ôºå‰ªñÊ≠£ÂáÜÂ§áÂà†Èô§ÈîÅÔºåËÄå‰∏îÂ∑≤ÁªèËµ∞Âà∞‰∫ÜÊù°‰ª∂Âà§Êñ≠ÁöÑËøáÁ®ã‰∏≠ÔºåÊØîÂ¶Ç‰ªñÂ∑≤ÁªèÊãøÂà∞‰∫ÜÂΩìÂâçËøôÊääÈîÅÁ°ÆÂÆûÊòØÂ±û‰∫é‰ªñËá™Â∑±ÁöÑÔºåÊ≠£ÂáÜÂ§áÂà†Èô§ÈîÅÔºå‰ΩÜÊòØÊ≠§Êó∂‰ªñÁöÑÈîÅÂà∞Êúü‰∫ÜÔºåÈÇ£‰πàÊ≠§Êó∂Á∫øÁ®ã2ËøõÊù•Ôºå‰ΩÜÊòØÁ∫øÁ®ã1‰ªñ‰ºöÊé•ÁùÄÂæÄÂêéÊâßË°åÔºåÂΩì‰ªñÂç°È°øÁªìÊùüÂêéÔºå‰ªñÁõ¥Êé•Â∞±‰ºöÊâßË°åÂà†Èô§ÈîÅÈÇ£Ë°å‰ª£Á†ÅÔºåÁõ∏ÂΩì‰∫éÊù°‰ª∂Âà§Êñ≠Âπ∂Ê≤°ÊúâËµ∑Âà∞‰ΩúÁî®ÔºåËøôÂ∞±ÊòØÂà†ÈîÅÊó∂ÁöÑÂéüÂ≠êÊÄßÈóÆÈ¢òÔºå‰πãÊâÄ‰ª•ÊúâËøô‰∏™ÈóÆÈ¢òÔºåÊòØÂõ†‰∏∫Á∫øÁ®ã1ÁöÑÊãøÈîÅÔºåÊØîÈîÅÔºåÂà†ÈîÅÔºåÂÆûÈôÖ‰∏äÂπ∂‰∏çÊòØÂéüÂ≠êÊÄßÁöÑ</p>
<p><img src="/img/blogs/java/redis/2.4.6.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-6-LuaËÑöÊú¨Ëß£ÂÜ≥Â§öÊù°ÂëΩ‰ª§ÂéüÂ≠êÊÄßÈóÆÈ¢ò"><a href="#4-6-LuaËÑöÊú¨Ëß£ÂÜ≥Â§öÊù°ÂëΩ‰ª§ÂéüÂ≠êÊÄßÈóÆÈ¢ò" class="headerlink" title="4.6 LuaËÑöÊú¨Ëß£ÂÜ≥Â§öÊù°ÂëΩ‰ª§ÂéüÂ≠êÊÄßÈóÆÈ¢ò"></a>4.6 LuaËÑöÊú¨Ëß£ÂÜ≥Â§öÊù°ÂëΩ‰ª§ÂéüÂ≠êÊÄßÈóÆÈ¢ò</h3><p>RedisÊèê‰æõ‰∫ÜLuaËÑöÊú¨ÂäüËÉΩÔºåÂú®‰∏Ä‰∏™ËÑöÊú¨‰∏≠ÁºñÂÜôÂ§öÊù°RedisÂëΩ‰ª§ÔºåÁ°Æ‰øùÂ§öÊù°ÂëΩ‰ª§ÊâßË°åÊó∂ÁöÑÂéüÂ≠êÊÄß</p>
<p>RedisÊèê‰æõÁöÑË∞ÉÁî®ÂáΩÊï∞ÔºåËØ≠Ê≥ïÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">redis.call(<span class="hljs-string">&#x27;ÂëΩ‰ª§ÂêçÁß∞&#x27;</span>, <span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;ÂÖ∂ÂÆÉÂèÇÊï∞&#x27;</span>, ...)<br></code></pre></td></tr></table></figure>

<p>‰æãÂ¶ÇÔºåÊàë‰ª¨Ë¶ÅÊâßË°åset name jackÔºåÂàôËÑöÊú¨ÊòØËøôÊ†∑Ôºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"># ÊâßË°å set name jack<br>redis.call(<span class="hljs-string">&#x27;set&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;jack&#x27;</span>)<br></code></pre></td></tr></table></figure>

<p>‰æãÂ¶ÇÔºåÊàë‰ª¨Ë¶ÅÂÖàÊâßË°åset name RoseÔºåÂÜçÊâßË°åget nameÔºåÂàôËÑöÊú¨Â¶Ç‰∏ãÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"># ÂÖàÊâßË°å set name jack<br>redis.call(<span class="hljs-string">&#x27;set&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>, <span class="hljs-string">&#x27;Rose&#x27;</span>)<br># ÂÜçÊâßË°å get name<br><span class="hljs-keyword">local</span> name = redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, <span class="hljs-string">&#x27;name&#x27;</span>)<br># ËøîÂõû<br><span class="hljs-keyword">return</span> name<br></code></pre></td></tr></table></figure>

<ul>
<li>ÈáäÊîæÈîÅÁöÑ‰∏öÂä°ÊµÅÁ®ãÊòØËøôÊ†∑ÁöÑ<ol>
<li>Ëé∑ÂèñÈîÅ‰∏≠ÁöÑÁ∫øÁ®ãÊ†áÁ§∫</li>
<li>Âà§Êñ≠ÊòØÂê¶‰∏éÊåáÂÆöÁöÑÊ†áÁ§∫ÔºàÂΩìÂâçÁ∫øÁ®ãÊ†áÁ§∫Ôºâ‰∏ÄËá¥</li>
<li>Â¶ÇÊûú‰∏ÄËá¥ÂàôÈáäÊîæÈîÅÔºàÂà†Èô§Ôºâ</li>
<li>Â¶ÇÊûú‰∏ç‰∏ÄËá¥Âàô‰ªÄ‰πàÈÉΩ‰∏çÂÅö</li>
</ol>
</li>
</ul>
<p>ÊúÄÁªàÊàë‰ª¨Êìç‰ΩúredisÁöÑÊãøÈîÅÊØîÈîÅÂà†ÈîÅÁöÑluaËÑöÊú¨Â∞±‰ºöÂèòÊàêËøôÊ†∑</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ËøôÈáåÁöÑ KEYS[1] Â∞±ÊòØÈîÅÁöÑkeyÔºåËøôÈáåÁöÑARGV[1] Â∞±ÊòØÂΩìÂâçÁ∫øÁ®ãÊ†áÁ§∫</span><br><span class="hljs-comment">-- Ëé∑ÂèñÈîÅ‰∏≠ÁöÑÊ†áÁ§∫ÔºåÂà§Êñ≠ÊòØÂê¶‰∏éÂΩìÂâçÁ∫øÁ®ãÊ†áÁ§∫‰∏ÄËá¥</span><br><span class="hljs-keyword">if</span> (redis.call(<span class="hljs-string">&#x27;GET&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>]) <span class="hljs-keyword">then</span><br>  <span class="hljs-comment">-- ‰∏ÄËá¥ÔºåÂàôÂà†Èô§ÈîÅ</span><br>  <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">&#x27;DEL&#x27;</span>, KEYS[<span class="hljs-number">1</span>])<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- ‰∏ç‰∏ÄËá¥ÔºåÂàôÁõ¥Êé•ËøîÂõû</span><br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure>


<h3 id="4-7-Âà©Áî®Java‰ª£Á†ÅË∞ÉÁî®LuaËÑöÊú¨ÊîπÈÄ†ÂàÜÂ∏ÉÂºèÈîÅ"><a href="#4-7-Âà©Áî®Java‰ª£Á†ÅË∞ÉÁî®LuaËÑöÊú¨ÊîπÈÄ†ÂàÜÂ∏ÉÂºèÈîÅ" class="headerlink" title="4.7 Âà©Áî®Java‰ª£Á†ÅË∞ÉÁî®LuaËÑöÊú¨ÊîπÈÄ†ÂàÜÂ∏ÉÂºèÈîÅ"></a>4.7 Âà©Áî®Java‰ª£Á†ÅË∞ÉÁî®LuaËÑöÊú¨ÊîπÈÄ†ÂàÜÂ∏ÉÂºèÈîÅ</h3><p>RedisTemplate‰∏≠ÔºåÂèØ‰ª•Âà©Áî®executeÊñπÊ≥ïÂéªÊâßË°åluaËÑöÊú¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; UNLOCK_SCRIPT;<br>    <span class="hljs-keyword">static</span> &#123;<br>        UNLOCK_SCRIPT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;();<br>        UNLOCK_SCRIPT.setLocation(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">&quot;unlock.lua&quot;</span>));<br>        UNLOCK_SCRIPT.setResultType(Long.class);<br>    &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// Ë∞ÉÁî®luaËÑöÊú¨</span><br>    stringRedisTemplate.execute(<br>            UNLOCK_SCRIPT,<br>            Collections.singletonList(KEY_PREFIX + name),<br>            ID_PREFIX + Thread.currentThread().getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-8-Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÊÄùË∑Ø"><a href="#4-8-Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÊÄùË∑Ø" class="headerlink" title="4.8 Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÊÄùË∑Ø"></a>4.8 Âü∫‰∫éRedisÁöÑÂàÜÂ∏ÉÂºèÈîÅÂÆûÁé∞ÊÄùË∑Ø</h3><ul>
<li>Âà©Áî®set nx exËé∑ÂèñÈîÅÔºåÂπ∂ËÆæÁΩÆËøáÊúüÊó∂Èó¥Ôºå‰øùÂ≠òÁ∫øÁ®ãÊ†áÁ§∫</li>
<li>ÈáäÊîæÈîÅÊó∂ÂÖàÂà§Êñ≠Á∫øÁ®ãÊ†áÁ§∫ÊòØÂê¶‰∏éËá™Â∑±‰∏ÄËá¥Ôºå‰∏ÄËá¥ÂàôÂà†Èô§ÈîÅ<ul>
<li>ÁâπÊÄßÔºö<ul>
<li>Âà©Áî®set nxÊª°Ë∂≥‰∫íÊñ•ÊÄß</li>
<li>Âà©Áî®set ex‰øùËØÅÊïÖÈöúÊó∂ÈîÅ‰æùÁÑ∂ËÉΩÈáäÊîæÔºåÈÅøÂÖçÊ≠ªÈîÅÔºåÊèêÈ´òÂÆâÂÖ®ÊÄß</li>
<li>Âà©Áî®RedisÈõÜÁæ§‰øùËØÅÈ´òÂèØÁî®ÂíåÈ´òÂπ∂ÂèëÁâπÊÄß</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-9-ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂäüËÉΩ‰ªãÁªç"><a href="#4-9-ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂäüËÉΩ‰ªãÁªç" class="headerlink" title="4.9 ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂäüËÉΩ‰ªãÁªç"></a>4.9 ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂäüËÉΩ‰ªãÁªç</h3><p>Âü∫‰∫ésetnxÂÆûÁé∞ÁöÑÂàÜÂ∏ÉÂºèÈîÅÂ≠òÂú®‰∏ãÈù¢ÁöÑÈóÆÈ¢òÔºö</p>
<ul>
<li><strong>‰∏çÂèØÈáçÂÖ•ÈóÆÈ¢ò</strong>ÔºöÂêå‰∏Ä‰∏™Á∫øÁ®ãÊó†Ê≥ïÂ§öÊ¨°Ëé∑ÂèñÂêå‰∏ÄÊääÈîÅ</li>
<li><strong>‰∏çÂèØÈáçËØï</strong>ÔºöËé∑ÂèñÈîÅÂè™Â∞ùËØï‰∏ÄÊ¨°Â∞±ËøîÂõûfalseÔºåÊ≤°ÊúâÈáçËØïÊú∫Âà∂</li>
<li><strong>Ë∂ÖÊó∂ÈáäÊîæÔºö</strong>Ôºö ÈîÅË∂ÖÊó∂ÈáäÊîæËôΩÁÑ∂ÂèØ‰ª•ÈÅøÂÖçÊ≠ªÈîÅÔºå‰ΩÜÂ¶ÇÊûúÊòØ‰∏öÂä°ÊâßË°åËÄóÊó∂ËæÉÈïøÔºå‰πü‰ºöÂØºËá¥ÈîÅÈáäÊîæÔºåÂ≠òÂú®ÂÆâÂÖ®ÈöêÊÇ£</li>
<li><strong>‰∏ª‰ªé‰∏ÄËá¥ÊÄßÔºö</strong> ÔºöÂ¶ÇÊûúRedisÊèê‰æõ‰∫Ü‰∏ª‰ªéÈõÜÁæ§Ôºå‰∏ª‰ªéÂêåÊ≠•Â≠òÂú®Âª∂ËøüÔºåÂΩì‰∏ªÂÆïÊú∫Êó∂ÔºåÂ¶ÇÊûú‰ªéÂπ∂ÂêåÊ≠•‰∏ª‰∏≠ÁöÑÈîÅÊï∞ÊçÆÔºåÂàô‰ºöÂá∫Áé∞ÈîÅÂÆûÁé∞</li>
</ul>
<p>RedissonÊòØ‰∏Ä‰∏™Âú®RedisÁöÑÂü∫Á°Ä‰∏äÂÆûÁé∞ÁöÑJavaÈ©ªÂÜÖÂ≠òÊï∞ÊçÆÁΩëÊ†ºÔºàIn-Memory Data GridÔºâ„ÄÇÂÆÉ‰∏ç‰ªÖÊèê‰æõ‰∫Ü‰∏ÄÁ≥ªÂàóÁöÑÂàÜÂ∏ÉÂºèÁöÑJavaÂ∏∏Áî®ÂØπË±°ÔºåËøòÊèê‰æõ‰∫ÜËÆ∏Â§öÂàÜÂ∏ÉÂºèÊúçÂä°ÔºåÂÖ∂‰∏≠Â∞±ÂåÖÂê´‰∫ÜÂêÑÁßçÂàÜÂ∏ÉÂºèÈîÅÁöÑÂÆûÁé∞„ÄÇ</p>
<p><strong>RedissionÊèê‰æõ‰∫ÜÂàÜÂ∏ÉÂºèÈîÅÁöÑÂ§öÁßçÂ§öÊ†∑ÁöÑÂäüËÉΩ</strong></p>
<h3 id="4-10-ÂàÜÂ∏ÉÂºèÈîÅ-RedissionÂø´ÈÄüÂÖ•Èó®"><a href="#4-10-ÂàÜÂ∏ÉÂºèÈîÅ-RedissionÂø´ÈÄüÂÖ•Èó®" class="headerlink" title="4.10 ÂàÜÂ∏ÉÂºèÈîÅ-RedissionÂø´ÈÄüÂÖ•Èó®"></a>4.10 ÂàÜÂ∏ÉÂºèÈîÅ-RedissionÂø´ÈÄüÂÖ•Èó®</h3><ol>
<li>ÂºïÂÖ•‰æùËµñÔºö</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.13.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>ÈÖçÁΩÆRedissonÂÆ¢Êà∑Á´ØÔºö</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedissonConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedissonClient <span class="hljs-title function_">redissonClient</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// ÈÖçÁΩÆ</span><br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>();<br>        config.useSingleServer().setAddress(<span class="hljs-string">&quot;redis://192.168.150.101:6379&quot;</span>)<br>            .setPassword(<span class="hljs-string">&quot;123321&quot;</span>);<br>        <span class="hljs-comment">// ÂàõÂª∫RedissonClientÂØπË±°</span><br>        <span class="hljs-keyword">return</span> Redisson.create(config);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>‰ΩøÁî®RedissionÁöÑÂàÜÂ∏ÉÂºèÈîÅ</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissionClient redissonClient;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//Ëé∑ÂèñÈîÅ(ÂèØÈáçÂÖ•)ÔºåÊåáÂÆöÈîÅÁöÑÂêçÁß∞</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br>    <span class="hljs-comment">//Â∞ùËØïËé∑ÂèñÈîÅÔºåÂèÇÊï∞ÂàÜÂà´ÊòØÔºöËé∑ÂèñÈîÅÁöÑÊúÄÂ§ßÁ≠âÂæÖÊó∂Èó¥(ÊúüÈó¥‰ºöÈáçËØï)ÔºåÈîÅËá™Âä®ÈáäÊîæÊó∂Èó¥ÔºåÊó∂Èó¥Âçï‰Ωç</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>    <span class="hljs-comment">//Âà§Êñ≠Ëé∑ÂèñÈîÅÊàêÂäü</span><br>    <span class="hljs-keyword">if</span>(isLock)&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;ÊâßË°å‰∏öÂä°&quot;</span>);          <br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            <span class="hljs-comment">//ÈáäÊîæÈîÅ</span><br>            lock.unlock();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="4-11-ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂèØÈáçÂÖ•ÈîÅÂéüÁêÜ"><a href="#4-11-ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂèØÈáçÂÖ•ÈîÅÂéüÁêÜ" class="headerlink" title="4.11 ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂèØÈáçÂÖ•ÈîÅÂéüÁêÜ"></a>4.11 ÂàÜÂ∏ÉÂºèÈîÅ-redissionÂèØÈáçÂÖ•ÈîÅÂéüÁêÜ</h3><p><img src="/img/blogs/java/redis/2.4.7.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ÂàõÂª∫ÈîÅÂØπË±°</span><br>   <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;lock&quot;</span>);<br><br>   <span class="hljs-meta">@Test</span><br>   <span class="hljs-keyword">void</span> <span class="hljs-title function_">method1</span><span class="hljs-params">()</span> &#123;<br>       <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>       <span class="hljs-keyword">if</span> (!isLock) &#123;<br>           log.error(<span class="hljs-string">&quot;Ëé∑ÂèñÈîÅÂ§±Ë¥•,1&quot;</span>);<br>           <span class="hljs-keyword">return</span>;<br>       &#125;<br>       <span class="hljs-keyword">try</span> &#123;<br>           log.info(<span class="hljs-string">&quot;Ëé∑ÂèñÈîÅÊàêÂäü,1&quot;</span>);<br>           method2();<br>       &#125; <span class="hljs-keyword">finally</span> &#123;<br>           log.info(<span class="hljs-string">&quot;ÈáäÊîæÈîÅ,1&quot;</span>);<br>           lock.unlock();<br>       &#125;<br><br>       <span class="hljs-keyword">void</span> <span class="hljs-title function_">method2</span> <span class="hljs-params">()</span> &#123;<br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock();<br>           <span class="hljs-keyword">if</span> (!isLock) &#123;<br>               log.error(<span class="hljs-string">&quot;Ëé∑ÂèñÈîÅÂ§±Ë¥•,2&quot;</span>);<br>               <span class="hljs-keyword">return</span>;<br>           &#125;<br>           <span class="hljs-keyword">try</span> &#123;<br>               log.info(<span class="hljs-string">&quot;Ëé∑ÂèñÈîÅÊàêÂäü,2&quot;</span>);<br>           &#125; <span class="hljs-keyword">finally</span> &#123;<br>               log.info(<span class="hljs-string">&quot;ÈáäÊîæÈîÅ,2&quot;</span>);<br>               lock.unlock();<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-12-ÂàÜÂ∏ÉÂºèÈîÅ-redission-ÈîÅÈáçËØïÂíåWatchDogÊú∫Âà∂"><a href="#4-12-ÂàÜÂ∏ÉÂºèÈîÅ-redission-ÈîÅÈáçËØïÂíåWatchDogÊú∫Âà∂" class="headerlink" title="4.12 ÂàÜÂ∏ÉÂºèÈîÅ-redission ÈîÅÈáçËØïÂíåWatchDogÊú∫Âà∂"></a>4.12 ÂàÜÂ∏ÉÂºèÈîÅ-redission ÈîÅÈáçËØïÂíåWatchDogÊú∫Âà∂</h3><p><img src="/img/blogs/java/redis/2.4.8.png" srcset="/img/loading.gif" lazyload></p>
<p>RedissonÂàÜÂ∏ÉÂºèÈîÅÂéüÁêÜÔºö</p>
<ul>
<li>ÂèØÈáçÂÖ•ÔºöÂà©Áî®hashÁªìÊûÑËÆ∞ÂΩïÁ∫øÁ®ãidÂíåÈáçÂÖ•Ê¨°Êï∞</li>
<li>ÂèØÈáçËØïÔºöÂà©Áî®‰ø°Âè∑ÈáèÂíåPubSubÂäüËÉΩÂÆûÁé∞Á≠âÂæÖ„ÄÅÂî§ÈÜíÔºåËé∑ÂèñÈîÅÂ§±Ë¥•ÁöÑÈáçËØïÊú∫Âà∂</li>
<li>Ë∂ÖÊó∂Áª≠Á∫¶ÔºöÂà©Áî®watchDogÔºåÊØèÈöî‰∏ÄÊÆµÊó∂Èó¥ÔºàreleaseTime &#x2F; 3ÔºâÔºåÈáçÁΩÆË∂ÖÊó∂Êó∂Èó¥</li>
</ul>
<h3 id="4-13-ÂàÜÂ∏ÉÂºèÈîÅ-redission-ÈîÅÁöÑMutiLockÂéüÁêÜ"><a href="#4-13-ÂàÜÂ∏ÉÂºèÈîÅ-redission-ÈîÅÁöÑMutiLockÂéüÁêÜ" class="headerlink" title="4.13 ÂàÜÂ∏ÉÂºèÈîÅ-redission  ÈîÅÁöÑMutiLockÂéüÁêÜ"></a>4.13 ÂàÜÂ∏ÉÂºèÈîÅ-redission  ÈîÅÁöÑMutiLockÂéüÁêÜ</h3><p>redissionÊèêÂá∫Êù•‰∫ÜMutiLockÈîÅÔºå‰ΩøÁî®ËøôÊääÈîÅÂí±‰ª¨Â∞±‰∏ç‰ΩøÁî®‰∏ª‰ªé‰∫Ü,ÊØè‰∏™ËäÇÁÇπÁöÑÂú∞‰ΩçÈÉΩÊòØ‰∏ÄÊ†∑ÁöÑ<br>ËøôÊääÈîÅÂä†ÈîÅÁöÑÈÄªËæëÈúÄË¶ÅÂÜôÂÖ•Âà∞ÊØè‰∏Ä‰∏™‰∏ª‰∏õËäÇÁÇπ‰∏äÔºåÂè™ÊúâÊâÄÊúâÁöÑÊúçÂä°Âô®ÈÉΩÂÜôÂÖ•ÊàêÂäüÔºåÊ≠§Êó∂ÊâçÊòØÂä†ÈîÅÊàêÂäüÔºåÂÅáËÆæÁé∞Âú®Êüê‰∏™ËäÇÁÇπÊåÇ‰∫ÜÔºåÈÇ£‰πà‰ªñÂéªËé∑ÂæóÈîÅÁöÑÊó∂ÂÄôÔºåÂè™Ë¶ÅÊúâ‰∏Ä‰∏™ËäÇÁÇπÊãø‰∏çÂà∞ÔºåÈÉΩ‰∏çËÉΩÁÆóÊòØÂä†ÈîÅÊàêÂäüÔºåÂ∞±‰øùËØÅ‰∫ÜÂä†ÈîÅÁöÑÂèØÈù†ÊÄß„ÄÇ</p>
<p><img src="/img/blogs/java/redis/2.4.9.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="ÊÄªÁªì"><a href="#ÊÄªÁªì" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h4><ol>
<li>‰∏çÂèØÈáçÂÖ•RedisÂàÜÂ∏ÉÂºèÈîÅÔºö<ul>
<li>ÂéüÁêÜÔºöÂà©Áî®setnxÁöÑ‰∫íÊñ•ÊÄßÔºõÂà©Áî®exÈÅøÂÖçÊ≠ªÈîÅÔºõÈáäÊîæÈîÅÊó∂Âà§Êñ≠Á∫øÁ®ãÊ†áÁ§∫</li>
<li>Áº∫Èô∑Ôºö‰∏çÂèØÈáçÂÖ•„ÄÅÊó†Ê≥ïÈáçËØï„ÄÅÈîÅË∂ÖÊó∂Â§±Êïà</li>
</ul>
</li>
<li>ÂèØÈáçÂÖ•ÁöÑRedisÂàÜÂ∏ÉÂºèÈîÅÔºö<ul>
<li>ÂéüÁêÜÔºöÂà©Áî®hashÁªìÊûÑÔºåËÆ∞ÂΩïÁ∫øÁ®ãÊ†áÁ§∫ÂíåÈáçÂÖ•Ê¨°Êï∞ÔºõÂà©Áî®watchDogÂª∂Áª≠ÈîÅÊó∂Èó¥ÔºõÂà©Áî®‰ø°Âè∑ÈáèÊéßÂà∂ÈîÅÈáçËØïÁ≠âÂæÖ</li>
<li>Áº∫Èô∑ÔºöredisÂÆïÊú∫ÂºïËµ∑ÈîÅÂ§±ÊïàÈóÆÈ¢ò</li>
</ul>
</li>
<li>RedissonÁöÑmultiLockÔºö<ul>
<li>ÂéüÁêÜÔºöÂ§ö‰∏™Áã¨Á´ãÁöÑRedisËäÇÁÇπÔºåÂøÖÈ°ªÂú®ÊâÄÊúâËäÇÁÇπÈÉΩËé∑ÂèñÈáçÂÖ•ÈîÅÔºåÊâçÁÆóËé∑ÂèñÈîÅÊàêÂäü</li>
<li>Áº∫Èô∑ÔºöËøêÁª¥ÊàêÊú¨È´ò„ÄÅÂÆûÁé∞Â§çÊùÇ</li>
</ul>
</li>
</ol>
<h2 id="5-RedisÊ∂àÊÅØÈòüÂàó-ÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ"><a href="#5-RedisÊ∂àÊÅØÈòüÂàó-ÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ" class="headerlink" title="5. RedisÊ∂àÊÅØÈòüÂàó(ÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ)"></a>5. RedisÊ∂àÊÅØÈòüÂàó(ÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ)</h2><h3 id="5-1-ËÆ§ËØÜÊ∂àÊÅØÈòüÂàó"><a href="#5-1-ËÆ§ËØÜÊ∂àÊÅØÈòüÂàó" class="headerlink" title="5.1 ËÆ§ËØÜÊ∂àÊÅØÈòüÂàó"></a>5.1 ËÆ§ËØÜÊ∂àÊÅØÈòüÂàó</h3><p>‰ªÄ‰πàÊòØÊ∂àÊÅØÈòüÂàóÔºöÂ≠óÈù¢ÊÑèÊÄùÂ∞±ÊòØÂ≠òÊîæÊ∂àÊÅØÁöÑÈòüÂàó„ÄÇÊúÄÁÆÄÂçïÁöÑÊ∂àÊÅØÈòüÂàóÊ®°ÂûãÂåÖÊã¨3‰∏™ËßíËâ≤Ôºö</p>
<ul>
<li>Ê∂àÊÅØÈòüÂàóÔºöÂ≠òÂÇ®ÂíåÁÆ°ÁêÜÊ∂àÊÅØÔºå‰πüË¢´Áß∞‰∏∫Ê∂àÊÅØ‰ª£ÁêÜÔºàMessage BrokerÔºâ</li>
<li>Áîü‰∫ßËÄÖÔºöÂèëÈÄÅÊ∂àÊÅØÂà∞Ê∂àÊÅØÈòüÂàó</li>
<li>Ê∂àË¥πËÄÖÔºö‰ªéÊ∂àÊÅØÈòüÂàóËé∑ÂèñÊ∂àÊÅØÂπ∂Â§ÑÁêÜÊ∂àÊÅØ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.1.png" srcset="/img/loading.gif" lazyload></p>
<p>RedisÊèê‰æõ‰∫Ü‰∏âÁßç‰∏çÂêåÁöÑÊñπÂºèÊù•ÂÆûÁé∞Ê∂àÊÅØÈòüÂàóÔºö</p>
<ul>
<li>listÁªìÊûÑÔºöÂü∫‰∫éListÁªìÊûÑÊ®°ÊãüÊ∂àÊÅØÈòüÂàó</li>
<li>PubSubÔºöÂü∫Êú¨ÁöÑÁÇπÂØπÁÇπÊ∂àÊÅØÊ®°Âûã</li>
<li>StreamÔºöÊØîËæÉÂÆåÂñÑÁöÑÊ∂àÊÅØÈòüÂàóÊ®°Âûã</li>
</ul>
<h3 id="5-2-Âü∫‰∫éListÂÆûÁé∞Ê∂àÊÅØÈòüÂàó"><a href="#5-2-Âü∫‰∫éListÂÆûÁé∞Ê∂àÊÅØÈòüÂàó" class="headerlink" title="5.2 Âü∫‰∫éListÂÆûÁé∞Ê∂àÊÅØÈòüÂàó"></a>5.2 Âü∫‰∫éListÂÆûÁé∞Ê∂àÊÅØÈòüÂàó</h3><p><strong>Âè™ËÉΩÂçï‰∏™Áîü‰∫ßËÄÖÂçï‰∏™Ê∂àË¥πËÄÖ</strong><br>Ê∂àÊÅØÈòüÂàóÔºàMessage QueueÔºâÔºåÂ≠óÈù¢ÊÑèÊÄùÂ∞±ÊòØÂ≠òÊîæÊ∂àÊÅØÁöÑÈòüÂàó„ÄÇËÄåRedisÁöÑlistÊï∞ÊçÆÁªìÊûÑÊòØ‰∏Ä‰∏™ÂèåÂêëÈìæË°®ÔºåÂæàÂÆπÊòìÊ®°ÊãüÂá∫ÈòüÂàóÊïàÊûú„ÄÇ</p>
<ul>
<li>ÈòüÂàóÊòØÂÖ•Âè£ÂíåÂá∫Âè£‰∏çÂú®‰∏ÄËæπÔºåÂõ†Ê≠§Êàë‰ª¨ÂèØ‰ª•Âà©Áî®ÔºöLPUSH ÁªìÂêà RPOP„ÄÅÊàñËÄÖ RPUSH ÁªìÂêà LPOPÊù•ÂÆûÁé∞„ÄÇ</li>
<li>‰∏çËøáË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÂΩìÈòüÂàó‰∏≠Ê≤°ÊúâÊ∂àÊÅØÊó∂RPOPÊàñLPOPÊìç‰Ωú‰ºöËøîÂõûnullÔºåÂπ∂‰∏çÂÉèJVMÁöÑÈòªÂ°ûÈòüÂàóÈÇ£Ê†∑‰ºöÈòªÂ°ûÂπ∂Á≠âÂæÖÊ∂àÊÅØ„ÄÇÂõ†Ê≠§ËøôÈáåÂ∫îËØ•‰ΩøÁî®BRPOPÊàñËÄÖBLPOPÊù•ÂÆûÁé∞ÈòªÂ°ûÊïàÊûú„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Âü∫‰∫éListÁöÑÊ∂àÊÅØÈòüÂàóÊúâÂì™‰∫õ‰ºòÁº∫ÁÇπ</strong>?</p>
<ul>
<li><p>‰ºòÁÇπÔºö</p>
<ul>
<li>Âà©Áî®RedisÂ≠òÂÇ®Ôºå‰∏çÂèóÈôê‰∫éJVMÂÜÖÂ≠ò‰∏äÈôê</li>
<li>Âü∫‰∫éRedisÁöÑÊåÅ‰πÖÂåñÊú∫Âà∂ÔºåÊï∞ÊçÆÂÆâÂÖ®ÊÄßÊúâ‰øùËØÅ</li>
<li>ÂèØ‰ª•Êª°Ë∂≥Ê∂àÊÅØÊúâÂ∫èÊÄß</li>
</ul>
</li>
<li><p>Áº∫ÁÇπÔºö</p>
<ul>
<li>Êó†Ê≥ïÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§±</li>
<li>Âè™ÊîØÊåÅÂçïÊ∂àË¥πËÄÖ</li>
</ul>
</li>
</ul>
<h3 id="5-3-Âü∫‰∫éPubSubÁöÑÊ∂àÊÅØÈòüÂàó"><a href="#5-3-Âü∫‰∫éPubSubÁöÑÊ∂àÊÅØÈòüÂàó" class="headerlink" title="5.3 Âü∫‰∫éPubSubÁöÑÊ∂àÊÅØÈòüÂàó"></a>5.3 Âü∫‰∫éPubSubÁöÑÊ∂àÊÅØÈòüÂàó</h3><p><strong>ÂèØ‰ª•Â§öÁîü‰∫ßÂ§öÊ∂àË¥π</strong><br>PubSubÔºàÂèëÂ∏ÉËÆ¢ÈòÖÔºâÊòØRedis2.0ÁâàÊú¨ÂºïÂÖ•ÁöÑÊ∂àÊÅØ‰º†ÈÄíÊ®°Âûã„ÄÇÈ°æÂêçÊÄù‰πâÔºå<strong>Ê∂àË¥πËÄÖÂèØ‰ª•ËÆ¢ÈòÖ‰∏Ä‰∏™ÊàñÂ§ö‰∏™channel</strong>ÔºåÁîü‰∫ßËÄÖÂêëÂØπÂ∫îchannelÂèëÈÄÅÊ∂àÊÅØÂêéÔºåÊâÄÊúâËÆ¢ÈòÖËÄÖÈÉΩËÉΩÊî∂Âà∞Áõ∏ÂÖ≥Ê∂àÊÅØ„ÄÇ</p>
<p>Â∏∏Áî®ÂëΩ‰ª§Ôºö</p>
<ul>
<li><code>SUBSCRIBE channel [channel]</code> ÔºöËÆ¢ÈòÖ‰∏Ä‰∏™ÊàñÂ§ö‰∏™È¢ëÈÅì</li>
<li><code>PUBLISH channel msg</code> ÔºöÂêë‰∏Ä‰∏™È¢ëÈÅìÂèëÈÄÅÊ∂àÊÅØ</li>
<li><code>PSUBSCRIBE pattern[pattern]</code> ÔºöËÆ¢ÈòÖ‰∏épatternÊ†ºÂºèÂåπÈÖçÁöÑÊâÄÊúâÈ¢ëÈÅì</li>
</ul>
<p><img src="/img/blogs/java/redis/2.5.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Âü∫‰∫éPubSubÁöÑÊ∂àÊÅØÈòüÂàóÊúâÂì™‰∫õ‰ºòÁº∫ÁÇπÔºü</strong><br>‰ºòÁÇπÔºö</p>
<ul>
<li>ÈááÁî®ÂèëÂ∏ÉËÆ¢ÈòÖÊ®°ÂûãÔºåÊîØÊåÅÂ§öÁîü‰∫ß„ÄÅÂ§öÊ∂àË¥π</li>
</ul>
<p>Áº∫ÁÇπÔºö</p>
<ul>
<li>‰∏çÊîØÊåÅÊï∞ÊçÆÊåÅ‰πÖÂåñ</li>
<li>Êó†Ê≥ïÈÅøÂÖçÊ∂àÊÅØ‰∏¢Â§±</li>
<li>Ê∂àÊÅØÂ†ÜÁßØÊúâ‰∏äÈôêÔºåË∂ÖÂá∫Êó∂Êï∞ÊçÆ‰∏¢Â§±</li>
</ul>
<h3 id="5-4-Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó"><a href="#5-4-Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó" class="headerlink" title="5.4 Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó"></a>5.4 Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó</h3><p>Stream ÊòØ Redis 5.0 ÂºïÂÖ•ÁöÑ‰∏ÄÁßçÊñ∞Êï∞ÊçÆÁ±ªÂûãÔºåÂèØ‰ª•ÂÆûÁé∞‰∏Ä‰∏™ÂäüËÉΩÈùûÂ∏∏ÂÆåÂñÑÁöÑÊ∂àÊÅØÈòüÂàó„ÄÇ</p>
<ol>
<li>ÂèëÈÄÅÊ∂àÊÅØÁöÑÂëΩ‰ª§Ôºö</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.4.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>ËØªÂèñÊ∂àÊÅØÁöÑÊñπÂºè‰πã‰∏ÄÔºöXREAD</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.5.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>XREADÈòªÂ°ûÊñπÂºèÔºåËØªÂèñÊúÄÊñ∞ÁöÑÊ∂àÊÅØÔºö</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.6.png" srcset="/img/loading.gif" lazyload></p>
<ol start="4">
<li>Âú®‰∏öÂä°ÂºÄÂèë‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•Âæ™ÁéØÁöÑË∞ÉÁî®XREADÈòªÂ°ûÊñπÂºèÊù•Êü•ËØ¢ÊúÄÊñ∞Ê∂àÊÅØÔºå‰ªéËÄåÂÆûÁé∞ÊåÅÁª≠ÁõëÂê¨ÈòüÂàóÁöÑÊïàÊûúÔºå‰º™‰ª£Á†ÅÂ¶Ç‰∏ã</li>
</ol>
<p><img src="/img/blogs/java/redis/2.5.7.png" srcset="/img/loading.gif" lazyload></p>
<p>STREAMÁ±ªÂûãÊ∂àÊÅØÈòüÂàóÁöÑXREADÂëΩ‰ª§ÁâπÁÇπÔºö</p>
<ul>
<li>Ê∂àÊÅØÂèØÂõûÊ∫Ø</li>
<li>‰∏Ä‰∏™Ê∂àÊÅØÂèØ‰ª•Ë¢´Â§ö‰∏™Ê∂àË¥πËÄÖËØªÂèñ</li>
<li>ÂèØ‰ª•ÈòªÂ°ûËØªÂèñ</li>
<li>ÊúâÊ∂àÊÅØÊºèËØªÁöÑÈ£éÈô©</li>
</ul>
<h3 id="5-5-Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó-Ê∂àË¥πËÄÖÁªÑ"><a href="#5-5-Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó-Ê∂àË¥πËÄÖÁªÑ" class="headerlink" title="5.5 Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó-Ê∂àË¥πËÄÖÁªÑ"></a>5.5 Âü∫‰∫éStreamÁöÑÊ∂àÊÅØÈòüÂàó-Ê∂àË¥πËÄÖÁªÑ</h3><p>Ê∂àË¥πËÄÖÁªÑÔºàConsumer GroupÔºâÔºöÂ∞ÜÂ§ö‰∏™Ê∂àË¥πËÄÖÂàíÂàÜÂà∞‰∏Ä‰∏™ÁªÑ‰∏≠ÔºåÁõëÂê¨Âêå‰∏Ä‰∏™ÈòüÂàó„ÄÇÂÖ∑Â§á‰∏ãÂàóÁâπÁÇπÔºö</p>
<ul>
<li><strong>Ê∂àÊÅØÂàÜÊµÅ</strong><ul>
<li>ÈòüÂàó‰∏≠ÁöÑÊ∂àÊÅØ‰ºöÂàÜÊµÅÁªôÁªÑÂÜÖÁöÑ‰∏çÂêåÊ∂àË¥πËÄÖÔºåËÄå‰∏çÊòØÈáçÂ§çÊ∂àË¥πÔºå‰ªéËÄåÂä†Âø´Ê∂àÊÅØÂ§ÑÁêÜÁöÑÈÄüÂ∫¶</li>
</ul>
</li>
<li><strong>Ê∂àÊÅØÊ†áÁ§∫</strong><ul>
<li>Ê∂àË¥πËÄÖÁªÑ‰ºöÁª¥Êä§‰∏Ä‰∏™Ê†áÁ§∫ÔºåËÆ∞ÂΩïÊúÄÂêé‰∏Ä‰∏™Ë¢´Â§ÑÁêÜÁöÑÊ∂àÊÅØÔºåÂì™ÊÄïÊ∂àË¥πËÄÖÂÆïÊú∫ÈáçÂêØÔºåËøò‰ºö‰ªéÊ†áÁ§∫‰πãÂêéËØªÂèñÊ∂àÊÅØ„ÄÇÁ°Æ‰øùÊØè‰∏Ä‰∏™Ê∂àÊÅØÈÉΩ‰ºöË¢´Ê∂àË¥π</li>
</ul>
</li>
<li><strong>Ê∂àÊÅØÁ°ÆËÆ§</strong><ul>
<li>Ê∂àË¥πËÄÖËé∑ÂèñÊ∂àÊÅØÂêéÔºåÊ∂àÊÅØÂ§Ñ‰∫épendingÁä∂ÊÄÅÔºåÂπ∂Â≠òÂÖ•‰∏Ä‰∏™pending-list„ÄÇÂΩìÂ§ÑÁêÜÂÆåÊàêÂêéÈúÄË¶ÅÈÄöËøáXACKÊù•Á°ÆËÆ§Ê∂àÊÅØÔºåÊ†áËÆ∞Ê∂àÊÅØ‰∏∫Â∑≤Â§ÑÁêÜÔºåÊâç‰ºö‰ªépending-listÁßªÈô§„ÄÇ</li>
</ul>
</li>
</ul>
<p><strong>ÂàõÂª∫Ê∂àË¥πËÄÖÁªÑ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP CREATE  key groupName ID [MKSTREAM]<br></code></pre></td></tr></table></figure>

<ul>
<li>keyÔºöÈòüÂàóÂêçÁß∞</li>
<li>groupNameÔºöÊ∂àË¥πËÄÖÁªÑÂêçÁß∞</li>
<li>IDÔºöËµ∑ÂßãIDÊ†áÁ§∫Ôºå$‰ª£Ë°®ÈòüÂàó‰∏≠ÊúÄÂêé‰∏Ä‰∏™Ê∂àÊÅØÔºå0Âàô‰ª£Ë°®ÈòüÂàó‰∏≠Á¨¨‰∏Ä‰∏™Ê∂àÊÅØ</li>
<li>MKSTREAMÔºöÈòüÂàó‰∏çÂ≠òÂú®Êó∂Ëá™Âä®ÂàõÂª∫ÈòüÂàó</li>
</ul>
<p><strong>Âà†Èô§ÊåáÂÆöÁöÑÊ∂àË¥πËÄÖÁªÑ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP DESTORY key groupName<br></code></pre></td></tr></table></figure>

<p> <strong>ÁªôÊåáÂÆöÁöÑÊ∂àË¥πËÄÖÁªÑÊ∑ªÂä†Ê∂àË¥πËÄÖ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP CREATECONSUMER key groupname consumername<br></code></pre></td></tr></table></figure>

<p> <strong>Âà†Èô§Ê∂àË¥πËÄÖÁªÑ‰∏≠ÁöÑÊåáÂÆöÊ∂àË¥πËÄÖ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XGROUP DELCONSUMER key groupname consumername<br></code></pre></td></tr></table></figure>

<p><strong>‰ªéÊ∂àË¥πËÄÖÁªÑËØªÂèñÊ∂àÊÅØ</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">XREADGROUP GROUP group consumer [COUNT count] [BLOCK milliseconds] [NOACK] STREAMS key [key ...] ID [ID ...]<br></code></pre></td></tr></table></figure>

<ul>
<li>groupÔºöÊ∂àË¥πÁªÑÂêçÁß∞</li>
<li>consumerÔºöÊ∂àË¥πËÄÖÂêçÁß∞ÔºåÂ¶ÇÊûúÊ∂àË¥πËÄÖ‰∏çÂ≠òÂú®Ôºå‰ºöËá™Âä®ÂàõÂª∫‰∏Ä‰∏™Ê∂àË¥πËÄÖ</li>
<li>countÔºöÊú¨Ê¨°Êü•ËØ¢ÁöÑÊúÄÂ§ßÊï∞Èáè</li>
<li>BLOCK millisecondsÔºöÂΩìÊ≤°ÊúâÊ∂àÊÅØÊó∂ÊúÄÈïøÁ≠âÂæÖÊó∂Èó¥</li>
<li>NOACKÔºöÊó†ÈúÄÊâãÂä®ACKÔºåËé∑ÂèñÂà∞Ê∂àÊÅØÂêéËá™Âä®Á°ÆËÆ§</li>
<li>STREAMS keyÔºöÊåáÂÆöÈòüÂàóÂêçÁß∞</li>
<li>IDÔºöËé∑ÂèñÊ∂àÊÅØÁöÑËµ∑ÂßãIDÔºö<ul>
<li>‚Äú&gt;‚ÄùÔºö‰ªé‰∏ã‰∏Ä‰∏™Êú™Ê∂àË¥πÁöÑÊ∂àÊÅØÂºÄÂßã</li>
<li>ÂÖ∂ÂÆÉÔºöÊ†πÊçÆÊåáÂÆöid‰ªépending-list‰∏≠Ëé∑ÂèñÂ∑≤Ê∂àË¥π‰ΩÜÊú™Á°ÆËÆ§ÁöÑÊ∂àÊÅØÔºå‰æãÂ¶Ç0ÔºåÊòØ‰ªépending-list‰∏≠ÁöÑÁ¨¨‰∏Ä‰∏™Ê∂àÊÅØÂºÄÂßã</li>
</ul>
</li>
</ul>
<p><strong>Ê∂àË¥πËÄÖÁõëÂê¨Ê∂àÊÅØÁöÑÂü∫Êú¨ÊÄùË∑Ø</strong>:</p>
<p><img src="/img/blogs/java/redis/2.5.8.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>STREAMÁ±ªÂûãÊ∂àÊÅØÈòüÂàóÁöÑXREADGROUPÂëΩ‰ª§ÁâπÁÇπ</strong>Ôºö</p>
<ul>
<li>Ê∂àÊÅØÂèØÂõûÊ∫Ø</li>
<li>ÂèØ‰ª•Â§öÊ∂àË¥πËÄÖ‰∫âÊä¢Ê∂àÊÅØÔºåÂä†Âø´Ê∂àË¥πÈÄüÂ∫¶</li>
<li>ÂèØ‰ª•ÈòªÂ°ûËØªÂèñ</li>
<li>Ê≤°ÊúâÊ∂àÊÅØÊºèËØªÁöÑÈ£éÈô©</li>
<li>ÊúâÊ∂àÊÅØÁ°ÆËÆ§Êú∫Âà∂Ôºå‰øùËØÅÊ∂àÊÅØËá≥Â∞ëË¢´Ê∂àË¥π‰∏ÄÊ¨°</li>
</ul>
<p><strong>ÂØπÊØî</strong>Ôºö</p>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>PubSub</th>
<th>Stream</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Ê∂àÊÅØÊåÅ‰πÖÂåñ</strong></td>
<td>ÊîØÊåÅ</td>
<td>‰∏çÊîØÊåÅ</td>
<td>ÊîØÊåÅ</td>
</tr>
<tr>
<td><strong>ÈòªÂ°ûËØªÂèñ</strong></td>
<td>ÊîØÊåÅ</td>
<td>ÊîØÊåÅ</td>
<td>ÊîØÊåÅ</td>
</tr>
<tr>
<td><strong>Ê∂àÊÅØÂ†ÜÁßØÂ§ÑÁêÜ</strong></td>
<td>ÂèóÈôê‰∫éÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂèØ‰ª•Âà©Áî®Â§öÊ∂àË¥πËÄÖÂä†Âø´Â§ÑÁêÜ</td>
<td>ÂèóÈôê‰∫éÊ∂àË¥πËÄÖÁºìÂÜ≤Âå∫</td>
<td>ÂèóÈôê‰∫éÈòüÂàóÈïøÂ∫¶ÔºåÂèØ‰ª•Âà©Áî®Ê∂àË¥πËÄÖÁªÑÊèêÈ´òÊ∂àË¥πÈÄüÂ∫¶ÔºåÂáèÂ∞ëÂ†ÜÁßØ</td>
</tr>
<tr>
<td><strong>Ê∂àÊÅØÁ°ÆËÆ§Êú∫Âà∂</strong></td>
<td>‰∏çÊîØÊåÅ</td>
<td>‰∏çÊîØÊåÅ</td>
<td>ÊîØÊåÅ</td>
</tr>
<tr>
<td><strong>Ê∂àÊÅØÂõûÊ∫Ø</strong></td>
<td>‰∏çÊîØÊåÅ</td>
<td>‰∏çÊîØÊåÅ</td>
<td>ÊîØÊåÅ</td>
</tr>
</tbody></table>
<h3 id="5-6-Âü∫‰∫éRedisÁöÑStreamÁªìÊûÑ‰Ωú‰∏∫Ê∂àÊÅØÈòüÂàóÔºåÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ‰∏ãÂçï"><a href="#5-6-Âü∫‰∫éRedisÁöÑStreamÁªìÊûÑ‰Ωú‰∏∫Ê∂àÊÅØÈòüÂàóÔºåÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ‰∏ãÂçï" class="headerlink" title="5.6 Âü∫‰∫éRedisÁöÑStreamÁªìÊûÑ‰Ωú‰∏∫Ê∂àÊÅØÈòüÂàóÔºåÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ‰∏ãÂçï"></a>5.6 Âü∫‰∫éRedisÁöÑStreamÁªìÊûÑ‰Ωú‰∏∫Ê∂àÊÅØÈòüÂàóÔºåÂÆûÁé∞ÂºÇÊ≠•ÁßíÊùÄ‰∏ãÂçï</h3><ul>
<li>ÂàõÂª∫‰∏Ä‰∏™StreamÁ±ªÂûãÁöÑÊ∂àÊÅØÈòüÂàóÔºåÂêç‰∏∫stream.orders</li>
<li>‰øÆÊîπ‰πãÂâçÁöÑÁßíÊùÄ‰∏ãÂçïLuaËÑöÊú¨ÔºåÂú®ËÆ§ÂÆöÊúâÊä¢Ë¥≠ËµÑÊ†ºÂêéÔºåÁõ¥Êé•Âêëstream.orders‰∏≠Ê∑ªÂä†Ê∂àÊÅØÔºåÂÜÖÂÆπÂåÖÂê´voucherId„ÄÅuserId„ÄÅorderId</li>
<li>È°πÁõÆÂêØÂä®Êó∂ÔºåÂºÄÂêØ‰∏Ä‰∏™Á∫øÁ®ã‰ªªÂä°ÔºåÂ∞ùËØïËé∑Âèñstream.orders‰∏≠ÁöÑÊ∂àÊÅØÔºåÂÆåÊàê‰∏ãÂçï</li>
</ul>
<p><strong>VoucherOrderServiceImpl</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VoucherOrderHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1.Ëé∑ÂèñÊ∂àÊÅØÈòüÂàó‰∏≠ÁöÑËÆ¢Âçï‰ø°ÊÅØ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 &gt;</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>).block(Duration.ofSeconds(<span class="hljs-number">2</span>)),<br>                    StreamOffset.create(<span class="hljs-string">&quot;stream.orders&quot;</span>, ReadOffset.lastConsumed())<br>                );<br>                <span class="hljs-comment">// 2.Âà§Êñ≠ËÆ¢Âçï‰ø°ÊÅØÊòØÂê¶‰∏∫Á©∫</span><br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// Â¶ÇÊûú‰∏∫nullÔºåËØ¥ÊòéÊ≤°ÊúâÊ∂àÊÅØÔºåÁªßÁª≠‰∏ã‰∏ÄÊ¨°Âæ™ÁéØ</span><br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-comment">// Ëß£ÊûêÊï∞ÊçÆ</span><br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; value = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 3.ÂàõÂª∫ËÆ¢Âçï</span><br>                createVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// 4.Á°ÆËÆ§Ê∂àÊÅØ XACK</span><br>                stringRedisTemplate.opsForStream().acknowledge(<span class="hljs-string">&quot;s1&quot;</span>, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;Â§ÑÁêÜËÆ¢ÂçïÂºÇÂ∏∏&quot;</span>, e);<br>                <span class="hljs-comment">//Â§ÑÁêÜÂºÇÂ∏∏Ê∂àÊÅØ</span><br>                handlePendingList();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handlePendingList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// 1.Ëé∑Âèñpending-list‰∏≠ÁöÑËÆ¢Âçï‰ø°ÊÅØ XREADGROUP GROUP g1 c1 COUNT 1 BLOCK 2000 STREAMS s1 0</span><br>                List&lt;MapRecord&lt;String, Object, Object&gt;&gt; list = stringRedisTemplate.opsForStream().read(<br>                    Consumer.from(<span class="hljs-string">&quot;g1&quot;</span>, <span class="hljs-string">&quot;c1&quot;</span>),<br>                    StreamReadOptions.empty().count(<span class="hljs-number">1</span>),<br>                    StreamOffset.create(<span class="hljs-string">&quot;stream.orders&quot;</span>, ReadOffset.from(<span class="hljs-string">&quot;0&quot;</span>))<br>                );<br>                <span class="hljs-comment">// 2.Âà§Êñ≠ËÆ¢Âçï‰ø°ÊÅØÊòØÂê¶‰∏∫Á©∫</span><br>                <span class="hljs-keyword">if</span> (list == <span class="hljs-literal">null</span> || list.isEmpty()) &#123;<br>                    <span class="hljs-comment">// Â¶ÇÊûú‰∏∫nullÔºåËØ¥ÊòéÊ≤°ÊúâÂºÇÂ∏∏Ê∂àÊÅØÔºåÁªìÊùüÂæ™ÁéØ</span><br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>                <span class="hljs-comment">// Ëß£ÊûêÊï∞ÊçÆ</span><br>                MapRecord&lt;String, Object, Object&gt; record = list.get(<span class="hljs-number">0</span>);<br>                Map&lt;Object, Object&gt; value = record.getValue();<br>                <span class="hljs-type">VoucherOrder</span> <span class="hljs-variable">voucherOrder</span> <span class="hljs-operator">=</span> BeanUtil.fillBeanWithMap(value, <span class="hljs-keyword">new</span> <span class="hljs-title class_">VoucherOrder</span>(), <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">// 3.ÂàõÂª∫ËÆ¢Âçï</span><br>                createVoucherOrder(voucherOrder);<br>                <span class="hljs-comment">// 4.Á°ÆËÆ§Ê∂àÊÅØ XACK</span><br>                stringRedisTemplate.opsForStream().acknowledge(<span class="hljs-string">&quot;s1&quot;</span>, <span class="hljs-string">&quot;g1&quot;</span>, record.getId());<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;Â§ÑÁêÜpenddingËÆ¢ÂçïÂºÇÂ∏∏&quot;</span>, e);<br>                <span class="hljs-keyword">try</span>&#123;<br>                    Thread.sleep(<span class="hljs-number">20</span>);<br>                &#125;<span class="hljs-keyword">catch</span>(Exception e)&#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="6-Ëææ‰∫∫Êé¢Â∫ó"><a href="#6-Ëææ‰∫∫Êé¢Â∫ó" class="headerlink" title="6. Ëææ‰∫∫Êé¢Â∫ó"></a>6. Ëææ‰∫∫Êé¢Â∫ó</h2><h3 id="6-1-ÂèëÂ∏ÉÊé¢Â∫óÁ¨îËÆ∞"><a href="#6-1-ÂèëÂ∏ÉÊé¢Â∫óÁ¨îËÆ∞" class="headerlink" title="6.1 ÂèëÂ∏ÉÊé¢Â∫óÁ¨îËÆ∞"></a>6.1 ÂèëÂ∏ÉÊé¢Â∫óÁ¨îËÆ∞</h3><p>Êé¢Â∫óÁ¨îËÆ∞Á±ª‰ººÁÇπËØÑÁΩëÁ´ôÁöÑËØÑ‰ª∑ÔºåÂæÄÂæÄÊòØÂõæÊñáÁªìÂêà„ÄÇÂØπÂ∫îÁöÑË°®Êúâ‰∏§‰∏™Ôºö</p>
<ul>
<li>tb_blogÔºöÊé¢Â∫óÁ¨îËÆ∞Ë°®ÔºåÂåÖÂê´Á¨îËÆ∞‰∏≠ÁöÑÊ†áÈ¢ò„ÄÅÊñáÂ≠ó„ÄÅÂõæÁâáÁ≠â</li>
<li>tb_blog_commentsÔºöÂÖ∂‰ªñÁî®Êà∑ÂØπÊé¢Â∫óÁ¨îËÆ∞ÁöÑËØÑ‰ª∑</li>
</ul>
<h4 id="6-1-1-‰∏ä‰º†Êé•Âè£"><a href="#6-1-1-‰∏ä‰º†Êé•Âè£" class="headerlink" title="6.1.1 ‰∏ä‰º†Êé•Âè£"></a>6.1.1 ‰∏ä‰º†Êé•Âè£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;upload&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UploadController</span> &#123;<br><br>    <span class="hljs-meta">@PostMapping(&quot;blog&quot;)</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">uploadImage</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(&quot;file&quot;)</span> MultipartFile image)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// Ëé∑ÂèñÂéüÂßãÊñá‰ª∂ÂêçÁß∞</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> image.getOriginalFilename();<br>            <span class="hljs-comment">// ÁîüÊàêÊñ∞Êñá‰ª∂Âêç</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> createNewFileName(originalFilename);<br>            <span class="hljs-comment">// ‰øùÂ≠òÊñá‰ª∂</span><br>            image.transferTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(SystemConstants.IMAGE_UPLOAD_DIR, fileName));<br>            <span class="hljs-comment">// ËøîÂõûÁªìÊûú</span><br>            log.debug(<span class="hljs-string">&quot;Êñá‰ª∂‰∏ä‰º†ÊàêÂäüÔºå&#123;&#125;&quot;</span>, fileName);<br>            <span class="hljs-keyword">return</span> Result.ok(fileName);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Êñá‰ª∂‰∏ä‰º†Â§±Ë¥•&quot;</span>, e);<br>        &#125;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-1-2-BlogController"><a href="#6-1-2-BlogController" class="headerlink" title="6.1.2 BlogController"></a>6.1.2 BlogController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;/blog&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BlogController</span> &#123;<br><br>    <span class="hljs-meta">@Resource</span><br>    <span class="hljs-keyword">private</span> IBlogService blogService;<br><br>    <span class="hljs-meta">@PostMapping</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Blog blog)</span> &#123;<br>        <span class="hljs-comment">//Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>        <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>        blog.setUpdateTime(user.getId());<br>        <span class="hljs-comment">//‰øùÂ≠òÊé¢Â∫óÂçöÊñá</span><br>        blogService.saveBlog(blog);<br>        <span class="hljs-comment">//ËøîÂõûid</span><br>        <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="6-1-3-BlogServiceImpl"><a href="#6-1-3-BlogServiceImpl" class="headerlink" title="6.1.3 BlogServiceImpl"></a>6.1.3 BlogServiceImpl</h4><p>ÂÆûÁé∞Êü•ÁúãÂèëÂ∏ÉÊé¢Â∫óÁ¨îËÆ∞ÁöÑÊé•Âè£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 1.Êü•ËØ¢blog</span><br>    <span class="hljs-type">Blog</span> <span class="hljs-variable">blog</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-keyword">if</span> (blog == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Á¨îËÆ∞‰∏çÂ≠òÂú®ÔºÅ&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 2.Êü•ËØ¢blogÊúâÂÖ≥ÁöÑÁî®Êà∑</span><br>    queryBlogUser(blog);<br>  <br>    <span class="hljs-keyword">return</span> Result.ok(blog);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-2-ÁÇπËµûÂäüËÉΩ"><a href="#6-2-ÁÇπËµûÂäüËÉΩ" class="headerlink" title="6.2 ÁÇπËµûÂäüËÉΩ"></a>6.2 ÁÇπËµûÂäüËÉΩ</h3><p>ÈúÄÊ±ÇÔºö</p>
<ul>
<li><strong>Âêå‰∏Ä‰∏™Áî®Êà∑Âè™ËÉΩÁÇπËµû‰∏ÄÊ¨°</strong>ÔºåÂÜçÊ¨°ÁÇπÂáªÂàôÂèñÊ∂àÁÇπËµû</li>
<li>Â¶ÇÊûúÂΩìÂâçÁî®Êà∑<strong>Â∑≤ÁªèÁÇπËµûÔºåÂàôÁÇπËµûÊåâÈíÆÈ´ò‰∫ÆÊòæÁ§∫</strong>ÔºàÂâçÁ´ØÂ∑≤ÂÆûÁé∞ÔºåÂà§Êñ≠Â≠óÊÆµBlogÁ±ªÁöÑisLikeÂ±ûÊÄßÔºâ</li>
</ul>
<ul>
<li>‰∏∫‰ªÄ‰πà<strong>ÈááÁî®setÈõÜÂêà</strong>ÔºöÂõ†‰∏∫Êàë‰ª¨ÁöÑÊï∞ÊçÆÊòØ‰∏çËÉΩÈáçÂ§çÁöÑ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>   <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span>&#123;<br>       <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>       <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>       <span class="hljs-comment">// 2.Âà§Êñ≠ÂΩìÂâçÁôªÂΩïÁî®Êà∑ÊòØÂê¶Â∑≤ÁªèÁÇπËµû</span><br>       <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>       <span class="hljs-type">Boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForSet().isMember(key, userId.toString());<br>       <span class="hljs-keyword">if</span>(BooleanUtil.isFalse(isMember))&#123;<br>            <span class="hljs-comment">//3.Â¶ÇÊûúÊú™ÁÇπËµûÔºåÂèØ‰ª•ÁÇπËµû</span><br>           <span class="hljs-comment">//3.1 Êï∞ÊçÆÂ∫ìÁÇπËµûÊï∞+1</span><br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>           <span class="hljs-comment">//3.2 ‰øùÂ≠òÁî®Êà∑Âà∞RedisÁöÑsetÈõÜÂêà</span><br>           <span class="hljs-keyword">if</span>(isSuccess)&#123;<br>               stringRedisTemplate.opsForSet().add(key,userId.toString());<br>           &#125;<br>       &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//4.Â¶ÇÊûúÂ∑≤ÁÇπËµûÔºåÂèñÊ∂àÁÇπËµû</span><br>           <span class="hljs-comment">//4.1 Êï∞ÊçÆÂ∫ìÁÇπËµûÊï∞-1</span><br>           <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>           <span class="hljs-comment">//4.2 ÊääÁî®Êà∑‰ªéRedisÁöÑsetÈõÜÂêàÁßªÈô§</span><br>           <span class="hljs-keyword">if</span>(isSuccess)&#123;<br>               stringRedisTemplate.opsForSet().remove(key,userId.toString());<br>           &#125;<br>       &#125;<br></code></pre></td></tr></table></figure>

<p>ÂÆûÁé∞Ê≠•È™§Ôºö</p>
<ul>
<li>ÁªôBlogÁ±ª‰∏≠Ê∑ªÂä†‰∏Ä‰∏™isLikeÂ≠óÊÆµÔºåÊ†áÁ§∫ÊòØÂê¶Ë¢´ÂΩìÂâçÁî®Êà∑ÁÇπËµû</li>
<li>‰øÆÊîπÁÇπËµûÂäüËÉΩÔºåÂà©Áî®RedisÁöÑsetÈõÜÂêàÂà§Êñ≠ÊòØÂê¶ÁÇπËµûËøáÔºåÊú™ÁÇπËµûËøáÂàôÁÇπËµûÊï∞+1ÔºåÂ∑≤ÁÇπËµûËøáÂàôÁÇπËµûÊï∞-1</li>
<li>‰øÆÊîπÊ†πÊçÆidÊü•ËØ¢BlogÁöÑ‰∏öÂä°ÔºåÂà§Êñ≠ÂΩìÂâçÁôªÂΩïÁî®Êà∑ÊòØÂê¶ÁÇπËµûËøáÔºåËµãÂÄºÁªôisLikeÂ≠óÊÆµ</li>
<li>‰øÆÊîπÂàÜÈ°µÊü•ËØ¢Blog‰∏öÂä°ÔºåÂà§Êñ≠ÂΩìÂâçÁôªÂΩïÁî®Êà∑ÊòØÂê¶ÁÇπËµûËøáÔºåËµãÂÄºÁªôisLikeÂ≠óÊÆµ</li>
</ul>
<h3 id="6-3-ÁÇπËµûÊéíË°åÊ¶ú"><a href="#6-3-ÁÇπËµûÊéíË°åÊ¶ú" class="headerlink" title="6.3 ÁÇπËµûÊéíË°åÊ¶ú"></a>6.3 ÁÇπËµûÊéíË°åÊ¶ú</h3><p>Âú®Êé¢Â∫óÁ¨îËÆ∞ÁöÑËØ¶ÊÉÖÈ°µÈù¢ÔºåÂ∫îËØ•ÊääÁªôËØ•Á¨îËÆ∞ÁÇπËµûÁöÑ‰∫∫ÊòæÁ§∫Âá∫Êù•ÔºåÊØîÂ¶ÇÊúÄÊó©ÁÇπËµûÁöÑTOP5ÔºåÂΩ¢ÊàêÁÇπËµûÊéíË°åÊ¶ú</p>
<p>‰πãÂâçÁöÑÁÇπËµûÊòØÊîæÂà∞setÈõÜÂêàÔºå‰ΩÜÊòØsetÈõÜÂêàÊòØ‰∏çËÉΩÊéíÂ∫èÁöÑÔºåÊâÄ‰ª•Ëøô‰∏™Êó∂ÂÄôÔºåÂí±‰ª¨ÂèØ‰ª•ÈááÁî®‰∏Ä‰∏™ÂèØ‰ª•ÊéíÂ∫èÁöÑsetÈõÜÂêàÔºåÂ∞±ÊòØÂí±‰ª¨ÁöÑsortedSet</p>
<table>
<thead>
<tr>
<th></th>
<th>List</th>
<th>Set</th>
<th>SortedSet</th>
</tr>
</thead>
<tbody><tr>
<td>ÊéíÂ∫èÊñπÂºè</td>
<td>ÊåâÊ∑ªÂä†È°∫Â∫èÊéíÂ∫è</td>
<td>Êó†Ê≥ïÊéíÂ∫è</td>
<td>Ê†πÊçÆscoreÂÄºÊéíÂ∫è</td>
</tr>
<tr>
<td>ÂîØ‰∏ÄÊÄß</td>
<td>‰∏çÂîØ‰∏Ä</td>
<td>ÂîØ‰∏Ä</td>
<td>ÂîØ‰∏Ä</td>
</tr>
<tr>
<td>Êü•ÊâæÊñπÂºè</td>
<td>ÊåâÁ¥¢ÂºïÊü•ÊâæÊàñÈ¶ñÂ∞æÊü•Êâæ</td>
<td>Ê†πÊçÆÂÖÉÁ¥†Êü•Êâæ</td>
<td>Ê†πÊçÆÂÖÉÁ¥†Êü•Êâæ</td>
</tr>
</tbody></table>
<h4 id="6-3-1-BlogServiceImpl"><a href="#6-3-1-BlogServiceImpl" class="headerlink" title="6.3.1 BlogServiceImpl"></a>6.3.1 BlogServiceImpl</h4><p>ÁÇπËµûÈÄªËæë‰ª£Á†Å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">likeBlog</span><span class="hljs-params">(Long id)</span> &#123;<br>     <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>     <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>     <span class="hljs-comment">// 2.Âà§Êñ≠ÂΩìÂâçÁôªÂΩïÁî®Êà∑ÊòØÂê¶Â∑≤ÁªèÁÇπËµû</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>     <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>     <span class="hljs-keyword">if</span> (score == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// 3.Â¶ÇÊûúÊú™ÁÇπËµûÔºåÂèØ‰ª•ÁÇπËµû</span><br>         <span class="hljs-comment">// 3.1.Êï∞ÊçÆÂ∫ìÁÇπËµûÊï∞ + 1</span><br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked + 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>         <span class="hljs-comment">// 3.2.‰øùÂ≠òÁî®Êà∑Âà∞RedisÁöÑsetÈõÜÂêà  zadd key value score</span><br>         <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>             stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br>         &#125;<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-comment">// 4.Â¶ÇÊûúÂ∑≤ÁÇπËµûÔºåÂèñÊ∂àÁÇπËµû</span><br>         <span class="hljs-comment">// 4.1.Êï∞ÊçÆÂ∫ìÁÇπËµûÊï∞ -1</span><br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> update().setSql(<span class="hljs-string">&quot;liked = liked - 1&quot;</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, id).update();<br>         <span class="hljs-comment">// 4.2.ÊääÁî®Êà∑‰ªéRedisÁöÑsetÈõÜÂêàÁßªÈô§</span><br>         <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>             stringRedisTemplate.opsForZSet().remove(key, userId.toString());<br>         &#125;<br>     &#125;<br>     <span class="hljs-keyword">return</span> Result.ok();<br> &#125;<br><br><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">isBlogLiked</span><span class="hljs-params">(Blog blog)</span> &#123;<br>     <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>     <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>     <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// Áî®Êà∑Êú™ÁôªÂΩïÔºåÊó†ÈúÄÊü•ËØ¢ÊòØÂê¶ÁÇπËµû</span><br>         <span class="hljs-keyword">return</span>;<br>     &#125;<br>     <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> user.getId();<br>     <span class="hljs-comment">// 2.Âà§Êñ≠ÂΩìÂâçÁôªÂΩïÁî®Êà∑ÊòØÂê¶Â∑≤ÁªèÁÇπËµû</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;blog:liked:&quot;</span> + blog.getId();<br>     <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForZSet().score(key, userId.toString());<br>     blog.setIsLike(score != <span class="hljs-literal">null</span>);<br> &#125;<br></code></pre></td></tr></table></figure>

<h4 id="6-3-2-ÁÇπËµûÂàóË°®Êü•ËØ¢ÂàóË°®"><a href="#6-3-2-ÁÇπËµûÂàóË°®Êü•ËØ¢ÂàóË°®" class="headerlink" title="6.3.2 ÁÇπËµûÂàóË°®Êü•ËØ¢ÂàóË°®"></a>6.3.2 ÁÇπËµûÂàóË°®Êü•ËØ¢ÂàóË°®</h4><p><strong>BlogController</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/likes/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br><br>    <span class="hljs-keyword">return</span> blogService.queryBlogLikes(id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>BlogService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogLikes</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> BLOG_LIKED_KEY + id;<br>    <span class="hljs-comment">// 1.Êü•ËØ¢top5ÁöÑÁÇπËµûÁî®Êà∑ zrange key 0 4</span><br>    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet().range(key, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    <span class="hljs-keyword">if</span> (top5 == <span class="hljs-literal">null</span> || top5.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 2.Ëß£ÊûêÂá∫ÂÖ∂‰∏≠ÁöÑÁî®Êà∑id</span><br>    List&lt;Long&gt; ids = top5.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    <span class="hljs-comment">// 3.Ê†πÊçÆÁî®Êà∑idÊü•ËØ¢Áî®Êà∑ WHERE id IN ( 5 , 1 ) ORDER BY FIELD(id, 5, 1)</span><br>    List&lt;UserDTO&gt; userDTOS = userService.query()<br>            .in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list()<br>            .stream()<br>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>            .collect(Collectors.toList());<br>    <span class="hljs-comment">// 4.ËøîÂõû</span><br>    <span class="hljs-keyword">return</span> Result.ok(userDTOS);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-Â•ΩÂèãÂÖ≥Ê≥®"><a href="#7-Â•ΩÂèãÂÖ≥Ê≥®" class="headerlink" title="7. Â•ΩÂèãÂÖ≥Ê≥®"></a>7. Â•ΩÂèãÂÖ≥Ê≥®</h2><h3 id="7-1-ÂÖ≥Ê≥®ÂíåÂèñÊ∂àÂÖ≥Ê≥®"><a href="#7-1-ÂÖ≥Ê≥®ÂíåÂèñÊ∂àÂÖ≥Ê≥®" class="headerlink" title="7.1 ÂÖ≥Ê≥®ÂíåÂèñÊ∂àÂÖ≥Ê≥®"></a>7.1 ÂÖ≥Ê≥®ÂíåÂèñÊ∂àÂÖ≥Ê≥®</h3><p>ÈúÄÊ±ÇÔºöÂü∫‰∫éËØ•Ë°®Êï∞ÊçÆÁªìÊûÑÔºåÂÆûÁé∞‰∏§‰∏™Êé•Âè£Ôºö</p>
<ul>
<li>ÂÖ≥Ê≥®ÂíåÂèñÂÖ≥Êé•Âè£</li>
<li>Âà§Êñ≠ÊòØÂê¶ÂÖ≥Ê≥®ÁöÑÊé•Âè£</li>
</ul>
<p>ÂÖ≥Ê≥®ÊòØUser‰πãÈó¥ÁöÑÂÖ≥Á≥ªÔºåÊòØÂçö‰∏ª‰∏éÁ≤â‰∏ùÁöÑÂÖ≥Á≥ªÔºåÊï∞ÊçÆÂ∫ì‰∏≠Êúâ‰∏ÄÂº†tb_followË°®Êù•Ê†áÁ§∫</p>
<h4 id="7-1-1-FollowController"><a href="#7-1-1-FollowController" class="headerlink" title="7.1.1 FollowController"></a>7.1.1 FollowController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ÂÖ≥Ê≥®</span><br><span class="hljs-meta">@PutMapping(&quot;/&#123;id&#125;/&#123;isFollow&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId, <span class="hljs-meta">@PathVariable(&quot;isFollow&quot;)</span> Boolean isFollow)</span> &#123;<br>    <span class="hljs-keyword">return</span> followService.follow(followUserId, isFollow);<br>&#125;<br><span class="hljs-comment">//ÂèñÊ∂àÂÖ≥Ê≥®</span><br><span class="hljs-meta">@GetMapping(&quot;/or/not/&#123;id&#125;&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long followUserId)</span> &#123;<br>      <span class="hljs-keyword">return</span> followService.isFollow(followUserId);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-1-2-FollowService"><a href="#7-1-2-FollowService" class="headerlink" title="7.1.2 FollowService"></a>7.1.2 FollowService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ÂèñÊ∂àÂÖ≥Ê≥®service</span><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">isFollow</span><span class="hljs-params">(Long followUserId)</span> &#123;<br>        <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-comment">// 2.Êü•ËØ¢ÊòØÂê¶ÂÖ≥Ê≥® select count(*) from tb_follow where user_id = ? and follow_user_id = ?</span><br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> query().eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId).count();<br>        <span class="hljs-comment">// 3.Âà§Êñ≠</span><br>        <span class="hljs-keyword">return</span> Result.ok(count &gt; <span class="hljs-number">0</span>);<br>    &#125;<br><br> <span class="hljs-comment">//ÂÖ≥Ê≥®service</span><br> <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, Boolean isFollow)</span> &#123;<br>        <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>        <span class="hljs-comment">// 1.Âà§Êñ≠Âà∞Â∫ïÊòØÂÖ≥Ê≥®ËøòÊòØÂèñÂÖ≥</span><br>        <span class="hljs-keyword">if</span> (isFollow) &#123;<br>            <span class="hljs-comment">// 2.ÂÖ≥Ê≥®ÔºåÊñ∞Â¢ûÊï∞ÊçÆ</span><br>            <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>            follow.setUserId(userId);<br>            follow.setFollowUserId(followUserId);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 3.ÂèñÂÖ≥ÔºåÂà†Èô§ delete from tb_follow where user_id = ? and follow_user_id = ?</span><br>            remove(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Follow&gt;()<br>                    .eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId));<br><br>        &#125;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-2-ÂÖ±ÂêåÂÖ≥Ê≥®"><a href="#7-2-ÂÖ±ÂêåÂÖ≥Ê≥®" class="headerlink" title="7.2 ÂÖ±ÂêåÂÖ≥Ê≥®"></a>7.2 ÂÖ±ÂêåÂÖ≥Ê≥®</h3><p>ÊÉ≥Ë¶ÅÂéªÁúãÂÖ±ÂêåÂÖ≥Ê≥®ÁöÑÂ•ΩÂèãÔºåÈúÄË¶ÅÈ¶ñÂÖàËøõÂÖ•Âà∞Ëøô‰∏™È°µÈù¢ÔºåËøô‰∏™È°µÈù¢‰ºöÂèëËµ∑‰∏§‰∏™ËØ∑Ê±Ç</p>
<ol>
<li>ÂéªÊü•ËØ¢Áî®Êà∑ÁöÑËØ¶ÊÉÖ</li>
<li>ÂéªÊü•ËØ¢Áî®Êà∑ÁöÑÁ¨îËÆ∞</li>
</ol>
<p>ÈúÄÊ±ÇÔºöÂà©Áî®Redis‰∏≠ÊÅ∞ÂΩìÁöÑÊï∞ÊçÆÁªìÊûÑÔºåÂÆûÁé∞ÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ„ÄÇÂú®Âçö‰∏ª‰∏™‰∫∫È°µÈù¢Â±ïÁ§∫Âá∫ÂΩìÂâçÁî®Êà∑‰∏éÂçö‰∏ªÁöÑÂÖ±ÂêåÂÖ≥Ê≥®Âë¢„ÄÇ</p>
<ul>
<li>ÂΩìÁÑ∂ÊòØ‰ΩøÁî®Êàë‰ª¨‰πãÂâçÂ≠¶‰π†ËøáÁöÑsetÈõÜÂêàÂíØÔºå<strong>Âú®setÈõÜÂêà‰∏≠ÔºåÊúâ‰∫§ÈõÜÂπ∂ÈõÜË°•ÈõÜÁöÑapi</strong>ÔºåÊàë‰ª¨ÂèØ‰ª•Êää‰∏§‰∫∫ÁöÑÂÖ≥Ê≥®ÁöÑ‰∫∫ÂàÜÂà´ÊîæÂÖ•Âà∞‰∏Ä‰∏™setÈõÜÂêà‰∏≠ÔºåÁÑ∂ÂêéÂÜçÈÄöËøáapiÂéªÊü•ÁúãËøô‰∏§‰∏™setÈõÜÂêà‰∏≠ÁöÑ‰∫§ÈõÜÊï∞ÊçÆ„ÄÇ</li>
</ul>
<p><strong>FollowServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">follow</span><span class="hljs-params">(Long followUserId, Boolean isFollow)</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>    <span class="hljs-comment">// 1.Âà§Êñ≠Âà∞Â∫ïÊòØÂÖ≥Ê≥®ËøòÊòØÂèñÂÖ≥</span><br>    <span class="hljs-keyword">if</span> (isFollow) &#123;<br>        <span class="hljs-comment">// 2.ÂÖ≥Ê≥®ÔºåÊñ∞Â¢ûÊï∞ÊçÆ</span><br>        <span class="hljs-type">Follow</span> <span class="hljs-variable">follow</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Follow</span>();<br>        follow.setUserId(userId);<br>        follow.setFollowUserId(followUserId);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(follow);<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// ÊääÂÖ≥Ê≥®Áî®Êà∑ÁöÑidÔºåÊîæÂÖ•redisÁöÑsetÈõÜÂêà sadd userId followerUserId</span><br>            stringRedisTemplate.opsForSet().add(key, followUserId.toString());<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 3.ÂèñÂÖ≥ÔºåÂà†Èô§ delete from tb_follow where user_id = ? and follow_user_id = ?</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> remove(<span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;Follow&gt;()<br>                .eq(<span class="hljs-string">&quot;user_id&quot;</span>, userId).eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, followUserId));<br>        <span class="hljs-keyword">if</span> (isSuccess) &#123;<br>            <span class="hljs-comment">// ÊääÂÖ≥Ê≥®Áî®Êà∑ÁöÑid‰ªéRedisÈõÜÂêà‰∏≠ÁßªÈô§</span><br>            stringRedisTemplate.opsForSet().remove(key, followUserId.toString());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>FollowServiceImpl</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">followCommons</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÂΩìÂâçÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + userId;<br>    <span class="hljs-comment">// 2.Ê±Ç‰∫§ÈõÜ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follows:&quot;</span> + id;<br>    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key, key2);<br>    <span class="hljs-keyword">if</span> (intersect == <span class="hljs-literal">null</span> || intersect.isEmpty()) &#123;<br>        <span class="hljs-comment">// Êó†‰∫§ÈõÜ</span><br>        <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>    &#125;<br>    <span class="hljs-comment">// 3.Ëß£ÊûêidÈõÜÂêà</span><br>    List&lt;Long&gt; ids = intersect.stream().map(Long::valueOf).collect(Collectors.toList());<br>    <span class="hljs-comment">// 4.Êü•ËØ¢Áî®Êà∑</span><br>    List&lt;UserDTO&gt; users = userService.listByIds(ids)<br>            .stream()<br>            .map(user -&gt; BeanUtil.copyProperties(user, UserDTO.class))<br>            .collect(Collectors.toList());<br>    <span class="hljs-keyword">return</span> Result.ok(users);<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="7-3-ÂÖ±ÂêåÊé®ÈÄÅ-FeedÊµÅÂÆûÁé∞ÊñπÊ°à"><a href="#7-3-ÂÖ±ÂêåÊé®ÈÄÅ-FeedÊµÅÂÆûÁé∞ÊñπÊ°à" class="headerlink" title="7.3 ÂÖ±ÂêåÊé®ÈÄÅ-FeedÊµÅÂÆûÁé∞ÊñπÊ°à"></a>7.3 ÂÖ±ÂêåÊé®ÈÄÅ-FeedÊµÅÂÆûÁé∞ÊñπÊ°à</h3><p>ÂÖ≥Ê≥®Êé®ÈÄÅ‰πüÂè´ÂÅöFeedÊµÅÔºåÁõ¥ËØë‰∏∫ÊäïÂñÇ„ÄÇ‰∏∫Áî®Êà∑ÊåÅÁª≠ÁöÑÊèê‰æõ‚ÄúÊ≤âÊµ∏Âºè‚ÄùÁöÑ‰ΩìÈ™åÔºåÈÄöËøáÊó†Èôê‰∏ãÊãâÂà∑Êñ∞Ëé∑ÂèñÊñ∞ÁöÑ‰ø°ÊÅØ</p>
<p><img src="/img/blogs/java/redis/2.7.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="7-3-1-FeedÊµÅ‰∫ßÂìÅÊúâ‰∏§ÁßçÂ∏∏ËßÅÊ®°Âºè"><a href="#7-3-1-FeedÊµÅ‰∫ßÂìÅÊúâ‰∏§ÁßçÂ∏∏ËßÅÊ®°Âºè" class="headerlink" title="7.3.1 FeedÊµÅ‰∫ßÂìÅÊúâ‰∏§ÁßçÂ∏∏ËßÅÊ®°Âºè"></a>7.3.1 FeedÊµÅ‰∫ßÂìÅÊúâ‰∏§ÁßçÂ∏∏ËßÅÊ®°Âºè</h4><p><strong>Timeline</strong>Ôºö‰∏çÂÅöÂÜÖÂÆπÁ≠õÈÄâÔºåÁÆÄÂçïÁöÑÊåâÁÖßÂÜÖÂÆπÂèëÂ∏ÉÊó∂Èó¥ÊéíÂ∫èÔºåÂ∏∏Áî®‰∫éÂ•ΩÂèãÊàñÂÖ≥Ê≥®„ÄÇ‰æãÂ¶ÇÊúãÂèãÂúà</p>
<ul>
<li>‰ºòÁÇπÔºö‰ø°ÊÅØÂÖ®Èù¢Ôºå‰∏ç‰ºöÊúâÁº∫Â§±„ÄÇÂπ∂‰∏îÂÆûÁé∞‰πüÁõ∏ÂØπÁÆÄÂçï</li>
<li>Áº∫ÁÇπÔºö‰ø°ÊÅØÂô™Èü≥ËæÉÂ§öÔºåÁî®Êà∑‰∏ç‰∏ÄÂÆöÊÑüÂÖ¥Ë∂£ÔºåÂÜÖÂÆπËé∑ÂèñÊïàÁéá‰Ωé</li>
</ul>
<p><strong>Êô∫ËÉΩÊéíÂ∫è</strong>ÔºöÂà©Áî®Êô∫ËÉΩÁÆóÊ≥ïÂ±èËîΩÊéâËøùËßÑÁöÑ„ÄÅÁî®Êà∑‰∏çÊÑüÂÖ¥Ë∂£ÁöÑÂÜÖÂÆπ„ÄÇÊé®ÈÄÅÁî®Êà∑ÊÑüÂÖ¥Ë∂£‰ø°ÊÅØÊù•Âê∏ÂºïÁî®Êà∑</p>
<ul>
<li>‰ºòÁÇπÔºöÊäïÂñÇÁî®Êà∑ÊÑüÂÖ¥Ë∂£‰ø°ÊÅØÔºåÁî®Êà∑Á≤òÂ∫¶ÂæàÈ´òÔºåÂÆπÊòìÊ≤âËø∑</li>
<li>Áº∫ÁÇπÔºöÂ¶ÇÊûúÁÆóÊ≥ï‰∏çÁ≤æÂáÜÔºåÂèØËÉΩËµ∑Âà∞Âèç‰ΩúÁî®<br>Êú¨‰æã‰∏≠ÁöÑ‰∏™‰∫∫È°µÈù¢ÔºåÊòØÂü∫‰∫éÂÖ≥Ê≥®ÁöÑÂ•ΩÂèãÊù•ÂÅöFeedÊµÅÔºåÂõ†Ê≠§ÈááÁî®TimelineÁöÑÊ®°Âºè„ÄÇËØ•Ê®°ÂºèÁöÑÂÆûÁé∞ÊñπÊ°àÊúâ‰∏âÁßçÔºö</li>
</ul>
<p>Êàë‰ª¨Êú¨Ê¨°ÈíàÂØπÂ•ΩÂèãÁöÑÊìç‰ΩúÔºåÈááÁî®ÁöÑÂ∞±ÊòØTimelineÁöÑÊñπÂºèÔºåÂè™ÈúÄË¶ÅÊãøÂà∞Êàë‰ª¨ÂÖ≥Ê≥®Áî®Êà∑ÁöÑ‰ø°ÊÅØÔºåÁÑ∂ÂêéÊåâÁÖßÊó∂Èó¥ÊéíÂ∫èÂç≥ÂèØ</p>
<h4 id="7-3-2-TimelineÁöÑ‰∏âÁßçÊ®°Âºè"><a href="#7-3-2-TimelineÁöÑ‰∏âÁßçÊ®°Âºè" class="headerlink" title="7.3.2 TimelineÁöÑ‰∏âÁßçÊ®°Âºè"></a>7.3.2 TimelineÁöÑ‰∏âÁßçÊ®°Âºè</h4><ul>
<li>ÊãâÊ®°Âºè</li>
<li>Êé®Ê®°Âºè</li>
<li>Êé®ÊãâÁªìÂêà</li>
</ul>
<p><strong>ÊãâÊ®°Âºè</strong>Ôºö‰πüÂè´ÂÅöËØªÊâ©Êï£</p>
<p><img src="/img/blogs/java/redis/2.7.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Êé®Ê®°Âºè</strong>Ôºö‰πüÂè´ÂÅöÂÜôÊâ©Êï£„ÄÇ</p>
<p><img src="/img/blogs/java/redis/2.7.3.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Êé®ÊãâÁªìÂêàÊ®°Âºè</strong>Ôºö‰πüÂè´ÂÅöËØªÂÜôÊ∑∑ÂêàÔºåÂÖºÂÖ∑Êé®ÂíåÊãâ‰∏§ÁßçÊ®°ÂºèÁöÑ‰ºòÁÇπ</p>
<p><img src="/img/blogs/java/redis/2.7.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>‰∏âÁßçÊ®°ÂºèÂØπÊØî</strong>Ôºö</p>
<table>
<thead>
<tr>
<th></th>
<th>ÊãâÊ®°Âºè</th>
<th>Êé®Ê®°Âºè</th>
<th>Êé®ÊãâÁªìÂêà</th>
</tr>
</thead>
<tbody><tr>
<td>ÂÜôÊØî‰æã</td>
<td>‰Ωé</td>
<td>È´ò</td>
<td>‰∏≠</td>
</tr>
<tr>
<td>ËØªÊØî‰æã</td>
<td>È´ò</td>
<td>‰Ωé</td>
<td>‰∏≠</td>
</tr>
<tr>
<td>Áî®Êà∑ËØªÂèñÂª∂Ëøü</td>
<td>È´ò</td>
<td>‰Ωé</td>
<td>‰Ωé</td>
</tr>
<tr>
<td>ÂÆûÁé∞ÈöæÂ∫¶</td>
<td>Â§çÊùÇ</td>
<td>ÁÆÄÂçï</td>
<td>ÂæàÂ§çÊùÇ</td>
</tr>
<tr>
<td>‰ΩøÁî®Âú∫ÊôØ</td>
<td>ÂæàÂ∞ë‰ΩøÁî®</td>
<td>Áî®Êà∑ÈáèÂ∞ë„ÄÅÊ≤°ÊúâÂ§ßV</td>
<td>ËøáÂçÉ‰∏áÁöÑÁî®Êà∑ÈáèÔºåÊúâÂ§ßV</td>
</tr>
</tbody></table>
<h3 id="7-4-Êé®ÈÄÅÂà∞Á≤â‰∏ùÊî∂‰ª∂ÁÆ±"><a href="#7-4-Êé®ÈÄÅÂà∞Á≤â‰∏ùÊî∂‰ª∂ÁÆ±" class="headerlink" title="7.4 Êé®ÈÄÅÂà∞Á≤â‰∏ùÊî∂‰ª∂ÁÆ±"></a>7.4 Êé®ÈÄÅÂà∞Á≤â‰∏ùÊî∂‰ª∂ÁÆ±</h3><p>ÈúÄÊ±ÇÔºö</p>
<ul>
<li>‰øÆÊîπÊñ∞Â¢ûÊé¢Â∫óÁ¨îËÆ∞ÁöÑ‰∏öÂä°ÔºåÂú®‰øùÂ≠òblogÂà∞Êï∞ÊçÆÂ∫ìÁöÑÂêåÊó∂ÔºåÊé®ÈÄÅÂà∞Á≤â‰∏ùÁöÑÊî∂‰ª∂ÁÆ±</li>
<li>Êî∂‰ª∂ÁÆ±Êª°Ë∂≥ÂèØ‰ª•Ê†πÊçÆÊó∂Èó¥Êà≥ÊéíÂ∫èÔºåÂøÖÈ°ªÁî®RedisÁöÑÊï∞ÊçÆÁªìÊûÑÂÆûÁé∞</li>
<li>Êü•ËØ¢Êî∂‰ª∂ÁÆ±Êï∞ÊçÆÊó∂ÔºåÂèØ‰ª•ÂÆûÁé∞ÂàÜÈ°µÊü•ËØ¢</li>
</ul>
<p><strong>FeedÊµÅÁöÑÊªöÂä®ÂàÜÈ°µ</strong></p>
<ul>
<li>FeedÊµÅ‰∏≠ÁöÑÊï∞ÊçÆ‰ºö‰∏çÊñ≠Êõ¥Êñ∞ÔºåÊâÄ‰ª•Êï∞ÊçÆÁöÑËßíÊ†á‰πüÂú®ÂèòÂåñÔºåÂõ†Ê≠§‰∏çËÉΩÈááÁî®‰º†ÁªüÁöÑÂàÜÈ°µÊ®°Âºè„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/2.7.5.png" srcset="/img/loading.gif" lazyload></p>
<p>Êàë‰ª¨Âú®‰øùÂ≠òÂÆåÊé¢Â∫óÁ¨îËÆ∞ÂêéÔºåËé∑ÂæóÂà∞ÂΩìÂâçÁ¨îËÆ∞ÁöÑÁ≤â‰∏ùÔºåÁÑ∂ÂêéÊääÊï∞ÊçÆÊé®ÈÄÅÂà∞Á≤â‰∏ùÁöÑredis‰∏≠Âéª„ÄÇ<br>‰ª£Á†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">saveBlog</span><span class="hljs-params">(Blog blog)</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÁôªÂΩïÁî®Êà∑</span><br>    <span class="hljs-type">UserDTO</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> UserHolder.getUser();<br>    blog.setUserId(user.getId());<br>    <span class="hljs-comment">// 2.‰øùÂ≠òÊé¢Â∫óÁ¨îËÆ∞</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuccess</span> <span class="hljs-operator">=</span> save(blog);<br>    <span class="hljs-keyword">if</span>(!isSuccess)&#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Êñ∞Â¢ûÁ¨îËÆ∞Â§±Ë¥•!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.Êü•ËØ¢Á¨îËÆ∞‰ΩúËÄÖÁöÑÊâÄÊúâÁ≤â‰∏ù select * from tb_follow where follow_user_id = ?</span><br>    List&lt;Follow&gt; follows = followService.query().eq(<span class="hljs-string">&quot;follow_user_id&quot;</span>, user.getId()).list();<br>    <span class="hljs-comment">// 4.Êé®ÈÄÅÁ¨îËÆ∞idÁªôÊâÄÊúâÁ≤â‰∏ù</span><br>    <span class="hljs-keyword">for</span> (Follow follow : follows) &#123;<br>        <span class="hljs-comment">// 4.1.Ëé∑ÂèñÁ≤â‰∏ùid</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> follow.getUserId();<br>        <span class="hljs-comment">// 4.2.Êé®ÈÄÅ</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> FEED_KEY + userId;<br>        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());<br>    &#125;<br>    <span class="hljs-comment">// 5.ËøîÂõûid</span><br>    <span class="hljs-keyword">return</span> Result.ok(blog.getId());<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="7-5-ÂÆûÁé∞ÂÖ≥Ê≥®Êé®ÈÄÅÈ°µÈù¢ÁöÑÂàÜÈ°µÊü•ËØ¢"><a href="#7-5-ÂÆûÁé∞ÂÖ≥Ê≥®Êé®ÈÄÅÈ°µÈù¢ÁöÑÂàÜÈ°µÊü•ËØ¢" class="headerlink" title="7.5 ÂÆûÁé∞ÂÖ≥Ê≥®Êé®ÈÄÅÈ°µÈù¢ÁöÑÂàÜÈ°µÊü•ËØ¢"></a>7.5 ÂÆûÁé∞ÂÖ≥Ê≥®Êé®ÈÄÅÈ°µÈù¢ÁöÑÂàÜÈ°µÊü•ËØ¢</h3><p>ÈúÄÊ±ÇÔºöÂú®‰∏™‰∫∫‰∏ªÈ°µÁöÑ‚ÄúÂÖ≥Ê≥®‚ÄùÂç°Áâá‰∏≠ÔºåÊü•ËØ¢Âπ∂Â±ïÁ§∫Êé®ÈÄÅÁöÑBlog‰ø°ÊÅØÔºö</p>
<ol>
<li>ÊØèÊ¨°Êü•ËØ¢ÂÆåÊàêÂêéÔºåÊàë‰ª¨Ë¶ÅÂàÜÊûêÂá∫Êü•ËØ¢Âá∫Êï∞ÊçÆÁöÑÊúÄÂ∞èÊó∂Èó¥Êà≥ÔºåËøô‰∏™ÂÄº‰ºö‰Ωú‰∏∫‰∏ã‰∏ÄÊ¨°Êü•ËØ¢ÁöÑÊù°‰ª∂</li>
<li>Êàë‰ª¨ÈúÄË¶ÅÊâæÂà∞‰∏é‰∏ä‰∏ÄÊ¨°Êü•ËØ¢Áõ∏ÂêåÁöÑÊü•ËØ¢‰∏™Êï∞‰Ωú‰∏∫ÂÅèÁßªÈáèÔºå‰∏ãÊ¨°Êü•ËØ¢Êó∂ÔºåË∑≥ËøáËøô‰∫õÊü•ËØ¢ËøáÁöÑÊï∞ÊçÆÔºåÊãøÂà∞Êàë‰ª¨ÈúÄË¶ÅÁöÑÊï∞ÊçÆ</li>
</ol>
<ul>
<li>Áªº‰∏äÔºöÊàë‰ª¨ÁöÑËØ∑Ê±ÇÂèÇÊï∞‰∏≠Â∞±ÈúÄË¶ÅÊê∫Â∏¶ lastIdÔºö<strong>‰∏ä‰∏ÄÊ¨°Êü•ËØ¢ÁöÑÊúÄÂ∞èÊó∂Èó¥Êà≥</strong> Âíå<strong>ÂÅèÁßªÈáè</strong>Ëøô‰∏§‰∏™ÂèÇÊï∞</li>
</ul>
<h4 id="7-5-1-ÂÆö‰πâÂá∫Êù•ÂÖ∑‰ΩìÁöÑËøîÂõûÂÄºÂÆû‰ΩìÁ±ª"><a href="#7-5-1-ÂÆö‰πâÂá∫Êù•ÂÖ∑‰ΩìÁöÑËøîÂõûÂÄºÂÆû‰ΩìÁ±ª" class="headerlink" title="7.5.1 ÂÆö‰πâÂá∫Êù•ÂÖ∑‰ΩìÁöÑËøîÂõûÂÄºÂÆû‰ΩìÁ±ª"></a>7.5.1 ÂÆö‰πâÂá∫Êù•ÂÖ∑‰ΩìÁöÑËøîÂõûÂÄºÂÆû‰ΩìÁ±ª</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Data</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScrollResult</span> &#123;<br>    <span class="hljs-keyword">private</span> List&lt;?&gt; list;<br>    <span class="hljs-keyword">private</span> Long minTime;<br>    <span class="hljs-keyword">private</span> Integer offset;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-5-2-BlogController"><a href="#7-5-2-BlogController" class="headerlink" title="7.5.2 BlogController"></a>7.5.2 BlogController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/follow&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(</span><br><span class="hljs-params">    <span class="hljs-meta">@RequestParam(&quot;lastId&quot;)</span> Long max, <span class="hljs-meta">@RequestParam(value = &quot;offset&quot;, defaultValue = &quot;0&quot;)</span> Integer offset)</span>&#123;<br>    <span class="hljs-keyword">return</span> blogService.queryBlogOfFollow(max, offset);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="7-5-3-BlogServiceImpl"><a href="#7-5-3-BlogServiceImpl" class="headerlink" title="7.5.3 BlogServiceImpl"></a>7.5.3 BlogServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryBlogOfFollow</span><span class="hljs-params">(Long max, Integer offset)</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÂΩìÂâçÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.Êü•ËØ¢Êî∂‰ª∂ÁÆ± ZREVRANGEBYSCORE key Max Min LIMIT offset count</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> FEED_KEY + userId;<br>    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate.opsForZSet()<br>        .reverseRangeByScoreWithScores(key, <span class="hljs-number">0</span>, max, offset, <span class="hljs-number">2</span>);<br>    <span class="hljs-comment">// 3.ÈùûÁ©∫Âà§Êñ≠</span><br>    <span class="hljs-keyword">if</span> (typedTuples == <span class="hljs-literal">null</span> || typedTuples.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok();<br>    &#125;<br>    <span class="hljs-comment">// 4.Ëß£ÊûêÊï∞ÊçÆÔºöblogId„ÄÅminTimeÔºàÊó∂Èó¥Êà≥Ôºâ„ÄÅoffset</span><br>    List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(typedTuples.size());<br>    <span class="hljs-type">long</span> <span class="hljs-variable">minTime</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// 2</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; <span class="hljs-comment">// 2</span><br>    <span class="hljs-keyword">for</span> (ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples) &#123; <span class="hljs-comment">// 5 4 4 2 2</span><br>        <span class="hljs-comment">// 4.1.Ëé∑Âèñid</span><br>        ids.add(Long.valueOf(tuple.getValue()));<br>        <span class="hljs-comment">// 4.2.Ëé∑ÂèñÂàÜÊï∞(Êó∂Èó¥Êà≥Ôºâ</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">time</span> <span class="hljs-operator">=</span> tuple.getScore().longValue();<br>        <span class="hljs-keyword">if</span>(time == minTime)&#123;<br>            os++;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            minTime = time;<br>            os = <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>	os = minTime == max ? os : os + offset;<br>    <span class="hljs-comment">// 5.Ê†πÊçÆidÊü•ËØ¢blog</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>    List&lt;Blog&gt; blogs = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br><br>    <span class="hljs-keyword">for</span> (Blog blog : blogs) &#123;<br>        <span class="hljs-comment">// 5.1.Êü•ËØ¢blogÊúâÂÖ≥ÁöÑÁî®Êà∑</span><br>        queryBlogUser(blog);<br>        <span class="hljs-comment">// 5.2.Êü•ËØ¢blogÊòØÂê¶Ë¢´ÁÇπËµû</span><br>        isBlogLiked(blog);<br>    &#125;<br><br>    <span class="hljs-comment">// 6.Â∞ÅË£ÖÂπ∂ËøîÂõû</span><br>    <span class="hljs-type">ScrollResult</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ScrollResult</span>();<br>    r.setList(blogs);<br>    r.setOffset(os);<br>    r.setMinTime(minTime);<br><br>    <span class="hljs-keyword">return</span> Result.ok(r);<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="8-ÈôÑËøëÂïÜÊà∑"><a href="#8-ÈôÑËøëÂïÜÊà∑" class="headerlink" title="8. ÈôÑËøëÂïÜÊà∑"></a>8. ÈôÑËøëÂïÜÊà∑</h2><h3 id="8-1-GEOÊï∞ÊçÆÁªìÊûÑ"><a href="#8-1-GEOÊï∞ÊçÆÁªìÊûÑ" class="headerlink" title="8.1 GEOÊï∞ÊçÆÁªìÊûÑ"></a>8.1 GEOÊï∞ÊçÆÁªìÊûÑ</h3><p>GEOÂ∞±ÊòØGeolocationÁöÑÁÆÄÂÜôÂΩ¢ÂºèÔºå‰ª£Ë°®Âú∞ÁêÜÂùêÊ†á„ÄÇRedisÂú®3.2ÁâàÊú¨‰∏≠Âä†ÂÖ•‰∫ÜÂØπGEOÁöÑÊîØÊåÅÔºåÂÖÅËÆ∏Â≠òÂÇ®Âú∞ÁêÜÂùêÊ†á‰ø°ÊÅØÔºåÂ∏ÆÂä©Êàë‰ª¨Ê†πÊçÆÁªèÁ∫¨Â∫¶Êù•Ê£ÄÁ¥¢Êï∞ÊçÆ„ÄÇÂ∏∏ËßÅÁöÑÂëΩ‰ª§ÊúâÔºö</p>
<ul>
<li>GEOADDÔºöÊ∑ªÂä†‰∏Ä‰∏™Âú∞ÁêÜÁ©∫Èó¥‰ø°ÊÅØÔºåÂåÖÂê´ÔºöÁªèÂ∫¶ÔºàlongitudeÔºâ„ÄÅÁ∫¨Â∫¶ÔºàlatitudeÔºâ„ÄÅÂÄºÔºàmemberÔºâ</li>
<li>GEODISTÔºöËÆ°ÁÆóÊåáÂÆöÁöÑ‰∏§‰∏™ÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ªÂπ∂ËøîÂõû</li>
<li>GEOHASHÔºöÂ∞ÜÊåáÂÆömemberÁöÑÂùêÊ†áËΩ¨‰∏∫hashÂ≠óÁ¨¶‰∏≤ÂΩ¢ÂºèÂπ∂ËøîÂõû</li>
<li>GEOPOSÔºöËøîÂõûÊåáÂÆömemberÁöÑÂùêÊ†á</li>
<li>GEORADIUSÔºöÊåáÂÆöÂúÜÂøÉ„ÄÅÂçäÂæÑÔºåÊâæÂà∞ËØ•ÂúÜÂÜÖÂåÖÂê´ÁöÑÊâÄÊúâmemberÔºåÂπ∂ÊåâÁÖß‰∏éÂúÜÂøÉ‰πãÈó¥ÁöÑË∑ùÁ¶ªÊéíÂ∫èÂêéËøîÂõû„ÄÇ6.‰ª•ÂêéÂ∑≤Â∫üÂºÉ</li>
<li>GEOSEARCHÔºöÂú®ÊåáÂÆöËåÉÂõ¥ÂÜÖÊêúÁ¥¢memberÔºåÂπ∂ÊåâÁÖß‰∏éÊåáÂÆöÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ªÊéíÂ∫èÂêéËøîÂõû„ÄÇËåÉÂõ¥ÂèØ‰ª•ÊòØÂúÜÂΩ¢ÊàñÁü©ÂΩ¢„ÄÇ6.2.Êñ∞ÂäüËÉΩ</li>
<li>GEOSEARCHSTOREÔºö‰∏éGEOSEARCHÂäüËÉΩ‰∏ÄËá¥Ôºå‰∏çËøáÂèØ‰ª•ÊääÁªìÊûúÂ≠òÂÇ®Âà∞‰∏Ä‰∏™ÊåáÂÆöÁöÑkey„ÄÇ 6.2.Êñ∞ÂäüËÉΩ</li>
</ul>
<h3 id="8-2-ÈôÑËøëÂïÜÊà∑ÊêúÁ¥¢"><a href="#8-2-ÈôÑËøëÂïÜÊà∑ÊêúÁ¥¢" class="headerlink" title="8.2 ÈôÑËøëÂïÜÊà∑ÊêúÁ¥¢"></a>8.2 ÈôÑËøëÂïÜÊà∑ÊêúÁ¥¢</h3><h4 id="8-2-1-ÂØºÂÖ•Â∫óÈì∫Êï∞ÊçÆÂà∞GEO"><a href="#8-2-1-ÂØºÂÖ•Â∫óÈì∫Êï∞ÊçÆÂà∞GEO" class="headerlink" title="8.2.1 ÂØºÂÖ•Â∫óÈì∫Êï∞ÊçÆÂà∞GEO"></a>8.2.1 ÂØºÂÖ•Â∫óÈì∫Êï∞ÊçÆÂà∞GEO</h4><ul>
<li>Êàë‰ª¨Ë¶ÅÂÅöÁöÑ‰∫ãÊÉÖÊòØÔºöÂ∞ÜÊï∞ÊçÆÂ∫ìË°®‰∏≠ÁöÑÊï∞ÊçÆÂØºÂÖ•Âà∞redis‰∏≠ÂéªÔºåredis‰∏≠ÁöÑGEOÔºåGEOÂú®redis‰∏≠Â∞±‰∏Ä‰∏™menberÂíå‰∏Ä‰∏™ÁªèÁ∫¨Â∫¶ÔºåÊàë‰ª¨<strong>ÊääxÂíåyËΩ¥‰º†ÂÖ•Âà∞redisÂÅöÁöÑÁªèÁ∫¨Â∫¶‰ΩçÁΩÆ</strong>ÂéªÔºå‰ΩÜÊàë‰ª¨‰∏çËÉΩÊääÊâÄÊúâÁöÑÊï∞ÊçÆÈÉΩÊîæÂÖ•Âà∞menber‰∏≠ÂéªÔºåÊØïÁ´ü‰Ωú‰∏∫redisÊòØ‰∏Ä‰∏™ÂÜÖÂ≠òÁ∫ßÊï∞ÊçÆÂ∫ìÔºåÂ¶ÇÊûúÂ≠òÊµ∑ÈáèÊï∞ÊçÆÔºåredisËøòÊòØÂäõ‰∏ç‰ªéÂøÉÔºåÊâÄ‰ª•Êàë‰ª¨Âú®Ëøô‰∏™Âú∞Êñπ<strong>Â≠òÂÇ®‰ªñÁöÑid</strong>Âç≥ÂèØ„ÄÇ</li>
<li>‰ΩÜÊòØËøô‰∏™Êó∂ÂÄôËøòÊúâ‰∏Ä‰∏™ÈóÆÈ¢òÔºåÂ∞±ÊòØÂú®redis‰∏≠Âπ∂Ê≤°ÊúâÂ≠òÂÇ®typeÔºåÊâÄ‰ª•Êàë‰ª¨Êó†Ê≥ïÊ†πÊçÆtypeÊù•ÂØπÊï∞ÊçÆËøõË°åÁ≠õÈÄâÔºåÊâÄ‰ª•<strong>Êàë‰ª¨ÂèØ‰ª•ÊåâÁÖßÂïÜÊà∑Á±ªÂûãÂÅöÂàÜÁªÑÔºåÁ±ªÂûãÁõ∏ÂêåÁöÑÂïÜÊà∑‰Ωú‰∏∫Âêå‰∏ÄÁªÑ</strong>Ôºå‰ª•typeId‰∏∫keyÂ≠òÂÖ•Âêå‰∏Ä‰∏™GEOÈõÜÂêà‰∏≠Âç≥ÂèØ</li>
</ul>
<p><strong>HmDianPingApplicationTests</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">loadShopData</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.Êü•ËØ¢Â∫óÈì∫‰ø°ÊÅØ</span><br>    List&lt;Shop&gt; list = shopService.list();<br>    <span class="hljs-comment">// 2.ÊääÂ∫óÈì∫ÂàÜÁªÑÔºåÊåâÁÖßtypeIdÂàÜÁªÑÔºåtypeId‰∏ÄËá¥ÁöÑÊîæÂà∞‰∏Ä‰∏™ÈõÜÂêà</span><br>    Map&lt;Long, List&lt;Shop&gt;&gt; map = list.stream().collect(Collectors.groupingBy(Shop::getTypeId));<br>    <span class="hljs-comment">// 3.ÂàÜÊâπÂÆåÊàêÂÜôÂÖ•Redis</span><br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;Long, List&lt;Shop&gt;&gt; entry : map.entrySet()) &#123;<br>        <span class="hljs-comment">// 3.1.Ëé∑ÂèñÁ±ªÂûãid</span><br>        <span class="hljs-type">Long</span> <span class="hljs-variable">typeId</span> <span class="hljs-operator">=</span> entry.getKey();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> SHOP_GEO_KEY + typeId;<br>        <span class="hljs-comment">// 3.2.Ëé∑ÂèñÂêåÁ±ªÂûãÁöÑÂ∫óÈì∫ÁöÑÈõÜÂêà</span><br>        List&lt;Shop&gt; value = entry.getValue();<br>        List&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; locations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(value.size());<br>        <span class="hljs-comment">// 3.3.ÂÜôÂÖ•redis GEOADD key ÁªèÂ∫¶ Á∫¨Â∫¶ member</span><br>        <span class="hljs-keyword">for</span> (Shop shop : value) &#123;<br>            <span class="hljs-comment">// stringRedisTemplate.opsForGeo().add(key, new Point(shop.getX(), shop.getY()), shop.getId().toString());</span><br>            locations.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisGeoCommands</span>.GeoLocation&lt;&gt;(<br>                    shop.getId().toString(),<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(shop.getX(), shop.getY())<br>            ));<br>        &#125;<br>        stringRedisTemplate.opsForGeo().add(key, locations);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="8-2-2-ÂÆûÁé∞ÈôÑËøëÂïÜÊà∑ÂäüËÉΩ"><a href="#8-2-2-ÂÆûÁé∞ÈôÑËøëÂïÜÊà∑ÂäüËÉΩ" class="headerlink" title="8.2.2 ÂÆûÁé∞ÈôÑËøëÂïÜÊà∑ÂäüËÉΩ"></a>8.2.2 ÂÆûÁé∞ÈôÑËøëÂïÜÊà∑ÂäüËÉΩ</h4><p><strong>ShopController</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/of/type&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(&quot;typeId&quot;)</span> Integer typeId,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;current&quot;, defaultValue = &quot;1&quot;)</span> Integer current,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;x&quot;, required = false)</span> Double x,</span><br><span class="hljs-params">        <span class="hljs-meta">@RequestParam(value = &quot;y&quot;, required = false)</span> Double y</span><br><span class="hljs-params">)</span> &#123;<br>   <span class="hljs-keyword">return</span> shopService.queryShopByType(typeId, current, x, y);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>ShopServiceImpl</strong>Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryShopByType</span><span class="hljs-params">(Integer typeId, Integer current, Double x, Double y)</span> &#123;<br>        <span class="hljs-comment">// 1.Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊ†πÊçÆÂùêÊ†áÊü•ËØ¢</span><br>        <span class="hljs-keyword">if</span> (x == <span class="hljs-literal">null</span> || y == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// ‰∏çÈúÄË¶ÅÂùêÊ†áÊü•ËØ¢ÔºåÊåâÊï∞ÊçÆÂ∫ìÊü•ËØ¢</span><br>            Page&lt;Shop&gt; page = query()<br>                    .eq(<span class="hljs-string">&quot;type_id&quot;</span>, typeId)<br>                    .page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(current, SystemConstants.DEFAULT_PAGE_SIZE));<br>            <span class="hljs-comment">// ËøîÂõûÊï∞ÊçÆ</span><br>            <span class="hljs-keyword">return</span> Result.ok(page.getRecords());<br>        &#125;<br><br>        <span class="hljs-comment">// 2.ËÆ°ÁÆóÂàÜÈ°µÂèÇÊï∞</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">from</span> <span class="hljs-operator">=</span> (current - <span class="hljs-number">1</span>) * SystemConstants.DEFAULT_PAGE_SIZE;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> current * SystemConstants.DEFAULT_PAGE_SIZE;<br><br>        <span class="hljs-comment">// 3.Êü•ËØ¢redis„ÄÅÊåâÁÖßË∑ùÁ¶ªÊéíÂ∫è„ÄÅÂàÜÈ°µ„ÄÇÁªìÊûúÔºöshopId„ÄÅdistance</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> SHOP_GEO_KEY + typeId;<br>        GeoResults&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt; results = stringRedisTemplate.opsForGeo() <span class="hljs-comment">// GEOSEARCH key BYLONLAT x y BYRADIUS 10 WITHDISTANCE</span><br>                .search(<br>                        key,<br>                        GeoReference.fromCoordinate(x, y),<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Distance</span>(<span class="hljs-number">5000</span>),<br>                        RedisGeoCommands.GeoSearchCommandArgs.newGeoSearchArgs().includeDistance().limit(end)<br>                );<br>        <span class="hljs-comment">// 4.Ëß£ÊûêÂá∫id</span><br>        <span class="hljs-keyword">if</span> (results == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>        &#125;<br>        List&lt;GeoResult&lt;RedisGeoCommands.GeoLocation&lt;String&gt;&gt;&gt; list = results.getContent();<br>        <span class="hljs-keyword">if</span> (list.size() &lt;= from) &#123;<br>            <span class="hljs-comment">// Ê≤°Êúâ‰∏ã‰∏ÄÈ°µ‰∫ÜÔºåÁªìÊùü</span><br>            <span class="hljs-keyword">return</span> Result.ok(Collections.emptyList());<br>        &#125;<br>        <span class="hljs-comment">// 4.1.Êà™Âèñ from ~ endÁöÑÈÉ®ÂàÜ</span><br>        List&lt;Long&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(list.size());<br>        Map&lt;String, Distance&gt; distanceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;(list.size());<br>        list.stream().skip(from).forEach(result -&gt; &#123;<br>            <span class="hljs-comment">// 4.2.Ëé∑ÂèñÂ∫óÈì∫id</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">shopIdStr</span> <span class="hljs-operator">=</span> result.getContent().getName();<br>            ids.add(Long.valueOf(shopIdStr));<br>            <span class="hljs-comment">// 4.3.Ëé∑ÂèñË∑ùÁ¶ª</span><br>            <span class="hljs-type">Distance</span> <span class="hljs-variable">distance</span> <span class="hljs-operator">=</span> result.getDistance();<br>            distanceMap.put(shopIdStr, distance);<br>        &#125;);<br>        <span class="hljs-comment">// 5.Ê†πÊçÆidÊü•ËØ¢Shop</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">idStr</span> <span class="hljs-operator">=</span> StrUtil.join(<span class="hljs-string">&quot;,&quot;</span>, ids);<br>        List&lt;Shop&gt; shops = query().in(<span class="hljs-string">&quot;id&quot;</span>, ids).last(<span class="hljs-string">&quot;ORDER BY FIELD(id,&quot;</span> + idStr + <span class="hljs-string">&quot;)&quot;</span>).list();<br>        <span class="hljs-keyword">for</span> (Shop shop : shops) &#123;<br>            shop.setDistance(distanceMap.get(shop.getId().toString()).getValue());<br>        &#125;<br>        <span class="hljs-comment">// 6.ËøîÂõû</span><br>        <span class="hljs-keyword">return</span> Result.ok(shops);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="9-Áî®Êà∑Á≠æÂà∞"><a href="#9-Áî®Êà∑Á≠æÂà∞" class="headerlink" title="9. Áî®Êà∑Á≠æÂà∞"></a>9. Áî®Êà∑Á≠æÂà∞</h2><h3 id="9-1-BitMapÁî®Ê≥ï"><a href="#9-1-BitMapÁî®Ê≥ï" class="headerlink" title="9.1 BitMapÁî®Ê≥ï"></a>9.1 BitMapÁî®Ê≥ï</h3><p>Êàë‰ª¨ÊåâÊúàÊù•ÁªüËÆ°Áî®Êà∑Á≠æÂà∞‰ø°ÊÅØÔºåÁ≠æÂà∞ËÆ∞ÂΩï‰∏∫1ÔºåÊú™Á≠æÂà∞ÂàôËÆ∞ÂΩï‰∏∫0</p>
<p><img src="/img/blogs/java/redis/2.9.1.png" srcset="/img/loading.gif" lazyload></p>
<p>Êää<strong>ÊØè‰∏Ä‰∏™bit‰ΩçÂØπÂ∫îÂΩìÊúàÁöÑÊØè‰∏ÄÂ§©</strong>ÔºåÂΩ¢Êàê‰∫ÜÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇÁî®0Âíå1Ê†áÁ§∫‰∏öÂä°Áä∂ÊÄÅÔºåËøôÁßçÊÄùË∑ØÂ∞±Áß∞‰∏∫‰ΩçÂõæÔºàBitMapÔºâ„ÄÇËøôÊ†∑Êàë‰ª¨Â∞±Áî®ÊûÅÂ∞èÁöÑÁ©∫Èó¥ÔºåÊù•ÂÆûÁé∞‰∫ÜÂ§ßÈáèÊï∞ÊçÆÁöÑË°®Á§∫</p>
<p>BitMapÁöÑÊìç‰ΩúÂëΩ‰ª§ÊúâÔºö</p>
<ul>
<li>SETBITÔºöÂêëÊåáÂÆö‰ΩçÁΩÆÔºàoffsetÔºâÂ≠òÂÖ•‰∏Ä‰∏™0Êàñ1</li>
<li>GETBIT ÔºöËé∑ÂèñÊåáÂÆö‰ΩçÁΩÆÔºàoffsetÔºâÁöÑbitÂÄº</li>
<li>BITCOUNT ÔºöÁªüËÆ°BitMap‰∏≠ÂÄº‰∏∫1ÁöÑbit‰ΩçÁöÑÊï∞Èáè</li>
<li>BITFIELD ÔºöÊìç‰ΩúÔºàÊü•ËØ¢„ÄÅ‰øÆÊîπ„ÄÅËá™Â¢ûÔºâBitMap‰∏≠bitÊï∞ÁªÑ‰∏≠ÁöÑÊåáÂÆö‰ΩçÁΩÆÔºàoffsetÔºâÁöÑÂÄº</li>
<li>BITFIELD_RO ÔºöËé∑ÂèñBitMap‰∏≠bitÊï∞ÁªÑÔºåÂπ∂‰ª•ÂçÅËøõÂà∂ÂΩ¢ÂºèËøîÂõû</li>
<li>BITOP ÔºöÂ∞ÜÂ§ö‰∏™BitMapÁöÑÁªìÊûúÂÅö‰ΩçËøêÁÆóÔºà‰∏é „ÄÅÊàñ„ÄÅÂºÇÊàñÔºâ</li>
<li>BITPOS ÔºöÊü•ÊâæbitÊï∞ÁªÑ‰∏≠ÊåáÂÆöËåÉÂõ¥ÂÜÖÁ¨¨‰∏Ä‰∏™0Êàñ1Âá∫Áé∞ÁöÑ‰ΩçÁΩÆ</li>
</ul>
<h3 id="9-2-ÂÆûÁé∞Á≠æÂà∞ÂäüËÉΩ"><a href="#9-2-ÂÆûÁé∞Á≠æÂà∞ÂäüËÉΩ" class="headerlink" title="9.2 ÂÆûÁé∞Á≠æÂà∞ÂäüËÉΩ"></a>9.2 ÂÆûÁé∞Á≠æÂà∞ÂäüËÉΩ</h3><p>ÈúÄÊ±ÇÔºöÂÆûÁé∞Á≠æÂà∞Êé•Âè£ÔºåÂ∞ÜÂΩìÂâçÁî®Êà∑ÂΩìÂ§©Á≠æÂà∞‰ø°ÊÅØ‰øùÂ≠òÂà∞Redis‰∏≠</p>
<h4 id="9-2-1-UserController"><a href="#9-2-1-UserController" class="headerlink" title="9.2.1 UserController"></a>9.2.1 UserController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping(&quot;/sign&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span>&#123;<br>   <span class="hljs-keyword">return</span> userService.sign();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="9-2-2-UserServiceImpl"><a href="#9-2-2-UserServiceImpl" class="headerlink" title="9.2.2 UserServiceImpl"></a>9.2.2 UserServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">sign</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.Ëé∑ÂèñÊó•Êúü</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-comment">// 3.ÊãºÊé•key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> USER_SIGN_KEY + userId + keySuffix;<br>    <span class="hljs-comment">// 4.Ëé∑Âèñ‰ªäÂ§©ÊòØÊú¨ÊúàÁöÑÁ¨¨Âá†Â§©</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 5.ÂÜôÂÖ•Redis SETBIT key offset 1</span><br>    stringRedisTemplate.opsForValue().setBit(key, dayOfMonth - <span class="hljs-number">1</span>, <span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> Result.ok();<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="9-3-Á≠æÂà∞ÁªüËÆ°"><a href="#9-3-Á≠æÂà∞ÁªüËÆ°" class="headerlink" title="9.3 Á≠æÂà∞ÁªüËÆ°"></a>9.3 Á≠æÂà∞ÁªüËÆ°</h3><p>ÈúÄÊ±ÇÔºöÂÆûÁé∞‰∏ãÈù¢Êé•Âè£ÔºåÁªüËÆ°ÂΩìÂâçÁî®Êà∑Êà™Ê≠¢ÂΩìÂâçÊó∂Èó¥Âú®Êú¨ÊúàÁöÑËøûÁª≠Á≠æÂà∞Â§©Êï∞</p>
<ul>
<li>**ÈóÆÈ¢ò1Ôºö**‰ªÄ‰πàÂè´ÂÅöËøûÁª≠Á≠æÂà∞Â§©Êï∞Ôºü<ul>
<li>‰ªéÊúÄÂêé‰∏ÄÊ¨°Á≠æÂà∞ÂºÄÂßãÂêëÂâçÁªüËÆ°ÔºåÁõ¥Âà∞ÈÅáÂà∞Á¨¨‰∏ÄÊ¨°Êú™Á≠æÂà∞‰∏∫Ê≠¢ÔºåËÆ°ÁÆóÊÄªÁöÑÁ≠æÂà∞Ê¨°Êï∞ÔºåÂ∞±ÊòØËøûÁª≠Á≠æÂà∞Â§©Êï∞„ÄÇ</li>
</ul>
</li>
<li>**ÈóÆÈ¢ò2Ôºö**Â¶Ç‰ΩïÂæóÂà∞Êú¨ÊúàÂà∞‰ªäÂ§©‰∏∫Ê≠¢ÁöÑÊâÄÊúâÁ≠æÂà∞Êï∞ÊçÆÔºü<ul>
<li>ÂÅáËÆæ‰ªäÂ§©ÊòØ10Âè∑ÔºåÈÇ£‰πàÊàë‰ª¨Â∞±ÂèØ‰ª•‰ªéÂΩìÂâçÊúàÁöÑÁ¨¨‰∏ÄÂ§©ÂºÄÂßãÔºåËé∑ÂæóÂà∞ÂΩìÂâçËøô‰∏ÄÂ§©ÁöÑ‰ΩçÊï∞ÔºåÊòØ10Âè∑ÔºåÈÇ£‰πàÂ∞±ÊòØ10‰ΩçÔºåÂéªÊãøËøôÊÆµÊó∂Èó¥ÁöÑÊï∞ÊçÆÔºåÂ∞±ËÉΩÊãøÂà∞ÊâÄÊúâÁöÑÊï∞ÊçÆ‰∫ÜÔºåÈÇ£‰πàËøô10Â§©ÈáåËæπÁ≠æÂà∞‰∫ÜÂ§öÂ∞ëÊ¨°Âë¢ÔºüÁªüËÆ°ÊúâÂ§öÂ∞ë‰∏™1Âç≥ÂèØ„ÄÇ</li>
</ul>
</li>
<li><strong>ÈóÆÈ¢ò3ÔºöÂ¶Ç‰Ωï‰ªéÂêéÂêëÂâçÈÅçÂéÜÊØè‰∏™bit‰ΩçÔºü</strong><ul>
<li>Êàë‰ª¨Âè™ÈúÄË¶ÅËÆ©ÂæóÂà∞ÁöÑ10ËøõÂà∂Êï∞Â≠óÂíå1ÂÅö‰∏éËøêÁÆóÂ∞±ÂèØ‰ª•‰∫ÜÔºåÂõ†‰∏∫1Âè™ÊúâÈÅáËßÅ1 ÊâçÊòØ1ÔºåÂÖ∂‰ªñÊï∞Â≠óÈÉΩÊòØ0</li>
<li>Êàë‰ª¨ÊääÁ≠æÂà∞ÁªìÊûúÂíå1ËøõË°å‰∏éÊìç‰ΩúÔºåÊØè‰∏é‰∏ÄÊ¨°ÔºåÂ∞±ÊääÁ≠æÂà∞ÁªìÊûúÂêëÂè≥ÁßªÂä®‰∏Ä‰ΩçÔºå‰æùÊ¨°ÂÜÖÊé®ÔºåÊàë‰ª¨Â∞±ËÉΩÂÆåÊàêÈÄê‰∏™ÈÅçÂéÜÁöÑÊïàÊûú‰∫Ü„ÄÇ</li>
</ul>
</li>
</ul>
<h4 id="9-3-1-UserController"><a href="#9-3-1-UserController" class="headerlink" title="9.3.1 UserController"></a>9.3.1 UserController</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping(&quot;/sign/count&quot;)</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> userService.signCount();<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="9-3-2-UserServiceImpl"><a href="#9-3-2-UserServiceImpl" class="headerlink" title="9.3.2 UserServiceImpl"></a>9.3.2 UserServiceImpl</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">signCount</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁî®Êà∑</span><br>    <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> UserHolder.getUser().getId();<br>    <span class="hljs-comment">// 2.Ëé∑ÂèñÊó•Êúü</span><br>    <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();<br>    <span class="hljs-comment">// 3.ÊãºÊé•key</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">keySuffix</span> <span class="hljs-operator">=</span> now.format(DateTimeFormatter.ofPattern(<span class="hljs-string">&quot;:yyyyMM&quot;</span>));<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> USER_SIGN_KEY + userId + keySuffix;<br>    <span class="hljs-comment">// 4.Ëé∑Âèñ‰ªäÂ§©ÊòØÊú¨ÊúàÁöÑÁ¨¨Âá†Â§©</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">dayOfMonth</span> <span class="hljs-operator">=</span> now.getDayOfMonth();<br>    <span class="hljs-comment">// 5.Ëé∑ÂèñÊú¨ÊúàÊà™Ê≠¢‰ªäÂ§©‰∏∫Ê≠¢ÁöÑÊâÄÊúâÁöÑÁ≠æÂà∞ËÆ∞ÂΩïÔºåËøîÂõûÁöÑÊòØ‰∏Ä‰∏™ÂçÅËøõÂà∂ÁöÑÊï∞Â≠ó BITFIELD sign:5:202203 GET u14 0</span><br>    List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(<br>            key,<br>            BitFieldSubCommands.create()<br>                    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth)).valueAt(<span class="hljs-number">0</span>)<br>    );<br>    <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.isEmpty()) &#123;<br>        <span class="hljs-comment">// Ê≤°Êúâ‰ªª‰ΩïÁ≠æÂà∞ÁªìÊûú</span><br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-type">Long</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> result.get(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (num == <span class="hljs-literal">null</span> || num == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.ok(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-comment">// 6.Âæ™ÁéØÈÅçÂéÜ</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// 6.1.ËÆ©Ëøô‰∏™Êï∞Â≠ó‰∏é1ÂÅö‰∏éËøêÁÆóÔºåÂæóÂà∞Êï∞Â≠óÁöÑÊúÄÂêé‰∏Ä‰∏™bit‰Ωç  // Âà§Êñ≠Ëøô‰∏™bit‰ΩçÊòØÂê¶‰∏∫0</span><br>        <span class="hljs-keyword">if</span> ((num &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// Â¶ÇÊûú‰∏∫0ÔºåËØ¥ÊòéÊú™Á≠æÂà∞ÔºåÁªìÊùü</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Â¶ÇÊûú‰∏ç‰∏∫0ÔºåËØ¥ÊòéÂ∑≤Á≠æÂà∞ÔºåËÆ°Êï∞Âô®+1</span><br>            count++;<br>        &#125;<br>        <span class="hljs-comment">// ÊääÊï∞Â≠óÂè≥Áßª‰∏Ä‰ΩçÔºåÊäõÂºÉÊúÄÂêé‰∏Ä‰∏™bit‰ΩçÔºåÁªßÁª≠‰∏ã‰∏Ä‰∏™bit‰Ωç</span><br>        num &gt;&gt;&gt;= <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> Result.ok(count);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="10-UVÁªüËÆ°-HyperLogLog"><a href="#10-UVÁªüËÆ°-HyperLogLog" class="headerlink" title="10. UVÁªüËÆ°-HyperLogLog"></a>10. UVÁªüËÆ°-HyperLogLog</h2><p>È¶ñÂÖàÊàë‰ª¨ÊêûÊáÇ‰∏§‰∏™Ê¶ÇÂøµÔºö</p>
<ul>
<li>UVÔºöÂÖ®Áß∞Unique VisitorÔºå‰πüÂè´Áã¨Á´ãËÆøÂÆ¢ÈáèÔºåÊòØÊåáÈÄöËøá‰∫íËÅîÁΩëËÆøÈóÆ„ÄÅÊµèËßàËøô‰∏™ÁΩëÈ°µÁöÑËá™ÁÑ∂‰∫∫„ÄÇ1Â§©ÂÜÖÂêå‰∏Ä‰∏™Áî®Êà∑Â§öÊ¨°ËÆøÈóÆËØ•ÁΩëÁ´ôÔºåÂè™ËÆ∞ÂΩï1Ê¨°„ÄÇ</li>
<li>PVÔºöÂÖ®Áß∞Page ViewÔºå‰πüÂè´È°µÈù¢ËÆøÈóÆÈáèÊàñÁÇπÂáªÈáèÔºåÁî®Êà∑ÊØèËÆøÈóÆÁΩëÁ´ôÁöÑ‰∏Ä‰∏™È°µÈù¢ÔºåËÆ∞ÂΩï1Ê¨°PVÔºåÁî®Êà∑Â§öÊ¨°ÊâìÂºÄÈ°µÈù¢ÔºåÂàôËÆ∞ÂΩïÂ§öÊ¨°PV„ÄÇÂæÄÂæÄÁî®Êù•Ë°°ÈáèÁΩëÁ´ôÁöÑÊµÅÈáè„ÄÇ</li>
</ul>
<ul>
<li>ÈÄöÂ∏∏Êù•ËØ¥UV‰ºöÊØîPVÂ§ßÂæàÂ§öÔºåÊâÄ‰ª•Ë°°ÈáèÂêå‰∏Ä‰∏™ÁΩëÁ´ôÁöÑËÆøÈóÆÈáèÔºåÊàë‰ª¨ÈúÄË¶ÅÁªºÂêàËÄÉËôëÂæàÂ§öÂõ†Á¥†ÔºåÊâÄ‰ª•Êàë‰ª¨Âè™ÊòØÂçïÁ∫ØÁöÑÊääËøô‰∏§‰∏™ÂÄº‰Ωú‰∏∫‰∏Ä‰∏™ÂèÇËÄÉÂÄº</li>
<li>UVÁªüËÆ°Âú®ÊúçÂä°Á´ØÂÅö‰ºöÊØîËæÉÈ∫ªÁÉ¶ÔºåÂõ†‰∏∫Ë¶ÅÂà§Êñ≠ËØ•Áî®Êà∑ÊòØÂê¶Â∑≤ÁªèÁªüËÆ°Ëøá‰∫ÜÔºåÈúÄË¶ÅÂ∞ÜÁªüËÆ°ËøáÁöÑÁî®Êà∑‰ø°ÊÅØ‰øùÂ≠ò„ÄÇ‰ΩÜÊòØÂ¶ÇÊûúÊØè‰∏™ËÆøÈóÆÁöÑÁî®Êà∑ÈÉΩ‰øùÂ≠òÂà∞Redis‰∏≠ÔºåÊï∞ÊçÆÈáè‰ºöÈùûÂ∏∏ÊÅêÊÄñÔºåÈÇ£ÊÄé‰πàÂ§ÑÁêÜÂë¢Ôºü</li>
</ul>
<h4 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h4><ul>
<li>Hyperloglog(HLL)ÊòØ‰ªéLoglogÁÆóÊ≥ïÊ¥æÁîüÁöÑÊ¶ÇÁéáÁÆóÊ≥ïÔºåÁî®‰∫éÁ°ÆÂÆöÈùûÂ∏∏Â§ßÁöÑÈõÜÂêàÁöÑÂü∫Êï∞ÔºåËÄå‰∏çÈúÄË¶ÅÂ≠òÂÇ®ÂÖ∂ÊâÄÊúâÂÄº„ÄÇ</li>
<li>Redis‰∏≠ÁöÑHLLÊòØÂü∫‰∫éstringÁªìÊûÑÂÆûÁé∞ÁöÑÔºåÂçï‰∏™HLLÁöÑÂÜÖÂ≠ò<strong>Ê∞∏ËøúÂ∞è‰∫é16kb</strong>Ôºå<strong>ÂÜÖÂ≠òÂç†Áî®‰Ωé</strong>ÁöÑ‰ª§‰∫∫ÂèëÊåáÔºÅ‰Ωú‰∏∫‰ª£‰ª∑ÔºåÂÖ∂ÊµãÈáèÁªìÊûúÊòØÊ¶ÇÁéáÊÄßÁöÑÔºå<strong>ÊúâÂ∞è‰∫é0.81ÔºÖÁöÑËØØÂ∑Æ</strong>„ÄÇ‰∏çËøáÂØπ‰∫éUVÁªüËÆ°Êù•ËØ¥ÔºåËøôÂÆåÂÖ®ÂèØ‰ª•ÂøΩÁï•„ÄÇ</li>
</ul>
<h1 id="‰∏â-RedisÈ´òÁ∫ßÁØá"><a href="#‰∏â-RedisÈ´òÁ∫ßÁØá" class="headerlink" title="‰∏â. RedisÈ´òÁ∫ßÁØá"></a>‰∏â. RedisÈ´òÁ∫ßÁØá</h1><h2 id="1-ÂàÜÂ∏ÉÂºèÁºìÂ≠ò"><a href="#1-ÂàÜÂ∏ÉÂºèÁºìÂ≠ò" class="headerlink" title="1. ÂàÜÂ∏ÉÂºèÁºìÂ≠ò"></a>1. ÂàÜÂ∏ÉÂºèÁºìÂ≠ò</h2><h3 id="1-1-ÂçïÁÇπRedisÁöÑÈóÆÈ¢ò"><a href="#1-1-ÂçïÁÇπRedisÁöÑÈóÆÈ¢ò" class="headerlink" title="1.1 ÂçïÁÇπRedisÁöÑÈóÆÈ¢ò"></a>1.1 ÂçïÁÇπRedisÁöÑÈóÆÈ¢ò</h3><ul>
<li><p>Êï∞ÊçÆ‰∏¢Â§±ÈóÆÈ¢ò</p>
<ul>
<li>RedisÊòØÂÜÖÂ≠òÂ≠òÂÇ®ÔºåÊúçÂä°ÈáçÂêØÂèØËÉΩ‰ºö‰∏¢Â§±Êï∞ÊçÆ</li>
<li>Ëß£ÂÜ≥ÊñπÊ°àÔºöÂÆûÁé∞RedisÊï∞ÊçÆÊåÅ‰πÖÂåñ</li>
</ul>
</li>
<li><p>Âπ∂ÂèëËÉΩÂäõÈóÆÈ¢ò</p>
<ul>
<li>ÂçïËäÇÁÇπRedisÂπ∂ÂèëËÉΩÂäõËôΩÁÑ∂‰∏çÈîôÔºå‰ΩÜ‰πüÊó†Ê≥ïÊª°Ë∂≥Â¶Ç618ËøôÊ†∑ÁöÑÈ´òÂπ∂ÂèëÂú∫ÊôØ</li>
<li>Ëß£ÂÜ≥ÊñπÊ°àÔºöÊê≠Âª∫‰∏ª‰ªéÈõÜÁæ§ÔºåÂÆûÁé∞ËØªÂÜôÂàÜÁ¶ª</li>
</ul>
</li>
<li><p>ÊïÖÈöúÊÅ¢Â§çÈóÆÈ¢ò</p>
<ul>
<li>Â¶ÇÊûúRedisÂÆïÊú∫ÔºåÂàôÊúçÂä°‰∏çÂèØÁî®ÔºåÈúÄË¶Å‰∏ÄÁßçËá™Âä®ÁöÑÊïÖÈöúÊÅ¢Â§çÊâãÊÆµ</li>
<li>Ëß£ÂÜ≥ÊñπÊ°àÔºöÂà©Áî®RedisÂì®ÂÖµÔºåÂÆûÁé∞ÂÅ•Â∫∑Ê£ÄÊµãÂíåËá™Âä®ÊÅ¢Â§ç</li>
</ul>
</li>
<li><p>Â≠òÂÇ®ËÉΩÂäõÈóÆÈ¢ò</p>
<ul>
<li>RedisÂü∫‰∫éÂÜÖÂ≠òÔºåÂçïËäÇÁÇπËÉΩÂ≠òÂÇ®ÁöÑÊï∞ÊçÆÈáèÈöæ‰ª•Êª°Ë∂≥Êµ∑ÈáèÊï∞ÊçÆÈúÄÊ±Ç</li>
<li>Ëß£ÂÜ≥ÊñπÊ°àÔºöÊê≠Âª∫ÂàÜÁâáÈõÜÁæ§ÔºåÂà©Áî®ÊèíÊßΩÊú∫Âà∂ÂÆûÁé∞Âä®ÊÄÅÊâ©ÂÆπ</li>
</ul>
</li>
</ul>
<h3 id="1-2-RedisÊåÅ‰πÖÂåñ"><a href="#1-2-RedisÊåÅ‰πÖÂåñ" class="headerlink" title="1.2 RedisÊåÅ‰πÖÂåñ"></a>1.2 RedisÊåÅ‰πÖÂåñ</h3><p>RedisÊúâ‰∏§ÁßçÊåÅ‰πÖÂåñÊñπÊ°àÔºö</p>
<ul>
<li>RDBÊåÅ‰πÖÂåñ</li>
<li>AOFÊåÅ‰πÖÂåñ</li>
</ul>
<h4 id="1-2-1-RDBÊåÅ‰πÖÂåñ"><a href="#1-2-1-RDBÊåÅ‰πÖÂåñ" class="headerlink" title="1.2.1 RDBÊåÅ‰πÖÂåñ"></a>1.2.1 RDBÊåÅ‰πÖÂåñ</h4><p>RDBÂÖ®Áß∞Redis Database Backup fileÔºàRedisÊï∞ÊçÆÂ§á‰ªΩÊñá‰ª∂ÔºâÔºå‰πüË¢´Âè´ÂÅöRedisÊï∞ÊçÆÂø´ÁÖß„ÄÇÁÆÄÂçïÊù•ËØ¥Â∞±ÊòØÊääÂÜÖÂ≠ò‰∏≠ÁöÑÊâÄÊúâÊï∞ÊçÆÈÉΩËÆ∞ÂΩïÂà∞Á£ÅÁõò‰∏≠„ÄÇÂΩìRedisÂÆû‰æãÊïÖÈöúÈáçÂêØÂêéÔºå‰ªéÁ£ÅÁõòËØªÂèñÂø´ÁÖßÊñá‰ª∂ÔºåÊÅ¢Â§çÊï∞ÊçÆ„ÄÇÂø´ÁÖßÊñá‰ª∂Áß∞‰∏∫RDBÊñá‰ª∂ÔºåÈªòËÆ§ÊòØ‰øùÂ≠òÂú®ÂΩìÂâçËøêË°åÁõÆÂΩï„ÄÇ</p>
<h5 id="1-2-1-1-RDBÊåÅ‰πÖÂåñÂú®ÂõõÁßçÊÉÖÂÜµ‰∏ã‰ºöÊâßË°åÔºö"><a href="#1-2-1-1-RDBÊåÅ‰πÖÂåñÂú®ÂõõÁßçÊÉÖÂÜµ‰∏ã‰ºöÊâßË°åÔºö" class="headerlink" title="1.2.1.1 RDBÊåÅ‰πÖÂåñÂú®ÂõõÁßçÊÉÖÂÜµ‰∏ã‰ºöÊâßË°åÔºö"></a>1.2.1.1 RDBÊåÅ‰πÖÂåñÂú®ÂõõÁßçÊÉÖÂÜµ‰∏ã‰ºöÊâßË°åÔºö</h5><ul>
<li>ÊâßË°åsaveÂëΩ‰ª§</li>
<li>ÊâßË°åbgsaveÂëΩ‰ª§</li>
<li><strong>RedisÂÅúÊú∫Êó∂</strong></li>
<li>Ëß¶ÂèëRDBÊù°‰ª∂Êó∂</li>
</ul>
<h5 id="1-2-1-2-Ëß¶ÂèëRDBÊù°‰ª∂"><a href="#1-2-1-2-Ëß¶ÂèëRDBÊù°‰ª∂" class="headerlink" title="1.2.1.2 Ëß¶ÂèëRDBÊù°‰ª∂"></a>1.2.1.2 Ëß¶ÂèëRDBÊù°‰ª∂</h5><ul>
<li>RedisÂÜÖÈÉ®ÊúâËß¶ÂèëRDBÁöÑÊú∫Âà∂ÔºåÂèØ‰ª•Âú®redis.confÊñá‰ª∂‰∏≠ÊâæÂà∞ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 900ÁßíÂÜÖÔºåÂ¶ÇÊûúËá≥Â∞ëÊúâ1‰∏™keyË¢´‰øÆÊîπÔºåÂàôÊâßË°åbgsave Ôºå Â¶ÇÊûúÊòØsave &quot;&quot; ÂàôË°®Á§∫Á¶ÅÁî®RDB</span><br><span class="hljs-attr">save</span> <span class="hljs-string">900 1  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">300 10  </span><br><span class="hljs-attr">save</span> <span class="hljs-string">60 10000 </span><br></code></pre></td></tr></table></figure>

<ul>
<li>RDBÁöÑÂÖ∂ÂÆÉÈÖçÁΩÆ‰πüÂèØ‰ª•Âú®redis.confÊñá‰ª∂‰∏≠ËÆæÁΩÆÔºö</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># ÊòØÂê¶ÂéãÁº© ,Âª∫ËÆÆ‰∏çÂºÄÂêØÔºåÂéãÁº©‰πü‰ºöÊ∂àËÄócpuÔºåÁ£ÅÁõòÁöÑËØù‰∏çÂÄºÈí±</span><br><span class="hljs-attr">rdbcompression</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># RDBÊñá‰ª∂ÂêçÁß∞</span><br><span class="hljs-attr">dbfilename</span> <span class="hljs-string">dump.rdb  </span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># Êñá‰ª∂‰øùÂ≠òÁöÑË∑ØÂæÑÁõÆÂΩï</span><br><span class="hljs-attr">dir</span> <span class="hljs-string">./ </span><br></code></pre></td></tr></table></figure>

<h4 id="1-2-2-RDBÂéüÁêÜ"><a href="#1-2-2-RDBÂéüÁêÜ" class="headerlink" title="1.2.2 RDBÂéüÁêÜ"></a>1.2.2 RDBÂéüÁêÜ</h4><p>bgsaveÂºÄÂßãÊó∂‰ºöfork‰∏ªËøõÁ®ãÂæóÂà∞Â≠êËøõÁ®ãÔºåÂ≠êËøõÁ®ãÂÖ±‰∫´‰∏ªËøõÁ®ãÁöÑÂÜÖÂ≠òÊï∞ÊçÆ„ÄÇÂÆåÊàêforkÂêéËØªÂèñÂÜÖÂ≠òÊï∞ÊçÆÂπ∂ÂÜôÂÖ• RDB Êñá‰ª∂„ÄÇ</p>
<p>forkÈááÁî®ÁöÑÊòØcopy-on-writeÊäÄÊúØÔºö</p>
<ul>
<li>ÂΩì‰∏ªËøõÁ®ãÊâßË°åËØªÊìç‰ΩúÊó∂ÔºåËÆøÈóÆÂÖ±‰∫´ÂÜÖÂ≠òÔºõ</li>
<li>ÂΩì‰∏ªËøõÁ®ãÊâßË°åÂÜôÊìç‰ΩúÊó∂ÔºåÂàô‰ºöÊã∑Ë¥ù‰∏Ä‰ªΩÊï∞ÊçÆÔºåÊâßË°åÂÜôÊìç‰Ωú„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="1-2-3-RDBÂ∞èÁªì"><a href="#1-2-3-RDBÂ∞èÁªì" class="headerlink" title="1.2.3 RDBÂ∞èÁªì"></a>1.2.3 RDBÂ∞èÁªì</h4><p>RDBÊñπÂºèbgsaveÁöÑÂü∫Êú¨ÊµÅÁ®ãÔºü</p>
<ul>
<li>fork‰∏ªËøõÁ®ãÂæóÂà∞‰∏Ä‰∏™Â≠êËøõÁ®ãÔºåÂÖ±‰∫´ÂÜÖÂ≠òÁ©∫Èó¥</li>
<li>Â≠êËøõÁ®ãËØªÂèñÂÜÖÂ≠òÊï∞ÊçÆÂπ∂ÂÜôÂÖ•Êñ∞ÁöÑRDBÊñá‰ª∂</li>
<li>Áî®Êñ∞RDBÊñá‰ª∂ÊõøÊç¢ÊóßÁöÑRDBÊñá‰ª∂</li>
</ul>
<p>RDB‰ºöÂú®‰ªÄ‰πàÊó∂ÂÄôÊâßË°åÔºüsave 60 1000‰ª£Ë°®‰ªÄ‰πàÂê´‰πâÔºü</p>
<ul>
<li>ÈªòËÆ§ÊòØÊúçÂä°ÂÅúÊ≠¢Êó∂</li>
<li>‰ª£Ë°®60ÁßíÂÜÖËá≥Â∞ëÊâßË°å1000Ê¨°‰øÆÊîπÂàôËß¶ÂèëRDB</li>
</ul>
<p>RDBÁöÑÁº∫ÁÇπÔºü</p>
<ul>
<li>RDBÊâßË°åÈó¥ÈöîÊó∂Èó¥ÈïøÔºå‰∏§Ê¨°RDB‰πãÈó¥ÂÜôÂÖ•Êï∞ÊçÆÊúâ‰∏¢Â§±ÁöÑÈ£éÈô©</li>
<li>forkÂ≠êËøõÁ®ã„ÄÅÂéãÁº©„ÄÅÂÜôÂá∫RDBÊñá‰ª∂ÈÉΩÊØîËæÉËÄóÊó∂</li>
</ul>
<h4 id="1-2-4-AOFÊåÅ‰πÖÂåñ"><a href="#1-2-4-AOFÊåÅ‰πÖÂåñ" class="headerlink" title="1.2.4 AOFÊåÅ‰πÖÂåñ"></a>1.2.4 AOFÊåÅ‰πÖÂåñ</h4><p>AOFÂÖ®Áß∞‰∏∫Append Only FileÔºàËøΩÂä†Êñá‰ª∂Ôºâ„ÄÇRedisÂ§ÑÁêÜÁöÑÊØè‰∏Ä‰∏™ÂÜôÂëΩ‰ª§ÈÉΩ‰ºöËÆ∞ÂΩïÂú®AOFÊñá‰ª∂ÔºåÂèØ‰ª•ÁúãÂÅöÊòØÂëΩ‰ª§Êó•ÂøóÊñá‰ª∂„ÄÇ</p>
<p><img src="/img/blogs/java/redis/3.1.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>AOFÈªòËÆ§ÊòØÂÖ≥Èó≠ÁöÑÔºåÈúÄË¶Å‰øÆÊîπredis.confÈÖçÁΩÆÊñá‰ª∂Êù•ÂºÄÂêØAOFÔºö</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># ÊòØÂê¶ÂºÄÂêØAOFÂäüËÉΩÔºåÈªòËÆ§ÊòØno</span><br><span class="hljs-attr">appendonly</span> <span class="hljs-string">yes</span><br><span class="hljs-comment"># AOFÊñá‰ª∂ÁöÑÂêçÁß∞</span><br><span class="hljs-attr">appendfilename</span> <span class="hljs-string">&quot;appendonly.aof&quot;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>AOFÁöÑÂëΩ‰ª§ËÆ∞ÂΩïÁöÑÈ¢ëÁéá‰πüÂèØ‰ª•ÈÄöËøáredis.confÊñá‰ª∂Êù•ÈÖçÔºö</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># Ë°®Á§∫ÊØèÊâßË°å‰∏ÄÊ¨°ÂÜôÂëΩ‰ª§ÔºåÁ´ãÂç≥ËÆ∞ÂΩïÂà∞AOFÊñá‰ª∂</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">always </span><br><span class="hljs-comment"># ÂÜôÂëΩ‰ª§ÊâßË°åÂÆåÂÖàÊîæÂÖ•AOFÁºìÂÜ≤Âå∫ÔºåÁÑ∂ÂêéË°®Á§∫ÊØèÈöî1ÁßíÂ∞ÜÁºìÂÜ≤Âå∫Êï∞ÊçÆÂÜôÂà∞AOFÊñá‰ª∂ÔºåÊòØÈªòËÆ§ÊñπÊ°à</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">everysec </span><br><span class="hljs-comment"># ÂÜôÂëΩ‰ª§ÊâßË°åÂÆåÂÖàÊîæÂÖ•AOFÁºìÂÜ≤Âå∫ÔºåÁî±Êìç‰ΩúÁ≥ªÁªüÂÜ≥ÂÆö‰ΩïÊó∂Â∞ÜÁºìÂÜ≤Âå∫ÂÜÖÂÆπÂÜôÂõûÁ£ÅÁõò</span><br><span class="hljs-attr">appendfsync</span> <span class="hljs-string">no</span><br></code></pre></td></tr></table></figure>


<h4 id="1-2-5-AOFÊñá‰ª∂ÈáçÂÜô"><a href="#1-2-5-AOFÊñá‰ª∂ÈáçÂÜô" class="headerlink" title="1.2.5 AOFÊñá‰ª∂ÈáçÂÜô"></a>1.2.5 AOFÊñá‰ª∂ÈáçÂÜô</h4><p>Âõ†‰∏∫ÊòØËÆ∞ÂΩïÂëΩ‰ª§ÔºåAOFÊñá‰ª∂‰ºöÊØîRDBÊñá‰ª∂Â§ßÁöÑÂ§ö„ÄÇËÄå‰∏îAOF‰ºöËÆ∞ÂΩïÂØπÂêå‰∏Ä‰∏™keyÁöÑÂ§öÊ¨°ÂÜôÊìç‰ΩúÔºå‰ΩÜÂè™ÊúâÊúÄÂêé‰∏ÄÊ¨°ÂÜôÊìç‰ΩúÊâçÊúâÊÑè‰πâ„ÄÇÈÄöËøáÊâßË°åbgrewriteaofÂëΩ‰ª§ÔºåÂèØ‰ª•ËÆ©AOFÊñá‰ª∂ÊâßË°åÈáçÂÜôÂäüËÉΩÔºåÁî®ÊúÄÂ∞ëÁöÑÂëΩ‰ª§ËææÂà∞Áõ∏ÂêåÊïàÊûú„ÄÇ</p>
<p><img src="/img/blogs/java/redis/3.1.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Redis‰πü‰ºöÂú®Ëß¶ÂèëÈòàÂÄºÊó∂Ëá™Âä®ÂéªÈáçÂÜôAOFÊñá‰ª∂„ÄÇÈòàÂÄº‰πüÂèØ‰ª•Âú®redis.conf‰∏≠ÈÖçÁΩÆÔºö</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># AOFÊñá‰ª∂ÊØî‰∏äÊ¨°Êñá‰ª∂ Â¢ûÈïøË∂ÖËøáÂ§öÂ∞ëÁôæÂàÜÊØîÂàôËß¶ÂèëÈáçÂÜô</span><br><span class="hljs-attr">auto-aof-rewrite-percentage</span> <span class="hljs-string">100</span><br><span class="hljs-comment"># AOFÊñá‰ª∂‰ΩìÁßØÊúÄÂ∞èÂ§öÂ§ß‰ª•‰∏äÊâçËß¶ÂèëÈáçÂÜô </span><br><span class="hljs-attr">auto-aof-rewrite-min-size</span> <span class="hljs-string">64mb </span><br></code></pre></td></tr></table></figure>


<h4 id="1-2-6-RDB‰∏éAOFÂØπÊØî"><a href="#1-2-6-RDB‰∏éAOFÂØπÊØî" class="headerlink" title="1.2.6 RDB‰∏éAOFÂØπÊØî"></a>1.2.6 RDB‰∏éAOFÂØπÊØî</h4><p>RDBÂíåAOFÂêÑÊúâËá™Â∑±ÁöÑ‰ºòÁº∫ÁÇπÔºåÂ¶ÇÊûúÂØπÊï∞ÊçÆÂÆâÂÖ®ÊÄßË¶ÅÊ±ÇËæÉÈ´òÔºåÂú®ÂÆûÈôÖÂºÄÂèë‰∏≠ÂæÄÂæÄ‰ºö<strong>ÁªìÂêà</strong>‰∏§ËÄÖÊù•‰ΩøÁî®„ÄÇ</p>
<table>
<thead>
<tr>
<th></th>
<th>RDB</th>
<th>AOF</th>
</tr>
</thead>
<tbody><tr>
<td><strong>ÊåÅ‰πÖÂåñÊñπÂºè</strong></td>
<td>ÂÆöÊó∂ÂØπÊï¥‰∏™ÂÜÖÂ≠òÂÅöÂø´ÁÖß</td>
<td>ËÆ∞ÂΩïÊØè‰∏ÄÊ¨°ÊâßË°åÁöÑÂëΩ‰ª§</td>
</tr>
<tr>
<td><strong>Êï∞ÊçÆÂÆåÊï¥ÊÄß</strong></td>
<td>‰∏çÂÆåÊï¥Ôºå‰∏§Ê¨°Â§á‰ªΩ‰πãÈó¥‰ºö‰∏¢Â§±</td>
<td>Áõ∏ÂØπÂÆåÊï¥ÔºåÂèñÂÜ≥‰∫éÂà∑ÁõòÁ≠ñÁï•</td>
</tr>
<tr>
<td><strong>Êñá‰ª∂Â§ßÂ∞è</strong></td>
<td>‰ºöÊúâÂéãÁº©ÔºåÊñá‰ª∂‰ΩìÁßØÂ∞è</td>
<td>ËÆ∞ÂΩïÂëΩ‰ª§ÔºåÊñá‰ª∂‰ΩìÁßØÂæàÂ§ß</td>
</tr>
<tr>
<td><strong>ÂÆïÊú∫ÊÅ¢Â§çÈÄüÂ∫¶</strong></td>
<td>ÂæàÂø´</td>
<td>ÊÖ¢</td>
</tr>
<tr>
<td><strong>Êï∞ÊçÆÊÅ¢Â§ç‰ºòÂÖàÁ∫ß</strong></td>
<td>‰ΩéÔºåÂõ†‰∏∫Êï∞ÊçÆÂÆåÊï¥ÊÄß‰∏çÂ¶ÇAOF</td>
<td>È´òÔºåÂõ†‰∏∫Êï∞ÊçÆÂÆåÊï¥ÊÄßÊõ¥È´ò</td>
</tr>
<tr>
<td><strong>Á≥ªÁªüËµÑÊ∫êÂç†Áî®</strong></td>
<td>È´òÔºåÂ§ßÈáèCPUÂíåÂÜÖÂ≠òÊ∂àËÄó</td>
<td>‰ΩéÔºå‰∏ªË¶ÅÊòØÁ£ÅÁõòIOËµÑÊ∫ê<br>‰ΩÜAOFÈáçÂÜôÊó∂‰ºöÂç†Áî®Â§ßÈáèCPUÂíåÂÜÖÂ≠òËµÑÊ∫ê</td>
</tr>
<tr>
<td><strong>‰ΩøÁî®Âú∫ÊôØ</strong></td>
<td>ÂèØ‰ª•ÂÆπÂøçÊï∞ÂàÜÈíüÁöÑÊï∞ÊçÆ‰∏¢Â§±ÔºåËøΩÊ±ÇÊõ¥Âø´ÁöÑÂêØÂä®ÈÄüÂ∫¶</td>
<td>ÂØπÊï∞ÊçÆÂÆâÂÖ®ÊÄßË¶ÅÊ±ÇËæÉÈ´òÂ∏∏ËßÅ</td>
</tr>
</tbody></table>
<h2 id="2-Redis‰∏ª‰ªé"><a href="#2-Redis‰∏ª‰ªé" class="headerlink" title="2. Redis‰∏ª‰ªé"></a>2. Redis‰∏ª‰ªé</h2><ul>
<li>Redis‰∏ªÁªìÁÇπÂè™ÂÜô(master)</li>
<li>Redis‰ªéÁªìÁÇπÂè™ËØª(slave)</li>
</ul>
<h3 id="2-1-Êê≠Âª∫‰∏ª‰ªéÊû∂ÊûÑ"><a href="#2-1-Êê≠Âª∫‰∏ª‰ªéÊû∂ÊûÑ" class="headerlink" title="2.1 Êê≠Âª∫‰∏ª‰ªéÊû∂ÊûÑ"></a>2.1 Êê≠Âª∫‰∏ª‰ªéÊû∂ÊûÑ</h3><p>ÂçïËäÇÁÇπRedisÁöÑÂπ∂ÂèëËÉΩÂäõÊòØÊúâ‰∏äÈôêÁöÑÔºåË¶ÅËøõ‰∏ÄÊ≠•ÊèêÈ´òRedisÁöÑÂπ∂ÂèëËÉΩÂäõÔºåÂ∞±ÈúÄË¶ÅÊê≠Âª∫‰∏ª‰ªéÈõÜÁæ§ÔºåÂÆûÁé∞ËØªÂÜôÂàÜÁ¶ª„ÄÇ</p>
<p><img src="/img/blogs/java/redis/3.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-‰∏ª‰ªéÊï∞ÊçÆÂêåÊ≠•ÂéüÁêÜ"><a href="#2-2-‰∏ª‰ªéÊï∞ÊçÆÂêåÊ≠•ÂéüÁêÜ" class="headerlink" title="2.2 ‰∏ª‰ªéÊï∞ÊçÆÂêåÊ≠•ÂéüÁêÜ"></a>2.2 ‰∏ª‰ªéÊï∞ÊçÆÂêåÊ≠•ÂéüÁêÜ</h3><h4 id="2-2-1-ÂÖ®ÈáèÂêåÊ≠•"><a href="#2-2-1-ÂÖ®ÈáèÂêåÊ≠•" class="headerlink" title="2.2.1 ÂÖ®ÈáèÂêåÊ≠•"></a>2.2.1 ÂÖ®ÈáèÂêåÊ≠•</h4><p>‰∏ª‰ªéÁ¨¨‰∏ÄÊ¨°Âª∫Á´ãËøûÊé•Êó∂Ôºå‰ºöÊâßË°å<strong>ÂÖ®ÈáèÂêåÊ≠•</strong>ÔºåÂ∞ÜmasterËäÇÁÇπÁöÑÊâÄÊúâÊï∞ÊçÆÈÉΩÊã∑Ë¥ùÁªôslaveËäÇÁÇπÔºö</p>
<p><img src="/img/blogs/java/redis/3.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>masterÂ¶Ç‰ΩïÂæóÁü•salveÊòØÁ¨¨‰∏ÄÊ¨°Êù•ËøûÊé•Âë¢</strong>ÔºüÔºü<br>ÊúâÂá†‰∏™Ê¶ÇÂøµÔºåÂèØ‰ª•‰Ωú‰∏∫Âà§Êñ≠‰æùÊçÆÔºö</p>
<ul>
<li><p><strong>Replication Id</strong>ÔºöÁÆÄÁß∞replidÔºåÊòØÊï∞ÊçÆÈõÜÁöÑÊ†áËÆ∞Ôºåid‰∏ÄËá¥ÂàôËØ¥ÊòéÊòØÂêå‰∏ÄÊï∞ÊçÆÈõÜ„ÄÇÊØè‰∏Ä‰∏™masterÈÉΩÊúâÂîØ‰∏ÄÁöÑreplidÔºåslaveÂàô‰ºöÁªßÊâømasterËäÇÁÇπÁöÑreplid</p>
</li>
<li><p><strong>offset</strong>ÔºöÂÅèÁßªÈáèÔºåÈöèÁùÄËÆ∞ÂΩïÂú®repl_baklog‰∏≠ÁöÑÊï∞ÊçÆÂ¢ûÂ§öËÄåÈÄêÊ∏êÂ¢ûÂ§ß„ÄÇslaveÂÆåÊàêÂêåÊ≠•Êó∂‰πü‰ºöËÆ∞ÂΩïÂΩìÂâçÂêåÊ≠•ÁöÑoffset„ÄÇÂ¶ÇÊûúslaveÁöÑoffsetÂ∞è‰∫émasterÁöÑoffsetÔºåËØ¥ÊòéslaveÊï∞ÊçÆËêΩÂêé‰∫émasterÔºåÈúÄË¶ÅÊõ¥Êñ∞„ÄÇ</p>
</li>
<li><p>Âõ†Ê≠§slaveÂÅöÊï∞ÊçÆÂêåÊ≠•ÔºåÂøÖÈ°ªÂêëmasterÂ£∞ÊòéËá™Â∑±ÁöÑreplication id ÂíåoffsetÔºåmasterÊâçÂèØ‰ª•Âà§Êñ≠Âà∞Â∫ïÈúÄË¶ÅÂêåÊ≠•Âì™‰∫õÊï∞ÊçÆ„ÄÇ</p>
</li>
</ul>
<p>Âõ†Ê≠§Ôºå<strong>masterÂà§Êñ≠‰∏Ä‰∏™ËäÇÁÇπÊòØÂê¶ÊòØÁ¨¨‰∏ÄÊ¨°ÂêåÊ≠•ÁöÑ‰æùÊçÆÔºåÂ∞±ÊòØÁúãreplidÊòØÂê¶‰∏ÄËá¥</strong>„ÄÇ</p>
<p><img src="/img/blogs/java/redis/3.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p>ÂÆåÊï¥ÊµÅÁ®ãÊèèËø∞Ôºö</p>
<ul>
<li>slaveËäÇÁÇπËØ∑Ê±ÇÂ¢ûÈáèÂêåÊ≠•</li>
<li>masterËäÇÁÇπÂà§Êñ≠replidÔºåÂèëÁé∞‰∏ç‰∏ÄËá¥ÔºåÊãíÁªùÂ¢ûÈáèÂêåÊ≠•</li>
<li>masterÂ∞ÜÂÆåÊï¥ÂÜÖÂ≠òÊï∞ÊçÆÁîüÊàêRDBÔºåÂèëÈÄÅRDBÂà∞slave</li>
<li>slaveÊ∏ÖÁ©∫Êú¨Âú∞Êï∞ÊçÆÔºåÂä†ËΩΩmasterÁöÑRDB</li>
<li>masterÂ∞ÜRDBÊúüÈó¥ÁöÑÂëΩ‰ª§ËÆ∞ÂΩïÂú®repl_baklogÔºåÂπ∂ÊåÅÁª≠Â∞Ülog‰∏≠ÁöÑÂëΩ‰ª§ÂèëÈÄÅÁªôslave</li>
<li>slaveÊâßË°åÊé•Êî∂Âà∞ÁöÑÂëΩ‰ª§Ôºå‰øùÊåÅ‰∏émaster‰πãÈó¥ÁöÑÂêåÊ≠•</li>
</ul>
<h4 id="2-2-2-Â¢ûÈáèÂêåÊ≠•"><a href="#2-2-2-Â¢ûÈáèÂêåÊ≠•" class="headerlink" title="2.2.2 Â¢ûÈáèÂêåÊ≠•"></a>2.2.2 Â¢ûÈáèÂêåÊ≠•</h4><p>ÂÖ®ÈáèÂêåÊ≠•ÈúÄË¶ÅÂÖàÂÅöRDBÔºåÁÑ∂ÂêéÂ∞ÜRDBÊñá‰ª∂ÈÄöËøáÁΩëÁªú‰º†Ëæì‰∏™slaveÔºåÊàêÊú¨Â§™È´ò‰∫Ü„ÄÇÂõ†Ê≠§Èô§‰∫ÜÁ¨¨‰∏ÄÊ¨°ÂÅöÂÖ®ÈáèÂêåÊ≠•ÔºåÂÖ∂ÂÆÉÂ§ßÂ§öÊï∞Êó∂ÂÄôslave‰∏émasterÈÉΩÊòØÂÅö<strong>Â¢ûÈáèÂêåÊ≠•</strong>„ÄÇ</p>
<ul>
<li>‰ªÄ‰πàÊòØÂ¢ûÈáèÂêåÊ≠•ÔºüÂ∞±ÊòØÂè™Êõ¥Êñ∞slave‰∏émasterÂ≠òÂú®Â∑ÆÂºÇÁöÑÈÉ®ÂàÜÊï∞ÊçÆ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.2.4.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>repl_baklog‰∏≠‰ºöËÆ∞ÂΩïRedisÂ§ÑÁêÜËøáÁöÑÂëΩ‰ª§Êó•ÂøóÂèäoffsetÔºåÂåÖÊã¨masterÂΩìÂâçÁöÑoffsetÔºåÂíåslaveÂ∑≤ÁªèÊã∑Ë¥ùÂà∞ÁöÑoffsetÔºö<ul>
<li>slave‰∏émasterÁöÑoffset‰πãÈó¥ÁöÑÂ∑ÆÂºÇÔºåÂ∞±ÊòØsalveÈúÄË¶ÅÂ¢ûÈáèÊã∑Ë¥ùÁöÑÊï∞ÊçÆ‰∫Ü„ÄÇ</li>
</ul>
</li>
<li>repl_baklogÂ§ßÂ∞èÊúâ‰∏äÈôêÔºåÂÜôÊª°Âêé‰ºöË¶ÜÁõñÊúÄÊó©ÁöÑÊï∞ÊçÆ„ÄÇÂ¶ÇÊûúslaveÊñ≠ÂºÄÊó∂Èó¥Ëøá‰πÖÔºåÂØºËá¥Â∞öÊú™Â§á‰ªΩÁöÑÊï∞ÊçÆË¢´Ë¶ÜÁõñÔºåÂàôÊó†Ê≥ïÂü∫‰∫élogÂÅöÂ¢ûÈáèÂêåÊ≠•ÔºåÂè™ËÉΩÂÜçÊ¨°ÂÖ®ÈáèÂêåÊ≠•„ÄÇ</li>
</ul>
<h4 id="2-2-3-‰∏ª‰ªéÂêåÊ≠•‰ºòÂåñ"><a href="#2-2-3-‰∏ª‰ªéÂêåÊ≠•‰ºòÂåñ" class="headerlink" title="2.2.3 ‰∏ª‰ªéÂêåÊ≠•‰ºòÂåñ"></a>2.2.3 ‰∏ª‰ªéÂêåÊ≠•‰ºòÂåñ</h4><ul>
<li>Âú®master‰∏≠ÈÖçÁΩÆrepl-diskless-sync yesÂêØÁî®Êó†Á£ÅÁõòÂ§çÂà∂ÔºåÈÅøÂÖçÂÖ®ÈáèÂêåÊ≠•Êó∂ÁöÑÁ£ÅÁõòIO„ÄÇ</li>
<li>RedisÂçïËäÇÁÇπ‰∏äÁöÑÂÜÖÂ≠òÂç†Áî®‰∏çË¶ÅÂ§™Â§ßÔºåÂáèÂ∞ëRDBÂØºËá¥ÁöÑËøáÂ§öÁ£ÅÁõòIO</li>
<li>ÈÄÇÂΩìÊèêÈ´òrepl_baklogÁöÑÂ§ßÂ∞èÔºåÂèëÁé∞slaveÂÆïÊú∫Êó∂Â∞ΩÂø´ÂÆûÁé∞ÊïÖÈöúÊÅ¢Â§çÔºåÂ∞ΩÂèØËÉΩÈÅøÂÖçÂÖ®ÈáèÂêåÊ≠•</li>
<li>ÈôêÂà∂‰∏Ä‰∏™master‰∏äÁöÑslaveËäÇÁÇπÊï∞ÈáèÔºåÂ¶ÇÊûúÂÆûÂú®ÊòØÂ§™Â§öslaveÔºåÂàôÂèØ‰ª•ÈááÁî®‰∏ª-‰ªé-‰ªéÈìæÂºèÁªìÊûÑÔºåÂáèÂ∞ëmasterÂéãÂäõ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-2-4-Â∞èÁªì"><a href="#2-2-4-Â∞èÁªì" class="headerlink" title="2.2.4 Â∞èÁªì"></a>2.2.4 Â∞èÁªì</h4><p>ÁÆÄËø∞ÂÖ®ÈáèÂêåÊ≠•ÂíåÂ¢ûÈáèÂêåÊ≠•Âå∫Âà´Ôºü</p>
<ul>
<li>ÂÖ®ÈáèÂêåÊ≠•ÔºömasterÂ∞ÜÂÆåÊï¥ÂÜÖÂ≠òÊï∞ÊçÆÁîüÊàêRDBÔºåÂèëÈÄÅRDBÂà∞slave„ÄÇÂêéÁª≠ÂëΩ‰ª§ÂàôËÆ∞ÂΩïÂú®repl_baklogÔºåÈÄê‰∏™ÂèëÈÄÅÁªôslave„ÄÇ</li>
<li>Â¢ûÈáèÂêåÊ≠•ÔºöslaveÊèê‰∫§Ëá™Â∑±ÁöÑoffsetÂà∞masterÔºåmasterËé∑Âèñrepl_baklog‰∏≠‰ªéoffset‰πãÂêéÁöÑÂëΩ‰ª§Áªôslave</li>
</ul>
<p>‰ªÄ‰πàÊó∂ÂÄôÊâßË°åÂÖ®ÈáèÂêåÊ≠•Ôºü</p>
<ul>
<li>slaveËäÇÁÇπÁ¨¨‰∏ÄÊ¨°ËøûÊé•masterËäÇÁÇπÊó∂</li>
<li>slaveËäÇÁÇπÊñ≠ÂºÄÊó∂Èó¥Â§™‰πÖÔºårepl_baklog‰∏≠ÁöÑoffsetÂ∑≤ÁªèË¢´Ë¶ÜÁõñÊó∂</li>
</ul>
<p>‰ªÄ‰πàÊó∂ÂÄôÊâßË°åÂ¢ûÈáèÂêåÊ≠•Ôºü</p>
<ul>
<li>slaveËäÇÁÇπÊñ≠ÂºÄÂèàÊÅ¢Â§çÔºåÂπ∂‰∏îÂú®repl_baklog‰∏≠ËÉΩÊâæÂà∞offsetÊó∂</li>
</ul>
<h2 id="3-RedisÂì®ÂÖµ"><a href="#3-RedisÂì®ÂÖµ" class="headerlink" title="3. RedisÂì®ÂÖµ"></a>3. RedisÂì®ÂÖµ</h2><p>RedisÊèê‰æõ‰∫ÜÂì®ÂÖµÔºàSentinelÔºâÊú∫Âà∂Êù•ÂÆûÁé∞‰∏ª‰ªéÈõÜÁæ§ÁöÑËá™Âä®ÊïÖÈöúÊÅ¢Â§ç</p>
<h3 id="3-1-Âì®ÂÖµÁöÑ‰ΩúÁî®"><a href="#3-1-Âì®ÂÖµÁöÑ‰ΩúÁî®" class="headerlink" title="3.1 Âì®ÂÖµÁöÑ‰ΩúÁî®"></a>3.1 Âì®ÂÖµÁöÑ‰ΩúÁî®</h3><ul>
<li><strong>ÁõëÊéß</strong>ÔºöSentinel ‰ºö‰∏çÊñ≠Ê£ÄÊü•ÊÇ®ÁöÑmasterÂíåslaveÊòØÂê¶ÊåâÈ¢ÑÊúüÂ∑•‰Ωú</li>
<li><strong>Ëá™Âä®ÊïÖÈöúÊÅ¢Â§ç</strong>ÔºöÂ¶ÇÊûúmasterÊïÖÈöúÔºåSentinel‰ºöÂ∞Ü‰∏Ä‰∏™slaveÊèêÂçá‰∏∫master„ÄÇÂΩìÊïÖÈöúÂÆû‰æãÊÅ¢Â§çÂêé‰πü‰ª•Êñ∞ÁöÑmaster‰∏∫‰∏ª</li>
<li><strong>ÈÄöÁü•</strong>ÔºöSentinelÂÖÖÂΩìRedisÂÆ¢Êà∑Á´ØÁöÑÊúçÂä°ÂèëÁé∞Êù•Ê∫êÔºåÂΩìÈõÜÁæ§ÂèëÁîüÊïÖÈöúËΩ¨ÁßªÊó∂Ôºå‰ºöÂ∞ÜÊúÄÊñ∞‰ø°ÊÅØÊé®ÈÄÅÁªôRedisÁöÑÂÆ¢Êà∑Á´Ø</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-2-ÈõÜÁæ§ÁõëÊéßÂéüÁêÜ"><a href="#3-2-ÈõÜÁæ§ÁõëÊéßÂéüÁêÜ" class="headerlink" title="3.2 ÈõÜÁæ§ÁõëÊéßÂéüÁêÜ"></a>3.2 ÈõÜÁæ§ÁõëÊéßÂéüÁêÜ</h3><p>SentinelÂü∫‰∫éÂøÉË∑≥Êú∫Âà∂ÁõëÊµãÊúçÂä°Áä∂ÊÄÅÔºåÊØèÈöî1ÁßíÂêëÈõÜÁæ§ÁöÑÊØè‰∏™ÂÆû‰æãÂèëÈÄÅpingÂëΩ‰ª§Ôºö</p>
<ul>
<li>‰∏ªËßÇ‰∏ãÁ∫øÔºöÂ¶ÇÊûúÊüêsentinelËäÇÁÇπÂèëÁé∞ÊüêÂÆû‰æãÊú™Âú®ËßÑÂÆöÊó∂Èó¥ÂìçÂ∫îÔºåÂàôËÆ§‰∏∫ËØ•ÂÆû‰æã<strong>‰∏ªËßÇ‰∏ãÁ∫ø</strong>„ÄÇ</li>
<li>ÂÆ¢ËßÇ‰∏ãÁ∫øÔºöËã•Ë∂ÖËøáÊåáÂÆöÊï∞ÈáèÔºàquorumÔºâÁöÑsentinelÈÉΩËÆ§‰∏∫ËØ•ÂÆû‰æã‰∏ªËßÇ‰∏ãÁ∫øÔºåÂàôËØ•ÂÆû‰æã<strong>ÂÆ¢ËßÇ‰∏ãÁ∫ø</strong>„ÄÇquorumÂÄºÊúÄÂ•ΩË∂ÖËøáSentinelÂÆû‰æãÊï∞ÈáèÁöÑ‰∏ÄÂçä„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-3-ÈÄâ‰∏æÊñ∞ÁöÑmaster"><a href="#3-3-ÈÄâ‰∏æÊñ∞ÁöÑmaster" class="headerlink" title="3.3 ÈÄâ‰∏æÊñ∞ÁöÑmaster"></a>3.3 ÈÄâ‰∏æÊñ∞ÁöÑmaster</h3><p>‰∏ÄÊó¶ÂèëÁé∞masterÊïÖÈöúÔºåsentinelÈúÄË¶ÅÂú®salve‰∏≠ÈÄâÊã©‰∏Ä‰∏™‰Ωú‰∏∫Êñ∞ÁöÑmasterÔºåÈÄâÊã©‰æùÊçÆÊòØËøôÊ†∑ÁöÑÔºö</p>
<ul>
<li>È¶ñÂÖà‰ºöÂà§Êñ≠slaveËäÇÁÇπ‰∏émasterËäÇÁÇπÊñ≠ÂºÄÊó∂Èó¥ÈïøÁü≠ÔºåÂ¶ÇÊûúË∂ÖËøáÊåáÂÆöÂÄºÔºàdown-after-milliseconds * 10ÔºâÂàô‰ºöÊéíÈô§ËØ•slaveËäÇÁÇπ</li>
<li>ÁÑ∂ÂêéÂà§Êñ≠slaveËäÇÁÇπÁöÑslave-priorityÂÄºÔºåË∂äÂ∞è‰ºòÂÖàÁ∫ßË∂äÈ´òÔºåÂ¶ÇÊûúÊòØ0ÂàôÊ∞∏‰∏çÂèÇ‰∏éÈÄâ‰∏æ</li>
<li>Â¶ÇÊûúslave-prority‰∏ÄÊ†∑ÔºåÂàôÂà§Êñ≠slaveËäÇÁÇπÁöÑoffsetÂÄºÔºåË∂äÂ§ßËØ¥ÊòéÊï∞ÊçÆË∂äÊñ∞Ôºå‰ºòÂÖàÁ∫ßË∂äÈ´ò</li>
<li>ÊúÄÂêéÊòØÂà§Êñ≠slaveËäÇÁÇπÁöÑËøêË°åidÂ§ßÂ∞èÔºåË∂äÂ∞è‰ºòÂÖàÁ∫ßË∂äÈ´ò„ÄÇ</li>
</ul>
<h3 id="3-4-Â¶Ç‰ΩïÂÆûÁé∞ÊïÖÈöúËΩ¨Áßª"><a href="#3-4-Â¶Ç‰ΩïÂÆûÁé∞ÊïÖÈöúËΩ¨Áßª" class="headerlink" title="3.4 Â¶Ç‰ΩïÂÆûÁé∞ÊïÖÈöúËΩ¨Áßª"></a>3.4 Â¶Ç‰ΩïÂÆûÁé∞ÊïÖÈöúËΩ¨Áßª</h3><p>ÂΩìÈÄâÂá∫‰∏Ä‰∏™Êñ∞ÁöÑmasterÂêéÔºåËØ•Â¶Ç‰ΩïÂÆûÁé∞ÂàáÊç¢Âë¢Ôºü</p>
<p>ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>sentinelÁªôÂ§áÈÄâÁöÑslave1ËäÇÁÇπÂèëÈÄÅslaveof no oneÂëΩ‰ª§ÔºåËÆ©ËØ•ËäÇÁÇπÊàê‰∏∫master</li>
<li>ÂπøÊí≠ÔºösentinelÁªôÊâÄÊúâÂÖ∂ÂÆÉslaveÂèëÈÄÅslaveof 192.168.150.101 7002 ÂëΩ‰ª§ÔºåËÆ©Ëøô‰∫õslaveÊàê‰∏∫Êñ∞masterÁöÑ‰ªéËäÇÁÇπÔºåÂºÄÂßã‰ªéÊñ∞ÁöÑmaster‰∏äÂêåÊ≠•Êï∞ÊçÆ„ÄÇ</li>
<li>ÊúÄÂêéÔºåsentinelÂ∞ÜÊïÖÈöúËäÇÁÇπÊ†áËÆ∞‰∏∫slaveÔºåÂΩìÊïÖÈöúËäÇÁÇπÊÅ¢Â§çÂêé‰ºöËá™Âä®Êàê‰∏∫Êñ∞ÁöÑmasterÁöÑslaveËäÇÁÇπ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.3.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="3-5-Â∞èÁªì"><a href="#3-5-Â∞èÁªì" class="headerlink" title="3.5 Â∞èÁªì"></a>3.5 Â∞èÁªì</h3><p>SentinelÁöÑ‰∏â‰∏™‰ΩúÁî®ÊòØ‰ªÄ‰πàÔºü</p>
<ul>
<li>ÁõëÊéß</li>
<li>ÊïÖÈöúËΩ¨Áßª</li>
<li>ÈÄöÁü•</li>
</ul>
<p>SentinelÂ¶Ç‰ΩïÂà§Êñ≠‰∏Ä‰∏™redisÂÆû‰æãÊòØÂê¶ÂÅ•Â∫∑Ôºü</p>
<ul>
<li>ÊØèÈöî1ÁßíÂèëÈÄÅ‰∏ÄÊ¨°pingÂëΩ‰ª§ÔºåÂ¶ÇÊûúË∂ÖËøá‰∏ÄÂÆöÊó∂Èó¥Ê≤°ÊúâÁõ∏ÂêëÂàôËÆ§‰∏∫ÊòØ‰∏ªËßÇ‰∏ãÁ∫ø</li>
<li>Â¶ÇÊûúÂ§ßÂ§öÊï∞sentinelÈÉΩËÆ§‰∏∫ÂÆû‰æã‰∏ªËßÇ‰∏ãÁ∫øÔºåÂàôÂà§ÂÆöÊúçÂä°‰∏ãÁ∫ø</li>
</ul>
<p>ÊïÖÈöúËΩ¨ÁßªÊ≠•È™§ÊúâÂì™‰∫õÔºü</p>
<ul>
<li>È¶ñÂÖàÈÄâÂÆö‰∏Ä‰∏™slave‰Ωú‰∏∫Êñ∞ÁöÑmasterÔºåÊâßË°åslaveof no one</li>
<li>ÁÑ∂ÂêéËÆ©ÊâÄÊúâËäÇÁÇπÈÉΩÊâßË°åslaveof Êñ∞master</li>
<li>‰øÆÊîπÊïÖÈöúËäÇÁÇπÈÖçÁΩÆÔºåÊ∑ªÂä†slaveof Êñ∞master</li>
</ul>
<h3 id="3-6-RedisTemplate"><a href="#3-6-RedisTemplate" class="headerlink" title="3.6 RedisTemplate"></a>3.6 RedisTemplate</h3><p>Âú®SentinelÈõÜÁæ§ÁõëÁÆ°‰∏ãÁöÑRedis‰∏ª‰ªéÈõÜÁæ§ÔºåÂÖ∂ËäÇÁÇπ‰ºöÂõ†‰∏∫Ëá™Âä®ÊïÖÈöúËΩ¨ÁßªËÄåÂèëÁîüÂèòÂåñÔºåRedisÁöÑÂÆ¢Êà∑Á´ØÂøÖÈ°ªÊÑüÁü•ËøôÁßçÂèòÂåñÔºåÂèäÊó∂Êõ¥Êñ∞ËøûÊé•‰ø°ÊÅØ„ÄÇSpringÁöÑRedisTemplateÂ∫ïÂ±ÇÂà©Áî®lettuceÂÆûÁé∞‰∫ÜËäÇÁÇπÁöÑÊÑüÁü•ÂíåËá™Âä®ÂàáÊç¢„ÄÇ</p>
<ol>
<li>ÂºïÂÖ•‰æùËµñ<br>Âú®È°πÁõÆÁöÑpomÊñá‰ª∂‰∏≠ÂºïÂÖ•‰æùËµñÔºö</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>ÈÖçÁΩÆRedisÂú∞ÂùÄ<br>ÁÑ∂ÂêéÂú®ÈÖçÁΩÆÊñá‰ª∂application.yml‰∏≠ÊåáÂÆöredisÁöÑsentinelÁõ∏ÂÖ≥‰ø°ÊÅØÔºö</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">spring:<br>  redis:<br>    sentinel:<br>      master: mymaster<br>      nodes:<br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27001</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27002</span><br>        - <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span>:<span class="hljs-number">27003</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ÈÖçÁΩÆËØªÂÜôÂàÜÁ¶ª<br>Âú®È°πÁõÆÁöÑÂêØÂä®Á±ª‰∏≠ÔºåÊ∑ªÂä†‰∏Ä‰∏™Êñ∞ÁöÑbeanÔºö</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> LettuceClientConfigurationBuilderCustomizer <span class="hljs-title function_">clientConfigurationBuilderCustomizer</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> clientConfigurationBuilder -&gt; clientConfigurationBuilder.readFrom(ReadFrom.REPLICA_PREFERRED);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏™bean‰∏≠ÈÖçÁΩÆÁöÑÂ∞±ÊòØËØªÂÜôÁ≠ñÁï•ÔºåÂåÖÊã¨ÂõõÁßçÔºö</p>
<ul>
<li>MASTERÔºö‰ªé‰∏ªËäÇÁÇπËØªÂèñ</li>
<li>MASTER_PREFERREDÔºö‰ºòÂÖà‰ªémasterËäÇÁÇπËØªÂèñÔºåmaster‰∏çÂèØÁî®ÊâçËØªÂèñreplica</li>
<li>REPLICAÔºö‰ªéslaveÔºàreplicaÔºâËäÇÁÇπËØªÂèñ</li>
<li>REPLICA _PREFERREDÔºö‰ºòÂÖà‰ªéslaveÔºàreplicaÔºâËäÇÁÇπËØªÂèñÔºåÊâÄÊúâÁöÑslaveÈÉΩ‰∏çÂèØÁî®ÊâçËØªÂèñmaster</li>
</ul>
<h2 id="4-RedisÂàÜÁâáÈõÜÁæ§"><a href="#4-RedisÂàÜÁâáÈõÜÁæ§" class="headerlink" title="4. RedisÂàÜÁâáÈõÜÁæ§"></a>4. RedisÂàÜÁâáÈõÜÁæ§</h2><h3 id="4-1-ÂàÜÁâáÈõÜÁæ§"><a href="#4-1-ÂàÜÁâáÈõÜÁæ§" class="headerlink" title="4.1 ÂàÜÁâáÈõÜÁæ§"></a>4.1 ÂàÜÁâáÈõÜÁæ§</h3><p>‰∏ª‰ªéÂíåÂì®ÂÖµÂèØ‰ª•Ëß£ÂÜ≥È´òÂèØÁî®„ÄÅÈ´òÂπ∂ÂèëËØªÁöÑÈóÆÈ¢ò„ÄÇ‰ΩÜÊòØ‰æùÁÑ∂Êúâ‰∏§‰∏™ÈóÆÈ¢òÊ≤°ÊúâËß£ÂÜ≥Ôºö</p>
<ul>
<li>Êµ∑ÈáèÊï∞ÊçÆÂ≠òÂÇ®ÈóÆÈ¢ò</li>
<li>È´òÂπ∂ÂèëÂÜôÁöÑÈóÆÈ¢ò</li>
</ul>
<p>‰ΩøÁî®ÂàÜÁâáÈõÜÁæ§ÂèØ‰ª•Ëß£ÂÜ≥‰∏äËø∞ÈóÆÈ¢òÔºåÂàÜÁâáÈõÜÁæ§ÁâπÂæÅÔºö</p>
<ul>
<li>ÈõÜÁæ§‰∏≠ÊúâÂ§ö‰∏™masterÔºåÊØè‰∏™master‰øùÂ≠ò‰∏çÂêåÊï∞ÊçÆ</li>
<li>ÊØè‰∏™masterÈÉΩÂèØ‰ª•ÊúâÂ§ö‰∏™slaveËäÇÁÇπ</li>
<li>master‰πãÈó¥ÈÄöËøápingÁõëÊµãÂΩºÊ≠§ÂÅ•Â∫∑Áä∂ÊÄÅ</li>
<li>ÂÆ¢Êà∑Á´ØËØ∑Ê±ÇÂèØ‰ª•ËÆøÈóÆÈõÜÁæ§‰ªªÊÑèËäÇÁÇπÔºåÊúÄÁªàÈÉΩ‰ºöË¢´ËΩ¨ÂèëÂà∞Ê≠£Á°ÆËäÇÁÇπ</li>
</ul>
<p><img src="/img/blogs/java/redis/3.4.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-2-Êï£ÂàóÊèíÊßΩ"><a href="#4-2-Êï£ÂàóÊèíÊßΩ" class="headerlink" title="4.2 Êï£ÂàóÊèíÊßΩ"></a>4.2 Êï£ÂàóÊèíÊßΩ</h3><p>Redis‰ºöÊääÊØè‰∏Ä‰∏™masterËäÇÁÇπÊò†Â∞ÑÂà∞0~16383ÂÖ±16384‰∏™ÊèíÊßΩÔºàhash slotÔºâ‰∏ä</p>
<p><img src="/img/blogs/java/redis/3.4.2.png" srcset="/img/loading.gif" lazyload></p>
<p>Êï∞ÊçÆkey‰∏çÊòØ‰∏éËäÇÁÇπÁªëÂÆöÔºåËÄåÊòØ‰∏éÊèíÊßΩÁªëÂÆö„ÄÇredis‰ºöÊ†πÊçÆkeyÁöÑÊúâÊïàÈÉ®ÂàÜËÆ°ÁÆóÊèíÊßΩÂÄºÔºåÂàÜ‰∏§ÁßçÊÉÖÂÜµÔºö</p>
<ul>
<li>key‰∏≠ÂåÖÂê´‚Äù{}‚ÄùÔºå‰∏î‚Äú{}‚Äù‰∏≠Ëá≥Â∞ëÂåÖÂê´1‰∏™Â≠óÁ¨¶Ôºå‚Äú{}‚Äù‰∏≠ÁöÑÈÉ®ÂàÜÊòØÊúâÊïàÈÉ®ÂàÜ</li>
<li>key‰∏≠‰∏çÂåÖÂê´‚Äú{}‚ÄùÔºåÊï¥‰∏™keyÈÉΩÊòØÊúâÊïàÈÉ®ÂàÜ</li>
</ul>
<p>‰æãÂ¶ÇÔºökeyÊòØnumÔºåÈÇ£‰πàÂ∞±Ê†πÊçÆnumËÆ°ÁÆóÔºåÂ¶ÇÊûúÊòØ{itcast}numÔºåÂàôÊ†πÊçÆitcastËÆ°ÁÆó„ÄÇËÆ°ÁÆóÊñπÂºèÊòØÂà©Áî®CRC16ÁÆóÊ≥ïÂæóÂà∞‰∏Ä‰∏™hashÂÄºÔºåÁÑ∂ÂêéÂØπ16384Âèñ‰ΩôÔºåÂæóÂà∞ÁöÑÁªìÊûúÂ∞±ÊòØslotÂÄº„ÄÇ</p>
<p>RedisÂ¶Ç‰ΩïÂà§Êñ≠Êüê‰∏™keyÂ∫îËØ•Âú®Âì™‰∏™ÂÆû‰æãÔºü</p>
<ul>
<li>Â∞Ü16384‰∏™ÊèíÊßΩÂàÜÈÖçÂà∞‰∏çÂêåÁöÑÂÆû‰æã</li>
<li>Ê†πÊçÆkeyÁöÑÊúâÊïàÈÉ®ÂàÜËÆ°ÁÆóÂìàÂ∏åÂÄºÔºåÂØπ16384Âèñ‰Ωô</li>
<li>‰ΩôÊï∞‰Ωú‰∏∫ÊèíÊßΩÔºåÂØªÊâæÊèíÊßΩÊâÄÂú®ÂÆû‰æãÂç≥ÂèØ</li>
</ul>
<p>Â¶Ç‰ΩïÂ∞ÜÂêå‰∏ÄÁ±ªÊï∞ÊçÆÂõ∫ÂÆöÁöÑ‰øùÂ≠òÂú®Âêå‰∏Ä‰∏™RedisÂÆû‰æãÔºü</p>
<ul>
<li>Ëøô‰∏ÄÁ±ªÊï∞ÊçÆ‰ΩøÁî®Áõ∏ÂêåÁöÑÊúâÊïàÈÉ®ÂàÜÔºå‰æãÂ¶ÇkeyÈÉΩ‰ª•{typeId}‰∏∫ÂâçÁºÄ</li>
</ul>
<h3 id="4-3-ÈõÜÁæ§‰º∏Áº©"><a href="#4-3-ÈõÜÁæ§‰º∏Áº©" class="headerlink" title="4.3 ÈõÜÁæ§‰º∏Áº©"></a>4.3 ÈõÜÁæ§‰º∏Áº©</h3><p>redis-cli ‚ÄìclusterÊèê‰æõ‰∫ÜÂæàÂ§öÊìç‰ΩúÈõÜÁæ§ÁöÑÂëΩ‰ª§</p>
<ul>
<li>Ê∑ªÂä†ËäÇÁÇπÁöÑÂëΩ‰ª§Ôºö</li>
</ul>
<p><img src="/img/blogs/java/redis/3.4.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-4-ÊïÖÈöúËΩ¨Áßª"><a href="#4-4-ÊïÖÈöúËΩ¨Áßª" class="headerlink" title="4.4 ÊïÖÈöúËΩ¨Áßª"></a>4.4 ÊïÖÈöúËΩ¨Áßª</h3><h4 id="4-4-1-Ëá™Âä®ÊïÖÈöúËΩ¨Áßª"><a href="#4-4-1-Ëá™Âä®ÊïÖÈöúËΩ¨Áßª" class="headerlink" title="4.4.1 Ëá™Âä®ÊïÖÈöúËΩ¨Áßª"></a>4.4.1 Ëá™Âä®ÊïÖÈöúËΩ¨Áßª</h4><p>ÂΩìÈõÜÁæ§‰∏≠Êúâ‰∏Ä‰∏™masterÂÆïÊú∫‰ºöÂèëÁîü‰ªÄ‰πàÂë¢Ôºü</p>
<p>Áõ¥Êé•ÂÅúÊ≠¢‰∏Ä‰∏™redisÂÆû‰æãÔºå‰æãÂ¶Ç7002Ôºö</p>
<ol>
<li>È¶ñÂÖàÊòØËØ•ÂÆû‰æã‰∏éÂÖ∂ÂÆÉÂÆû‰æãÂ§±ÂéªËøûÊé•</li>
<li>ÁÑ∂ÂêéÊòØÁñë‰ººÂÆïÊú∫Ôºö</li>
<li>ÊúÄÂêéÊòØÁ°ÆÂÆö‰∏ãÁ∫øÔºåËá™Âä®ÊèêÂçá‰∏Ä‰∏™slave‰∏∫Êñ∞ÁöÑmaster</li>
<li>ÂΩì7002ÂÜçÊ¨°ÂêØÂä®ÔºåÂ∞±‰ºöÂèò‰∏∫‰∏Ä‰∏™slaveËäÇÁÇπ‰∫Ü</li>
</ol>
<h4 id="4-4-2-ÊâãÂä®ÊïÖÈöúËΩ¨Áßª"><a href="#4-4-2-ÊâãÂä®ÊïÖÈöúËΩ¨Áßª" class="headerlink" title="4.4.2 ÊâãÂä®ÊïÖÈöúËΩ¨Áßª"></a>4.4.2 ÊâãÂä®ÊïÖÈöúËΩ¨Áßª</h4><p>Âà©Áî®cluster failoverÂëΩ‰ª§ÂèØ‰ª•ÊâãÂä®ËÆ©ÈõÜÁæ§‰∏≠ÁöÑÊüê‰∏™masterÂÆïÊú∫ÔºåÂàáÊç¢Âà∞ÊâßË°åcluster failoverÂëΩ‰ª§ÁöÑËøô‰∏™slaveËäÇÁÇπÔºåÂÆûÁé∞Êó†ÊÑüÁü•ÁöÑÊï∞ÊçÆËøÅÁßª„ÄÇ</p>
<h3 id="4-5-RedisTemplateËÆøÈóÆÂàÜÁâáÈõÜÁæ§"><a href="#4-5-RedisTemplateËÆøÈóÆÂàÜÁâáÈõÜÁæ§" class="headerlink" title="4.5 RedisTemplateËÆøÈóÆÂàÜÁâáÈõÜÁæ§"></a>4.5 RedisTemplateËÆøÈóÆÂàÜÁâáÈõÜÁæ§</h3><p>RedisTemplateÂ∫ïÂ±ÇÂêåÊ†∑Âü∫‰∫élettuceÂÆûÁé∞‰∫ÜÂàÜÁâáÈõÜÁæ§ÁöÑÊîØÊåÅÔºåËÄå‰ΩøÁî®ÁöÑÊ≠•È™§‰∏éÂì®ÂÖµÊ®°ÂºèÂü∫Êú¨‰∏ÄËá¥Ôºö</p>
<ol>
<li>ÂºïÂÖ•redisÁöÑstarter‰æùËµñ</li>
<li>ÈÖçÁΩÆÂàÜÁâáÈõÜÁæ§Âú∞ÂùÄ</li>
<li>ÈÖçÁΩÆËØªÂÜôÂàÜÁ¶ª</li>
</ol>
<p>‰∏éÂì®ÂÖµÊ®°ÂºèÁõ∏ÊØîÔºåÂÖ∂‰∏≠Âè™ÊúâÂàÜÁâáÈõÜÁæ§ÁöÑÈÖçÁΩÆÊñπÂºèÁï•ÊúâÂ∑ÆÂºÇÔºåÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">redis:</span><br>    <span class="hljs-attr">cluster:</span><br>      <span class="hljs-attr">nodes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:7003</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8001</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8002</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8003</span><br></code></pre></td></tr></table></figure>


<h2 id="5-Â§öÁ∫ßÁºìÂ≠ò"><a href="#5-Â§öÁ∫ßÁºìÂ≠ò" class="headerlink" title="5. Â§öÁ∫ßÁºìÂ≠ò"></a>5. Â§öÁ∫ßÁºìÂ≠ò</h2><h3 id="5-1-‰ªÄ‰πàÊòØÂ§öÁ∫ßÁºìÂ≠ò"><a href="#5-1-‰ªÄ‰πàÊòØÂ§öÁ∫ßÁºìÂ≠ò" class="headerlink" title="5.1 ‰ªÄ‰πàÊòØÂ§öÁ∫ßÁºìÂ≠ò"></a>5.1 ‰ªÄ‰πàÊòØÂ§öÁ∫ßÁºìÂ≠ò</h3><p><strong>‰º†ÁªüÁöÑÁºìÂ≠ò</strong>Á≠ñÁï•‰∏ÄËà¨ÊòØËØ∑Ê±ÇÂà∞ËææTomcatÂêéÔºåÂÖàÊü•ËØ¢RedisÔºåÂ¶ÇÊûúÊú™ÂëΩ‰∏≠ÂàôÊü•ËØ¢Êï∞ÊçÆÂ∫ì</p>
<ul>
<li>ËØ∑Ê±ÇË¶ÅÁªèËøáTomcatÂ§ÑÁêÜÔºåTomcatÁöÑÊÄßËÉΩÊàê‰∏∫Êï¥‰∏™Á≥ªÁªüÁöÑÁì∂È¢à</li>
<li>RedisÁºìÂ≠òÂ§±ÊïàÊó∂Ôºå‰ºöÂØπÊï∞ÊçÆÂ∫ì‰∫ßÁîüÂÜ≤Âáª</li>
</ul>
<p><img src="/img/blogs/java/redis/3.5.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Â§öÁ∫ßÁºìÂ≠ò</strong>Â∞±ÊòØÂÖÖÂàÜÂà©Áî®ËØ∑Ê±ÇÂ§ÑÁêÜÁöÑÊØè‰∏™ÁéØËäÇÔºåÂàÜÂà´Ê∑ªÂä†ÁºìÂ≠òÔºåÂáèËΩªTomcatÂéãÂäõÔºåÊèêÂçáÊúçÂä°ÊÄßËÉΩÔºö</p>
<ul>
<li>ÊµèËßàÂô®ËÆøÈóÆÈùôÊÄÅËµÑÊ∫êÊó∂Ôºå‰ºòÂÖàËØªÂèñÊµèËßàÂô®Êú¨Âú∞ÁºìÂ≠ò</li>
<li>ËÆøÈóÆÈùûÈùôÊÄÅËµÑÊ∫êÔºàajaxÊü•ËØ¢Êï∞ÊçÆÔºâÊó∂ÔºåËÆøÈóÆÊúçÂä°Á´Ø</li>
<li>ËØ∑Ê±ÇÂà∞ËææNginxÂêéÔºå‰ºòÂÖàËØªÂèñNginxÊú¨Âú∞ÁºìÂ≠ò</li>
<li>Â¶ÇÊûúNginxÊú¨Âú∞ÁºìÂ≠òÊú™ÂëΩ‰∏≠ÔºåÂàôÂéªÁõ¥Êé•Êü•ËØ¢RedisÔºà‰∏çÁªèËøáTomcatÔºâ</li>
<li>Â¶ÇÊûúRedisÊü•ËØ¢Êú™ÂëΩ‰∏≠ÔºåÂàôÊü•ËØ¢Tomcat</li>
<li>ËØ∑Ê±ÇËøõÂÖ•TomcatÂêéÔºå‰ºòÂÖàÊü•ËØ¢JVMËøõÁ®ãÁºìÂ≠ò</li>
<li>Â¶ÇÊûúJVMËøõÁ®ãÁºìÂ≠òÊú™ÂëΩ‰∏≠ÔºåÂàôÊü•ËØ¢Êï∞ÊçÆÂ∫ì</li>
</ul>
<p><img src="/img/blogs/java/redis/3.5.2.png" srcset="/img/loading.gif" lazyload></p>
<p>Â§öÁ∫ßÁºìÂ≠òÁöÑÂÖ≥ÈîÆÊúâ‰∏§‰∏™Ôºö</p>
<ul>
<li>‰∏Ä‰∏™ÊòØÂú®nginx‰∏≠ÁºñÂÜô‰∏öÂä°ÔºåÂÆûÁé∞nginxÊú¨Âú∞ÁºìÂ≠ò„ÄÅRedis„ÄÅTomcatÁöÑÊü•ËØ¢</li>
<li>Âè¶‰∏Ä‰∏™Â∞±ÊòØÂú®Tomcat‰∏≠ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò</li>
</ul>
<h3 id="5-2-JVMËøõÁ®ãÁºìÂ≠ò"><a href="#5-2-JVMËøõÁ®ãÁºìÂ≠ò" class="headerlink" title="5.2 JVMËøõÁ®ãÁºìÂ≠ò"></a>5.2 JVMËøõÁ®ãÁºìÂ≠ò</h3><p><img src="/img/blogs/java/redis/3.5.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="5-2-1-ÂàùËØÜCaffeine"><a href="#5-2-1-ÂàùËØÜCaffeine" class="headerlink" title="5.2.1 ÂàùËØÜCaffeine"></a>5.2.1 ÂàùËØÜCaffeine</h4><p>ÁºìÂ≠òÂú®Êó•Â∏∏ÂºÄÂèë‰∏≠ÂêØÂä®Ëá≥ÂÖ≥ÈáçË¶ÅÁöÑ‰ΩúÁî®ÔºåÁî±‰∫éÊòØÂ≠òÂÇ®Âú®ÂÜÖÂ≠ò‰∏≠ÔºåÊï∞ÊçÆÁöÑËØªÂèñÈÄüÂ∫¶ÊòØÈùûÂ∏∏Âø´ÁöÑÔºåËÉΩÂ§ßÈáèÂáèÂ∞ëÂØπÊï∞ÊçÆÂ∫ìÁöÑËÆøÈóÆÔºåÂáèÂ∞ëÊï∞ÊçÆÂ∫ìÁöÑÂéãÂäõ„ÄÇÊàë‰ª¨ÊääÁºìÂ≠òÂàÜ‰∏∫‰∏§Á±ªÔºö</p>
<ul>
<li>ÂàÜÂ∏ÉÂºèÁºìÂ≠òÔºå‰æãÂ¶ÇRedisÔºö<ul>
<li>‰ºòÁÇπÔºöÂ≠òÂÇ®ÂÆπÈáèÊõ¥Â§ß„ÄÅÂèØÈù†ÊÄßÊõ¥Â•Ω„ÄÅÂèØ‰ª•Âú®ÈõÜÁæ§Èó¥ÂÖ±‰∫´</li>
<li>Áº∫ÁÇπÔºöËÆøÈóÆÁºìÂ≠òÊúâÁΩëÁªúÂºÄÈîÄ</li>
<li>Âú∫ÊôØÔºöÁºìÂ≠òÊï∞ÊçÆÈáèËæÉÂ§ß„ÄÅÂèØÈù†ÊÄßË¶ÅÊ±ÇËæÉÈ´ò„ÄÅÈúÄË¶ÅÂú®ÈõÜÁæ§Èó¥ÂÖ±‰∫´</li>
</ul>
</li>
<li>ËøõÁ®ãÊú¨Âú∞ÁºìÂ≠òÔºå‰æãÂ¶ÇHashMap„ÄÅGuavaCacheÔºö<ul>
<li>‰ºòÁÇπÔºöËØªÂèñÊú¨Âú∞ÂÜÖÂ≠òÔºåÊ≤°ÊúâÁΩëÁªúÂºÄÈîÄÔºåÈÄüÂ∫¶Êõ¥Âø´</li>
<li>Áº∫ÁÇπÔºöÂ≠òÂÇ®ÂÆπÈáèÊúâÈôê„ÄÅÂèØÈù†ÊÄßËæÉ‰Ωé„ÄÅÊó†Ê≥ïÂÖ±‰∫´</li>
<li>Âú∫ÊôØÔºöÊÄßËÉΩË¶ÅÊ±ÇËæÉÈ´òÔºåÁºìÂ≠òÊï∞ÊçÆÈáèËæÉÂ∞è</li>
</ul>
</li>
</ul>
<p>Êàë‰ª¨‰ªäÂ§©‰ºöÂà©Áî®CaffeineÊ°ÜÊû∂Êù•ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò</p>
<p><strong>Caffeine</strong>ÊòØ‰∏Ä‰∏™Âü∫‰∫éJava8ÂºÄÂèëÁöÑÔºåÊèê‰æõ‰∫ÜËøë‰πéÊúÄ‰Ω≥ÂëΩ‰∏≠ÁéáÁöÑÈ´òÊÄßËÉΩÁöÑÊú¨Âú∞ÁºìÂ≠òÂ∫ì„ÄÇÁõÆÂâçSpringÂÜÖÈÉ®ÁöÑÁºìÂ≠ò‰ΩøÁî®ÁöÑÂ∞±ÊòØCaffeine„ÄÇ</p>
<ul>
<li>ÁºìÂ≠ò‰ΩøÁî®ÁöÑÂü∫Êú¨APIÔºö</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testBasicOps</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// ÊûÑÂª∫cacheÂØπË±°</span><br>    Cache&lt;String, String&gt; cache = Caffeine.newBuilder().build();<br><br>    <span class="hljs-comment">// Â≠òÊï∞ÊçÆ</span><br>    cache.put(<span class="hljs-string">&quot;gf&quot;</span>, <span class="hljs-string">&quot;Ëø™‰∏ΩÁÉ≠Â∑¥&quot;</span>);<br><br>    <span class="hljs-comment">// ÂèñÊï∞ÊçÆ</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">gf</span> <span class="hljs-operator">=</span> cache.getIfPresent(<span class="hljs-string">&quot;gf&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;gf = &quot;</span> + gf);<br><br>    <span class="hljs-comment">// ÂèñÊï∞ÊçÆÔºåÂåÖÂê´‰∏§‰∏™ÂèÇÊï∞Ôºö</span><br>    <span class="hljs-comment">// ÂèÇÊï∞‰∏ÄÔºöÁºìÂ≠òÁöÑkey</span><br>    <span class="hljs-comment">// ÂèÇÊï∞‰∫åÔºöLambdaË°®ËææÂºèÔºåË°®ËææÂºèÂèÇÊï∞Â∞±ÊòØÁºìÂ≠òÁöÑkeyÔºåÊñπÊ≥ï‰ΩìÊòØÊü•ËØ¢Êï∞ÊçÆÂ∫ìÁöÑÈÄªËæë</span><br>    <span class="hljs-comment">// ‰ºòÂÖàÊ†πÊçÆkeyÊü•ËØ¢JVMÁºìÂ≠òÔºåÂ¶ÇÊûúÊú™ÂëΩ‰∏≠ÔºåÂàôÊâßË°åÂèÇÊï∞‰∫åÁöÑLambdaË°®ËææÂºè</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">defaultGF</span> <span class="hljs-operator">=</span> cache.get(<span class="hljs-string">&quot;defaultGF&quot;</span>, key -&gt; &#123;<br>        <span class="hljs-comment">// Ê†πÊçÆkeyÂéªÊï∞ÊçÆÂ∫ìÊü•ËØ¢Êï∞ÊçÆ</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Êü≥Â≤©&quot;</span>;<br>    &#125;);<br>    System.out.println(<span class="hljs-string">&quot;defaultGF = &quot;</span> + defaultGF);<br>&#125;<br></code></pre></td></tr></table></figure>


<p>CaffeineÊó¢ÁÑ∂ÊòØÁºìÂ≠òÁöÑ‰∏ÄÁßçÔºåËÇØÂÆöÈúÄË¶ÅÊúâÁºìÂ≠òÁöÑÊ∏ÖÈô§Á≠ñÁï•Ôºå‰∏çÁÑ∂ÁöÑËØùÂÜÖÂ≠òÊÄª‰ºöÊúâËÄóÂ∞ΩÁöÑÊó∂ÂÄô„ÄÇCaffeineÊèê‰æõ‰∫Ü‰∏âÁßçÁºìÂ≠òÈ©±ÈÄêÁ≠ñÁï•Ôºö</p>
<ul>
<li><p><strong>Âü∫‰∫éÂÆπÈáè</strong>ÔºöËÆæÁΩÆÁºìÂ≠òÁöÑÊï∞Èáè‰∏äÈôê</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ÂàõÂª∫ÁºìÂ≠òÂØπË±°</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>    .maximumSize(<span class="hljs-number">1</span>) <span class="hljs-comment">// ËÆæÁΩÆÁºìÂ≠òÂ§ßÂ∞è‰∏äÈôê‰∏∫ 1</span><br>    .build();<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>Âü∫‰∫éÊó∂Èó¥</strong>ÔºöËÆæÁΩÆÁºìÂ≠òÁöÑÊúâÊïàÊó∂Èó¥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ÂàõÂª∫ÁºìÂ≠òÂØπË±°</span><br>Cache&lt;String, String&gt; cache = Caffeine.newBuilder()<br>    <span class="hljs-comment">// ËÆæÁΩÆÁºìÂ≠òÊúâÊïàÊúü‰∏∫ 10 ÁßíÔºå‰ªéÊúÄÂêé‰∏ÄÊ¨°ÂÜôÂÖ•ÂºÄÂßãËÆ°Êó∂ </span><br>    .expireAfterWrite(Duration.ofSeconds(<span class="hljs-number">10</span>)) <br>    .build();<br><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>Âü∫‰∫éÂºïÁî®</strong>ÔºöËÆæÁΩÆÁºìÂ≠ò‰∏∫ËΩØÂºïÁî®ÊàñÂº±ÂºïÁî®ÔºåÂà©Áî®GCÊù•ÂõûÊî∂ÁºìÂ≠òÊï∞ÊçÆ„ÄÇÊÄßËÉΩËæÉÂ∑ÆÔºå‰∏çÂª∫ËÆÆ‰ΩøÁî®„ÄÇ</p>
</li>
</ul>
<p><strong>Ê≥®ÊÑè</strong>ÔºöÂú®ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåÂΩì‰∏Ä‰∏™ÁºìÂ≠òÂÖÉÁ¥†ËøáÊúüÁöÑÊó∂ÂÄôÔºåCaffeine‰∏ç‰ºöËá™Âä®Á´ãÂç≥Â∞ÜÂÖ∂Ê∏ÖÁêÜÂíåÈ©±ÈÄê„ÄÇËÄåÊòØÂú®‰∏ÄÊ¨°ËØªÊàñÂÜôÊìç‰ΩúÂêéÔºåÊàñËÄÖÂú®Á©∫Èó≤Êó∂Èó¥ÂÆåÊàêÂØπÂ§±ÊïàÊï∞ÊçÆÁöÑÈ©±ÈÄê„ÄÇ</p>
<h4 id="5-2-2-ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò"><a href="#5-2-2-ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò" class="headerlink" title="5.2.2 ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò"></a>5.2.2 ÂÆûÁé∞JVMËøõÁ®ãÁºìÂ≠ò</h4><p>Âà©Áî®CaffeineÂÆûÁé∞‰∏ãÂàóÈúÄÊ±ÇÔºö</p>
<ul>
<li>ÁªôÊ†πÊçÆidÊü•ËØ¢ÂïÜÂìÅÁöÑ‰∏öÂä°Ê∑ªÂä†ÁºìÂ≠òÔºåÁºìÂ≠òÊú™ÂëΩ‰∏≠Êó∂Êü•ËØ¢Êï∞ÊçÆÂ∫ì</li>
<li>ÁªôÊ†πÊçÆidÊü•ËØ¢ÂïÜÂìÅÂ∫ìÂ≠òÁöÑ‰∏öÂä°Ê∑ªÂä†ÁºìÂ≠òÔºåÁºìÂ≠òÊú™ÂëΩ‰∏≠Êó∂Êü•ËØ¢Êï∞ÊçÆÂ∫ì</li>
<li>ÁºìÂ≠òÂàùÂßãÂ§ßÂ∞è‰∏∫100</li>
<li>ÁºìÂ≠ò‰∏äÈôê‰∏∫10000</li>
</ul>
<h5 id="ÂÆö‰πâ‰∏§‰∏™CaffeineÁöÑÁºìÂ≠òÂØπË±°ÔºåÂàÜÂà´‰øùÂ≠òÂïÜÂìÅ„ÄÅÂ∫ìÂ≠òÁöÑÁºìÂ≠òÊï∞ÊçÆ„ÄÇ"><a href="#ÂÆö‰πâ‰∏§‰∏™CaffeineÁöÑÁºìÂ≠òÂØπË±°ÔºåÂàÜÂà´‰øùÂ≠òÂïÜÂìÅ„ÄÅÂ∫ìÂ≠òÁöÑÁºìÂ≠òÊï∞ÊçÆ„ÄÇ" class="headerlink" title="ÂÆö‰πâ‰∏§‰∏™CaffeineÁöÑÁºìÂ≠òÂØπË±°ÔºåÂàÜÂà´‰øùÂ≠òÂïÜÂìÅ„ÄÅÂ∫ìÂ≠òÁöÑÁºìÂ≠òÊï∞ÊçÆ„ÄÇ"></a>ÂÆö‰πâ‰∏§‰∏™CaffeineÁöÑÁºìÂ≠òÂØπË±°ÔºåÂàÜÂà´‰øùÂ≠òÂïÜÂìÅ„ÄÅÂ∫ìÂ≠òÁöÑÁºìÂ≠òÊï∞ÊçÆ„ÄÇ</h5><p>Âú®item-serviceÁöÑ<code>com.heima.item.config</code>ÂåÖ‰∏ãÂÆö‰πâ<code>CaffeineConfig</code>Á±ªÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.heima.item.config;<br><br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Cache;<br><span class="hljs-keyword">import</span> com.github.benmanes.caffeine.cache.Caffeine;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.Item;<br><span class="hljs-keyword">import</span> com.heima.item.pojo.ItemStock;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaffeineConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, Item&gt; <span class="hljs-title function_">itemCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Cache&lt;Long, ItemStock&gt; <span class="hljs-title function_">stockCache</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Caffeine.newBuilder()<br>                .initialCapacity(<span class="hljs-number">100</span>)<br>                .maximumSize(<span class="hljs-number">10_000</span>)<br>                .build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="ItemController"><a href="#ItemController" class="headerlink" title="ItemController"></a>ItemController</h5><p>‰øÆÊîπitem-service‰∏≠ÁöÑ<code>com.heima.item.web</code>ÂåÖ‰∏ãÁöÑItemControllerÁ±ªÔºåÊ∑ªÂä†ÁºìÂ≠òÈÄªËæëÔºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping(&quot;item&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, ItemStock&gt; stockCache;<br>    <br>    <span class="hljs-comment">// ...ÂÖ∂ÂÆÉÁï•</span><br>    <br>    <span class="hljs-meta">@GetMapping(&quot;/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> Item <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> itemCache.get(id, key -&gt; itemService.query()<br>                .ne(<span class="hljs-string">&quot;status&quot;</span>, <span class="hljs-number">3</span>).eq(<span class="hljs-string">&quot;id&quot;</span>, key)<br>                .one()<br>        );<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/stock/&#123;id&#125;&quot;)</span><br>    <span class="hljs-keyword">public</span> ItemStock <span class="hljs-title function_">findStockById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;<br>        <span class="hljs-keyword">return</span> stockCache.get(id, key -&gt; stockService.getById(key));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="5-3-LuaËØ≠Ê≥ïÂÖ•Èó®"><a href="#5-3-LuaËØ≠Ê≥ïÂÖ•Èó®" class="headerlink" title="5.3 LuaËØ≠Ê≥ïÂÖ•Èó®"></a>5.3 LuaËØ≠Ê≥ïÂÖ•Èó®</h3><p>NginxÁºñÁ®ãÈúÄË¶ÅÁî®Âà∞LuaËØ≠Ë®Ä</p>
<p><img src="/img/blogs/java/redis/3.5.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="5-3-1-ÂàùËØÜLua"><a href="#5-3-1-ÂàùËØÜLua" class="headerlink" title="5.3.1 ÂàùËØÜLua"></a>5.3.1 ÂàùËØÜLua</h4><p>Lua ÊòØ‰∏ÄÁßçËΩªÈáèÂ∞èÂ∑ßÁöÑËÑöÊú¨ËØ≠Ë®ÄÔºåÁî®Ê†áÂáÜCËØ≠Ë®ÄÁºñÂÜôÂπ∂‰ª•Ê∫ê‰ª£Á†ÅÂΩ¢ÂºèÂºÄÊîæÔºå ÂÖ∂ËÆæËÆ°ÁõÆÁöÑÊòØ‰∏∫‰∫ÜÂµåÂÖ•Â∫îÁî®Á®ãÂ∫è‰∏≠Ôºå‰ªéËÄå‰∏∫Â∫îÁî®Á®ãÂ∫èÊèê‰æõÁÅµÊ¥ªÁöÑÊâ©Â±ïÂíåÂÆöÂà∂ÂäüËÉΩ„ÄÇ</p>
<h4 id="5-3-2-ÂèòÈáèÂíåÂæ™ÁéØ"><a href="#5-3-2-ÂèòÈáèÂíåÂæ™ÁéØ" class="headerlink" title="5.3.2 ÂèòÈáèÂíåÂæ™ÁéØ"></a>5.3.2 ÂèòÈáèÂíåÂæ™ÁéØ</h4><h5 id="LuaÁöÑÊï∞ÊçÆÁ±ªÂûã"><a href="#LuaÁöÑÊï∞ÊçÆÁ±ªÂûã" class="headerlink" title="LuaÁöÑÊï∞ÊçÆÁ±ªÂûã"></a>LuaÁöÑÊï∞ÊçÆÁ±ªÂûã</h5><table>
<thead>
<tr>
<th>Êï∞ÊçÆÁ±ªÂûã</th>
<th>ÊèèËø∞</th>
</tr>
</thead>
<tbody><tr>
<td>nil</td>
<td>Ëøô‰∏™ÊúÄÁÆÄÂçïÔºåÂè™ÊúâÂÄºnilÂ±û‰∫éËØ•Á±ªÔºåË°®Á§∫‰∏Ä‰∏™Êó†ÊïàÂÄºÔºàÂú®Êù°‰ª∂Ë°®ËææÂºè‰∏≠Áõ∏ÂΩì‰∫éfalseÔºâ„ÄÇ</td>
</tr>
<tr>
<td>boolean</td>
<td>ÂåÖÂê´‰∏§‰∏™ÂÄºÔºöfalseÂíåtrue</td>
</tr>
<tr>
<td>number</td>
<td>Ë°®Á§∫ÂèåÁ≤æÂ∫¶Á±ªÂûãÁöÑÂÆûÊµÆÁÇπÊï∞</td>
</tr>
<tr>
<td>string</td>
<td>Â≠óÁ¨¶‰∏≤Áî±‰∏ÄÂØπÂèåÂºïÂè∑ÊàñÂçïÂºïÂè∑Êù•Ë°®Á§∫</td>
</tr>
<tr>
<td>function</td>
<td>Áî± C Êàñ Lua ÁºñÂÜôÁöÑÂáΩÊï∞</td>
</tr>
<tr>
<td>table</td>
<td>Lua ‰∏≠ÁöÑË°®ÔºàtableÔºâÂÖ∂ÂÆûÊòØ‰∏Ä‰∏™‚ÄùÂÖ≥ËÅîÊï∞ÁªÑ‚ÄùÔºàassociative arraysÔºâÔºåÊï∞ÁªÑÁöÑÁ¥¢ÂºïÂèØ‰ª•ÊòØÊï∞Â≠ó„ÄÅÂ≠óÁ¨¶‰∏≤ÊàñË°®Á±ªÂûã„ÄÇÂú® Lua ÈáåÔºåtable ÁöÑÂàõÂª∫ÊòØÈÄöËøá‚ÄùÊûÑÈÄ†Ë°®ËææÂºè‚ÄùÊù•ÂÆåÊàêÔºåÊúÄÁÆÄÂçïÊûÑÈÄ†Ë°®ËææÂºèÊòØ{}ÔºåÁî®Êù•ÂàõÂª∫‰∏Ä‰∏™Á©∫Ë°®„ÄÇ</td>
</tr>
</tbody></table>
<ul>
<li>LuaÊèê‰æõ‰∫Ütype()ÂáΩÊï∞Êù•Âà§Êñ≠‰∏Ä‰∏™ÂèòÈáèÁöÑÊï∞ÊçÆÁ±ªÂûã</li>
</ul>
<h5 id="ÂèòÈáè"><a href="#ÂèòÈáè" class="headerlink" title="ÂèòÈáè"></a>ÂèòÈáè</h5><p>LuaÂ£∞ÊòéÂèòÈáèÁöÑÊó∂ÂÄôÊó†ÈúÄÊåáÂÆöÊï∞ÊçÆÁ±ªÂûãÔºåËÄåÊòØÁî®localÊù•Â£∞ÊòéÂèòÈáè‰∏∫Â±ÄÈÉ®ÂèòÈáèÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Â£∞ÊòéÂ≠óÁ¨¶‰∏≤ÔºåÂèØ‰ª•Áî®ÂçïÂºïÂè∑ÊàñÂèåÂºïÂè∑Ôºå</span><br><span class="hljs-keyword">local</span> str = <span class="hljs-string">&#x27;hello&#x27;</span><br><span class="hljs-comment">-- Â≠óÁ¨¶‰∏≤ÊãºÊé•ÂèØ‰ª•‰ΩøÁî® ..</span><br><span class="hljs-keyword">local</span> str2 = <span class="hljs-string">&#x27;hello&#x27;</span> .. <span class="hljs-string">&#x27;world&#x27;</span><br><span class="hljs-comment">-- Â£∞ÊòéÊï∞Â≠ó</span><br><span class="hljs-keyword">local</span> num = <span class="hljs-number">21</span><br><span class="hljs-comment">-- Â£∞ÊòéÂ∏ÉÂ∞îÁ±ªÂûã</span><br><span class="hljs-keyword">local</span> flag = <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>Lua‰∏≠ÁöÑtableÁ±ªÂûãÊó¢ÂèØ‰ª•‰Ωú‰∏∫Êï∞ÁªÑÔºåÂèàÂèØ‰ª•‰Ωú‰∏∫Java‰∏≠ÁöÑmapÊù•‰ΩøÁî®„ÄÇÊï∞ÁªÑÂ∞±ÊòØÁâπÊÆäÁöÑtableÔºåkeyÊòØÊï∞ÁªÑËßíÊ†áËÄåÂ∑≤Ôºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Â£∞ÊòéÊï∞ÁªÑ Ôºåkey‰∏∫ËßíÊ†áÁöÑ table</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;python&#x27;</span>, <span class="hljs-string">&#x27;lua&#x27;</span>&#125;<br><span class="hljs-comment">-- Â£∞ÊòétableÔºåÁ±ª‰ººjavaÁöÑmap</span><br><span class="hljs-keyword">local</span> map =  &#123;name=<span class="hljs-string">&#x27;Jack&#x27;</span>, age=<span class="hljs-number">21</span>&#125;<br></code></pre></td></tr></table></figure>

<p>Lua‰∏≠ÁöÑÊï∞ÁªÑËßíÊ†áÊòØ‰ªé1ÂºÄÂßãÔºåËÆøÈóÆÁöÑÊó∂ÂÄô‰∏éJava‰∏≠Á±ª‰ººÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ËÆøÈóÆÊï∞ÁªÑÔºåluaÊï∞ÁªÑÁöÑËßíÊ†á‰ªé1ÂºÄÂßã</span><br><span class="hljs-built_in">print</span>(arr[<span class="hljs-number">1</span>])<br></code></pre></td></tr></table></figure>

<p>Lua‰∏≠ÁöÑtableÂèØ‰ª•Áî®keyÊù•ËÆøÈóÆÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ËÆøÈóÆtable</span><br><span class="hljs-built_in">print</span>(map[<span class="hljs-string">&#x27;name&#x27;</span>])<br><span class="hljs-built_in">print</span>(map.name)<br></code></pre></td></tr></table></figure>


<h4 id="5-3-3-Âæ™ÁéØ"><a href="#5-3-3-Âæ™ÁéØ" class="headerlink" title="5.3.3 Âæ™ÁéØ"></a>5.3.3 Âæ™ÁéØ</h4><p>ÂØπ‰∫étableÔºåÊàë‰ª¨ÂèØ‰ª•Âà©Áî®forÂæ™ÁéØÊù•ÈÅçÂéÜ„ÄÇ‰∏çËøáÊï∞ÁªÑÂíåÊôÆÈÄötableÈÅçÂéÜÁï•ÊúâÂ∑ÆÂºÇ„ÄÇ<br>ÈÅçÂéÜÊï∞ÁªÑÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Â£∞ÊòéÊï∞ÁªÑ key‰∏∫Á¥¢ÂºïÁöÑ table</span><br><span class="hljs-keyword">local</span> arr = &#123;<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;python&#x27;</span>, <span class="hljs-string">&#x27;lua&#x27;</span>&#125;<br><span class="hljs-comment">-- ÈÅçÂéÜÊï∞ÁªÑ</span><br><span class="hljs-keyword">for</span> index,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">print</span>(index, value) <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>ÈÅçÂéÜÊôÆÈÄötable</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Â£∞ÊòémapÔºå‰πüÂ∞±ÊòØtable</span><br><span class="hljs-keyword">local</span> map = &#123;name=<span class="hljs-string">&#x27;Jack&#x27;</span>, age=<span class="hljs-number">21</span>&#125;<br><span class="hljs-comment">-- ÈÅçÂéÜtable</span><br><span class="hljs-keyword">for</span> key,value <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(map) <span class="hljs-keyword">do</span><br>   <span class="hljs-built_in">print</span>(key, value) <br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-4-ÂáΩÊï∞"><a href="#5-3-4-ÂáΩÊï∞" class="headerlink" title="5.3.4 ÂáΩÊï∞"></a>5.3.4 ÂáΩÊï∞</h4><p>ÂÆö‰πâÂáΩÊï∞ÁöÑËØ≠Ê≥ïÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> ÂáΩÊï∞Âêç<span class="hljs-params">( argument1, argument2..., argumentn)</span></span><br>    <span class="hljs-comment">-- ÂáΩÊï∞‰Ωì</span><br>    <span class="hljs-keyword">return</span> ËøîÂõûÂÄº<br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<p>‰æãÂ¶ÇÔºåÂÆö‰πâ‰∏Ä‰∏™ÂáΩÊï∞ÔºåÁî®Êù•ÊâìÂç∞Êï∞ÁªÑÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">for</span> index, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-5-Êù°‰ª∂ÊéßÂà∂"><a href="#5-3-5-Êù°‰ª∂ÊéßÂà∂" class="headerlink" title="5.3.5 Êù°‰ª∂ÊéßÂà∂"></a>5.3.5 Êù°‰ª∂ÊéßÂà∂</h4><p>Á±ª‰ººJavaÁöÑÊù°‰ª∂ÊéßÂà∂Ôºå‰æãÂ¶Çif„ÄÅelseËØ≠Ê≥ïÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span>(Â∏ÉÂ∞îË°®ËææÂºè)<br><span class="hljs-keyword">then</span><br>   <span class="hljs-comment">--[ Â∏ÉÂ∞îË°®ËææÂºè‰∏∫ true Êó∂ÊâßË°åËØ•ËØ≠Âè•Âùó --]</span><br><span class="hljs-keyword">else</span><br>   <span class="hljs-comment">--[ Â∏ÉÂ∞îË°®ËææÂºè‰∏∫ false Êó∂ÊâßË°åËØ•ËØ≠Âè•Âùó --]</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h4 id="5-3-6-Ê°à‰æã"><a href="#5-3-6-Ê°à‰æã" class="headerlink" title="5.3.6 Ê°à‰æã"></a>5.3.6 Ê°à‰æã</h4><p>ÈúÄÊ±ÇÔºöËá™ÂÆö‰πâ‰∏Ä‰∏™ÂáΩÊï∞ÔºåÂèØ‰ª•ÊâìÂç∞tableÔºåÂΩìÂèÇÊï∞‰∏∫nilÊó∂ÔºåÊâìÂç∞ÈîôËØØ‰ø°ÊÅØ</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printArr</span><span class="hljs-params">(arr)</span></span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> arr <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;Êï∞ÁªÑ‰∏çËÉΩ‰∏∫Á©∫ÔºÅ&#x27;</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">for</span> index, value <span class="hljs-keyword">in</span> <span class="hljs-built_in">ipairs</span>(arr) <span class="hljs-keyword">do</span><br>        <span class="hljs-built_in">print</span>(value)<br>    <span class="hljs-keyword">end</span><br><span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure>

<h2 id="6-ÂÆûÁé∞Â§öÁ∫ßÁºìÂ≠ò"><a href="#6-ÂÆûÁé∞Â§öÁ∫ßÁºìÂ≠ò" class="headerlink" title="6. ÂÆûÁé∞Â§öÁ∫ßÁºìÂ≠ò"></a>6. ÂÆûÁé∞Â§öÁ∫ßÁºìÂ≠ò</h2><h3 id="6-1-OpenResty"><a href="#6-1-OpenResty" class="headerlink" title="6.1 OpenResty"></a>6.1 OpenResty</h3><p>Â§öÁ∫ßÁºìÂ≠òÁöÑÂÆûÁé∞Á¶ª‰∏çÂºÄNginxÁºñÁ®ãÔºåËÄåNginxÁºñÁ®ãÂèàÁ¶ª‰∏çÂºÄOpenResty</p>
<p>OpenResty¬Æ ÊòØ‰∏Ä‰∏™Âü∫‰∫é NginxÁöÑÈ´òÊÄßËÉΩ Web Âπ≥Âè∞ÔºåÁî®‰∫éÊñπ‰æøÂú∞Êê≠Âª∫ËÉΩÂ§üÂ§ÑÁêÜË∂ÖÈ´òÂπ∂Âèë„ÄÅÊâ©Â±ïÊÄßÊûÅÈ´òÁöÑÂä®ÊÄÅ Web Â∫îÁî®„ÄÅWeb ÊúçÂä°ÂíåÂä®ÊÄÅÁΩëÂÖ≥„ÄÇÂÖ∑Â§á‰∏ãÂàóÁâπÁÇπÔºö</p>
<ul>
<li>ÂÖ∑Â§áNginxÁöÑÂÆåÊï¥ÂäüËÉΩ</li>
<li>Âü∫‰∫éLuaËØ≠Ë®ÄËøõË°åÊâ©Â±ïÔºåÈõÜÊàê‰∫ÜÂ§ßÈáèÁ≤æËâØÁöÑ Lua Â∫ì„ÄÅÁ¨¨‰∏âÊñπÊ®°Âùó</li>
<li>ÂÖÅËÆ∏‰ΩøÁî®Lua<strong>Ëá™ÂÆö‰πâ‰∏öÂä°ÈÄªËæë</strong>„ÄÅ<strong>Ëá™ÂÆö‰πâÂ∫ì</strong></li>
</ul>
<h3 id="6-2-OpenRestyÂø´ÈÄüÂÖ•Èó®"><a href="#6-2-OpenRestyÂø´ÈÄüÂÖ•Èó®" class="headerlink" title="6.2 OpenRestyÂø´ÈÄüÂÖ•Èó®"></a>6.2 OpenRestyÂø´ÈÄüÂÖ•Èó®</h3><p>OpenRestyÁõëÂê¨ËØ∑Ê±Ç<br>OpenRestyÁöÑÂæàÂ§öÂäüËÉΩÈÉΩ‰æùËµñ‰∫éÂÖ∂ÁõÆÂΩï‰∏ãÁöÑLuaÂ∫ìÔºåÈúÄË¶ÅÂú®nginx.conf‰∏≠ÊåáÂÆö‰æùËµñÂ∫ìÁöÑÁõÆÂΩïÔºåÂπ∂ÂØºÂÖ•‰æùËµñÔºö</p>
<ol>
<li>Ê∑ªÂä†ÂØπOpenRestyÁöÑLuaÊ®°ÂùóÁöÑÂä†ËΩΩ<br>‰øÆÊîπ<code>/usr/local/openresty/nginx/conf/nginx.conf</code>Êñá‰ª∂ÔºåÂú®ÂÖ∂‰∏≠ÁöÑhttp‰∏ãÈù¢ÔºåÊ∑ªÂä†‰∏ãÈù¢‰ª£Á†ÅÔºö</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment">#lua Ê®°Âùó</span><br><span class="hljs-attribute">lua_package_path</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.lua;;&quot;</span>;<br><span class="hljs-comment">#cÊ®°Âùó     </span><br><span class="hljs-attribute">lua_package_cpath</span> <span class="hljs-string">&quot;/usr/local/openresty/lualib/?.so;;&quot;</span>;  <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>ÁõëÂê¨&#x2F;api&#x2F;itemË∑ØÂæÑ<br>‰øÆÊîπ<code>/usr/local/openresty/nginx/conf/nginx.conf</code>Êñá‰ª∂ÔºåÂú®nginx.confÁöÑserver‰∏ãÈù¢ÔºåÊ∑ªÂä†ÂØπ&#x2F;api&#x2F;itemËøô‰∏™Ë∑ØÂæÑÁöÑÁõëÂê¨Ôºö</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span>  /api/item &#123;<br>    <span class="hljs-comment"># ÈªòËÆ§ÁöÑÂìçÂ∫îÁ±ªÂûã</span><br>    <span class="hljs-attribute">default_type</span> application/json;<br>    <span class="hljs-comment"># ÂìçÂ∫îÁªìÊûúÁî±lua/item.luaÊñá‰ª∂Êù•ÂÜ≥ÂÆö</span><br>    <span class="hljs-attribute">content_by_lua_file</span> lua/item.lua;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Ëøô‰∏™ÁõëÂê¨ÔºåÂ∞±Á±ª‰ºº‰∫éSpringMVC‰∏≠ÁöÑ<code>@GetMapping(&quot;/api/item&quot;)</code>ÂÅöË∑ØÂæÑÊò†Â∞Ñ„ÄÇ<br>ËÄå<code>content_by_lua_file lua/item.lua</code>ÂàôÁõ∏ÂΩì‰∫éË∞ÉÁî®item.luaËøô‰∏™Êñá‰ª∂ÔºåÊâßË°åÂÖ∂‰∏≠ÁöÑ‰∏öÂä°ÔºåÊääÁªìÊûúËøîÂõûÁªôÁî®Êà∑„ÄÇÁõ∏ÂΩì‰∫éjava‰∏≠Ë∞ÉÁî®service„ÄÇ</p>
<ol start="3">
<li>ÁºñÂÜôitem.luaÔºåËøîÂõûÂÅáÊï∞ÊçÆ<br>item.lua‰∏≠ÔºåÂà©Áî®ngx.say()ÂáΩÊï∞ËøîÂõûÊï∞ÊçÆÂà∞Response‰∏≠</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">ngx.say(<span class="hljs-string">&#x27;&#123;&quot;id&quot;:10001,&quot;name&quot;:&quot;SALSA AIR&quot;,&quot;title&quot;:&quot;RIMOWA 21ÂØ∏ÊâòËøêÁÆ±ÊãâÊùÜÁÆ± SALSA AIRÁ≥ªÂàóÊûúÁªøËâ≤ 820.70.36.4&quot;,&quot;price&quot;:17900,&quot;image&quot;:&quot;https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp&quot;,&quot;category&quot;:&quot;ÊãâÊùÜÁÆ±&quot;,&quot;brand&quot;:&quot;RIMOWA&quot;,&quot;spec&quot;:&quot;&quot;,&quot;status&quot;:1,&quot;createTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;updateTime&quot;:&quot;2019-04-30T16:00:00.000+00:00&quot;,&quot;stock&quot;:2999,&quot;sold&quot;:31290&#125;&#x27;</span>)<br></code></pre></td></tr></table></figure>


<h3 id="6-3-ËØ∑Ê±ÇÂèÇÊï∞Â§ÑÁêÜ"><a href="#6-3-ËØ∑Ê±ÇÂèÇÊï∞Â§ÑÁêÜ" class="headerlink" title="6.3 ËØ∑Ê±ÇÂèÇÊï∞Â§ÑÁêÜ"></a>6.3 ËØ∑Ê±ÇÂèÇÊï∞Â§ÑÁêÜ</h3><p>Ë¶ÅËøîÂõûÁúüÂÆûÊï∞ÊçÆÔºåÂøÖÈ°ªÊ†πÊçÆÂâçÁ´Ø‰º†ÈÄíÊù•ÁöÑÂïÜÂìÅidÔºåÊü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØÊâçÂèØ‰ª•„ÄÇÈÇ£‰πàÂ¶Ç‰ΩïËé∑ÂèñÂâçÁ´Ø‰º†ÈÄíÁöÑÂïÜÂìÅÂèÇÊï∞Âë¢Ôºü</p>
<ul>
<li>OpenResty‰∏≠Êèê‰æõ‰∫Ü‰∏Ä‰∫õAPIÁî®Êù•Ëé∑Âèñ‰∏çÂêåÁ±ªÂûãÁöÑÂâçÁ´ØËØ∑Ê±ÇÂèÇÊï∞Ôºö</li>
</ul>
<table>
<thead>
<tr>
<th>ÂèÇÊï∞Ê†ºÂºè</th>
<th>ÂèÇÊï∞Á§∫‰æã</th>
<th>ÂèÇÊï∞Ëß£Êûê‰ª£Á†ÅÁ§∫‰æã</th>
</tr>
</thead>
<tbody><tr>
<td>Ë∑ØÂæÑÂç†‰ΩçÁ¨¶</td>
<td><code>/item/1001</code></td>
<td>‚Äì1.Ê≠£ÂàôË°®ËææÂºèÂåπÈÖç:<br>location ~ &#x2F;item&#x2F;(\d+) {<br>    content_by_lua_file lua&#x2F;item.lua;<br>}<br>‚Äì 2. ÂåπÈÖçÂà∞ÁöÑÂèÇÊï∞‰ºöÂ≠òÂÖ•ngx.varÊï∞ÁªÑ‰∏≠Ôºå<br>‚Äì ÂèØ‰ª•Áî®ËßíÊ†áËé∑Âèñ<br>local id &#x3D; ngx.var[1]</td>
</tr>
<tr>
<td>ËØ∑Ê±ÇÂ§¥</td>
<td><code>id: 1001</code></td>
<td>‚Äì Ëé∑ÂèñËØ∑Ê±ÇÂ§¥ÔºåËøîÂõûÂÄºÊòØtableÁ±ªÂûã<br>local headers &#x3D; ngx.req.get_headers()</td>
</tr>
<tr>
<td>GetËØ∑Ê±ÇÂèÇÊï∞</td>
<td><code>?id=1001</code></td>
<td>‚Äì Ëé∑ÂèñGETËØ∑Ê±ÇÂèÇÊï∞ÔºåËøîÂõûÂÄºÊòØtableÁ±ªÂûã<br>local getParams &#x3D; ngx.req.get_url_args()</td>
</tr>
<tr>
<td>PostË°®ÂçïÂèÇÊï∞</td>
<td><code>id=1001</code></td>
<td>‚Äì ËØªÂèñËØ∑Ê±Ç‰Ωì<br>ngx.req.read_body()<br>‚Äì Ëé∑ÂèñPOSTË°®ÂçïÂèÇÊï∞ÔºåËøîÂõûÂÄºÊòØtableÁ±ªÂûã<br>local postParams &#x3D; ngx.req.get_post_args()</td>
</tr>
<tr>
<td>JSONÂèÇÊï∞</td>
<td><code>{&quot;id&quot;: 1001}</code></td>
<td>‚Äì ËØªÂèñËØ∑Ê±Ç‰Ωì<br>ngx.req.read_body()<br>‚Äì Ëé∑Âèñbody‰∏≠ÁöÑjsonÂèÇÊï∞ÔºåËøîÂõûÂÄºÊòØstringÁ±ªÂûã<br>local jsonBody &#x3D; ngx.req.get_body_data()</td>
</tr>
</tbody></table>
<h3 id="6-4-Êü•ËØ¢Tomcat"><a href="#6-4-Êü•ËØ¢Tomcat" class="headerlink" title="6.4 Êü•ËØ¢Tomcat"></a>6.4 Êü•ËØ¢Tomcat</h3><p>ÊãøÂà∞ÂïÜÂìÅIDÂêéÔºåÊú¨Â∫îÂéªÁºìÂ≠ò‰∏≠Êü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØÔºå‰∏çËøáÁõÆÂâçÊàë‰ª¨ËøòÊú™Âª∫Á´ãnginx„ÄÅredisÁºìÂ≠ò„ÄÇÂõ†Ê≠§ÔºåËøôÈáåÊàë‰ª¨ÂÖàÊ†πÊçÆÂïÜÂìÅidÂéªtomcatÊü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØ</p>
<p><img src="/img/blogs/java/redis/3.6.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="6-4-1-ÂèëÈÄÅhttpËØ∑Ê±ÇÁöÑAPI"><a href="#6-4-1-ÂèëÈÄÅhttpËØ∑Ê±ÇÁöÑAPI" class="headerlink" title="6.4.1 ÂèëÈÄÅhttpËØ∑Ê±ÇÁöÑAPI"></a>6.4.1 ÂèëÈÄÅhttpËØ∑Ê±ÇÁöÑAPI</h4><p>nginxÊèê‰æõ‰∫ÜÂÜÖÈÉ®APIÁî®‰ª•ÂèëÈÄÅhttpËØ∑Ê±ÇÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-string">&quot;/path&quot;</span>,&#123;<br>    method = ngx.HTTP_GET,   <span class="hljs-comment">-- ËØ∑Ê±ÇÊñπÂºè</span><br>    args = &#123;a=<span class="hljs-number">1</span>,b=<span class="hljs-number">2</span>&#125;,  <span class="hljs-comment">-- getÊñπÂºè‰º†ÂèÇÊï∞</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<p>ËøîÂõûÁöÑÂìçÂ∫îÂÜÖÂÆπÂåÖÊã¨Ôºö</p>
<ul>
<li>resp.statusÔºöÂìçÂ∫îÁä∂ÊÄÅÁ†Å</li>
<li>resp.headerÔºöÂìçÂ∫îÂ§¥ÔºåÊòØ‰∏Ä‰∏™table</li>
<li>resp.bodyÔºöÂìçÂ∫î‰ΩìÔºåÂ∞±ÊòØÂìçÂ∫îÊï∞ÊçÆ</li>
</ul>
<h4 id="6-4-2-Â∞ÅË£ÖHTTPÊü•ËØ¢ÂáΩÊï∞"><a href="#6-4-2-Â∞ÅË£ÖHTTPÊü•ËØ¢ÂáΩÊï∞" class="headerlink" title="6.4.2 Â∞ÅË£ÖHTTPÊü•ËØ¢ÂáΩÊï∞"></a>6.4.2 Â∞ÅË£ÖHTTPÊü•ËØ¢ÂáΩÊï∞</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Â∞ÅË£ÖÂáΩÊï∞ÔºåÂèëÈÄÅhttpËØ∑Ê±ÇÔºåÂπ∂Ëß£ÊûêÂìçÂ∫î</span><br><span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_http</span><span class="hljs-params">(path, params)</span></span><br>    <span class="hljs-keyword">local</span> resp = ngx.location.capture(<span class="hljs-built_in">path</span>,&#123;<br>        method = ngx.HTTP_GET,<br>        args = params,<br>    &#125;)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> resp <span class="hljs-keyword">then</span><br>        <span class="hljs-comment">-- ËÆ∞ÂΩïÈîôËØØ‰ø°ÊÅØÔºåËøîÂõû404</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;httpËØ∑Ê±ÇÊü•ËØ¢Â§±Ë¥•, path: &quot;</span>, <span class="hljs-built_in">path</span> , <span class="hljs-string">&quot;, args: &quot;</span>, args)<br>        ngx.<span class="hljs-built_in">exit</span>(<span class="hljs-number">404</span>)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">return</span> resp.body<br><span class="hljs-keyword">end</span><br><span class="hljs-comment">-- Â∞ÜÊñπÊ≥ïÂØºÂá∫</span><br><span class="hljs-keyword">local</span> _M = &#123;  <br>    read_http = read_http<br>&#125;  <br><span class="hljs-keyword">return</span> _M<br></code></pre></td></tr></table></figure>

<h4 id="6-4-3-ÂÆûÁé∞ÂïÜÂìÅÊü•ËØ¢"><a href="#6-4-3-ÂÆûÁé∞ÂïÜÂìÅÊü•ËØ¢" class="headerlink" title="6.4.3 ÂÆûÁé∞ÂïÜÂìÅÊü•ËØ¢"></a>6.4.3 ÂÆûÁé∞ÂïÜÂìÅÊü•ËØ¢</h4><p>ÊúÄÂêéÔºåÊàë‰ª¨‰øÆÊîπ<code>/usr/local/openresty/lua/item.lua</code>Êñá‰ª∂ÔºåÂà©Áî®ÂàöÂàöÂ∞ÅË£ÖÁöÑÂáΩÊï∞Â∫ìÂÆûÁé∞ÂØπtomcatÁöÑÊü•ËØ¢Ôºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ÂºïÂÖ•Ëá™ÂÆö‰πâcommonÂ∑•ÂÖ∑Ê®°ÂùóÔºåËøîÂõûÂÄºÊòØcommon‰∏≠ËøîÂõûÁöÑ _M</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;common&quot;</span>)<br><span class="hljs-comment">-- ‰ªé common‰∏≠Ëé∑Âèñread_httpËøô‰∏™ÂáΩÊï∞</span><br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-comment">-- Ëé∑ÂèñË∑ØÂæÑÂèÇÊï∞</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- Ê†πÊçÆidÊü•ËØ¢ÂïÜÂìÅ</span><br><span class="hljs-keyword">local</span> itemJSON = read_http(<span class="hljs-string">&quot;/item/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- Ê†πÊçÆidÊü•ËØ¢ÂïÜÂìÅÂ∫ìÂ≠ò</span><br><span class="hljs-keyword">local</span> itemStockJSON = read_http(<span class="hljs-string">&quot;/item/stock/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br></code></pre></td></tr></table></figure>

<h4 id="6-4-4-CJSONÂ∑•ÂÖ∑Á±ª"><a href="#6-4-4-CJSONÂ∑•ÂÖ∑Á±ª" class="headerlink" title="6.4.4 CJSONÂ∑•ÂÖ∑Á±ª"></a>6.4.4 CJSONÂ∑•ÂÖ∑Á±ª</h4><p>OpenRestyÊèê‰æõ‰∫Ü‰∏Ä‰∏™cjsonÁöÑÊ®°ÂùóÁî®Êù•Â§ÑÁêÜJSONÁöÑÂ∫èÂàóÂåñÂíåÂèçÂ∫èÂàóÂåñ„ÄÇ</p>
<ol>
<li>ÂºïÂÖ•cjsonÊ®°ÂùóÔºö</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span> <span class="hljs-string">&quot;cjson&quot;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>Â∫èÂàóÂåñÔºö</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> obj = &#123;<br>    name = <span class="hljs-string">&#x27;jack&#x27;</span>,<br>    age = <span class="hljs-number">21</span><br>&#125;<br><span class="hljs-comment">-- Êää table Â∫èÂàóÂåñ‰∏∫ json</span><br><span class="hljs-keyword">local</span> json = cjson.encode(obj)<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ÂèçÂ∫èÂàóÂåñÔºö</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">local</span> json = <span class="hljs-string">&#x27;&#123;&quot;name&quot;: &quot;jack&quot;, &quot;age&quot;: 21&#125;&#x27;</span><br><span class="hljs-comment">-- ÂèçÂ∫èÂàóÂåñ json‰∏∫ table</span><br><span class="hljs-keyword">local</span> obj = cjson.decode(json);<br><span class="hljs-built_in">print</span>(obj.name)<br></code></pre></td></tr></table></figure>


<h4 id="6-4-5-ÂÆûÁé∞TomcatÊü•ËØ¢"><a href="#6-4-5-ÂÆûÁé∞TomcatÊü•ËØ¢" class="headerlink" title="6.4.5 ÂÆûÁé∞TomcatÊü•ËØ¢"></a>6.4.5 ÂÆûÁé∞TomcatÊü•ËØ¢</h4><p>‰∏ãÈù¢ÔºåÊàë‰ª¨‰øÆÊîπ‰πãÂâçÁöÑitem.lua‰∏≠ÁöÑ‰∏öÂä°ÔºåÊ∑ªÂä†jsonÂ§ÑÁêÜÂäüËÉΩÔºö</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ÂØºÂÖ•commonÂáΩÊï∞Â∫ì</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-comment">-- ÂØºÂÖ•cjsonÂ∫ì</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><span class="hljs-comment">-- Ëé∑ÂèñË∑ØÂæÑÂèÇÊï∞</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><span class="hljs-comment">-- Ê†πÊçÆidÊü•ËØ¢ÂïÜÂìÅ</span><br><span class="hljs-keyword">local</span> itemJSON = read_http(<span class="hljs-string">&quot;/item/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- Ê†πÊçÆidÊü•ËØ¢ÂïÜÂìÅÂ∫ìÂ≠ò</span><br><span class="hljs-keyword">local</span> itemStockJSON = read_http(<span class="hljs-string">&quot;/item/stock/&quot;</span>.. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONËΩ¨Âåñ‰∏∫luaÁöÑtable</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><br><span class="hljs-comment">-- ÁªÑÂêàÊï∞ÊçÆ</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- ÊääitemÂ∫èÂàóÂåñ‰∏∫json ËøîÂõûÁªìÊûú</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>


<h4 id="6-4-6-Âü∫‰∫éIDË¥üËΩΩÂùáË°°"><a href="#6-4-6-Âü∫‰∫éIDË¥üËΩΩÂùáË°°" class="headerlink" title="6.4.6 Âü∫‰∫éIDË¥üËΩΩÂùáË°°"></a>6.4.6 Âü∫‰∫éIDË¥üËΩΩÂùáË°°</h4><p>Êàë‰ª¨ÁöÑtomcatÊòØÂçïÊú∫ÈÉ®ÁΩ≤„ÄÇËÄåÂÆûÈôÖÂºÄÂèë‰∏≠Ôºåtomcat‰∏ÄÂÆöÊòØÈõÜÁæ§Ê®°Âºè</p>
<p><img src="/img/blogs/java/redis/3.6.2.png" srcset="/img/loading.gif" lazyload></p>
<p>OpenRestyÈúÄË¶ÅÂØπtomcatÈõÜÁæ§ÂÅöË¥üËΩΩÂùáË°°„ÄÇ</p>
<p>ËÄåÈªòËÆ§ÁöÑË¥üËΩΩÂùáË°°ËßÑÂàôÊòØËΩÆËØ¢Ê®°ÂºèÔºåÂΩìÊàë‰ª¨Êü•ËØ¢&#x2F;item&#x2F;10001Êó∂Ôºö</p>
<ul>
<li>Á¨¨‰∏ÄÊ¨°‰ºöËÆøÈóÆ8081Á´ØÂè£ÁöÑtomcatÊúçÂä°ÔºåÂú®ËØ•ÊúçÂä°ÂÜÖÈÉ®Â∞±ÂΩ¢Êàê‰∫ÜJVMËøõÁ®ãÁºìÂ≠ò</li>
<li>Á¨¨‰∫åÊ¨°‰ºöËÆøÈóÆ8082Á´ØÂè£ÁöÑtomcatÊúçÂä°ÔºåËØ•ÊúçÂä°ÂÜÖÈÉ®Ê≤°ÊúâJVMÁºìÂ≠òÔºàÂõ†‰∏∫JVMÁºìÂ≠òÊó†Ê≥ïÂÖ±‰∫´ÔºâÔºå‰ºöÊü•ËØ¢Êï∞ÊçÆÂ∫ì</li>
</ul>
<h5 id="Ëß£ÂÜ≥ÊñπÊ°à"><a href="#Ëß£ÂÜ≥ÊñπÊ°à" class="headerlink" title="Ëß£ÂÜ≥ÊñπÊ°à"></a>Ëß£ÂÜ≥ÊñπÊ°à</h5><p>‰øÆÊîπ<code>/usr/local/openresty/nginx/conf/nginx.conf</code>Êñá‰ª∂ÔºåÂÆûÁé∞Âü∫‰∫éIDÂÅöË¥üËΩΩÂùáË°°„ÄÇ<br>È¶ñÂÖàÔºåÂÆö‰πâtomcatÈõÜÁæ§ÔºåÂπ∂ËÆæÁΩÆÂü∫‰∫éË∑ØÂæÑÂÅöË¥üËΩΩÂùáË°°Ôºö</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">upstream</span> tomcat-cluster &#123;<br>    <span class="hljs-attribute">hash</span> <span class="hljs-variable">$request_uri</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.150.1:8081</span>;<br>    <span class="hljs-attribute">server</span> <span class="hljs-number">192.168.150.1:8082</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ÁÑ∂ÂêéÔºå‰øÆÊîπÂØπtomcatÊúçÂä°ÁöÑÂèçÂêë‰ª£ÁêÜÔºåÁõÆÊ†áÊåáÂêëtomcatÈõÜÁæ§Ôºö</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">location</span> /item &#123;<br>    <span class="hljs-attribute">proxy_pass</span> http://tomcat-cluster;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="6-5-RedisÁºìÂ≠òÈ¢ÑÁÉ≠"><a href="#6-5-RedisÁºìÂ≠òÈ¢ÑÁÉ≠" class="headerlink" title="6.5 RedisÁºìÂ≠òÈ¢ÑÁÉ≠"></a>6.5 RedisÁºìÂ≠òÈ¢ÑÁÉ≠</h3><p><img src="/img/blogs/java/redis/3.6.3.png" srcset="/img/loading.gif" lazyload></p>
<p>RedisÁºìÂ≠ò‰ºöÈù¢‰∏¥ÂÜ∑ÂêØÂä®ÈóÆÈ¢òÔºö</p>
<ul>
<li><strong>ÂÜ∑ÂêØÂä®</strong>ÔºöÊúçÂä°ÂàöÂàöÂêØÂä®Êó∂ÔºåRedis‰∏≠Âπ∂Ê≤°ÊúâÁºìÂ≠òÔºåÂ¶ÇÊûúÊâÄÊúâÂïÜÂìÅÊï∞ÊçÆÈÉΩÂú®Á¨¨‰∏ÄÊ¨°Êü•ËØ¢Êó∂Ê∑ªÂä†ÁºìÂ≠òÔºåÂèØËÉΩ‰ºöÁªôÊï∞ÊçÆÂ∫ìÂ∏¶Êù•ËæÉÂ§ßÂéãÂäõ„ÄÇ</li>
<li><strong>ÁºìÂ≠òÈ¢ÑÁÉ≠</strong>ÔºöÂú®ÂÆûÈôÖÂºÄÂèë‰∏≠ÔºåÊàë‰ª¨ÂèØ‰ª•Âà©Áî®Â§ßÊï∞ÊçÆÁªüËÆ°Áî®Êà∑ËÆøÈóÆÁöÑÁÉ≠ÁÇπÊï∞ÊçÆÔºåÂú®È°πÁõÆÂêØÂä®Êó∂Â∞ÜËøô‰∫õÁÉ≠ÁÇπÊï∞ÊçÆÊèêÂâçÊü•ËØ¢Âπ∂‰øùÂ≠òÂà∞Redis‰∏≠„ÄÇ</li>
<li>Êàë‰ª¨Êï∞ÊçÆÈáèËæÉÂ∞ëÔºåÂπ∂‰∏îÊ≤°ÊúâÊï∞ÊçÆÁªüËÆ°Áõ∏ÂÖ≥ÂäüËÉΩÔºåÁõÆÂâçÂèØ‰ª•Âú®ÂêØÂä®Êó∂Â∞ÜÊâÄÊúâÊï∞ÊçÆÈÉΩÊîæÂÖ•ÁºìÂ≠ò‰∏≠„ÄÇ</li>
</ul>
<p>ÁºìÂ≠òÈ¢ÑÁÉ≠ÈúÄË¶ÅÂú®È°πÁõÆÂêØÂä®Êó∂ÂÆåÊàêÔºåÂπ∂‰∏îÂøÖÈ°ªÊòØÊãøÂà∞RedisTemplate‰πãÂêé„ÄÇ<br>ËøôÈáåÊàë‰ª¨Âà©Áî®InitializingBeanÊé•Âè£Êù•ÂÆûÁé∞ÔºåÂõ†‰∏∫InitializingBeanÂèØ‰ª•Âú®ÂØπË±°Ë¢´SpringÂàõÂª∫Âπ∂‰∏îÊàêÂëòÂèòÈáèÂÖ®ÈÉ®Ê≥®ÂÖ•ÂêéÊâßË°å„ÄÇ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> StringRedisTemplate redisTemplate;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemService itemService;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> IItemStockService stockService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">MAPPER</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// ÂàùÂßãÂåñÁºìÂ≠ò</span><br>        <span class="hljs-comment">// 1.Êü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØ</span><br>        List&lt;Item&gt; itemList = itemService.list();<br>        <span class="hljs-comment">// 2.ÊîæÂÖ•ÁºìÂ≠ò</span><br>        <span class="hljs-keyword">for</span> (Item item : itemList) &#123;<br>            <span class="hljs-comment">// 2.1.itemÂ∫èÂàóÂåñ‰∏∫JSON</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(item);<br>            <span class="hljs-comment">// 2.2.Â≠òÂÖ•redis</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:id:&quot;</span> + item.getId(), json);<br>        &#125;<br><br>        <span class="hljs-comment">// 3.Êü•ËØ¢ÂïÜÂìÅÂ∫ìÂ≠ò‰ø°ÊÅØ</span><br>        List&lt;ItemStock&gt; stockList = stockService.list();<br>        <span class="hljs-comment">// 4.ÊîæÂÖ•ÁºìÂ≠ò</span><br>        <span class="hljs-keyword">for</span> (ItemStock stock : stockList) &#123;<br>            <span class="hljs-comment">// 2.1.itemÂ∫èÂàóÂåñ‰∏∫JSON</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> MAPPER.writeValueAsString(stock);<br>            <span class="hljs-comment">// 2.2.Â≠òÂÖ•redis</span><br>            redisTemplate.opsForValue().set(<span class="hljs-string">&quot;item:stock:id:&quot;</span> + stock.getId(), json);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="6-6-Êü•ËØ¢RedisÁºìÂ≠ò"><a href="#6-6-Êü•ËØ¢RedisÁºìÂ≠ò" class="headerlink" title="6.6 Êü•ËØ¢RedisÁºìÂ≠ò"></a>6.6 Êü•ËØ¢RedisÁºìÂ≠ò</h3><p>ÂΩìËØ∑Ê±ÇËøõÂÖ•OpenResty‰πãÂêéÔºö</p>
<ul>
<li>‰ºòÂÖàÊü•ËØ¢RedisÁºìÂ≠ò</li>
<li>Â¶ÇÊûúRedisÁºìÂ≠òÊú™ÂëΩ‰∏≠ÔºåÂÜçÊü•ËØ¢Tomcat</li>
</ul>
<p>‰øÆÊîπitem.luaÊñá‰ª∂ÔºåÂÆûÁé∞ÂØπRedisÁöÑÊü•ËØ¢ÔºåÊü•ËØ¢ÈÄªËæëÊòØÔºö</p>
<ul>
<li>Ê†πÊçÆidÊü•ËØ¢Redis</li>
<li>Â¶ÇÊûúÊü•ËØ¢Â§±Ë¥•ÂàôÁªßÁª≠Êü•ËØ¢Tomcat</li>
<li>Â∞ÜÊü•ËØ¢ÁªìÊûúËøîÂõû</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ÂØºÂÖ•commonÂáΩÊï∞Â∫ì</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-keyword">local</span> read_redis = common.read_redis<br><span class="hljs-comment">-- ÂØºÂÖ•cjsonÂ∫ì</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><br><span class="hljs-comment">-- Â∞ÅË£ÖÊü•ËØ¢ÂáΩÊï∞</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, path, params)</span></span><br>    <span class="hljs-comment">-- Êü•ËØ¢Êú¨Âú∞ÁºìÂ≠ò</span><br>    <span class="hljs-keyword">local</span> val = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>    <span class="hljs-comment">-- Âà§Êñ≠Êü•ËØ¢ÁªìÊûú</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redisÊü•ËØ¢Â§±Ë¥•ÔºåÂ∞ùËØïÊü•ËØ¢httpÔºå key: &quot;</span>, key)<br>        <span class="hljs-comment">-- redisÊü•ËØ¢Â§±Ë¥•ÔºåÂéªÊü•ËØ¢http</span><br>        val = read_http(<span class="hljs-built_in">path</span>, params)<br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- ËøîÂõûÊï∞ÊçÆ</span><br>    <span class="hljs-keyword">return</span> val<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- Ëé∑ÂèñË∑ØÂæÑÂèÇÊï∞</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- Êü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØ</span><br><span class="hljs-keyword">local</span> itemJSON = read_data(<span class="hljs-string">&quot;item:id:&quot;</span> .. id,  <span class="hljs-string">&quot;/item/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- Êü•ËØ¢Â∫ìÂ≠ò‰ø°ÊÅØ</span><br><span class="hljs-keyword">local</span> stockJSON = read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span> .. id, <span class="hljs-string">&quot;/item/stock/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONËΩ¨Âåñ‰∏∫luaÁöÑtable</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><span class="hljs-comment">-- ÁªÑÂêàÊï∞ÊçÆ</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- ÊääitemÂ∫èÂàóÂåñ‰∏∫json ËøîÂõûÁªìÊûú</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>

<h3 id="6-7-NginxÊú¨Âú∞ÁºìÂ≠ò"><a href="#6-7-NginxÊú¨Âú∞ÁºìÂ≠ò" class="headerlink" title="6.7 NginxÊú¨Âú∞ÁºìÂ≠ò"></a>6.7 NginxÊú¨Âú∞ÁºìÂ≠ò</h3><p><img src="/img/blogs/java/redis/3.6.4.png" srcset="/img/loading.gif" lazyload></p>
<p>OpenResty‰∏∫NginxÊèê‰æõ‰∫Ü<strong>shard dict</strong>ÁöÑÂäüËÉΩÔºåÂèØ‰ª•Âú®nginxÁöÑÂ§ö‰∏™worker‰πãÈó¥ÂÖ±‰∫´Êï∞ÊçÆÔºåÂÆûÁé∞ÁºìÂ≠òÂäüËÉΩ„ÄÇ</p>
<ol>
<li>ÂºÄÂêØÂÖ±‰∫´Â≠óÂÖ∏ÔºåÂú®nginx.confÁöÑhttp‰∏ãÊ∑ªÂä†ÈÖçÁΩÆÔºö</li>
</ol>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-comment"># ÂÖ±‰∫´Â≠óÂÖ∏Ôºå‰πüÂ∞±ÊòØÊú¨Âú∞ÁºìÂ≠òÔºåÂêçÁß∞Âè´ÂÅöÔºöitem_cacheÔºåÂ§ßÂ∞è150m</span><br><span class="hljs-attribute">lua_shared_dict</span> item_cache <span class="hljs-number">150m</span>; <br></code></pre></td></tr></table></figure>

<ol start="2">
<li>Êìç‰ΩúÂÖ±‰∫´Â≠óÂÖ∏Ôºö</li>
</ol>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- Ëé∑ÂèñÊú¨Âú∞ÁºìÂ≠òÂØπË±°</span><br><span class="hljs-keyword">local</span> item_cache = ngx.shared.item_cache<br><span class="hljs-comment">-- Â≠òÂÇ®, ÊåáÂÆökey„ÄÅvalue„ÄÅËøáÊúüÊó∂Èó¥ÔºåÂçï‰ΩçsÔºåÈªòËÆ§‰∏∫0‰ª£Ë°®Ê∞∏‰∏çËøáÊúü</span><br>item_cache:set(<span class="hljs-string">&#x27;key&#x27;</span>, <span class="hljs-string">&#x27;value&#x27;</span>, <span class="hljs-number">1000</span>)<br><span class="hljs-comment">-- ËØªÂèñ</span><br><span class="hljs-keyword">local</span> val = item_cache:get(<span class="hljs-string">&#x27;key&#x27;</span>)<br></code></pre></td></tr></table></figure>

<h4 id="ÂÆûÁé∞Êú¨Âú∞ÁºìÂ≠òÊü•ËØ¢"><a href="#ÂÆûÁé∞Êú¨Âú∞ÁºìÂ≠òÊü•ËØ¢" class="headerlink" title="ÂÆûÁé∞Êú¨Âú∞ÁºìÂ≠òÊü•ËØ¢"></a>ÂÆûÁé∞Êú¨Âú∞ÁºìÂ≠òÊü•ËØ¢</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">-- ÂØºÂÖ•commonÂáΩÊï∞Â∫ì</span><br><span class="hljs-keyword">local</span> common = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;common&#x27;</span>)<br><span class="hljs-keyword">local</span> read_http = common.read_http<br><span class="hljs-keyword">local</span> read_redis = common.read_redis<br><span class="hljs-comment">-- ÂØºÂÖ•cjsonÂ∫ì</span><br><span class="hljs-keyword">local</span> cjson = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;cjson&#x27;</span>)<br><span class="hljs-comment">-- ÂØºÂÖ•ÂÖ±‰∫´ËØçÂÖ∏ÔºåÊú¨Âú∞ÁºìÂ≠ò</span><br><span class="hljs-keyword">local</span> item_cache = ngx.shared.item_cache<br><br><span class="hljs-comment">-- Â∞ÅË£ÖÊü•ËØ¢ÂáΩÊï∞</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">read_data</span><span class="hljs-params">(key, expire, path, params)</span></span><br>    <span class="hljs-comment">-- Êü•ËØ¢Êú¨Âú∞ÁºìÂ≠ò</span><br>    <span class="hljs-keyword">local</span> val = item_cache:get(key)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>        ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;Êú¨Âú∞ÁºìÂ≠òÊü•ËØ¢Â§±Ë¥•ÔºåÂ∞ùËØïÊü•ËØ¢RedisÔºå key: &quot;</span>, key)<br>        <span class="hljs-comment">-- Êü•ËØ¢redis</span><br>        val = read_redis(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">6379</span>, key)<br>        <span class="hljs-comment">-- Âà§Êñ≠Êü•ËØ¢ÁªìÊûú</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> val <span class="hljs-keyword">then</span><br>            ngx.<span class="hljs-built_in">log</span>(ngx.ERR, <span class="hljs-string">&quot;redisÊü•ËØ¢Â§±Ë¥•ÔºåÂ∞ùËØïÊü•ËØ¢httpÔºå key: &quot;</span>, key)<br>            <span class="hljs-comment">-- redisÊü•ËØ¢Â§±Ë¥•ÔºåÂéªÊü•ËØ¢http</span><br>            val = read_http(<span class="hljs-built_in">path</span>, params)<br>        <span class="hljs-keyword">end</span><br>    <span class="hljs-keyword">end</span><br>    <span class="hljs-comment">-- Êü•ËØ¢ÊàêÂäüÔºåÊääÊï∞ÊçÆÂÜôÂÖ•Êú¨Âú∞ÁºìÂ≠ò</span><br>    item_cache:set(key, val, expire)<br>    <span class="hljs-comment">-- ËøîÂõûÊï∞ÊçÆ</span><br>    <span class="hljs-keyword">return</span> val<br><span class="hljs-keyword">end</span><br><br><span class="hljs-comment">-- Ëé∑ÂèñË∑ØÂæÑÂèÇÊï∞</span><br><span class="hljs-keyword">local</span> id = ngx.var[<span class="hljs-number">1</span>]<br><br><span class="hljs-comment">-- Êü•ËØ¢ÂïÜÂìÅ‰ø°ÊÅØ</span><br><span class="hljs-keyword">local</span> itemJSON = read_data(<span class="hljs-string">&quot;item:id:&quot;</span> .. id, <span class="hljs-number">1800</span>,  <span class="hljs-string">&quot;/item/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><span class="hljs-comment">-- Êü•ËØ¢Â∫ìÂ≠ò‰ø°ÊÅØ</span><br><span class="hljs-keyword">local</span> stockJSON = read_data(<span class="hljs-string">&quot;item:stock:id:&quot;</span> .. id, <span class="hljs-number">60</span>, <span class="hljs-string">&quot;/item/stock/&quot;</span> .. id, <span class="hljs-literal">nil</span>)<br><br><span class="hljs-comment">-- JSONËΩ¨Âåñ‰∏∫luaÁöÑtable</span><br><span class="hljs-keyword">local</span> item = cjson.decode(itemJSON)<br><span class="hljs-keyword">local</span> stock = cjson.decode(stockJSON)<br><span class="hljs-comment">-- ÁªÑÂêàÊï∞ÊçÆ</span><br>item.stock = stock.stock<br>item.sold = stock.sold<br><br><span class="hljs-comment">-- ÊääitemÂ∫èÂàóÂåñ‰∏∫json ËøîÂõûÁªìÊûú</span><br>ngx.say(cjson.encode(item))<br></code></pre></td></tr></table></figure>

<h2 id="7-ÁºìÂ≠òÂêåÊ≠•"><a href="#7-ÁºìÂ≠òÂêåÊ≠•" class="headerlink" title="7. ÁºìÂ≠òÂêåÊ≠•"></a>7. ÁºìÂ≠òÂêåÊ≠•</h2><p>Êàë‰ª¨ÂøÖÈ°ª‰øùËØÅÊï∞ÊçÆÂ∫ìÊï∞ÊçÆ„ÄÅÁºìÂ≠òÊï∞ÊçÆÁöÑ‰∏ÄËá¥ÊÄßÔºåËøôÂ∞±ÊòØÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÁöÑÂêåÊ≠•</p>
<h3 id="7-1-Êï∞ÊçÆÂêåÊ≠•Á≠ñÁï•"><a href="#7-1-Êï∞ÊçÆÂêåÊ≠•Á≠ñÁï•" class="headerlink" title="7.1 Êï∞ÊçÆÂêåÊ≠•Á≠ñÁï•"></a>7.1 Êï∞ÊçÆÂêåÊ≠•Á≠ñÁï•</h3><p>ÁºìÂ≠òÊï∞ÊçÆÂêåÊ≠•ÁöÑÂ∏∏ËßÅÊñπÂºèÊúâ‰∏âÁßçÔºö</p>
<p><strong>ËÆæÁΩÆÊúâÊïàÊúü</strong>ÔºöÁªôÁºìÂ≠òËÆæÁΩÆÊúâÊïàÊúüÔºåÂà∞ÊúüÂêéËá™Âä®Âà†Èô§„ÄÇÂÜçÊ¨°Êü•ËØ¢Êó∂Êõ¥Êñ∞</p>
<ul>
<li>‰ºòÂäøÔºöÁÆÄÂçï„ÄÅÊñπ‰æø</li>
<li>Áº∫ÁÇπÔºöÊó∂ÊïàÊÄßÂ∑ÆÔºåÁºìÂ≠òËøáÊúü‰πãÂâçÂèØËÉΩ‰∏ç‰∏ÄËá¥</li>
<li>Âú∫ÊôØÔºöÊõ¥Êñ∞È¢ëÁéáËæÉ‰ΩéÔºåÊó∂ÊïàÊÄßË¶ÅÊ±Ç‰ΩéÁöÑ‰∏öÂä°</li>
</ul>
<p><strong>ÂêåÊ≠•ÂèåÂÜô</strong>ÔºöÂú®‰øÆÊîπÊï∞ÊçÆÂ∫ìÁöÑÂêåÊó∂ÔºåÁõ¥Êé•‰øÆÊîπÁºìÂ≠ò</p>
<ul>
<li>‰ºòÂäøÔºöÊó∂ÊïàÊÄßÂº∫ÔºåÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÂº∫‰∏ÄËá¥</li>
<li>Áº∫ÁÇπÔºöÊúâ‰ª£Á†Å‰æµÂÖ•ÔºåËÄ¶ÂêàÂ∫¶È´òÔºõ</li>
<li>Âú∫ÊôØÔºöÂØπ‰∏ÄËá¥ÊÄß„ÄÅÊó∂ÊïàÊÄßË¶ÅÊ±ÇËæÉÈ´òÁöÑÁºìÂ≠òÊï∞ÊçÆ</li>
</ul>
<p>**ÂºÇÊ≠•ÈÄöÁü•Ôºö**‰øÆÊîπÊï∞ÊçÆÂ∫ìÊó∂ÂèëÈÄÅ‰∫ã‰ª∂ÈÄöÁü•ÔºåÁõ∏ÂÖ≥ÊúçÂä°ÁõëÂê¨Âà∞ÈÄöÁü•Âêé‰øÆÊîπÁºìÂ≠òÊï∞ÊçÆ</p>
<ul>
<li>‰ºòÂäøÔºö‰ΩéËÄ¶ÂêàÔºåÂèØ‰ª•ÂêåÊó∂ÈÄöÁü•Â§ö‰∏™ÁºìÂ≠òÊúçÂä°</li>
<li>Áº∫ÁÇπÔºöÊó∂ÊïàÊÄß‰∏ÄËà¨ÔºåÂèØËÉΩÂ≠òÂú®‰∏≠Èó¥‰∏ç‰∏ÄËá¥Áä∂ÊÄÅ</li>
<li>Âú∫ÊôØÔºöÊó∂ÊïàÊÄßË¶ÅÊ±Ç‰∏ÄËà¨ÔºåÊúâÂ§ö‰∏™ÊúçÂä°ÈúÄË¶ÅÂêåÊ≠•</li>
</ul>
<p><strong>ÂºÇÊ≠•ÂÆûÁé∞ÔºöÂü∫‰∫éCanalÁöÑÈÄöÁü•</strong>Ôºö</p>
<ul>
<li>ÂïÜÂìÅÊúçÂä°ÂÆåÊàêÂïÜÂìÅ‰øÆÊîπÂêéÔºå‰∏öÂä°Áõ¥Êé•ÁªìÊùüÔºåÊ≤°Êúâ‰ªª‰Ωï‰ª£Á†Å‰æµÂÖ•</li>
<li>CanalÁõëÂê¨MySQLÂèòÂåñÔºåÂΩìÂèëÁé∞ÂèòÂåñÂêéÔºåÁ´ãÂç≥ÈÄöÁü•ÁºìÂ≠òÊúçÂä°</li>
<li>ÁºìÂ≠òÊúçÂä°Êé•Êî∂Âà∞canalÈÄöÁü•ÔºåÊõ¥Êñ∞ÁºìÂ≠ò</li>
</ul>
<p><img src="/img/blogs/java/redis/3.7.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="7-2-Canal"><a href="#7-2-Canal" class="headerlink" title="7.2 Canal"></a>7.2 Canal</h3><p><strong>Canal</strong>ÔºåËØëÊÑè‰∏∫Ê∞¥ÈÅì&#x2F;ÁÆ°ÈÅì&#x2F;Ê≤üÊ∏†ÔºåcanalÊòØÈòøÈáåÂ∑¥Â∑¥Êóó‰∏ãÁöÑ‰∏ÄÊ¨æÂºÄÊ∫êÈ°πÁõÆÔºåÂü∫‰∫éJavaÂºÄÂèë„ÄÇÂü∫‰∫éÊï∞ÊçÆÂ∫ìÂ¢ûÈáèÊó•ÂøóËß£ÊûêÔºåÊèê‰æõÂ¢ûÈáèÊï∞ÊçÆËÆ¢ÈòÖ&amp;Ê∂àË¥π„ÄÇ</p>
<p>CanalÊòØÂü∫‰∫émysqlÁöÑ‰∏ª‰ªéÂêåÊ≠•Êù•ÂÆûÁé∞ÁöÑÔºåMySQL‰∏ª‰ªéÂêåÊ≠•ÁöÑÂéüÁêÜÂ¶Ç‰∏ãÔºö</p>
<p><img src="/img/blogs/java/redis/3.7.2.png" srcset="/img/loading.gif" lazyload></p>
<p>ËÄåCanalÂ∞±ÊòØÊääËá™Â∑±‰º™Ë£ÖÊàêMySQLÁöÑ‰∏Ä‰∏™slaveËäÇÁÇπÔºå‰ªéËÄåÁõëÂê¨masterÁöÑbinary logÂèòÂåñ„ÄÇÂÜçÊääÂæóÂà∞ÁöÑÂèòÂåñ‰ø°ÊÅØÈÄöÁü•ÁªôCanalÁöÑÂÆ¢Êà∑Á´ØÔºåËøõËÄåÂÆåÊàêÂØπÂÖ∂ÂÆÉÊï∞ÊçÆÂ∫ìÁöÑÂêåÊ≠•„ÄÇ</p>
<h3 id="7-3-ÁõëÂê¨Canal"><a href="#7-3-ÁõëÂê¨Canal" class="headerlink" title="7.3 ÁõëÂê¨Canal"></a>7.3 ÁõëÂê¨Canal</h3><p>CanalÊèê‰æõ‰∫ÜÂêÑÁßçËØ≠Ë®ÄÁöÑÂÆ¢Êà∑Á´ØÔºåÂΩìCanalÁõëÂê¨Âà∞binlogÂèòÂåñÊó∂Ôºå‰ºöÈÄöÁü•CanalÁöÑÂÆ¢Êà∑Á´Ø„ÄÇ</p>
<p><img src="/img/blogs/java/redis/3.7.3.png" srcset="/img/loading.gif" lazyload></p>
<p>Êàë‰ª¨ÂèØ‰ª•Âà©Áî®CanalÊèê‰æõÁöÑJavaÂÆ¢Êà∑Á´ØÔºåÁõëÂê¨CanalÈÄöÁü•Ê∂àÊÅØ„ÄÇÂΩìÊî∂Âà∞ÂèòÂåñÁöÑÊ∂àÊÅØÊó∂ÔºåÂÆåÊàêÂØπÁºìÂ≠òÁöÑÊõ¥Êñ∞„ÄÇ</p>
<h5 id="ÁºñÂÜôÁõëÂê¨Âô®"><a href="#ÁºñÂÜôÁõëÂê¨Âô®" class="headerlink" title="ÁºñÂÜôÁõëÂê¨Âô®"></a>ÁºñÂÜôÁõëÂê¨Âô®</h5><p>ÈÄöËøáÂÆûÁé∞<code>EntryHandler&lt;T&gt;</code>Êé•Âè£ÁºñÂÜôÁõëÂê¨Âô®ÔºåÁõëÂê¨CanalÊ∂àÊÅØ„ÄÇÊ≥®ÊÑè‰∏§ÁÇπÔºö</p>
<ul>
<li>ÂÆûÁé∞Á±ªÈÄöËøá<code>@CanalTable(&quot;tb_item&quot;)</code>ÊåáÂÆöÁõëÂê¨ÁöÑË°®‰ø°ÊÅØ</li>
<li>EntryHandlerÁöÑÊ≥õÂûãÊòØ‰∏éË°®ÂØπÂ∫îÁöÑÂÆû‰ΩìÁ±ª</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CanalTable(&quot;tb_item&quot;)</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EntryHandler</span>&lt;Item&gt; &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisHandler redisHandler;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cache&lt;Long, Item&gt; itemCache;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insert</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// ÂÜôÊï∞ÊçÆÂà∞JVMËøõÁ®ãÁºìÂ≠ò</span><br>        itemCache.put(item.getId(), item);<br>        <span class="hljs-comment">// ÂÜôÊï∞ÊçÆÂà∞redis</span><br>        redisHandler.saveItem(item);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">(Item before, Item after)</span> &#123;<br>        <span class="hljs-comment">// ÂÜôÊï∞ÊçÆÂà∞JVMËøõÁ®ãÁºìÂ≠ò</span><br>        itemCache.put(after.getId(), after);<br>        <span class="hljs-comment">// ÂÜôÊï∞ÊçÆÂà∞redis</span><br>        redisHandler.saveItem(after);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delete</span><span class="hljs-params">(Item item)</span> &#123;<br>        <span class="hljs-comment">// Âà†Èô§Êï∞ÊçÆÂà∞JVMËøõÁ®ãÁºìÂ≠ò</span><br>        itemCache.invalidate(item.getId());<br>        <span class="hljs-comment">// Âà†Èô§Êï∞ÊçÆÂà∞redis</span><br>        redisHandler.deleteItemById(item.getId());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="8-Â§öÁ∫ßÁºìÂ≠òÊÄªÁªì"><a href="#8-Â§öÁ∫ßÁºìÂ≠òÊÄªÁªì" class="headerlink" title="8. Â§öÁ∫ßÁºìÂ≠òÊÄªÁªì"></a>8. Â§öÁ∫ßÁºìÂ≠òÊÄªÁªì</h2><p><img src="/img/blogs/java/redis/3.8.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="9-RedisÊúÄ‰Ω≥ÂÆûË∑µ"><a href="#9-RedisÊúÄ‰Ω≥ÂÆûË∑µ" class="headerlink" title="9. RedisÊúÄ‰Ω≥ÂÆûË∑µ"></a>9. RedisÊúÄ‰Ω≥ÂÆûË∑µ</h2><h3 id="9-1-RedisÈîÆÂÄºËÆæËÆ°"><a href="#9-1-RedisÈîÆÂÄºËÆæËÆ°" class="headerlink" title="9.1 RedisÈîÆÂÄºËÆæËÆ°"></a>9.1 RedisÈîÆÂÄºËÆæËÆ°</h3><h4 id="9-1-1-‰ºòÈõÖÁöÑkeyÁªìÊûÑ"><a href="#9-1-1-‰ºòÈõÖÁöÑkeyÁªìÊûÑ" class="headerlink" title="9.1.1 ‰ºòÈõÖÁöÑkeyÁªìÊûÑ"></a>9.1.1 ‰ºòÈõÖÁöÑkeyÁªìÊûÑ</h4><p>RedisÁöÑKeyËôΩÁÑ∂ÂèØ‰ª•Ëá™ÂÆö‰πâÔºå‰ΩÜÊúÄÂ•ΩÈÅµÂæ™‰∏ãÈù¢ÁöÑÂá†‰∏™ÊúÄ‰Ω≥ÂÆûË∑µÁ∫¶ÂÆöÔºö</p>
<ul>
<li>ÈÅµÂæ™Âü∫Êú¨Ê†ºÂºèÔºö<code>[‰∏öÂä°ÂêçÁß∞]:[Êï∞ÊçÆÂêç]:[id]</code></li>
<li>ÈïøÂ∫¶‰∏çË∂ÖËøá44Â≠óËäÇ</li>
<li>‰∏çÂåÖÂê´ÁâπÊÆäÂ≠óÁ¨¶</li>
</ul>
<p><img src="/img/blogs/java/redis/3.9.1.png" srcset="/img/loading.gif" lazyload></p>
<p>ËøôÊ†∑ËÆæËÆ°ÁöÑÂ•ΩÂ§ÑÔºö</p>
<ul>
<li>ÂèØËØªÊÄßÂº∫</li>
<li>ÈÅøÂÖçkeyÂÜ≤Á™Å</li>
<li>Êñπ‰æøÁÆ°ÁêÜ</li>
<li>Êõ¥ËäÇÁúÅÂÜÖÂ≠ò</li>
</ul>
<h4 id="9-1-2-ÊãíÁªùBigKey"><a href="#9-1-2-ÊãíÁªùBigKey" class="headerlink" title="9.1.2 ÊãíÁªùBigKey"></a>9.1.2 ÊãíÁªùBigKey</h4><h5 id="9-1-2-1-BigKey"><a href="#9-1-2-1-BigKey" class="headerlink" title="9.1.2.1 BigKey"></a>9.1.2.1 BigKey</h5><p>BigKeyÈÄöÂ∏∏‰ª•KeyÁöÑÂ§ßÂ∞èÂíåKey‰∏≠ÊàêÂëòÁöÑÊï∞ÈáèÊù•ÁªºÂêàÂà§ÂÆöÔºå‰æãÂ¶ÇÔºö</p>
<ul>
<li>KeyÊú¨Ë∫´ÁöÑÊï∞ÊçÆÈáèËøáÂ§ßÔºö‰∏Ä‰∏™StringÁ±ªÂûãÁöÑKeyÔºåÂÆÉÁöÑÂÄº‰∏∫5 MB</li>
<li>Key‰∏≠ÁöÑÊàêÂëòÊï∞ËøáÂ§öÔºö‰∏Ä‰∏™ZSETÁ±ªÂûãÁöÑKeyÔºåÂÆÉÁöÑÊàêÂëòÊï∞Èáè‰∏∫10,000‰∏™</li>
<li>Key‰∏≠ÊàêÂëòÁöÑÊï∞ÊçÆÈáèËøáÂ§ßÔºö‰∏Ä‰∏™HashÁ±ªÂûãÁöÑKeyÔºåÂÆÉÁöÑÊàêÂëòÊï∞ÈáèËôΩÁÑ∂Âè™Êúâ1,000‰∏™‰ΩÜËøô‰∫õÊàêÂëòÁöÑValueÔºàÂÄºÔºâÊÄªÂ§ßÂ∞è‰∏∫100 MB</li>
</ul>
<p>Êé®ËçêÂÄºÔºö</p>
<ul>
<li>Âçï‰∏™keyÁöÑvalueÂ∞è‰∫é10KB</li>
<li>ÂØπ‰∫éÈõÜÂêàÁ±ªÂûãÁöÑkeyÔºåÂª∫ËÆÆÂÖÉÁ¥†Êï∞ÈáèÂ∞è‰∫é1000</li>
</ul>
<h5 id="9-1-2-2-BigKeyÁöÑÂç±ÂÆ≥"><a href="#9-1-2-2-BigKeyÁöÑÂç±ÂÆ≥" class="headerlink" title="9.1.2.2 BigKeyÁöÑÂç±ÂÆ≥"></a>9.1.2.2 BigKeyÁöÑÂç±ÂÆ≥</h5><ul>
<li>ÁΩëÁªúÈòªÂ°û<ul>
<li>ÂØπBigKeyÊâßË°åËØªËØ∑Ê±ÇÊó∂ÔºåÂ∞ëÈáèÁöÑQPSÂ∞±ÂèØËÉΩÂØºËá¥Â∏¶ÂÆΩ‰ΩøÁî®ÁéáË¢´Âç†Êª°ÔºåÂØºËá¥RedisÂÆû‰æãÔºå‰πÉËá≥ÊâÄÂú®Áâ©ÁêÜÊú∫ÂèòÊÖ¢</li>
</ul>
</li>
<li>Êï∞ÊçÆÂÄæÊñú<ul>
<li>BigKeyÊâÄÂú®ÁöÑRedisÂÆû‰æãÂÜÖÂ≠ò‰ΩøÁî®ÁéáËøúË∂ÖÂÖ∂‰ªñÂÆû‰æãÔºåÊó†Ê≥ï‰ΩøÊï∞ÊçÆÂàÜÁâáÁöÑÂÜÖÂ≠òËµÑÊ∫êËææÂà∞ÂùáË°°</li>
</ul>
</li>
<li>RedisÈòªÂ°û<ul>
<li>ÂØπÂÖÉÁ¥†ËæÉÂ§öÁöÑhash„ÄÅlist„ÄÅzsetÁ≠âÂÅöËøêÁÆó‰ºöËÄóÊó∂ËæÉÊóßÔºå‰Ωø‰∏ªÁ∫øÁ®ãË¢´ÈòªÂ°û</li>
</ul>
</li>
<li>CPUÂéãÂäõ<ul>
<li>ÂØπBigKeyÁöÑÊï∞ÊçÆÂ∫èÂàóÂåñÂíåÂèçÂ∫èÂàóÂåñ‰ºöÂØºËá¥CPUÁöÑ‰ΩøÁî®ÁéáÈ£ôÂçáÔºåÂΩ±ÂìçRedisÂÆû‰æãÂíåÊú¨Êú∫ÂÖ∂ÂÆÉÂ∫îÁî®</li>
</ul>
</li>
</ul>
<h5 id="9-1-2-3-Â¶Ç‰ΩïÂèëÁé∞BigKey"><a href="#9-1-2-3-Â¶Ç‰ΩïÂèëÁé∞BigKey" class="headerlink" title="9.1.2.3 Â¶Ç‰ΩïÂèëÁé∞BigKey"></a>9.1.2.3 Â¶Ç‰ΩïÂèëÁé∞BigKey</h5><ul>
<li><strong>redis-cli ‚Äìbigkeys</strong><ul>
<li>Âà©Áî®redis-cliÊèê‰æõÁöÑ‚ÄìbigkeysÂèÇÊï∞ÔºåÂèØ‰ª•ÈÅçÂéÜÂàÜÊûêÊâÄÊúâkeyÔºåÂπ∂ËøîÂõûKeyÁöÑÊï¥‰ΩìÁªüËÆ°‰ø°ÊÅØ‰∏éÊØè‰∏™Êï∞ÊçÆÁöÑTop1ÁöÑbig key</li>
</ul>
</li>
<li><strong>scanÊâ´Êèè</strong><ul>
<li>Ëá™Â∑±ÁºñÁ®ãÔºåÂà©Áî®scanÊâ´ÊèèRedis‰∏≠ÁöÑÊâÄÊúâkeyÔºåÂà©Áî®strlen„ÄÅhlenÁ≠âÂëΩ‰ª§Âà§Êñ≠keyÁöÑÈïøÂ∫¶ÔºàÊ≠§Â§Ñ‰∏çÂª∫ËÆÆ‰ΩøÁî®MEMORY USAGEÔºâ</li>
</ul>
</li>
<li><strong>Á¨¨‰∏âÊñπÂ∑•ÂÖ∑</strong><ul>
<li>Âà©Áî®Á¨¨‰∏âÊñπÂ∑•ÂÖ∑ÔºåÂ¶Ç Redis-Rdb-Tools ÂàÜÊûêRDBÂø´ÁÖßÊñá‰ª∂ÔºåÂÖ®Èù¢ÂàÜÊûêÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµ</li>
</ul>
</li>
<li><strong>ÁΩëÁªúÁõëÊéß</strong><ul>
<li>Ëá™ÂÆö‰πâÂ∑•ÂÖ∑ÔºåÁõëÊéßËøõÂá∫RedisÁöÑÁΩëÁªúÊï∞ÊçÆÔºåË∂ÖÂá∫È¢ÑË≠¶ÂÄºÊó∂‰∏ªÂä®ÂëäË≠¶</li>
</ul>
</li>
</ul>
<h5 id="9-1-2-4-Â¶Ç‰ΩïÂà†Èô§BigKey"><a href="#9-1-2-4-Â¶Ç‰ΩïÂà†Èô§BigKey" class="headerlink" title="9.1.2.4 Â¶Ç‰ΩïÂà†Èô§BigKey"></a>9.1.2.4 Â¶Ç‰ΩïÂà†Èô§BigKey</h5><p>BigKeyÂÜÖÂ≠òÂç†Áî®ËæÉÂ§öÔºåÂç≥‰æøÊó∂Âà†Èô§ËøôÊ†∑ÁöÑkey‰πüÈúÄË¶ÅËÄóË¥πÂæàÈïøÊó∂Èó¥ÔºåÂØºËá¥Redis‰∏ªÁ∫øÁ®ãÈòªÂ°ûÔºåÂºïÂèë‰∏ÄÁ≥ªÂàóÈóÆÈ¢ò„ÄÇ</p>
<ul>
<li>redis 3.0 Âèä‰ª•‰∏ãÁâàÊú¨<ul>
<li>Â¶ÇÊûúÊòØÈõÜÂêàÁ±ªÂûãÔºåÂàôÈÅçÂéÜBigKeyÁöÑÂÖÉÁ¥†ÔºåÂÖàÈÄê‰∏™Âà†Èô§Â≠êÂÖÉÁ¥†ÔºåÊúÄÂêéÂà†Èô§BigKey</li>
</ul>
</li>
<li>Redis 4.0‰ª•Âêé<ul>
<li>RedisÂú®4.0ÂêéÊèê‰æõ‰∫ÜÂºÇÊ≠•Âà†Èô§ÁöÑÂëΩ‰ª§Ôºöunlink</li>
</ul>
</li>
</ul>
<h4 id="9-1-3-ÊÅ∞ÂΩìÁöÑÊï∞ÊçÆÁ±ªÂûã"><a href="#9-1-3-ÊÅ∞ÂΩìÁöÑÊï∞ÊçÆÁ±ªÂûã" class="headerlink" title="9.1.3 ÊÅ∞ÂΩìÁöÑÊï∞ÊçÆÁ±ªÂûã"></a>9.1.3 ÊÅ∞ÂΩìÁöÑÊï∞ÊçÆÁ±ªÂûã</h4><h5 id="‰æã1ÔºöÊØîÂ¶ÇÂ≠òÂÇ®‰∏Ä‰∏™UserÂØπË±°ÔºåÊàë‰ª¨Êúâ‰∏âÁßçÂ≠òÂÇ®ÊñπÂºèÔºö"><a href="#‰æã1ÔºöÊØîÂ¶ÇÂ≠òÂÇ®‰∏Ä‰∏™UserÂØπË±°ÔºåÊàë‰ª¨Êúâ‰∏âÁßçÂ≠òÂÇ®ÊñπÂºèÔºö" class="headerlink" title="‰æã1ÔºöÊØîÂ¶ÇÂ≠òÂÇ®‰∏Ä‰∏™UserÂØπË±°ÔºåÊàë‰ª¨Êúâ‰∏âÁßçÂ≠òÂÇ®ÊñπÂºèÔºö"></a>‰æã1ÔºöÊØîÂ¶ÇÂ≠òÂÇ®‰∏Ä‰∏™UserÂØπË±°ÔºåÊàë‰ª¨Êúâ‰∏âÁßçÂ≠òÂÇ®ÊñπÂºèÔºö</h5><ol>
<li>ÊñπÂºè‰∏ÄÔºöjsonÂ≠óÁ¨¶‰∏≤</li>
<li>ÊñπÂºè‰∫åÔºöÂ≠óÊÆµÊâìÊï£</li>
<li>ÊñπÂºè‰∏âÔºöhashÔºà<strong>Êé®Ëçê</strong>Ôºâ</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.2.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="‰æã2ÔºöÂÅáÂ¶ÇÊúâhashÁ±ªÂûãÁöÑkeyÔºåÂÖ∂‰∏≠Êúâ100‰∏áÂØπfieldÂíåvalueÔºåfieldÊòØËá™Â¢ûidÔºåËøô‰∏™keyÂ≠òÂú®‰ªÄ‰πàÈóÆÈ¢òÔºüÂ¶Ç‰Ωï‰ºòÂåñÔºü"><a href="#‰æã2ÔºöÂÅáÂ¶ÇÊúâhashÁ±ªÂûãÁöÑkeyÔºåÂÖ∂‰∏≠Êúâ100‰∏áÂØπfieldÂíåvalueÔºåfieldÊòØËá™Â¢ûidÔºåËøô‰∏™keyÂ≠òÂú®‰ªÄ‰πàÈóÆÈ¢òÔºüÂ¶Ç‰Ωï‰ºòÂåñÔºü" class="headerlink" title="‰æã2ÔºöÂÅáÂ¶ÇÊúâhashÁ±ªÂûãÁöÑkeyÔºåÂÖ∂‰∏≠Êúâ100‰∏áÂØπfieldÂíåvalueÔºåfieldÊòØËá™Â¢ûidÔºåËøô‰∏™keyÂ≠òÂú®‰ªÄ‰πàÈóÆÈ¢òÔºüÂ¶Ç‰Ωï‰ºòÂåñÔºü"></a>‰æã2ÔºöÂÅáÂ¶ÇÊúâhashÁ±ªÂûãÁöÑkeyÔºåÂÖ∂‰∏≠Êúâ100‰∏áÂØπfieldÂíåvalueÔºåfieldÊòØËá™Â¢ûidÔºåËøô‰∏™keyÂ≠òÂú®‰ªÄ‰πàÈóÆÈ¢òÔºüÂ¶Ç‰Ωï‰ºòÂåñÔºü</h5><p>Â≠òÂú®ÁöÑÈóÆÈ¢òÔºö</p>
<ul>
<li>hashÁöÑentryÊï∞ÈáèË∂ÖËøá500Êó∂Ôºå‰ºö‰ΩøÁî®ÂìàÂ∏åË°®ËÄå‰∏çÊòØZipListÔºåÂÜÖÂ≠òÂç†Áî®ËæÉÂ§ö</li>
<li>ÂèØ‰ª•ÈÄöËøáhash-max-ziplist-entriesÈÖçÁΩÆentry‰∏äÈôê„ÄÇ‰ΩÜÊòØÂ¶ÇÊûúentryËøáÂ§öÂ∞±‰ºöÂØºËá¥BigKeyÈóÆÈ¢ò</li>
</ul>
<ol>
<li>ÊñπÊ°à‰∏ÄÔºö ÊãÜÂàÜ‰∏∫stringÁ±ªÂûã</li>
<li>ÊñπÊ°à‰∫åÔºö ÊãÜÂàÜ‰∏∫Â∞èÁöÑhashÔºåÂ∞Ü id &#x2F; 100 ‰Ωú‰∏∫keyÔºå Â∞Üid % 100 ‰Ωú‰∏∫fieldÔºåËøôÊ†∑ÊØè100‰∏™ÂÖÉÁ¥†‰∏∫‰∏Ä‰∏™Hash(<strong>Êé®Ëçê</strong>)</li>
</ol>
<h4 id="9-1-4-ÊÄªÁªì"><a href="#9-1-4-ÊÄªÁªì" class="headerlink" title="9.1.4 ÊÄªÁªì"></a>9.1.4 ÊÄªÁªì</h4><ul>
<li>KeyÁöÑÊúÄ‰Ω≥ÂÆûË∑µ<ul>
<li>Âõ∫ÂÆöÊ†ºÂºèÔºö<code>[‰∏öÂä°Âêç]:[Êï∞ÊçÆÂêç]:[id]</code></li>
<li>Ë∂≥Â§üÁÆÄÁü≠Ôºö‰∏çË∂ÖËøá44Â≠óËäÇ</li>
<li>‰∏çÂåÖÂê´ÁâπÊÆäÂ≠óÁ¨¶</li>
</ul>
</li>
<li>ValueÁöÑÊúÄ‰Ω≥ÂÆûË∑µÔºö<ul>
<li>ÂêàÁêÜÁöÑÊãÜÂàÜÊï∞ÊçÆÔºåÊãíÁªùBigKey</li>
<li>ÈÄâÊã©ÂêàÈÄÇÊï∞ÊçÆÁªìÊûÑ</li>
<li>HashÁªìÊûÑÁöÑentryÊï∞Èáè‰∏çË¶ÅË∂ÖËøá1000</li>
<li>ËÆæÁΩÆÂêàÁêÜÁöÑË∂ÖÊó∂Êó∂Èó¥</li>
</ul>
</li>
</ul>
<h3 id="9-2-ÊâπÂ§ÑÁêÜ‰ºòÂåñ"><a href="#9-2-ÊâπÂ§ÑÁêÜ‰ºòÂåñ" class="headerlink" title="9.2 ÊâπÂ§ÑÁêÜ‰ºòÂåñ"></a>9.2 ÊâπÂ§ÑÁêÜ‰ºòÂåñ</h3><h4 id="9-2-1-Pipeline"><a href="#9-2-1-Pipeline" class="headerlink" title="9.2.1 Pipeline"></a>9.2.1 Pipeline</h4><h5 id="9-2-1-1-ÂÆ¢Êà∑Á´Ø‰∏éredisÊúçÂä°Âô®ÊòØËøôÊ†∑‰∫§‰∫íÁöÑ"><a href="#9-2-1-1-ÂÆ¢Êà∑Á´Ø‰∏éredisÊúçÂä°Âô®ÊòØËøôÊ†∑‰∫§‰∫íÁöÑ" class="headerlink" title="9.2.1.1 ÂÆ¢Êà∑Á´Ø‰∏éredisÊúçÂä°Âô®ÊòØËøôÊ†∑‰∫§‰∫íÁöÑ"></a>9.2.1.1 ÂÆ¢Êà∑Á´Ø‰∏éredisÊúçÂä°Âô®ÊòØËøôÊ†∑‰∫§‰∫íÁöÑ</h5><ol>
<li>Âçï‰∏™ÂëΩ‰ª§ÁöÑÊâßË°åÊµÅÁ®ã<br>‰∏ÄÊ¨°ÂëΩ‰ª§ÁöÑÂìçÂ∫îÊó∂Èó¥ &#x3D; 1Ê¨°ÂæÄËøîÁöÑÁΩëÁªú‰º†ËæìËÄóÊó∂ + 1Ê¨°RedisÊâßË°åÂëΩ‰ª§ËÄóÊó∂</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.3.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>NÊù°ÂëΩ‰ª§‰æùÊ¨°ÊâßË°å<br>NÊ¨°ÂëΩ‰ª§ÁöÑÂìçÂ∫îÊó∂Èó¥ &#x3D; NÊ¨°ÂæÄËøîÁöÑÁΩëÁªú‰º†ËæìËÄóÊó∂ + NÊ¨°RedisÊâßË°åÂëΩ‰ª§ËÄóÊó∂</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.4.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>NÊù°ÂëΩ‰ª§ÊâπÈáèÊâßË°å<br>NÊ¨°ÂëΩ‰ª§ÁöÑÂìçÂ∫îÊó∂Èó¥ &#x3D; 1Ê¨°ÂæÄËøîÁöÑÁΩëÁªú‰º†ËæìËÄóÊó∂ + NÊ¨°RedisÊâßË°åÂëΩ‰ª§ËÄóÊó∂</li>
</ol>
<p><img src="/img/blogs/java/redis/3.9.5.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="9-2-1-2-MSet"><a href="#9-2-1-2-MSet" class="headerlink" title="9.2.1.2 MSet"></a>9.2.1.2 MSet</h5><p>RedisÊèê‰æõ‰∫ÜÂæàÂ§öMxxxËøôÊ†∑ÁöÑÂëΩ‰ª§ÔºåÂèØ‰ª•ÂÆûÁé∞ÊâπÈáèÊèíÂÖ•Êï∞ÊçÆÔºå‰æãÂ¶ÇÔºö</p>
<ul>
<li>mset</li>
<li>hmset</li>
</ul>
<p>Âà©Áî®msetÊâπÈáèÊèíÂÖ•10‰∏áÊù°Êï∞ÊçÆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMxx</span><span class="hljs-params">()</span> &#123;<br>    String[] arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">2000</span>];<br>    <span class="hljs-type">int</span> j;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100000</span>; i++) &#123;<br>        j = (i % <span class="hljs-number">1000</span>) &lt;&lt; <span class="hljs-number">1</span>;<br>        arr[j] = <span class="hljs-string">&quot;test:key_&quot;</span> + i;<br>        arr[j + <span class="hljs-number">1</span>] = <span class="hljs-string">&quot;value_&quot;</span> + i;<br>        <span class="hljs-keyword">if</span> (j == <span class="hljs-number">0</span>) &#123;<br>            jedis.mset(arr);<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;time: &quot;</span> + (e - b));<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="9-2-1-3-Pipeline"><a href="#9-2-1-3-Pipeline" class="headerlink" title="9.2.1.3 Pipeline"></a>9.2.1.3 Pipeline</h5><p>MSETËôΩÁÑ∂ÂèØ‰ª•ÊâπÂ§ÑÁêÜÔºå‰ΩÜÊòØÂç¥Âè™ËÉΩÊìç‰ΩúÈÉ®ÂàÜÊï∞ÊçÆÁ±ªÂûãÔºåÂõ†Ê≠§Â¶ÇÊûúÊúâÂØπÂ§çÊùÇÊï∞ÊçÆÁ±ªÂûãÁöÑÊâπÂ§ÑÁêÜÈúÄË¶ÅÔºåÂª∫ËÆÆ‰ΩøÁî®Pipeline</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPipeline</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// ÂàõÂª∫ÁÆ°ÈÅì</span><br>    <span class="hljs-type">Pipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> jedis.pipelined();<br>    <span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">100000</span>; i++) &#123;<br>        <span class="hljs-comment">// ÊîæÂÖ•ÂëΩ‰ª§Âà∞ÁÆ°ÈÅì</span><br>        pipeline.set(<span class="hljs-string">&quot;test:key_&quot;</span> + i, <span class="hljs-string">&quot;value_&quot;</span> + i);<br>        <span class="hljs-keyword">if</span> (i % <span class="hljs-number">1000</span> == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">// ÊØèÊîæÂÖ•1000Êù°ÂëΩ‰ª§ÔºåÊâπÈáèÊâßË°å</span><br>            pipeline.sync();<br>        &#125;<br>    &#125;<br>    <span class="hljs-type">long</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">&quot;time: &quot;</span> + (e - b));<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="9-2-2-ÈõÜÁæ§‰∏ãÁöÑÊâπÂ§ÑÁêÜ"><a href="#9-2-2-ÈõÜÁæ§‰∏ãÁöÑÊâπÂ§ÑÁêÜ" class="headerlink" title="9.2.2 ÈõÜÁæ§‰∏ãÁöÑÊâπÂ§ÑÁêÜ"></a>9.2.2 ÈõÜÁæ§‰∏ãÁöÑÊâπÂ§ÑÁêÜ</h4><p>Â¶ÇMSETÊàñPipelineËøôÊ†∑ÁöÑÊâπÂ§ÑÁêÜÈúÄË¶ÅÂú®‰∏ÄÊ¨°ËØ∑Ê±Ç‰∏≠Êê∫Â∏¶Â§öÊù°ÂëΩ‰ª§ÔºåËÄåÊ≠§Êó∂Â¶ÇÊûúRedisÊòØ‰∏Ä‰∏™ÈõÜÁæ§ÔºåÈÇ£ÊâπÂ§ÑÁêÜÂëΩ‰ª§ÁöÑÂ§ö‰∏™keyÂøÖÈ°ªËêΩÂú®‰∏Ä‰∏™ÊèíÊßΩ‰∏≠ÔºåÂê¶ÂàôÂ∞±‰ºöÂØºËá¥ÊâßË°åÂ§±Ë¥•„ÄÇ</p>
<table>
<thead>
<tr>
<th></th>
<th>‰∏≤Ë°åÂëΩ‰ª§</th>
<th>‰∏≤Ë°åslot</th>
<th>Âπ∂Ë°åslot(Êé®Ëçê)</th>
<th>hash_tag</th>
</tr>
</thead>
<tbody><tr>
<td>ÂÆûÁé∞ÊÄùË∑Ø</td>
<td>forÂæ™ÁéØÈÅçÂéÜÔºå‰æùÊ¨°ÊâßË°åÊØè‰∏™ÂëΩ‰ª§</td>
<td>Âú®ÂÆ¢Êà∑Á´ØËÆ°ÁÆóÊØè‰∏™keyÁöÑslotÔºåÂ∞Üslot‰∏ÄËá¥ÂàÜ‰∏∫‰∏ÄÁªÑÔºåÊØèÁªÑÈÉΩÂà©Áî®PipelineÊâπÂ§ÑÁêÜÔºå‰∏≤Ë°åÊâßË°åÂêÑÁªÑÂëΩ‰ª§</td>
<td>Âú®ÂÆ¢Êà∑Á´ØËÆ°ÁÆóÊØè‰∏™keyÁöÑslotÔºåÂ∞Üslot‰∏ÄËá¥ÂàÜ‰∏∫‰∏ÄÁªÑÔºåÊØèÁªÑÈÉΩÂà©Áî®PipelineÊâπÂ§ÑÁêÜÔºåÂπ∂Ë°åÊâßË°åÂêÑÁªÑÂëΩ‰ª§</td>
<td>Â∞ÜÊâÄÊúâkeyËÆæÁΩÆÁõ∏ÂêåÁöÑhash_tagÔºåÂàôÊâÄÊúâkeyÁöÑslot‰∏ÄÂÆöÁõ∏Âêå</td>
</tr>
<tr>
<td>ËÄóÊó∂</td>
<td>NÊ¨°ÁΩëÁªúËÄóÊó∂ + NÊ¨°ÂëΩ‰ª§ËÄóÊó∂</td>
<td>mÊ¨°ÁΩëÁªúËÄóÊó∂ + NÊ¨°ÂëΩ‰ª§ËÄóÊó∂<br>(m &#x3D; keyÁöÑslot‰∏™Êï∞)</td>
<td>1Ê¨°ÁΩëÁªúËÄóÊó∂ + NÊ¨°ÂëΩ‰ª§ËÄóÊó∂</td>
<td>1Ê¨°ÁΩëÁªúËÄóÊó∂ + NÊ¨°ÂëΩ‰ª§ËÄóÊó∂</td>
</tr>
<tr>
<td>‰ºòÁÇπ</td>
<td>ÂÆûÁé∞ÁÆÄÂçï</td>
<td>ËÄóÊó∂ËæÉÁü≠</td>
<td>ËÄóÊó∂ÈùûÂ∏∏Áü≠</td>
<td>ËÄóÊó∂ÈùûÂ∏∏Áü≠„ÄÅÂÆûÁé∞ÁÆÄÂçï</td>
</tr>
<tr>
<td>Áº∫ÁÇπ</td>
<td>ËÄóÊó∂ÈùûÂ∏∏‰πÖ</td>
<td>ÂÆûÁé∞Á®çÂ§çÊùÇ</td>
<td>ÂÆûÁé∞Â§çÊùÇ</td>
<td>ÂÆπÊòìÂá∫Áé∞Êï∞ÊçÆÂÄæÊñú</td>
</tr>
</tbody></table>
<ul>
<li>Êé®Ëçê‰ΩøÁî®Âπ∂Ë°åslot</li>
</ul>
<h3 id="9-3-ÊúçÂä°Á´Ø‰ºòÂåñ"><a href="#9-3-ÊúçÂä°Á´Ø‰ºòÂåñ" class="headerlink" title="9.3 ÊúçÂä°Á´Ø‰ºòÂåñ"></a>9.3 ÊúçÂä°Á´Ø‰ºòÂåñ</h3><h4 id="9-3-1-ÊåÅ‰πÖÂåñÈÖçÁΩÆ"><a href="#9-3-1-ÊåÅ‰πÖÂåñÈÖçÁΩÆ" class="headerlink" title="9.3.1 ÊåÅ‰πÖÂåñÈÖçÁΩÆ"></a>9.3.1 ÊåÅ‰πÖÂåñÈÖçÁΩÆ</h4><p>RedisÁöÑÊåÅ‰πÖÂåñËôΩÁÑ∂ÂèØ‰ª•‰øùËØÅÊï∞ÊçÆÂÆâÂÖ®Ôºå‰ΩÜ‰πü‰ºöÂ∏¶Êù•ÂæàÂ§öÈ¢ùÂ§ñÁöÑÂºÄÈîÄÔºåÂõ†Ê≠§ÊåÅ‰πÖÂåñËØ∑ÈÅµÂæ™‰∏ãÂàóÂª∫ËÆÆÔºö</p>
<ul>
<li>Áî®Êù•ÂÅöÁºìÂ≠òÁöÑRedisÂÆû‰æãÂ∞ΩÈáè‰∏çË¶ÅÂºÄÂêØÊåÅ‰πÖÂåñÂäüËÉΩ</li>
<li>Âª∫ËÆÆÂÖ≥Èó≠RDBÊåÅ‰πÖÂåñÂäüËÉΩÔºå<strong>‰ΩøÁî®AOFÊåÅ‰πÖÂåñ</strong></li>
<li>Âà©Áî®ËÑöÊú¨ÂÆöÊúüÂú®slaveËäÇÁÇπÂÅöRDBÔºåÂÆûÁé∞Êï∞ÊçÆÂ§á‰ªΩ</li>
<li>ËÆæÁΩÆÂêàÁêÜÁöÑrewriteÈòàÂÄºÔºåÈÅøÂÖçÈ¢ëÁπÅÁöÑbgrewrite</li>
<li>ÈÖçÁΩÆno-appendfsync-on-rewrite &#x3D; yesÔºåÁ¶ÅÊ≠¢Âú®rewriteÊúüÈó¥ÂÅöaofÔºåÈÅøÂÖçÂõ†AOFÂºïËµ∑ÁöÑÈòªÂ°û</li>
<li>ÈÉ®ÁΩ≤ÊúâÂÖ≥Âª∫ËÆÆÔºö<ul>
<li>RedisÂÆû‰æãÁöÑÁâ©ÁêÜÊú∫Ë¶ÅÈ¢ÑÁïôË∂≥Â§üÂÜÖÂ≠òÔºåÂ∫îÂØπforkÂíårewrite</li>
<li>Âçï‰∏™RedisÂÆû‰æãÂÜÖÂ≠ò‰∏äÈôê‰∏çË¶ÅÂ§™Â§ßÔºå‰æãÂ¶Ç4GÊàñ8G„ÄÇÂèØ‰ª•Âä†Âø´forkÁöÑÈÄüÂ∫¶„ÄÅÂáèÂ∞ë‰∏ª‰ªéÂêåÊ≠•„ÄÅÊï∞ÊçÆËøÅÁßªÂéãÂäõ</li>
<li>‰∏çË¶Å‰∏éCPUÂØÜÈõÜÂûãÂ∫îÁî®ÈÉ®ÁΩ≤Âú®‰∏ÄËµ∑</li>
<li>‰∏çË¶Å‰∏éÈ´òÁ°¨ÁõòË¥üËΩΩÂ∫îÁî®‰∏ÄËµ∑ÈÉ®ÁΩ≤„ÄÇ‰æãÂ¶ÇÔºöÊï∞ÊçÆÂ∫ì„ÄÅÊ∂àÊÅØÈòüÂàó</li>
</ul>
</li>
</ul>
<h4 id="9-3-2-ÊÖ¢Êü•ËØ¢‰ºòÂåñ"><a href="#9-3-2-ÊÖ¢Êü•ËØ¢‰ºòÂåñ" class="headerlink" title="9.3.2 ÊÖ¢Êü•ËØ¢‰ºòÂåñ"></a>9.3.2 ÊÖ¢Êü•ËØ¢‰ºòÂåñ</h4><p>Âú®RedisÊâßË°åÊó∂ËÄóÊó∂Ë∂ÖËøáÊüê‰∏™ÈòàÂÄºÁöÑÂëΩ‰ª§ÔºåÁß∞‰∏∫ÊÖ¢Êü•ËØ¢„ÄÇ</p>
<ul>
<li><p><strong>ÊÖ¢Êü•ËØ¢ÁöÑÂç±ÂÆ≥</strong>ÔºöÁî±‰∫éRedisÊòØÂçïÁ∫øÁ®ãÁöÑÔºåÊâÄ‰ª•ÂΩìÂÆ¢Êà∑Á´ØÂèëÂá∫Êåá‰ª§ÂêéÔºå‰ªñ‰ª¨ÈÉΩ‰ºöËøõÂÖ•Âà∞redisÂ∫ïÂ±ÇÁöÑqueueÊù•ÊâßË°åÔºåÂ¶ÇÊûúÊ≠§Êó∂Êúâ‰∏Ä‰∫õÊÖ¢Êü•ËØ¢ÁöÑÊï∞ÊçÆÔºåÂ∞±‰ºöÂØºËá¥Â§ßÈáèËØ∑Ê±ÇÈòªÂ°ûÔºå‰ªéËÄåÂºïËµ∑Êä•ÈîôÔºåÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅËß£ÂÜ≥ÊÖ¢Êü•ËØ¢ÈóÆÈ¢ò„ÄÇ</p>
</li>
<li><p>ÊÖ¢Êü•ËØ¢ÁöÑÈòàÂÄºÂèØ‰ª•ÈÄöËøáÈÖçÁΩÆÊåáÂÆöÔºö</p>
<ul>
<li>slowlog-log-slower-thanÔºöÊÖ¢Êü•ËØ¢ÈòàÂÄºÔºåÂçï‰ΩçÊòØÂæÆÁßí„ÄÇÈªòËÆ§ÊòØ10000ÔºåÂª∫ËÆÆ1000</li>
</ul>
</li>
<li><p>ÊÖ¢Êü•ËØ¢‰ºöË¢´ÊîæÂÖ•ÊÖ¢Êü•ËØ¢Êó•Âøó‰∏≠ÔºåÊó•ÂøóÁöÑÈïøÂ∫¶Êúâ‰∏äÈôêÔºåÂèØ‰ª•ÈÄöËøáÈÖçÁΩÆÊåáÂÆöÔºö</p>
<ul>
<li>slowlog-max-lenÔºöÊÖ¢Êü•ËØ¢Êó•ÂøóÔºàÊú¨Ë¥®ÊòØ‰∏Ä‰∏™ÈòüÂàóÔºâÁöÑÈïøÂ∫¶„ÄÇÈªòËÆ§ÊòØ128ÔºåÂª∫ËÆÆ1000</li>
</ul>
</li>
</ul>
<p>Êü•ÁúãÊÖ¢Êü•ËØ¢Êó•ÂøóÂàóË°®:</p>
<ul>
<li>slowlog lenÔºöÊü•ËØ¢ÊÖ¢Êü•ËØ¢Êó•ÂøóÈïøÂ∫¶</li>
<li>slowlog get [n]ÔºöËØªÂèñnÊù°ÊÖ¢Êü•ËØ¢Êó•Âøó</li>
<li>slowlog resetÔºöÊ∏ÖÁ©∫ÊÖ¢Êü•ËØ¢ÂàóË°®</li>
</ul>
<h4 id="9-3-3-ÂëΩ‰ª§ÂèäÂÆâÂÖ®ÈÖçÁΩÆ"><a href="#9-3-3-ÂëΩ‰ª§ÂèäÂÆâÂÖ®ÈÖçÁΩÆ" class="headerlink" title="9.3.3 ÂëΩ‰ª§ÂèäÂÆâÂÖ®ÈÖçÁΩÆ"></a>9.3.3 ÂëΩ‰ª§ÂèäÂÆâÂÖ®ÈÖçÁΩÆ</h4><p>ÊºèÊ¥ûÂá∫Áé∞ÁöÑÊ†∏ÂøÉÁöÑÂéüÂõ†Êúâ‰ª•‰∏ãÂá†ÁÇπÔºö</p>
<ul>
<li>RedisÊú™ËÆæÁΩÆÂØÜÁ†Å</li>
<li>Âà©Áî®‰∫ÜRedisÁöÑconfig setÂëΩ‰ª§Âä®ÊÄÅ‰øÆÊîπRedisÈÖçÁΩÆ</li>
<li>‰ΩøÁî®‰∫ÜRootË¥¶Âè∑ÊùÉÈôêÂêØÂä®Redis</li>
</ul>
<p>‰∏∫‰∫ÜÈÅøÂÖçËøôÊ†∑ÁöÑÊºèÊ¥ûÔºåËøôÈáåÁªôÂá∫‰∏Ä‰∫õÂª∫ËÆÆÔºö</p>
<ul>
<li>Redis‰∏ÄÂÆöË¶ÅËÆæÁΩÆÂØÜÁ†Å</li>
<li>Á¶ÅÊ≠¢Á∫ø‰∏ä‰ΩøÁî®‰∏ãÈù¢ÂëΩ‰ª§Ôºökeys„ÄÅflushall„ÄÅflushdb„ÄÅconfig setÁ≠âÂëΩ‰ª§„ÄÇÂèØ‰ª•Âà©Áî®rename-commandÁ¶ÅÁî®„ÄÇ</li>
<li>bindÔºöÈôêÂà∂ÁΩëÂç°ÔºåÁ¶ÅÊ≠¢Â§ñÁΩëÁΩëÂç°ËÆøÈóÆ</li>
<li>ÂºÄÂêØÈò≤ÁÅ´Â¢ô</li>
<li>‰∏çË¶Å‰ΩøÁî®RootË¥¶Êà∑ÂêØÂä®Redis</li>
<li>Â∞ΩÈáè‰∏çÊòØÊúâÈªòËÆ§ÁöÑÁ´ØÂè£</li>
</ul>
<h4 id="9-3-4-ÂÜÖÂ≠òÈÖçÁΩÆ"><a href="#9-3-4-ÂÜÖÂ≠òÈÖçÁΩÆ" class="headerlink" title="9.3.4 ÂÜÖÂ≠òÈÖçÁΩÆ"></a>9.3.4 ÂÜÖÂ≠òÈÖçÁΩÆ</h4><p>ÂΩìRedisÂÜÖÂ≠ò‰∏çË∂≥Êó∂ÔºåÂèØËÉΩÂØºËá¥KeyÈ¢ëÁπÅË¢´Âà†Èô§„ÄÅÂìçÂ∫îÊó∂Èó¥ÂèòÈïø„ÄÅQPS‰∏çÁ®≥ÂÆöÁ≠âÈóÆÈ¢ò„ÄÇÂΩìÂÜÖÂ≠ò‰ΩøÁî®ÁéáËææÂà∞90%‰ª•‰∏äÊó∂Â∞±ÈúÄË¶ÅÊàë‰ª¨Ë≠¶ÊÉïÔºåÂπ∂Âø´ÈÄüÂÆö‰ΩçÂà∞ÂÜÖÂ≠òÂç†Áî®ÁöÑÂéüÂõ†„ÄÇ</p>
<table>
<thead>
<tr>
<th>ÂÜÖÂ≠òÁ±ªÂûã</th>
<th>ËØ¥Êòé</th>
</tr>
</thead>
<tbody><tr>
<td>Êï∞ÊçÆÂÜÖÂ≠ò</td>
<td>ÊòØRedisÊúÄ‰∏ªË¶ÅÁöÑÈÉ®ÂàÜÔºåÂ≠òÂÇ®RedisÁöÑÈîÆÂÄº‰ø°ÊÅØ„ÄÇ‰∏ªË¶ÅÈóÆÈ¢òÊòØBigKeyÈóÆÈ¢ò„ÄÅÂÜÖÂ≠òÁ¢éÁâáÈóÆÈ¢ò</td>
</tr>
<tr>
<td>ËøõÁ®ãÂÜÖÂ≠ò</td>
<td>Redis‰∏ªËøõÁ®ãÊú¨Ë∫´ËøêË°åËÇØÂÆöÈúÄË¶ÅÂç†Áî®ÂÜÖÂ≠òÔºåÂ¶Ç‰ª£Á†Å„ÄÅÂ∏∏ÈáèÊ±†Á≠âÔºõËøôÈÉ®ÂàÜÂÜÖÂ≠òÂ§ßÁ∫¶Âá†ÂÖÜÔºåÂú®Â§ßÂ§öÊï∞Áîü‰∫ßÁéØÂ¢É‰∏≠‰∏éRedisÊï∞ÊçÆÂç†Áî®ÁöÑÂÜÖÂ≠òÁõ∏ÊØîÂèØ‰ª•ÂøΩÁï•</td>
</tr>
<tr>
<td>ÁºìÂÜ≤Âå∫ÂÜÖÂ≠ò</td>
<td>‰∏ÄËà¨ÂåÖÊã¨ÂÆ¢Êà∑Á´ØÁºìÂÜ≤Âå∫„ÄÅAOFÁºìÂÜ≤Âå∫„ÄÅÂ§çÂà∂ÁºìÂÜ≤Âå∫Á≠â„ÄÇÂÆ¢Êà∑Á´ØÁºìÂÜ≤Âå∫ÂèàÂåÖÊã¨ËæìÂÖ•ÁºìÂÜ≤Âå∫ÂíåËæìÂá∫ÁºìÂÜ≤Âå∫‰∏§Áßç„ÄÇËøôÈÉ®ÂàÜÂÜÖÂ≠òÂç†Áî®Ê≥¢Âä®ËæÉÂ§ßÔºå‰∏çÂΩì‰ΩøÁî®BigKeyÂèØËÉΩÂØºËá¥ÂÜÖÂ≠òÊ∫¢Âá∫</td>
</tr>
</tbody></table>
<p>ÂÜÖÂ≠òÁºìÂÜ≤Âå∫Â∏∏ËßÅÁöÑÊúâ‰∏âÁßçÔºö</p>
<ul>
<li>Â§çÂà∂ÁºìÂÜ≤Âå∫Ôºö‰∏ª‰ªéÂ§çÂà∂ÁöÑrepl_backlog_bufÔºåÂ¶ÇÊûúÂ§™Â∞èÂèØËÉΩÂØºËá¥È¢ëÁπÅÁöÑÂÖ®ÈáèÂ§çÂà∂ÔºåÂΩ±ÂìçÊÄßËÉΩ„ÄÇÈÄöËøáreplbacklog-sizeÊù•ËÆæÁΩÆÔºåÈªòËÆ§1mb</li>
<li>AOFÁºìÂÜ≤Âå∫ÔºöAOFÂà∑Áõò‰πãÂâçÁöÑÁºìÂ≠òÂå∫ÂüüÔºåAOFÊâßË°årewriteÁöÑÁºìÂÜ≤Âå∫„ÄÇÊó†Ê≥ïËÆæÁΩÆÂÆπÈáè‰∏äÈôê</li>
<li>ÂÆ¢Êà∑Á´ØÁºìÂÜ≤Âå∫ÔºöÂàÜ‰∏∫ËæìÂÖ•ÁºìÂÜ≤Âå∫ÂíåËæìÂá∫ÁºìÂÜ≤Âå∫ÔºåËæìÂÖ•ÁºìÂÜ≤Âå∫ÊúÄÂ§ß1G‰∏î‰∏çËÉΩËÆæÁΩÆ„ÄÇËæìÂá∫ÁºìÂÜ≤Âå∫ÂèØ‰ª•ËÆæÁΩÆ</li>
</ul>
<h3 id="9-4-ÈõÜÁæ§ÊúÄ‰Ω≥ÂÆûË∑µ"><a href="#9-4-ÈõÜÁæ§ÊúÄ‰Ω≥ÂÆûË∑µ" class="headerlink" title="9.4 ÈõÜÁæ§ÊúÄ‰Ω≥ÂÆûË∑µ"></a>9.4 ÈõÜÁæ§ÊúÄ‰Ω≥ÂÆûË∑µ</h3><h4 id="9-4-1-ÈóÆÈ¢ò1„ÄÅÂú®RedisÁöÑÈªòËÆ§ÈÖçÁΩÆ‰∏≠ÔºåÂ¶ÇÊûúÂèëÁé∞‰ªªÊÑè‰∏Ä‰∏™ÊèíÊßΩ‰∏çÂèØÁî®ÔºåÂàôÊï¥‰∏™ÈõÜÁæ§ÈÉΩ‰ºöÂÅúÊ≠¢ÂØπÂ§ñÊúçÂä°Ôºö"><a href="#9-4-1-ÈóÆÈ¢ò1„ÄÅÂú®RedisÁöÑÈªòËÆ§ÈÖçÁΩÆ‰∏≠ÔºåÂ¶ÇÊûúÂèëÁé∞‰ªªÊÑè‰∏Ä‰∏™ÊèíÊßΩ‰∏çÂèØÁî®ÔºåÂàôÊï¥‰∏™ÈõÜÁæ§ÈÉΩ‰ºöÂÅúÊ≠¢ÂØπÂ§ñÊúçÂä°Ôºö" class="headerlink" title="9.4.1 ÈóÆÈ¢ò1„ÄÅÂú®RedisÁöÑÈªòËÆ§ÈÖçÁΩÆ‰∏≠ÔºåÂ¶ÇÊûúÂèëÁé∞‰ªªÊÑè‰∏Ä‰∏™ÊèíÊßΩ‰∏çÂèØÁî®ÔºåÂàôÊï¥‰∏™ÈõÜÁæ§ÈÉΩ‰ºöÂÅúÊ≠¢ÂØπÂ§ñÊúçÂä°Ôºö"></a>9.4.1 ÈóÆÈ¢ò1„ÄÅÂú®RedisÁöÑÈªòËÆ§ÈÖçÁΩÆ‰∏≠ÔºåÂ¶ÇÊûúÂèëÁé∞‰ªªÊÑè‰∏Ä‰∏™ÊèíÊßΩ‰∏çÂèØÁî®ÔºåÂàôÊï¥‰∏™ÈõÜÁæ§ÈÉΩ‰ºöÂÅúÊ≠¢ÂØπÂ§ñÊúçÂä°Ôºö</h4><ul>
<li>‰∏∫‰∫Ü‰øùËØÅÈ´òÂèØÁî®ÁâπÊÄßÔºåËøôÈáåÂª∫ËÆÆÂ∞Ü cluster-require-full-coverageÈÖçÁΩÆ‰∏∫false</li>
</ul>
<h4 id="9-4-2-ÈóÆÈ¢ò2„ÄÅÈõÜÁæ§Â∏¶ÂÆΩÈóÆÈ¢ò"><a href="#9-4-2-ÈóÆÈ¢ò2„ÄÅÈõÜÁæ§Â∏¶ÂÆΩÈóÆÈ¢ò" class="headerlink" title="9.4.2 ÈóÆÈ¢ò2„ÄÅÈõÜÁæ§Â∏¶ÂÆΩÈóÆÈ¢ò"></a>9.4.2 ÈóÆÈ¢ò2„ÄÅÈõÜÁæ§Â∏¶ÂÆΩÈóÆÈ¢ò</h4><p>ÈõÜÁæ§ËäÇÁÇπ‰πãÈó¥‰ºö‰∏çÊñ≠ÁöÑ‰∫íÁõ∏PingÊù•Á°ÆÂÆöÈõÜÁæ§‰∏≠ÂÖ∂ÂÆÉËäÇÁÇπÁöÑÁä∂ÊÄÅ„ÄÇÊØèÊ¨°PingÊê∫Â∏¶ÁöÑ‰ø°ÊÅØËá≥Â∞ëÂåÖÊã¨Ôºö</p>
<ul>
<li>ÊèíÊßΩ‰ø°ÊÅØ</li>
<li>ÈõÜÁæ§Áä∂ÊÄÅ‰ø°ÊÅØ</li>
</ul>
<p>ÈõÜÁæ§‰∏≠ËäÇÁÇπË∂äÂ§öÔºåÈõÜÁæ§Áä∂ÊÄÅ‰ø°ÊÅØÊï∞ÊçÆÈáè‰πüË∂äÂ§ßÔºå10‰∏™ËäÇÁÇπÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÂèØËÉΩËææÂà∞1kbÔºåÊ≠§Êó∂ÊØèÊ¨°ÈõÜÁæ§‰∫íÈÄöÈúÄË¶ÅÁöÑÂ∏¶ÂÆΩ‰ºöÈùûÂ∏∏È´òÔºåËøôÊ†∑‰ºöÂØºËá¥ÈõÜÁæ§‰∏≠Â§ßÈáèÁöÑÂ∏¶ÂÆΩÈÉΩ‰ºöË¢´ping‰ø°ÊÅØÊâÄÂç†Áî®ÔºåËøôÊòØ‰∏Ä‰∏™ÈùûÂ∏∏ÂèØÊÄïÁöÑÈóÆÈ¢òÔºåÊâÄ‰ª•Êàë‰ª¨ÈúÄË¶ÅÂéªËß£ÂÜ≥ËøôÊ†∑ÁöÑÈóÆÈ¢ò</p>
<p><strong>Ëß£ÂÜ≥ÈÄîÂæÑÔºö</strong></p>
<ul>
<li>ÈÅøÂÖçÂ§ßÈõÜÁæ§ÔºåÈõÜÁæ§ËäÇÁÇπÊï∞‰∏çË¶ÅÂ§™Â§öÔºåÊúÄÂ•ΩÂ∞ë‰∫é1000ÔºåÂ¶ÇÊûú‰∏öÂä°Â∫ûÂ§ßÔºåÂàôÂª∫Á´ãÂ§ö‰∏™ÈõÜÁæ§„ÄÇ</li>
<li>ÈÅøÂÖçÂú®Âçï‰∏™Áâ©ÁêÜÊú∫‰∏≠ËøêË°åÂ§™Â§öRedisÂÆû‰æã</li>
<li>ÈÖçÁΩÆÂêàÈÄÇÁöÑcluster-node-timeoutÂÄº</li>
</ul>
<h4 id="9-4-3-ÂÖ∂‰ªñÈóÆÈ¢ò"><a href="#9-4-3-ÂÖ∂‰ªñÈóÆÈ¢ò" class="headerlink" title="9.4.3 ÂÖ∂‰ªñÈóÆÈ¢ò"></a>9.4.3 ÂÖ∂‰ªñÈóÆÈ¢ò</h4><ul>
<li>Êï∞ÊçÆÂÄæÊñúÈóÆÈ¢ò</li>
<li>ÂÆ¢Êà∑Á´ØÊÄßËÉΩÈóÆÈ¢ò</li>
<li>ÂëΩ‰ª§ÁöÑÈõÜÁæ§ÂÖºÂÆπÊÄßÈóÆÈ¢ò</li>
<li>luaÂíå‰∫ãÂä°ÈóÆÈ¢ò</li>
</ul>
<p><strong>ÈÇ£Êàë‰ª¨Âà∞Â∫ïÊòØÈõÜÁæ§ËøòÊòØ‰∏ª‰ªé</strong></p>
<ul>
<li>Âçï‰ΩìRedisÔºà‰∏ª‰ªéRedisÔºâÂ∑≤ÁªèËÉΩËææÂà∞‰∏áÁ∫ßÂà´ÁöÑQPSÔºåÂπ∂‰∏î‰πüÂÖ∑Â§áÂæàÂº∫ÁöÑÈ´òÂèØÁî®ÁâπÊÄß„ÄÇÂ¶ÇÊûú‰∏ª‰ªéËÉΩÊª°Ë∂≥‰∏öÂä°ÈúÄÊ±ÇÁöÑÊÉÖÂÜµ‰∏ãÔºåÊâÄ‰ª•Â¶ÇÊûú‰∏çÊòØÂú®‰∏á‰∏çÂæóÂ∑≤ÁöÑÊÉÖÂÜµ‰∏ãÔºåÂ∞ΩÈáè‰∏çÊê≠Âª∫RedisÈõÜÁæ§</li>
</ul>
<h1 id="Âõõ-RedisÂéüÁêÜÁØá"><a href="#Âõõ-RedisÂéüÁêÜÁØá" class="headerlink" title="Âõõ. RedisÂéüÁêÜÁØá"></a>Âõõ. RedisÂéüÁêÜÁØá</h1><h2 id="1-RedisÊï∞ÊçÆÁªìÊûÑ"><a href="#1-RedisÊï∞ÊçÆÁªìÊûÑ" class="headerlink" title="1. RedisÊï∞ÊçÆÁªìÊûÑ"></a>1. RedisÊï∞ÊçÆÁªìÊûÑ</h2><h3 id="1-1-Âä®ÊÄÅÂ≠óÁ¨¶‰∏≤SDS"><a href="#1-1-Âä®ÊÄÅÂ≠óÁ¨¶‰∏≤SDS" class="headerlink" title="1.1 Âä®ÊÄÅÂ≠óÁ¨¶‰∏≤SDS"></a>1.1 Âä®ÊÄÅÂ≠óÁ¨¶‰∏≤SDS</h3><p>Êàë‰ª¨ÈÉΩÁü•ÈÅìRedis‰∏≠‰øùÂ≠òÁöÑKeyÊòØÂ≠óÁ¨¶‰∏≤ÔºåvalueÂæÄÂæÄÊòØÂ≠óÁ¨¶‰∏≤ÊàñËÄÖÂ≠óÁ¨¶‰∏≤ÁöÑÈõÜÂêà„ÄÇÂèØËßÅÂ≠óÁ¨¶‰∏≤ÊòØRedis‰∏≠ÊúÄÂ∏∏Áî®ÁöÑ‰∏ÄÁßçÊï∞ÊçÆÁªìÊûÑ„ÄÇ<br>RedisÊûÑÂª∫‰∫Ü‰∏ÄÁßçÊñ∞ÁöÑÂ≠óÁ¨¶‰∏≤ÁªìÊûÑÔºåÁß∞‰∏∫ÁÆÄÂçïÂä®ÊÄÅÂ≠óÁ¨¶‰∏≤ÔºàSimple Dynamic StringÔºâÔºåÁÆÄÁß∞SDS„ÄÇ</p>
<ul>
<li>‰æãÂ¶ÇÔºöRedisÂ∞ÜÂú®Â∫ïÂ±ÇÂàõÂª∫‰∏§‰∏™SDSÔºåÂÖ∂‰∏≠‰∏Ä‰∏™ÊòØÂåÖÂê´‚Äúname‚ÄùÁöÑSDSÔºåÂè¶‰∏Ä‰∏™ÊòØÂåÖÂê´‚ÄúËôéÂì•‚ÄùÁöÑSDS„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p>RedisÊòØCËØ≠Ë®ÄÂÆûÁé∞ÁöÑÔºåÂÖ∂‰∏≠SDSÊòØ‰∏Ä‰∏™ÁªìÊûÑ‰Ωì,Ê∫êÁ†ÅÂ¶Ç‰∏ãÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> __<span class="hljs-title">attribute__</span> ((__<span class="hljs-title">packed__</span>)) <span class="hljs-title">sdshdr8</span> &#123;</span><br>¬† ¬† <span class="hljs-type">uint8_t</span> len; <span class="hljs-comment">/* bufÂ∑≤‰øùÂ≠òÁöÑÂ≠óÁ¨¶‰∏≤Â≠óËäÇÊï∞Ôºå‰∏çÂåÖÂê´ÁªìÊùüÊ†áÁ§∫*/</span><br>¬† ¬† <span class="hljs-type">uint8_t</span> alloc; <span class="hljs-comment">/* bufÁî≥ËØ∑ÁöÑÊÄªÁöÑÂ≠óËäÇÊï∞Ôºå‰∏çÂåÖÂê´ÁªìÊùüÊ†áÁ§∫*/</span><br>¬† ¬† <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> flags; <span class="hljs-comment">/* ‰∏çÂêåSDSÁöÑÂ§¥Á±ªÂûãÔºåÁî®Êù•ÊéßÂà∂SDSÁöÑÂ§¥Â§ßÂ∞è</span><br><span class="hljs-comment">¬† ¬† char buf[];</span><br><span class="hljs-comment">&#125;;</span><br></code></pre></td></tr></table></figure>

<p>‰æãÂ¶ÇÔºå‰∏Ä‰∏™ÂåÖÂê´Â≠óÁ¨¶‰∏≤‚Äúname‚ÄùÁöÑsdsÁªìÊûÑÂ¶Ç‰∏ãÔºö</p>
<p><img src="/img/blogs/java/redis/4.1.2.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>SDS‰πãÊâÄ‰ª•Âè´ÂÅöÂä®ÊÄÅÂ≠óÁ¨¶‰∏≤ÔºåÊòØÂõ†‰∏∫ÂÆÉÂÖ∑Â§áÂä®ÊÄÅÊâ©ÂÆπÁöÑËÉΩÂäõÔºå‰æãÂ¶Ç‰∏Ä‰∏™ÂÜÖÂÆπ‰∏∫‚Äúhi‚ÄùÁöÑSDS</li>
<li>ÂÅáÂ¶ÇÊàë‰ª¨Ë¶ÅÁªôSDSËøΩÂä†‰∏ÄÊÆµÂ≠óÁ¨¶‰∏≤‚Äú,Amy‚ÄùÔºåËøôÈáåÈ¶ñÂÖà‰ºöÁî≥ËØ∑Êñ∞ÂÜÖÂ≠òÁ©∫Èó¥<ul>
<li>Â¶ÇÊûúÊñ∞Â≠óÁ¨¶‰∏≤Â∞è‰∫é1MÔºåÂàôÊñ∞Á©∫Èó¥‰∏∫Êâ©Â±ïÂêéÂ≠óÁ¨¶‰∏≤ÈïøÂ∫¶ÁöÑ‰∏§ÂÄç+1Ôºõ</li>
<li>Â¶ÇÊûúÊñ∞Â≠óÁ¨¶‰∏≤Â§ß‰∫é1MÔºåÂàôÊñ∞Á©∫Èó¥‰∏∫Êâ©Â±ïÂêéÂ≠óÁ¨¶‰∏≤ÈïøÂ∫¶+1M+1„ÄÇÁß∞‰∏∫ÂÜÖÂ≠òÈ¢ÑÂàÜÈÖç„ÄÇ</li>
</ul>
</li>
</ul>
<h3 id="1-2-IntSet"><a href="#1-2-IntSet" class="headerlink" title="1.2 IntSet"></a>1.2 IntSet</h3><p>IntSetÊòØRedis‰∏≠setÈõÜÂêàÁöÑ‰∏ÄÁßçÂÆûÁé∞ÊñπÂºèÔºåÂü∫‰∫éÊï¥Êï∞Êï∞ÁªÑÊù•ÂÆûÁé∞ÔºåÂπ∂‰∏îÂÖ∑Â§áÈïøÂ∫¶ÂèØÂèò„ÄÅÊúâÂ∫èÁ≠âÁâπÂæÅ„ÄÇ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">intset</span> &#123;</span><br>¬† ¬† <span class="hljs-type">uint32_t</span> encoding; <span class="hljs-comment">/* ÁºñÁ†ÅÊñπÂºèÔºåÊîØÊåÅÂ≠òÊîæ16‰Ωç„ÄÅ32‰Ωç„ÄÅ64‰ΩçÊï¥Êï∞*/</span><br>¬† ¬† <span class="hljs-type">uint32_t</span> length; <span class="hljs-comment">/* ÂÖÉÁ¥†‰∏™Êï∞ */</span><br>¬† ¬† <span class="hljs-type">int8_t</span> contents[]; <span class="hljs-comment">/* Êï¥Êï∞Êï∞ÁªÑÔºå‰øùÂ≠òÈõÜÂêàÊï∞ÊçÆ*/</span><br>&#125; intset;<br></code></pre></td></tr></table></figure>

<p>ÂÖ∂‰∏≠ÁöÑencodingÂåÖÂê´‰∏âÁßçÊ®°ÂºèÔºåË°®Á§∫Â≠òÂÇ®ÁöÑÊï¥Êï∞Â§ßÂ∞è‰∏çÂêåÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Note that these encodings are ordered, so:</span><br><span class="hljs-comment">¬†* INTSET_ENC_INT16 &lt; INTSET_ENC_INT32 &lt; INTSET_ENC_INT64. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT16 (sizeof(int16_t)) <span class="hljs-comment">/* 2Â≠óËäÇÊï¥Êï∞ÔºåËåÉÂõ¥Á±ª‰ººjavaÁöÑshort*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT32 (sizeof(int32_t)) <span class="hljs-comment">/* 4Â≠óËäÇÊï¥Êï∞ÔºåËåÉÂõ¥Á±ª‰ººjavaÁöÑint */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INTSET_ENC_INT64 (sizeof(int64_t)) <span class="hljs-comment">/* 8Â≠óËäÇÊï¥Êï∞ÔºåËåÉÂõ¥Á±ª‰ººjavaÁöÑlong */</span></span><br></code></pre></td></tr></table></figure>

<p>‰∏∫‰∫ÜÊñπ‰æøÊü•ÊâæÔºåRedis‰ºöÂ∞Üintset‰∏≠ÊâÄÊúâÁöÑÊï¥Êï∞ÊåâÁÖßÂçáÂ∫è‰æùÊ¨°‰øùÂ≠òÂú®contentsÊï∞ÁªÑ‰∏≠ÔºåÁªìÊûÑÂ¶ÇÂõæÔºö</p>
<p><img src="/img/blogs/java/redis/4.1.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="IntSetÂçáÁ∫ß"><a href="#IntSetÂçáÁ∫ß" class="headerlink" title="IntSetÂçáÁ∫ß"></a>IntSetÂçáÁ∫ß</h4><p>Êàë‰ª¨ÂêëËØ•ÂÖ∂‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Êï∞Â≠óÔºö50000ÔºåËøô‰∏™Êï∞Â≠óË∂ÖÂá∫‰∫Üint16_tÁöÑËåÉÂõ¥Ôºåintset‰ºöËá™Âä®ÂçáÁ∫ßÁºñÁ†ÅÊñπÂºèÂà∞ÂêàÈÄÇÁöÑÂ§ßÂ∞è„ÄÇ<br>‰ª•ÂΩìÂâçÊ°à‰æãÊù•ËØ¥ÊµÅÁ®ãÂ¶Ç‰∏ãÔºö</p>
<ul>
<li>ÂçáÁ∫ßÁºñÁ†Å‰∏∫INTSET_ENC_INT32, ÊØè‰∏™Êï¥Êï∞Âç†4Â≠óËäÇÔºåÂπ∂ÊåâÁÖßÊñ∞ÁöÑÁºñÁ†ÅÊñπÂºèÂèäÂÖÉÁ¥†‰∏™Êï∞Êâ©ÂÆπÊï∞ÁªÑ</li>
<li>ÂÄíÂ∫è‰æùÊ¨°Â∞ÜÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†Êã∑Ë¥ùÂà∞Êâ©ÂÆπÂêéÁöÑÊ≠£Á°Æ‰ΩçÁΩÆ</li>
<li>Â∞ÜÂæÖÊ∑ªÂä†ÁöÑÂÖÉÁ¥†ÊîæÂÖ•Êï∞ÁªÑÊú´Â∞æ</li>
<li>ÊúÄÂêéÔºåÂ∞ÜinsetÁöÑencodingÂ±ûÊÄßÊîπ‰∏∫INTSET_ENC_INT32ÔºåÂ∞ÜlengthÂ±ûÊÄßÊîπ‰∏∫4</li>
</ul>
<p>ÂéüÊú¨Ôºö</p>
<p><img src="/img/blogs/java/redis/4.1.4.png" srcset="/img/loading.gif" lazyload></p>
<p>Êâ©ÂÆπÂêéÔºö</p>
<p><img src="/img/blogs/java/redis/4.1.5.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ÊÄªÁªì</strong>ÔºöIntsetÂèØ‰ª•ÁúãÂÅöÊòØÁâπÊÆäÁöÑÊï¥Êï∞Êï∞ÁªÑÔºåÂÖ∑Â§á‰∏Ä‰∫õÁâπÁÇπÔºö</p>
<ul>
<li>Redis‰ºöÁ°Æ‰øùIntset‰∏≠ÁöÑÂÖÉÁ¥†ÂîØ‰∏Ä„ÄÅÊúâÂ∫è</li>
<li>ÂÖ∑Â§áÁ±ªÂûãÂçáÁ∫ßÊú∫Âà∂ÔºåÂèØ‰ª•ËäÇÁúÅÂÜÖÂ≠òÁ©∫Èó¥</li>
<li>Â∫ïÂ±ÇÈááÁî®‰∫åÂàÜÊü•ÊâæÊñπÂºèÊù•Êü•ËØ¢</li>
</ul>
<h3 id="1-3-Dict"><a href="#1-3-Dict" class="headerlink" title="1.3 Dict"></a>1.3 Dict</h3><p>Êàë‰ª¨Áü•ÈÅìRedisÊòØ‰∏Ä‰∏™ÈîÆÂÄºÂûãÔºàKey-Value PairÔºâÁöÑÊï∞ÊçÆÂ∫ìÔºåÊàë‰ª¨ÂèØ‰ª•Ê†πÊçÆÈîÆÂÆûÁé∞Âø´ÈÄüÁöÑÂ¢ûÂà†ÊîπÊü•„ÄÇËÄåÈîÆ‰∏éÂÄºÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÊ≠£ÊòØÈÄöËøáDictÊù•ÂÆûÁé∞ÁöÑ„ÄÇ</p>
<ul>
<li>DictÁî±‰∏âÈÉ®ÂàÜÁªÑÊàêÔºåÂàÜÂà´ÊòØÔºöÂìàÂ∏åË°®ÔºàDictHashTableÔºâ„ÄÅÂìàÂ∏åËäÇÁÇπÔºàDictEntryÔºâ„ÄÅÂ≠óÂÖ∏ÔºàDictÔºâ</li>
</ul>
<p>ÂΩìÊàë‰ª¨ÂêëDictÊ∑ªÂä†ÈîÆÂÄºÂØπÊó∂ÔºåRedisÈ¶ñÂÖàÊ†πÊçÆkeyËÆ°ÁÆóÂá∫hashÂÄºÔºàhÔºâÔºåÁÑ∂Âêé<strong>Âà©Áî® h &amp; sizemaskÊù•ËÆ°ÁÆóÂÖÉÁ¥†Â∫îËØ•Â≠òÂÇ®Âà∞Êï∞ÁªÑ‰∏≠ÁöÑÂì™‰∏™Á¥¢Âºï‰ΩçÁΩÆ</strong>„ÄÇ</p>
<ul>
<li>Êàë‰ª¨Â≠òÂÇ®k1&#x3D;v1ÔºåÂÅáËÆæk1ÁöÑÂìàÂ∏åÂÄºh &#x3D;1ÔºåÂàô1&amp;3 &#x3D;1ÔºåÂõ†Ê≠§k1&#x3D;v1Ë¶ÅÂ≠òÂÇ®Âà∞Êï∞ÁªÑËßíÊ†á1‰ΩçÁΩÆ„ÄÇ</li>
</ul>
<h4 id="DictÁöÑÊâ©ÂÆπ"><a href="#DictÁöÑÊâ©ÂÆπ" class="headerlink" title="DictÁöÑÊâ©ÂÆπ"></a>DictÁöÑÊâ©ÂÆπ</h4><p>Dict‰∏≠ÁöÑHashTableÂ∞±ÊòØÊï∞ÁªÑÁªìÂêàÂçïÂêëÈìæË°®ÁöÑÂÆûÁé∞ÔºåÂΩìÈõÜÂêà‰∏≠ÂÖÉÁ¥†ËæÉÂ§öÊó∂ÔºåÂøÖÁÑ∂ÂØºËá¥ÂìàÂ∏åÂÜ≤Á™ÅÂ¢ûÂ§öÔºåÈìæË°®ËøáÈïøÔºåÂàôÊü•ËØ¢ÊïàÁéá‰ºöÂ§ßÂ§ßÈôç‰Ωé„ÄÇ<br>DictÂú®ÊØèÊ¨°Êñ∞Â¢ûÈîÆÂÄºÂØπÊó∂ÈÉΩ‰ºöÊ£ÄÊü•Ë¥üËΩΩÂõ†Â≠êÔºàLoadFactor &#x3D; used&#x2F;sizeÔºâ ÔºåÊª°Ë∂≥‰ª•‰∏ã‰∏§ÁßçÊÉÖÂÜµÊó∂‰ºöËß¶ÂèëÂìàÂ∏åË°®Êâ©ÂÆπÔºö</p>
<ul>
<li>ÂìàÂ∏åË°®ÁöÑ LoadFactor &gt;&#x3D; 1ÔºåÂπ∂‰∏îÊúçÂä°Âô®Ê≤°ÊúâÊâßË°å BGSAVE ÊàñËÄÖ BGREWRITEAOF Á≠âÂêéÂè∞ËøõÁ®ãÔºõ</li>
<li>ÂìàÂ∏åË°®ÁöÑ LoadFactor &gt; 5 Ôºõ</li>
</ul>
<h4 id="DictÁöÑÊî∂Áº©"><a href="#DictÁöÑÊî∂Áº©" class="headerlink" title="DictÁöÑÊî∂Áº©"></a>DictÁöÑÊî∂Áº©</h4><p>DictÈô§‰∫ÜÊâ©ÂÆπ‰ª•Â§ñÔºåÊØèÊ¨°Âà†Èô§ÂÖÉÁ¥†Êó∂Ôºå‰πü‰ºöÂØπË¥üËΩΩÂõ†Â≠êÂÅöÊ£ÄÊü•ÔºåÂΩìLoadFactor &lt; 0.1 Êó∂Ôºå‰ºöÂÅöÂìàÂ∏åË°®Êî∂Áº©</p>
<h4 id="DictÁöÑrehash"><a href="#DictÁöÑrehash" class="headerlink" title="DictÁöÑrehash"></a>DictÁöÑrehash</h4><p>‰∏çÁÆ°ÊòØÊâ©ÂÆπËøòÊòØÊî∂Áº©ÔºåÂøÖÂÆö‰ºöÂàõÂª∫Êñ∞ÁöÑÂìàÂ∏åË°®ÔºåÂØºËá¥ÂìàÂ∏åË°®ÁöÑsizeÂíåsizemaskÂèòÂåñÔºåËÄåkeyÁöÑÊü•ËØ¢‰∏ésizemaskÊúâÂÖ≥„ÄÇÂõ†Ê≠§ÂøÖÈ°ªÂØπÂìàÂ∏åË°®‰∏≠ÁöÑÊØè‰∏Ä‰∏™keyÈáçÊñ∞ËÆ°ÁÆóÁ¥¢ÂºïÔºåÊèíÂÖ•Êñ∞ÁöÑÂìàÂ∏åË°®ÔºåËøô‰∏™ËøáÁ®ãÁß∞‰∏∫rehash„ÄÇËøáÁ®ãÊòØËøôÊ†∑ÁöÑÔºö</p>
<ul>
<li>ËÆ°ÁÆóÊñ∞hashË°®ÁöÑrealeSizeÔºåÂÄºÂèñÂÜ≥‰∫éÂΩìÂâçË¶ÅÂÅöÁöÑÊòØÊâ©ÂÆπËøòÊòØÊî∂Áº©Ôºö<ul>
<li>Â¶ÇÊûúÊòØÊâ©ÂÆπÔºåÂàôÊñ∞size‰∏∫Á¨¨‰∏Ä‰∏™Â§ß‰∫éÁ≠â‰∫édict.ht[0].used + 1ÁöÑ2^n</li>
<li>Â¶ÇÊûúÊòØÊî∂Áº©ÔºåÂàôÊñ∞size‰∏∫Á¨¨‰∏Ä‰∏™Â§ß‰∫éÁ≠â‰∫édict.ht[0].usedÁöÑ2^n Ôºà‰∏çÂæóÂ∞è‰∫é4Ôºâ</li>
</ul>
</li>
<li>ÊåâÁÖßÊñ∞ÁöÑrealeSizeÁî≥ËØ∑ÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂàõÂª∫dicthtÔºåÂπ∂ËµãÂÄºÁªôdict.ht[1]</li>
<li>ËÆæÁΩÆdict.rehashidx &#x3D; 0ÔºåÊ†áÁ§∫ÂºÄÂßãrehash</li>
<li>Â∞Üdict.ht[0]‰∏≠ÁöÑÊØè‰∏Ä‰∏™dictEntryÈÉΩrehashÂà∞dict.ht[1]</li>
<li>Â∞Üdict.ht[1]ËµãÂÄºÁªôdict.ht[0]ÔºåÁªôdict.ht[1]ÂàùÂßãÂåñ‰∏∫Á©∫ÂìàÂ∏åË°®ÔºåÈáäÊîæÂéüÊù•ÁöÑdict.ht[0]ÁöÑÂÜÖÂ≠ò</li>
<li>Â∞ÜrehashidxËµãÂÄº‰∏∫-1Ôºå‰ª£Ë°®rehashÁªìÊùü</li>
<li>Âú®rehashËøáÁ®ã‰∏≠ÔºåÊñ∞Â¢ûÊìç‰ΩúÔºåÂàôÁõ¥Êé•ÂÜôÂÖ•ht[1]ÔºåÊü•ËØ¢„ÄÅ‰øÆÊîπÂíåÂà†Èô§Âàô‰ºöÂú®dict.ht[0]Âíådict.ht[1]‰æùÊ¨°Êü•ÊâæÂπ∂ÊâßË°å„ÄÇËøôÊ†∑ÂèØ‰ª•Á°Æ‰øùht[0]ÁöÑÊï∞ÊçÆÂè™Âáè‰∏çÂ¢ûÔºåÈöèÁùÄrehashÊúÄÁªà‰∏∫Á©∫</li>
</ul>
<h4 id="ÊÄªÁªì-1"><a href="#ÊÄªÁªì-1" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h4><p>DictÁöÑÁªìÊûÑÔºö</p>
<ul>
<li>Á±ª‰ººjavaÁöÑHashTableÔºåÂ∫ïÂ±ÇÊòØÊï∞ÁªÑÂä†ÈìæË°®Êù•Ëß£ÂÜ≥ÂìàÂ∏åÂÜ≤Á™Å</li>
<li>DictÂåÖÂê´‰∏§‰∏™ÂìàÂ∏åË°®Ôºåht[0]Âπ≥Â∏∏Áî®Ôºåht[1]Áî®Êù•rehash</li>
</ul>
<p>DictÁöÑ‰º∏Áº©Ôºö</p>
<ul>
<li>ÂΩìLoadFactorÂ§ß‰∫é5ÊàñËÄÖLoadFactorÂ§ß‰∫é1Âπ∂‰∏îÊ≤°ÊúâÂ≠êËøõÁ®ã‰ªªÂä°Êó∂ÔºåDictÊâ©ÂÆπ</li>
<li>ÂΩìLoadFactorÂ∞è‰∫é0.1Êó∂ÔºåDictÊî∂Áº©</li>
<li>Êâ©ÂÆπÂ§ßÂ∞è‰∏∫Á¨¨‰∏Ä‰∏™Â§ß‰∫éÁ≠â‰∫éused + 1ÁöÑ2^n</li>
<li>Êî∂Áº©Â§ßÂ∞è‰∏∫Á¨¨‰∏Ä‰∏™Â§ß‰∫éÁ≠â‰∫éused ÁöÑ2^n</li>
<li>DictÈááÁî®Ê∏êËøõÂºèrehashÔºåÊØèÊ¨°ËÆøÈóÆDictÊó∂ÊâßË°å‰∏ÄÊ¨°rehash</li>
<li>rehashÊó∂ht[0]Âè™Âáè‰∏çÂ¢ûÔºåÊñ∞Â¢ûÊìç‰ΩúÂè™Âú®ht[1]ÊâßË°åÔºåÂÖ∂ÂÆÉÊìç‰ΩúÂú®‰∏§‰∏™ÂìàÂ∏åË°®</li>
</ul>
<h3 id="1-4-ZipList"><a href="#1-4-ZipList" class="headerlink" title="1.4 ZipList"></a>1.4 ZipList</h3><p>ZipList ÊòØ‰∏ÄÁßçÁâπÊÆäÁöÑ‚ÄúÂèåÁ´ØÈìæË°®‚Äù ÔºåÁî±‰∏ÄÁ≥ªÂàóÁâπÊÆäÁºñÁ†ÅÁöÑËøûÁª≠ÂÜÖÂ≠òÂùóÁªÑÊàê„ÄÇÂèØ‰ª•Âú®‰ªªÊÑè‰∏ÄÁ´ØËøõË°åÂéãÂÖ•&#x2F;ÂºπÂá∫Êìç‰Ωú, Âπ∂‰∏îËØ•Êìç‰ΩúÁöÑÊó∂Èó¥Â§çÊùÇÂ∫¶‰∏∫ O(1)„ÄÇ</p>
<p><img src="/img/blogs/java/redis/4.1.6.png" srcset="/img/loading.gif" lazyload></p>
<table>
<thead>
<tr>
<th><strong>Â±ûÊÄß</strong></th>
<th><strong>Á±ªÂûã</strong></th>
<th><strong>ÈïøÂ∫¶</strong></th>
<th><strong>Áî®ÈÄî</strong></th>
</tr>
</thead>
<tbody><tr>
<td>zlbytes</td>
<td>uint32_t</td>
<td>4 Â≠óËäÇ</td>
<td>ËÆ∞ÂΩïÊï¥‰∏™ÂéãÁº©ÂàóË°®Âç†Áî®ÁöÑÂÜÖÂ≠òÂ≠óËäÇÊï∞</td>
</tr>
<tr>
<td>zltail</td>
<td>uint32_t</td>
<td>4 Â≠óËäÇ</td>
<td>ËÆ∞ÂΩïÂéãÁº©ÂàóË°®Ë°®Â∞æËäÇÁÇπË∑ùÁ¶ªÂéãÁº©ÂàóË°®ÁöÑËµ∑ÂßãÂú∞ÂùÄÊúâÂ§öÂ∞ëÂ≠óËäÇÔºåÈÄöËøáËøô‰∏™ÂÅèÁßªÈáèÔºåÂèØ‰ª•Á°ÆÂÆöË°®Â∞æËäÇÁÇπÁöÑÂú∞ÂùÄ„ÄÇ</td>
</tr>
<tr>
<td>zllen</td>
<td>uint16_t</td>
<td>2 Â≠óËäÇ</td>
<td>ËÆ∞ÂΩï‰∫ÜÂéãÁº©ÂàóË°®ÂåÖÂê´ÁöÑËäÇÁÇπÊï∞Èáè„ÄÇ ÊúÄÂ§ßÂÄº‰∏∫UINT16_MAX Ôºà65534ÔºâÔºåÂ¶ÇÊûúË∂ÖËøáËøô‰∏™ÂÄºÔºåÊ≠§Â§Ñ‰ºöËÆ∞ÂΩï‰∏∫65535Ôºå‰ΩÜËäÇÁÇπÁöÑÁúüÂÆûÊï∞ÈáèÈúÄË¶ÅÈÅçÂéÜÊï¥‰∏™ÂéãÁº©ÂàóË°®ÊâçËÉΩËÆ°ÁÆóÂæóÂá∫„ÄÇ</td>
</tr>
<tr>
<td>entry</td>
<td>ÂàóË°®ËäÇÁÇπ</td>
<td>‰∏çÂÆö</td>
<td>ÂéãÁº©ÂàóË°®ÂåÖÂê´ÁöÑÂêÑ‰∏™ËäÇÁÇπÔºåËäÇÁÇπÁöÑÈïøÂ∫¶Áî±ËäÇÁÇπ‰øùÂ≠òÁöÑÂÜÖÂÆπÂÜ≥ÂÆö„ÄÇ</td>
</tr>
<tr>
<td>zlend</td>
<td>uint8_t</td>
<td>1 Â≠óËäÇ</td>
<td>ÁâπÊÆäÂÄº 0xFF ÔºàÂçÅËøõÂà∂ 255 ÔºâÔºåÁî®‰∫éÊ†áËÆ∞ÂéãÁº©ÂàóË°®ÁöÑÊú´Á´Ø„ÄÇ</td>
</tr>
</tbody></table>
<h4 id="ZipListEntry"><a href="#ZipListEntry" class="headerlink" title="ZipListEntry"></a>ZipListEntry</h4><p>ZipList ‰∏≠ÁöÑEntryÂπ∂‰∏çÂÉèÊôÆÈÄöÈìæË°®ÈÇ£Ê†∑ËÆ∞ÂΩïÂâçÂêéËäÇÁÇπÁöÑÊåáÈíàÔºåÂõ†‰∏∫ËÆ∞ÂΩï‰∏§‰∏™ÊåáÈíàË¶ÅÂç†Áî®16‰∏™Â≠óËäÇÔºåÊµ™Ë¥πÂÜÖÂ≠ò„ÄÇËÄåÊòØÈááÁî®‰∫Ü‰∏ãÈù¢ÁöÑÁªìÊûÑÔºö</p>
<p><img src="/img/blogs/java/redis/4.1.7.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>previous_entry_lengthÔºöÂâç‰∏ÄËäÇÁÇπÁöÑÈïøÂ∫¶ÔºåÂç†1‰∏™Êàñ5‰∏™Â≠óËäÇ„ÄÇ<ul>
<li>Â¶ÇÊûúÂâç‰∏ÄËäÇÁÇπÁöÑÈïøÂ∫¶Â∞è‰∫é254Â≠óËäÇÔºåÂàôÈááÁî®1‰∏™Â≠óËäÇÊù•‰øùÂ≠òËøô‰∏™ÈïøÂ∫¶ÂÄº</li>
<li>Â¶ÇÊûúÂâç‰∏ÄËäÇÁÇπÁöÑÈïøÂ∫¶Â§ß‰∫é254Â≠óËäÇÔºåÂàôÈááÁî®5‰∏™Â≠óËäÇÊù•‰øùÂ≠òËøô‰∏™ÈïøÂ∫¶ÂÄºÔºåÁ¨¨‰∏Ä‰∏™Â≠óËäÇ‰∏∫0xfeÔºåÂêéÂõõ‰∏™Â≠óËäÇÊâçÊòØÁúüÂÆûÈïøÂ∫¶Êï∞ÊçÆ</li>
</ul>
</li>
<li>encodingÔºöÁºñÁ†ÅÂ±ûÊÄßÔºåËÆ∞ÂΩïcontentÁöÑÊï∞ÊçÆÁ±ªÂûãÔºàÂ≠óÁ¨¶‰∏≤ËøòÊòØÊï¥Êï∞Ôºâ‰ª•ÂèäÈïøÂ∫¶ÔºåÂç†Áî®1‰∏™„ÄÅ2‰∏™Êàñ5‰∏™Â≠óËäÇ</li>
<li>contentsÔºöË¥üË¥£‰øùÂ≠òËäÇÁÇπÁöÑÊï∞ÊçÆÔºåÂèØ‰ª•ÊòØÂ≠óÁ¨¶‰∏≤ÊàñÊï¥Êï∞</li>
</ul>
<h4 id="ZipListÁöÑËøûÈîÅÊõ¥Êñ∞ÈóÆÈ¢ò"><a href="#ZipListÁöÑËøûÈîÅÊõ¥Êñ∞ÈóÆÈ¢ò" class="headerlink" title="ZipListÁöÑËøûÈîÅÊõ¥Êñ∞ÈóÆÈ¢ò"></a>ZipListÁöÑËøûÈîÅÊõ¥Êñ∞ÈóÆÈ¢ò</h4><p>Áé∞Âú®ÔºåÂÅáËÆæÊàë‰ª¨ÊúâN‰∏™ËøûÁª≠ÁöÑ„ÄÅÈïøÂ∫¶‰∏∫250~253Â≠óËäÇ‰πãÈó¥ÁöÑentryÔºåÂõ†Ê≠§entryÁöÑprevious_entry_lengthÂ±ûÊÄßÁî®1‰∏™Â≠óËäÇÂç≥ÂèØË°®Á§∫ÔºåÂ¶ÇÂõæÊâÄÁ§∫Ôºö</p>
<p><img src="/img/blogs/java/redis/4.1.8.png" srcset="/img/loading.gif" lazyload></p>
<p>ZipListËøôÁßçÁâπÊÆäÊÉÖÂÜµ‰∏ã‰∫ßÁîüÁöÑËøûÁª≠Â§öÊ¨°Á©∫Èó¥Êâ©Â±ïÊìç‰ΩúÁß∞‰πã‰∏∫ËøûÈîÅÊõ¥Êñ∞ÔºàCascade UpdateÔºâ„ÄÇÊñ∞Â¢û„ÄÅÂà†Èô§ÈÉΩÂèØËÉΩÂØºËá¥ËøûÈîÅÊõ¥Êñ∞ÁöÑÂèëÁîü„ÄÇ</p>
<h4 id="ÊÄªÁªì-2"><a href="#ÊÄªÁªì-2" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h4><p><strong>ZipListÁâπÊÄßÔºö</strong></p>
<ul>
<li>ÂéãÁº©ÂàóË°®ÁöÑÂèØ‰ª•ÁúãÂÅö‰∏ÄÁßçËøûÁª≠ÂÜÖÂ≠òÁ©∫Èó¥ÁöÑ‚ÄùÂèåÂêëÈìæË°®‚Äù</li>
<li>ÂàóË°®ÁöÑËäÇÁÇπ‰πãÈó¥‰∏çÊòØÈÄöËøáÊåáÈíàËøûÊé•ÔºåËÄåÊòØËÆ∞ÂΩï‰∏ä‰∏ÄËäÇÁÇπÂíåÊú¨ËäÇÁÇπÈïøÂ∫¶Êù•ÂØªÂùÄÔºåÂÜÖÂ≠òÂç†Áî®ËæÉ‰Ωé</li>
<li>Â¶ÇÊûúÂàóË°®Êï∞ÊçÆËøáÂ§öÔºåÂØºËá¥ÈìæË°®ËøáÈïøÔºåÂèØËÉΩÂΩ±ÂìçÊü•ËØ¢ÊÄßËÉΩ</li>
<li>Â¢ûÊàñÂà†ËæÉÂ§ßÊï∞ÊçÆÊó∂ÊúâÂèØËÉΩÂèëÁîüËøûÁª≠Êõ¥Êñ∞ÈóÆÈ¢ò</li>
</ul>
<h3 id="1-5-QuickList"><a href="#1-5-QuickList" class="headerlink" title="1.5 QuickList"></a>1.5 QuickList</h3><ul>
<li><p>ÈóÆÈ¢ò1ÔºöZipListËôΩÁÑ∂ËäÇÁúÅÂÜÖÂ≠òÔºå‰ΩÜÁî≥ËØ∑ÂÜÖÂ≠òÂøÖÈ°ªÊòØËøûÁª≠Á©∫Èó¥ÔºåÂ¶ÇÊûúÂÜÖÂ≠òÂç†Áî®ËæÉÂ§öÔºåÁî≥ËØ∑ÂÜÖÂ≠òÊïàÁéáÂæà‰Ωé„ÄÇÊÄé‰πàÂäûÔºü</p>
<ul>
<li>Á≠îÔºö‰∏∫‰∫ÜÁºìËß£Ëøô‰∏™ÈóÆÈ¢òÔºåÊàë‰ª¨ÂøÖÈ°ªÈôêÂà∂ZipListÁöÑÈïøÂ∫¶ÂíåentryÂ§ßÂ∞è„ÄÇ</li>
</ul>
</li>
<li><p>ÈóÆÈ¢ò2Ôºö‰ΩÜÊòØÊàë‰ª¨Ë¶ÅÂ≠òÂÇ®Â§ßÈáèÊï∞ÊçÆÔºåË∂ÖÂá∫‰∫ÜZipListÊúÄ‰Ω≥ÁöÑ‰∏äÈôêËØ•ÊÄé‰πàÂäûÔºü</p>
<ul>
<li>Á≠îÔºöÊàë‰ª¨ÂèØ‰ª•ÂàõÂª∫Â§ö‰∏™ZipListÊù•ÂàÜÁâáÂ≠òÂÇ®Êï∞ÊçÆ„ÄÇ</li>
</ul>
</li>
<li><p>ÈóÆÈ¢ò3ÔºöÊï∞ÊçÆÊãÜÂàÜÂêéÊØîËæÉÂàÜÊï£Ôºå‰∏çÊñπ‰æøÁÆ°ÁêÜÂíåÊü•ÊâæÔºåËøôÂ§ö‰∏™ZipListÂ¶Ç‰ΩïÂª∫Á´ãËÅîÁ≥ªÔºü</p>
<ul>
<li>Á≠îÔºöRedisÂú®3.2ÁâàÊú¨ÂºïÂÖ•‰∫ÜÊñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑQuickListÔºåÂÆÉÊòØ‰∏Ä‰∏™ÂèåÁ´ØÈìæË°®ÔºåÂè™‰∏çËøáÈìæË°®‰∏≠ÁöÑÊØè‰∏™ËäÇÁÇπÈÉΩÊòØ‰∏Ä‰∏™ZipList„ÄÇ</li>
</ul>
</li>
<li><p>‰∏∫‰∫ÜÈÅøÂÖçQuickList‰∏≠ÁöÑÊØè‰∏™ZipList‰∏≠entryËøáÂ§öÔºåRedisÊèê‰æõ‰∫Ü‰∏Ä‰∏™ÈÖçÁΩÆÈ°πÔºölist-max-ziplist-sizeÊù•ÈôêÂà∂„ÄÇ</p>
</li>
<li><p>Èô§‰∫ÜÊéßÂà∂ZipListÁöÑÂ§ßÂ∞èÔºåQuickListËøòÂèØ‰ª•ÂØπËäÇÁÇπÁöÑZipListÂÅöÂéãÁº©„ÄÇÈÄöËøáÈÖçÁΩÆÈ°πlist-compress-depthÊù•ÊéßÂà∂</p>
</li>
</ul>
<p><strong>QuickListÁöÑÁâπÁÇπ</strong>Ôºö</p>
<ul>
<li>ÊòØ‰∏Ä‰∏™ËäÇÁÇπ‰∏∫ZipListÁöÑÂèåÁ´ØÈìæË°®</li>
<li>ËäÇÁÇπÈááÁî®ZipListÔºåËß£ÂÜ≥‰∫Ü‰º†ÁªüÈìæË°®ÁöÑÂÜÖÂ≠òÂç†Áî®ÈóÆÈ¢ò</li>
<li>ÊéßÂà∂‰∫ÜZipListÂ§ßÂ∞èÔºåËß£ÂÜ≥ËøûÁª≠ÂÜÖÂ≠òÁ©∫Èó¥Áî≥ËØ∑ÊïàÁéáÈóÆÈ¢ò</li>
<li>‰∏≠Èó¥ËäÇÁÇπÂèØ‰ª•ÂéãÁº©ÔºåËøõ‰∏ÄÊ≠•ËäÇÁúÅ‰∫ÜÂÜÖÂ≠ò</li>
</ul>
<h3 id="1-6-SkipList"><a href="#1-6-SkipList" class="headerlink" title="1.6 SkipList"></a>1.6 SkipList</h3><p>SkipListÔºàË∑≥Ë°®ÔºâÈ¶ñÂÖàÊòØÈìæË°®Ôºå‰ΩÜ‰∏é‰º†ÁªüÈìæË°®Áõ∏ÊØîÊúâÂá†ÁÇπÂ∑ÆÂºÇÔºö</p>
<ul>
<li>ÂÖÉÁ¥†ÊåâÁÖßÂçáÂ∫èÊéíÂàóÂ≠òÂÇ®</li>
<li>ËäÇÁÇπÂèØËÉΩÂåÖÂê´Â§ö‰∏™ÊåáÈíàÔºåÊåáÈíàË∑®Â∫¶‰∏çÂêå„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.9.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>SkipListÁöÑÁâπÁÇπ</strong>Ôºö</p>
<ul>
<li>Ë∑≥Ë∑ÉË°®ÊòØ‰∏Ä‰∏™ÂèåÂêëÈìæË°®ÔºåÊØè‰∏™ËäÇÁÇπÈÉΩÂåÖÂê´scoreÂíåeleÂÄº</li>
<li>ËäÇÁÇπÊåâÁÖßscoreÂÄºÊéíÂ∫èÔºåscoreÂÄº‰∏ÄÊ†∑ÂàôÊåâÁÖßeleÂ≠óÂÖ∏ÊéíÂ∫è</li>
<li>ÊØè‰∏™ËäÇÁÇπÈÉΩÂèØ‰ª•ÂåÖÂê´Â§öÂ±ÇÊåáÈíàÔºåÂ±ÇÊï∞ÊòØ1Âà∞32‰πãÈó¥ÁöÑÈöèÊú∫Êï∞</li>
<li>‰∏çÂêåÂ±ÇÊåáÈíàÂà∞‰∏ã‰∏Ä‰∏™ËäÇÁÇπÁöÑË∑®Â∫¶‰∏çÂêåÔºåÂ±ÇÁ∫ßË∂äÈ´òÔºåË∑®Â∫¶Ë∂äÂ§ß</li>
<li>Â¢ûÂà†ÊîπÊü•ÊïàÁéá‰∏éÁ∫¢ÈªëÊ†ëÂü∫Êú¨‰∏ÄËá¥ÔºåÂÆûÁé∞Âç¥Êõ¥ÁÆÄÂçï</li>
</ul>
<h3 id="1-7-RedisObject"><a href="#1-7-RedisObject" class="headerlink" title="1.7 RedisObject"></a>1.7 RedisObject</h3><p>Redis‰∏≠ÁöÑ‰ªªÊÑèÊï∞ÊçÆÁ±ªÂûãÁöÑÈîÆÂíåÂÄºÈÉΩ‰ºöË¢´Â∞ÅË£Ö‰∏∫‰∏Ä‰∏™RedisObjectÔºå‰πüÂè´ÂÅöRedisÂØπË±°</p>
<p><img src="/img/blogs/java/redis/4.1.10.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-8-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-String"><a href="#1-8-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-String" class="headerlink" title="1.8 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-String"></a>1.8 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-String</h3><p>StringÊòØRedis‰∏≠ÊúÄÂ∏∏ËßÅÁöÑÊï∞ÊçÆÂ≠òÂÇ®Á±ªÂûãÔºö</p>
<ul>
<li>ÂÖ∂Âü∫Êú¨ÁºñÁ†ÅÊñπÂºèÊòØ<strong>RAW</strong>ÔºåÂü∫‰∫éÁÆÄÂçïÂä®ÊÄÅÂ≠óÁ¨¶‰∏≤ÔºàSDSÔºâÂÆûÁé∞ÔºåÂ≠òÂÇ®‰∏äÈôê‰∏∫512mb„ÄÇ</li>
<li>Â¶ÇÊûúÂ≠òÂÇ®ÁöÑSDSÈïøÂ∫¶Â∞è‰∫é44Â≠óËäÇÔºåÂàô‰ºöÈááÁî®<strong>EMBSTRÁºñÁ†Å</strong>ÔºåÊ≠§Êó∂object head‰∏éSDSÊòØ‰∏ÄÊÆµËøûÁª≠Á©∫Èó¥„ÄÇÁî≥ËØ∑ÂÜÖÂ≠òÊó∂Âè™ÈúÄË¶ÅË∞ÉÁî®‰∏ÄÊ¨°ÂÜÖÂ≠òÂàÜÈÖçÂáΩÊï∞ÔºåÊïàÁéáÊõ¥È´ò„ÄÇ</li>
<li>Â¶ÇÊûúÂ≠òÂÇ®ÁöÑÂ≠óÁ¨¶‰∏≤ÊòØÊï¥Êï∞ÂÄºÔºåÂπ∂‰∏îÂ§ßÂ∞èÂú®LONG_MAXËåÉÂõ¥ÂÜÖÔºåÂàô‰ºöÈááÁî®<strong>INTÁºñÁ†Å</strong>ÔºöÁõ¥Êé•Â∞ÜÊï∞ÊçÆ‰øùÂ≠òÂú®RedisObjectÁöÑptrÊåáÈíà‰ΩçÁΩÆÔºàÂàöÂ•Ω8Â≠óËäÇÔºâÔºå‰∏çÂÜçÈúÄË¶ÅSDS‰∫Ü„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.11.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-9-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-List"><a href="#1-9-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-List" class="headerlink" title="1.9 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-List"></a>1.9 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-List</h3><p>RedisÁöÑListÁ±ªÂûãÂèØ‰ª•‰ªéÈ¶ñ„ÄÅÂ∞æÊìç‰ΩúÂàóË°®‰∏≠ÁöÑÂÖÉÁ¥†Ôºö</p>
<ul>
<li>Âú®3.2ÁâàÊú¨‰πãÂâçÔºåRedisÈááÁî®ZipListÂíåLinkedListÊù•ÂÆûÁé∞ListÔºåÂΩìÂÖÉÁ¥†Êï∞ÈáèÂ∞è‰∫é512Âπ∂‰∏îÂÖÉÁ¥†Â§ßÂ∞èÂ∞è‰∫é64Â≠óËäÇÊó∂ÈááÁî®ZipListÁºñÁ†ÅÔºåË∂ÖËøáÂàôÈááÁî®LinkedListÁºñÁ†Å„ÄÇ</li>
<li>Âú®3.2ÁâàÊú¨‰πãÂêéÔºåRedisÁªü‰∏ÄÈááÁî®QuickListÊù•ÂÆûÁé∞List</li>
</ul>
<p><img src="/img/blogs/java/redis/4.1.12.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>LinkedList ÔºöÊôÆÈÄöÈìæË°®ÔºåÂèØ‰ª•‰ªéÂèåÁ´ØËÆøÈóÆÔºåÂÜÖÂ≠òÂç†Áî®ËæÉÈ´òÔºåÂÜÖÂ≠òÁ¢éÁâáËæÉÂ§ö</li>
<li>ZipList ÔºöÂéãÁº©ÂàóË°®ÔºåÂèØ‰ª•‰ªéÂèåÁ´ØËÆøÈóÆÔºåÂÜÖÂ≠òÂç†Áî®‰ΩéÔºåÂ≠òÂÇ®‰∏äÈôê‰Ωé</li>
<li>QuickListÔºöLinkedList + ZipListÔºåÂèØ‰ª•‰ªéÂèåÁ´ØËÆøÈóÆÔºåÂÜÖÂ≠òÂç†Áî®ËæÉ‰ΩéÔºåÂåÖÂê´Â§ö‰∏™ZipListÔºåÂ≠òÂÇ®‰∏äÈôêÈ´ò</li>
</ul>
<h3 id="1-10-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Set"><a href="#1-10-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Set" class="headerlink" title="1.10 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Set"></a>1.10 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Set</h3><p>SetÊòØRedis‰∏≠ÁöÑÂçïÂàóÈõÜÂêàÔºåÊª°Ë∂≥‰∏ãÂàóÁâπÁÇπÔºö</p>
<ul>
<li>‰∏ç‰øùËØÅÊúâÂ∫èÊÄß</li>
<li>‰øùËØÅÂÖÉÁ¥†ÂîØ‰∏Ä</li>
<li>Ê±Ç‰∫§ÈõÜ„ÄÅÂπ∂ÈõÜ„ÄÅÂ∑ÆÈõÜ</li>
</ul>
<p>‰ªÄ‰πàÊ†∑ÁöÑÊï∞ÊçÆÁªìÊûÑÂèØ‰ª•Êª°Ë∂≥Ôºü</p>
<ul>
<li>HashTableÔºå‰πüÂ∞±ÊòØRedis‰∏≠ÁöÑDictÔºå‰∏çËøáDictÊòØÂèåÂàóÈõÜÂêàÔºàÂèØ‰ª•Â≠òÈîÆ„ÄÅÂÄºÂØπÔºâ</li>
</ul>
<p>SetÊòØRedis‰∏≠ÁöÑÈõÜÂêàÔºå‰∏ç‰∏ÄÂÆöÁ°Æ‰øùÂÖÉÁ¥†ÊúâÂ∫èÔºåÂèØ‰ª•Êª°Ë∂≥ÂÖÉÁ¥†ÂîØ‰∏Ä„ÄÅÊü•ËØ¢ÊïàÁéáË¶ÅÊ±ÇÊûÅÈ´ò„ÄÇ</p>
<ul>
<li>‰∏∫‰∫ÜÊü•ËØ¢ÊïàÁéáÂíåÂîØ‰∏ÄÊÄßÔºåsetÈááÁî®HTÁºñÁ†ÅÔºàDictÔºâ„ÄÇDict‰∏≠ÁöÑkeyÁî®Êù•Â≠òÂÇ®ÂÖÉÁ¥†ÔºåvalueÁªü‰∏Ä‰∏∫null„ÄÇ</li>
<li>ÂΩìÂ≠òÂÇ®ÁöÑÊâÄÊúâÊï∞ÊçÆÈÉΩÊòØÊï¥Êï∞ÔºåÂπ∂‰∏îÂÖÉÁ¥†Êï∞Èáè‰∏çË∂ÖËøáset-max-intset-entriesÊó∂ÔºåSet‰ºöÈááÁî®IntSetÁºñÁ†ÅÔºå‰ª•ËäÇÁúÅÂÜÖÂ≠ò</li>
</ul>
<h3 id="1-11-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-ZSet"><a href="#1-11-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-ZSet" class="headerlink" title="1.11 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-ZSet"></a>1.11 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-ZSet</h3><p>ZSet‰πüÂ∞±ÊòØSortedSetÔºåÂÖ∂‰∏≠ÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÈúÄË¶ÅÊåáÂÆö‰∏Ä‰∏™scoreÂÄºÂíåmemberÂÄºÔºö</p>
<ul>
<li>ÂèØ‰ª•Ê†πÊçÆscoreÂÄºÊéíÂ∫èÂêé</li>
<li>memberÂøÖÈ°ªÂîØ‰∏Ä</li>
<li>ÂèØ‰ª•Ê†πÊçÆmemberÊü•ËØ¢ÂàÜÊï∞</li>
</ul>
<p>Âõ†Ê≠§ÔºåzsetÂ∫ïÂ±ÇÊï∞ÊçÆÁªìÊûÑÂøÖÈ°ªÊª°Ë∂≥ÈîÆÂÄºÂ≠òÂÇ®„ÄÅÈîÆÂøÖÈ°ªÂîØ‰∏Ä„ÄÅÂèØÊéíÂ∫èËøôÂá†‰∏™ÈúÄÊ±Ç„ÄÇ‰πãÂâçÂ≠¶‰π†ÁöÑÂì™ÁßçÁºñÁ†ÅÁªìÊûÑÂèØ‰ª•Êª°Ë∂≥Ôºü</p>
<ul>
<li><strong>SkipList</strong>ÔºöÂèØ‰ª•ÊéíÂ∫èÔºåÂπ∂‰∏îÂèØ‰ª•ÂêåÊó∂Â≠òÂÇ®scoreÂíåeleÂÄºÔºàmemberÔºâ</li>
<li><strong>HTÔºàDictÔºâ</strong>ÔºöÂèØ‰ª•ÈîÆÂÄºÂ≠òÂÇ®ÔºåÂπ∂‰∏îÂèØ‰ª•Ê†πÊçÆkeyÊâævalue</li>
</ul>
<p>ÂΩìÂÖÉÁ¥†Êï∞Èáè‰∏çÂ§öÊó∂ÔºåHTÂíåSkipListÁöÑ‰ºòÂäø‰∏çÊòéÊòæÔºåËÄå‰∏îÊõ¥ËÄóÂÜÖÂ≠ò„ÄÇÂõ†Ê≠§zsetËøò‰ºöÈááÁî®ZipListÁªìÊûÑÊù•ËäÇÁúÅÂÜÖÂ≠òÔºå‰∏çËøáÈúÄË¶ÅÂêåÊó∂Êª°Ë∂≥‰∏§‰∏™Êù°‰ª∂Ôºö</p>
<ul>
<li>ÂÖÉÁ¥†Êï∞ÈáèÂ∞è‰∫ézset_max_ziplist_entriesÔºåÈªòËÆ§ÂÄº128</li>
<li>ÊØè‰∏™ÂÖÉÁ¥†ÈÉΩÂ∞è‰∫ézset_max_ziplist_valueÂ≠óËäÇÔºåÈªòËÆ§ÂÄº64</li>
</ul>
<p>ziplistÊú¨Ë∫´Ê≤°ÊúâÊéíÂ∫èÂäüËÉΩÔºåËÄå‰∏îÊ≤°ÊúâÈîÆÂÄºÂØπÁöÑÊ¶ÇÂøµÔºåÂõ†Ê≠§ÈúÄË¶ÅÊúâzsetÈÄöËøáÁºñÁ†ÅÂÆûÁé∞Ôºö</p>
<ul>
<li>ZipListÊòØËøûÁª≠ÂÜÖÂ≠òÔºåÂõ†Ê≠§scoreÂíåelementÊòØÁ¥ßÊå®Âú®‰∏ÄËµ∑ÁöÑ‰∏§‰∏™entryÔºå elementÂú®ÂâçÔºåscoreÂú®Âêé</li>
<li>scoreË∂äÂ∞èË∂äÊé•ËøëÈòüÈ¶ñÔºåscoreË∂äÂ§ßË∂äÊé•ËøëÈòüÂ∞æÔºåÊåâÁÖßscoreÂÄºÂçáÂ∫èÊéíÂàó</li>
</ul>
<h3 id="1-12-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Hash"><a href="#1-12-RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Hash" class="headerlink" title="1.12 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Hash"></a>1.12 RedisÂü∫Êú¨Êï∞ÊçÆÁ±ªÂûã-Hash</h3><p>HashÁªìÊûÑ‰∏éRedis‰∏≠ÁöÑZsetÈùûÂ∏∏Á±ª‰ººÔºö</p>
<ul>
<li>ÈÉΩÊòØÈîÆÂÄºÂ≠òÂÇ®</li>
<li>ÈÉΩÈúÄÊ±ÇÊ†πÊçÆÈîÆËé∑ÂèñÂÄº</li>
<li>ÈîÆÂøÖÈ°ªÂîØ‰∏Ä</li>
</ul>
<p>Âå∫Âà´Â¶Ç‰∏ãÔºö</p>
<ul>
<li>zsetÁöÑÈîÆÊòØmemberÔºåÂÄºÊòØscoreÔºõhashÁöÑÈîÆÂíåÂÄºÈÉΩÊòØ‰ªªÊÑèÂÄº</li>
<li>zsetË¶ÅÊ†πÊçÆscoreÊéíÂ∫èÔºõhashÂàôÊó†ÈúÄÊéíÂ∫è</li>
</ul>
<p>Âõ†Ê≠§ÔºåHashÂ∫ïÂ±ÇÈááÁî®ÁöÑÁºñÁ†Å‰∏éZset‰πüÂü∫Êú¨‰∏ÄËá¥ÔºåÂè™ÈúÄË¶ÅÊääÊéíÂ∫èÊúâÂÖ≥ÁöÑSkipListÂéªÊéâÂç≥ÂèØ</p>
<ul>
<li>HashÁªìÊûÑÈªòËÆ§ÈááÁî®ZipListÁºñÁ†ÅÔºåÁî®‰ª•ËäÇÁúÅÂÜÖÂ≠ò„ÄÇ ZipList‰∏≠Áõ∏ÈÇªÁöÑ‰∏§‰∏™entry ÂàÜÂà´‰øùÂ≠òfieldÂíåvalue</li>
<li>ÂΩìÊï∞ÊçÆÈáèËæÉÂ§ßÊó∂ÔºåHashÁªìÊûÑ‰ºöËΩ¨‰∏∫HTÁºñÁ†ÅÔºå‰πüÂ∞±ÊòØDictÔºåËß¶ÂèëÊù°‰ª∂Êúâ‰∏§‰∏™Ôºö<ul>
<li>ZipList‰∏≠ÁöÑÂÖÉÁ¥†Êï∞ÈáèË∂ÖËøá‰∫Ühash-max-ziplist-entriesÔºàÈªòËÆ§512Ôºâ</li>
<li>ZipList‰∏≠ÁöÑ‰ªªÊÑèentryÂ§ßÂ∞èË∂ÖËøá‰∫Ühash-max-ziplist-valueÔºàÈªòËÆ§64Â≠óËäÇÔºâ</li>
</ul>
</li>
</ul>
<h2 id="2-RedisÁΩëÁªúÊ®°Âûã"><a href="#2-RedisÁΩëÁªúÊ®°Âûã" class="headerlink" title="2. RedisÁΩëÁªúÊ®°Âûã"></a>2. RedisÁΩëÁªúÊ®°Âûã</h2><h3 id="2-1-Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏ÊÄÅÁ©∫Èó¥"><a href="#2-1-Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏ÊÄÅÁ©∫Èó¥" class="headerlink" title="2.1 Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏ÊÄÅÁ©∫Èó¥"></a>2.1 Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏ÊÄÅÁ©∫Èó¥</h3><p>Áî®Êà∑ÁöÑÂ∫îÁî®ÔºåÊØîÂ¶ÇredisÔºåmysqlÁ≠âÂÖ∂ÂÆûÊòØÊ≤°ÊúâÂäûÊ≥ïÂéªÊâßË°åËÆøÈóÆÊàë‰ª¨Êìç‰ΩúÁ≥ªÁªüÁöÑÁ°¨‰ª∂ÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•ÈÄöËøáÂèëË°åÁâàÁöÑËøô‰∏™Â£≥Â≠êÂéªËÆøÈóÆÂÜÖÊ†∏ÔºåÂÜçÈÄöËøáÂÜÖÊ†∏ÂéªËÆøÈóÆËÆ°ÁÆóÊú∫Á°¨‰ª∂<br>ËÆ°ÁÆóÊú∫Á°¨‰ª∂ÂåÖÊã¨ÔºåÂ¶ÇcpuÔºåÂÜÖÂ≠òÔºåÁΩëÂç°Á≠âÁ≠âÔºåÂÜÖÊ†∏ÔºàÈÄöËøáÂØªÂùÄÁ©∫Èó¥ÔºâÂèØ‰ª•Êìç‰ΩúÁ°¨‰ª∂ÁöÑÔºå‰ΩÜÊòØÂÜÖÊ†∏ÈúÄË¶Å‰∏çÂêåËÆæÂ§áÁöÑÈ©±Âä®ÔºåÊúâ‰∫ÜËøô‰∫õÈ©±Âä®‰πãÂêéÔºåÂÜÖÊ†∏Â∞±ÂèØ‰ª•ÂéªÂØπËÆ°ÁÆóÊú∫Á°¨‰ª∂ÂéªËøõË°å ÂÜÖÂ≠òÁÆ°ÁêÜÔºåÊñá‰ª∂Á≥ªÁªüÁöÑÁÆ°ÁêÜÔºåËøõÁ®ãÁöÑÁÆ°ÁêÜÁ≠âÁ≠â</p>
<p><img src="/img/blogs/java/redis/4.2.1.png" srcset="/img/loading.gif" lazyload></p>
<p>‰∏∫‰∫ÜÈÅøÂÖçÁî®Êà∑Â∫îÁî®ÂØºËá¥ÂÜ≤Á™ÅÁîöËá≥ÂÜÖÊ†∏Â¥©Ê∫ÉÔºåÁî®Êà∑Â∫îÁî®‰∏éÂÜÖÊ†∏ÊòØÂàÜÁ¶ªÁöÑÔºö</p>
<ul>
<li>ËøõÁ®ãÁöÑÂØªÂùÄÁ©∫Èó¥ÂàíÂàÜÊàê‰∏§ÈÉ®ÂàÜÔºö<strong>ÂÜÖÊ†∏Á©∫Èó¥„ÄÅÁî®Êà∑Á©∫Èó¥</strong></li>
<li>Áî®Êà∑Á©∫Èó¥Âè™ËÉΩÊâßË°åÂèóÈôêÁöÑÂëΩ‰ª§ÔºàRing3ÔºâÔºåËÄå‰∏î‰∏çËÉΩÁõ¥Êé•Ë∞ÉÁî®Á≥ªÁªüËµÑÊ∫êÔºåÂøÖÈ°ªÈÄöËøáÂÜÖÊ†∏Êèê‰æõÁöÑÊé•Âè£Êù•ËÆø</li>
<li>ÂÜÖÊ†∏Á©∫Èó¥ÂèØ‰ª•ÊâßË°åÁâπÊùÉÂëΩ‰ª§ÔºàRing0ÔºâÔºåË∞ÉÁî®‰∏ÄÂàáÁ≥ªÁªüËµÑÊ∫ê</li>
</ul>
<p>LinuxÁ≥ªÁªü‰∏∫‰∫ÜÊèêÈ´òIOÊïàÁéáÔºå‰ºöÂú®Áî®Êà∑Á©∫Èó¥ÂíåÂÜÖÊ†∏Á©∫Èó¥ÈÉΩÂä†ÂÖ•ÁºìÂÜ≤Âå∫Ôºö</p>
<ul>
<li>ÂÜôÊï∞ÊçÆÊó∂ÔºåË¶ÅÊääÁî®Êà∑ÁºìÂÜ≤Êï∞ÊçÆÊã∑Ë¥ùÂà∞ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫ÔºåÁÑ∂ÂêéÂÜôÂÖ•ËÆæÂ§á</li>
<li>ËØªÊï∞ÊçÆÊó∂ÔºåË¶Å‰ªéËÆæÂ§áËØªÂèñÊï∞ÊçÆÂà∞ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫ÔºåÁÑ∂ÂêéÊã∑Ë¥ùÂà∞Áî®Êà∑ÁºìÂÜ≤Âå∫</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-ÈòªÂ°ûIO"><a href="#2-2-ÈòªÂ°ûIO" class="headerlink" title="2.2 ÈòªÂ°ûIO"></a>2.2 ÈòªÂ°ûIO</h3><p>ÊÄªÁªìÂΩíÁ∫≥‰∫Ü5ÁßçIOÊ®°ÂûãÔºö</p>
<ul>
<li>ÈòªÂ°ûIOÔºàBlocking IOÔºâ</li>
<li>ÈùûÈòªÂ°ûIOÔºàNonblocking IOÔºâ</li>
<li>IOÂ§öË∑ØÂ§çÁî®ÔºàIO MultiplexingÔºâ</li>
<li>‰ø°Âè∑È©±Âä®IOÔºàSignal Driven IOÔºâ</li>
<li>ÂºÇÊ≠•IOÔºàAsynchronous IOÔºâ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.3.png" srcset="/img/loading.gif" lazyload></p>
<p>Áî®Êà∑ÂéªËØªÂèñÊï∞ÊçÆÊó∂Ôºå‰ºöÂéªÂÖàÂèëËµ∑recvform‰∏Ä‰∏™ÂëΩ‰ª§ÔºåÂéªÂ∞ùËØï‰ªéÂÜÖÊ†∏‰∏äÂä†ËΩΩÊï∞ÊçÆÔºåÂ¶ÇÊûúÂÜÖÊ†∏Ê≤°ÊúâÊï∞ÊçÆÔºåÈÇ£‰πàÁî®Êà∑Â∞±‰ºöÁ≠âÂæÖÔºåÊ≠§Êó∂ÂÜÖÊ†∏‰ºöÂéª‰ªéÁ°¨‰ª∂‰∏äËØªÂèñÊï∞ÊçÆÔºåÂÜÖÊ†∏ËØªÂèñÊï∞ÊçÆ‰πãÂêéÔºå‰ºöÊääÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÊÄÅÔºåÂπ∂‰∏îËøîÂõûokÔºåÊï¥‰∏™ËøáÁ®ãÔºåÈÉΩÊòØÈòªÂ°ûÁ≠âÂæÖÁöÑÔºåËøôÂ∞±ÊòØÈòªÂ°ûIO<br>È°æÂêçÊÄù‰πâÔºåÈòªÂ°ûIOÂ∞±ÊòØ‰∏§‰∏™Èò∂ÊÆµÈÉΩÂøÖÈ°ªÈòªÂ°ûÁ≠âÂæÖÔºåÂÖ∑‰ΩìÊµÅÁ®ãÂ¶Ç‰∏ãÂõæÔºö</p>
<p><img src="/img/blogs/java/redis/4.2.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Èò∂ÊÆµ‰∏ÄÔºö</strong></p>
<ul>
<li>Áî®Êà∑ËøõÁ®ãÂ∞ùËØïËØªÂèñÊï∞ÊçÆÔºàÊØîÂ¶ÇÁΩëÂç°Êï∞ÊçÆÔºâ</li>
<li>Ê≠§Êó∂Êï∞ÊçÆÂ∞öÊú™Âà∞ËææÔºåÂÜÖÊ†∏ÈúÄË¶ÅÁ≠âÂæÖÊï∞ÊçÆ</li>
<li>Ê≠§Êó∂Áî®Êà∑ËøõÁ®ã‰πüÂ§Ñ‰∫éÈòªÂ°ûÁä∂ÊÄÅ</li>
</ul>
<p>Èò∂ÊÆµ‰∫åÔºö</p>
<ul>
<li>Êï∞ÊçÆÂà∞ËææÂπ∂Êã∑Ë¥ùÂà∞ÂÜÖÊ†∏ÁºìÂÜ≤Âå∫Ôºå‰ª£Ë°®Â∑≤Â∞±Áª™</li>
<li>Â∞ÜÂÜÖÊ†∏Êï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÁºìÂÜ≤Âå∫</li>
<li>Êã∑Ë¥ùËøáÁ®ã‰∏≠ÔºåÁî®Êà∑ËøõÁ®ã‰æùÁÑ∂ÈòªÂ°ûÁ≠âÂæÖ</li>
<li>Êã∑Ë¥ùÂÆåÊàêÔºåÁî®Êà∑ËøõÁ®ãËß£Èô§ÈòªÂ°ûÔºåÂ§ÑÁêÜÊï∞ÊçÆ</li>
</ul>
<p>ÂèØ‰ª•ÁúãÂà∞ÔºåÈòªÂ°ûIOÊ®°Âûã‰∏≠Ôºå<strong>Áî®Êà∑ËøõÁ®ãÂú®‰∏§‰∏™Èò∂ÊÆµÈÉΩÊòØÈòªÂ°ûÁä∂ÊÄÅ</strong>„ÄÇ</p>
<h3 id="2-3-ÈùûÈòªÂ°ûIO"><a href="#2-3-ÈùûÈòªÂ°ûIO" class="headerlink" title="2.3 ÈùûÈòªÂ°ûIO"></a>2.3 ÈùûÈòªÂ°ûIO</h3><p>È°æÂêçÊÄù‰πâÔºåÈùûÈòªÂ°ûIOÁöÑrecvfromÊìç‰Ωú‰ºö<strong>Á´ãÂç≥ËøîÂõûÁªìÊûú</strong>ËÄå‰∏çÊòØÈòªÂ°ûÁî®Êà∑ËøõÁ®ã„ÄÇ</p>
<p>Èò∂ÊÆµ‰∏ÄÔºö</p>
<ul>
<li>Áî®Êà∑ËøõÁ®ãÂ∞ùËØïËØªÂèñÊï∞ÊçÆÔºàÊØîÂ¶ÇÁΩëÂç°Êï∞ÊçÆÔºâ</li>
<li>Ê≠§Êó∂Êï∞ÊçÆÂ∞öÊú™Âà∞ËææÔºåÂÜÖÊ†∏ÈúÄË¶ÅÁ≠âÂæÖÊï∞ÊçÆ</li>
<li>ËøîÂõûÂºÇÂ∏∏ÁªôÁî®Êà∑ËøõÁ®ã</li>
<li>Áî®Êà∑ËøõÁ®ãÊãøÂà∞errorÂêéÔºåÂÜçÊ¨°Â∞ùËØïËØªÂèñ</li>
<li><strong>Âæ™ÁéØÂæÄÂ§çÔºåÁõ¥Âà∞Êï∞ÊçÆÂ∞±Áª™</strong></li>
</ul>
<p>Èò∂ÊÆµ‰∫åÔºö</p>
<ul>
<li>Â∞ÜÂÜÖÊ†∏Êï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑ÁºìÂÜ≤Âå∫</li>
<li>Êã∑Ë¥ùËøáÁ®ã‰∏≠ÔºåÁî®Êà∑ËøõÁ®ã‰æùÁÑ∂ÈòªÂ°ûÁ≠âÂæÖ</li>
<li>Êã∑Ë¥ùÂÆåÊàêÔºåÁî®Êà∑ËøõÁ®ãËß£Èô§ÈòªÂ°ûÔºåÂ§ÑÁêÜÊï∞ÊçÆ</li>
<li>ÂèØ‰ª•ÁúãÂà∞ÔºåÈùûÈòªÂ°ûIOÊ®°Âûã‰∏≠ÔºåÁî®Êà∑ËøõÁ®ãÂú®Á¨¨‰∏Ä‰∏™Èò∂ÊÆµÊòØÈùûÈòªÂ°ûÔºåÁ¨¨‰∫å‰∏™Èò∂ÊÆµÊòØÈòªÂ°ûÁä∂ÊÄÅ„ÄÇËôΩÁÑ∂ÊòØÈùûÈòªÂ°ûÔºå‰ΩÜÊÄßËÉΩÂπ∂Ê≤°ÊúâÂæóÂà∞ÊèêÈ´ò„ÄÇËÄå‰∏îÂøôÁ≠âÊú∫Âà∂‰ºöÂØºËá¥CPUÁ©∫ËΩ¨ÔºåCPU‰ΩøÁî®ÁéáÊö¥Â¢û„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-4-IOÂ§öË∑ØÂ§çÁî®"><a href="#2-4-IOÂ§öË∑ØÂ§çÁî®" class="headerlink" title="2.4 IOÂ§öË∑ØÂ§çÁî®"></a>2.4 IOÂ§öË∑ØÂ§çÁî®</h3><p>Êó†ËÆ∫ÊòØÈòªÂ°ûIOËøòÊòØÈùûÈòªÂ°ûIOÔºåÁî®Êà∑Â∫îÁî®Âú®‰∏ÄÈò∂ÊÆµÈÉΩÈúÄË¶ÅË∞ÉÁî®recvfromÊù•Ëé∑ÂèñÊï∞ÊçÆÔºåÂ∑ÆÂà´Âú®‰∫éÊó†Êï∞ÊçÆÊó∂ÁöÑÂ§ÑÁêÜÊñπÊ°àÔºö</p>
<ul>
<li><p>Â¶ÇÊûúË∞ÉÁî®recvfromÊó∂ÔºåÊÅ∞Â•ΩÊ≤°ÊúâÊï∞ÊçÆÔºåÈòªÂ°ûIO‰ºö‰ΩøCPUÈòªÂ°ûÔºåÈùûÈòªÂ°ûIO‰ΩøCPUÁ©∫ËΩ¨ÔºåÈÉΩ‰∏çËÉΩÂÖÖÂàÜÂèëÊå•CPUÁöÑ‰ΩúÁî®„ÄÇ</p>
</li>
<li><p>Â¶ÇÊûúË∞ÉÁî®recvfromÊó∂ÔºåÊÅ∞Â•ΩÊúâÊï∞ÊçÆÔºåÂàôÁî®Êà∑ËøõÁ®ãÂèØ‰ª•Áõ¥Êé•ËøõÂÖ•Á¨¨‰∫åÈò∂ÊÆµÔºåËØªÂèñÂπ∂Â§ÑÁêÜÊï∞ÊçÆ<br>ËÄåÂú®ÂçïÁ∫øÁ®ãÊÉÖÂÜµ‰∏ãÔºåÂè™ËÉΩ‰æùÊ¨°Â§ÑÁêÜIO‰∫ã‰ª∂ÔºåÂ¶ÇÊûúÊ≠£Âú®Â§ÑÁêÜÁöÑIO‰∫ã‰ª∂ÊÅ∞Â•ΩÊú™Â∞±Áª™ÔºàÊï∞ÊçÆ‰∏çÂèØËØªÊàñ‰∏çÂèØÂÜôÔºâÔºåÁ∫øÁ®ãÂ∞±‰ºöË¢´ÈòªÂ°ûÔºåÊâÄÊúâIO‰∫ã‰ª∂ÈÉΩÂøÖÈ°ªÁ≠âÂæÖÔºåÊÄßËÉΩËá™ÁÑ∂‰ºöÂæàÂ∑Æ„ÄÇ</p>
</li>
<li><p><strong>Êñá‰ª∂ÊèèËø∞Á¨¶</strong>ÔºàFile DescriptorÔºâÔºöÁÆÄÁß∞FDÔºåÊòØ‰∏Ä‰∏™‰ªé0 ÂºÄÂßãÁöÑÊó†Á¨¶Âè∑Êï¥Êï∞ÔºåÁî®Êù•ÂÖ≥ËÅîLinux‰∏≠ÁöÑ‰∏Ä‰∏™Êñá‰ª∂„ÄÇÂú®Linux‰∏≠Ôºå‰∏ÄÂàáÁöÜÊñá‰ª∂Ôºå‰æãÂ¶ÇÂ∏∏ËßÑÊñá‰ª∂„ÄÅËßÜÈ¢ë„ÄÅÁ°¨‰ª∂ËÆæÂ§áÁ≠âÔºåÂΩìÁÑ∂‰πüÂåÖÊã¨ÁΩëÁªúÂ•óÊé•Â≠óÔºàSocketÔºâ„ÄÇ</p>
</li>
<li><p>IOÂ§öË∑ØÂ§çÁî®ÔºöÊòØÂà©Áî®Âçï‰∏™Á∫øÁ®ãÊù•ÂêåÊó∂ÁõëÂê¨Â§ö‰∏™FDÔºåÂπ∂Âú®Êüê‰∏™FDÂèØËØª„ÄÅÂèØÂÜôÊó∂ÂæóÂà∞ÈÄöÁü•Ôºå‰ªéËÄåÈÅøÂÖçÊó†ÊïàÁöÑÁ≠âÂæÖÔºåÂÖÖÂàÜÂà©Áî®CPUËµÑÊ∫ê„ÄÇ</p>
</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.6.png" srcset="/img/loading.gif" lazyload></p>
<p>Èò∂ÊÆµ‰∏ÄÔºö</p>
<ul>
<li>Áî®Êà∑ËøõÁ®ãË∞ÉÁî®selectÔºåÊåáÂÆöË¶ÅÁõëÂê¨ÁöÑFDÈõÜÂêà</li>
<li>Ê†∏ÁõëÂê¨FDÂØπÂ∫îÁöÑÂ§ö‰∏™socket</li>
<li>‰ªªÊÑè‰∏Ä‰∏™ÊàñÂ§ö‰∏™socketÊï∞ÊçÆÂ∞±Áª™ÂàôËøîÂõûreadable</li>
<li>Ê≠§ËøáÁ®ã‰∏≠Áî®Êà∑ËøõÁ®ãÈòªÂ°û</li>
</ul>
<p>Èò∂ÊÆµ‰∫åÔºö</p>
<ul>
<li>Áî®Êà∑ËøõÁ®ãÊâæÂà∞Â∞±Áª™ÁöÑsocket</li>
<li>‰æùÊ¨°Ë∞ÉÁî®recvfromËØªÂèñÊï∞ÊçÆ</li>
<li>ÂÜÖÊ†∏Â∞ÜÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑Á©∫Èó¥</li>
<li>Áî®Êà∑ËøõÁ®ãÂ§ÑÁêÜÊï∞ÊçÆ</li>
</ul>
<h4 id="IOÂ§öË∑ØÂ§çÁî®Â∏∏ËßÅÊñπÂºèÁöÑÊúâÔºö"><a href="#IOÂ§öË∑ØÂ§çÁî®Â∏∏ËßÅÊñπÂºèÁöÑÊúâÔºö" class="headerlink" title="IOÂ§öË∑ØÂ§çÁî®Â∏∏ËßÅÊñπÂºèÁöÑÊúâÔºö"></a>IOÂ§öË∑ØÂ§çÁî®Â∏∏ËßÅÊñπÂºèÁöÑÊúâÔºö</h4><ul>
<li><p>select</p>
</li>
<li><p>poll</p>
</li>
<li><p>epoll</p>
</li>
<li><p>ÂÖ∂‰∏≠selectÂíåpoolÁõ∏ÂΩì‰∫éÊòØÂΩìË¢´ÁõëÂê¨ÁöÑÊï∞ÊçÆÂáÜÂ§áÂ•Ω‰πãÂêéÔºå‰ªñ‰ºöÊää‰Ω†ÁõëÂê¨ÁöÑFDÊï¥‰∏™Êï∞ÊçÆÈÉΩÂèëÁªô‰Ω†Ôºå‰Ω†ÈúÄË¶ÅÂà∞Êï¥‰∏™FD‰∏≠ÂéªÊâæÔºåÂì™‰∫õÊòØÂ§ÑÁêÜÂ•Ω‰∫ÜÁöÑÔºåÈúÄË¶ÅÈÄöËøáÈÅçÂéÜÁöÑÊñπÂºèÔºåÊâÄ‰ª•ÊÄßËÉΩ‰πüÂπ∂‰∏çÊòØÈÇ£‰πàÂ•Ω</p>
</li>
<li><p>ËÄåepollÔºåÂàôÁõ∏ÂΩì‰∫éÂÜÖÊ†∏ÂáÜÂ§áÂ•Ω‰∫Ü‰πãÂêéÔºå‰ªñ‰ºöÊääÂáÜÂ§áÂ•ΩÁöÑÊï∞ÊçÆÔºåÁõ¥Êé•ÂèëÁªô‰Ω†ÔºåÂí±‰ª¨Â∞±ÁúÅÂéª‰∫ÜÈÅçÂéÜÁöÑÂä®‰Ωú„ÄÇ</p>
</li>
</ul>
<h3 id="2-5-IOÂ§öË∑ØÂ§çÁî®ÁöÑ‰∏âÁßçÊñπÂºè"><a href="#2-5-IOÂ§öË∑ØÂ§çÁî®ÁöÑ‰∏âÁßçÊñπÂºè" class="headerlink" title="2.5 IOÂ§öË∑ØÂ§çÁî®ÁöÑ‰∏âÁßçÊñπÂºè"></a>2.5 IOÂ§öË∑ØÂ§çÁî®ÁöÑ‰∏âÁßçÊñπÂºè</h3><h4 id="2-5-1-selectÊñπÂºè"><a href="#2-5-1-selectÊñπÂºè" class="headerlink" title="2.5.1 selectÊñπÂºè"></a>2.5.1 selectÊñπÂºè</h4><p><img src="/img/blogs/java/redis/4.2.7.png" srcset="/img/loading.gif" lazyload></p>
<p>selectÊ®°ÂºèÂ≠òÂú®ÁöÑÈóÆÈ¢òÔºö</p>
<ul>
<li>ÈúÄË¶ÅÂ∞ÜÊï¥‰∏™fd_set‰ªéÁî®Êà∑Á©∫Èó¥Êã∑Ë¥ùÂà∞ÂÜÖÊ†∏Á©∫Èó¥ÔºåselectÁªìÊùüËøòË¶ÅÂÜçÊ¨°Êã∑Ë¥ùÂõûÁî®Êà∑Á©∫Èó¥</li>
<li>selectÊó†Ê≥ïÂæóÁü•ÂÖ∑‰ΩìÊòØÂì™‰∏™fdÂ∞±Áª™ÔºåÈúÄË¶ÅÈÅçÂéÜÊï¥‰∏™fd_set</li>
<li>fd_setÁõëÂê¨ÁöÑfdÊï∞Èáè‰∏çËÉΩË∂ÖËøá1024</li>
</ul>
<h4 id="2-5-2-pollÊ®°Âºè"><a href="#2-5-2-pollÊ®°Âºè" class="headerlink" title="2.5.2 pollÊ®°Âºè"></a>2.5.2 pollÊ®°Âºè</h4><p>pollÊ®°ÂºèÂØπselectÊ®°ÂºèÂÅö‰∫ÜÁÆÄÂçïÊîπËøõÔºå‰ΩÜÊÄßËÉΩÊèêÂçá‰∏çÊòéÊòæ</p>
<p>IOÊµÅÁ®ãÔºö</p>
<ul>
<li>ÂàõÂª∫pollfdÊï∞ÁªÑÔºåÂêëÂÖ∂‰∏≠Ê∑ªÂä†ÂÖ≥Ê≥®ÁöÑfd‰ø°ÊÅØÔºåÊï∞ÁªÑÂ§ßÂ∞èËá™ÂÆö‰πâ</li>
<li>Ë∞ÉÁî®pollÂáΩÊï∞ÔºåÂ∞ÜpollfdÊï∞ÁªÑÊã∑Ë¥ùÂà∞ÂÜÖÊ†∏Á©∫Èó¥ÔºåËΩ¨ÈìæË°®Â≠òÂÇ®ÔºåÊó†‰∏äÈôê</li>
<li>ÂÜÖÊ†∏ÈÅçÂéÜfdÔºåÂà§Êñ≠ÊòØÂê¶Â∞±Áª™</li>
<li>Êï∞ÊçÆÂ∞±Áª™ÊàñË∂ÖÊó∂ÂêéÔºåÊã∑Ë¥ùpollfdÊï∞ÁªÑÂà∞Áî®Êà∑Á©∫Èó¥ÔºåËøîÂõûÂ∞±Áª™fdÊï∞Èáèn</li>
<li>Áî®Êà∑ËøõÁ®ãÂà§Êñ≠nÊòØÂê¶Â§ß‰∫é0,Â§ß‰∫é0ÂàôÈÅçÂéÜpollfdÊï∞ÁªÑÔºåÊâæÂà∞Â∞±Áª™ÁöÑfd</li>
</ul>
<p><strong>‰∏éselectÂØπÊØîÔºö</strong></p>
<ul>
<li>selectÊ®°Âºè‰∏≠ÁöÑfd_setÂ§ßÂ∞èÂõ∫ÂÆö‰∏∫1024ÔºåËÄåpollfdÂú®ÂÜÖÊ†∏‰∏≠ÈááÁî®ÈìæË°®ÔºåÁêÜËÆ∫‰∏äÊó†‰∏äÈôê</li>
<li>ÁõëÂê¨FDË∂äÂ§öÔºåÊØèÊ¨°ÈÅçÂéÜÊ∂àËÄóÊó∂Èó¥‰πüË∂ä‰πÖÔºåÊÄßËÉΩÂèçËÄå‰ºö‰∏ãÈôç</li>
</ul>
<h4 id="2-5-3-epollÂáΩÊï∞"><a href="#2-5-3-epollÂáΩÊï∞" class="headerlink" title="2.5.3 epollÂáΩÊï∞"></a>2.5.3 epollÂáΩÊï∞</h4><p>epollÊ®°ÂºèÊòØÂØπselectÂíåpollÁöÑÊîπËøõÔºåÂÆÉÊèê‰æõ‰∫Ü‰∏â‰∏™ÂáΩÊï∞Ôºö</p>
<ol>
<li>Á∫¢ÈªëÊ†ë-&gt; ËÆ∞ÂΩïÁöÑ‰∫ãË¶ÅÁõëÂê¨ÁöÑFD</li>
<li>‰∏Ä‰∏™ÊòØÈìæË°®-&gt;‰∏Ä‰∏™ÈìæË°®ÔºåËÆ∞ÂΩïÁöÑÊòØÂ∞±Áª™ÁöÑFD</li>
</ol>
<ul>
<li>Á¥ßÊé•ÁùÄË∞ÉÁî®epoll_ctlÊìç‰ΩúÔºåÂ∞ÜË¶ÅÁõëÂê¨ÁöÑÊï∞ÊçÆÊ∑ªÂä†Âà∞Á∫¢ÈªëÊ†ë‰∏äÂéªÔºåÂπ∂‰∏îÁªôÊØè‰∏™fdËÆæÁΩÆ‰∏Ä‰∏™ÁõëÂê¨ÂáΩÊï∞ÔºåËøô‰∏™ÂáΩÊï∞‰ºöÂú®fdÊï∞ÊçÆÂ∞±Áª™Êó∂Ëß¶ÂèëÔºåÂ∞±ÊòØÂáÜÂ§áÂ•Ω‰∫ÜÔºåÁé∞Âú®Â∞±ÊääfdÊääÊï∞ÊçÆÊ∑ªÂä†Âà∞list_head‰∏≠Âéª</li>
</ul>
<ol start="3">
<li>Ë∞ÉÁî®epoll_waitÂáΩÊï∞</li>
</ol>
<ul>
<li>Â∞±ÂéªÁ≠âÂæÖÔºåÂú®Áî®Êà∑ÊÄÅÂàõÂª∫‰∏Ä‰∏™Á©∫ÁöÑeventsÊï∞ÁªÑÔºåÂΩìÂ∞±Áª™‰πãÂêéÔºåÊàë‰ª¨ÁöÑÂõûË∞ÉÂáΩÊï∞‰ºöÊääÊï∞ÊçÆÊ∑ªÂä†Âà∞list_head‰∏≠ÂéªÔºåÂΩìË∞ÉÁî®Ëøô‰∏™ÂáΩÊï∞ÁöÑÊó∂ÂÄôÔºå‰ºöÂéªÊ£ÄÊü•list_headÔºåÂΩìÁÑ∂Ëøô‰∏™ËøáÁ®ãÈúÄË¶ÅÂèÇËÄÉÈÖçÁΩÆÁöÑÁ≠âÂæÖÊó∂Èó¥ÔºåÂèØ‰ª•Á≠â‰∏ÄÂÆöÊó∂Èó¥Ôºå‰πüÂèØ‰ª•‰∏ÄÁõ¥Á≠âÔºå Â¶ÇÊûúÂú®Ê≠§ËøáÁ®ã‰∏≠ÔºåÊ£ÄÊü•Âà∞‰∫Ülist_head‰∏≠ÊúâÊï∞ÊçÆ‰ºöÂ∞ÜÊï∞ÊçÆÊ∑ªÂä†Âà∞ÈìæË°®‰∏≠ÔºåÊ≠§Êó∂Â∞ÜÊï∞ÊçÆÊîæÂÖ•Âà∞eventsÊï∞ÁªÑ‰∏≠ÔºåÂπ∂‰∏îËøîÂõûÂØπÂ∫îÁöÑÊìç‰ΩúÁöÑÊï∞ÈáèÔºåÁî®Êà∑ÊÄÅÁöÑÊ≠§Êó∂Êî∂Âà∞ÂìçÂ∫îÂêéÔºå‰ªéevents‰∏≠ÊãøÂà∞ÂØπÂ∫îÂáÜÂ§áÂ•ΩÁöÑÊï∞ÊçÆÁöÑËäÇÁÇπÔºåÂÜçÂéªË∞ÉÁî®ÊñπÊ≥ïÂéªÊãøÊï∞ÊçÆ„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.8.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-5-4-ÊÄªÁªì"><a href="#2-5-4-ÊÄªÁªì" class="headerlink" title="2.5.4 ÊÄªÁªì"></a>2.5.4 ÊÄªÁªì</h4><p>selectÊ®°ÂºèÂ≠òÂú®ÁöÑ‰∏â‰∏™ÈóÆÈ¢òÔºö</p>
<ul>
<li>ËÉΩÁõëÂê¨ÁöÑFDÊúÄÂ§ß‰∏çË∂ÖËøá1024</li>
<li>ÊØèÊ¨°selectÈÉΩÈúÄË¶ÅÊääÊâÄÊúâË¶ÅÁõëÂê¨ÁöÑFDÈÉΩÊã∑Ë¥ùÂà∞ÂÜÖÊ†∏Á©∫Èó¥</li>
<li>ÊØèÊ¨°ÈÉΩË¶ÅÈÅçÂéÜÊâÄÊúâFDÊù•Âà§Êñ≠Â∞±Áª™Áä∂ÊÄÅ</li>
</ul>
<p>pollÊ®°ÂºèÁöÑÈóÆÈ¢òÔºö</p>
<ul>
<li>pollÂà©Áî®ÈìæË°®Ëß£ÂÜ≥‰∫Üselect‰∏≠ÁõëÂê¨FD‰∏äÈôêÁöÑÈóÆÈ¢òÔºå‰ΩÜ‰æùÁÑ∂Ë¶ÅÈÅçÂéÜÊâÄÊúâFDÔºåÂ¶ÇÊûúÁõëÂê¨ËæÉÂ§öÔºåÊÄßËÉΩ‰ºö‰∏ãÈôç</li>
</ul>
<p>epollÊ®°Âºè‰∏≠Â¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∫õÈóÆÈ¢òÁöÑÔºü</p>
<ul>
<li>Âü∫‰∫éepollÂÆû‰æã‰∏≠ÁöÑÁ∫¢ÈªëÊ†ë‰øùÂ≠òË¶ÅÁõëÂê¨ÁöÑFDÔºåÁêÜËÆ∫‰∏äÊó†‰∏äÈôêÔºåËÄå‰∏îÂ¢ûÂà†ÊîπÊü•ÊïàÁéáÈÉΩÈùûÂ∏∏È´ò</li>
<li>ÊØè‰∏™FDÂè™ÈúÄË¶ÅÊâßË°å‰∏ÄÊ¨°epoll_ctlÊ∑ªÂä†Âà∞Á∫¢ÈªëÊ†ëÔºå‰ª•ÂêéÊØèÊ¨°epol_waitÊó†ÈúÄ‰º†ÈÄí‰ªª‰ΩïÂèÇÊï∞ÔºåÊó†ÈúÄÈáçÂ§çÊã∑Ë¥ùFDÂà∞ÂÜÖÊ†∏Á©∫Èó¥</li>
<li>Âà©Áî®ep_poll_callbackÊú∫Âà∂Êù•ÁõëÂê¨FDÁä∂ÊÄÅÔºåÊó†ÈúÄÈÅçÂéÜÊâÄÊúâFDÔºåÂõ†Ê≠§ÊÄßËÉΩ‰∏ç‰ºöÈöèÁõëÂê¨ÁöÑFDÊï∞ÈáèÂ¢ûÂ§öËÄå‰∏ãÈôç</li>
</ul>
<h3 id="2-6-IOÂ§öË∑ØÂ§çÁî®-epoll"><a href="#2-6-IOÂ§öË∑ØÂ§çÁî®-epoll" class="headerlink" title="2.6 IOÂ§öË∑ØÂ§çÁî®-epoll"></a>2.6 IOÂ§öË∑ØÂ§çÁî®-epoll</h3><h4 id="2-6-1-Êó∂Èó¥ÈÄöÁü•Êú∫Âà∂"><a href="#2-6-1-Êó∂Èó¥ÈÄöÁü•Êú∫Âà∂" class="headerlink" title="2.6.1 Êó∂Èó¥ÈÄöÁü•Êú∫Âà∂"></a>2.6.1 Êó∂Èó¥ÈÄöÁü•Êú∫Âà∂</h4><p>ÂΩìFDÊúâÊï∞ÊçÆÂèØËØªÊó∂ÔºåÊàë‰ª¨Ë∞ÉÁî®epoll_waitÔºàÊàñËÄÖselect„ÄÅpollÔºâÂèØ‰ª•ÂæóÂà∞ÈÄöÁü•„ÄÇ‰ΩÜÊòØ‰∫ã‰ª∂ÈÄöÁü•ÁöÑÊ®°ÂºèÊúâ‰∏§ÁßçÔºö</p>
<ul>
<li>LevelTriggeredÔºöÁÆÄÁß∞LTÔºå‰πüÂè´ÂÅöÊ∞¥Âπ≥Ëß¶Âèë„ÄÇÂè™Ë¶ÅÊüê‰∏™FD‰∏≠ÊúâÊï∞ÊçÆÂèØËØªÔºåÊØèÊ¨°Ë∞ÉÁî®epoll_waitÈÉΩ‰ºöÂæóÂà∞ÈÄöÁü•„ÄÇ</li>
<li>EdgeTriggeredÔºöÁÆÄÁß∞ETÔºå‰πüÂè´ÂÅöËæπÊ≤øËß¶Âèë„ÄÇÂè™ÊúâÂú®Êüê‰∏™FDÊúâÁä∂ÊÄÅÂèòÂåñÊó∂ÔºåË∞ÉÁî®epoll_waitÊâç‰ºöË¢´ÈÄöÁü•„ÄÇ</li>
</ul>
<h4 id="2-6-2-Âü∫‰∫éepollÁöÑÊúçÂä°Âô®Á´ØÊµÅÁ®ã"><a href="#2-6-2-Âü∫‰∫éepollÁöÑÊúçÂä°Âô®Á´ØÊµÅÁ®ã" class="headerlink" title="2.6.2 Âü∫‰∫éepollÁöÑÊúçÂä°Âô®Á´ØÊµÅÁ®ã"></a>2.6.2 Âü∫‰∫éepollÁöÑÊúçÂä°Âô®Á´ØÊµÅÁ®ã</h4><p>Âü∫‰∫éepollÊ®°ÂºèÁöÑwebÊúçÂä°ÁöÑÂü∫Êú¨ÊµÅÁ®ãÂ¶ÇÂõæÔºö</p>
<p><img src="/img/blogs/java/redis/4.2.9.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-7-‰ø°Âè∑È©±Âä®IO"><a href="#2-7-‰ø°Âè∑È©±Âä®IO" class="headerlink" title="2.7 ‰ø°Âè∑È©±Âä®IO"></a>2.7 ‰ø°Âè∑È©±Âä®IO</h3><p>‰ø°Âè∑È©±Âä®IOÊòØ‰∏éÂÜÖÊ†∏Âª∫Á´ãSIGIOÁöÑ‰ø°Âè∑ÂÖ≥ËÅîÂπ∂ËÆæÁΩÆÂõûË∞ÉÔºåÂΩìÂÜÖÊ†∏ÊúâFDÂ∞±Áª™Êó∂Ôºå‰ºöÂèëÂá∫SIGIO‰ø°Âè∑ÈÄöÁü•Áî®Êà∑ÔºåÊúüÈó¥Áî®Êà∑Â∫îÁî®ÂèØ‰ª•ÊâßË°åÂÖ∂ÂÆÉ‰∏öÂä°ÔºåÊó†ÈúÄÈòªÂ°ûÁ≠âÂæÖ„ÄÇ</p>
<p>Èò∂ÊÆµ‰∏ÄÔºö</p>
<ul>
<li>Áî®Êà∑ËøõÁ®ãË∞ÉÁî®sigactionÔºåÊ≥®ÂÜå‰ø°Âè∑Â§ÑÁêÜÂáΩÊï∞</li>
<li>ÂÜÖÊ†∏ËøîÂõûÊàêÂäüÔºåÂºÄÂßãÁõëÂê¨FD</li>
<li>Áî®Êà∑ËøõÁ®ã‰∏çÈòªÂ°ûÁ≠âÂæÖÔºåÂèØ‰ª•ÊâßË°åÂÖ∂ÂÆÉ‰∏öÂä°</li>
<li>ÂΩìÂÜÖÊ†∏Êï∞ÊçÆÂ∞±Áª™ÂêéÔºåÂõûË∞ÉÁî®Êà∑ËøõÁ®ãÁöÑSIGIOÂ§ÑÁêÜÂáΩÊï∞</li>
</ul>
<p>Èò∂ÊÆµ‰∫åÔºö</p>
<ul>
<li>Êî∂Âà∞SIGIOÂõûË∞É‰ø°Âè∑</li>
<li>Ë∞ÉÁî®recvfromÔºåËØªÂèñ</li>
<li>ÂÜÖÊ†∏Â∞ÜÊï∞ÊçÆÊã∑Ë¥ùÂà∞Áî®Êà∑Á©∫Èó¥</li>
<li>Áî®Êà∑ËøõÁ®ãÂ§ÑÁêÜÊï∞ÊçÆ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.10.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Áº∫ÁÇπÔºöÂΩìÊúâÂ§ßÈáèIOÊìç‰ΩúÊó∂Ôºå‰ø°Âè∑ËæÉÂ§öÔºåSIGIOÂ§ÑÁêÜÂáΩÊï∞‰∏çËÉΩÂèäÊó∂Â§ÑÁêÜÂèØËÉΩÂØºËá¥‰ø°Âè∑ÈòüÂàóÊ∫¢Âá∫ÔºåËÄå‰∏îÂÜÖÊ†∏Á©∫Èó¥‰∏éÁî®Êà∑Á©∫Èó¥ÁöÑÈ¢ëÁπÅ‰ø°Âè∑‰∫§‰∫íÊÄßËÉΩ‰πüËæÉ‰Ωé„ÄÇ</li>
</ul>
<h3 id="2-8-ÂºÇÊ≠•IO"><a href="#2-8-ÂºÇÊ≠•IO" class="headerlink" title="2.8 ÂºÇÊ≠•IO"></a>2.8 ÂºÇÊ≠•IO</h3><p>ÂºÇÊ≠•IOÁöÑÊï¥‰∏™ËøáÁ®ãÈÉΩÊòØÈùûÈòªÂ°ûÁöÑÔºåÁî®Êà∑ËøõÁ®ãË∞ÉÁî®ÂÆåÂºÇÊ≠•APIÂêéÂ∞±ÂèØ‰ª•ÂéªÂÅöÂÖ∂ÂÆÉ‰∫ãÊÉÖÔºåÂÜÖÊ†∏Á≠âÂæÖÊï∞ÊçÆÂ∞±Áª™Âπ∂Êã∑Ë¥ùÂà∞Áî®Êà∑Á©∫Èó¥ÂêéÊâç‰ºöÈÄí‰∫§‰ø°Âè∑ÔºåÈÄöÁü•Áî®Êà∑ËøõÁ®ã„ÄÇ</p>
<ul>
<li>ÂºÇÊ≠•IOÊ®°Âûã‰∏≠ÔºåÁî®Êà∑ËøõÁ®ãÂú®‰∏§‰∏™Èò∂ÊÆµÈÉΩÊòØÈùûÈòªÂ°ûÁä∂ÊÄÅ„ÄÇ</li>
</ul>
<p><img src="/img/blogs/java/redis/4.2.11.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-9-‰∫îÁßçIOÊ®°ÂûãÂØπÊØî"><a href="#2-9-‰∫îÁßçIOÊ®°ÂûãÂØπÊØî" class="headerlink" title="2.9 ‰∫îÁßçIOÊ®°ÂûãÂØπÊØî"></a>2.9 ‰∫îÁßçIOÊ®°ÂûãÂØπÊØî</h3><p><img src="/img/blogs/java/redis/4.2.12.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-10-RedisÁΩëÁªúÊ®°Âûã"><a href="#2-10-RedisÁΩëÁªúÊ®°Âûã" class="headerlink" title="2.10 RedisÁΩëÁªúÊ®°Âûã"></a>2.10 RedisÁΩëÁªúÊ®°Âûã</h3><h4 id="2-10-1-RedisÊòØÂçïÁ∫øÁ®ãÁöÑÂêóÔºü‰∏∫‰ªÄ‰πà‰ΩøÁî®ÂçïÁ∫øÁ®ã"><a href="#2-10-1-RedisÊòØÂçïÁ∫øÁ®ãÁöÑÂêóÔºü‰∏∫‰ªÄ‰πà‰ΩøÁî®ÂçïÁ∫øÁ®ã" class="headerlink" title="2.10.1 RedisÊòØÂçïÁ∫øÁ®ãÁöÑÂêóÔºü‰∏∫‰ªÄ‰πà‰ΩøÁî®ÂçïÁ∫øÁ®ã"></a>2.10.1 RedisÊòØÂçïÁ∫øÁ®ãÁöÑÂêóÔºü‰∏∫‰ªÄ‰πà‰ΩøÁî®ÂçïÁ∫øÁ®ã</h4><p><strong>RedisÂà∞Â∫ïÊòØÂçïÁ∫øÁ®ãËøòÊòØÂ§öÁ∫øÁ®ãÔºü</strong></p>
<ul>
<li>Â¶ÇÊûú‰ªÖ‰ªÖËÅäRedisÁöÑÊ†∏ÂøÉ‰∏öÂä°ÈÉ®ÂàÜÔºàÂëΩ‰ª§Â§ÑÁêÜÔºâÔºåÁ≠îÊ°àÊòØÂçïÁ∫øÁ®ã</li>
<li>Â¶ÇÊûúÊòØËÅäÊï¥‰∏™RedisÔºåÈÇ£‰πàÁ≠îÊ°àÂ∞±ÊòØÂ§öÁ∫øÁ®ã</li>
</ul>
<p>Âú®RedisÁâàÊú¨Ëø≠‰ª£ËøáÁ®ã‰∏≠ÔºåÂú®‰∏§‰∏™ÈáçË¶ÅÁöÑÊó∂Èó¥ËäÇÁÇπ‰∏äÂºïÂÖ•‰∫ÜÂ§öÁ∫øÁ®ãÁöÑÊîØÊåÅÔºö</p>
<ul>
<li>Redis v4.0ÔºöÂºïÂÖ•Â§öÁ∫øÁ®ãÂºÇÊ≠•Â§ÑÁêÜ‰∏Ä‰∫õËÄóÊó∂ËæÉÊóßÁöÑ‰ªªÂä°Ôºå‰æãÂ¶ÇÂºÇÊ≠•Âà†Èô§ÂëΩ‰ª§unlink</li>
<li>Redis v6.0ÔºöÂú®Ê†∏ÂøÉÁΩëÁªúÊ®°Âûã‰∏≠ÂºïÂÖ• Â§öÁ∫øÁ®ãÔºåËøõ‰∏ÄÊ≠•ÊèêÈ´òÂØπ‰∫éÂ§öÊ†∏CPUÁöÑÂà©Áî®Áéá</li>
</ul>
<p><strong>‰∏∫‰ªÄ‰πàRedisË¶ÅÈÄâÊã©ÂçïÁ∫øÁ®ãÔºü</strong></p>
<ul>
<li>ÊäõÂºÄÊåÅ‰πÖÂåñ‰∏çË∞àÔºåRedisÊòØÁ∫Ø  ÂÜÖÂ≠òÊìç‰ΩúÔºåÊâßË°åÈÄüÂ∫¶ÈùûÂ∏∏Âø´ÔºåÂÆÉÁöÑÊÄßËÉΩÁì∂È¢àÊòØÁΩëÁªúÂª∂ËøüËÄå‰∏çÊòØÊâßË°åÈÄüÂ∫¶ÔºåÂõ†Ê≠§Â§öÁ∫øÁ®ãÂπ∂‰∏ç‰ºöÂ∏¶Êù•Â∑®Â§ßÁöÑÊÄßËÉΩÊèêÂçá„ÄÇ</li>
<li>Â§öÁ∫øÁ®ã‰ºöÂØºËá¥ËøáÂ§öÁöÑ‰∏ä‰∏ãÊñáÂàáÊç¢ÔºåÂ∏¶Êù•‰∏çÂøÖË¶ÅÁöÑÂºÄÈîÄ</li>
<li>ÂºïÂÖ•Â§öÁ∫øÁ®ã‰ºöÈù¢‰∏¥Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢òÔºåÂøÖÁÑ∂Ë¶ÅÂºïÂÖ•Á∫øÁ®ãÈîÅËøôÊ†∑ÁöÑÂÆâÂÖ®ÊâãÊÆµÔºåÂÆûÁé∞Â§çÊùÇÂ∫¶Â¢ûÈ´òÔºåËÄå‰∏îÊÄßËÉΩ‰πü‰ºöÂ§ßÊâìÊäòÊâ£</li>
</ul>
<h4 id="2-10-2-RedisÂçïÁ∫øÁ®ãÂíåÂ§öÁ∫øÁ®ãÁΩëÁªúÊ®°ÂûãÂèòÊõ¥"><a href="#2-10-2-RedisÂçïÁ∫øÁ®ãÂíåÂ§öÁ∫øÁ®ãÁΩëÁªúÊ®°ÂûãÂèòÊõ¥" class="headerlink" title="2.10.2 RedisÂçïÁ∫øÁ®ãÂíåÂ§öÁ∫øÁ®ãÁΩëÁªúÊ®°ÂûãÂèòÊõ¥"></a>2.10.2 RedisÂçïÁ∫øÁ®ãÂíåÂ§öÁ∫øÁ®ãÁΩëÁªúÊ®°ÂûãÂèòÊõ¥</h4><p>RedisÈÄöËøá<strong>IOÂ§öË∑ØÂ§çÁî®Êù•ÊèêÈ´òÁΩëÁªúÊÄßËÉΩ</strong>ÔºåÂπ∂‰∏îÊîØÊåÅÂêÑÁßç‰∏çÂêåÁöÑÂ§öË∑ØÂ§çÁî®ÂÆûÁé∞ÔºåÂπ∂‰∏îÂ∞ÜËøô‰∫õÂÆûÁé∞ËøõË°åÂ∞ÅË£ÖÔºå Êèê‰æõ‰∫ÜÁªü‰∏ÄÁöÑÈ´òÊÄßËÉΩ‰∫ã‰ª∂Â∫ìAPIÂ∫ì AE<br>Redis 6.0ÁâàÊú¨‰∏≠ÂºïÂÖ•‰∫ÜÂ§öÁ∫øÁ®ãÔºåÁõÆÁöÑÊòØ‰∏∫‰∫ÜÊèêÈ´òIOËØªÂÜôÊïàÁéá„ÄÇÂõ†Ê≠§Âú®Ëß£ÊûêÂÆ¢Êà∑Á´ØÂëΩ‰ª§„ÄÅÂÜôÂìçÂ∫îÁªìÊûúÊó∂ÈááÁî®‰∫ÜÂ§öÁ∫øÁ®ã„ÄÇÊ†∏ÂøÉÁöÑÂëΩ‰ª§ÊâßË°å„ÄÅIOÂ§öË∑ØÂ§çÁî®Ê®°Âùó‰æùÁÑ∂ÊòØÁî±‰∏ªÁ∫øÁ®ãÊâßË°å„ÄÇ</p>
<h2 id="3-ÈÄö‰ø°ÂçèËÆÆ"><a href="#3-ÈÄö‰ø°ÂçèËÆÆ" class="headerlink" title="3. ÈÄö‰ø°ÂçèËÆÆ"></a>3. ÈÄö‰ø°ÂçèËÆÆ</h2><h3 id="3-1-RESPÂçèËÆÆ"><a href="#3-1-RESPÂçèËÆÆ" class="headerlink" title="3.1 RESPÂçèËÆÆ"></a>3.1 RESPÂçèËÆÆ</h3><p>RedisÊòØ‰∏Ä‰∏™CSÊû∂ÊûÑÁöÑËΩØ‰ª∂ÔºåÈÄö‰ø°‰∏ÄËà¨ÂàÜ‰∏§Ê≠•Ôºö</p>
<ul>
<li>ÂÆ¢Êà∑Á´ØÔºàclientÔºâÂêëÊúçÂä°Á´ØÔºàserverÔºâÂèëÈÄÅ‰∏ÄÊù°ÂëΩ‰ª§</li>
<li>ÊúçÂä°Á´ØËß£ÊûêÂπ∂ÊâßË°åÂëΩ‰ª§ÔºåËøîÂõûÂìçÂ∫îÁªìÊûúÁªôÂÆ¢Êà∑Á´Ø</li>
</ul>
<p>Âõ†Ê≠§ÂÆ¢Êà∑Á´ØÂèëÈÄÅÂëΩ‰ª§ÁöÑÊ†ºÂºè„ÄÅÊúçÂä°Á´ØÂìçÂ∫îÁªìÊûúÁöÑÊ†ºÂºèÂøÖÈ°ªÊúâ‰∏Ä‰∏™ËßÑËåÉÔºåËøô‰∏™ËßÑËåÉÂ∞±ÊòØÈÄö‰ø°ÂçèËÆÆ„ÄÇ</p>
<ul>
<li>ËÄåÂú®Redis‰∏≠ÈááÁî®ÁöÑÊòØRESPÔºàRedis Serialization ProtocolÔºâÂçèËÆÆÔºö</li>
</ul>
<h4 id="RESPÂçèËÆÆÁöÑÊï∞ÊçÆÁ±ªÂûã"><a href="#RESPÂçèËÆÆÁöÑÊï∞ÊçÆÁ±ªÂûã" class="headerlink" title="RESPÂçèËÆÆÁöÑÊï∞ÊçÆÁ±ªÂûã"></a>RESPÂçèËÆÆÁöÑÊï∞ÊçÆÁ±ªÂûã</h4><p>Âú®RESP‰∏≠ÔºåÈÄöËøáÈ¶ñÂ≠óËäÇÁöÑÂ≠óÁ¨¶Êù•Âå∫ÂàÜ‰∏çÂêåÊï∞ÊçÆÁ±ªÂûãÔºåÂ∏∏Áî®ÁöÑÊï∞ÊçÆÁ±ªÂûãÂåÖÊã¨5ÁßçÔºö</p>
<ol>
<li>ÂçïË°åÂ≠óÁ¨¶‰∏≤ÔºöÈ¶ñÂ≠óËäÇÊòØ ‚Äò+‚Äô ÔºåÂêéÈù¢Ë∑ü‰∏äÂçïË°åÂ≠óÁ¨¶‰∏≤Ôºå‰ª•CRLFÔºà ‚Äú\r\n‚Äù ÔºâÁªìÂ∞æ„ÄÇ‰æãÂ¶ÇËøîÂõû‚ÄùOK‚ÄùÔºö ‚Äú+OK\r\n‚Äù</li>
<li>ÈîôËØØÔºàErrorsÔºâÔºöÈ¶ñÂ≠óËäÇÊòØ ‚Äò-‚Äô Ôºå‰∏éÂçïË°åÂ≠óÁ¨¶‰∏≤Ê†ºÂºè‰∏ÄÊ†∑ÔºåÂè™ÊòØÂ≠óÁ¨¶‰∏≤ÊòØÂºÇÂ∏∏‰ø°ÊÅØÔºå‰æãÂ¶ÇÔºö‚Äù-Error message\r\n‚Äù</li>
<li>Êï∞ÂÄºÔºöÈ¶ñÂ≠óËäÇÊòØ ‚Äò:‚Äô ÔºåÂêéÈù¢Ë∑ü‰∏äÊï∞Â≠óÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰ª•CRLFÁªìÂ∞æ„ÄÇ‰æãÂ¶ÇÔºö‚Äù:10\r\n‚Äù</li>
<li>Â§öË°åÂ≠óÁ¨¶‰∏≤ÔºöÈ¶ñÂ≠óËäÇÊòØ ‚Äò$‚Äô ÔºåË°®Á§∫‰∫åËøõÂà∂ÂÆâÂÖ®ÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊúÄÂ§ßÊîØÊåÅ512MBÔºö<ul>
<li>Â¶ÇÊûúÂ§ßÂ∞è‰∏∫0ÔºåÂàô‰ª£Ë°®Á©∫Â≠óÁ¨¶‰∏≤Ôºö‚Äù$0\r\n\r\n‚Äù</li>
<li>Â¶ÇÊûúÂ§ßÂ∞è‰∏∫-1ÔºåÂàô‰ª£Ë°®‰∏çÂ≠òÂú®Ôºö‚Äù$-1\r\n‚Äù</li>
</ul>
</li>
<li>Êï∞ÁªÑÔºöÈ¶ñÂ≠óËäÇÊòØ ‚Äò*‚ÄôÔºåÂêéÈù¢Ë∑ü‰∏äÊï∞ÁªÑÂÖÉÁ¥†‰∏™Êï∞ÔºåÂÜçË∑ü‰∏äÂÖÉÁ¥†ÔºåÂÖÉÁ¥†Êï∞ÊçÆÁ±ªÂûã‰∏çÈôê:</li>
</ol>
<h3 id="3-2-Âü∫‰∫éSocketËá™ÂÆö‰πâRedisÁöÑÂÆ¢Êà∑Á´Ø"><a href="#3-2-Âü∫‰∫éSocketËá™ÂÆö‰πâRedisÁöÑÂÆ¢Êà∑Á´Ø" class="headerlink" title="3.2 Âü∫‰∫éSocketËá™ÂÆö‰πâRedisÁöÑÂÆ¢Êà∑Á´Ø"></a>3.2 Âü∫‰∫éSocketËá™ÂÆö‰πâRedisÁöÑÂÆ¢Êà∑Á´Ø</h3><p>RedisÊîØÊåÅTCPÈÄö‰ø°ÔºåÂõ†Ê≠§Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî®SocketÊù•Ê®°ÊãüÂÆ¢Êà∑Á´ØÔºå‰∏éRedisÊúçÂä°Á´ØÂª∫Á´ãËøûÊé•Ôºö</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">static</span> Socket s;<br>    <span class="hljs-keyword">static</span> PrintWriter writer;<br>    <span class="hljs-keyword">static</span> BufferedReader reader;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 1.Âª∫Á´ãËøûÊé•</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;192.168.150.101&quot;</span>;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">port</span> <span class="hljs-operator">=</span> <span class="hljs-number">6379</span>;<br>            s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(host, port);<br>            <span class="hljs-comment">// 2.Ëé∑ÂèñËæìÂá∫ÊµÅ„ÄÅËæìÂÖ•ÊµÅ</span><br>            writer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(s.getOutputStream(), StandardCharsets.UTF_8));<br>            reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(s.getInputStream(), StandardCharsets.UTF_8));<br><br>            <span class="hljs-comment">// 3.ÂèëÂá∫ËØ∑Ê±Ç</span><br>            <span class="hljs-comment">// 3.1.Ëé∑ÂèñÊéàÊùÉ auth 123321</span><br>            sendRequest(<span class="hljs-string">&quot;auth&quot;</span>, <span class="hljs-string">&quot;123321&quot;</span>);<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name ËôéÂì•</span><br>            sendRequest(<span class="hljs-string">&quot;set&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;ËôéÂì•&quot;</span>);<br>            <span class="hljs-comment">// 4.Ëß£ÊûêÂìçÂ∫î</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name ËôéÂì•</span><br>            sendRequest(<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-comment">// 4.Ëß£ÊûêÂìçÂ∫î</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br><br>            <span class="hljs-comment">// 3.2.set name ËôéÂì•</span><br>            sendRequest(<span class="hljs-string">&quot;mget&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;num&quot;</span>, <span class="hljs-string">&quot;msg&quot;</span>);<br>            <span class="hljs-comment">// 4.Ëß£ÊûêÂìçÂ∫î</span><br>            obj = handleResponse();<br>            System.out.println(<span class="hljs-string">&quot;obj = &quot;</span> + obj);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-comment">// 5.ÈáäÊîæËøûÊé•</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (reader != <span class="hljs-literal">null</span>) reader.close();<br>                <span class="hljs-keyword">if</span> (writer != <span class="hljs-literal">null</span>) writer.close();<br>                <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) s.close();<br>            &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">handleResponse</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// ËØªÂèñÈ¶ñÂ≠óËäÇ</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">prefix</span> <span class="hljs-operator">=</span> reader.read();<br>        <span class="hljs-comment">// Âà§Êñ≠Êï∞ÊçÆÁ±ªÂûãÊ†áÁ§∫</span><br>        <span class="hljs-keyword">switch</span> (prefix) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;+&#x27;</span>: <span class="hljs-comment">// ÂçïË°åÂ≠óÁ¨¶‰∏≤ÔºåÁõ¥Êé•ËØª‰∏ÄË°å</span><br>                <span class="hljs-keyword">return</span> reader.readLine();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;-&#x27;</span>: <span class="hljs-comment">// ÂºÇÂ∏∏Ôºå‰πüËØª‰∏ÄË°å</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(reader.readLine());<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;:&#x27;</span>: <span class="hljs-comment">// Êï∞Â≠ó</span><br>                <span class="hljs-keyword">return</span> Long.parseLong(reader.readLine());<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;$&#x27;</span>: <span class="hljs-comment">// Â§öË°åÂ≠óÁ¨¶‰∏≤</span><br>                <span class="hljs-comment">// ÂÖàËØªÈïøÂ∫¶</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> Integer.parseInt(reader.readLine());<br>                <span class="hljs-keyword">if</span> (len == -<span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>                &#125;<br>                <span class="hljs-comment">// ÂÜçËØªÊï∞ÊçÆ,ËØªlen‰∏™Â≠óËäÇ„ÄÇÊàë‰ª¨ÂÅáËÆæÊ≤°ÊúâÁâπÊÆäÂ≠óÁ¨¶ÔºåÊâÄ‰ª•ËØª‰∏ÄË°åÔºàÁÆÄÂåñÔºâ</span><br>                <span class="hljs-keyword">return</span> reader.readLine();<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;*&#x27;</span>:<br>                <span class="hljs-keyword">return</span> readBulkString();<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ÈîôËØØÁöÑÊï∞ÊçÆÊ†ºÂºèÔºÅ&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">readBulkString</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// Ëé∑ÂèñÊï∞ÁªÑÂ§ßÂ∞è</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">len</span> <span class="hljs-operator">=</span> Integer.parseInt(reader.readLine());<br>        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        <span class="hljs-comment">// ÂÆö‰πâÈõÜÂêàÔºåÊé•Êî∂Â§ö‰∏™ÂÖÉÁ¥†</span><br>        List&lt;Object&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(len);<br>        <span class="hljs-comment">// ÈÅçÂéÜÔºå‰æùÊ¨°ËØªÂèñÊØè‰∏™ÂÖÉÁ¥†</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; len; i++) &#123;<br>            list.add(handleResponse());<br>        &#125;<br>        <span class="hljs-keyword">return</span> list;<br>    &#125;<br><br>    <span class="hljs-comment">// set name ËôéÂì•</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendRequest</span><span class="hljs-params">(String ... args)</span> &#123;<br>        writer.println(<span class="hljs-string">&quot;*&quot;</span> + args.length);<br>        <span class="hljs-keyword">for</span> (String arg : args) &#123;<br>            writer.println(<span class="hljs-string">&quot;$&quot;</span> + arg.getBytes(StandardCharsets.UTF_8).length);<br>            writer.println(arg);<br>        &#125;<br>        writer.flush();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h2 id="4-RedisÂÜÖÂ≠òÂõûÊî∂"><a href="#4-RedisÂÜÖÂ≠òÂõûÊî∂" class="headerlink" title="4. RedisÂÜÖÂ≠òÂõûÊî∂"></a>4. RedisÂÜÖÂ≠òÂõûÊî∂</h2><p>Redis‰πãÊâÄ‰ª•ÊÄßËÉΩÂº∫ÔºåÊúÄ‰∏ªË¶ÅÁöÑÂéüÂõ†Â∞±ÊòØÂü∫‰∫éÂÜÖÂ≠òÂ≠òÂÇ®„ÄÇÁÑ∂ËÄåÂçïËäÇÁÇπÁöÑRedisÂÖ∂ÂÜÖÂ≠òÂ§ßÂ∞è‰∏çÂÆúËøáÂ§ßÔºå‰ºöÂΩ±ÂìçÊåÅ‰πÖÂåñÊàñ‰∏ª‰ªéÂêåÊ≠•ÊÄßËÉΩ„ÄÇ<br>ÂΩìÂÜÖÂ≠ò‰ΩøÁî®ËææÂà∞‰∏äÈôêÊó∂ÔºåÂ∞±Êó†Ê≥ïÂ≠òÂÇ®Êõ¥Â§öÊï∞ÊçÆ‰∫Ü„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåRedisÊèê‰æõ‰∫Ü‰∏Ä‰∫õÁ≠ñÁï•ÂÆûÁé∞ÂÜÖÂ≠òÂõûÊî∂Ôºö</p>
<ul>
<li>ÂÜÖÂ≠òËøáÊúüÁ≠ñÁï•</li>
<li>ÂÜÖÂ≠òÊ∑òÊ±∞Á≠ñÁï•</li>
</ul>
<h3 id="4-1-ÂÜÖÂ≠òËøáÊúüÁ≠ñÁï•"><a href="#4-1-ÂÜÖÂ≠òËøáÊúüÁ≠ñÁï•" class="headerlink" title="4.1 ÂÜÖÂ≠òËøáÊúüÁ≠ñÁï•"></a>4.1 ÂÜÖÂ≠òËøáÊúüÁ≠ñÁï•</h3><p>Âú®Â≠¶‰π†RedisÁºìÂ≠òÁöÑÊó∂ÂÄôÊàë‰ª¨ËØ¥ËøáÔºåÂèØ‰ª•ÈÄöËøáexpireÂëΩ‰ª§ÁªôRedisÁöÑkeyËÆæÁΩÆTTLÔºàÂ≠òÊ¥ªÊó∂Èó¥ÔºâÔºö</p>
<ul>
<li>ÂèØ‰ª•ÂèëÁé∞ÔºåÂΩìkeyÁöÑTTLÂà∞Êúü‰ª•ÂêéÔºåÂÜçÊ¨°ËÆøÈóÆnameËøîÂõûÁöÑÊòØnilÔºåËØ¥ÊòéËøô‰∏™keyÂ∑≤Áªè‰∏çÂ≠òÂú®‰∫ÜÔºåÂØπÂ∫îÁöÑÂÜÖÂ≠ò‰πüÂæóÂà∞ÈáäÊîæ„ÄÇ‰ªéËÄåËµ∑Âà∞ÂÜÖÂ≠òÂõûÊî∂ÁöÑÁõÆÁöÑ„ÄÇ</li>
</ul>
<p>RedisÊú¨Ë∫´ÊòØ‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑkey-valueÂÜÖÂ≠òÂ≠òÂÇ®Êï∞ÊçÆÂ∫ìÔºåÂõ†Ê≠§ÊâÄÊúâÁöÑkey„ÄÅvalueÈÉΩ‰øùÂ≠òÂú®‰πãÂâçÂ≠¶‰π†ËøáÁöÑDictÁªìÊûÑ‰∏≠„ÄÇ‰∏çËøáÂú®ÂÖ∂databaseÁªìÊûÑ‰Ωì‰∏≠ÔºåÊúâ‰∏§‰∏™DictÔºö‰∏Ä‰∏™Áî®Êù•ËÆ∞ÂΩïkey-valueÔºõÂè¶‰∏Ä‰∏™Áî®Êù•ËÆ∞ÂΩïkey-TTL„ÄÇ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisDb</span> &#123;</span><br>¬† ¬† dict *dict; ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <span class="hljs-comment">/* Â≠òÊîæÊâÄÊúâkeyÂèävalueÁöÑÂú∞ÊñπÔºå‰πüË¢´Áß∞‰∏∫keyspace*/</span><br>¬† ¬† dict *expires; ¬† ¬† ¬† ¬† ¬† ¬† ¬†<span class="hljs-comment">/* Â≠òÊîæÊØè‰∏Ä‰∏™keyÂèäÂÖ∂ÂØπÂ∫îÁöÑTTLÂ≠òÊ¥ªÊó∂Èó¥ÔºåÂè™ÂåÖÂê´ËÆæÁΩÆ‰∫ÜTTLÁöÑkey*/</span><br>¬† ¬† dict *blocking_keys; ¬† ¬† ¬† ¬†<span class="hljs-comment">/* Keys with clients waiting for data (BLPOP)*/</span><br>¬† ¬† dict *ready_keys; ¬† ¬† ¬† ¬† ¬† <span class="hljs-comment">/* Blocked keys that received a PUSH */</span><br>¬† ¬† dict *watched_keys; ¬† ¬† ¬† ¬† <span class="hljs-comment">/* WATCHED keys for MULTI/EXEC CAS */</span><br>¬† ¬† <span class="hljs-type">int</span> id; ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <span class="hljs-comment">/* Database IDÔºå0~15 */</span><br>¬† ¬† <span class="hljs-type">long</span> <span class="hljs-type">long</span> avg_ttl; ¬† ¬† ¬† ¬† ¬†<span class="hljs-comment">/* ËÆ∞ÂΩïÂπ≥ÂùáTTLÊó∂Èïø */</span><br>¬† ¬† <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> expires_cursor; <span class="hljs-comment">/* expireÊ£ÄÊü•Êó∂Âú®dict‰∏≠ÊäΩÊ†∑ÁöÑÁ¥¢Âºï‰ΩçÁΩÆ. */</span><br>¬† ¬† <span class="hljs-built_in">list</span> *defrag_later; ¬† ¬† ¬† ¬† <span class="hljs-comment">/* Á≠âÂæÖÁ¢éÁâáÊï¥ÁêÜÁöÑkeyÂàóË°®. */</span><br>&#125; redisDb;<br></code></pre></td></tr></table></figure>

<p>RedisÊòØÂ¶Ç‰ΩïÁü•ÈÅì‰∏Ä‰∏™keyÊòØÂê¶ËøáÊúüÂë¢Ôºü</p>
<ul>
<li>Âà©Áî®‰∏§‰∏™DictÂàÜÂà´ËÆ∞ÂΩïkey-valueÂØπÂèäkey-ttlÂØπ</li>
</ul>
<h4 id="ÊòØ‰∏çÊòØTTLÂà∞ÊúüÂ∞±Á´ãÂç≥Âà†Èô§‰∫ÜÂë¢Ôºü"><a href="#ÊòØ‰∏çÊòØTTLÂà∞ÊúüÂ∞±Á´ãÂç≥Âà†Èô§‰∫ÜÂë¢Ôºü" class="headerlink" title="ÊòØ‰∏çÊòØTTLÂà∞ÊúüÂ∞±Á´ãÂç≥Âà†Èô§‰∫ÜÂë¢Ôºü"></a>ÊòØ‰∏çÊòØTTLÂà∞ÊúüÂ∞±Á´ãÂç≥Âà†Èô§‰∫ÜÂë¢Ôºü</h4><p><strong>ÊÉ∞ÊÄßÂà†Èô§</strong><br>ÊÉ∞ÊÄßÂà†Èô§ÔºöÈ°æÊòéÊÄùËÆÆÂπ∂‰∏çÊòØÂú®TTLÂà∞ÊúüÂêéÂ∞±Á´ãÂàªÂà†Èô§ÔºåËÄåÊòØÂú®ËÆøÈóÆ‰∏Ä‰∏™keyÁöÑÊó∂ÂÄôÔºåÊ£ÄÊü•ËØ•keyÁöÑÂ≠òÊ¥ªÊó∂Èó¥ÔºåÂ¶ÇÊûúÂ∑≤ÁªèËøáÊúüÊâçÊâßË°åÂà†Èô§„ÄÇ</p>
<p><strong>Âë®ÊúüÂà†Èô§</strong><br>Âë®ÊúüÂà†Èô§ÔºöÈ°æÊòéÊÄùËÆÆÊòØÈÄöËøá‰∏Ä‰∏™ÂÆöÊó∂‰ªªÂä°ÔºåÂë®ÊúüÊÄßÁöÑ<strong>ÊäΩÊ†∑ÈÉ®ÂàÜËøáÊúüÁöÑkey</strong>ÔºåÁÑ∂ÂêéÊâßË°åÂà†Èô§„ÄÇÊâßË°åÂë®ÊúüÊúâ‰∏§ÁßçÔºö</p>
<ul>
<li>RedisÊúçÂä°ÂàùÂßãÂåñÂáΩÊï∞initServer()‰∏≠ËÆæÁΩÆÂÆöÊó∂‰ªªÂä°ÔºåÊåâÁÖßserver.hzÁöÑÈ¢ëÁéáÊù•ÊâßË°åËøáÊúükeyÊ∏ÖÁêÜÔºåÊ®°Âºè‰∏∫SLOW</li>
<li>RedisÁöÑÊØè‰∏™‰∫ã‰ª∂Âæ™ÁéØÂâç‰ºöË∞ÉÁî®beforeSleep()ÂáΩÊï∞ÔºåÊâßË°åËøáÊúükeyÊ∏ÖÁêÜÔºåÊ®°Âºè‰∏∫FAST</li>
</ul>
<p>SLOWÊ®°ÂºèËßÑÂàôÔºö</p>
<ul>
<li>ÊâßË°åÈ¢ëÁéáÂèóserver.hzÂΩ±ÂìçÔºåÈªòËÆ§‰∏∫10ÔºåÂç≥ÊØèÁßíÊâßË°å10Ê¨°ÔºåÊØè‰∏™ÊâßË°åÂë®Êúü100ms„ÄÇ</li>
<li>ÊâßË°åÊ∏ÖÁêÜËÄóÊó∂‰∏çË∂ÖËøá‰∏ÄÊ¨°ÊâßË°åÂë®ÊúüÁöÑ25%.ÈªòËÆ§slowÊ®°ÂºèËÄóÊó∂‰∏çË∂ÖËøá25ms</li>
<li>ÈÄê‰∏™ÈÅçÂéÜdbÔºåÈÄê‰∏™ÈÅçÂéÜdb‰∏≠ÁöÑbucketÔºåÊäΩÂèñ20‰∏™keyÂà§Êñ≠ÊòØÂê¶ËøáÊúü</li>
<li>Â¶ÇÊûúÊ≤°ËææÂà∞Êó∂Èó¥‰∏äÈôêÔºà25msÔºâÂπ∂‰∏îËøáÊúükeyÊØî‰æãÂ§ß‰∫é10%ÔºåÂÜçËøõË°å‰∏ÄÊ¨°ÊäΩÊ†∑ÔºåÂê¶ÂàôÁªìÊùü</li>
</ul>
<p>FASTÊ®°ÂºèËßÑÂàôÔºàËøáÊúükeyÊØî‰æãÂ∞è‰∫é10%‰∏çÊâßË°å ÔºâÔºö</p>
<ul>
<li>ÊâßË°åÈ¢ëÁéáÂèóbeforeSleep()Ë∞ÉÁî®È¢ëÁéáÂΩ±ÂìçÔºå‰ΩÜ‰∏§Ê¨°FASTÊ®°ÂºèÈó¥Èöî‰∏ç‰Ωé‰∫é2ms</li>
<li>ÊâßË°åÊ∏ÖÁêÜËÄóÊó∂‰∏çË∂ÖËøá1ms</li>
<li>ÈÄê‰∏™ÈÅçÂéÜdbÔºåÈÄê‰∏™ÈÅçÂéÜdb‰∏≠ÁöÑbucketÔºåÊäΩÂèñ20‰∏™keyÂà§Êñ≠ÊòØÂê¶ËøáÊúü<br>Â¶ÇÊûúÊ≤°ËææÂà∞Êó∂Èó¥‰∏äÈôêÔºà1msÔºâÂπ∂‰∏îËøáÊúükeyÊØî‰æãÂ§ß‰∫é10%ÔºåÂÜçËøõË°å‰∏ÄÊ¨°ÊäΩÊ†∑ÔºåÂê¶ÂàôÁªìÊùü</li>
</ul>
<h4 id="ÊÄªÁªì-3"><a href="#ÊÄªÁªì-3" class="headerlink" title="ÊÄªÁªì"></a>ÊÄªÁªì</h4><p>RedisKeyÁöÑTTLËÆ∞ÂΩïÊñπÂºèÔºö</p>
<ul>
<li>Âú®RedisDB‰∏≠ÈÄöËøá‰∏Ä‰∏™DictËÆ∞ÂΩïÊØè‰∏™KeyÁöÑTTLÊó∂Èó¥</li>
</ul>
<p>ËøáÊúükeyÁöÑÂà†Èô§Á≠ñÁï•Ôºö</p>
<ul>
<li>ÊÉ∞ÊÄßÊ∏ÖÁêÜÔºöÊØèÊ¨°Êü•ÊâækeyÊó∂Âà§Êñ≠ÊòØÂê¶ËøáÊúüÔºåÂ¶ÇÊûúËøáÊúüÂàôÂà†Èô§</li>
<li>ÂÆöÊúüÊ∏ÖÁêÜÔºöÂÆöÊúüÊäΩÊ†∑ÈÉ®ÂàÜkeyÔºåÂà§Êñ≠ÊòØÂê¶ËøáÊúüÔºåÂ¶ÇÊûúËøáÊúüÂàôÂà†Èô§„ÄÇ</li>
</ul>
<p>ÂÆöÊúüÊ∏ÖÁêÜÁöÑ‰∏§ÁßçÊ®°ÂºèÔºö</p>
<ul>
<li>SLOWÊ®°ÂºèÊâßË°åÈ¢ëÁéáÈªòËÆ§‰∏∫10ÔºåÊØèÊ¨°‰∏çË∂ÖËøá25ms</li>
<li>FASTÊ®°ÂºèÊâßË°åÈ¢ëÁéá‰∏çÂõ∫ÂÆöÔºå‰ΩÜ‰∏§Ê¨°Èó¥Èöî‰∏ç‰Ωé‰∫é2msÔºåÊØèÊ¨°ËÄóÊó∂‰∏çË∂ÖËøá1ms</li>
</ul>
<h3 id="4-2-ÂÜÖÂ≠òÊ∑òÊ±∞Á≠ñÁï•"><a href="#4-2-ÂÜÖÂ≠òÊ∑òÊ±∞Á≠ñÁï•" class="headerlink" title="4.2 ÂÜÖÂ≠òÊ∑òÊ±∞Á≠ñÁï•"></a>4.2 ÂÜÖÂ≠òÊ∑òÊ±∞Á≠ñÁï•</h3><p>ÂÜÖÂ≠òÊ∑òÊ±∞ÔºöÂ∞±ÊòØÂΩìRedisÂÜÖÂ≠ò‰ΩøÁî®ËææÂà∞ËÆæÁΩÆÁöÑ‰∏äÈôêÊó∂Ôºå‰∏ªÂä®ÊåëÈÄâÈÉ®ÂàÜkeyÂà†Èô§‰ª•ÈáäÊîæÊõ¥Â§öÂÜÖÂ≠òÁöÑÊµÅÁ®ã„ÄÇ<br>Redis‰ºöÂú®Â§ÑÁêÜÂÆ¢Êà∑Á´ØÂëΩ‰ª§ÁöÑÊñπÊ≥ïprocessCommand()‰∏≠Â∞ùËØïÂÅöÂÜÖÂ≠òÊ∑òÊ±∞</p>
<p>RedisÊîØÊåÅ8Áßç‰∏çÂêåÁ≠ñÁï•Êù•ÈÄâÊã©Ë¶ÅÂà†Èô§ÁöÑkeyÔºö</p>
<ul>
<li>noevictionÔºö ‰∏çÊ∑òÊ±∞‰ªª‰ΩïkeyÔºå‰ΩÜÊòØÂÜÖÂ≠òÊª°Êó∂‰∏çÂÖÅËÆ∏ÂÜôÂÖ•Êñ∞Êï∞ÊçÆÔºåÈªòËÆ§Â∞±ÊòØËøôÁßçÁ≠ñÁï•„ÄÇ</li>
<li>volatile-ttlÔºö ÂØπËÆæÁΩÆ‰∫ÜTTLÁöÑkeyÔºåÊØîËæÉkeyÁöÑÂâ©‰ΩôTTLÂÄºÔºåTTLË∂äÂ∞èË∂äÂÖàË¢´Ê∑òÊ±∞</li>
<li>allkeys-randomÔºöÂØπÂÖ®‰Ωìkey ÔºåÈöèÊú∫ËøõË°åÊ∑òÊ±∞„ÄÇ‰πüÂ∞±ÊòØÁõ¥Êé•‰ªédb-&gt;dict‰∏≠ÈöèÊú∫ÊåëÈÄâ</li>
<li>volatile-randomÔºöÂØπËÆæÁΩÆ‰∫ÜTTLÁöÑkey ÔºåÈöèÊú∫ËøõË°åÊ∑òÊ±∞„ÄÇ‰πüÂ∞±ÊòØ‰ªédb-&gt;expires‰∏≠ÈöèÊú∫ÊåëÈÄâ„ÄÇ</li>
<li>allkeys-lruÔºö ÂØπÂÖ®‰ΩìkeyÔºåÂü∫‰∫éLRUÁÆóÊ≥ïËøõË°åÊ∑òÊ±∞</li>
<li>volatile-lruÔºö ÂØπËÆæÁΩÆ‰∫ÜTTLÁöÑkeyÔºåÂü∫‰∫éLRUÁÆóÊ≥ïËøõË°åÊ∑òÊ±∞</li>
<li>allkeys-lfuÔºö ÂØπÂÖ®‰ΩìkeyÔºåÂü∫‰∫éLFUÁÆóÊ≥ïËøõË°åÊ∑òÊ±∞</li>
<li>volatile-lfuÔºö ÂØπËÆæÁΩÆ‰∫ÜTTLÁöÑkeyÔºåÂü∫‰∫éLFIÁÆóÊ≥ïËøõË°åÊ∑òÊ±∞</li>
</ul>
<p>ÊØîËæÉÂÆπÊòìÊ∑∑Ê∑ÜÁöÑÊúâ‰∏§‰∏™Ôºö</p>
<ul>
<li>LRUÔºàLeast Recently UsedÔºâÔºåÊúÄÂ∞ëÊúÄËøë‰ΩøÁî®„ÄÇÁî®ÂΩìÂâçÊó∂Èó¥ÂáèÂéªÊúÄÂêé‰∏ÄÊ¨°ËÆøÈóÆÊó∂Èó¥ÔºåËøô‰∏™ÂÄºË∂äÂ§ßÂàôÊ∑òÊ±∞‰ºòÂÖàÁ∫ßË∂äÈ´ò„ÄÇ</li>
<li>LFUÔºàLeast Frequently UsedÔºâÔºåÊúÄÂ∞ëÈ¢ëÁéá‰ΩøÁî®„ÄÇ‰ºöÁªüËÆ°ÊØè‰∏™keyÁöÑËÆøÈóÆÈ¢ëÁéáÔºåÂÄºË∂äÂ∞èÊ∑òÊ±∞‰ºòÂÖàÁ∫ßË∂äÈ´ò„ÄÇ</li>
</ul>
<p>RedisÁöÑÊï∞ÊçÆÈÉΩ‰ºöË¢´Â∞ÅË£Ö‰∏∫RedisObjectÁªìÊûÑÔºö</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisObject</span> &#123;</span><br>¬† ¬† <span class="hljs-type">unsigned</span> type:<span class="hljs-number">4</span>; ¬† ¬† ¬† ¬†<span class="hljs-comment">// ÂØπË±°Á±ªÂûã</span><br>¬† ¬† <span class="hljs-type">unsigned</span> encoding:<span class="hljs-number">4</span>; ¬† ¬†<span class="hljs-comment">// ÁºñÁ†ÅÊñπÂºè</span><br>¬† ¬† <span class="hljs-type">unsigned</span> lru:LRU_BITS; ¬†<span class="hljs-comment">// LRUÔºö‰ª•Áßí‰∏∫Âçï‰ΩçËÆ∞ÂΩïÊúÄËøë‰∏ÄÊ¨°ËÆøÈóÆÊó∂Èó¥ÔºåÈïøÂ∫¶24bit</span><br>              <span class="hljs-comment">// LFUÔºöÈ´ò16‰Ωç‰ª•ÂàÜÈíü‰∏∫Âçï‰ΩçËÆ∞ÂΩïÊúÄËøë‰∏ÄÊ¨°ËÆøÈóÆÊó∂Èó¥Ôºå‰Ωé8‰ΩçËÆ∞ÂΩïÈÄªËæëËÆøÈóÆÊ¨°Êï∞</span><br>¬† ¬† <span class="hljs-type">int</span> refcount; ¬† ¬† ¬† ¬† ¬† <span class="hljs-comment">// ÂºïÁî®ËÆ°Êï∞ÔºåËÆ°Êï∞‰∏∫0ÂàôÂèØ‰ª•ÂõûÊî∂</span><br>¬† ¬† <span class="hljs-type">void</span> *ptr; ¬† ¬† ¬† ¬† ¬† ¬† ¬†<span class="hljs-comment">// Êï∞ÊçÆÊåáÈíàÔºåÊåáÂêëÁúüÂÆûÊï∞ÊçÆ</span><br>&#125; robj;<br></code></pre></td></tr></table></figure>

<p>LFUÁöÑËÆøÈóÆÊ¨°Êï∞‰πãÊâÄ‰ª•Âè´ÂÅö<strong>ÈÄªËæëËÆøÈóÆÊ¨°Êï∞</strong>ÔºåÊòØÂõ†‰∏∫Âπ∂‰∏çÊòØÊØèÊ¨°keyË¢´ËÆøÈóÆÈÉΩËÆ°Êï∞ÔºåËÄåÊòØÈÄöËøáËøêÁÆóÔºö</p>
<ul>
<li>ÁîüÊàê0~1‰πãÈó¥ÁöÑÈöèÊú∫Êï∞R</li>
<li>ËÆ°ÁÆó (ÊóßÊ¨°Êï∞ * lfu_log_factor + 1)ÔºåËÆ∞ÂΩï‰∏∫P</li>
<li>Â¶ÇÊûú R &lt; P ÔºåÂàôËÆ°Êï∞Âô® + 1Ôºå‰∏îÊúÄÂ§ß‰∏çË∂ÖËøá255</li>
<li>ËÆøÈóÆÊ¨°Êï∞‰ºöÈöèÊó∂Èó¥Ë°∞ÂáèÔºåË∑ùÁ¶ª‰∏ä‰∏ÄÊ¨°ËÆøÈóÆÊó∂Èó¥ÊØèÈöî lfu_decay_time ÂàÜÈíüÔºåËÆ°Êï∞Âô® -1</li>
</ul>
<p><img src="/img/blogs/java/redis/4.4.1.png" srcset="/img/loading.gif" lazyload></p>
<hr>
<hr>
<hr>
<h1 id="‰∫î-ÈªëÈ©¨ÁÇπËØÑÁÆÄÂéÜ"><a href="#‰∫î-ÈªëÈ©¨ÁÇπËØÑÁÆÄÂéÜ" class="headerlink" title="‰∫î. ÈªëÈ©¨ÁÇπËØÑÁÆÄÂéÜ"></a>‰∫î. ÈªëÈ©¨ÁÇπËØÑÁÆÄÂéÜ</h1><p><strong>È°πÁõÆ‰∫ÆÁÇπÔºö</strong></p>
<ol>
<li>ÈááÁî® Redis ÂØπÈ´òÈ¢ëËÆøÈóÆÁöÑÂïÜÊà∑‰ø°ÊÅØËøõË°åÁºìÂ≠òÔºåÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÁöÑÂéãÂäõÔºåËß£ÂÜ≥‰∫ÜÁºìÂ≠òÁ©øÈÄè„ÄÅÈõ™Â¥©„ÄÅÂáªÁ©øÈóÆÈ¢ò</li>
<li>ÈÄöËøá ThreadLocal ‰øùÂ≠òÂ∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéÁßªÈô§ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÈú≤‰∏éËµÑÊ∫êÊµ™Ë¥π</li>
<li>Âà©Áî® Redisson ÂàÜÂ∏ÉÂºèÈîÅËß£ÂÜ≥ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºåÁªìÂêà‰πêËßÇÈîÅÊú∫Âà∂Èò≤Ê≠¢ÁßíÊùÄË∂ÖÂçñÈóÆÈ¢ò</li>
<li>Âü∫‰∫é Redis ÂÆûÁé∞ÂàÜÂ∏ÉÂºè Session ÂÖ±‰∫´Ôºå‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞</li>
<li>ÂÆûÁé∞Âü∫‰∫éÊé®Ê®°ÂºèÁöÑ Feed ÊµÅÂäüËÉΩÔºåÈááÁî®ÊªöÂä®ÂàÜÈ°µÔºåÁî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó</li>
<li>ÂÄüÂä© Redis ÁöÑ ZSet ÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºåÂà©Áî® Set Êï∞ÊçÆÁªìÊûÑÊîØÊåÅÁî®Êà∑ÂÖ≥Ê≥®‰∏éÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ</li>
</ol>
<h2 id="È°πÁõÆ‰∫ÆÁÇπËØ¶Ëß£"><a href="#È°πÁõÆ‰∫ÆÁÇπËØ¶Ëß£" class="headerlink" title="È°πÁõÆ‰∫ÆÁÇπËØ¶Ëß£"></a>È°πÁõÆ‰∫ÆÁÇπËØ¶Ëß£</h2><h3 id="1-ÈááÁî®-Redis-ÂØπÈ´òÈ¢ëËÆøÈóÆÁöÑÂïÜÊà∑‰ø°ÊÅØËøõË°åÁºìÂ≠òÔºåÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÁöÑÂéãÂäõÔºåËß£ÂÜ≥‰∫ÜÁºìÂ≠òÁ©øÈÄè„ÄÅÈõ™Â¥©„ÄÅÂáªÁ©øÈóÆÈ¢ò"><a href="#1-ÈááÁî®-Redis-ÂØπÈ´òÈ¢ëËÆøÈóÆÁöÑÂïÜÊà∑‰ø°ÊÅØËøõË°åÁºìÂ≠òÔºåÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÁöÑÂéãÂäõÔºåËß£ÂÜ≥‰∫ÜÁºìÂ≠òÁ©øÈÄè„ÄÅÈõ™Â¥©„ÄÅÂáªÁ©øÈóÆÈ¢ò" class="headerlink" title="1. ÈááÁî® Redis ÂØπÈ´òÈ¢ëËÆøÈóÆÁöÑÂïÜÊà∑‰ø°ÊÅØËøõË°åÁºìÂ≠òÔºåÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÁöÑÂéãÂäõÔºåËß£ÂÜ≥‰∫ÜÁºìÂ≠òÁ©øÈÄè„ÄÅÈõ™Â¥©„ÄÅÂáªÁ©øÈóÆÈ¢ò"></a>1. ÈááÁî® Redis ÂØπÈ´òÈ¢ëËÆøÈóÆÁöÑÂïÜÊà∑‰ø°ÊÅØËøõË°åÁºìÂ≠òÔºåÈôç‰Ωé‰∫ÜÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÁöÑÂéãÂäõÔºåËß£ÂÜ≥‰∫ÜÁºìÂ≠òÁ©øÈÄè„ÄÅÈõ™Â¥©„ÄÅÂáªÁ©øÈóÆÈ¢ò</h3><p><a href="#2-%E5%95%86%E6%88%B7%E6%9F%A5%E8%AF%A2%E7%BC%93%E5%AD%98">Ë∑≥ËΩ¨Âà∞ÂïÜÊà∑Êü•ËØ¢ÁºìÂ≠òËøô‰∏ÄËäÇ</a></p>
<h4 id="1-1-ÁºìÂ≠òÂíåÂÜÖÂ≠òÁöÑÂå∫Âà´Ôºü"><a href="#1-1-ÁºìÂ≠òÂíåÂÜÖÂ≠òÁöÑÂå∫Âà´Ôºü" class="headerlink" title="1.1 ÁºìÂ≠òÂíåÂÜÖÂ≠òÁöÑÂå∫Âà´Ôºü"></a>1.1 ÁºìÂ≠òÂíåÂÜÖÂ≠òÁöÑÂå∫Âà´Ôºü</h4><table>
<thead>
<tr>
<th>È°πÁõÆ</th>
<th>ÁºìÂ≠òÔºàCacheÔºâ</th>
<th>ÂÜÖÂ≠òÔºàMemoryÔºå‰πüÂè´‰∏ªÂ≠òÔºåRAMÔºâ</th>
</tr>
</thead>
<tbody><tr>
<td>ÂÆö‰πâ</td>
<td><strong>CPU‰∏éÂÜÖÂ≠ò‰πãÈó¥</strong>ÁöÑÈ´òÈÄüÁºìÂ≠òÔºåÁî®‰∫é<strong>Â≠òÊîæËøëÊúü‰ΩøÁî®ÁöÑÁÉ≠ÁÇπÊï∞ÊçÆ</strong></td>
<td>ËÆ°ÁÆóÊú∫ÁöÑ‰∏ªÂÜÖÂ≠òÔºåÁî®‰∫é<strong>Â≠òÂÇ®ÂΩìÂâçËøêË°å‰∏≠ÁöÑÁ®ãÂ∫èÂíåÊï∞ÊçÆ</strong></td>
</tr>
<tr>
<td>‰ΩúÁî®</td>
<td>ÊèêÈ´òCPUËÆøÈóÆÊï∞ÊçÆÁöÑÈÄüÂ∫¶ÔºåÂáèÂ∞ëÂØπÂÜÖÂ≠òÁöÑËÆøÈóÆÈ¢ëÁéá</td>
<td>Êèê‰æõËøêË°åÁ®ãÂ∫èÊó∂ÊâÄÈúÄÁöÑÊï∞ÊçÆÁ©∫Èó¥</td>
</tr>
</tbody></table>
<ul>
<li>Redis ÊòØ‰∏ÄÁßçÂ∏∏Áî®ÁöÑÁºìÂ≠òÊäÄÊúØÔºöÁî®Êù•ÁºìÂ≠òÁÉ≠ÁÇπÊï∞ÊçÆ„ÄÅÈ°µÈù¢„ÄÅSession Á≠âÔºåÂáèËΩªÊï∞ÊçÆÂ∫ìÂéãÂäõ(<strong>Âü∫‰∫éÂÜÖÂ≠òÔºåËÆøÈóÆÈÄüÂ∫¶ÈùûÂ∏∏Âø´</strong>)</li>
</ul>
<h4 id="1-2-‰ΩøÁî®RedisÊ∑ªÂä†ÂïÜÊà∑ÁºìÂ≠òÁöÑÊµÅÁ®ã"><a href="#1-2-‰ΩøÁî®RedisÊ∑ªÂä†ÂïÜÊà∑ÁºìÂ≠òÁöÑÊµÅÁ®ã" class="headerlink" title="1.2 ‰ΩøÁî®RedisÊ∑ªÂä†ÂïÜÊà∑ÁºìÂ≠òÁöÑÊµÅÁ®ã"></a>1.2 ‰ΩøÁî®RedisÊ∑ªÂä†ÂïÜÊà∑ÁºìÂ≠òÁöÑÊµÅÁ®ã</h4><ul>
<li>Êü•ËØ¢Êï∞ÊçÆÂ∫ì‰πãÂâçÂÖàÊü•ËØ¢ÁºìÂ≠òÔºåÂ¶ÇÊûúÁºìÂ≠òÊï∞ÊçÆÂ≠òÂú®ÔºåÂàôÁõ¥Êé•‰ªéÁºìÂ≠ò‰∏≠ËøîÂõûÔºåÂ¶ÇÊûúÁºìÂ≠òÊï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÂÜçÊü•ËØ¢Êï∞ÊçÆÂ∫ìÔºåÁÑ∂ÂêéÂ∞ÜÊï∞ÊçÆÂ≠òÂÖ•redis</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Result <span class="hljs-title function_">queryById</span><span class="hljs-params">(Long id)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> CACHE_SHOP_KEY + id;<br>    <span class="hljs-comment">// 1.‰ªéredisÊü•ËØ¢ÂïÜÈì∫ÁºìÂ≠ò</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">shopJson</span> <span class="hljs-operator">=</span> stringRedisTemplate.opsForValue().get(key);<br>    <span class="hljs-comment">// 2.Âà§Êñ≠ÊòØÂê¶Â≠òÂú®</span><br>    <span class="hljs-keyword">if</span> (StrUtil.isNotBlank(shopJson)) &#123;<br>        <span class="hljs-comment">// 3.Â≠òÂú®,Áõ¥Êé•ËøîÂõû</span><br>        <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> JSONUtil.toBean(shopJson, Shop.class);<br>        <span class="hljs-keyword">return</span> Result.ok(shop);<br>    &#125;<br>    <span class="hljs-comment">// 4.‰∏çÂ≠òÂú®,Ê†πÊçÆidÊü•ËØ¢Êï∞ÊçÆÂ∫ì</span><br>    <span class="hljs-type">Shop</span> <span class="hljs-variable">shop</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 5.‰∏çÂ≠òÂú®,ËøîÂõûÈîôËØØ</span><br>    <span class="hljs-keyword">if</span> (shop == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">&quot;Â∫óÈì∫‰∏çÂ≠òÂú®!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">//6.Â≠òÂú®,ÂÜôÂÖ•redis</span><br>    stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(shop));<br>    <span class="hljs-comment">// 7.ËøîÂõû</span><br>    <span class="hljs-keyword">return</span> Result.ok(shop);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="1-3-Â¶Ç‰Ωï‰øùËØÅÊï∞ÊçÆÂ∫ìÂíåÁºìÂ≠òÁöÑ‰∏ÄËá¥ÊÄßÔºü"><a href="#1-3-Â¶Ç‰Ωï‰øùËØÅÊï∞ÊçÆÂ∫ìÂíåÁºìÂ≠òÁöÑ‰∏ÄËá¥ÊÄßÔºü" class="headerlink" title="1.3 Â¶Ç‰Ωï‰øùËØÅÊï∞ÊçÆÂ∫ìÂíåÁºìÂ≠òÁöÑ‰∏ÄËá¥ÊÄßÔºü"></a>1.3 Â¶Ç‰Ωï‰øùËØÅÊï∞ÊçÆÂ∫ìÂíåÁºìÂ≠òÁöÑ‰∏ÄËá¥ÊÄßÔºü</h4><p><a href="#23-%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5">Ë∑≥ËΩ¨Âà∞ÁºìÂ≠òÊõ¥Êñ∞Á≠ñÁï•Ëøô‰∏ÄËäÇ</a></p>
<p>Â¶ÇÊûúÊõ¥Êñ∞‰∫ÜÊï∞ÊçÆÂ∫ìÔºåÂØºËá¥Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊï∞ÊçÆÂÜÖÂÆπÂíåÂΩìÂâçÁºìÂ≠ò‰∏≠‰øùÁïôÁöÑ‰ª•ÂâçÁöÑÂÜÖÂÆπ‰∏ç‰∏ÄËá¥„ÄÇÂ¶Ç‰Ωï‰øùËØÅ‰∏ÄËá¥ÊÄßÔºü</p>
<ul>
<li>Êï∞ÊçÆÂ∫ìÊòØÊñ∞ÁöÑÔºåÁºìÂ≠òÊòØÊóßÁöÑ ‚Äî‚Äî Êï∞ÊçÆËÑèËØª</li>
</ul>
<ol>
<li>ÂÖàÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì</li>
<li>ÂÜçÂà†Èô§ÁºìÂ≠ò</li>
<li>‰∏ãÊ¨°ËØ∑Ê±ÇËØªÁºìÂ≠ò -&gt; ÂèëÁé∞Ê≤°‰∫Ü -&gt; ËØªÊï∞ÊçÆÂ∫ì -&gt; ÂÜçÂÜôÂÖ•ÁºìÂ≠ò</li>
</ol>
<p>Â¶Ç‰Ωï‰øùËØÅÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÁöÑÊìç‰ΩúÁöÑÂêåÊó∂ÊàêÂäüÊàñÂ§±Ë¥•Ôºü</p>
<ul>
<li>Âçï‰ΩìÁ≥ªÁªüÔºåÂ∞ÜÁºìÂ≠ò‰∏éÊï∞ÊçÆÂ∫ìÊìç‰ΩúÊîæÂú®‰∏Ä‰∏™‰∫ãÂä°</li>
<li>ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÔºåÂà©Áî®TCCÁ≠âÂàÜÂ∏ÉÂºè‰∫ãÂä°ÊñπÊ°à</li>
</ul>
<h4 id="1-4-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÔºü"><a href="#1-4-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÔºü" class="headerlink" title="1.4 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÔºü"></a>1.4 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÔºü</h4><p><a href="#25-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F">Ë∑≥ËΩ¨Âà∞ÁºìÂ≠òÁ©øÈÄèËøô‰∏ÄËäÇ</a></p>
<ul>
<li>ÁºìÂ≠òÁ©øÈÄèÊòØÊåáÂÆ¢Êà∑Á´Ø<strong>ËØ∑Ê±ÇÁöÑÊï∞ÊçÆÂú®ÁºìÂ≠ò‰∏≠ÂíåÊï∞ÊçÆÂ∫ì‰∏≠ÈÉΩ‰∏çÂ≠òÂú®</strong>ÔºåËøôÊ†∑ÁºìÂ≠òÊ∞∏Ëøú‰∏ç‰ºöÁîüÊïàÔºåËøô‰∫õËØ∑Ê±ÇÈÉΩ‰ºöÊâìÂà∞Êï∞ÊçÆÂ∫ì</li>
</ul>
<p>Â∏∏ËßÅÁöÑËß£ÂÜ≥ÊñπÊ°àÊúâ‰∏§ÁßçÔºö</p>
<ul>
<li>ÁºìÂ≠òÁ©∫ÂØπË±°</li>
<li>Â∏ÉÈöÜËøáÊª§Âô®</li>
</ul>
<p><strong>Â¶Ç‰Ωï‰ΩøÁî®Â∏ÉÈöÜËøáÊª§Âô®Ëß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÈóÆÈ¢òÔºü</strong><br>Áî®Â∏ÉÈöÜËøáÊª§Âô®ÊèêÂâçËÆ∞ÂΩï ÊâÄÊúâÂêàÊ≥ïÁöÑ keyÔºàÊØîÂ¶ÇÁî®Êà∑ ID„ÄÅÂïÜÂìÅ IDÔºâ</p>
<ul>
<li>ËØ∑Ê±ÇËøõÊù•ÂÖàÊü•Â∏ÉÈöÜËøáÊª§Âô®</li>
<li>Â¶ÇÊûúÂ∏ÉÈöÜËøáÊª§Âô®ÈáåÈÉΩÊ≤°ÊúâÔºåÈÇ£Â∞±<strong>Áõ¥Êé•Êã¶Êà™</strong>Ôºå‰∏çÁî®Êü• Redis„ÄÅÊï∞ÊçÆÂ∫ì‰∫Ü„ÄÇ</li>
</ul>
<p>Â∏ÉÈöÜËøáÊª§Âô®ÈÄöËøáËÆ∞ÂΩïÊâÄÊúâ‚ÄúÂêàÊ≥ï key‚ÄùÔºå<strong>Âú®ËÆøÈóÆÁºìÂ≠òÂâçÂø´ÈÄüÊã¶Êà™ÊéâÈùûÊ≥ïËØ∑Ê±Ç</strong>Ôºå‰ªéËÄåËß£ÂÜ≥ÁºìÂ≠òÁ©øÈÄèÈóÆÈ¢ò</p>
<p><strong>Â∏ÉÈöÜËøáÊª§Ôºö<strong>Â∏ÉÈöÜËøáÊª§Âô®ÂÖ∂ÂÆûÈááÁî®ÁöÑÊòØ</strong>ÂìàÂ∏åÊÄùÊÉ≥</strong>Êù•Ëß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåÈÄöËøá‰∏Ä‰∏™Â∫ûÂ§ßÁöÑ‰∫åËøõÂà∂Êï∞ÁªÑÔºåËµ∞ÂìàÂ∏åÊÄùÊÉ≥ÂéªÂà§Êñ≠ÂΩìÂâçËøô‰∏™Ë¶ÅÊü•ËØ¢ÁöÑËøô‰∏™Êï∞ÊçÆÊòØÂê¶Â≠òÂú®ÔºåÂ¶ÇÊûúÂ∏ÉÈöÜËøáÊª§Âô®Âà§Êñ≠Â≠òÂú®ÔºåÂàôÊîæË°åÔºåËøô‰∏™ËØ∑Ê±Ç‰ºöÂéªËÆøÈóÆredisÔºåÂì™ÊÄïÊ≠§Êó∂redis‰∏≠ÁöÑÊï∞ÊçÆËøáÊúü‰∫ÜÔºå‰ΩÜÊòØÊï∞ÊçÆÂ∫ì‰∏≠‰∏ÄÂÆöÂ≠òÂú®Ëøô‰∏™Êï∞ÊçÆÔºåÂú®Êï∞ÊçÆÂ∫ì‰∏≠Êü•ËØ¢Âá∫Êù•Ëøô‰∏™Êï∞ÊçÆÂêéÔºåÂÜçÂ∞ÜÂÖ∂ÊîæÂÖ•Âà∞redis‰∏≠Ôºå</p>
<p>ÂÅáËÆæÂ∏ÉÈöÜËøáÊª§Âô®Âà§Êñ≠Ëøô‰∏™Êï∞ÊçÆ‰∏çÂ≠òÂú®ÔºåÂàôÁõ¥Êé•ËøîÂõû</p>
<p>ËøôÁßçÊñπÂºè‰ºòÁÇπÂú®‰∫éËäÇÁ∫¶ÂÜÖÂ≠òÁ©∫Èó¥ÔºåÂ≠òÂú®ËØØÂà§ÔºåËØØÂà§ÂéüÂõ†Âú®‰∫éÔºö<strong>Â∏ÉÈöÜËøáÊª§Âô®Ëµ∞ÁöÑÊòØÂìàÂ∏åÊÄùÊÉ≥ÔºåÂè™Ë¶ÅÂìàÂ∏åÊÄùÊÉ≥ÔºåÂ∞±ÂèØËÉΩÂ≠òÂú®ÂìàÂ∏åÂÜ≤Á™Å</strong></p>
<ul>
<li>Êúâ‰∏ÄÂÆöËØØÂà§ÁéáÔºöÂèØËÉΩ‰ºöËØØÂà§‰∏∫Â≠òÂú®Ôºå‰ΩÜ‰∏ç‰ºöËØØÂà§‰∏∫‰∏çÂ≠òÂú®</li>
</ul>
<h4 id="1-5-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÈõ™Â¥©Ôºü"><a href="#1-5-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÈõ™Â¥©Ôºü" class="headerlink" title="1.5 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÈõ™Â¥©Ôºü"></a>1.5 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÈõ™Â¥©Ôºü</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_52031708/article/details/142862864?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522171eed587531abcfcf154d766791ee79%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=171eed587531abcfcf154d766791ee79&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-5-142862864-null-null.142%5Ev102%5Epc_search_result_base2&utm_term=caffeine%20redis%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98&spm=1018.2226.3001.4187">‰ΩøÁî®Caffeine+RedisÂÆûÁé∞Â∫îÁî®Á∫ß‰∫åÂ±ÇÁºìÂ≠ò</a></p>
<p>ÁºìÂ≠òÈõ™Â¥©ÊòØÊåáÂú®Âêå‰∏ÄÊó∂ÊÆµÂ§ßÈáèÁöÑÁºìÂ≠òkeyÂêåÊó∂Â§±ÊïàÊàñËÄÖ<strong>RedisÊúçÂä°ÂÆïÊú∫</strong>ÔºåÂØºËá¥Â§ßÈáèËØ∑Ê±ÇÂà∞ËææÊï∞ÊçÆÂ∫ìÔºåÂ∏¶Êù•Â∑®Â§ßÂéãÂäõ„ÄÇ</p>
<p>Ëß£ÂÜ≥ÊñπÊ°àÔºö</p>
<ul>
<li>Áªô‰∏çÂêåÁöÑKeyÁöÑTTLÊ∑ªÂä†ÈöèÊú∫ÂÄºÔºàÂêå‰∏ÄÊó∂ÊÆµÔºåÁªô‰∏çÂêåkeyËÆæÁΩÆ‰∏çÂêåÁöÑTTLÔºâ</li>
<li>Âà©Áî®RedisÈõÜÁæ§ÊèêÈ´òÊúçÂä°ÁöÑÂèØÁî®ÊÄß</li>
<li>ÁªôÁºìÂ≠ò‰∏öÂä°Ê∑ªÂä†ÈôçÁ∫ßÈôêÊµÅÁ≠ñÁï•ÔºàÂæÆÊúçÂä°Ôºâ</li>
<li>Áªô‰∏öÂä°Ê∑ªÂä†Â§öÁ∫ßÁºìÂ≠ò</li>
</ul>
<p>ËøôÈáåÊàëÈááÁî®<strong>Â§öÁ∫ßÁºìÂ≠ò</strong>ÁöÑÊñπÂºèËß£ÂÜ≥ÁºìÂ≠òÈõ™Â¥©ÈóÆÈ¢ò<br>Â§öÁ∫ßÁºìÂ≠ò &#x3D; Êú¨Âú∞ÁºìÂ≠òÔºàÂ¶Ç CaffeineÔºâ + ÂàÜÂ∏ÉÂºèÁºìÂ≠òÔºàÂ¶Ç RedisÔºâ</p>
<p>‰ΩøÁî®ÊµÅÁ®ãÂ§ßËá¥Â¶Ç‰∏ãÔºö</p>
<ol>
<li>È¶ñÂÖà‰ªé‰∏ÄÁ∫ßÁºìÂ≠òÔºàcaffeine-Êú¨Âú∞Â∫îÁî®ÂÜÖÔºâ‰∏≠Êü•ÊâæÊï∞ÊçÆÔºõ</li>
<li>Â¶ÇÊûúÊ≤°ÊúâÁöÑËØùÔºåÂàô‰ªé‰∫åÁ∫ßÁºìÂ≠òÔºàredis-ÂÜÖÂ≠òÔºâ‰∏≠Êü•ÊâæÊï∞ÊçÆÔºõ</li>
<li>Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÁöÑËØùÔºåÂÜç‰ªéÊï∞ÊçÆÂ∫ìÔºàÊï∞ÊçÆÂ∫ì-Á£ÅÁõòÔºâ‰∏≠Êü•ÊâæÊï∞ÊçÆÔºõ</li>
</ol>
<h4 id="1-6-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÔºü"><a href="#1-6-Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÔºü" class="headerlink" title="1.6 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÔºü"></a>1.6 Â¶Ç‰ΩïËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©øÔºü</h4><p>Êüê‰∏™ÁÉ≠ÁÇπ key Âú®Áû¨Èó¥Â§±ÊïàÔºåÂ§ßÈáèÂπ∂ÂèëËØ∑Ê±ÇÂêåÊó∂ËÆøÈóÆËøô‰∏™ keyÔºåÁºìÂ≠òÊ≤°ÂëΩ‰∏≠ÔºåÂØºËá¥Âπ∂ÂèëÊâìÂà∞Êï∞ÊçÆÂ∫ì„ÄÇ</p>
<p><a href="#27-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF">Ë∑≥ËΩ¨Âà∞ÁºìÂ≠òÂáªÁ©øËøô‰∏ÄËäÇ</a></p>
<p><strong>ËøôÈáåÊàëÁî®ÁöÑÊòØ‰∫íÊñ•ÈîÅÁöÑÊñπÂºèËß£ÂÜ≥ÁºìÂ≠òÂáªÁ©ø</strong></p>
<p>Â∏∏ËßÅÁöÑËß£ÂÜ≥ÊñπÊ°àÊúâÔºö</p>
<ul>
<li><strong>‰∫íÊñ•ÈîÅ</strong>: ÂΩìÁºìÂ≠òÂ§±ÊïàÊó∂ÔºåÁ¨¨‰∏Ä‰∏™Á∫øÁ®ãËé∑ÂèñÈîÅÂπ∂Êü•ËØ¢Êï∞ÊçÆÂ∫ìÔºåÂÖ∂ÂÆÉÁ∫øÁ®ãÁ≠âÂæÖ„ÄÇ</li>
<li>ËÆæÁΩÆÊ∞∏‰∏çËøáÊúü + ÂêéÂè∞ÂÆöÊó∂ÂºÇÊ≠•Êõ¥Êñ∞ÁºìÂ≠ò(ÂΩìÁÉ≠ÁÇπkeyÁöÑÊï∞ÈáèÂ∞ëÔºåÂç†Áî®ÂÜÖÂ≠òÂ∞ëÁöÑÊó∂ÂÄô)</li>
<li>ÈÄªËæëËøáÊúü</li>
</ul>
<p><strong>ËÆæÁΩÆÊ∞∏‰∏çËøáÊúü + ÂêéÂè∞ÂÆöÊó∂ÂºÇÊ≠•Êõ¥Êñ∞ÁºìÂ≠ò</strong></p>
<ul>
<li>‰Ω†‰∏çËÆ©ÁºìÂ≠òËá™ÁÑ∂ËøáÊúüÔºåËÄåÊòØÁî® ‰∏ªÂä®Âà∑Êñ∞ Êù•Áª¥ÊåÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄß</li>
<li>‰∏ç‰ºöÂ§±ÊïàÔºåËá™ÁÑ∂‰πü‰∏ç‰ºöÂáªÁ©ø</li>
</ul>
<p><strong>ÈÄªËæëËøáÊúü</strong></p>
<ul>
<li>Êàë‰ª¨ÊääËøáÊúüÊó∂Èó¥ËÆæÁΩÆÂú® redisÁöÑvalue‰∏≠ÔºåÊ≥®ÊÑèÔºöËøô‰∏™ËøáÊúüÊó∂Èó¥Âπ∂‰∏ç‰ºöÁõ¥Êé•‰ΩúÁî®‰∫éredisÔºåËÄåÊòØÊàë‰ª¨ÂêéÁª≠ÈÄöËøáÈÄªËæëÂéªÂ§ÑÁêÜ</li>
<li>ÂÅáËÆæÁ∫øÁ®ã1ÂéªÊü•ËØ¢ÁºìÂ≠òÔºåÁÑ∂Âêé‰ªévalue‰∏≠Âà§Êñ≠Âá∫Êù•ÂΩìÂâçÁöÑÊï∞ÊçÆÂ∑≤ÁªèËøáÊúü‰∫ÜÔºåÊ≠§Êó∂Á∫øÁ®ã1ÂéªËé∑Âæó‰∫íÊñ•ÈîÅÔºåÈÇ£‰πàÂÖ∂‰ªñÁ∫øÁ®ã‰ºöËøõË°åÈòªÂ°û</li>
<li>Ëé∑Âæó‰∫ÜÈîÅÁöÑÁ∫øÁ®ã‰ªñ‰ºöÂºÄÂêØ‰∏Ä‰∏™ Á∫øÁ®ãÂéªËøõË°å ‰ª•ÂâçÁöÑÈáçÊûÑÊï∞ÊçÆÁöÑÈÄªËæëÔºåÁõ¥Âà∞Êñ∞ÂºÄÁöÑÁ∫øÁ®ãÂÆåÊàêËøô‰∏™ÈÄªËæëÂêéÔºåÊâçÈáäÊîæÈîÅÔºå ËÄåÁ∫øÁ®ã1Áõ¥Êé•ËøõË°åËøîÂõû</li>
<li>ÂÅáËÆæÁé∞Âú®Á∫øÁ®ã3ËøáÊù•ËÆøÈóÆÔºåÁî±‰∫éÁ∫øÁ®ãÁ∫øÁ®ã2ÊåÅÊúâÁùÄÈîÅÔºåÊâÄ‰ª•Á∫øÁ®ã3Êó†Ê≥ïËé∑ÂæóÈîÅÔºåÁ∫øÁ®ã3‰πüÁõ¥Êé•ËøîÂõûÊï∞ÊçÆ</li>
<li>Âè™ÊúâÁ≠âÂà∞Êñ∞ÂºÄÁöÑÁ∫øÁ®ã2ÊääÈáçÂª∫Êï∞ÊçÆÊûÑÂª∫ÂÆåÂêéÔºåÂÖ∂‰ªñÁ∫øÁ®ãÊâçËÉΩËµ∞ËøîÂõûÊ≠£Á°ÆÁöÑÊï∞ÊçÆ„ÄÇ</li>
</ul>
<h3 id="2-ÈÄöËøá-ThreadLocal-‰øùÂ≠òÂ∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéÁßªÈô§ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÈú≤‰∏éËµÑÊ∫êÊµ™Ë¥π"><a href="#2-ÈÄöËøá-ThreadLocal-‰øùÂ≠òÂ∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéÁßªÈô§ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÈú≤‰∏éËµÑÊ∫êÊµ™Ë¥π" class="headerlink" title="2. ÈÄöËøá ThreadLocal ‰øùÂ≠òÂ∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéÁßªÈô§ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÈú≤‰∏éËµÑÊ∫êÊµ™Ë¥π"></a>2. ÈÄöËøá ThreadLocal ‰øùÂ≠òÂ∑≤ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÔºåËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéÁßªÈô§ÔºåÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÈú≤‰∏éËµÑÊ∫êÊµ™Ë¥π</h3><h4 id="2-1-‰∏∫‰ªÄ‰πà‰∏ç‰ΩøÁî®sessionÂ≠òÂÇ®Áî®Êà∑‰ø°ÊÅØÔºåËÄåÊòØ‰ΩøÁî®ThreadLocalÂ≠òÊîæÁî®Êà∑‰ø°ÊÅØÔºü"><a href="#2-1-‰∏∫‰ªÄ‰πà‰∏ç‰ΩøÁî®sessionÂ≠òÂÇ®Áî®Êà∑‰ø°ÊÅØÔºåËÄåÊòØ‰ΩøÁî®ThreadLocalÂ≠òÊîæÁî®Êà∑‰ø°ÊÅØÔºü" class="headerlink" title="2.1 ‰∏∫‰ªÄ‰πà‰∏ç‰ΩøÁî®sessionÂ≠òÂÇ®Áî®Êà∑‰ø°ÊÅØÔºåËÄåÊòØ‰ΩøÁî®ThreadLocalÂ≠òÊîæÁî®Êà∑‰ø°ÊÅØÔºü"></a>2.1 ‰∏∫‰ªÄ‰πà‰∏ç‰ΩøÁî®sessionÂ≠òÂÇ®Áî®Êà∑‰ø°ÊÅØÔºåËÄåÊòØ‰ΩøÁî®ThreadLocalÂ≠òÊîæÁî®Êà∑‰ø°ÊÅØÔºü</h4><ol>
<li>Session ‰æùËµñÊúçÂä°Á´ØÁä∂ÊÄÅÔºå‰∏çÈÄÇÂêàÂàÜÂ∏ÉÂºèÂú∫ÊôØ(SessionÂÖ±‰∫´ÈóÆÈ¢ò)<ul>
<li>HttpSession ÊòØÊúçÂä°Á´ØÁä∂ÊÄÅÔºå‰ºöËØù‰ø°ÊÅØÈªòËÆ§‰øùÂ≠òÂú®ÊúçÂä°Á´ØÂÜÖÂ≠ò‰∏≠ÔºàÂ¶Ç Tomcat ÂÜÖÈÉ®Ôºâ„ÄÇ</li>
<li>Âú®<strong>ÂàÜÂ∏ÉÂºèÈÉ®ÁΩ≤</strong>Êó∂ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂÅö Session ÂÖ±‰∫´ÔºàÂ¶Ç‰ΩøÁî® Redis SessionÔºâÔºå<strong>Áî®Êà∑ÂèØËÉΩÊØèÊ¨°ËØ∑Ê±Ç‰ºöÊâìÂà∞‰∏çÂêåÁöÑÊúçÂä°ËäÇÁÇπÔºåÂØºËá¥ Session ‰∏¢Â§±</strong>„ÄÇ</li>
</ul>
</li>
<li>Â¶ÇÊûúÈÅáÂà∞<strong>È´òÂπ∂Âèë</strong>ÔºåÂ§ö‰∫∫ÂêåÊó∂ÁôªÂΩïÁ≥ªÁªüÊó∂Ôºå‰ºöÂá∫Áé∞sessionÊ∑∑‰π±</li>
<li>ThreadLocal ‰∏∫ÊØè‰∏™Á∫øÁ®ãÁª¥Êä§‰∏Ä‰∏™Áã¨Á´ãÂâØÊú¨ÔºåÂ§©ÁÑ∂Á∫øÁ®ãÈöîÁ¶ªÔºåÈÅøÂÖçÂπ∂ÂèëËÆøÈóÆÂ∏¶Êù•ÁöÑÊï∞ÊçÆÂÆâÂÖ®ÈóÆÈ¢ò</li>
<li>Êàë‰ª¨ÂèØ‰ª•ÂÄüÂä©Ëøô‰∏™ThreadLocalÊù•Â≠òÂÇ®ÁôªÂΩïÁî®Êà∑ÁöÑ‰ø°ÊÅØÔºå<strong>Âú®‰∏Ä‰∏™ËØ∑Ê±Ç‰∏≠ÔºåÊâÄÊúâË∞ÉÁî®ÁöÑÊñπÊ≥ïÈÉΩÂú®Âêå‰∏Ä‰∏™Á∫øÁ®ã‰∏≠ÂéªÂ§ÑÁêÜ</strong>ÔºåËøôÊ†∑Â∞±ÂÆûÁé∞‰∫Ü<strong>Âú®‰ªª‰ΩïÂú∞ÊñπÈÉΩÂèØ‰ª•Ëé∑ÂèñÂà∞Áî®Êà∑‰ø°ÊÅØ</strong>‰∫Ü„ÄÇ</li>
<li><strong>ÊîæÂà∞ ThreadLocal Â∞±ÂèØ‰ª•‰∏çÁî®ÊØèÊ¨°ÈÉΩÊü• Redis</strong>„ÄÇÂ¶ÇÊûú‰Ω†ÊääËøô‰∏™ UserDTO Â≠òÂà∞ ThreadLocal ‰∏≠ÔºåÈÇ£‰πàÂú®Ëøô‰∏ÄËØ∑Ê±ÇÁîüÂëΩÂë®ÊúüÂÜÖÔºåÂêéÁª≠‰ªª‰ΩïÂú∞ÊñπÂ∞±<strong>ÂèØ‰ª•Áõ¥Êé•‰ªé ThreadLocal ÂèñÂá∫Áî®Êà∑‰ø°ÊÅØ</strong>ÔºåËÄå‰∏çÁî®ÈáçÂ§ç‰ªé Redis Êü•ËØ¢ÊàñÂ§öÂ±Ç‰º†ÂèÇ„ÄÇ</li>
</ol>
<h4 id="2-2-ÂÆåÊï¥ÁöÑÁî®Êà∑ÁôªÂΩï-Êã¶Êà™Âô®Èâ¥ÊùÉ-ThreadLocal-Áî®Êà∑‰∏ä‰∏ãÊñáÁÆ°ÁêÜ"><a href="#2-2-ÂÆåÊï¥ÁöÑÁî®Êà∑ÁôªÂΩï-Êã¶Êà™Âô®Èâ¥ÊùÉ-ThreadLocal-Áî®Êà∑‰∏ä‰∏ãÊñáÁÆ°ÁêÜ" class="headerlink" title="2.2 ÂÆåÊï¥ÁöÑÁî®Êà∑ÁôªÂΩï + Êã¶Êà™Âô®Èâ¥ÊùÉ + ThreadLocal Áî®Êà∑‰∏ä‰∏ãÊñáÁÆ°ÁêÜ"></a>2.2 ÂÆåÊï¥ÁöÑÁî®Êà∑ÁôªÂΩï + Êã¶Êà™Âô®Èâ¥ÊùÉ + ThreadLocal Áî®Êà∑‰∏ä‰∏ãÊñáÁÆ°ÁêÜ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">‚îú‚îÄ‚îÄ config<br>‚îÇ   ‚îî‚îÄ‚îÄ LoginInterceptor.java      <span class="hljs-comment">// ÁôªÂΩïÊã¶Êà™Âô®</span><br>‚îú‚îÄ‚îÄ dto<br>‚îÇ   ‚îî‚îÄ‚îÄ UserDTO.java               <span class="hljs-comment">// ÁôªÂΩïÁî®Êà∑‰ø°ÊÅØÁÆÄÂåñÂ∞ÅË£Ö</span><br>‚îú‚îÄ‚îÄ utils<br>‚îÇ   ‚îî‚îÄ‚îÄ UserHolder.java           <span class="hljs-comment">// ThreadLocal Áî®Êà∑‰∏ä‰∏ãÊñáÁÆ°ÁêÜ</span><br>‚îú‚îÄ‚îÄ controller<br>‚îÇ   ‚îî‚îÄ‚îÄ UserController.java        <span class="hljs-comment">// ÁôªÂΩïÁõ∏ÂÖ≥Êé•Âè£</span><br>‚îú‚îÄ‚îÄ service<br>‚îÇ   ‚îî‚îÄ‚îÄ UserService.java           <span class="hljs-comment">// ÁôªÂΩïÈÄªËæëÔºàÂê´Redis tokenÊ†°È™åÔºâ</span><br>‚îî‚îÄ‚îÄ ...<br></code></pre></td></tr></table></figure>


<ol>
<li>ÂÆö‰πâÁî®Êà∑ÂÆû‰ΩìÔºö<code>UserDTO</code>(Áî®‰∫éÂ≠òÂÇ®ÁôªÂΩïÁî®Êà∑ÁöÑÁÆÄÂåñ‰ø°ÊÅØ)</li>
<li>ÂÆö‰πâÂ∑•ÂÖ∑Á±ª<code>UserHolder</code>Êìç‰ΩúThreadLocalÔºàÂ≠òÊîæÔºåËé∑ÂèñÔºåÂà†Èô§Áî®Êà∑‰ø°ÊÅØÔºâ</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserHolder</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;UserDTO&gt; tl = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-comment">//‰øùÂ≠òÁî®Êà∑‰ø°ÊÅØ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveUser</span><span class="hljs-params">(UserDTO user)</span>&#123;<br>        tl.set(user);<br>    &#125;<br><br>    <span class="hljs-comment">//Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> UserDTO <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> tl.get();<br>    &#125;<br><br>    <span class="hljs-comment">//Âà†Èô§Áî®Êà∑‰ø°ÊÅØ</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">removeUser</span><span class="hljs-params">()</span>&#123;<br>        tl.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>ÁôªÂΩïÊã¶Êà™Âô®ÔºöÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊã¶Êà™ÔºàThreadLocal‰∏≠ÊòØÂê¶ÊúâÁî®Êà∑Ôºâ<ul>
<li>ËÆøÈóÆÊé•Âè£Êó∂Â∞ÜÁî®Êà∑‰ø°ÊÅØÊîæÂÖ•ThreadLocal</li>
<li>ËÆøÈóÆÁªìÊùüÊó∂ÂÄôÂà†Èô§ThreadLocal‰∏≠‰ø°ÊÅØÔºàÁ∫øÁ®ãÊîæÂÖ•Á∫øÁ®ãÊ±†Âπ∂‰∏ç‰∏ÄÂÆö‰ºöÈîÄÊØÅÔºâ</li>
</ul>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1.Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÊã¶Êà™ÔºàThreadLocal‰∏≠ÊòØÂê¶ÊúâÁî®Êà∑Ôºâ</span><br>        <span class="hljs-keyword">if</span> (UserHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// Ê≤°ÊúâÔºåÈúÄË¶ÅÊã¶Êà™ÔºåËÆæÁΩÆÁä∂ÊÄÅÁ†Å</span><br>            response.setStatus(<span class="hljs-number">401</span>);<br>            <span class="hljs-comment">// Êã¶Êà™</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-comment">// ÊúâÁî®Êà∑ÔºåÂàôÊîæË°å</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ÈÖçÁΩÆÊã¶Êà™Âô®ÔºåËÆ©Êã¶Êà™Âô®ÁîüÊïà(Êã¶Êà™ÈúÄË¶ÅÁôªÂΩïÁöÑÊé•Âè£)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoginInterceptor loginInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// Êã¶Êà™ÈúÄË¶ÅÁôªÂΩïÁöÑÊé•Âè£</span><br>        registry.addInterceptor(loginInterceptor)<br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>) <span class="hljs-comment">// ÂèØÁªÜÂåñË∑ØÂæÑ</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/user/login&quot;</span>, <span class="hljs-string">&quot;/user/register&quot;</span>, <span class="hljs-string">&quot;/static/**&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-3-‰∏∫‰ªÄ‰πàËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéË¶ÅÁßªÈô§-ThreadLocal-ÁöÑÂÄºÔºü"><a href="#2-3-‰∏∫‰ªÄ‰πàËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéË¶ÅÁßªÈô§-ThreadLocal-ÁöÑÂÄºÔºü" class="headerlink" title="2.3 ‰∏∫‰ªÄ‰πàËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéË¶ÅÁßªÈô§ ThreadLocal ÁöÑÂÄºÔºü"></a>2.3 ‰∏∫‰ªÄ‰πàËØ∑Ê±ÇÂ§ÑÁêÜÂÆåÂêéË¶ÅÁßªÈô§ ThreadLocal ÁöÑÂÄºÔºü</h4><p>ÁõÆÁöÑÔºö<strong>ÈÅøÂÖçÂÜÖÂ≠òÊ≥ÑÊºè‰∏éËµÑÊ∫êÊµ™Ë¥π</strong></p>
<p><strong>ÂéüÂõ†</strong>Ôºö</p>
<ol>
<li>ThreadLocalMap ÁöÑ key ÊòØÂº±ÂºïÁî®Ôºåvalue ÊòØÂº∫ÂºïÁî®<ul>
<li>ÂΩì ThreadLocal ÂÆû‰æãÔºàkeyÔºâË¢´ GC ÂõûÊî∂ÂêéÔºåÂ¶ÇÊûúÊ≤°ÊúâÊâãÂä® remove()ÔºåÂÆÉÂØπÂ∫îÁöÑ <strong>value ‰ºö‚ÄúÊÇ¨ÊåÇ‚ÄùÂú®ÂÜÖÂ≠ò‰∏≠</strong>ÔºåËÄå ThreadLocalMap ÊòØÊåÇÂú® Thread ÂØπË±°‰∏äÁöÑÔºå<strong>Á∫øÁ®ã‰∏çÊ≠ªÔºåvalue Â∞±‰∏ç‰ºöÈáäÊîæÔºåÈÄ†ÊàêÂÜÖÂ≠òÊ≥ÑÊºè</strong>„ÄÇ</li>
</ul>
</li>
<li>Á∫øÁ®ãÊ±†Â§çÁî®Á∫øÁ®ãÔºöÁ∫øÁ®ãÊ±†ÂØºËá¥Á∫øÁ®ãÈïøÊúüÂ≠òÊ¥ªÔºåÂä†ÂâßÊ≥ÑÊºèÈóÆÈ¢ò<ul>
<li>Â¶ÇÊûú‰Ω†Âú®Á∫øÁ®ã‰∏≠‰ΩøÁî®‰∫Ü ThreadLocal ‰ΩÜÊ≤°Ë∞ÉÁî® <strong>remove()</strong>Ôºå‰∏ä‰∏Ä‰∏™ËØ∑Ê±ÇÁöÑÊï∞ÊçÆÂ∞±ÂèØËÉΩ<strong>Ë¢´‰∏ã‰∏Ä‰∏™ËØ∑Ê±ÇÂ§çÁî®ÁöÑÁ∫øÁ®ãËØØÁî®</strong>ÔºåÈÄ†Êàê<strong>Êï∞ÊçÆÊ≥ÑÊºèÂíåÂÆâÂÖ®È£éÈô©„ÄÇ</strong></li>
</ul>
</li>
</ol>
<ul>
<li><strong>ThreadLocal ÁöÑ key ÊòØÂº±ÂºïÁî®ÔºåËã•‰∏çÂèäÊó∂Ë∞ÉÁî® remove() Ê∏ÖÈô§ÁªëÂÆöÊï∞ÊçÆÔºåÂèØËÉΩÂõ†Á∫øÁ®ãÊ±†Â§çÁî®ÂØºËá¥ÂÜÖÂ≠òÊ≥ÑÊºè‰∏éÁî®Êà∑Êï∞ÊçÆÈîô‰π±</strong>ÔºåÂ∞§ÂÖ∂Âú®È´òÂπ∂ÂèëÁ≥ªÁªü‰∏≠Âç±ÂÆ≥Êõ¥ÊòéÊòæ„ÄÇ</li>
</ul>
<h4 id="2-4-ThreadLocalÂéüÁêÜ-ÈáçÁÇπ"><a href="#2-4-ThreadLocalÂéüÁêÜ-ÈáçÁÇπ" class="headerlink" title="2.4 ThreadLocalÂéüÁêÜ(ÈáçÁÇπ)"></a>2.4 ThreadLocalÂéüÁêÜ(ÈáçÁÇπ)</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44184990/article/details/122279854?ops_request_misc=%257B%2522request%255Fid%2522%253A%25224d0490e493964472613e577c3e94bd9f%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=4d0490e493964472613e577c3e94bd9f&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-122279854-null-null.142%5Ev102%5Epc_search_result_base2&utm_term=ThreadLocal%E5%8E%9F%E7%90%86&spm=1018.2226.3001.4187">ThreadLocalÂéüÁêÜ</a></p>
<h3 id="3-Âà©Áî®-Redisson-ÂàÜÂ∏ÉÂºèÈîÅËß£ÂÜ≥ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºåÁªìÂêà‰πêËßÇÈîÅÊú∫Âà∂Èò≤Ê≠¢ÁßíÊùÄË∂ÖÂçñÈóÆÈ¢ò"><a href="#3-Âà©Áî®-Redisson-ÂàÜÂ∏ÉÂºèÈîÅËß£ÂÜ≥ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºåÁªìÂêà‰πêËßÇÈîÅÊú∫Âà∂Èò≤Ê≠¢ÁßíÊùÄË∂ÖÂçñÈóÆÈ¢ò" class="headerlink" title="3. Âà©Áî® Redisson ÂàÜÂ∏ÉÂºèÈîÅËß£ÂÜ≥ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºåÁªìÂêà‰πêËßÇÈîÅÊú∫Âà∂Èò≤Ê≠¢ÁßíÊùÄË∂ÖÂçñÈóÆÈ¢ò"></a>3. Âà©Áî® Redisson ÂàÜÂ∏ÉÂºèÈîÅËß£ÂÜ≥ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºåÁªìÂêà‰πêËßÇÈîÅÊú∫Âà∂Èò≤Ê≠¢ÁßíÊùÄË∂ÖÂçñÈóÆÈ¢ò</h3><h4 id="3-1-‰ªÄ‰πàÊòØÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºü"><a href="#3-1-‰ªÄ‰πàÊòØÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºü" class="headerlink" title="3.1 ‰ªÄ‰πàÊòØÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºü"></a>3.1 ‰ªÄ‰πàÊòØÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢òÔºü</h4><p><a href="#35-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E4%B8%8B%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95%E7%9A%84%E5%B9%B6%E5%8F%91%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98">Ë∑≥ËΩ¨Âà∞ÈõÜÁæ§ÁéØÂ¢É‰∏ã‰∏Ä‰∫∫‰∏ÄÂçïÁöÑÂπ∂ÂèëÂÆâÂÖ®ÈóÆÈ¢ò</a></p>
<ul>
<li><strong>‰∏Ä‰∫∫‰∏ÄÂçï</strong>ÔºöÁßíÊùÄ‰∏öÂä°Ë¶ÅÊ±Ç<strong>Âêå‰∏Ä‰∏™‰ºòÊÉ†Âà∏Ôºå‰∏Ä‰∏™Áî®Êà∑Âè™ËÉΩ‰∏ã‰∏ÄÂçï</strong></li>
<li><strong>ÈõÜÁæ§ÁéØÂ¢É‰∏ãÁöÑ‰∏Ä‰∫∫‰∏ÄÂçï</strong>Ôºö<ul>
<li>ÈÄöËøáÂä†ÈîÅÂèØ‰ª•Ëß£ÂÜ≥Âú®ÂçïÊú∫ÊÉÖÂÜµ‰∏ãÁöÑ‰∏Ä‰∫∫‰∏ÄÂçïÂÆâÂÖ®ÈóÆÈ¢òÔºå‰ΩÜÊòØ<strong>Âú®ÈõÜÁæ§Ê®°Âºè‰∏ãÂ∞±‰∏çË°å‰∫Ü</strong></li>
<li><strong>ÊØè‰∏™tomcatÈÉΩÊúâ‰∏Ä‰∏™Â±û‰∫éËá™Â∑±ÁöÑjvm</strong>Ôºå<strong>ÊØè‰∏™JVMÈÉΩÊúâÂêÑËá™ÁöÑÈîÅÁõëËßÜÂô®ÔºåÂØºËá¥‰∏çÂêåJVMÁöÑÈîÅÂú®‰∏çÂêåÁöÑÈîÅÁõëËßÜÂô®‰∏≠</strong></li>
<li>Âú®ÈõÜÁæ§Ê®°Âºè‰∏ãÔºåÂä†ÈîÅÂè™ÊòØÂØπËØ• JVM ÁªôÂΩìÂâçËøôÂè∞ÊúçÂä°Âô®ÁöÑËØ∑Ê±ÇÁöÑÂä†ÈîÅÔºåËÄå<strong>ÈõÜÁæ§ÊòØÂ§öÂè∞ÊúçÂä°Âô®ÔºåÊâÄ‰ª•Ë¶Å‰ΩøÁî®ÂàÜÂ∏ÉÂºèÈîÅ</strong>ÔºåÊª°Ë∂≥ÈõÜÁæ§Ê®°Âºè‰∏ãÂ§öËøõÁ®ãÂèØËßÅÂπ∂‰∏î‰∫íÊñ•ÁöÑÈîÅ„ÄÇ</li>
</ul>
</li>
</ul>
<h4 id="3-2-‰ªÄ‰πàÊòØÂàÜÂ∏ÉÂºèÈîÅÔºü"><a href="#3-2-‰ªÄ‰πàÊòØÂàÜÂ∏ÉÂºèÈîÅÔºü" class="headerlink" title="3.2 ‰ªÄ‰πàÊòØÂàÜÂ∏ÉÂºèÈîÅÔºü"></a>3.2 ‰ªÄ‰πàÊòØÂàÜÂ∏ÉÂºèÈîÅÔºü</h4><p><a href="#4-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81">Ë∑≥ËΩ¨Âà∞ÂàÜÂ∏ÉÂºèÈîÅ</a></p>
<p>ÂàÜÂ∏ÉÂºèÈîÅÔºöÊª°Ë∂≥ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÊàñÈõÜÁæ§Ê®°Âºè‰∏ã<strong>Â§öËøõÁ®ãÂèØËßÅÂπ∂‰∏î‰∫íÊñ•ÁöÑÈîÅ</strong>„ÄÇ</p>
<ul>
<li>ÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ†∏ÂøÉÊÄùÊÉ≥Â∞±ÊòØËÆ©Â§ßÂÆ∂ÈÉΩ‰ΩøÁî®Âêå‰∏ÄÊääÈîÅÔºåÂè™Ë¶ÅÂ§ßÂÆ∂‰ΩøÁî®ÁöÑÊòØÂêå‰∏ÄÊääÈîÅÔºåÈÇ£‰πàÊàë‰ª¨Â∞±ËÉΩÈîÅ‰ΩèÁ∫øÁ®ãÔºå‰∏çËÆ©Á∫øÁ®ãËøõË°åÔºåËÆ©Á®ãÂ∫è‰∏≤Ë°åÊâßË°åÔºåËøôÂ∞±ÊòØÂàÜÂ∏ÉÂºèÈîÅÁöÑÊ†∏ÂøÉÊÄùË∑Ø</li>
</ul>
<h4 id="3-3-RedissonÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÁêÜÂíå‰ΩøÁî®"><a href="#3-3-RedissonÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÁêÜÂíå‰ΩøÁî®" class="headerlink" title="3.3 RedissonÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÁêÜÂíå‰ΩøÁî®"></a>3.3 RedissonÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÁêÜÂíå‰ΩøÁî®</h4><p><a href="#49-%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81-redission%E5%8A%9F%E8%83%BD%E4%BB%8B%E7%BB%8D">Ë∑≥ËΩ¨Âà∞RedissonÂàÜÂ∏ÉÂºèÈîÅ</a></p>
<p>Redisson ÊòØ‰∏Ä‰∏™ Java ÂÆ¢Êà∑Á´ØÊ°ÜÊû∂ÔºåÂü∫‰∫é Redis ÂÆûÁé∞‰∫ÜÂàÜÂ∏ÉÂºèÈîÅ„ÄÅÂàÜÂ∏ÉÂºèÈõÜÂêà„ÄÅÂàÜÂ∏ÉÂºèÂØπË±°Á≠âÈ´òÈò∂ÂäüËÉΩ</p>
<p><strong>Redisson ÂàÜÂ∏ÉÂºèÈîÅÁöÑÂéüÁêÜÔºö</strong></p>
<ol>
<li><strong>Âä†ÈîÅÂéüÁêÜ</strong>ÔºöRedisson ‰ΩøÁî® Redis ÁöÑ <code>SET key value NX PX</code> ÂëΩ‰ª§Âä†ÈîÅ<ul>
<li>key ÊòØÈîÅÂêçÔºåvalue ÊòØÂîØ‰∏ÄÊ†áËØÜÔºàUUID+Á∫øÁ®ãIDÔºâ</li>
<li>ËÆæÁΩÆ 30 ÁßíËøáÊúüÊó∂Èó¥ÔºàÈªòËÆ§ÂÄºÔºåÂèØÈÖçÁΩÆÔºâ</li>
</ul>
</li>
<li><strong>ÁúãÈó®ÁãóÊú∫Âà∂ÔºàWatchdogÔºâ</strong><ul>
<li>Â¶ÇÊûú‰ΩøÁî® lock() Âä†ÈîÅÔºà‰∏çÂ∏¶Ë∂ÖÊó∂Êó∂Èó¥ÔºâÔºåRedisson ‰ºöÂêØÂä®‰∏Ä‰∏™ÂêéÂè∞ÂÆöÊó∂‰ªªÂä°ÔºåÊØèÈöî 10 ÁßíËá™Âä®Áª≠ÊúüÔºåÂ∞ÜÈîÅÁöÑËøáÊúüÊó∂Èó¥Áª≠‰∏∫ 30 ÁßíÔºõ</li>
<li>Â¶ÇÊûú‰Ω†‰∏ªÂä®ËÆæÁΩÆ‰∫ÜÈîÅÁöÑËøáÊúüÊó∂Èó¥ÔºåÊØîÂ¶Ç lock(10, TimeUnit.SECONDS)ÔºåÂàô‰∏ç‰ºöËá™Âä®Áª≠ÊúüÔºå10 ÁßíÂêéËá™Âä®ÈáäÊîæÔºõ</li>
</ul>
</li>
<li><strong>Ëß£ÈîÅÂéüÁêÜ</strong><ul>
<li>Redisson ‰ºöÈ™åËØÅÂΩìÂâçÁ∫øÁ®ãÊòØÂê¶ÊòØÈîÅÁöÑÊã•ÊúâËÄÖÔºàÊ†πÊçÆ UUID+Á∫øÁ®ãID Âà§Êñ≠Ôºâ</li>
<li>ÊòØÁöÑËØùÊâßË°å Lua ËÑöÊú¨Âà†Èô§ÈîÅÔºåÈò≤Ê≠¢ËØØÂà†ÂÖ∂‰ªñÁ∫øÁ®ãÁöÑÈîÅÔºàÂéüÂ≠êÊìç‰ΩúÔºâ</li>
</ul>
</li>
<li><strong>ÊîØÊåÅÂ§öÁßçÊ®°Âºè</strong><ul>
<li>ÂÖ¨Âπ≥ÈîÅÔºöÊéíÈòüÊú∫Âà∂ÔºåÂÖàÊù•ÂÖàÂæóÔºàÈÄÇÁî®‰∫éÈ´òÂπ∂Âèë‰∏ãÂÖ¨Âπ≥ËÆøÈóÆËµÑÊ∫êÁöÑÂú∫ÊôØÔºâ</li>
<li>ÂèØÈáçÂÖ•ÈîÅÔºöÂêå‰∏Ä‰∏™Á∫øÁ®ãÂèØ‰ª•Â§öÊ¨°Ëé∑ÂèñÂêå‰∏ÄÊääÈîÅ</li>
</ul>
</li>
</ol>
<p><strong>‰ΩøÁî®RedissionÁöÑÂàÜÂ∏ÉÂºèÈîÅÔºö</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Resource</span><br><span class="hljs-keyword">private</span> RedissionClient redissonClient;<br><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRedisson</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>    <span class="hljs-comment">//Ëé∑ÂèñÈîÅ(ÂèØÈáçÂÖ•)ÔºåÊåáÂÆöÈîÅÁöÑÂêçÁß∞</span><br>    <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">&quot;anyLock&quot;</span>);<br>    <span class="hljs-comment">//Â∞ùËØïËé∑ÂèñÈîÅÔºåÂèÇÊï∞ÂàÜÂà´ÊòØÔºöËé∑ÂèñÈîÅÁöÑÊúÄÂ§ßÁ≠âÂæÖÊó∂Èó¥(ÊúüÈó¥‰ºöÈáçËØï)ÔºåÈîÅËá™Âä®ÈáäÊîæÊó∂Èó¥ÔºåÊó∂Èó¥Âçï‰Ωç</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">isLock</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>,TimeUnit.SECONDS);<br>    <span class="hljs-comment">//Âà§Êñ≠Ëé∑ÂèñÈîÅÊàêÂäü</span><br>    <span class="hljs-keyword">if</span>(isLock)&#123;<br>        <span class="hljs-keyword">try</span>&#123;<br>            System.out.println(<span class="hljs-string">&quot;ÊâßË°å‰∏öÂä°&quot;</span>);          <br>        &#125;<span class="hljs-keyword">finally</span>&#123;<br>            <span class="hljs-comment">//ÈáäÊîæÈîÅ</span><br>            lock.unlock();<br>        &#125;<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="3-4-‰∏∫‰ªÄ‰πà‰ºöÂá∫Áé∞Ë∂ÖÂçñÔºü"><a href="#3-4-‰∏∫‰ªÄ‰πà‰ºöÂá∫Áé∞Ë∂ÖÂçñÔºü" class="headerlink" title="3.4 ‰∏∫‰ªÄ‰πà‰ºöÂá∫Áé∞Ë∂ÖÂçñÔºü"></a>3.4 ‰∏∫‰ªÄ‰πà‰ºöÂá∫Áé∞Ë∂ÖÂçñÔºü</h4><p>‰∏ªË¶ÅÊòØÂú®È´òÂπ∂ÂèëÂú∫ÊôØ‰∏ãÂπ∂ÂèëÊéßÂà∂‰∏çÂΩìÈÄ†ÊàêÁöÑÔºå‰∏ãÈù¢ÊòØ‰∏Ä‰∏™ÂÖ∏ÂûãÊµÅÁ®ãÔºö</p>
<ol>
<li>Â§ö‰∏™Áî®Êà∑ÂêåÊó∂Êü•ËØ¢Â∫ìÂ≠òÔºàÊØîÂ¶ÇÊü•Âà∞ÂΩìÂâçÂ∫ìÂ≠ò‰∏∫ 5Ôºâ</li>
<li>Â§ö‰∏™Áî®Êà∑Âá†‰πéÂêåÊó∂ÂèëËµ∑‰∏ãÂçïËØ∑Ê±Ç</li>
<li>Á≥ªÁªüÊù•‰∏çÂèä‚ÄúÂêåÊ≠•Êõ¥Êñ∞‚ÄùÂ∫ìÂ≠òÔºåÂØºËá¥Â§ö‰∏™ËØ∑Ê±ÇÈÉΩÊàêÂäü‰∫Ü ‚ûú Â∫ìÂ≠òÂèòË¥üÊï∞<br><strong>ÂçñÂá∫ÂéªÁöÑÊï∞ÈáèË∂ÖËøá‰∫ÜÂÆûÈôÖÂ∫ìÂ≠ò</strong>„ÄÇ</li>
</ol>
<h4 id="3-5-‰ªÄ‰πàÊòØ‰πêËßÇÈîÅÔºü"><a href="#3-5-‰ªÄ‰πàÊòØ‰πêËßÇÈîÅÔºü" class="headerlink" title="3.5 ‰ªÄ‰πàÊòØ‰πêËßÇÈîÅÔºü"></a>3.5 ‰ªÄ‰πàÊòØ‰πêËßÇÈîÅÔºü</h4><p><strong>ÊÇ≤ËßÇÈîÅÔºö</strong></p>
<ul>
<li>ËÆ§‰∏∫Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò‰∏ÄÂÆö‰ºöÂèëÁîüÔºåÂõ†Ê≠§<strong>Âú®Êìç‰ΩúÊï∞ÊçÆ‰πãÂâçÂÖàËé∑ÂèñÈîÅ</strong>ÔºåÁ°Æ‰øùÁ∫øÁ®ã‰∏≤Ë°åÊâßË°å„ÄÇ</li>
<li>‰æãÂ¶ÇSynchronized„ÄÅLockÈÉΩÂ±û‰∫éÊÇ≤ËßÇÈîÅ</li>
</ul>
<p><strong>‰πêËßÇÈîÅ(CAS)Ôºö</strong></p>
<ul>
<li>ËÆ§‰∏∫Á∫øÁ®ãÂÆâÂÖ®ÈóÆÈ¢ò‰∏ç‰∏ÄÂÆö‰ºöÂèëÁîüÔºåÂõ†Ê≠§‰∏çÂä†ÈîÅÔºå<strong>Âè™ÊòØÂú®Êõ¥Êñ∞Êï∞ÊçÆÊó∂ÂéªÂà§Êñ≠ÊúâÊ≤°ÊúâÂÖ∂ÂÆÉÁ∫øÁ®ãÂØπÊï∞ÊçÆÂÅö‰∫Ü‰øÆÊîπ</strong>„ÄÇ</li>
<li>Â¶ÇÊûúÊ≤°Êúâ‰øÆÊîπÂàôËÆ§‰∏∫ÊòØÂÆâÂÖ®ÁöÑÔºåËá™Â∑±ÊâçÊõ¥Êñ∞Êï∞ÊçÆ„ÄÇ</li>
<li>Â¶ÇÊûúÂ∑≤ÁªèË¢´ÂÖ∂ÂÆÉÁ∫øÁ®ã‰øÆÊîπËØ¥ÊòéÂèëÁîü‰∫ÜÂÆâÂÖ®ÈóÆÈ¢òÔºåÊ≠§Êó∂ÂèØ‰ª•ÈáçËØïÊàñÂºÇÂ∏∏</li>
</ul>
<h4 id="3-6-Â¶Ç‰Ωï‰ΩøÁî®‰πêËßÇÈîÅ-CAS-Ëß£ÂÜ≥Ë∂ÖÂçñÈóÆÈ¢òÔºü"><a href="#3-6-Â¶Ç‰Ωï‰ΩøÁî®‰πêËßÇÈîÅ-CAS-Ëß£ÂÜ≥Ë∂ÖÂçñÈóÆÈ¢òÔºü" class="headerlink" title="3.6 Â¶Ç‰Ωï‰ΩøÁî®‰πêËßÇÈîÅ(CAS)Ëß£ÂÜ≥Ë∂ÖÂçñÈóÆÈ¢òÔºü"></a>3.6 Â¶Ç‰Ωï‰ΩøÁî®‰πêËßÇÈîÅ(CAS)Ëß£ÂÜ≥Ë∂ÖÂçñÈóÆÈ¢òÔºü</h4><p><a href="#332-%E5%9F%BA%E4%BA%8E%E4%B9%90%E8%A7%82%E9%94%81cas%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">Ë∑≥ËΩ¨Âà∞‰πêËßÇÈîÅËß£ÂÜ≥ÊñπÊ°à</a></p>
<p><strong>Âè™Ë¶ÅÊàëÊâ£ÂáèÂ∫ìÂ≠òÊó∂ÁöÑÂ∫ìÂ≠òÂíå‰πãÂâçÊàëÊü•ËØ¢Âà∞ÁöÑÂ∫ìÂ≠òÊòØ‰∏ÄÊ†∑ÁöÑÔºåÂ∞±ÊÑèÂë≥ÁùÄÊ≤°Êúâ‰∫∫Âú®‰∏≠Èó¥‰øÆÊîπËøáÂ∫ìÂ≠òÔºåÈÇ£‰πàÊ≠§Êó∂Â∞±ÊòØÂÆâÂÖ®ÁöÑ</strong><br>Êàë‰ª¨ÁöÑ‰πêËßÇÈîÅÈúÄË¶ÅÂèò‰∏Ä‰∏ãÔºåÊîπÊàêstockÂ§ß‰∫é0 Âç≥ÂèØ</p>
<ul>
<li><strong>Âè™Ë¶ÅÂ∫ìÂ≠òÂ§ß‰∫é0ÔºåÂ∞±ÂèØ‰ª•‰π∞Ôºå‰∏ç‰ºöË∂ÖÂçñ</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">boolean</span> <span class="hljs-variable">success</span> <span class="hljs-operator">=</span> seckillVoucherService.update()<br>            .setSql(<span class="hljs-string">&quot;stock= stock -1&quot;</span>)<br>            .eq(<span class="hljs-string">&quot;voucher_id&quot;</span>, voucherId).update().gt(<span class="hljs-string">&quot;stock&quot;</span>,<span class="hljs-number">0</span>); <span class="hljs-comment">//where id = ? and stock &gt; 0</span><br></code></pre></td></tr></table></figure>



<h3 id="4-‰ΩøÁî®-Redis-Ëß£ÂÜ≥‰∫ÜÂú®ÈõÜÁæ§Ê®°Âºè‰∏ãÁöÑ-Session-ÂÖ±‰∫´ÈóÆÈ¢òÔºå‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞"><a href="#4-‰ΩøÁî®-Redis-Ëß£ÂÜ≥‰∫ÜÂú®ÈõÜÁæ§Ê®°Âºè‰∏ãÁöÑ-Session-ÂÖ±‰∫´ÈóÆÈ¢òÔºå‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞" class="headerlink" title="4. ‰ΩøÁî® Redis Ëß£ÂÜ≥‰∫ÜÂú®ÈõÜÁæ§Ê®°Âºè‰∏ãÁöÑ Session ÂÖ±‰∫´ÈóÆÈ¢òÔºå‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞"></a>4. ‰ΩøÁî® Redis Ëß£ÂÜ≥‰∫ÜÂú®ÈõÜÁæ§Ê®°Âºè‰∏ãÁöÑ Session ÂÖ±‰∫´ÈóÆÈ¢òÔºå‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞</h3><p><a target="_blank" rel="noopener" href="https://kneegcyao.github.io/posts/bbf9fa63.html">ÈªëÈ©¨ÁÇπËØÑÈáçÁÇπÈù¢ËØïÈóÆÈ¢ò</a></p>
<h4 id="4-1-‰ªÄ‰πàÊòØSessionÂÖ±‰∫´ÈóÆÈ¢òÔºü"><a href="#4-1-‰ªÄ‰πàÊòØSessionÂÖ±‰∫´ÈóÆÈ¢òÔºü" class="headerlink" title="4.1 ‰ªÄ‰πàÊòØSessionÂÖ±‰∫´ÈóÆÈ¢òÔºü"></a>4.1 ‰ªÄ‰πàÊòØSessionÂÖ±‰∫´ÈóÆÈ¢òÔºü</h4><p><a href="#15-session%E5%85%B1%E4%BA%AB%E9%97%AE%E9%A2%98">Ë∑≥ËΩ¨Âà∞sessionÂÖ±‰∫´ÈóÆÈ¢ò</a></p>
<p><strong>Â§öÂè∞ Tomct Âπ∂‰∏çÂÖ±‰∫´ session Â≠òÂÇ®Á©∫Èó¥ÔºåÂΩìËØ∑Ê±ÇÂàáÊç¢Âà∞‰∏çÂêå tomcat ÊúçÂä°Êó∂ÂØºËá¥Êï∞ÊçÆ‰∏¢Â§±ÁöÑÈóÆÈ¢ò„ÄÇ</strong></p>
<p><strong>ÊØè‰∏™tomcat‰∏≠ÈÉΩÊúâ‰∏Ä‰ªΩÂ±û‰∫éËá™Â∑±ÁöÑsession</strong>,ÂÅáËÆæÁî®Êà∑Á¨¨‰∏ÄÊ¨°ËÆøÈóÆÁ¨¨‰∏ÄÂè∞tomcatÔºåÂπ∂‰∏îÊääËá™Â∑±ÁöÑ‰ø°ÊÅØÂ≠òÊîæÂà∞Á¨¨‰∏ÄÂè∞ÊúçÂä°Âô®ÁöÑsession‰∏≠Ôºå‰ΩÜÊòØÁ¨¨‰∫åÊ¨°Ëøô‰∏™Áî®Êà∑ËÆøÈóÆÂà∞‰∫ÜÁ¨¨‰∫åÂè∞tomcatÔºåÈÇ£‰πà<strong>Âú®Á¨¨‰∫åÂè∞ÊúçÂä°Âô®‰∏äÔºåËÇØÂÆöÊ≤°ÊúâÁ¨¨‰∏ÄÂè∞ÊúçÂä°Âô®Â≠òÊîæÁöÑsession</strong>ÔºåÊâÄ‰ª•Ê≠§Êó∂ Êï¥‰∏™ÁôªÂΩïÊã¶Êà™ÂäüËÉΩÂ∞±‰ºöÂá∫Áé∞ÈóÆÈ¢ò</p>
<p>Êàë‰ª¨ËÉΩÂ¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÂë¢Ôºü<strong>Êó©ÊúüÁöÑÊñπÊ°àÊòØsessionÊã∑Ë¥ù</strong>ÔºåÂ∞±ÊòØËØ¥ËôΩÁÑ∂ÊØè‰∏™tomcat‰∏äÈÉΩÊúâ‰∏çÂêåÁöÑsessionÔºå‰ΩÜÊòØÊØèÂΩì<strong>‰ªªÊÑè‰∏ÄÂè∞ÊúçÂä°Âô®ÁöÑsession‰øÆÊîπÊó∂ÔºåÈÉΩ‰ºöÂêåÊ≠•ÁªôÂÖ∂‰ªñÁöÑTomcatÊúçÂä°Âô®ÁöÑsession</strong>ÔºåËøôÊ†∑ÁöÑËØùÔºåÂ∞±ÂèØ‰ª•ÂÆûÁé∞sessionÁöÑÂÖ±‰∫´‰∫Ü</p>
<p>ÂêéÊù•ÈááÁî®ÁöÑÊñπÊ°àÈÉΩÊòØÂü∫‰∫éredisÊù•ÂÆåÊàêÔºåÊàë‰ª¨<strong>ÊääsessionÊç¢Êàêredis</strong>Ôºå<strong>redisÊï∞ÊçÆÊú¨Ë∫´Â∞±ÊòØÂÖ±‰∫´ÁöÑÔºåÂ∞±ÂèØ‰ª•ÈÅøÂÖçsessionÂÖ±‰∫´</strong>ÁöÑÈóÆÈ¢ò‰∫Ü</p>
<h4 id="4-2-Â¶Ç‰ΩïÂú®ÁôªÂΩïËøáÁ®ã‰∏≠Áî®Redis‰ª£ÊõøSessionÁöÑÔºü"><a href="#4-2-Â¶Ç‰ΩïÂú®ÁôªÂΩïËøáÁ®ã‰∏≠Áî®Redis‰ª£ÊõøSessionÁöÑÔºü" class="headerlink" title="4.2 Â¶Ç‰ΩïÂú®ÁôªÂΩïËøáÁ®ã‰∏≠Áî®Redis‰ª£ÊõøSessionÁöÑÔºü"></a>4.2 Â¶Ç‰ΩïÂú®ÁôªÂΩïËøáÁ®ã‰∏≠Áî®Redis‰ª£ÊõøSessionÁöÑÔºü</h4><p><a href="#16-redis%E4%BB%A3%E6%9B%BFsession%E7%9A%84%E4%B8%9A%E5%8A%A1%E6%B5%81%E7%A8%8B">Ë∑≥ËΩ¨Âà∞Redis‰ª£ÊõøsessionÁöÑ‰∏öÂä°ÊµÅÁ®ã</a></p>
<p><strong>ÁôªÂΩïÊµÅÁ®ãÔºö</strong></p>
<ol>
<li><strong>ÂèëÈÄÅÁü≠‰ø°È™åËØÅÁ†Å</strong>ÔºöÂ∞ÜÈ™åËØÅÁ†Å‰øùÂ≠òÂà∞RedisÈáåÈù¢ÔºåËÄå‰∏çÊòØsession</li>
<li><strong>ÁôªÂΩïËøáÁ®ã</strong>ÔºöÊ†πÊçÆÊâãÊú∫Âè∑Êü•ËØ¢Áî®Êà∑‰ø°ÊÅØÔºå‰∏çÂ≠òÂú®ÂàôÊñ∞Âª∫ÔºåÊúÄÂêéÂ∞ÜÁî®Êà∑Êï∞ÊçÆ‰øùÂ≠òÂà∞redis(‰Ωú‰∏∫ÂÄº)ÔºåÂπ∂‰∏îÁîüÊàêtoken‰Ωú‰∏∫redisÁöÑkey</li>
<li><strong>Ê†°È™åÁôªÂΩïÁä∂ÊÄÅ</strong>ÔºöÂΩìÊàë‰ª¨Ê†°È™åÁî®Êà∑ÊòØÂê¶ÁôªÂΩïÊó∂Ôºå‰ºöÂéª<strong>Êê∫Â∏¶ÁùÄtokenËøõË°åËÆøÈóÆ</strong>Ôºå‰ªéredis‰∏≠ÂèñÂá∫tokenÂØπÂ∫îÁöÑvalueÔºåÂà§Êñ≠ÊòØÂê¶Â≠òÂú®Ëøô‰∏™Êï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÊã¶Êà™ÔºåÂ¶ÇÊûúÂ≠òÂú®ÂàôÂ∞ÜÂÖ∂‰øùÂ≠òÂà∞threadLocal‰∏≠ÔºåÂπ∂‰∏îÊîæË°å„ÄÇ</li>
</ol>
<h4 id="4-3-ËøòÊúâÂÖ∂‰ªñËß£ÂÜ≥ÊñπÊ≥ïÂêóÔºü"><a href="#4-3-ËøòÊúâÂÖ∂‰ªñËß£ÂÜ≥ÊñπÊ≥ïÂêóÔºü" class="headerlink" title="4.3 ËøòÊúâÂÖ∂‰ªñËß£ÂÜ≥ÊñπÊ≥ïÂêóÔºü"></a>4.3 ËøòÊúâÂÖ∂‰ªñËß£ÂÜ≥ÊñπÊ≥ïÂêóÔºü</h4><ul>
<li><strong>Âü∫‰∫é Cookie ÁöÑ Token Êú∫Âà∂</strong>Ôºå‰∏çÂÜç‰ΩøÁî®ÊúçÂä°Âô®Á´Ø‰øùÂ≠ò SessionÔºåËÄåÊòØÈÄöËøá<strong>ÂÆ¢Êà∑Á´Ø‰øùÂ≠ò Token</strong>ÔºàÂ¶Ç JWTÔºâ„ÄÇ</li>
<li>Token ÂåÖÂê´Áî®Êà∑ÁöÑËÆ§ËØÅ‰ø°ÊÅØÔºàÂ¶ÇÁî®Êà∑ ID„ÄÅÊùÉÈôêÁ≠âÔºâÔºåÂπ∂ÈÄöËøáÁ≠æÂêçÈ™åËØÅÂÖ∂ÂÆåÊï¥ÊÄßÂíåÁúüÂÆûÊÄß„ÄÇ</li>
<li>ÊØèÊ¨°ËØ∑Ê±ÇÔºå<strong>ÂÆ¢Êà∑Á´ØÂ∞Ü Token ÊîæÂú® Cookie Êàñ HTTP Â§¥‰∏≠ÂèëÈÄÅÂà∞ÊúçÂä°</strong>ÔºåËøõË°åÈ™åËØÅ</li>
</ul>
<h4 id="4-4-Â¶Ç‰Ωï‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞Ôºü"><a href="#4-4-Â¶Ç‰Ωï‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞Ôºü" class="headerlink" title="4.4 Â¶Ç‰Ωï‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞Ôºü"></a>4.4 Â¶Ç‰Ωï‰ΩøÁî®Êã¶Êà™Âô®ÂÆûÁé∞Áî®Êà∑ÁöÑÁôªÂΩïÊ†°È™åÂíåÊùÉÈôêÂà∑Êñ∞Ôºü</h4><p><a href="#18-%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%99%BB%E5%BD%95%E5%88%B7%E6%96%B0%E9%97%AE%E9%A2%98">Ë∑≥ËΩ¨Âà∞Êã¶Êà™Âô®</a></p>
<p><strong>ÈóÆÈ¢òÊâÄÂú®Ôºö</strong></p>
<ul>
<li>ÂéüÂßãÊñπÊ°àÁ°ÆÂÆûÂèØ‰ª•‰ΩøÁî®ÂØπÂ∫îË∑ØÂæÑÁöÑÊã¶Êà™ÔºåÂêåÊó∂Âà∑Êñ∞ÁôªÂΩïtoken‰ª§ÁâåÁöÑÂ≠òÊ¥ªÊó∂Èó¥Ôºå‰ΩÜÊòØÁé∞Âú®Ëøô‰∏™Êã¶Êà™Âô®‰ªñ<strong>Âè™ÊòØÊã¶Êà™ÈúÄË¶ÅË¢´Êã¶Êà™ÁöÑË∑ØÂæÑ</strong></li>
<li>ÂÅáËÆæ<strong>ÂΩìÂâçÁî®Êà∑ËÆøÈóÆ‰∫Ü‰∏Ä‰∫õ‰∏çÈúÄË¶ÅÊã¶Êà™ÁöÑË∑ØÂæÑÔºåÈÇ£‰πàËøô‰∏™Êã¶Êà™Âô®Â∞±‰∏ç‰ºöÁîüÊïà</strong>ÔºåÊâÄ‰ª•Ê≠§Êó∂<strong>‰ª§ÁâåÂà∑Êñ∞ÁöÑÂä®‰ΩúÂÆûÈôÖ‰∏äÂ∞±‰∏ç‰ºöÊâßË°å</strong>ÔºåÊâÄ‰ª•Ëøô‰∏™ÊñπÊ°à‰ªñÊòØÂ≠òÂú®ÈóÆÈ¢òÁöÑ</li>
</ul>
<p><strong>ÂÆûÁé∞ÊñπÊ°àÔºö</strong></p>
<ul>
<li>Êàë‰ª¨ÂèØ‰ª•Ê∑ªÂä†‰∏Ä‰∏™Êã¶Êà™Âô®</li>
</ul>
<ol>
<li>Âú®<strong>Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®‰∏≠Êã¶Êà™ÊâÄÊúâÁöÑË∑ØÂæÑ</strong>ÔºåÊääÁ¨¨‰∫å‰∏™Êã¶Êà™Âô®ÂÅöÁöÑ‰∫ãÊÉÖÊîæÂÖ•Âà∞Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®‰∏≠ÔºåÂêåÊó∂<strong>Âà∑Êñ∞‰ª§Áâå</strong></li>
<li>Âõ†‰∏∫Á¨¨‰∏Ä‰∏™Êã¶Êà™Âô®Êúâ‰∫ÜThreadLocalÁöÑÊï∞ÊçÆÔºåÊâÄ‰ª•Ê≠§Êó∂<strong>Á¨¨‰∫å‰∏™Êã¶Êà™Âô®Âè™ÈúÄË¶ÅÂà§Êñ≠Êã¶Êà™Âô®‰∏≠ÁöÑuserÂØπË±°ÊòØÂê¶Â≠òÂú®Âç≥ÂèØ</strong>ÔºåÂÆåÊàêÊï¥‰ΩìÂà∑Êñ∞ÂäüËÉΩ„ÄÇ</li>
</ol>
<ul>
<li>Á¨¨‰∏ÄÂ±ÇÊã¶Êà™Âô®ÊòØÂÅö<strong>ÂÖ®Â±ÄÂ§ÑÁêÜ</strong>Ôºå‰æãÂ¶ÇËé∑Âèñ TokenÔºåÊü•ËØ¢ Redis ‰∏≠ÁöÑÁî®Êà∑‰ø°ÊÅØÔºåÂà∑Êñ∞ Token ÊúâÊïàÊúüÁ≠âÈÄöÁî®Êìç‰Ωú„ÄÇ</li>
<li>Á¨¨‰∫åÂ±ÇÊã¶Êà™Âô®‰∏ìÊ≥®‰∫é<strong>È™åËØÅÁî®Êà∑ÁôªÂΩï</strong>ÁöÑÈÄªËæëÔºåÂ¶ÇÊûúË∑ØÂæÑÈúÄË¶ÅÁôªÂΩïÔºå‰ΩÜÁî®Êà∑Êú™ÁôªÂΩïÔºåÂàôÁõ¥Êé•Êã¶Êà™ËØ∑Ê±Ç„ÄÇ<strong>‰ΩúÁî®ÊòØÊã¶Êà™Êú™ÁôªÂΩïÁöÑÁî®Êà∑</strong></li>
</ul>
<p><strong>Â•ΩÂ§ÑÔºö</strong></p>
<ul>
<li>ËÅåË¥£ÂàÜÁ¶ªÔºöËøôÁßçÂàÜÂ±ÇËÆæËÆ°ËÆ©ÊØè‰∏™Êã¶Êà™Âô®ÁöÑËÅåË¥£Êõ¥Âä†Âçï‰∏ÄÔºå‰ª£Á†ÅÊõ¥Âä†Ê∏ÖÊô∞„ÄÅÊòì‰∫éÁª¥Êä§</li>
<li>ÊèêÂçáÊÄßËÉΩ</li>
</ul>
<h3 id="5-ÂÆûÁé∞Âü∫‰∫éÊé®Ê®°ÂºèÁöÑ-Feed-ÊµÅÂäüËÉΩÔºåÈááÁî®ÊªöÂä®ÂàÜÈ°µÔºåÁî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó"><a href="#5-ÂÆûÁé∞Âü∫‰∫éÊé®Ê®°ÂºèÁöÑ-Feed-ÊµÅÂäüËÉΩÔºåÈááÁî®ÊªöÂä®ÂàÜÈ°µÔºåÁî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó" class="headerlink" title="5. ÂÆûÁé∞Âü∫‰∫éÊé®Ê®°ÂºèÁöÑ Feed ÊµÅÂäüËÉΩÔºåÈááÁî®ÊªöÂä®ÂàÜÈ°µÔºåÁî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó"></a>5. ÂÆûÁé∞Âü∫‰∫éÊé®Ê®°ÂºèÁöÑ Feed ÊµÅÂäüËÉΩÔºåÈááÁî®ÊªöÂä®ÂàÜÈ°µÔºåÁî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó</h3><p><a href="#73-%E5%85%B1%E5%90%8C%E6%8E%A8%E9%80%81-feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88">Ë∑≥ËΩ¨Âà∞ÂÖ±ÂêåÊé®ÈÄÅ-FeeedÊµÅÂÆûÁé∞ÊñπÊ°à</a></p>
<h4 id="5-1-‰ªÄ‰πàÊòØÊé®Ê®°ÂºèÁöÑFeedÊµÅÔºü"><a href="#5-1-‰ªÄ‰πàÊòØÊé®Ê®°ÂºèÁöÑFeedÊµÅÔºü" class="headerlink" title="5.1 ‰ªÄ‰πàÊòØÊé®Ê®°ÂºèÁöÑFeedÊµÅÔºü"></a>5.1 ‰ªÄ‰πàÊòØÊé®Ê®°ÂºèÁöÑFeedÊµÅÔºü</h4><ul>
<li><strong>ÂÖ≥Ê≥®Êé®ÈÄÅ‰πüÂè´ÂÅöFeedÊµÅ</strong>ÔºåÁõ¥ËØë‰∏∫ÊäïÂñÇ„ÄÇ‰∏∫Áî®Êà∑ÊåÅÁª≠ÁöÑÊèê‰æõ‚ÄúÊ≤âÊµ∏Âºè‚ÄùÁöÑ‰ΩìÈ™åÔºåÈÄöËøáÊó†Èôê‰∏ãÊãâÂà∑Êñ∞Ëé∑ÂèñÊñ∞ÁöÑ‰ø°ÊÅØ</li>
</ul>
<p>FeedÊµÅ‰∫ßÂìÅÊúâ‰∏§ÁßçÂ∏∏ËßÅÊ®°Âºè</p>
<ul>
<li><strong>Timeline</strong>Ôºö‰∏çÂÅöÂÜÖÂÆπÁ≠õÈÄâÔºåÁÆÄÂçïÁöÑÊåâÁÖßÂÜÖÂÆπÂèëÂ∏ÉÊó∂Èó¥ÊéíÂ∫èÔºåÂ∏∏Áî®‰∫éÂ•ΩÂèãÊàñÂÖ≥Ê≥®„ÄÇ‰æãÂ¶ÇÊúãÂèãÂúà</li>
<li><strong>Êô∫ËÉΩÊéíÂ∫è</strong>ÔºöÂà©Áî®Êô∫ËÉΩÁÆóÊ≥ïÂ±èËîΩÊéâËøùËßÑÁöÑ„ÄÅÁî®Êà∑‰∏çÊÑüÂÖ¥Ë∂£ÁöÑÂÜÖÂÆπ„ÄÇÊé®ÈÄÅÁî®Êà∑ÊÑüÂÖ¥Ë∂£‰ø°ÊÅØÊù•Âê∏ÂºïÁî®Êà∑(ÊäñÈü≥)</li>
</ul>
<p><strong>TimelineÁöÑ‰∏âÁßçÊ®°Âºè</strong><br><a href="#73-%E5%85%B1%E5%90%8C%E6%8E%A8%E9%80%81-feed%E6%B5%81%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88">Ë∑≥ËΩ¨Âà∞ÂÖ±ÂêåÊé®ÈÄÅÊü•Áúã</a></p>
<ul>
<li>ÊãâÊ®°Âºè</li>
<li>Êé®Ê®°ÂºèÔºö‰πüÂè´ÂÜôÊâ©Êï£</li>
<li>Êé®ÊãâÁªìÂêà</li>
</ul>
<p><strong>Êé®Ê®°ÂºèÁöÑFeedÊµÅ</strong></p>
<ul>
<li>ÂΩìÂº†‰∏âÂÜô‰∫Ü‰∏Ä‰∏™ÂÜÖÂÆπÔºåÊ≠§Êó∂‰ºö<strong>‰∏ªÂä®ÁöÑÊääÂº†‰∏âÂÜôÁöÑÂÜÖÂÆπÂèëÈÄÅÂà∞‰ªñÁöÑÁ≤â‰∏ùÊî∂‰ª∂ÁÆ±</strong>‰∏≠ÂéªÔºåÂÅáËÆæÊ≠§Êó∂ÊùéÂõõÂÜçÊù•ËØªÂèñÔºåÂ∞±‰∏çÁî®ÂÜçÂéª‰∏¥Êó∂ÊãâÂèñ‰∫ÜÔºàÂÉèÊúãÂèãÂúàÁöÑÊñπÂºèÔºâ</li>
<li><strong>Áî®Êà∑ÂèëÂ∏ÉÁ¨îËÆ∞Êó∂ÂÆûÊó∂Êé®ÈÄÅËá≥Á≤â‰∏ùÊ∂àÊÅØÈòüÂàó</strong></li>
</ul>
<h4 id="5-2-‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÊªöÂä®ÂàÜÈ°µÔºü"><a href="#5-2-‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÊªöÂä®ÂàÜÈ°µÔºü" class="headerlink" title="5.2 ‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÊªöÂä®ÂàÜÈ°µÔºü"></a>5.2 ‰∏∫‰ªÄ‰πàË¶Å‰ΩøÁî®ÊªöÂä®ÂàÜÈ°µÔºü</h4><p>FeedÊµÅ‰∏≠ÁöÑ<strong>Êï∞ÊçÆ‰ºö‰∏çÊñ≠Êõ¥Êñ∞</strong>ÔºåÊâÄ‰ª•Êï∞ÊçÆÁöÑËßíÊ†á‰πüÂú®ÂèòÂåñÔºåÂõ†Ê≠§‰∏çËÉΩÈááÁî®‰º†ÁªüÁöÑÂàÜÈ°µÊ®°Âºè„ÄÇ</p>
<ul>
<li>Â¶Ç‰ΩïÂÆûÁé∞FeedÊµÅÁöÑÂàÜÈ°µÂäüËÉΩÊòØ‰∏Ä‰∏™Â§çÊùÇÁöÑÈóÆÈ¢òÔºåÂ¶ÇÊûúÈááÁî®MyBatis‰∏≠ÁöÑÂàÜÈ°µÊèí‰ª∂ÊòØ‰∏çËÉΩÊª°Ë∂≥ÂàÜÈ°µÂäüËÉΩÁöÑÔºå<strong>Âõ†‰∏∫FeedÊµÅÊòØ‰∏Ä‰∏™Âä®ÊÄÅÁöÑÔºåÊï∞ÊçÆ‰ºö‰∏çÊñ≠Êõ¥Êñ∞ÔºåÂõ†Ê≠§Êï∞ÊçÆÁöÑËßíÊ†á‰ºö‰∏çÂÅúÊõ¥Êñ∞</strong>ÔºåÂΩìÊàë‰ª¨ÈúÄË¶ÅÊü•ËØ¢Á¨¨5-10Êù°ÁöÑÊï∞ÊçÆÊó∂ÔºåÂèØËÉΩÂèà‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™Êñ∞ÁöÑÊï∞ÊçÆÂà∞Êï∞ÊçÆÂ∫ìÔºå‰ªéËÄå<strong>ÂØºËá¥Êàë‰ª¨ÂàÜÈ°µÊü•ÊâæÁöÑÊï∞ÊçÆÂ≠òÂú®‰∏é‰∏ä‰∏ÄÊ¨°Êü•ËØ¢ÁöÑÊï∞ÊçÆÈáçÂ§çÁöÑÈóÆÈ¢ò</strong></li>
</ul>
<h4 id="5-3-Â¶Ç‰ΩïÂÆûÁé∞ÊªöÂä®ÂàÜÈ°µÔºü"><a href="#5-3-Â¶Ç‰ΩïÂÆûÁé∞ÊªöÂä®ÂàÜÈ°µÔºü" class="headerlink" title="5.3 Â¶Ç‰ΩïÂÆûÁé∞ÊªöÂä®ÂàÜÈ°µÔºü"></a>5.3 Â¶Ç‰ΩïÂÆûÁé∞ÊªöÂä®ÂàÜÈ°µÔºü</h4><p>ÊªöÂä®ÂàÜÈ°µÂ∞±ÊòØÊØèÊ¨°Êü•ËØ¢ËøáÊï∞ÊçÆÂ∫ìÂêéÔºåÊàë‰ª¨ÈúÄË¶Å<strong>ËÆ∞ÂΩïËøô‰∏ÄÊ¨°Êü•ËØ¢ÁªìÊûúÁöÑÊúÄÂêé‰∏ÄÊù°Êï∞ÊçÆÔºå‰∏ã‰∏ÄÊ¨°Êü•ËØ¢Êó∂Ôºå‰ªéËøô‰∏™‰ΩçÁΩÆÂºÄÂßãÂéªËØªÂèñÊï∞ÊçÆ</strong></p>
<ol>
<li>ÊØèÊ¨°Êü•ËØ¢ÂÆåÊàêÂêéÔºåÊàë‰ª¨Ë¶ÅÂàÜÊûêÂá∫<strong>Êü•ËØ¢Âá∫Êï∞ÊçÆÁöÑÊúÄÂ∞èÊó∂Èó¥Êà≥</strong>ÔºåËøô‰∏™ÂÄº‰ºö<strong>‰Ωú‰∏∫‰∏ã‰∏ÄÊ¨°Êü•ËØ¢ÁöÑÊù°‰ª∂</strong></li>
<li>Êàë‰ª¨ÈúÄË¶Å<strong>ÊâæÂà∞‰∏é‰∏ä‰∏ÄÊ¨°Êü•ËØ¢Áõ∏ÂêåÁöÑÊü•ËØ¢‰∏™Êï∞‰Ωú‰∏∫ÂÅèÁßªÈáè</strong>Ôºå‰∏ãÊ¨°Êü•ËØ¢Êó∂Ôºå<strong>Ë∑≥ËøáËøô‰∫õÊü•ËØ¢ËøáÁöÑÊï∞ÊçÆÔºåÊãøÂà∞Êàë‰ª¨ÈúÄË¶ÅÁöÑÊï∞ÊçÆ</strong></li>
</ol>
<ul>
<li>Áªº‰∏äÔºöÊàë‰ª¨ÁöÑËØ∑Ê±ÇÂèÇÊï∞‰∏≠Â∞±ÈúÄË¶ÅÊê∫Â∏¶ lastIdÔºö<strong>‰∏ä‰∏ÄÊ¨°Êü•ËØ¢ÁöÑÊúÄÂ∞èÊó∂Èó¥Êà≥</strong> Âíå<strong>ÂÅèÁßªÈáè</strong>Ëøô‰∏§‰∏™ÂèÇÊï∞</li>
</ul>
<h3 id="6-ÂÄüÂä©-Redis-ÁöÑ-ZSet-ÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºåÂà©Áî®-Set-Êï∞ÊçÆÁªìÊûÑÊîØÊåÅÁî®Êà∑ÂÖ≥Ê≥®‰∏éÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ"><a href="#6-ÂÄüÂä©-Redis-ÁöÑ-ZSet-ÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºåÂà©Áî®-Set-Êï∞ÊçÆÁªìÊûÑÊîØÊåÅÁî®Êà∑ÂÖ≥Ê≥®‰∏éÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ" class="headerlink" title="6. ÂÄüÂä© Redis ÁöÑ ZSet ÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºåÂà©Áî® Set Êï∞ÊçÆÁªìÊûÑÊîØÊåÅÁî®Êà∑ÂÖ≥Ê≥®‰∏éÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ"></a>6. ÂÄüÂä© Redis ÁöÑ ZSet ÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºåÂà©Áî® Set Êï∞ÊçÆÁªìÊûÑÊîØÊåÅÁî®Êà∑ÂÖ≥Ê≥®‰∏éÂÖ±ÂêåÂÖ≥Ê≥®ÂäüËÉΩ</h3><h4 id="6-1-‰∏∫‰ªÄ‰πà‰ΩøÁî®ZSetÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºü"><a href="#6-1-‰∏∫‰ªÄ‰πà‰ΩøÁî®ZSetÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºü" class="headerlink" title="6.1 ‰∏∫‰ªÄ‰πà‰ΩøÁî®ZSetÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºü"></a>6.1 ‰∏∫‰ªÄ‰πà‰ΩøÁî®ZSetÂÆûÁé∞ÁÇπËµûÊéíË°åÊ¶úÔºü</h4><p><a href="#63-%E7%82%B9%E8%B5%9E%E6%8E%92%E8%A1%8C%E6%A6%9C">Ë∑≥ËΩ¨Âà∞ÁÇπËµûÊéíË°åÊ¶ú</a></p>
<p>Âú®Êé¢Â∫óÁ¨îËÆ∞ÁöÑËØ¶ÊÉÖÈ°µÈù¢ÔºåÂ∫îËØ•ÊääÁªôËØ•Á¨îËÆ∞ÁÇπËµûÁöÑ‰∫∫ÊòæÁ§∫Âá∫Êù•ÔºåÊØîÂ¶ÇÊúÄÊó©ÁÇπËµûÁöÑTOP5ÔºåÂΩ¢ÊàêÁÇπËµûÊéíË°åÊ¶ú</p>
<ul>
<li><strong>ÁÇπËµûÂäüËÉΩ</strong>Ôºö‰ΩøÁî®setÈõÜÂêàÔºåÂõ†‰∏∫ÁÇπËµûÊòØ‰∏çËÉΩÈáçÂ§çÁöÑ</li>
<li><strong>ÁÇπËµûÊéíË°åÊ¶úÂäüËÉΩ</strong>Ôºö‰ΩøÁî®sortedSet(ZSet)ÔºåÂõ†‰∏∫ÈúÄË¶ÅÈááÁî®‰∏Ä‰∏™<strong>ÂèØ‰ª•ÊéíÂ∫èÁöÑsetÈõÜÂêà</strong></li>
</ul>
<p>ZSetÔºö‰øùÂ≠òÁî®Êà∑ID‰∏∫ÈîÆÔºåÁî®Êà∑ÁÇπËµûÊó∂Èó¥‰Ωú‰∏∫scoreËøõË°åÊéíÂ∫è</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">stringRedisTemplate.opsForZSet().add(key, userId.toString(), System.currentTimeMillis());<br></code></pre></td></tr></table></figure>

<p>Êü•ËØ¢top5ÁöÑÁÇπËµûÁî®Êà∑: <code>zrange key 0 4</code></p>
<h4 id="6-2-Â¶Ç‰ΩïÂà©Áî®SetÂÆûÁé∞Áî®Êà∑ÂÖ≥Ê≥®ÂíåÂÖ±ÂêåÂÖ≥Ê≥®Ôºü"><a href="#6-2-Â¶Ç‰ΩïÂà©Áî®SetÂÆûÁé∞Áî®Êà∑ÂÖ≥Ê≥®ÂíåÂÖ±ÂêåÂÖ≥Ê≥®Ôºü" class="headerlink" title="6.2 Â¶Ç‰ΩïÂà©Áî®SetÂÆûÁé∞Áî®Êà∑ÂÖ≥Ê≥®ÂíåÂÖ±ÂêåÂÖ≥Ê≥®Ôºü"></a>6.2 Â¶Ç‰ΩïÂà©Áî®SetÂÆûÁé∞Áî®Êà∑ÂÖ≥Ê≥®ÂíåÂÖ±ÂêåÂÖ≥Ê≥®Ôºü</h4><p><a href="#72-%E5%85%B1%E5%90%8C%E5%85%B3%E6%B3%A8">Ë∑≥ËΩ¨Âà∞ÂÖ≥Ê≥®ÂíåÂÖ±ÂêåÂÖ≥Ê≥®</a></p>
<p><strong>Áî®Êà∑ÂÖ≥Ê≥®</strong>ÔºöÊòØUser‰πãÈó¥ÁöÑÂÖ≥Á≥ªÔºåÊòØÂçö‰∏ª‰∏éÁ≤â‰∏ùÁöÑÂÖ≥Á≥ªÔºåÊï∞ÊçÆÂ∫ì‰∏≠Êúâ‰∏ÄÂº†tb_followË°®Êù•Ë°®Á§∫</p>
<ul>
<li>Ë°®ÁöÑ‰∏ªÈîÆÊòØÂΩìÂâçÁî®Êà∑IDÔºåÊúâ‰∏Ä‰∏™FollowedIDË°®Á§∫ÂÖ≥Ê≥®ÁöÑÁî®Êà∑ID</li>
</ul>
<p><strong>ÂÖ±ÂêåÂÖ≥Ê≥®</strong>ÔºöÂú®Âçö‰∏ª‰∏™‰∫∫È°µÈù¢Â±ïÁ§∫Âá∫ÂΩìÂâçÁî®Êà∑‰∏éÂçö‰∏ªÁöÑÂÖ±ÂêåÂÖ≥Ê≥®Âë¢</p>
<ul>
<li>‰ΩøÁî®setÈõÜÂêàÔºå<strong>Âú®setÈõÜÂêà‰∏≠ÔºåÊúâ‰∫§ÈõÜÂπ∂ÈõÜË°•ÈõÜÁöÑapi</strong></li>
<li>Êàë‰ª¨ÂèØ‰ª•Êää‰∏§‰∫∫ÁöÑÂÖ≥Ê≥®ÁöÑ‰∫∫ÂàÜÂà´ÊîæÂÖ•Âà∞‰∏Ä‰∏™setÈõÜÂêà‰∏≠ÔºåÁÑ∂ÂêéÂÜçÈÄöËøáapiÂéªÊü•ÁúãËøô‰∏§‰∏™setÈõÜÂêà‰∏≠ÁöÑ‰∫§ÈõÜÊï∞ÊçÆ„ÄÇ</li>
</ul>
<h4 id="6-3-‰ªãÁªçSetÊï∞ÊçÆÁªìÊûÑÂíåÂ∫ïÂ±ÇÂéüÁêÜ"><a href="#6-3-‰ªãÁªçSetÊï∞ÊçÆÁªìÊûÑÂíåÂ∫ïÂ±ÇÂéüÁêÜ" class="headerlink" title="6.3 ‰ªãÁªçSetÊï∞ÊçÆÁªìÊûÑÂíåÂ∫ïÂ±ÇÂéüÁêÜ"></a>6.3 ‰ªãÁªçSetÊï∞ÊçÆÁªìÊûÑÂíåÂ∫ïÂ±ÇÂéüÁêÜ</h4><p><a href="#26-set%E7%B1%BB%E5%9E%8B">Ë∑≥ËΩ¨Âà∞SetÊï∞ÊçÆÁªìÊûÑ</a></p>
<p><a href="#27-sortedset%E7%B1%BB%E5%9E%8B">Ë∑≥ËΩ¨Âà∞ZSetÊï∞ÊçÆÁªìÊûÑ</a></p>
<p><a href="#110-redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-set">Ë∑≥ËΩ¨Âà∞SetÊï∞ÊçÆÁªìÊûÑÂ∫ïÂ±ÇÂéüÁêÜ</a></p>
<p><a href="#111-redis%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-zset">Ë∑≥ËΩ¨Âà∞ZSetÊï∞ÊçÆÁªìÊûÑÂ∫ïÂ±ÇÂéüÁêÜ</a></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/JAVA/" class="category-chain-item">JAVA</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="print-no-link">#Â≠¶‰π†</a>
      
        <a href="/tags/JAVA/" class="print-no-link">#JAVA</a>
      
        <a href="/tags/Redis/" class="print-no-link">#Redis</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/12/JAVA/JUC/" title="JUCÂπ∂ÂèëÁºñÁ®ãÂ≠¶‰π†Á¨îËÆ∞">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JUCÂπ∂ÂèëÁºñÁ®ãÂ≠¶‰π†Á¨îËÆ∞</span>
                        <span class="visible-mobile">‰∏ä‰∏ÄÁØá</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/04/04/JAVA/SpringCloud/SpringCloud/" title="SpringCloudÂ≠¶‰π†Á¨îËÆ∞">
                        <span class="hidden-mobile">SpringCloudÂ≠¶‰π†Á¨îËÆ∞</span>
                        <span class="visible-mobile">‰∏ã‰∏ÄÁØá</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"sj2tGuxMGSDhkN5hNuOIVta1-gzGzoHsz","appKey":"ysR5OTuTzoby2oNvNyGOtXFQ","path":"window.location.pathname","placeholder":"Â¶ÇÊúâÈóÆÈ¢òÔºåÊ¨¢ËøéÊåáÊ≠£~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ÁõÆÂΩï</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">ÊêúÁ¥¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">ÂÖ≥ÈîÆËØç</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>AI</span> <i class="iconfont icon-love"></i> <span>CPP</span> <i class="iconfont icon-love"></i> <span>JAVA</span> <i class="iconfont icon-love"></i> <span>CyberSec</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        ÊÄªËÆøÈóÆÈáè 
        <span id="busuanzi_value_site_pv"></span>
         Ê¨°
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        ÊÄªËÆøÂÆ¢Êï∞ 
        <span id="busuanzi_value_site_uv"></span>
         ‰∫∫
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>
<script src="/js/bubble.js"></script>



<!-- ‰∏ªÈ¢òÁöÑÂêØÂä®È°πÔºåÂ∞ÜÂÆÉ‰øùÊåÅÂú®ÊúÄÂ∫ïÈÉ® -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">ÂçöÂÆ¢Âú®ÂÖÅËÆ∏ JavaScript ËøêË°åÁöÑÁéØÂ¢É‰∏ãÊµèËßàÊïàÊûúÊõ¥‰Ω≥</div>
  </noscript>
</body>
</html>
