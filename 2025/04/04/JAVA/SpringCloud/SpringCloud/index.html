

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/about/dogs.jpg">
  <link rel="icon" href="/img/about/dogs.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="ranzier">
  <meta name="keywords" content="">
  
    <meta name="description" content="SpringCloudå¾®æœåŠ¡å­¦ä¹ ç¬”è®°   ä¸€. MybatisPlus1. å¿«é€Ÿå…¥é—¨å®ç°æ­¥éª¤ï¼š  å¼•å…¥MybatisPlusä¾èµ– å®šä¹‰Mapper  1.1 å¼•å…¥ä¾èµ–12345&lt;dependency&gt;    &lt;groupId&gt;com.baomidou&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;mybatis-plus-boot-starter">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloudå­¦ä¹ ç¬”è®°">
<meta property="og:url" content="http://example.com/2025/04/04/JAVA/SpringCloud/SpringCloud/index.html">
<meta property="og:site_name" content="RANZIER">
<meta property="og:description" content="SpringCloudå¾®æœåŠ¡å­¦ä¹ ç¬”è®°   ä¸€. MybatisPlus1. å¿«é€Ÿå…¥é—¨å®ç°æ­¥éª¤ï¼š  å¼•å…¥MybatisPlusä¾èµ– å®šä¹‰Mapper  1.1 å¼•å…¥ä¾èµ–12345&lt;dependency&gt;    &lt;groupId&gt;com.baomidou&lt;&#x2F;groupId&gt;    &lt;artifactId&gt;mybatis-plus-boot-starter">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg/32.jpg">
<meta property="article:published_time" content="2025-04-04T02:38:09.000Z">
<meta property="article:modified_time" content="2025-10-14T03:58:51.450Z">
<meta property="article:author" content="ranzier">
<meta property="article:tag" content="JAVA">
<meta property="article:tag" content="SpringCloud">
<meta property="article:tag" content="å­¦ä¹ ">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/bg/32.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>SpringCloudå­¦ä¹ ç¬”è®° - RANZIER</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  



  
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3846514_kabxni94auf.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/shubiao.css">
<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/bynotes/texiao/source/css/gundongtiao.css">
<link rel="stylesheet" href="/css/bubble.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"ğŸŒŸ","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.0.0"></head>


<body><!-- hexo injector body_begin start --><div id="web_bg"></div><!-- hexo injector body_begin end -->
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>RANZIER</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>é¦–é¡µ</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>å½’æ¡£</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>åˆ†ç±»</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>æ ‡ç­¾</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>å…³äº</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg/3.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.35)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringCloudå­¦ä¹ ç¬”è®°"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-04-04 10:38" pubdate>
          2025å¹´4æœˆ4æ—¥ ä¸Šåˆ
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          28k å­—
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          139 åˆ†é’Ÿ
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          æœ¬æ–‡é˜…è¯»æ¬¡æ•°ï¼š<span id="busuanzi_value_page_pv"></span> æ¬¡
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">SpringCloudå­¦ä¹ ç¬”è®°</h1>
            
            
              <div class="markdown-body">
                
                <h1 align="center">SpringCloudå¾®æœåŠ¡å­¦ä¹ ç¬”è®°</h1>


<h1 id="ä¸€-MybatisPlus"><a href="#ä¸€-MybatisPlus" class="headerlink" title="ä¸€. MybatisPlus"></a>ä¸€. MybatisPlus</h1><h2 id="1-å¿«é€Ÿå…¥é—¨"><a href="#1-å¿«é€Ÿå…¥é—¨" class="headerlink" title="1. å¿«é€Ÿå…¥é—¨"></a>1. å¿«é€Ÿå…¥é—¨</h2><p>å®ç°æ­¥éª¤ï¼š</p>
<ul>
<li>å¼•å…¥MybatisPlusä¾èµ–</li>
<li>å®šä¹‰Mapper</li>
</ul>
<h3 id="1-1-å¼•å…¥ä¾èµ–"><a href="#1-1-å¼•å…¥ä¾èµ–" class="headerlink" title="1.1 å¼•å…¥ä¾èµ–"></a>1.1 å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="1-2-å®šä¹‰Mapper"><a href="#1-2-å®šä¹‰Mapper" class="headerlink" title="1.2 å®šä¹‰Mapper"></a>1.2 å®šä¹‰Mapper</h3><ul>
<li>MybatisPlusæä¾›äº†ä¸€ä¸ªåŸºç¡€çš„BaseMapperæ¥å£</li>
<li>ä¿®æ”¹mp-demoä¸­çš„com.itheima.mp.mapperåŒ…ä¸‹çš„UserMapperæ¥å£ï¼Œè®©å…¶ç»§æ‰¿BaseMapperï¼š</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="2-å¸¸è§æ³¨è§£"><a href="#2-å¸¸è§æ³¨è§£" class="headerlink" title="2. å¸¸è§æ³¨è§£"></a>2. å¸¸è§æ³¨è§£</h2><h3 id="2-1-é»˜è®¤æƒ…å†µ"><a href="#2-1-é»˜è®¤æƒ…å†µ" class="headerlink" title="2.1 é»˜è®¤æƒ…å†µ"></a>2.1 é»˜è®¤æƒ…å†µ</h3><p>MybatisPluså°±æ˜¯æ ¹æ®POå®ä½“çš„ä¿¡æ¯æ¥æ¨æ–­å‡ºè¡¨çš„ä¿¡æ¯ï¼Œä»è€Œç”ŸæˆSQLçš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼š</p>
<ul>
<li>MybatisPlusä¼šæŠŠPOå®ä½“çš„ç±»åé©¼å³°è½¬ä¸‹åˆ’çº¿ä½œä¸ºè¡¨å</li>
<li>MybatisPlusä¼šæŠŠPOå®ä½“çš„æ‰€æœ‰å˜é‡åé©¼å³°è½¬ä¸‹åˆ’çº¿ä½œä¸ºè¡¨çš„å­—æ®µåï¼Œå¹¶æ ¹æ®å˜é‡ç±»å‹æ¨æ–­å­—æ®µç±»å‹</li>
<li>MybatisPlusä¼šæŠŠåä¸ºidçš„å­—æ®µä½œä¸ºä¸»é”®</li>
</ul>
<h3 id="2-2-TableName"><a href="#2-2-TableName" class="headerlink" title="2.2 @TableName"></a>2.2 @TableName</h3><ul>
<li>æè¿°ï¼šè¡¨åæ³¨è§£ï¼Œæ ‡è¯†å®ä½“ç±»å¯¹åº”çš„è¡¨</li>
<li>ä½¿ç”¨ä½ç½®ï¼šå®ä½“ç±»</li>
</ul>
<h3 id="2-3-TableId"><a href="#2-3-TableId" class="headerlink" title="2.3 @TableId"></a>2.3 @TableId</h3><ul>
<li>æè¿°ï¼šä¸»é”®æ³¨è§£ï¼Œæ ‡è¯†å®ä½“ç±»ä¸­çš„ä¸»é”®å­—æ®µ</li>
<li>ä½¿ç”¨ä½ç½®ï¼šå®ä½“ç±»çš„ä¸»é”®å­—æ®µ</li>
</ul>
<p>IdTypeå±æ€§çš„å¸¸è§å€¼ï¼š</p>
<ul>
<li>AUTOï¼šåˆ©ç”¨æ•°æ®åº“çš„idè‡ªå¢é•¿</li>
<li>INPUTï¼šæ‰‹åŠ¨ç”Ÿæˆid</li>
<li>ASSIGN_IDï¼šé›ªèŠ±ç®—æ³•ç”ŸæˆLongç±»å‹çš„å…¨å±€å”¯ä¸€idï¼Œè¿™æ˜¯é»˜è®¤çš„IDç­–ç•¥</li>
</ul>
<h3 id="2-4-TableField"><a href="#2-4-TableField" class="headerlink" title="2.4 @TableField"></a>2.4 @TableField</h3><p>æ™®é€šå­—æ®µæ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableName(&quot;user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> &#123;<br>    <span class="hljs-meta">@TableId</span><br>    <span class="hljs-keyword">private</span> Long id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-meta">@TableField(is_married&quot;)</span><br>    <span class="hljs-keyword">private</span> Boolean isMarried;<br>    <span class="hljs-meta">@TableField(&quot;`concat`&quot;)</span><br>    <span class="hljs-keyword">private</span> String concat;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>æ·»åŠ @TableFieldæ³¨è§£çš„ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼š</p>
<ul>
<li>æˆå‘˜å˜é‡åä¸æ•°æ®åº“å­—æ®µåä¸ä¸€è‡´</li>
<li>æˆå‘˜å˜é‡æ˜¯ä»¥isXXXå‘½åï¼ŒæŒ‰ç…§JavaBeançš„è§„èŒƒï¼ŒMybatisPlusè¯†åˆ«å­—æ®µæ—¶ä¼šæŠŠiså»é™¤ï¼Œè¿™å°±å¯¼è‡´ä¸æ•°æ®åº“ä¸ç¬¦ã€‚</li>
<li>æˆå‘˜å˜é‡åä¸æ•°æ®åº“ä¸€è‡´ï¼Œä½†æ˜¯ä¸æ•°æ®åº“çš„å…³é”®å­—å†²çªã€‚ä½¿ç”¨@TableFieldæ³¨è§£ç»™å­—æ®µåæ·»åŠ è½¬ä¹‰å­—ç¬¦ï¼š&#96;&#96;</li>
</ul>
<h2 id="3-æ ¸å¿ƒåŠŸèƒ½"><a href="#3-æ ¸å¿ƒåŠŸèƒ½" class="headerlink" title="3. æ ¸å¿ƒåŠŸèƒ½"></a>3. æ ¸å¿ƒåŠŸèƒ½</h2><h3 id="3-1-æ¡ä»¶æ„é€ å™¨"><a href="#3-1-æ¡ä»¶æ„é€ å™¨" class="headerlink" title="3.1 æ¡ä»¶æ„é€ å™¨"></a>3.1 æ¡ä»¶æ„é€ å™¨</h3><p>é™¤äº†æ–°å¢ä»¥å¤–ï¼Œä¿®æ”¹ã€åˆ é™¤ã€æŸ¥è¯¢çš„SQLè¯­å¥éƒ½éœ€è¦æŒ‡å®šwhereæ¡ä»¶ã€‚å› æ­¤BaseMapperä¸­æä¾›çš„ç›¸å…³æ–¹æ³•é™¤äº†ä»¥idä½œä¸ºwhereæ¡ä»¶ä»¥å¤–ï¼Œè¿˜æ”¯æŒæ›´åŠ å¤æ‚çš„whereæ¡ä»¶ã€‚</p>
<p>Wrapperå°±æ˜¯æ¡ä»¶æ„é€ çš„æŠ½è±¡ç±»</p>
<p><img src="/img/blogs/java/springcloud/mp.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-1-1-QueryWrapper"><a href="#3-1-1-QueryWrapper" class="headerlink" title="3.1.1 QueryWrapper"></a>3.1.1 QueryWrapper</h4><p>æŸ¥è¯¢ï¼šæŸ¥è¯¢å‡ºåå­—ä¸­å¸¦oçš„ï¼Œå­˜æ¬¾å¤§äºç­‰äº1000å…ƒçš„äººã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testQueryWrapper</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.æ„å»ºæŸ¥è¯¢æ¡ä»¶ where name like &quot;%o%&quot; AND balance &gt;= 1000</span><br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;()<br>            .select(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;info&quot;</span>, <span class="hljs-string">&quot;balance&quot;</span>)<br>            .like(<span class="hljs-string">&quot;username&quot;</span>, <span class="hljs-string">&quot;o&quot;</span>)<br>            .ge(<span class="hljs-string">&quot;balance&quot;</span>, <span class="hljs-number">1000</span>);<br>    <span class="hljs-comment">// 2.æŸ¥è¯¢æ•°æ®</span><br>    List&lt;User&gt; users = userMapper.selectList(wrapper);<br>    users.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-UpdateWrapper"><a href="#3-1-2-UpdateWrapper" class="headerlink" title="3.1.2 UpdateWrapper"></a>3.1.2 UpdateWrapper</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateWrapper</span><span class="hljs-params">()</span> &#123;<br>    List&lt;Long&gt; ids = List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">4L</span>);<br>    <span class="hljs-comment">// 1.ç”ŸæˆSQL</span><br>    UpdateWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateWrapper</span>&lt;User&gt;()<br>            .setSql(<span class="hljs-string">&quot;balance = balance - 200&quot;</span>) <span class="hljs-comment">// SET balance = balance - 200</span><br>            .in(<span class="hljs-string">&quot;id&quot;</span>, ids); <span class="hljs-comment">// WHERE id in (1, 2, 4)</span><br>        <span class="hljs-comment">// 2.æ›´æ–°ï¼Œæ³¨æ„ç¬¬ä¸€ä¸ªå‚æ•°å¯ä»¥ç»™nullï¼Œä¹Ÿå°±æ˜¯ä¸å¡«æ›´æ–°å­—æ®µå’Œæ•°æ®ï¼Œ</span><br>    <span class="hljs-comment">// è€Œæ˜¯åŸºäºUpdateWrapperä¸­çš„setSQLæ¥æ›´æ–°</span><br>    userMapper.update(<span class="hljs-literal">null</span>, wrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-3-LambdaQueryWrapper"><a href="#3-1-3-LambdaQueryWrapper" class="headerlink" title="3.1.3 LambdaQueryWrapper"></a>3.1.3 LambdaQueryWrapper</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testLambdaQueryWrapper</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.æ„å»ºæ¡ä»¶ WHERE username LIKE &quot;%o%&quot; AND balance &gt;= 1000</span><br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;&gt;();<br>    wrapper.lambda()<br>            .select(User::getId, User::getUsername, User::getInfo, User::getBalance)<br>            .like(User::getUsername, <span class="hljs-string">&quot;o&quot;</span>)<br>            .ge(User::getBalance, <span class="hljs-number">1000</span>);<br>    <span class="hljs-comment">// 2.æŸ¥è¯¢</span><br>    List&lt;User&gt; users = userMapper.selectList(wrapper);<br>    users.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-è‡ªå®šä¹‰SQL"><a href="#3-2-è‡ªå®šä¹‰SQL" class="headerlink" title="3.2 è‡ªå®šä¹‰SQL"></a>3.2 è‡ªå®šä¹‰SQL</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testCustomWrapper</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.å‡†å¤‡è‡ªå®šä¹‰æŸ¥è¯¢æ¡ä»¶</span><br>    List&lt;Long&gt; ids = List.of(<span class="hljs-number">1L</span>, <span class="hljs-number">2L</span>, <span class="hljs-number">4L</span>);<br>    QueryWrapper&lt;User&gt; wrapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryWrapper</span>&lt;User&gt;().in(<span class="hljs-string">&quot;id&quot;</span>, ids);<br><br>    <span class="hljs-comment">// 2.è°ƒç”¨mapperçš„è‡ªå®šä¹‰æ–¹æ³•ï¼Œç›´æ¥ä¼ é€’Wrapper</span><br>    userMapper.deductBalanceByIds(<span class="hljs-number">200</span>, wrapper);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç„¶ååœ¨UserMapperä¸­è‡ªå®šä¹‰SQLï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">BaseMapper</span>&lt;User&gt; &#123;<br>    <span class="hljs-meta">@Select(&quot;UPDATE user SET balance = balance - #&#123;money&#125; $&#123;ew.customSqlSegment&#125;&quot;)</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductBalanceByIds</span><span class="hljs-params">(<span class="hljs-meta">@Param(&quot;money&quot;)</span> <span class="hljs-type">int</span> money, <span class="hljs-meta">@Param(&quot;ew&quot;)</span> QueryWrapper&lt;User&gt; wrapper)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="3-3-Serviceæ¥å£"><a href="#3-3-Serviceæ¥å£" class="headerlink" title="3.3 Serviceæ¥å£"></a>3.3 Serviceæ¥å£</h3><h4 id="3-3-1-ä»‹ç»"><a href="#3-3-1-ä»‹ç»" class="headerlink" title="3.3.1 ä»‹ç»"></a>3.3.1 ä»‹ç»</h4><p>MybatisPlusä¸ä»…æä¾›äº†BaseMapperï¼Œè¿˜æä¾›äº†é€šç”¨çš„Serviceæ¥å£åŠé»˜è®¤å®ç°ï¼Œå°è£…äº†ä¸€äº›å¸¸ç”¨çš„serviceæ¨¡æ¿æ–¹æ³•ã€‚<br><strong>é€šç”¨æ¥å£ä¸ºIService</strong>ï¼Œ<strong>é»˜è®¤å®ç°ä¸ºServiceImpl</strong>ï¼Œå…¶ä¸­å°è£…çš„æ–¹æ³•å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p>
<ul>
<li>saveï¼šæ–°å¢</li>
<li>removeï¼šåˆ é™¤</li>
<li>updateï¼šæ›´æ–°</li>
<li>getï¼šæŸ¥è¯¢å•ä¸ªç»“æœ</li>
<li>listï¼šæŸ¥è¯¢é›†åˆç»“æœ</li>
<li>countï¼šè®¡æ•°</li>
<li>pageï¼šåˆ†é¡µæŸ¥è¯¢</li>
</ul>
<h4 id="3-3-2-åŸºæœ¬ç”¨æ³•"><a href="#3-3-2-åŸºæœ¬ç”¨æ³•" class="headerlink" title="3.3.2 åŸºæœ¬ç”¨æ³•"></a>3.3.2 åŸºæœ¬ç”¨æ³•</h4><p>è‡ªå®šä¹‰Serviceæ¥å£ç»§æ‰¿IServiceä»¥æ‹“å±•æ–¹æ³•ã€‚åŒæ—¶ï¼Œè®©è‡ªå®šä¹‰çš„Serviceå®ç°ç±»ç»§æ‰¿ServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IService</span>&lt;User&gt; &#123;<br>    <span class="hljs-comment">// æ‹“å±•è‡ªå®šä¹‰æ–¹æ³•</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>ç¼–å†™UserServiceImplç±»ï¼Œç»§æ‰¿ServiceImplï¼Œå®ç°UserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ServiceImpl</span>&lt;UserMapper, User&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> &#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-3-Lambda"><a href="#3-3-3-Lambda" class="headerlink" title="3.3.3 Lambda"></a>3.3.3 Lambda</h4><p>IServiceä¸­è¿˜æä¾›äº†LambdaåŠŸèƒ½æ¥ç®€åŒ–æˆ‘ä»¬çš„å¤æ‚æŸ¥è¯¢åŠæ›´æ–°åŠŸèƒ½</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductBalance</span><span class="hljs-params">(Long id, Integer money)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢ç”¨æˆ·</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(id);<br>    <span class="hljs-comment">// 2.æ ¡éªŒç”¨æˆ·çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span> || user.getStatus() == <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç”¨æˆ·çŠ¶æ€å¼‚å¸¸ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 3.æ ¡éªŒä½™é¢æ˜¯å¦å……è¶³</span><br>    <span class="hljs-keyword">if</span> (user.getBalance() &lt; money) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;ç”¨æˆ·ä½™é¢ä¸è¶³ï¼&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 4.æ‰£å‡ä½™é¢ update tb_user set balance = balance - ?</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">remainBalance</span> <span class="hljs-operator">=</span> user.getBalance() - money;<br>    lambdaUpdate()<br>            .set(User::getBalance, remainBalance) <span class="hljs-comment">// æ›´æ–°ä½™é¢</span><br>            .set(remainBalance == <span class="hljs-number">0</span>, User::getStatus, <span class="hljs-number">2</span>) <span class="hljs-comment">// åŠ¨æ€åˆ¤æ–­ï¼Œæ˜¯å¦æ›´æ–°status</span><br>            .eq(User::getId, id)<br>            .eq(User::getBalance, user.getBalance()) <span class="hljs-comment">// ä¹è§‚é”</span><br>            .update();<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-æ‰©å±•åŠŸèƒ½"><a href="#4-æ‰©å±•åŠŸèƒ½" class="headerlink" title="4. æ‰©å±•åŠŸèƒ½"></a>4. æ‰©å±•åŠŸèƒ½</h2><h3 id="4-1-ä»£ç ç”Ÿæˆ"><a href="#4-1-ä»£ç ç”Ÿæˆ" class="headerlink" title="4.1 ä»£ç ç”Ÿæˆ"></a>4.1 ä»£ç ç”Ÿæˆ</h3><p>ä½¿ç”¨MybatisXæ’ä»¶å³å¯</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_47025166/article/details/125362323">SpringBootä¸­MybatisXæ’ä»¶çš„ç®€å•ä½¿ç”¨æ•™ç¨‹ï¼ˆè¶…è¯¦ç»†ï¼ï¼ï¼‰</a></p>
<h3 id="4-2-é™æ€å·¥å…·"><a href="#4-2-é™æ€å·¥å…·" class="headerlink" title="4.2 é™æ€å·¥å…·"></a>4.2 é™æ€å·¥å…·</h3><p>æœ‰çš„æ—¶å€™<strong>Serviceä¹‹é—´ä¹Ÿä¼šç›¸äº’è°ƒç”¨</strong>ï¼Œä¸ºäº†é¿å…å‡ºç°å¾ªç¯ä¾èµ–é—®é¢˜ï¼ŒMybatisPlusæä¾›ä¸€ä¸ªé™æ€å·¥å…·ç±»ï¼šDbï¼Œå…¶ä¸­çš„ä¸€äº›é™æ€æ–¹æ³•ä¸IServiceä¸­æ–¹æ³•ç­¾ååŸºæœ¬ä¸€è‡´</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> UserVO <span class="hljs-title function_">queryUserAndAddressById</span><span class="hljs-params">(Long userId)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢ç”¨æˆ·</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-comment">// 2.æŸ¥è¯¢æ”¶è´§åœ°å€</span><br>    List&lt;Address&gt; addresses = Db.lambdaQuery(Address.class)<br>            .eq(Address::getUserId, userId)<br>            .list();<br>    <span class="hljs-comment">// 3.å¤„ç†vo</span><br>    <span class="hljs-type">UserVO</span> <span class="hljs-variable">userVO</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(user, UserVO.class);<br>    userVO.setAddresses(BeanUtil.copyToList(addresses, AddressVO.class));<br>    <span class="hljs-keyword">return</span> userVO;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>åœ¨æŸ¥è¯¢åœ°å€æ—¶ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†Dbçš„é™æ€æ–¹æ³•ï¼Œå› æ­¤é¿å…äº†æ³¨å…¥AddressServiceï¼Œå‡å°‘äº†å¾ªç¯ä¾èµ–çš„é£é™©ã€‚</p>
<h3 id="4-3-é€»è¾‘åˆ é™¤"><a href="#4-3-é€»è¾‘åˆ é™¤" class="headerlink" title="4.3 é€»è¾‘åˆ é™¤"></a>4.3 é€»è¾‘åˆ é™¤</h3><p>å¯¹äºä¸€äº›æ¯”è¾ƒé‡è¦çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸åˆ é™¤æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯</p>
<ul>
<li>åœ¨è¡¨ä¸­æ·»åŠ ä¸€ä¸ªå­—æ®µæ ‡è®°æ•°æ®æ˜¯å¦è¢«åˆ é™¤</li>
<li>å½“åˆ é™¤æ•°æ®æ—¶æŠŠæ ‡è®°ç½®ä¸ºtrue</li>
</ul>
<p>æˆ‘ä»¬è¦åœ¨application.ymlä¸­é…ç½®é€»è¾‘åˆ é™¤å­—æ®µ</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">global-config:</span><br>    <span class="hljs-attr">db-config:</span><br>      <span class="hljs-attr">logic-delete-field:</span> <span class="hljs-string">deleted</span> <span class="hljs-comment"># å…¨å±€é€»è¾‘åˆ é™¤çš„å®ä½“å­—æ®µå(since 3.3.0,é…ç½®åå¯ä»¥å¿½ç•¥ä¸é…ç½®æ­¥éª¤2)</span><br>      <span class="hljs-attr">logic-delete-value:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># é€»è¾‘å·²åˆ é™¤å€¼(é»˜è®¤ä¸º 1)</span><br>      <span class="hljs-attr">logic-not-delete-value:</span> <span class="hljs-number">0</span> <span class="hljs-comment"># é€»è¾‘æœªåˆ é™¤å€¼(é»˜è®¤ä¸º 0)</span><br></code></pre></td></tr></table></figure>

<h3 id="4-4-æšä¸¾å¤„ç†å™¨"><a href="#4-4-æšä¸¾å¤„ç†å™¨" class="headerlink" title="4.4 æšä¸¾å¤„ç†å™¨"></a>4.4 æšä¸¾å¤„ç†å™¨</h3><p>MybatisPlusæä¾›äº†ä¸€ä¸ªå¤„ç†æšä¸¾çš„ç±»å‹è½¬æ¢å™¨ï¼Œå¯ä»¥å¸®æˆ‘ä»¬æŠŠ<strong>æšä¸¾ç±»å‹ä¸æ•°æ®åº“ç±»å‹è‡ªåŠ¨è½¬æ¢</strong></p>
<h4 id="4-4-1-å®šä¹‰æšä¸¾"><a href="#4-4-1-å®šä¹‰æšä¸¾" class="headerlink" title="4.4.1 å®šä¹‰æšä¸¾"></a>4.4.1 å®šä¹‰æšä¸¾</h4><p><img src="/img/blogs/java/springcloud/mp.2.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="4-4-2-EnumValue"><a href="#4-4-2-EnumValue" class="headerlink" title="4.4.2 @EnumValue"></a>4.4.2 @EnumValue</h4><p>MybatisPlusæä¾›äº†@EnumValueæ³¨è§£æ¥æ ‡è®°æšä¸¾å±æ€§</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnumValue</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;<br></code></pre></td></tr></table></figure>
<p>è¡¨ç¤ºvalueå­—æ®µçš„å€¼æ˜¯æ•°æ®åº“å€¼</p>
<h4 id="4-4-3-é…ç½®æšä¸¾å¤„ç†å™¨"><a href="#4-4-3-é…ç½®æšä¸¾å¤„ç†å™¨" class="headerlink" title="4.4.3 é…ç½®æšä¸¾å¤„ç†å™¨"></a>4.4.3 é…ç½®æšä¸¾å¤„ç†å™¨</h4><p>åœ¨application.yamlæ–‡ä»¶ä¸­æ·»åŠ é…ç½®</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">mybatis-plus:</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">default-enum-type-handler:</span> <span class="hljs-string">com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler</span><br></code></pre></td></tr></table></figure>


<h3 id="4-5-JSONç±»å‹å¤„ç†å™¨"><a href="#4-5-JSONç±»å‹å¤„ç†å™¨" class="headerlink" title="4.5 JSONç±»å‹å¤„ç†å™¨"></a>4.5 JSONç±»å‹å¤„ç†å™¨</h3><p>æ•°æ®åº“çš„userè¡¨ä¸­æœ‰ä¸€ä¸ªinfoå­—æ®µï¼Œæ˜¯JSONç±»å‹ã€‚è€Œç›®å‰Userå®ä½“ç±»ä¸­å´æ˜¯Stringç±»å‹ã€‚å¤„ç†JSONå°±å¯ä»¥ä½¿ç”¨JacksonTypeHandlerå¤„ç†å™¨</p>
<p><strong>ä½¿ç”¨ç±»å‹å¤„ç†å™¨</strong><br>å°†Userç±»çš„infoå­—æ®µä¿®æ”¹ä¸ºUserInfoç±»å‹ï¼Œå¹¶å£°æ˜ç±»å‹å¤„ç†å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@TableField(typeHandler = JacksonTypeHandler.class)</span><br><span class="hljs-keyword">private</span> UserInfo info;<br></code></pre></td></tr></table></figure>

<h2 id="5-æ’ä»¶åŠŸèƒ½-ä»¥åˆ†é¡µæ’ä»¶ä¸ºä¾‹"><a href="#5-æ’ä»¶åŠŸèƒ½-ä»¥åˆ†é¡µæ’ä»¶ä¸ºä¾‹" class="headerlink" title="5. æ’ä»¶åŠŸèƒ½(ä»¥åˆ†é¡µæ’ä»¶ä¸ºä¾‹)"></a>5. æ’ä»¶åŠŸèƒ½(ä»¥åˆ†é¡µæ’ä»¶ä¸ºä¾‹)</h2><p>MybatisPlusæä¾›äº†å¾ˆå¤šçš„æ’ä»¶åŠŸèƒ½ï¼Œè¿›ä¸€æ­¥æ‹“å±•å…¶åŠŸèƒ½ã€‚</p>
<ul>
<li>PaginationInnerInterceptorï¼šè‡ªåŠ¨åˆ†é¡µ</li>
<li>TenantLineInnerInterceptorï¼šå¤šç§Ÿæˆ·</li>
<li>DynamicTableNameInnerInterceptorï¼šåŠ¨æ€è¡¨å</li>
<li>OptimisticLockerInnerInterceptorï¼šä¹è§‚é”</li>
<li>IllegalSQLInnerInterceptorï¼šsql æ€§èƒ½è§„èŒƒ</li>
<li>BlockAttackInnerInterceptorï¼šé˜²æ­¢å…¨è¡¨æ›´æ–°ä¸åˆ é™¤</li>
</ul>
<h3 id="5-1-é…ç½®åˆ†é¡µæ’ä»¶"><a href="#5-1-é…ç½®åˆ†é¡µæ’ä»¶" class="headerlink" title="5.1 é…ç½®åˆ†é¡µæ’ä»¶"></a>5.1 é…ç½®åˆ†é¡µæ’ä»¶</h3><p>åœ¨é¡¹ç›®ä¸­æ–°å»ºä¸€ä¸ªé…ç½®ç±»ï¼šMybatisConfig.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.annotation.DbType;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.MybatisPlusInterceptor;<br><span class="hljs-keyword">import</span> com.baomidou.mybatisplus.extension.plugins.inner.PaginationInnerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MybatisConfig</span> &#123;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title function_">mybatisPlusInterceptor</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// åˆå§‹åŒ–æ ¸å¿ƒæ’ä»¶</span><br>        <span class="hljs-type">MybatisPlusInterceptor</span> <span class="hljs-variable">interceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MybatisPlusInterceptor</span>();<br>        <span class="hljs-comment">// æ·»åŠ åˆ†é¡µæ’ä»¶</span><br>        interceptor.addInnerInterceptor(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));<br>        <span class="hljs-keyword">return</span> interceptor;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="5-2-åˆ†é¡µæŸ¥è¯¢çš„æµ‹è¯•"><a href="#5-2-åˆ†é¡µæŸ¥è¯¢çš„æµ‹è¯•" class="headerlink" title="5.2 åˆ†é¡µæŸ¥è¯¢çš„æµ‹è¯•"></a>5.2 åˆ†é¡µæŸ¥è¯¢çš„æµ‹è¯•</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPageQuery</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.åˆ†é¡µæŸ¥è¯¢ï¼Œnew Page()çš„ä¸¤ä¸ªå‚æ•°åˆ†åˆ«æ˜¯ï¼šé¡µç ã€æ¯é¡µå¤§å°</span><br>    Page&lt;User&gt; p = userService.page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;&gt;(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>));<br>    <span class="hljs-comment">// 2.æ€»æ¡æ•°</span><br>    System.out.println(<span class="hljs-string">&quot;total = &quot;</span> + p.getTotal());<br>    <span class="hljs-comment">// 3.æ€»é¡µæ•°</span><br>    System.out.println(<span class="hljs-string">&quot;pages = &quot;</span> + p.getPages());<br>    <span class="hljs-comment">// 4.æ•°æ®</span><br>    List&lt;User&gt; records = p.getRecords();<br>    records.forEach(System.out::println);<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="äºŒ-Docker"><a href="#äºŒ-Docker" class="headerlink" title="äºŒ. Docker"></a>äºŒ. Docker</h1><h2 id="1-Dockerä»‹ç»"><a href="#1-Dockerä»‹ç»" class="headerlink" title="1. Dockerä»‹ç»"></a>1. Dockerä»‹ç»</h2><p>Dockeræœ¬èº«åŒ…å«ä¸€ä¸ªåå°æœåŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨Dockerå‘½ä»¤å‘Šè¯‰DockeræœåŠ¡ï¼Œå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿéƒ¨ç½²æŒ‡å®šçš„åº”ç”¨ã€‚DockeræœåŠ¡éƒ¨ç½²åº”ç”¨æ—¶ï¼Œé¦–å…ˆè¦å»æœç´¢å¹¶ä¸‹è½½åº”ç”¨å¯¹åº”çš„é•œåƒï¼Œç„¶åæ ¹æ®é•œåƒåˆ›å»ºå¹¶å…è®¸å®¹å™¨ï¼Œåº”ç”¨å°±éƒ¨ç½²å®Œæˆäº†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/docker.1.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="2-Dockerå¸¸è§å‘½ä»¤"><a href="#2-Dockerå¸¸è§å‘½ä»¤" class="headerlink" title="2. Dockerå¸¸è§å‘½ä»¤"></a>2. Dockerå¸¸è§å‘½ä»¤</h2><h3 id="2-1-å¸¸è§å‘½ä»¤"><a href="#2-1-å¸¸è§å‘½ä»¤" class="headerlink" title="2.1 å¸¸è§å‘½ä»¤"></a>2.1 å¸¸è§å‘½ä»¤</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>docker pull</td>
<td>æ‹‰å–é•œåƒ</td>
</tr>
<tr>
<td>docker push</td>
<td>æ¨é€é•œåƒåˆ° Docker Registry</td>
</tr>
<tr>
<td>docker images</td>
<td>æŸ¥çœ‹æœ¬åœ°é•œåƒ</td>
</tr>
<tr>
<td>docker rmi</td>
<td>åˆ é™¤æœ¬åœ°é•œåƒ</td>
</tr>
<tr>
<td>docker run</td>
<td>åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨ï¼ˆä¸èƒ½é‡å¤åˆ›å»ºï¼‰</td>
</tr>
<tr>
<td>docker stop</td>
<td>åœæ­¢æŒ‡å®šå®¹å™¨</td>
</tr>
<tr>
<td>docker start</td>
<td>å¯åŠ¨æŒ‡å®šå®¹å™¨</td>
</tr>
<tr>
<td>docker restart</td>
<td>é‡æ–°å¯åŠ¨å®¹å™¨</td>
</tr>
<tr>
<td>docker rm</td>
<td>åˆ é™¤æŒ‡å®šå®¹å™¨</td>
</tr>
<tr>
<td>docker ps</td>
<td>æŸ¥çœ‹å®¹å™¨</td>
</tr>
<tr>
<td>docker logs</td>
<td>æŸ¥çœ‹å®¹å™¨è¿è¡Œæ—¥å¿—</td>
</tr>
<tr>
<td>docker exec</td>
<td>è¿›å…¥å®¹å™¨</td>
</tr>
<tr>
<td>docker save</td>
<td>ä¿å­˜é•œåƒåˆ°æœ¬åœ°å‹ç¼©æ–‡ä»¶</td>
</tr>
<tr>
<td>docker load</td>
<td>åŠ è½½æœ¬åœ°å‹ç¼©æ–‡ä»¶åˆ°é•œåƒ</td>
</tr>
<tr>
<td>docker inspect</td>
<td>æŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯</td>
</tr>
</tbody></table>
<p><img src="/img/blogs/java/springcloud/docker.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="2-2-ç¤ºä¾‹"><a href="#2-2-ç¤ºä¾‹" class="headerlink" title="2.2 ç¤ºä¾‹"></a>2.2 ç¤ºä¾‹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç¬¬1æ­¥ï¼Œå»DockerHubæŸ¥çœ‹nginxé•œåƒä»“åº“åŠç›¸å…³ä¿¡æ¯</span><br><br><span class="hljs-comment"># ç¬¬2æ­¥ï¼Œæ‹‰å–Nginxé•œåƒ</span><br>docker pull nginx<br><br><span class="hljs-comment"># ç¬¬3æ­¥ï¼ŒæŸ¥çœ‹é•œåƒ</span><br>docker images<br><span class="hljs-comment"># ç»“æœå¦‚ä¸‹ï¼š</span><br>REPOSITORY   TAG       IMAGE ID       CREATED         SIZE<br>nginx        latest    605c77e624dd   16 months ago   141MB<br>mysql        latest    3218b38490ce   17 months ago   516MB<br><br><span class="hljs-comment"># ç¬¬4æ­¥ï¼Œåˆ›å»ºå¹¶å…è®¸Nginxå®¹å™¨</span><br>docker run -d --name nginx -p 80:80 nginx<br><br><span class="hljs-comment"># ç¬¬5æ­¥ï¼ŒæŸ¥çœ‹è¿è¡Œä¸­å®¹å™¨</span><br>docker ps<br><span class="hljs-comment"># ä¹Ÿå¯ä»¥åŠ æ ¼å¼åŒ–æ–¹å¼è®¿é—®ï¼Œæ ¼å¼ä¼šæ›´åŠ æ¸…çˆ½</span><br>docker ps --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># ç¬¬6æ­¥ï¼Œè®¿é—®ç½‘é¡µï¼Œåœ°å€ï¼šhttp://è™šæ‹Ÿæœºåœ°å€</span><br><br><span class="hljs-comment"># ç¬¬7æ­¥ï¼Œåœæ­¢å®¹å™¨</span><br>docker stop nginx<br><br><span class="hljs-comment"># ç¬¬8æ­¥ï¼ŒæŸ¥çœ‹æ‰€æœ‰å®¹å™¨</span><br>docker ps -a --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># ç¬¬9æ­¥ï¼Œå†æ¬¡å¯åŠ¨nginxå®¹å™¨</span><br>docker start nginx<br><br><span class="hljs-comment"># ç¬¬10æ­¥ï¼Œå†æ¬¡æŸ¥çœ‹å®¹å™¨</span><br>docker ps --format <span class="hljs-string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span><br><br><span class="hljs-comment"># ç¬¬11æ­¥ï¼ŒæŸ¥çœ‹å®¹å™¨è¯¦ç»†ä¿¡æ¯</span><br>docker inspect nginx<br><br><span class="hljs-comment"># ç¬¬12æ­¥ï¼Œè¿›å…¥å®¹å™¨,æŸ¥çœ‹å®¹å™¨å†…ç›®å½•</span><br>docker <span class="hljs-built_in">exec</span> -it nginx bash<br><span class="hljs-comment"># æˆ–è€…ï¼Œå¯ä»¥è¿›å…¥MySQL</span><br>docker <span class="hljs-built_in">exec</span> -it mysql mysql -uroot -p<br><br><span class="hljs-comment"># ç¬¬13æ­¥ï¼Œåˆ é™¤å®¹å™¨</span><br>docker <span class="hljs-built_in">rm</span> nginx<br><span class="hljs-comment"># å‘ç°æ— æ³•åˆ é™¤ï¼Œå› ä¸ºå®¹å™¨è¿è¡Œä¸­ï¼Œå¼ºåˆ¶åˆ é™¤å®¹å™¨</span><br>docker <span class="hljs-built_in">rm</span> -f nginx<br></code></pre></td></tr></table></figure>

<h3 id="2-3-å‘½ä»¤åˆ«å"><a href="#2-3-å‘½ä»¤åˆ«å" class="headerlink" title="2.3 å‘½ä»¤åˆ«å"></a>2.3 å‘½ä»¤åˆ«å</h3><p>ç»™å¸¸ç”¨Dockerå‘½ä»¤èµ·åˆ«åï¼Œæ–¹ä¾¿æˆ‘ä»¬è®¿é—®</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ä¿®æ”¹/root/.bashrcæ–‡ä»¶</span><br>vi /root/.bashrc<br>å†…å®¹å¦‚ä¸‹ï¼š<br><span class="hljs-comment"># .bashrc</span><br><br><span class="hljs-comment"># User specific aliases and functions</span><br><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">rm</span>=<span class="hljs-string">&#x27;rm -i&#x27;</span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">cp</span>=<span class="hljs-string">&#x27;cp -i&#x27;</span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">mv</span>=<span class="hljs-string">&#x27;mv -i&#x27;</span><br><span class="hljs-built_in">alias</span> dps=<span class="hljs-string">&#x27;docker ps --format &quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;&#x27;</span><br><span class="hljs-built_in">alias</span> dis=<span class="hljs-string">&#x27;docker images&#x27;</span><br><br><span class="hljs-comment"># Source global definitions</span><br><span class="hljs-keyword">if</span> [ -f /etc/bashrc ]; <span class="hljs-keyword">then</span><br>        . /etc/bashrc<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤ä½¿åˆ«åç”Ÿæ•ˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> /root/.bashrc<br></code></pre></td></tr></table></figure>

<h2 id="3-æ•°æ®å·"><a href="#3-æ•°æ®å·" class="headerlink" title="3. æ•°æ®å·"></a>3. æ•°æ®å·</h2><h3 id="3-1-æ•°æ®å·ä»‹ç»"><a href="#3-1-æ•°æ®å·ä»‹ç»" class="headerlink" title="3.1 æ•°æ®å·ä»‹ç»"></a>3.1 æ•°æ®å·ä»‹ç»</h3><p>å®¹å™¨æ˜¯éš”ç¦»ç¯å¢ƒï¼Œå®¹å™¨å†…ç¨‹åºçš„æ–‡ä»¶ã€é…ç½®ã€è¿è¡Œæ—¶äº§ç”Ÿçš„å®¹å™¨éƒ½åœ¨å®¹å™¨å†…éƒ¨ï¼Œæˆ‘ä»¬è¦è¯»å†™å®¹å™¨å†…çš„æ–‡ä»¶éå¸¸ä¸æ–¹ä¾¿ã€‚<br><strong>æ•°æ®å·ï¼ˆvolumeï¼‰æ˜¯ä¸€ä¸ªè™šæ‹Ÿç›®å½•ï¼Œæ˜¯å®¹å™¨å†…ç›®å½•ä¸å®¿ä¸»æœºç›®å½•ä¹‹é—´æ˜ å°„çš„æ¡¥æ¢</strong></p>
<p><img src="/img/blogs/java/springcloud/docker.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>æˆ‘ä»¬åˆ›å»ºäº†ä¸¤ä¸ªæ•°æ®å·ï¼šconfã€html</li>
<li>Nginxå®¹å™¨å†…éƒ¨çš„confç›®å½•å’Œhtmlç›®å½•åˆ†åˆ«ä¸ä¸¤ä¸ªæ•°æ®å·å…³è”ã€‚</li>
<li>è€Œæ•°æ®å·confå’Œhtmlåˆ†åˆ«æŒ‡å‘äº†å®¿ä¸»æœºçš„&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;conf&#x2F;_dataç›®å½•å’Œ&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;html&#x2F;_dataç›®å½•<br>è¿™æ ·ä»¥æ¥ï¼Œå®¹å™¨å†…çš„confå’Œhtmlç›®å½•å°± ä¸å®¿ä¸»æœºçš„confå’Œhtmlç›®å½•å…³è”èµ·æ¥ï¼Œæˆ‘ä»¬ç§°ä¸ºæŒ‚è½½ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬æ“ä½œå®¿ä¸»æœºçš„&#x2F;var&#x2F;lib&#x2F;docker&#x2F;volumes&#x2F;html&#x2F;_dataå°±æ˜¯åœ¨æ“ä½œå®¹å™¨å†…çš„&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;_dataç›®å½•ã€‚åªè¦æˆ‘ä»¬å°†é™æ€èµ„æºæ”¾å…¥å®¿ä¸»æœºå¯¹åº”ç›®å½•ï¼Œå°±å¯ä»¥è¢«Nginxä»£ç†äº†ã€‚</li>
</ul>
<h3 id="3-2-æ•°æ®å·å‘½ä»¤"><a href="#3-2-æ•°æ®å·å‘½ä»¤" class="headerlink" title="3.2 æ•°æ®å·å‘½ä»¤"></a>3.2 æ•°æ®å·å‘½ä»¤</h3><table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>docker volume create</td>
<td>åˆ›å»ºæ•°æ®å·</td>
</tr>
<tr>
<td>docker volume ls</td>
<td>æŸ¥çœ‹æ‰€æœ‰æ•°æ®å·</td>
</tr>
<tr>
<td>docker volume rm</td>
<td>åˆ é™¤æŒ‡å®šæ•°æ®å·</td>
</tr>
<tr>
<td>docker volume inspect</td>
<td>æŸ¥çœ‹æŸä¸ªæ•°æ®å·çš„è¯¦æƒ…</td>
</tr>
<tr>
<td>docker volume prune</td>
<td>æ¸…é™¤æ•°æ®å·</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.é¦–å…ˆåˆ›å»ºå®¹å™¨å¹¶æŒ‡å®šæ•°æ®å·ï¼Œæ³¨æ„é€šè¿‡ -v å‚æ•°æ¥æŒ‡å®šæ•°æ®å·</span><br>docker run -d --name nginx -p 80:80 -v html:/usr/share/nginx/html nginx<br><br><span class="hljs-comment"># 2.ç„¶åæŸ¥çœ‹æ•°æ®å·</span><br>docker volume <span class="hljs-built_in">ls</span><br><span class="hljs-comment"># ç»“æœ</span><br>DRIVER    VOLUME NAME<br><span class="hljs-built_in">local</span>     29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f<br><span class="hljs-built_in">local</span>     html<br><br><span class="hljs-comment"># 3.æŸ¥çœ‹æ•°æ®å·è¯¦æƒ…</span><br>docker volume inspect html<br><span class="hljs-comment"># ç»“æœ</span><br>[<br>    &#123;<br>        <span class="hljs-string">&quot;CreatedAt&quot;</span>: <span class="hljs-string">&quot;2024-05-17T19:57:08+08:00&quot;</span>,<br>        <span class="hljs-string">&quot;Driver&quot;</span>: <span class="hljs-string">&quot;local&quot;</span>,<br>        <span class="hljs-string">&quot;Labels&quot;</span>: null,<br>        <span class="hljs-string">&quot;Mountpoint&quot;</span>: <span class="hljs-string">&quot;/var/lib/docker/volumes/html/_data&quot;</span>,<br>        <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;html&quot;</span>,<br>        <span class="hljs-string">&quot;Options&quot;</span>: null,<br>        <span class="hljs-string">&quot;Scope&quot;</span>: <span class="hljs-string">&quot;local&quot;</span><br>    &#125;<br>]<br><br><span class="hljs-comment"># 4.æŸ¥çœ‹/var/lib/docker/volumes/html/_dataç›®å½•</span><br>ll /var/lib/docker/volumes/html/_data<br><span class="hljs-comment"># å¯ä»¥çœ‹åˆ°ä¸nginxçš„htmlç›®å½•å†…å®¹ä¸€æ ·ï¼Œç»“æœå¦‚ä¸‹ï¼š</span><br>æ€»ç”¨é‡ 8<br>-rw-r--r--. 1 root root 497 12æœˆ 28 2021 50x.html<br>-rw-r--r--. 1 root root 615 12æœˆ 28 2021 index.html<br><br><span class="hljs-comment"># 5.è¿›å…¥è¯¥ç›®å½•ï¼Œå¹¶éšæ„ä¿®æ”¹index.htmlå†…å®¹</span><br><span class="hljs-built_in">cd</span> /var/lib/docker/volumes/html/_data<br>vi index.html<br><br><span class="hljs-comment"># 6.æ‰“å¼€é¡µé¢ï¼ŒæŸ¥çœ‹æ•ˆæœ</span><br><br><span class="hljs-comment"># 7.è¿›å…¥å®¹å™¨å†…éƒ¨ï¼ŒæŸ¥çœ‹/usr/share/nginx/htmlç›®å½•å†…çš„æ–‡ä»¶æ˜¯å¦å˜åŒ–</span><br>docker <span class="hljs-built_in">exec</span> -it nginx bash<br></code></pre></td></tr></table></figure>

<h3 id="3-3-æŒ‚è½½æœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶"><a href="#3-3-æŒ‚è½½æœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶" class="headerlink" title="3.3 æŒ‚è½½æœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶"></a>3.3 æŒ‚è½½æœ¬åœ°ç›®å½•æˆ–æ–‡ä»¶</h3><p>æ•°æ®å·çš„ç›®å½•ç»“æ„è¾ƒæ·±ï¼Œå¦‚æœæˆ‘ä»¬å»æ“ä½œæ•°æ®å·ç›®å½•ä¼šä¸å¤ªæ–¹ä¾¿ã€‚åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šç›´æ¥å°†å®¹å™¨ç›®å½•ä¸å®¿ä¸»æœºæŒ‡å®šç›®å½•æŒ‚è½½ã€‚æŒ‚è½½è¯­æ³•ä¸æ•°æ®å·ç±»ä¼¼ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŒ‚è½½æœ¬åœ°ç›®å½•</span><br>-v æœ¬åœ°ç›®å½•:å®¹å™¨å†…ç›®å½•<br><span class="hljs-comment"># æŒ‚è½½æœ¬åœ°æ–‡ä»¶</span><br>-v æœ¬åœ°æ–‡ä»¶:å®¹å™¨å†…æ–‡ä»¶<br></code></pre></td></tr></table></figure>

<p>æ¼”ç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs bash"><br><span class="hljs-comment"># 1.åˆ é™¤åŸæ¥çš„MySQLå®¹å™¨</span><br>docker <span class="hljs-built_in">rm</span> -f mysql<br><br><span class="hljs-comment"># 2.è¿›å…¥rootç›®å½•</span><br><span class="hljs-built_in">cd</span> ~<br><br><span class="hljs-comment"># 3.åˆ›å»ºå¹¶è¿è¡Œæ–°mysqlå®¹å™¨ï¼ŒæŒ‚è½½æœ¬åœ°ç›®å½•</span><br>docker run -d \<br>  --name mysql \<br>  -p 3306:3306 \<br>  -e TZ=Asia/Shanghai \<br>  -e MYSQL_ROOT_PASSWORD=123 \<br>  -v ./mysql/data:/var/lib/mysql \<br>  -v ./mysql/conf:/etc/mysql/conf.d \<br>  -v ./mysql/init:/docker-entrypoint-initdb.d \<br>  mysql<br><br><span class="hljs-comment"># 4.æŸ¥çœ‹rootç›®å½•ï¼Œå¯ä»¥å‘ç°~/mysql/dataç›®å½•å·²ç»è‡ªåŠ¨åˆ›å»ºå¥½äº†</span><br><span class="hljs-built_in">ls</span> -l mysql<br><span class="hljs-comment"># ç»“æœï¼š</span><br>æ€»ç”¨é‡ 4<br>drwxr-xr-x. 2 root    root   20 5æœˆ  19 15:11 conf<br>drwxr-xr-x. 7 polkitd root 4096 5æœˆ  19 15:11 data<br>drwxr-xr-x. 2 root    root   23 5æœˆ  19 15:11 init<br><br><span class="hljs-comment"># æŸ¥çœ‹dataç›®å½•ï¼Œä¼šå‘ç°é‡Œé¢æœ‰å¤§é‡æ•°æ®åº“æ•°æ®ï¼Œè¯´æ˜æ•°æ®åº“å®Œæˆäº†åˆå§‹åŒ–</span><br><span class="hljs-built_in">ls</span> -l data<br><br><span class="hljs-comment"># 5.æŸ¥çœ‹MySQLå®¹å™¨å†…æ•°æ®</span><br><span class="hljs-comment"># 5.1.è¿›å…¥MySQL</span><br>docker <span class="hljs-built_in">exec</span> -it mysql mysql -uroot -p123<br><span class="hljs-comment"># 5.2.æŸ¥çœ‹ç¼–ç è¡¨</span><br>show variables like <span class="hljs-string">&quot;%char%&quot;</span>;<br><span class="hljs-comment"># 5.3.ç»“æœï¼Œå‘ç°ç¼–ç æ˜¯utf8mb4æ²¡æœ‰é—®é¢˜</span><br>+--------------------------+--------------------------------+<br>| Variable_name            | Value                          |<br>+--------------------------+--------------------------------+<br>| character_set_client     | utf8mb4                        |<br>| character_set_connection | utf8mb4                        |<br>| character_set_database   | utf8mb4                        |<br>| character_set_filesystem | binary                         |<br>| character_set_results    | utf8mb4                        |<br>| character_set_server     | utf8mb4                        |<br>| character_set_system     | utf8mb3                        |<br>| character_sets_dir       | /usr/share/mysql-8.0/charsets/ |<br>+--------------------------+--------------------------------+<br><br><span class="hljs-comment"># 6.æŸ¥çœ‹æ•°æ®</span><br><span class="hljs-comment"># 6.1.æŸ¥çœ‹æ•°æ®åº“</span><br>show databases;<br><span class="hljs-comment"># ç»“æœï¼Œhmallæ˜¯é»‘é©¬å•†åŸæ•°æ®åº“</span><br>+--------------------+<br>| Database           |<br>+--------------------+<br>| hmall              |<br>| information_schema |<br>| mysql              |<br>| performance_schema |<br>| sys                |<br>+--------------------+<br>5 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><span class="hljs-comment"># 6.2.åˆ‡æ¢åˆ°hmallæ•°æ®åº“</span><br>use hmall;<br><span class="hljs-comment"># 6.3.æŸ¥çœ‹è¡¨</span><br>show tables;<br><span class="hljs-comment"># ç»“æœï¼š</span><br>+-----------------+<br>| Tables_in_hmall |<br>+-----------------+<br>| address         |<br>| cart            |<br>| item            |<br>| order           |<br>| order_detail    |<br>| order_logistics |<br>| pay_order       |<br>| user            |<br>+-----------------+<br><span class="hljs-comment"># 6.4.æŸ¥çœ‹addressè¡¨æ•°æ®</span><br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>| <span class="hljs-built_in">id</span> | user_id | province | city   | town     | mobile      | street        | contact   | is_default | notes |<br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>| 59 |       1 | åŒ—äº¬     | åŒ—äº¬   | æœé˜³åŒº    | 13900112222 | é‡‘ç‡•é¾™åŠå…¬æ¥¼   | æä½³è¯š    | 0          | NULL  |<br>| 60 |       1 | åŒ—äº¬     | åŒ—äº¬   | æœé˜³åŒº    | 13700221122 | ä¿®æ­£å¤§å¦       | æä½³çº¢    | 0          | NULL  |<br>| 61 |       1 | ä¸Šæµ·     | ä¸Šæµ·   | æµ¦ä¸œæ–°åŒº  | 13301212233 | èˆªå¤´é•‡èˆªå¤´è·¯   | æä½³æ˜Ÿ    | 1          | NULL  |<br>| 63 |       1 | å¹¿ä¸œ     | ä½›å±±   | æ°¸æ˜¥      | 13301212233 | æ°¸æ˜¥æ­¦é¦†       | ææ™“é¾™    | 0          | NULL  |<br>+----+---------+----------+--------+----------+-------------+---------------+-----------+------------+-------+<br>4 rows <span class="hljs-keyword">in</span> <span class="hljs-built_in">set</span> (0.00 sec)<br><br></code></pre></td></tr></table></figure>

<h2 id="4-é•œåƒ"><a href="#4-é•œåƒ" class="headerlink" title="4. é•œåƒ"></a>4. é•œåƒ</h2><h3 id="4-1-æ„å»ºè‡ªå·±çš„é•œåƒ"><a href="#4-1-æ„å»ºè‡ªå·±çš„é•œåƒ" class="headerlink" title="4.1 æ„å»ºè‡ªå·±çš„é•œåƒ"></a>4.1 æ„å»ºè‡ªå·±çš„é•œåƒ</h3><p>æˆ‘ä»¬æ‰“åŒ…é•œåƒä¹Ÿæ˜¯åˆ†æˆè¿™ä¹ˆå‡ æ­¥ï¼š</p>
<ul>
<li>å‡†å¤‡Linuxè¿è¡Œç¯å¢ƒï¼ˆjavaé¡¹ç›®å¹¶ä¸éœ€è¦å®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œä»…ä»…æ˜¯åŸºç¡€è¿è¡Œç¯å¢ƒå³å¯ï¼‰</li>
<li>å®‰è£…å¹¶é…ç½®JDK</li>
<li>æ‹·è´jaråŒ…</li>
<li>é…ç½®å¯åŠ¨è„šæœ¬</li>
</ul>
<h3 id="4-2-Dockerfile"><a href="#4-2-Dockerfile" class="headerlink" title="4.2 Dockerfile"></a>4.2 Dockerfile</h3><table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>FROM</td>
<td>æŒ‡å®šåŸºç¡€é•œåƒ</td>
</tr>
<tr>
<td>ENV</td>
<td>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¯åœ¨åé¢æŒ‡ä»¤ä½¿ç”¨</td>
</tr>
<tr>
<td>COPY</td>
<td>æ‹·è´æœ¬åœ°æ–‡ä»¶åˆ°é•œåƒçš„æŒ‡å®šç›®å½•</td>
</tr>
<tr>
<td>RUN</td>
<td>æ‰§è¡Œ Linux çš„ shell å‘½ä»¤ï¼Œä¸€èˆ¬æ˜¯å®‰è£…è¿‡ç¨‹çš„å‘½ä»¤</td>
</tr>
<tr>
<td>EXPOSE</td>
<td>æŒ‡å®šå®¹å™¨è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£ï¼Œæ˜¯ç»™é•œåƒä½¿ç”¨è€…çœ‹çš„</td>
</tr>
<tr>
<td>ENTRYPOINT</td>
<td>é•œåƒä¸­åº”ç”¨çš„å¯åŠ¨å‘½ä»¤ï¼Œå®¹å™¨è¿è¡Œæ—¶è°ƒç”¨</td>
</tr>
</tbody></table>
<p>æœ‰äººæä¾›äº†åŸºç¡€çš„ç³»ç»ŸåŠ JDKç¯å¢ƒï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šåˆ¶ä½œjavaé•œåƒ:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># åŸºç¡€é•œåƒ</span><br>FROM openjdk:11.0-jre-buster<br><span class="hljs-comment"># è®¾å®šæ—¶åŒº</span><br>ENV TZ=Asia/Shanghai<br>RUN <span class="hljs-built_in">ln</span> -snf /usr/share/zoneinfo/<span class="hljs-variable">$TZ</span> /etc/localtime &amp;&amp; <span class="hljs-built_in">echo</span> <span class="hljs-variable">$TZ</span> &gt; /etc/timezone<br><span class="hljs-comment"># æ‹·è´jaråŒ…</span><br>COPY docker-demo.jar /app.jar<br><span class="hljs-comment"># å…¥å£</span><br>ENTRYPOINT [<span class="hljs-string">&quot;java&quot;</span>, <span class="hljs-string">&quot;-jar&quot;</span>, <span class="hljs-string">&quot;/app.jar&quot;</span>]<br></code></pre></td></tr></table></figure>

<h2 id="5-è‡ªå®šä¹‰ç½‘ç»œ"><a href="#5-è‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="5. è‡ªå®šä¹‰ç½‘ç»œ"></a>5. è‡ªå®šä¹‰ç½‘ç»œ</h2><p>å®¹å™¨çš„ç½‘ç»œIPå…¶å®æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„IPï¼Œå…¶å€¼<strong>å¹¶ä¸å›ºå®š</strong>ä¸æŸä¸€ä¸ªå®¹å™¨ç»‘å®š</p>
<ul>
<li>åœ¨è‡ªå®šä¹‰ç½‘ç»œä¸­ï¼Œå¯ä»¥ç»™å®¹å™¨èµ·å¤šä¸ªåˆ«åï¼Œé»˜è®¤çš„åˆ«åæ˜¯å®¹å™¨åæœ¬èº«</li>
<li>åœ¨åŒä¸€ä¸ªè‡ªå®šä¹‰ç½‘ç»œä¸­çš„å®¹å™¨ï¼Œå¯ä»¥é€šè¿‡åˆ«åäº’ç›¸è®¿é—®</li>
</ul>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>docker network create</td>
<td>åˆ›å»ºä¸€ä¸ªç½‘ç»œ</td>
</tr>
<tr>
<td>docker network ls</td>
<td>æŸ¥çœ‹æ‰€æœ‰ç½‘ç»œ</td>
</tr>
<tr>
<td>docker network rm</td>
<td>åˆ é™¤æŒ‡å®šç½‘ç»œ</td>
</tr>
<tr>
<td>docker network prune</td>
<td>æ¸…é™¤æœªä½¿ç”¨çš„ç½‘ç»œ</td>
</tr>
<tr>
<td>docker network connect</td>
<td>ä½¿æŒ‡å®šå®¹å™¨è¿æ¥åŠ å…¥æŸç½‘ç»œ</td>
</tr>
<tr>
<td>docker network disconnect</td>
<td>ä½¿æŒ‡å®šå®¹å™¨è¿æ¥ç¦»å¼€æŸç½‘ç»œ</td>
</tr>
<tr>
<td>docker network inspect</td>
<td>æŸ¥çœ‹ç½‘ç»œè¯¦ç»†ä¿¡æ¯</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1.é¦–å…ˆé€šè¿‡å‘½ä»¤åˆ›å»ºä¸€ä¸ªç½‘ç»œ</span><br>docker network create hmall<br><br><span class="hljs-comment"># 2.ç„¶åæŸ¥çœ‹ç½‘ç»œ</span><br>docker network <span class="hljs-built_in">ls</span><br><span class="hljs-comment"># ç»“æœï¼š</span><br>NETWORK ID     NAME      DRIVER    SCOPE<br>639bc44d0a87   bridge    bridge    <span class="hljs-built_in">local</span><br>403f16ec62a2   hmall     bridge    <span class="hljs-built_in">local</span><br>0dc0f72a0fbb   host      host      <span class="hljs-built_in">local</span><br>cd8d3e8df47b   none      null      <span class="hljs-built_in">local</span><br><span class="hljs-comment"># å…¶ä¸­ï¼Œé™¤äº†hmallä»¥å¤–ï¼Œå…¶å®ƒéƒ½æ˜¯é»˜è®¤çš„ç½‘ç»œ</span><br><br><span class="hljs-comment"># 3.è®©ddå’Œmysqléƒ½åŠ å…¥è¯¥ç½‘ç»œï¼Œæ³¨æ„ï¼Œåœ¨åŠ å…¥ç½‘ç»œæ—¶å¯ä»¥é€šè¿‡--aliasç»™å®¹å™¨èµ·åˆ«å</span><br><span class="hljs-comment"># è¿™æ ·è¯¥ç½‘ç»œå†…çš„å…¶å®ƒå®¹å™¨å¯ä»¥ç”¨åˆ«åäº’ç›¸è®¿é—®ï¼</span><br><span class="hljs-comment"># 3.1.mysqlå®¹å™¨ï¼ŒæŒ‡å®šåˆ«åä¸ºdbï¼Œå¦å¤–æ¯ä¸€ä¸ªå®¹å™¨éƒ½æœ‰ä¸€ä¸ªåˆ«åæ˜¯å®¹å™¨å</span><br>docker network connect hmall mysql --<span class="hljs-built_in">alias</span> db<br><span class="hljs-comment"># 3.2.dbå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„javaé¡¹ç›®</span><br>docker network connect hmall <span class="hljs-built_in">dd</span><br><br><span class="hljs-comment"># 4.è¿›å…¥ddå®¹å™¨ï¼Œå°è¯•åˆ©ç”¨åˆ«åè®¿é—®db</span><br><span class="hljs-comment"># 4.1.è¿›å…¥å®¹å™¨</span><br>docker <span class="hljs-built_in">exec</span> -it <span class="hljs-built_in">dd</span> bash<br><span class="hljs-comment"># 4.2.ç”¨dbåˆ«åè®¿é—®</span><br>ping db<br><span class="hljs-comment"># ç»“æœ</span><br>PING db (172.18.0.2) 56(84) bytes of data.<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=1 ttl=64 <span class="hljs-keyword">time</span>=0.070 ms<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=2 ttl=64 <span class="hljs-keyword">time</span>=0.056 ms<br><span class="hljs-comment"># 4.3.ç”¨å®¹å™¨åè®¿é—®</span><br>ping mysql<br><span class="hljs-comment"># ç»“æœï¼š</span><br>PING mysql (172.18.0.2) 56(84) bytes of data.<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=1 ttl=64 <span class="hljs-keyword">time</span>=0.044 ms<br>64 bytes from mysql.hmall (172.18.0.2): icmp_seq=2 ttl=64 <span class="hljs-keyword">time</span>=0.054 ms<br></code></pre></td></tr></table></figure>

<h2 id="6-DockerCompose"><a href="#6-DockerCompose" class="headerlink" title="6. DockerCompose"></a>6. DockerCompose</h2><p>Docker Composeå¯ä»¥å¸®åŠ©æˆ‘ä»¬<strong>å®ç°å¤šä¸ªç›¸äº’å…³è”çš„Dockerå®¹å™¨çš„å¿«é€Ÿéƒ¨ç½²</strong>ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ä¸€ä¸ªå•ç‹¬çš„ docker-compose.yml æ¨¡æ¿æ–‡ä»¶ï¼ˆYAML æ ¼å¼ï¼‰æ¥å®šä¹‰ä¸€ç»„ç›¸å…³è”çš„åº”ç”¨å®¹å™¨ã€‚</p>
<p>éƒ¨ç½²mysqlï¼Œå¯ä»¥ä½¿ç”¨docker-compose.ymlè¿›è¡Œéƒ¨ç½²</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.8&quot;</span><br><br><span class="hljs-attr">services:</span><br>  <span class="hljs-attr">mysql:</span><br>    <span class="hljs-attr">image:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">container_name:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">ports:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;3306:3306&quot;</span><br>    <span class="hljs-attr">environment:</span><br>      <span class="hljs-attr">TZ:</span> <span class="hljs-string">Asia/Shanghai</span><br>      <span class="hljs-attr">MYSQL_ROOT_PASSWORD:</span> <span class="hljs-number">123</span><br>    <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/conf:/etc/mysql/conf.d&quot;</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;./mysql/data:/var/lib/mysql&quot;</span><br>    <span class="hljs-attr">networks:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">new</span><br><span class="hljs-attr">networks:</span><br>  <span class="hljs-attr">new:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">hmall</span><br></code></pre></td></tr></table></figure>

<p>åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker compose [OPTIONS] [COMMAND]<br></code></pre></td></tr></table></figure>

<table>
  <thead>
    <tr>
      <th>ç±»å‹</th>
      <th>å‚æ•°æˆ–æŒ‡ä»¤</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2">Options</td>
      <td>-f</td>
      <td>æŒ‡å®š compose æ–‡ä»¶çš„è·¯å¾„å’Œåç§°</td>
    </tr>
    <tr>
      <td>-p</td>
      <td>æŒ‡å®š project åç§°ã€‚project å°±æ˜¯å½“å‰ compose æ–‡ä»¶ä¸­è®¾ç½®çš„å¤šä¸ª service çš„é›†åˆï¼Œæ˜¯é€»è¾‘æ¦‚å¿µ</td>
    </tr>
    <tr>
     <td rowspan="9">Commands</td>
      <td>up</td>
      <td>åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰ service å®¹å™¨</td>
    </tr>
    <tr>
      <td>down</td>
      <td>åœæ­¢å¹¶ç§»é™¤æ‰€æœ‰å®¹å™¨ã€ç½‘ç»œ</td>
    </tr>
    <tr>
      <td>ps</td>
      <td>åˆ—å‡ºæ‰€æœ‰å¯åŠ¨çš„å®¹å™¨</td>
    </tr>
    <tr>
      <td>logs</td>
      <td>æŸ¥çœ‹æŒ‡å®šå®¹å™¨çš„æ—¥å¿—</td>
    </tr>
    <tr>
      <td>stop</td>
      <td>åœæ­¢å®¹å™¨</td>
    </tr>
    <tr>
      <td>start</td>
      <td>å¯åŠ¨å®¹å™¨</td>
    </tr>
    <tr>
      <td>restart</td>
      <td>é‡å¯å®¹å™¨</td>
    </tr>
    <tr>
      <td>top</td>
      <td>æŸ¥çœ‹è¿è¡Œçš„è¿›ç¨‹</td>
    </tr>
    <tr>
      <td>exec</td>
      <td>åœ¨æŒ‡å®šçš„è¿è¡Œä¸­å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤</td>
    </tr>
  </tbody>
</table>

<h1 id="ä¸‰-å¾®æœåŠ¡"><a href="#ä¸‰-å¾®æœåŠ¡" class="headerlink" title="ä¸‰. å¾®æœåŠ¡"></a>ä¸‰. å¾®æœåŠ¡</h1><h2 id="1-è®¤è¯†å¾®æœåŠ¡"><a href="#1-è®¤è¯†å¾®æœåŠ¡" class="headerlink" title="1. è®¤è¯†å¾®æœåŠ¡"></a>1. è®¤è¯†å¾®æœåŠ¡</h2><h3 id="1-1-å•ä½“æ¶æ„"><a href="#1-1-å•ä½“æ¶æ„" class="headerlink" title="1.1.å•ä½“æ¶æ„"></a>1.1.å•ä½“æ¶æ„</h3><p>å•ä½“æ¶æ„ï¼ˆmonolithic structureï¼‰ï¼šé¡¾åæ€ä¹‰ï¼Œæ•´ä¸ªé¡¹ç›®ä¸­<strong>æ‰€æœ‰åŠŸèƒ½æ¨¡å—éƒ½åœ¨ä¸€ä¸ªå·¥ç¨‹ä¸­å¼€å‘</strong>ï¼›é¡¹ç›®éƒ¨ç½²æ—¶éœ€è¦<strong>å¯¹æ‰€æœ‰æ¨¡å—ä¸€èµ·ç¼–è¯‘ã€æ‰“åŒ…</strong>ï¼›é¡¹ç›®çš„æ¶æ„è®¾è®¡ã€å¼€å‘æ¨¡å¼éƒ½éå¸¸ç®€å•ã€‚</p>
<h3 id="1-2-å¾®æœåŠ¡"><a href="#1-2-å¾®æœåŠ¡" class="headerlink" title="1.2 å¾®æœåŠ¡"></a>1.2 å¾®æœåŠ¡</h3><p>å¾®æœåŠ¡æ¶æ„ï¼Œé¦–å…ˆæ˜¯æœåŠ¡åŒ–ï¼Œå°±æ˜¯<strong>å°†å•ä½“æ¶æ„ä¸­çš„åŠŸèƒ½æ¨¡å—ä»å•ä½“åº”ç”¨ä¸­æ‹†åˆ†å‡ºæ¥</strong>ï¼Œç‹¬ç«‹éƒ¨ç½²ä¸ºå¤šä¸ªæœåŠ¡ã€‚åŒæ—¶è¦æ»¡è¶³ä¸‹é¢çš„ä¸€äº›ç‰¹ç‚¹ï¼š</p>
<ul>
<li>å•ä¸€èŒè´£ï¼šä¸€ä¸ªå¾®æœåŠ¡è´Ÿè´£ä¸€éƒ¨åˆ†ä¸šåŠ¡åŠŸèƒ½ï¼Œå¹¶ä¸”å…¶æ ¸å¿ƒæ•°æ®ä¸ä¾èµ–äºå…¶å®ƒæ¨¡å—ã€‚</li>
<li>å›¢é˜Ÿè‡ªæ²»ï¼šæ¯ä¸ªå¾®æœåŠ¡éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å¼€å‘ã€æµ‹è¯•ã€å‘å¸ƒã€è¿ç»´äººå‘˜ï¼Œå›¢é˜Ÿäººå‘˜è§„æ¨¡ä¸è¶…è¿‡10äººï¼ˆ2å¼ æŠ«è¨èƒ½å–‚é¥±ï¼‰</li>
<li>æœåŠ¡è‡ªæ²»ï¼š<strong>æ¯ä¸ªå¾®æœåŠ¡éƒ½ç‹¬ç«‹æ‰“åŒ…éƒ¨ç½²ï¼Œè®¿é—®è‡ªå·±ç‹¬ç«‹çš„æ•°æ®åº“</strong>ã€‚å¹¶ä¸”è¦åšå¥½æœåŠ¡éš”ç¦»ï¼Œé¿å…å¯¹å…¶å®ƒæœåŠ¡äº§ç”Ÿå½±å“</li>
</ul>
<p><img src="/img/blogs/java/springcloud/3.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-3-SpringCloud"><a href="#1-3-SpringCloud" class="headerlink" title="1.3 SpringCloud"></a>1.3 SpringCloud</h3><p>SpringCloudæ¡†æ¶æ˜¯ç›®å‰Javaé¢†åŸŸæœ€å…¨é¢çš„å¾®æœåŠ¡ç»„ä»¶çš„é›†åˆ</p>
<h2 id="2-å¾®æœåŠ¡æ‹†åˆ†"><a href="#2-å¾®æœåŠ¡æ‹†åˆ†" class="headerlink" title="2. å¾®æœåŠ¡æ‹†åˆ†"></a>2. å¾®æœåŠ¡æ‹†åˆ†</h2><h3 id="2-1-å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™"><a href="#2-1-å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™" class="headerlink" title="2.1 å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™"></a>2.1 å¾®æœåŠ¡æ‹†åˆ†åŸåˆ™</h3><h4 id="2-1-1-ä»€ä¹ˆæ—¶å€™æ‹†"><a href="#2-1-1-ä»€ä¹ˆæ—¶å€™æ‹†" class="headerlink" title="2.1.1 ä»€ä¹ˆæ—¶å€™æ‹†"></a>2.1.1 ä»€ä¹ˆæ—¶å€™æ‹†</h4><ul>
<li>å¯¹äº<strong>å¤§å¤šæ•°å°å‹é¡¹ç›®æ¥è¯´ï¼Œä¸€èˆ¬æ˜¯å…ˆé‡‡ç”¨å•ä½“æ¶æ„</strong>ï¼Œéšç€ç”¨æˆ·è§„æ¨¡æ‰©å¤§ã€<strong>ä¸šåŠ¡å¤æ‚åå†é€æ¸æ‹†åˆ†ä¸ºå¾®æœåŠ¡æ¶æ„</strong>ã€‚è¿™æ ·åˆæœŸæˆæœ¬ä¼šæ¯”è¾ƒä½ï¼Œå¯ä»¥å¿«é€Ÿè¯•é”™ã€‚ä½†æ˜¯ï¼Œè¿™ä¹ˆåšçš„é—®é¢˜å°±åœ¨äºåæœŸåšæœåŠ¡æ‹†åˆ†æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°å¾ˆå¤šä»£ç è€¦åˆå¸¦æ¥çš„é—®é¢˜ï¼Œæ‹†åˆ†æ¯”è¾ƒå›°éš¾ï¼ˆ<strong>å‰æ˜“åéš¾</strong>ï¼‰ã€‚</li>
<li>è€Œ<strong>å¯¹äºä¸€äº›å¤§å‹é¡¹ç›®</strong>ï¼Œåœ¨ç«‹é¡¹ä¹‹åˆç›®çš„å°±å¾ˆæ˜ç¡®ï¼Œä¸ºäº†é•¿è¿œè€ƒè™‘ï¼Œåœ¨æ¶æ„è®¾è®¡æ—¶å°±<strong>ç›´æ¥é€‰æ‹©å¾®æœåŠ¡æ¶æ„</strong>ã€‚è™½ç„¶å‰æœŸæŠ•å…¥è¾ƒå¤šï¼Œä½†åæœŸå°±å°‘äº†æ‹†åˆ†æœåŠ¡çš„çƒ¦æ¼ï¼ˆ<strong>å‰éš¾åæ˜“</strong>ï¼‰ã€‚</li>
</ul>
<h4 id="2-1-2-æ€ä¹ˆæ‹†"><a href="#2-1-2-æ€ä¹ˆæ‹†" class="headerlink" title="2.1.2 æ€ä¹ˆæ‹†"></a>2.1.2 æ€ä¹ˆæ‹†</h4><ul>
<li>ç›®æ ‡ï¼šå¾®æœåŠ¡æ‹†åˆ†æ—¶ç²’åº¦è¦å°</li>
<li><strong>é«˜å†…èš</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„èŒè´£è¦å°½é‡å•ä¸€ï¼ŒåŒ…å«çš„ä¸šåŠ¡ç›¸äº’å…³è”åº¦é«˜ã€å®Œæ•´åº¦é«˜ã€‚</li>
<li><strong>ä½è€¦åˆ</strong>ï¼šæ¯ä¸ªå¾®æœåŠ¡çš„åŠŸèƒ½è¦ç›¸å¯¹ç‹¬ç«‹ï¼Œå°½é‡å‡å°‘å¯¹å…¶å®ƒå¾®æœåŠ¡çš„ä¾èµ–ï¼Œæˆ–è€…ä¾èµ–æ¥å£çš„ç¨³å®šæ€§è¦å¼ºã€‚</li>
</ul>
<p>æˆ‘ä»¬åœ¨åšæœåŠ¡æ‹†åˆ†æ—¶ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>çºµå‘æ‹†åˆ†ï¼š<strong>æŒ‰ç…§é¡¹ç›®çš„åŠŸèƒ½æ¨¡å—æ¥æ‹†åˆ†</strong>ã€‚ä¾‹å¦‚é»‘é©¬å•†åŸä¸­ï¼Œå°±æœ‰ç”¨æˆ·ç®¡ç†åŠŸèƒ½ã€è®¢å•ç®¡ç†åŠŸèƒ½ã€è´­ç‰©è½¦åŠŸèƒ½ã€å•†å“ç®¡ç†åŠŸèƒ½ã€æ”¯ä»˜åŠŸèƒ½ç­‰ã€‚é‚£ä¹ˆæŒ‰ç…§åŠŸèƒ½æ¨¡å—å°†ä»–ä»¬æ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªæœåŠ¡ï¼Œå°±å±äºçºµå‘æ‹†åˆ†ã€‚è¿™ç§æ‹†åˆ†æ¨¡å¼å¯ä»¥å°½å¯èƒ½æé«˜æœåŠ¡çš„å†…èšæ€§ã€‚</li>
<li>æ¨ªå‘æ‹†åˆ†ï¼šå„ä¸ªåŠŸèƒ½æ¨¡å—ä¹‹é—´æœ‰æ²¡æœ‰<strong>å…¬å…±çš„ä¸šåŠ¡éƒ¨åˆ†ï¼Œå¦‚æœæœ‰å°†å…¶æŠ½å–å‡ºæ¥ä½œä¸ºé€šç”¨æœåŠ¡</strong>ã€‚ä¾‹å¦‚ç”¨æˆ·ç™»å½•æ˜¯éœ€è¦å‘é€æ¶ˆæ¯é€šçŸ¥ï¼Œè®°å½•é£æ§æ•°æ®ï¼Œä¸‹å•æ—¶ä¹Ÿè¦å‘é€çŸ­ä¿¡ï¼Œè®°å½•é£æ§æ•°æ®ã€‚</li>
</ul>
<p>ä¸€èˆ¬å¾®æœåŠ¡é¡¹ç›®æœ‰ä¸¤ç§ä¸åŒçš„å·¥ç¨‹ç»“æ„ï¼š</p>
<ul>
<li>å®Œå…¨è§£è€¦ï¼šæ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½åˆ›å»ºä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥ç¨‹ï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨ä¸åŒçš„å¼€å‘è¯­è¨€æ¥å¼€å‘ï¼Œé¡¹ç›®å®Œå…¨è§£è€¦ã€‚<ul>
<li>ä¼˜ç‚¹ï¼šæœåŠ¡ä¹‹é—´è€¦åˆåº¦ä½</li>
<li>ç¼ºç‚¹ï¼šæ¯ä¸ªé¡¹ç›®éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹ä»“åº“ï¼Œç®¡ç†èµ·æ¥æ¯”è¾ƒéº»çƒ¦</li>
</ul>
</li>
<li>Mavenèšåˆï¼šæ•´ä¸ªé¡¹ç›®ä¸ºä¸€ä¸ªProjectï¼Œç„¶åæ¯ä¸ªå¾®æœåŠ¡æ˜¯å…¶ä¸­çš„ä¸€ä¸ªModule<ul>
<li>ä¼˜ç‚¹ï¼šé¡¹ç›®ä»£ç é›†ä¸­ï¼Œç®¡ç†å’Œè¿ç»´æ–¹ä¾¿</li>
<li>ç¼ºç‚¹ï¼šæœåŠ¡ä¹‹é—´è€¦åˆï¼Œç¼–è¯‘æ—¶é—´è¾ƒé•¿</li>
</ul>
</li>
</ul>
<h3 id="2-2-é»‘é©¬å•†åŸçš„æ‹†åˆ†"><a href="#2-2-é»‘é©¬å•†åŸçš„æ‹†åˆ†" class="headerlink" title="2.2 é»‘é©¬å•†åŸçš„æ‹†åˆ†"></a>2.2 é»‘é©¬å•†åŸçš„æ‹†åˆ†</h3><p><img src="/img/blogs/java/springcloud/3.2.1.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/springcloud/3.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/img/blogs/java/springcloud/3.2.3.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="3-æœåŠ¡æ³¨å†Œå’Œå‘ç°-ä¸-OpenFeign"><a href="#3-æœåŠ¡æ³¨å†Œå’Œå‘ç°-ä¸-OpenFeign" class="headerlink" title="3. æœåŠ¡æ³¨å†Œå’Œå‘ç° ä¸ OpenFeign"></a>3. æœåŠ¡æ³¨å†Œå’Œå‘ç° ä¸ OpenFeign</h2><h3 id="3-1-æ³¨å†Œä¸­å¿ƒåŸç†"><a href="#3-1-æ³¨å†Œä¸­å¿ƒåŸç†" class="headerlink" title="3.1 æ³¨å†Œä¸­å¿ƒåŸç†"></a>3.1 æ³¨å†Œä¸­å¿ƒåŸç†</h3><p>åœ¨å¾®æœåŠ¡<strong>è¿œç¨‹è°ƒç”¨</strong>çš„è¿‡ç¨‹ä¸­ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªè§’è‰²ï¼š</p>
<ul>
<li><strong>æœåŠ¡æä¾›è€…</strong>ï¼šæä¾›æ¥å£ä¾›å…¶å®ƒå¾®æœåŠ¡è®¿é—®ï¼Œæ¯”å¦‚item-service</li>
<li><strong>æœåŠ¡æ¶ˆè´¹è€…</strong>ï¼šè°ƒç”¨å…¶å®ƒå¾®æœåŠ¡æä¾›çš„æ¥å£ï¼Œæ¯”å¦‚cart-service</li>
</ul>
<p>åœ¨å¤§å‹å¾®æœåŠ¡é¡¹ç›®ä¸­ï¼ŒæœåŠ¡æä¾›è€…çš„æ•°é‡ä¼šéå¸¸å¤šï¼Œä¸ºäº†ç®¡ç†è¿™äº›æœåŠ¡å°±å¼•å…¥äº†æ³¨å†Œä¸­å¿ƒçš„æ¦‚å¿µã€‚æ³¨å†Œä¸­å¿ƒã€æœåŠ¡æä¾›è€…ã€æœåŠ¡æ¶ˆè´¹è€…ä¸‰è€…é—´å…³ç³»å¦‚ä¸‹ï¼š</p>
<p><img src="/img/blogs/java/springcloud/3.3.1.png" srcset="/img/loading.gif" lazyload></p>
<p>æµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li>æœåŠ¡å¯åŠ¨æ—¶å°±ä¼š<strong>æ³¨å†Œè‡ªå·±çš„æœåŠ¡ä¿¡æ¯</strong>ï¼ˆæœåŠ¡åã€IPã€ç«¯å£ï¼‰åˆ°æ³¨å†Œä¸­å¿ƒ</li>
<li>è°ƒç”¨è€…å¯ä»¥ä»æ³¨å†Œä¸­å¿ƒè®¢é˜…æƒ³è¦çš„æœåŠ¡ï¼Œè·å–æœåŠ¡å¯¹åº”çš„å®ä¾‹åˆ—è¡¨ï¼ˆ1ä¸ªæœåŠ¡å¯èƒ½å¤šå®ä¾‹éƒ¨ç½²ï¼‰</li>
<li>è°ƒç”¨è€…è‡ªå·±å¯¹å®ä¾‹åˆ—è¡¨è´Ÿè½½å‡è¡¡ï¼Œ<strong>æŒ‘é€‰ä¸€ä¸ªå®ä¾‹</strong></li>
<li>è°ƒç”¨è€…å‘è¯¥å®ä¾‹å‘èµ·è¿œç¨‹è°ƒç”¨</li>
</ol>
<h3 id="3-2-Nacosæ³¨å†Œä¸­å¿ƒ"><a href="#3-2-Nacosæ³¨å†Œä¸­å¿ƒ" class="headerlink" title="3.2 Nacosæ³¨å†Œä¸­å¿ƒ"></a>3.2 Nacosæ³¨å†Œä¸­å¿ƒ</h3><p>Nacos: Alibabaå…¬å¸å‡ºå“ï¼Œç›®å‰è¢«é›†æˆåœ¨SpringCloudAlibabaä¸­ï¼Œä¸€èˆ¬ç”¨äºJavaåº”ç”¨</p>
<h3 id="3-3-æœåŠ¡æ³¨å†Œ"><a href="#3-3-æœåŠ¡æ³¨å†Œ" class="headerlink" title="3.3 æœåŠ¡æ³¨å†Œ"></a>3.3 æœåŠ¡æ³¨å†Œ</h3><p>æŠŠé¡¹ç›®æ³¨å†Œåˆ°Nacos, æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¼•å…¥ä¾èµ–</li>
<li>é…ç½®Nacosåœ°å€</li>
<li>é‡å¯</li>
</ul>
<h4 id="3-3-1-æ·»åŠ ä¾èµ–"><a href="#3-3-1-æ·»åŠ ä¾èµ–" class="headerlink" title="3.3.1 æ·»åŠ ä¾èµ–"></a>3.3.1 æ·»åŠ ä¾èµ–</h4><p>pom.xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--nacos æœåŠ¡æ³¨å†Œå‘ç°--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-é…ç½®Nacos"><a href="#3-3-2-é…ç½®Nacos" class="headerlink" title="3.3.2 é…ç½®Nacos"></a>3.3.2 é…ç½®Nacos</h4><p>application.yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">item-service</span> <span class="hljs-comment"># æœåŠ¡åç§°</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># nacosåœ°å€</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-æœåŠ¡å‘ç°"><a href="#3-4-æœåŠ¡å‘ç°" class="headerlink" title="3.4 æœåŠ¡å‘ç°"></a>3.4 æœåŠ¡å‘ç°</h3><p>æœåŠ¡çš„æ¶ˆè´¹è€…è¦å»nacosè®¢é˜…æœåŠ¡ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±æ˜¯æœåŠ¡å‘ç°ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¼•å…¥ä¾èµ–</li>
<li>é…ç½®Nacosåœ°å€</li>
<li>å‘ç°å¹¶è°ƒç”¨æœåŠ¡</li>
</ul>
<h3 id="3-5-OpenFeign"><a href="#3-5-OpenFeign" class="headerlink" title="3.5 OpenFeign"></a>3.5 OpenFeign</h3><p>å…¶å®è¿œç¨‹è°ƒç”¨çš„å…³é”®ç‚¹å°±åœ¨äºå››ä¸ªï¼š</p>
<ul>
<li>è¯·æ±‚æ–¹å¼</li>
<li>è¯·æ±‚è·¯å¾„</li>
<li>è¯·æ±‚å‚æ•°</li>
<li>è¿”å›å€¼ç±»å‹<br>æ‰€ä»¥ï¼ŒOpenFeignå°±åˆ©ç”¨SpringMVCçš„ç›¸å…³æ³¨è§£æ¥å£°æ˜ä¸Šè¿°4ä¸ªå‚æ•°ï¼Œç„¶ååŸºäºåŠ¨æ€ä»£ç†å¸®æˆ‘ä»¬ç”Ÿæˆè¿œç¨‹è°ƒç”¨çš„ä»£ç ï¼Œè€Œæ— éœ€æˆ‘ä»¬æ‰‹åŠ¨å†ç¼–å†™ï¼Œéå¸¸æ–¹ä¾¿ã€‚</li>
</ul>
<h3 id="3-6-æŠ½å–å¾®æœåŠ¡"><a href="#3-6-æŠ½å–å¾®æœåŠ¡" class="headerlink" title="3.6 æŠ½å–å¾®æœåŠ¡"></a>3.6 æŠ½å–å¾®æœåŠ¡</h3><p>é¿å…é‡å¤ç¼–ç çš„åŠæ³•å°±æ˜¯æŠ½å–ã€‚è¿™é‡Œæœ‰ä¸¤ç§æŠ½å–æ€è·¯ï¼š</p>
<ul>
<li>æ€è·¯1ï¼šæŠ½å–åˆ°å¾®æœåŠ¡ä¹‹å¤–çš„å…¬å…±module</li>
<li>æ€è·¯2ï¼šæ¯ä¸ªå¾®æœåŠ¡è‡ªå·±æŠ½å–ä¸€ä¸ªmodule</li>
</ul>
<p><img src="/img/blogs/java/springcloud/3.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p>æ–¹æ¡ˆ1æŠ½å–æ›´åŠ ç®€å•ï¼Œå·¥ç¨‹ç»“æ„ä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œä½†ç¼ºç‚¹æ˜¯æ•´ä¸ªé¡¹ç›®è€¦åˆåº¦åé«˜ã€‚<br>æ–¹æ¡ˆ2æŠ½å–ç›¸å¯¹éº»çƒ¦ï¼Œå·¥ç¨‹ç»“æ„ç›¸å¯¹æ›´å¤æ‚ï¼Œä½†æœåŠ¡ä¹‹é—´è€¦åˆåº¦é™ä½ã€‚</p>
<h2 id="4-ç½‘å…³"><a href="#4-ç½‘å…³" class="headerlink" title="4. ç½‘å…³"></a>4. ç½‘å…³</h2><h3 id="4-1-è®¤è¯†ç½‘å…³"><a href="#4-1-è®¤è¯†ç½‘å…³" class="headerlink" title="4.1 è®¤è¯†ç½‘å…³"></a>4.1 è®¤è¯†ç½‘å…³</h3><p>ç½‘å…³å°±æ˜¯ç½‘ç»œçš„å…³å£ã€‚æ•°æ®åœ¨ç½‘ç»œé—´ä¼ è¾“ï¼Œä»ä¸€ä¸ªç½‘ç»œä¼ è¾“åˆ°å¦ä¸€ç½‘ç»œæ—¶å°±éœ€è¦ç»è¿‡<strong>ç½‘å…³æ¥åšæ•°æ®çš„è·¯ç”±å’Œè½¬å‘ä»¥åŠæ•°æ®å®‰å…¨çš„æ ¡éªŒã€‚</strong></p>
<p><img src="/img/blogs/java/springcloud/3.4.1.png" srcset="/img/loading.gif" lazyload></p>
<p>å‰ç«¯è¯·æ±‚ä¸èƒ½ç›´æ¥è®¿é—®å¾®æœåŠ¡ï¼Œè€Œæ˜¯è¦è¯·æ±‚ç½‘å…³ï¼š</p>
<ul>
<li>ç½‘å…³å¯ä»¥åšå®‰å…¨æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯<strong>ç™»å½•èº«ä»½æ ¡éªŒ</strong>ï¼Œæ ¡éªŒé€šè¿‡æ‰æ”¾è¡Œ</li>
<li>é€šè¿‡è®¤è¯åï¼Œç½‘å…³å†æ ¹æ®è¯·æ±‚åˆ¤æ–­åº”è¯¥è®¿é—®å“ªä¸ªå¾®æœåŠ¡ï¼Œå°†è¯·æ±‚è½¬å‘è¿‡å»</li>
</ul>
<h3 id="4-2-ç½‘å…³è·¯ç”±å¿«é€Ÿå…¥é—¨"><a href="#4-2-ç½‘å…³è·¯ç”±å¿«é€Ÿå…¥é—¨" class="headerlink" title="4.2 ç½‘å…³è·¯ç”±å¿«é€Ÿå…¥é—¨"></a>4.2 ç½‘å…³è·¯ç”±å¿«é€Ÿå…¥é—¨</h3><p>æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li>åˆ›å»ºç½‘å…³å¾®æœåŠ¡</li>
<li>å¼•å…¥SpringCloudGatewayã€NacosDiscoveryä¾èµ–</li>
<li>ç¼–å†™å¯åŠ¨ç±»</li>
<li>é…ç½®ç½‘å…³è·¯ç”±</li>
</ul>
<p>åœ¨hm-gatewayæ¨¡å—çš„resourcesç›®å½•æ–°å»ºä¸€ä¸ªapplication.yamlæ–‡ä»¶,é…ç½®ç½‘å…³è·¯ç”±ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">gateway</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span> <span class="hljs-comment"># è·¯ç”±è§„åˆ™idï¼Œè‡ªå®šä¹‰ï¼Œå”¯ä¸€</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span> <span class="hljs-comment"># è·¯ç”±çš„ç›®æ ‡æœåŠ¡ï¼Œlbä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä¼šä»æ³¨å†Œä¸­å¿ƒæ‹‰å–æœåŠ¡åˆ—è¡¨</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment"># è·¯ç”±æ–­è¨€ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯å¦ç¬¦åˆå½“å‰è§„åˆ™ï¼Œç¬¦åˆåˆ™è·¯ç”±åˆ°ç›®æ ‡æœåŠ¡</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**,/search/**</span> <span class="hljs-comment"># è¿™é‡Œæ˜¯ä»¥è¯·æ±‚è·¯å¾„ä½œä¸ºåˆ¤æ–­è§„åˆ™</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">cart</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://cart-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/carts/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">user</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://user-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/users/**,/addresses/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">trade</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://trade-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/orders/**</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">pay</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://pay-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/pay-orders/**</span><br></code></pre></td></tr></table></figure>

<h3 id="4-3-è·¯ç”±è¿‡æ»¤"><a href="#4-3-è·¯ç”±è¿‡æ»¤" class="headerlink" title="4.3 è·¯ç”±è¿‡æ»¤"></a>4.3 è·¯ç”±è¿‡æ»¤</h3><p>è·¯ç”±è§„åˆ™ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">item</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://item-service</span><br>          <span class="hljs-attr">predicates:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/items/**,/search/**</span><br></code></pre></td></tr></table></figure>

<p>å››ä¸ªå±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>idï¼šè·¯ç”±çš„å”¯ä¸€æ ‡ç¤º</li>
<li>predicatesï¼šè·¯ç”±æ–­è¨€ï¼Œå…¶å®å°±æ˜¯<strong>åŒ¹é…æ¡ä»¶</strong></li>
<li>filtersï¼š<strong>è·¯ç”±è¿‡æ»¤</strong>æ¡ä»¶</li>
<li>uriï¼š<strong>è·¯ç”±ç›®æ ‡åœ°å€</strong>ï¼Œlb:&#x2F;&#x2F;ä»£è¡¨è´Ÿè½½å‡è¡¡ï¼Œä»æ³¨å†Œä¸­å¿ƒè·å–ç›®æ ‡å¾®æœåŠ¡çš„å®ä¾‹åˆ—è¡¨ï¼Œå¹¶ä¸”è´Ÿè½½å‡è¡¡é€‰æ‹©ä¸€ä¸ªè®¿é—®ã€‚</li>
</ul>
<ul>
<li>predicatesï¼Œè·¯ç”±æ–­è¨€çš„ç±»å‹:</li>
</ul>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>After</td>
<td>æ˜¯æŸä¸ªæ—¶é—´ç‚¹åçš„è¯·æ±‚</td>
</tr>
<tr>
<td>Before</td>
<td>æ˜¯æŸä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
</tr>
<tr>
<td>Between</td>
<td>æ˜¯æŸä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹å‰çš„è¯·æ±‚</td>
</tr>
<tr>
<td>Cookie</td>
<td>è¯·æ±‚å¿…é¡»åŒ…å«æŸäº› cookie</td>
</tr>
<tr>
<td>Header</td>
<td>è¯·æ±‚å¿…é¡»åŒ…å«æŸäº› header</td>
</tr>
<tr>
<td>Host</td>
<td>è¯·æ±‚å¿…é¡»æ˜¯è®¿é—®æŸä¸ª hostï¼ˆåŸŸåï¼‰</td>
</tr>
<tr>
<td>Method</td>
<td>è¯·æ±‚æ–¹å¼å¿…é¡»æ˜¯æŒ‡å®šæ–¹å¼</td>
</tr>
<tr>
<td>Path</td>
<td>è¯·æ±‚è·¯å¾„å¿…é¡»ç¬¦åˆæŒ‡å®šè§„åˆ™</td>
</tr>
<tr>
<td>Query</td>
<td>è¯·æ±‚å‚æ•°å¿…é¡»åŒ…å«æŒ‡å®šå‚æ•°</td>
</tr>
<tr>
<td>RemoteAddr</td>
<td>è¯·æ±‚è€…çš„ IP å¿…é¡»æ˜¯æŒ‡å®šèŒƒå›´</td>
</tr>
<tr>
<td>weight</td>
<td>æƒé‡å¤„ç†</td>
</tr>
</tbody></table>
<h3 id="4-4-ç½‘å…³ç™»å½•æ ¡éªŒ"><a href="#4-4-ç½‘å…³ç™»å½•æ ¡éªŒ" class="headerlink" title="4.4 ç½‘å…³ç™»å½•æ ¡éªŒ"></a>4.4 ç½‘å…³ç™»å½•æ ¡éªŒ</h3><p>æ—¢ç„¶ç½‘å…³æ˜¯æ‰€æœ‰å¾®æœåŠ¡çš„å…¥å£ï¼Œä¸€åˆ‡è¯·æ±‚éƒ½éœ€è¦å…ˆç»è¿‡ç½‘å…³ã€‚æˆ‘ä»¬å®Œå…¨<strong>å¯ä»¥æŠŠç™»å½•æ ¡éªŒçš„å·¥ä½œæ”¾åˆ°ç½‘å…³å»åš</strong>ï¼Œè¿™æ ·ä¹‹å‰è¯´çš„é—®é¢˜å°±è§£å†³äº†ï¼š</p>
<ul>
<li>åªéœ€è¦<strong>åœ¨ç½‘å…³å’Œç”¨æˆ·æœåŠ¡ä¿å­˜ç§˜é’¥</strong></li>
<li>åªéœ€è¦<strong>åœ¨ç½‘å…³å¼€å‘ç™»å½•æ ¡éªŒåŠŸèƒ½</strong></li>
</ul>
<p><img src="/img/blogs/java/springcloud/4.4.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="4-4-1-ç½‘å…³è¿‡æ»¤å™¨"><a href="#4-4-1-ç½‘å…³è¿‡æ»¤å™¨" class="headerlink" title="4.4.1 ç½‘å…³è¿‡æ»¤å™¨"></a>4.4.1 ç½‘å…³è¿‡æ»¤å™¨</h4><p><img src="/img/blogs/java/springcloud/4.4.2.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>å®¢æˆ·ç«¯è¯·æ±‚è¿›å…¥ç½‘å…³åç”±HandlerMappingå¯¹è¯·æ±‚åšåˆ¤æ–­ï¼Œæ‰¾åˆ°ä¸å½“å‰è¯·æ±‚åŒ¹é…çš„è·¯ç”±è§„åˆ™ï¼ˆRouteï¼‰ï¼Œç„¶åå°†è¯·æ±‚äº¤ç»™WebHandlerå»å¤„ç†ã€‚</li>
<li>WebHandleråˆ™ä¼šåŠ è½½å½“å‰è·¯ç”±ä¸‹éœ€è¦æ‰§è¡Œçš„è¿‡æ»¤å™¨é“¾ï¼ˆFilter chainï¼‰ï¼Œç„¶åæŒ‰ç…§é¡ºåºé€ä¸€æ‰§è¡Œè¿‡æ»¤å™¨ï¼ˆåé¢ç§°ä¸ºFilterï¼‰ã€‚</li>
<li>å›¾ä¸­Filterè¢«è™šçº¿åˆ†ä¸ºå·¦å³ä¸¤éƒ¨åˆ†ï¼Œæ˜¯å› ä¸ºFilterå†…éƒ¨çš„é€»è¾‘åˆ†ä¸ºpreå’Œpostä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¼šåœ¨è¯·æ±‚è·¯ç”±åˆ°å¾®æœåŠ¡ä¹‹å‰å’Œä¹‹åè¢«æ‰§è¡Œã€‚</li>
<li>åªæœ‰æ‰€æœ‰Filterçš„preé€»è¾‘éƒ½ä¾æ¬¡é¡ºåºæ‰§è¡Œé€šè¿‡åï¼Œè¯·æ±‚æ‰ä¼šè¢«è·¯ç”±åˆ°å¾®æœåŠ¡ã€‚</li>
<li>å¾®æœåŠ¡è¿”å›ç»“æœåï¼Œå†å€’åºæ‰§è¡ŒFilterçš„posté€»è¾‘ã€‚</li>
<li>æœ€ç»ˆæŠŠå“åº”ç»“æœè¿”å›</li>
</ol>
<p>ç½‘å…³è¿‡æ»¤å™¨é“¾ä¸­çš„è¿‡æ»¤å™¨æœ‰ä¸¤ç§ï¼š</p>
<ul>
<li><strong>GatewayFilter</strong>ï¼š<strong>è·¯ç”±è¿‡æ»¤å™¨</strong>ï¼Œä½œç”¨èŒƒå›´æ¯”è¾ƒçµæ´»ï¼Œå¯ä»¥æ˜¯ä»»æ„æŒ‡å®šçš„è·¯ç”±Route. </li>
<li><strong>GlobalFilter</strong>ï¼š<strong>å…¨å±€è¿‡æ»¤å™¨</strong>ï¼Œä½œç”¨èŒƒå›´æ˜¯æ‰€æœ‰è·¯ç”±ï¼Œä¸å¯é…ç½®ã€‚</li>
</ul>
<h4 id="4-4-2-è‡ªå®šä¹‰è¿‡æ»¤å™¨"><a href="#4-4-2-è‡ªå®šä¹‰è¿‡æ»¤å™¨" class="headerlink" title="4.4.2 è‡ªå®šä¹‰è¿‡æ»¤å™¨"></a>4.4.2 è‡ªå®šä¹‰è¿‡æ»¤å™¨</h4><p>è‡ªå®šä¹‰GlobalFilteråˆ™ç®€å•å¾ˆå¤šï¼Œç›´æ¥å®ç°GlobalFilterå³å¯ï¼Œè€Œä¸”ä¹Ÿæ— æ³•è®¾ç½®åŠ¨æ€å‚æ•°ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrintAnyGlobalFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">GlobalFilter</span>, Ordered &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Mono&lt;Void&gt; <span class="hljs-title function_">filter</span><span class="hljs-params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> &#123;<br>        <span class="hljs-comment">// ç¼–å†™è¿‡æ»¤å™¨é€»è¾‘</span><br>        System.out.println(<span class="hljs-string">&quot;æœªç™»å½•ï¼Œæ— æ³•è®¿é—®&quot;</span>);<br>        <span class="hljs-comment">// æ”¾è¡Œ</span><br>        <span class="hljs-comment">// return chain.filter(exchange);</span><br><br>        <span class="hljs-comment">// æ‹¦æˆª</span><br>        <span class="hljs-type">ServerHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> exchange.getResponse();<br>        response.setRawStatusCode(<span class="hljs-number">401</span>);<br>        <span class="hljs-keyword">return</span> response.setComplete();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// è¿‡æ»¤å™¨æ‰§è¡Œé¡ºåºï¼Œå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-å¾®æœåŠ¡è·å–ç”¨æˆ·"><a href="#4-4-3-å¾®æœåŠ¡è·å–ç”¨æˆ·" class="headerlink" title="4.4.3 å¾®æœåŠ¡è·å–ç”¨æˆ·"></a>4.4.3 å¾®æœåŠ¡è·å–ç”¨æˆ·</h4><p>ç”±äºç½‘å…³å‘é€è¯·æ±‚åˆ°å¾®æœåŠ¡ä¾ç„¶é‡‡ç”¨çš„æ˜¯Httpè¯·æ±‚ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯ä»¥è¯·æ±‚å¤´çš„æ–¹å¼ä¼ é€’åˆ°ä¸‹æ¸¸å¾®æœåŠ¡ã€‚ç„¶åå¾®æœåŠ¡å¯ä»¥<strong>ä»è¯·æ±‚å¤´ä¸­è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯</strong>ã€‚è€ƒè™‘åˆ°å¾®æœåŠ¡å†…éƒ¨å¯èƒ½å¾ˆå¤šåœ°æ–¹éƒ½éœ€è¦ç”¨åˆ°ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ©ç”¨SpringMVCçš„æ‹¦æˆªå™¨æ¥å®ç°ç™»å½•ç”¨æˆ·ä¿¡æ¯è·å–ï¼Œå¹¶å­˜å…¥ThreadLocalï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.4.3.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>æ”¹é€ ç½‘å…³è¿‡æ»¤å™¨ï¼Œåœ¨è·å–ç”¨æˆ·ä¿¡æ¯åä¿å­˜åˆ°è¯·æ±‚å¤´ï¼Œè½¬å‘åˆ°ä¸‹æ¸¸å¾®æœåŠ¡</li>
<li>ç¼–å†™å¾®æœåŠ¡æ‹¦æˆªå™¨ï¼Œæ‹¦æˆªè¯·æ±‚è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¿å­˜åˆ°ThreadLocalåæ”¾è¡Œ</li>
</ul>
<h4 id="4-4-4-OpenFeignä¼ é€’ç”¨æˆ·"><a href="#4-4-4-OpenFeignä¼ é€’ç”¨æˆ·" class="headerlink" title="4.4.4 OpenFeignä¼ é€’ç”¨æˆ·"></a>4.4.4 OpenFeignä¼ é€’ç”¨æˆ·</h4><p>å‰ç«¯å‘èµ·çš„è¯·æ±‚éƒ½ä¼šç»è¿‡ç½‘å…³å†åˆ°å¾®æœåŠ¡ï¼Œç”±äºæˆ‘ä»¬ä¹‹å‰ç¼–å†™çš„è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨åŠŸèƒ½ï¼Œå¾®æœåŠ¡å¯ä»¥è½»æ¾è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ã€‚</p>
<p>ç”±äºå¾®æœåŠ¡è·å–ç”¨æˆ·ä¿¡æ¯æ˜¯é€šè¿‡æ‹¦æˆªå™¨åœ¨è¯·æ±‚å¤´ä¸­è¯»å–ï¼Œå› æ­¤è¦æƒ³å®ç°å¾®æœåŠ¡ä¹‹é—´çš„ç”¨æˆ·ä¿¡æ¯ä¼ é€’ï¼Œå°±å¿…é¡»åœ¨å¾®æœåŠ¡å‘èµ·è°ƒç”¨æ—¶æŠŠç”¨æˆ·ä¿¡æ¯å­˜å…¥è¯·æ±‚å¤´ã€‚</p>
<p>å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨æ˜¯åŸºäºOpenFeignæ¥å®ç°çš„ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±å‘é€çš„è¯·æ±‚ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½è®©æ¯ä¸€ä¸ªç”±OpenFeignå‘èµ·çš„è¯·æ±‚è‡ªåŠ¨æºå¸¦ç™»å½•ç”¨æˆ·ä¿¡æ¯å‘¢ï¼Ÿ<br>è¿™é‡Œè¦å€ŸåŠ©Feignä¸­æä¾›çš„ä¸€ä¸ªæ‹¦æˆªå™¨æ¥å£ï¼šfeign.RequestInterceptor</p>
<h2 id="5-é…ç½®ç®¡ç†"><a href="#5-é…ç½®ç®¡ç†" class="headerlink" title="5. é…ç½®ç®¡ç†"></a>5. é…ç½®ç®¡ç†</h2><p>Nacosä¸ä»…ä»…å…·å¤‡æ³¨å†Œä¸­å¿ƒåŠŸèƒ½ï¼Œä¹Ÿå…·å¤‡é…ç½®ç®¡ç†çš„åŠŸèƒ½</p>
<p><img src="/img/blogs/java/springcloud/4.5.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>å¾®æœåŠ¡å…±äº«çš„é…ç½®å¯ä»¥ç»Ÿä¸€äº¤ç»™Nacosä¿å­˜å’Œç®¡ç†</strong>ï¼Œåœ¨Nacosæ§åˆ¶å°ä¿®æ”¹é…ç½®åï¼ŒNacosä¼šå°†é…ç½®å˜æ›´æ¨é€ç»™ç›¸å…³çš„å¾®æœåŠ¡ï¼Œå¹¶ä¸”<strong>æ— éœ€é‡å¯å³å¯ç”Ÿæ•ˆ</strong>ï¼Œå®ç°<strong>é…ç½®çƒ­æ›´æ–°</strong>ã€‚<br>ç½‘å…³çš„è·¯ç”±åŒæ ·æ˜¯é…ç½®ï¼Œå› æ­¤åŒæ ·å¯ä»¥åŸºäºè¿™ä¸ªåŠŸèƒ½å®ç°åŠ¨æ€è·¯ç”±åŠŸèƒ½ï¼Œæ— éœ€é‡å¯ç½‘å…³å³å¯ä¿®æ”¹è·¯ç”±é…ç½®ã€‚</p>
<h3 id="5-1-é…ç½®å…±äº«"><a href="#5-1-é…ç½®å…±äº«" class="headerlink" title="5.1 é…ç½®å…±äº«"></a>5.1 é…ç½®å…±äº«</h3><p>æŠŠå¾®æœåŠ¡å…±äº«çš„é…ç½®æŠ½å–åˆ°Nacosä¸­ç»Ÿä¸€ç®¡ç†ï¼Œè¿™æ ·å°±ä¸éœ€è¦æ¯ä¸ªå¾®æœåŠ¡éƒ½é‡å¤é…ç½®äº†ã€‚åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<ul>
<li><strong>åœ¨Nacosä¸­æ·»åŠ å…±äº«é…ç½®</strong></li>
<li><strong>å¾®æœåŠ¡æ‹‰å–é…ç½®</strong></li>
</ul>
<p>SpringCloudåœ¨åˆå§‹åŒ–ä¸Šä¸‹æ–‡çš„æ—¶å€™ä¼šå…ˆè¯»å–ä¸€ä¸ªåä¸ºbootstrap.yaml(æˆ–è€…bootstrap.properties)çš„æ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬å°†nacosåœ°å€é…ç½®åˆ°bootstrap.yamlä¸­ï¼Œé‚£ä¹ˆåœ¨é¡¹ç›®å¼•å¯¼é˜¶æ®µå°±å¯ä»¥è¯»å–nacosä¸­çš„é…ç½®äº†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.5.2.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="5-2-åŠ¨æ€è·¯ç”±"><a href="#5-2-åŠ¨æ€è·¯ç”±" class="headerlink" title="5.2 åŠ¨æ€è·¯ç”±"></a>5.2 åŠ¨æ€è·¯ç”±</h3><p>å¦‚æœå¸Œæœ› Nacos æ¨é€é…ç½®å˜æ›´ï¼Œå¯ä»¥ä½¿ç”¨ Nacos åŠ¨æ€ç›‘å¬é…ç½®æ¥å£æ¥å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addListener</span><span class="hljs-params">(String dataId, String group, Listener listener)</span><br></code></pre></td></tr></table></figure>
<p>ç¤ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">serverAddr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;serverAddr&#125;&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">dataId</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;dataId&#125;&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;group&#125;&quot;</span>;<br><span class="hljs-comment">// 1.åˆ›å»ºConfigServiceï¼Œè¿æ¥Nacos</span><br><span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>properties.put(<span class="hljs-string">&quot;serverAddr&quot;</span>, serverAddr);<br><span class="hljs-type">ConfigService</span> <span class="hljs-variable">configService</span> <span class="hljs-operator">=</span> NacosFactory.createConfigService(properties);<br><span class="hljs-comment">// 2.è¯»å–é…ç½®</span><br><span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> configService.getConfig(dataId, group, <span class="hljs-number">5000</span>);<br><span class="hljs-comment">// 3.æ·»åŠ é…ç½®ç›‘å¬å™¨</span><br>configService.addListener(dataId, group, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Listener</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">receiveConfigInfo</span><span class="hljs-params">(String configInfo)</span> &#123;<br>        <span class="hljs-comment">// é…ç½®å˜æ›´çš„é€šçŸ¥å¤„ç†</span><br>                System.out.println(<span class="hljs-string">&quot;recieve1:&quot;</span> + configInfo);<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Executor <span class="hljs-title function_">getExecutor</span><span class="hljs-params">()</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>
<p>æ ¸å¿ƒçš„æ­¥éª¤æœ‰2æ­¥ï¼š</p>
<ul>
<li>åˆ›å»ºConfigServiceï¼Œç›®çš„æ˜¯è¿æ¥åˆ°Nacos</li>
<li>æ·»åŠ é…ç½®ç›‘å¬å™¨ï¼Œç¼–å†™é…ç½®å˜æ›´çš„é€šçŸ¥å¤„ç†é€»è¾‘</li>
</ul>
<h1 id="å››-æœåŠ¡ä¿æŠ¤å’Œåˆ†å¸ƒå¼äº‹åŠ¡"><a href="#å››-æœåŠ¡ä¿æŠ¤å’Œåˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="å››. æœåŠ¡ä¿æŠ¤å’Œåˆ†å¸ƒå¼äº‹åŠ¡"></a>å››. æœåŠ¡ä¿æŠ¤å’Œåˆ†å¸ƒå¼äº‹åŠ¡</h1><h2 id="1-é›ªå´©é—®é¢˜"><a href="#1-é›ªå´©é—®é¢˜" class="headerlink" title="1. é›ªå´©é—®é¢˜"></a>1. é›ªå´©é—®é¢˜</h2><p>é›ªå´©é—®é¢˜æŒ‡çš„æ˜¯<strong>æŸä¸ªæœåŠ¡ä¸å¯ç”¨æˆ–å“åº”å˜æ…¢ï¼Œå¯¼è‡´ä¾èµ–è¯¥æœåŠ¡çš„å…¶ä»–æœåŠ¡ä¹Ÿæ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¿›è€Œå¼•å‘è¿é”ååº”ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ</strong>ã€‚è¿™ç§ç°è±¡ç±»ä¼¼äºé›ªå´©ï¼Œç”±ä¸€ä¸ªå°é—®é¢˜é€æ­¥æ‰©æ•£ï¼Œæœ€ç»ˆå½±å“æ•´ä¸ªç³»ç»Ÿçš„ç¨³å®šæ€§ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.1.1.png" srcset="/img/loading.gif" lazyload></p>
<p>é›ªå´©é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼š</p>
<ul>
<li>å¾®æœåŠ¡ç›¸äº’è°ƒç”¨,<strong>æœåŠ¡æä¾›è€…å‡ºç°æ•…éšœæˆ–é˜»å¡</strong>ã€‚</li>
<li><strong>æœåŠ¡è°ƒç”¨è€…</strong>æ²¡æœ‰åšå¥½å¼‚å¸¸å¤„ç†,å¯¼è‡´<strong>è‡ªèº«æ•…éšœ</strong>ã€‚</li>
<li>è°ƒç”¨é“¾ä¸­çš„æ‰€æœ‰æœåŠ¡çº§è”å¤±è´¥,å¯¼è‡´æ•´ä¸ªé›†ç¾¤æ•…éšœ</li>
</ul>
<p>è§£å†³é—®é¢˜çš„æ€è·¯ï¼š</p>
<ul>
<li>å°½é‡é¿å…æœåŠ¡å‡ºç°æ•…éšœæˆ–é˜»å¡</li>
<li>ä¿è¯ä»£ç çš„å¥å£®æ€§</li>
<li>ä¿è¯ç½‘ç»œç•…é€š</li>
<li>èƒ½åº”å¯¹è¾ƒé«˜çš„å¹¶å‘è¯·æ±‚</li>
</ul>
<h2 id="2-å¾®æœåŠ¡ä¿æŠ¤"><a href="#2-å¾®æœåŠ¡ä¿æŠ¤" class="headerlink" title="2. å¾®æœåŠ¡ä¿æŠ¤"></a>2. å¾®æœåŠ¡ä¿æŠ¤</h2><h3 id="2-1-å¾®æœåŠ¡ä¿æŠ¤æ–¹æ¡ˆ"><a href="#2-1-å¾®æœåŠ¡ä¿æŠ¤æ–¹æ¡ˆ" class="headerlink" title="2.1 å¾®æœåŠ¡ä¿æŠ¤æ–¹æ¡ˆ"></a>2.1 å¾®æœåŠ¡ä¿æŠ¤æ–¹æ¡ˆ</h3><ul>
<li><strong>è¯·æ±‚é™æµ</strong></li>
<li><strong>çº¿ç¨‹éš”ç¦»</strong></li>
<li><strong>æœåŠ¡ç†”æ–­</strong></li>
</ul>
<h4 id="2-1-1-è¯·æ±‚é™æµ"><a href="#2-1-1-è¯·æ±‚é™æµ" class="headerlink" title="2.1.1 è¯·æ±‚é™æµ"></a>2.1.1 è¯·æ±‚é™æµ</h4><p>æœåŠ¡æ•…éšœæœ€é‡è¦åŸå› ï¼Œå°±æ˜¯<strong>å¹¶å‘å¤ªé«˜ï¼å› æ­¤è¯·æ±‚é™æµ</strong>ï¼Œå°±æ˜¯<strong>é™åˆ¶æˆ–æ§åˆ¶æ¥å£è®¿é—®çš„å¹¶å‘æµé‡</strong>ï¼Œé¿å…æœåŠ¡å› æµé‡æ¿€å¢è€Œå‡ºç°æ•…éšœã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.2.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-1-2-çº¿ç¨‹éš”ç¦»"><a href="#2-1-2-çº¿ç¨‹éš”ç¦»" class="headerlink" title="2.1.2 çº¿ç¨‹éš”ç¦»"></a>2.1.2 çº¿ç¨‹éš”ç¦»</h4><p>å½“ä¸€ä¸ªä¸šåŠ¡æ¥å£å“åº”æ—¶é—´é•¿ï¼Œè€Œä¸”å¹¶å‘é«˜æ—¶ï¼Œå°±å¯èƒ½è€—å°½æœåŠ¡å™¨çš„çº¿ç¨‹èµ„æºï¼Œå¯¼è‡´æœåŠ¡å†…çš„å…¶å®ƒæ¥å£å—åˆ°å½±å“ã€‚æ‰€ä»¥æˆ‘ä»¬å¿…é¡»æŠŠè¿™ç§å½±å“é™ä½ï¼Œæˆ–è€…ç¼©å‡å½±å“çš„èŒƒå›´ã€‚<br>ä¸ºäº†é¿å…æŸä¸ªæ¥å£æ•…éšœæˆ–å‹åŠ›è¿‡å¤§å¯¼è‡´æ•´ä¸ªæœåŠ¡ä¸å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥<strong>é™å®šæ¯ä¸ªæ¥å£å¯ä»¥ä½¿ç”¨çš„èµ„æºèŒƒå›´</strong>ï¼Œä¹Ÿå°±æ˜¯å°†å…¶â€œéš”ç¦»â€èµ·æ¥ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.2.2.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-1-3-æœåŠ¡ç†”æ–­"><a href="#2-1-3-æœåŠ¡ç†”æ–­" class="headerlink" title="2.1.3 æœåŠ¡ç†”æ–­"></a>2.1.3 æœåŠ¡ç†”æ–­</h4><p>ç»Ÿè®¡æœåŠ¡æä¾›æ–¹çš„<strong>å¼‚å¸¸æ¯”ä¾‹ï¼Œå½“æ¯”ä¾‹è¿‡é«˜</strong>è¡¨æ˜è¯¥æ¥å£ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡ï¼Œ<strong>åº”è¯¥æ‹’ç»è°ƒç”¨è¯¥æ¥å£</strong>ï¼Œè€Œæ˜¯ç›´æ¥èµ°é™çº§é€»è¾‘ã€‚<br>æœåŠ¡è°ƒç”¨å¤±è´¥åçš„å¤„ç†é€»è¾‘ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œ<strong>å¯ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥è¿”å›å‹å¥½æç¤ºæˆ–é»˜è®¤æ•°æ®</strong>ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.2.3.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-1-4-è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹æ¡ˆ"><a href="#2-1-4-è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹æ¡ˆ" class="headerlink" title="2.1.4 è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹æ¡ˆ"></a>2.1.4 è§£å†³é›ªå´©é—®é¢˜çš„å¸¸è§æ–¹æ¡ˆ</h4><ul>
<li>è¯·æ±‚é™æµ:<strong>é™åˆ¶æµé‡</strong>åœ¨æœåŠ¡å¯ä»¥å¤„ç†çš„èŒƒå›´,é¿å…å› çªå‘æµé‡è€Œæ•…éšœ</li>
<li>çº¿ç¨‹éš”ç¦»:<strong>æ§åˆ¶ä¸šåŠ¡å¯ç”¨çš„çº¿ç¨‹æ•°é‡</strong>,å°†æ•…éšœéš”ç¦»åœ¨ä¸€å®šèŒƒå›´</li>
<li>æœåŠ¡ç†”æ–­:<strong>å°†å¼‚å¸¸æ¯”ä¾‹è¿‡é«˜çš„æ¥å£æ–­å¼€</strong>,æ‹’ç»æ‰€æœ‰è¯·æ±‚,ç›´æ¥èµ°fallback</li>
<li>å¤±è´¥å¤„ç†:<strong>å®šä¹‰fallbacké€»è¾‘</strong>,è®©ä¸šåŠ¡å¤±è´¥æ—¶ä¸å†æŠ›å‡ºå¼‚å¸¸,è€Œæ˜¯<strong>è¿”å›é»˜è®¤æ•°æ®æˆ–å‹å¥½æç¤º</strong></li>
</ul>
<h3 id="2-2-Sentinel-å¾®æœåŠ¡ä¿æŠ¤æŠ€æœ¯"><a href="#2-2-Sentinel-å¾®æœåŠ¡ä¿æŠ¤æŠ€æœ¯" class="headerlink" title="2.2 Sentinel(å¾®æœåŠ¡ä¿æŠ¤æŠ€æœ¯)"></a>2.2 Sentinel(å¾®æœåŠ¡ä¿æŠ¤æŠ€æœ¯)</h3><h4 id="2-2-1-Sentinelä¸‹è½½å®‰è£…å’Œè¿è¡Œ"><a href="#2-2-1-Sentinelä¸‹è½½å®‰è£…å’Œè¿è¡Œ" class="headerlink" title="2.2.1 Sentinelä¸‹è½½å®‰è£…å’Œè¿è¡Œ"></a>2.2.1 Sentinelä¸‹è½½å®‰è£…å’Œè¿è¡Œ</h4><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/">sentinelå®˜ç½‘</a></p>
<p>åœ¨ç›®å½•æ–‡ä»¶å¤¹ä¸­cmdæ‰“å¼€æ§åˆ¶å°è¿è¡Œï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">java -Dserver.port=8090 -Dcsp.sentinel.dashboard.server=localhost:8090 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard.jar<br></code></pre></td></tr></table></figure>

<p>è®¿é—®<code>http://localhost:8090</code>é¡µé¢ï¼Œå°±å¯ä»¥çœ‹åˆ°sentinelçš„æ§åˆ¶å°äº†</p>
<h4 id="2-2-2-è¯·æ±‚é™æµ"><a href="#2-2-2-è¯·æ±‚é™æµ" class="headerlink" title="2.2.2 è¯·æ±‚é™æµ"></a>2.2.2 è¯·æ±‚é™æµ</h4><p>åœ¨sentinelé…ç½®ï¼š</p>
<p><img src="/img/blogs/java/springcloud/4.2.4.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-2-3-çº¿ç¨‹éš”ç¦»"><a href="#2-2-3-çº¿ç¨‹éš”ç¦»" class="headerlink" title="2.2.3 çº¿ç¨‹éš”ç¦»"></a>2.2.3 çº¿ç¨‹éš”ç¦»</h4><p><strong>ä¿®æ”¹tomcatè¿æ¥</strong>ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">server:</span><br>  <span class="hljs-attr">port:</span> <span class="hljs-number">8082</span><br>  <span class="hljs-attr">tomcat:</span><br>    <span class="hljs-attr">threads:</span><br>      <span class="hljs-attr">max:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°</span><br>    <span class="hljs-attr">accept-count:</span> <span class="hljs-number">50</span> <span class="hljs-comment"># æœ€å¤§æ’é˜Ÿç­‰å¾…æ•°é‡</span><br>    <span class="hljs-attr">max-connections:</span> <span class="hljs-number">100</span> <span class="hljs-comment"># å…è®¸çš„æœ€å¤§è¿æ¥</span><br></code></pre></td></tr></table></figure>

<p><img src="/img/blogs/java/springcloud/4.2.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="2-2-4-æœåŠ¡ç†”æ–­"><a href="#2-2-4-æœåŠ¡ç†”æ–­" class="headerlink" title="2.2.4 æœåŠ¡ç†”æ–­"></a>2.2.4 æœåŠ¡ç†”æ–­</h4><h5 id="2-2-4-1-Fallback"><a href="#2-2-4-1-Fallback" class="headerlink" title="2.2.4.1 Fallback"></a>2.2.4.1 Fallback</h5><p>è¶…å‡ºçš„QPSä¸Šé™çš„è¯·æ±‚å°±åªèƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œå¯¼è‡´è´­ç‰©è½¦çš„æŸ¥è¯¢å¤±è´¥ã€‚ä½†ä»ä¸šåŠ¡è§’åº¦æ¥è¯´ï¼Œå³ä¾¿æ²¡æœ‰æŸ¥è¯¢åˆ°æœ€æ–°çš„å•†å“ä¿¡æ¯ï¼Œè´­ç‰©è½¦ä¹Ÿåº”è¯¥å±•ç¤ºç»™ç”¨æˆ·ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½ã€‚ä¹Ÿå°±æ˜¯ç»™æŸ¥è¯¢å¤±è´¥è®¾ç½®ä¸€ä¸ªé™çº§å¤„ç†é€»è¾‘ã€‚<br>è§¦å‘é™æµæˆ–ç†”æ–­åçš„è¯·æ±‚<strong>ä¸ä¸€å®šè¦ç›´æ¥æŠ¥é”™ï¼Œä¹Ÿå¯ä»¥è¿”å›ä¸€äº›é»˜è®¤æ•°æ®æˆ–è€…å‹å¥½æç¤º</strong>ï¼Œç”¨æˆ·ä½“éªŒä¼šæ›´å¥½ã€‚</p>
<ul>
<li>å®šä¹‰é™çº§å¤„ç†ç±»ï¼Œå®ç°FallbackFactory:</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemClientFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FallbackFactory</span>&lt;ItemClient&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> ItemClient <span class="hljs-title function_">create</span><span class="hljs-params">(Throwable cause)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ItemClient</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> List&lt;ItemDTO&gt; <span class="hljs-title function_">queryItemByIds</span><span class="hljs-params">(Collection&lt;Long&gt; ids)</span> &#123;<br>                log.error(<span class="hljs-string">&quot;è¿œç¨‹è°ƒç”¨ItemClient#queryItemByIdsæ–¹æ³•å‡ºç°å¼‚å¸¸ï¼Œå‚æ•°ï¼š&#123;&#125;&quot;</span>, ids, cause);<br>                <span class="hljs-comment">// æŸ¥è¯¢è´­ç‰©è½¦å…è®¸å¤±è´¥ï¼ŒæŸ¥è¯¢å¤±è´¥ï¼Œè¿”å›ç©ºé›†åˆ</span><br>                <span class="hljs-keyword">return</span> CollUtils.emptyList();<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deductStock</span><span class="hljs-params">(List&lt;OrderDetailDTO&gt; items)</span> &#123;<br>                <span class="hljs-comment">// åº“å­˜æ‰£å‡ä¸šåŠ¡éœ€è¦è§¦å‘äº‹åŠ¡å›æ»šï¼ŒæŸ¥è¯¢å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BizIllegalException</span>(cause);<br>            &#125;<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="2-2-4-2-æœåŠ¡ç†”æ–­"><a href="#2-2-4-2-æœåŠ¡ç†”æ–­" class="headerlink" title="2.2.4.2 æœåŠ¡ç†”æ–­"></a>2.2.4.2 æœåŠ¡ç†”æ–­</h5><p>Sentinelä¸­çš„æ–­è·¯å™¨ä¸ä»…å¯ä»¥ç»Ÿè®¡æŸä¸ªæ¥å£çš„<strong>æ…¢è¯·æ±‚æ¯”ä¾‹</strong>ï¼Œè¿˜å¯ä»¥ç»Ÿè®¡<strong>å¼‚å¸¸è¯·æ±‚æ¯”ä¾‹</strong>ã€‚å½“è¿™äº›æ¯”ä¾‹è¶…å‡ºé˜ˆå€¼æ—¶ï¼Œå°±ä¼šç†”æ–­è¯¥æ¥å£ï¼Œå³<strong>æ‹¦æˆªè®¿é—®è¯¥æ¥å£çš„ä¸€åˆ‡è¯·æ±‚</strong>ï¼Œé™çº§å¤„ç†ï¼›å½“è¯¥æ¥å£<strong>æ¢å¤æ­£å¸¸æ—¶ï¼Œå†æ”¾è¡Œ</strong>å¯¹äºè¯¥æ¥å£çš„è¯·æ±‚ã€‚<br>æ–­è·¯å™¨çš„å·¥ä½œçŠ¶æ€åˆ‡æ¢æœ‰ä¸€ä¸ªçŠ¶æ€æœºæ¥æ§åˆ¶ï¼š</p>
<p><img src="/img/blogs/java/springcloud/4.2.6.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>closedï¼š<strong>å…³é—­çŠ¶æ€ï¼Œæ–­è·¯å™¨æ”¾è¡Œæ‰€æœ‰è¯·æ±‚</strong>ï¼Œå¹¶å¼€å§‹ç»Ÿè®¡å¼‚å¸¸æ¯”ä¾‹ã€æ…¢è¯·æ±‚æ¯”ä¾‹ã€‚è¶…è¿‡é˜ˆå€¼åˆ™åˆ‡æ¢åˆ°opençŠ¶æ€</li>
<li>openï¼š<strong>æ‰“å¼€çŠ¶æ€ï¼ŒæœåŠ¡è°ƒç”¨è¢«ç†”æ–­</strong>ï¼Œè®¿é—®è¢«ç†”æ–­æœåŠ¡çš„è¯·æ±‚ä¼šè¢«æ‹’ç»ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œç›´æ¥èµ°é™çº§é€»è¾‘ã€‚OpençŠ¶æ€æŒç»­ä¸€æ®µæ—¶é—´åä¼šè¿›å…¥half-opençŠ¶æ€</li>
<li>half-openï¼š<strong>åŠå¼€çŠ¶æ€ï¼Œæ”¾è¡Œä¸€æ¬¡è¯·æ±‚</strong>ï¼Œæ ¹æ®æ‰§è¡Œç»“æœæ¥åˆ¤æ–­æ¥ä¸‹æ¥çš„æ“ä½œã€‚ <ul>
<li>è¯·æ±‚æˆåŠŸï¼šåˆ™åˆ‡æ¢åˆ°closedçŠ¶æ€</li>
<li>è¯·æ±‚å¤±è´¥ï¼šåˆ™åˆ‡æ¢åˆ°opençŠ¶æ€</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/springcloud/4.2.7.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="3-åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#3-åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="3. åˆ†å¸ƒå¼äº‹åŠ¡"></a>3. åˆ†å¸ƒå¼äº‹åŠ¡</h2><p><strong>æ¯ä¸ªå¾®æœåŠ¡çš„æœ¬åœ°äº‹åŠ¡ï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºåˆ†æ”¯äº‹åŠ¡</strong>ã€‚<strong>å¤šä¸ªæœ‰å…³è”çš„åˆ†æ”¯äº‹åŠ¡ä¸€èµ·å°±ç»„æˆäº†å…¨å±€äº‹åŠ¡</strong>ã€‚æˆ‘ä»¬å¿…é¡»ä¿è¯æ•´ä¸ªå…¨å±€äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–å¤±è´¥ã€‚æ»¡è¶³ACIDç‰¹æ€§ã€‚</p>
<h3 id="3-1-Seata"><a href="#3-1-Seata" class="headerlink" title="3.1 Seata"></a>3.1 Seata</h3><p>Seataæ˜¯é˜¿é‡Œå·´å·´çš„å¼€æºåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶<br>è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•æ˜¯<strong>æ‰¾ä¸€ä¸ªç»Ÿä¸€çš„äº‹åŠ¡åè°ƒè€…ï¼Œä¸å¤šä¸ªåˆ†æ”¯äº‹åŠ¡é€šä¿¡ï¼Œæ£€æµ‹æ¯ä¸ªåˆ†æ”¯äº‹åŠ¡çš„æ‰§è¡ŒçŠ¶æ€</strong>ï¼Œ<strong>ä¿è¯å…¨å±€äº‹åŠ¡ä¸‹çš„æ¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡åŒæ—¶æˆåŠŸæˆ–å¤±è´¥</strong>å³å¯ã€‚</p>
<p>åœ¨Seataçš„äº‹åŠ¡ç®¡ç†ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„è§’è‰²ï¼š</p>
<ul>
<li><strong>TC</strong> (Transaction Coordinator) - <strong>äº‹åŠ¡åè°ƒè€…</strong>ï¼š<strong>ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€</strong>ï¼Œåè°ƒ<strong>å…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»š</strong>ã€‚ </li>
<li><strong>TM</strong> (Transaction Manager) - <strong>äº‹åŠ¡ç®¡ç†å™¨</strong>ï¼š<strong>å®šä¹‰å…¨å±€äº‹åŠ¡çš„èŒƒå›´</strong>ã€å¼€å§‹å…¨å±€äº‹åŠ¡ã€æäº¤æˆ–å›æ»šå…¨å±€äº‹åŠ¡ã€‚ </li>
<li><strong>RM</strong> (Resource Manager) - <strong>èµ„æºç®¡ç†å™¨</strong>ï¼š<strong>ç®¡ç†åˆ†æ”¯äº‹åŠ¡</strong>ï¼Œä¸TCäº¤è°ˆä»¥æ³¨å†Œåˆ†æ”¯äº‹åŠ¡å’ŒæŠ¥å‘Šåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶<strong>é©±åŠ¨åˆ†æ”¯äº‹åŠ¡æäº¤æˆ–å›æ»š</strong>ã€‚</li>
</ul>
<p><img src="/img/blogs/java/springcloud/4.3.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li><strong>TCæœåŠ¡åˆ™æ˜¯äº‹åŠ¡åè°ƒä¸­å¿ƒï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¾®æœåŠ¡ï¼Œéœ€è¦å•ç‹¬éƒ¨ç½²</strong></li>
<li>TMå’ŒRMå°±ä¼šååŠ©å¾®æœåŠ¡ï¼Œ<strong>å®ç°æœ¬åœ°åˆ†æ”¯äº‹åŠ¡ä¸TCä¹‹é—´äº¤äº’</strong>ï¼Œå®ç°äº‹åŠ¡çš„æäº¤æˆ–å›æ»šã€‚</li>
</ul>
<h3 id="3-2-éƒ¨ç½²TCæœåŠ¡"><a href="#3-2-éƒ¨ç½²TCæœåŠ¡" class="headerlink" title="3.2 éƒ¨ç½²TCæœåŠ¡"></a>3.2 éƒ¨ç½²TCæœåŠ¡</h3><p>ç»´æŠ¤å…¨å±€å’Œåˆ†æ”¯äº‹åŠ¡çš„çŠ¶æ€ï¼Œåè°ƒå…¨å±€äº‹åŠ¡æäº¤æˆ–å›æ»šã€‚ </p>
<h3 id="3-3-å¾®æœåŠ¡é›†æˆSeata"><a href="#3-3-å¾®æœåŠ¡é›†æˆSeata" class="headerlink" title="3.3 å¾®æœåŠ¡é›†æˆSeata"></a>3.3 å¾®æœåŠ¡é›†æˆSeata</h3><h4 id="3-3-1-å¼•å…¥ä¾èµ–"><a href="#3-3-1-å¼•å…¥ä¾èµ–" class="headerlink" title="3.3.1 å¼•å…¥ä¾èµ–"></a>3.3.1 å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--ç»Ÿä¸€é…ç½®ç®¡ç†--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--è¯»å–bootstrapæ–‡ä»¶--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-comment">&lt;!--seata--&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-3-2-é…ç½®seata"><a href="#3-3-2-é…ç½®seata" class="headerlink" title="3.3.2 é…ç½®seata"></a>3.3.2 é…ç½®seata</h4><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">registry:</span> <span class="hljs-comment"># TCæœåŠ¡æ³¨å†Œä¸­å¿ƒçš„é…ç½®ï¼Œå¾®æœåŠ¡æ ¹æ®è¿™äº›ä¿¡æ¯å»æ³¨å†Œä¸­å¿ƒè·å–tcæœåŠ¡åœ°å€</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span> <span class="hljs-comment"># æ³¨å†Œä¸­å¿ƒç±»å‹ nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span><span class="hljs-string">:8848</span> <span class="hljs-comment"># nacosåœ°å€</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;&quot;</span> <span class="hljs-comment"># namespaceï¼Œé»˜è®¤ä¸ºç©º</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">DEFAULT_GROUP</span> <span class="hljs-comment"># åˆ†ç»„ï¼Œé»˜è®¤æ˜¯DEFAULT_GROUP</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span> <span class="hljs-comment"># seataæœåŠ¡åç§°</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">hmall</span> <span class="hljs-comment"># äº‹åŠ¡ç»„åç§°</span><br>  <span class="hljs-attr">service:</span><br>    <span class="hljs-attr">vgroup-mapping:</span> <span class="hljs-comment"># äº‹åŠ¡ç»„ä¸tcé›†ç¾¤çš„æ˜ å°„å…³ç³»</span><br>      <span class="hljs-attr">hmall:</span> <span class="hljs-string">&quot;default&quot;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-4-XAæ¨¡å¼"><a href="#3-4-XAæ¨¡å¼" class="headerlink" title="3.4 XAæ¨¡å¼"></a>3.4 XAæ¨¡å¼</h3><p>Seataæ”¯æŒ<strong>å››ç§ä¸åŒçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>XA</li>
<li>TCC</li>
<li>AT</li>
<li>SAGA</li>
</ul>
<p><img src="/img/blogs/java/springcloud/4.3.2.png" srcset="/img/loading.gif" lazyload></p>
<p>RMä¸€é˜¶æ®µçš„å·¥ä½œï¼š</p>
<ol>
<li>æ³¨å†Œåˆ†æ”¯äº‹åŠ¡åˆ°TC</li>
<li>æ‰§è¡Œåˆ†æ”¯ä¸šåŠ¡sqlä½†ä¸æäº¤</li>
<li>æŠ¥å‘Šæ‰§è¡ŒçŠ¶æ€åˆ°TC</li>
</ol>
<p>TCäºŒé˜¶æ®µçš„å·¥ä½œï¼š</p>
<ul>
<li>TCæ£€æµ‹å„åˆ†æ”¯äº‹åŠ¡æ‰§è¡ŒçŠ¶æ€<ol>
<li>å¦‚æœéƒ½æˆåŠŸï¼Œé€šçŸ¥æ‰€æœ‰RMæäº¤äº‹åŠ¡</li>
<li>å¦‚æœæœ‰å¤±è´¥ï¼Œé€šçŸ¥æ‰€æœ‰RMå›æ»šäº‹åŠ¡</li>
</ol>
</li>
</ul>
<p>RMäºŒé˜¶æ®µçš„å·¥ä½œï¼š</p>
<ul>
<li>æ¥æ”¶TCæŒ‡ä»¤ï¼Œæäº¤æˆ–å›æ»šäº‹åŠ¡</li>
</ul>
<p><strong>ä¼˜ç¼ºç‚¹</strong><br>XAæ¨¡å¼çš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>äº‹åŠ¡çš„<strong>å¼ºä¸€è‡´æ€§</strong>ï¼Œæ»¡è¶³ACIDåŸåˆ™</li>
<li>å¸¸ç”¨æ•°æ®åº“éƒ½æ”¯æŒï¼Œå®ç°ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ä»£ç ä¾µå…¥</li>
</ul>
<p>XAæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>å› ä¸º<strong>ä¸€é˜¶æ®µéœ€è¦é”å®šæ•°æ®åº“èµ„æºï¼Œç­‰å¾…äºŒé˜¶æ®µç»“æŸæ‰é‡Šæ”¾ï¼Œæ€§èƒ½è¾ƒå·®</strong></li>
<li>ä¾èµ–å…³ç³»å‹æ•°æ®åº“å®ç°äº‹åŠ¡</li>
</ul>
<h3 id="3-5-ATæ¨¡å¼"><a href="#3-5-ATæ¨¡å¼" class="headerlink" title="3.5 ATæ¨¡å¼"></a>3.5 ATæ¨¡å¼</h3><p>ATæ¨¡å¼åŒæ ·æ˜¯åˆ†é˜¶æ®µæäº¤çš„äº‹åŠ¡æ¨¡å‹ï¼Œä¸è¿‡ç¼ºå¼¥è¡¥äº†XAæ¨¡å‹ä¸­èµ„æºé”å®šå‘¨æœŸè¿‡é•¿çš„ç¼ºé™·ã€‚</p>
<p><img src="/img/blogs/java/springcloud/4.3.3.png" srcset="/img/loading.gif" lazyload></p>
<p>é˜¶æ®µä¸€RMçš„å·¥ä½œï¼š</p>
<ul>
<li>æ³¨å†Œåˆ†æ”¯äº‹åŠ¡</li>
<li>è®°å½•undo-logï¼ˆæ•°æ®å¿«ç…§ï¼‰</li>
<li>æ‰§è¡Œä¸šåŠ¡sqlå¹¶æäº¤</li>
<li>æŠ¥å‘Šäº‹åŠ¡çŠ¶æ€<br>é˜¶æ®µäºŒæäº¤æ—¶RMçš„å·¥ä½œï¼š</li>
<li>åˆ é™¤undo-logå³å¯<br>é˜¶æ®µäºŒå›æ»šæ—¶RMçš„å·¥ä½œï¼š</li>
<li>æ ¹æ®undo-logæ¢å¤æ•°æ®åˆ°æ›´æ–°å‰</li>
</ul>
<p><img src="/img/blogs/java/springcloud/4.3.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ATä¸XAçš„åŒºåˆ«</strong></p>
<ul>
<li>XAæ¨¡å¼ä¸€é˜¶æ®µä¸æäº¤äº‹åŠ¡ï¼Œé”å®šèµ„æºï¼›ATæ¨¡å¼ä¸€é˜¶æ®µç›´æ¥æäº¤ï¼Œä¸é”å®šèµ„æºã€‚</li>
<li>XAæ¨¡å¼ä¾èµ–æ•°æ®åº“æœºåˆ¶å®ç°å›æ»šï¼›ATæ¨¡å¼åˆ©ç”¨æ•°æ®å¿«ç…§å®ç°æ•°æ®å›æ»šã€‚</li>
<li>XAæ¨¡å¼å¼ºä¸€è‡´ï¼›ATæ¨¡å¼æœ€ç»ˆä¸€è‡´</li>
</ul>
<p>å¯è§ï¼ŒATæ¨¡å¼ä½¿ç”¨èµ·æ¥æ›´åŠ ç®€å•ï¼Œæ— ä¸šåŠ¡ä¾µå…¥ï¼Œæ€§èƒ½æ›´å¥½ã€‚å› æ­¤ä¼ä¸š90%çš„åˆ†å¸ƒå¼äº‹åŠ¡éƒ½å¯ä»¥ç”¨ATæ¨¡å¼æ¥è§£å†³ã€‚</p>
<h1 id="äº”-MQ"><a href="#äº”-MQ" class="headerlink" title="äº”. MQ"></a>äº”. MQ</h1><h2 id="1-è®¤è¯†MQ"><a href="#1-è®¤è¯†MQ" class="headerlink" title="1. è®¤è¯†MQ"></a>1. è®¤è¯†MQ</h2><h3 id="1-1-åŒæ­¥è°ƒç”¨"><a href="#1-1-åŒæ­¥è°ƒç”¨" class="headerlink" title="1.1 åŒæ­¥è°ƒç”¨"></a>1.1 åŒæ­¥è°ƒç”¨</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒåŒæ­¥è°ƒç”¨ï¼ˆSynchronous Invocationï¼‰é€šå¸¸<strong>æŒ‡ä¸€ä¸ªæœåŠ¡è°ƒç”¨å¦ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œè°ƒç”¨æ–¹å¿…é¡»ç­‰å¾…è¢«è°ƒç”¨æ–¹å¤„ç†å®Œè¯·æ±‚å¹¶è¿”å›å“åº”åï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œåç»­é€»è¾‘</strong>ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>é˜»å¡æ‰§è¡Œ</strong>ï¼šè°ƒç”¨æ–¹åœ¨ç­‰å¾…è¿”å›ç»“æœæ—¶æ— æ³•æ‰§è¡Œå…¶ä»–ä»»åŠ¡ã€‚</li>
<li>æ‰§è¡Œé¡ºåºä¸¥æ ¼ï¼š<strong>å¿…é¡»æŒ‰é¡ºåºç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡å®Œæˆåæ‰èƒ½ç»§ç»­ä¸‹ä¸€ä¸ªä»»åŠ¡</strong>ã€‚</li>
<li><strong>é€‚ç”¨äºçŸ­æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡</strong>ï¼šå¦‚æœè¢«è°ƒç”¨çš„æ–¹æ³•æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œä¼šå½±å“ç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œå¹¶å‘èƒ½åŠ›ã€‚</li>
</ul>
<p><strong>å­˜åœ¨çš„é—®é¢˜</strong>ï¼š</p>
<ul>
<li>æ‹“å±•æ€§å·®ï¼šæ¯æ¬¡æœ‰æ–°çš„éœ€æ±‚ï¼Œç°æœ‰æ”¯ä»˜é€»è¾‘éƒ½è¦è·Ÿç€å˜åŒ–ï¼Œä»£ç ç»å¸¸å˜åŠ¨ï¼Œä¸ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œæ‹“å±•æ€§ä¸å¥½ã€‚</li>
<li>æ€§èƒ½ä¸‹é™ï¼šæ¯æ¬¡è¿œç¨‹è°ƒç”¨ï¼Œè°ƒç”¨è€…éƒ½æ˜¯é˜»å¡ç­‰å¾…çŠ¶æ€ã€‚æœ€ç»ˆæ•´ä¸ªä¸šåŠ¡çš„å“åº”æ—¶é•¿å°±æ˜¯æ¯æ¬¡è¿œç¨‹è°ƒç”¨çš„æ‰§è¡Œæ—¶é•¿ä¹‹å’Œ</li>
<li>çº§è”å¤±è´¥(é›ªå´©é—®é¢˜)ï¼šå½“äº¤æ˜“æœåŠ¡ã€é€šçŸ¥æœåŠ¡å‡ºç°æ•…éšœæ—¶ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¼šå›æ»šï¼Œäº¤æ˜“å¤±è´¥ã€‚</li>
</ul>
<h3 id="1-2-å¼‚æ­¥è°ƒç”¨"><a href="#1-2-å¼‚æ­¥è°ƒç”¨" class="headerlink" title="1.2 å¼‚æ­¥è°ƒç”¨"></a>1.2 å¼‚æ­¥è°ƒç”¨</h3><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œå¼‚æ­¥è°ƒç”¨ï¼ˆAsynchronous Invocationï¼‰æŒ‡çš„æ˜¯<strong>è°ƒç”¨æ–¹åœ¨è°ƒç”¨æŸä¸ªæœåŠ¡æ—¶ï¼Œä¸éœ€è¦ç­‰å¾…å…¶å®Œæˆï¼Œè€Œæ˜¯ç«‹å³è¿”å›å¹¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡</strong>ã€‚<strong>è¢«è°ƒç”¨æ–¹åœ¨å®Œæˆå¤„ç†å</strong>ï¼Œå¯ä»¥é€šè¿‡å›è°ƒã€è½®è¯¢ã€<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ç­‰æ–¹å¼é€šçŸ¥è°ƒç”¨æ–¹ã€‚</p>
<p>å¼‚æ­¥è°ƒç”¨æ–¹å¼å…¶å®å°±æ˜¯åŸºäºæ¶ˆæ¯é€šçŸ¥çš„æ–¹å¼ï¼Œä¸€èˆ¬åŒ…å«ä¸‰ä¸ªè§’è‰²ï¼š</p>
<ul>
<li>æ¶ˆæ¯å‘é€è€…ï¼šæŠ•é€’æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„è°ƒç”¨æ–¹</li>
<li>æ¶ˆæ¯Brokerï¼šç®¡ç†ã€æš‚å­˜ã€è½¬å‘æ¶ˆæ¯ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆå¾®ä¿¡æœåŠ¡å™¨</li>
<li>æ¶ˆæ¯æ¥æ”¶è€…ï¼šæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„äººï¼Œå°±æ˜¯åŸæ¥çš„æœåŠ¡æä¾›æ–¹</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.2.png" srcset="/img/loading.gif" lazyload></p>
<p>åœ¨å¼‚æ­¥è°ƒç”¨ä¸­ï¼Œå‘é€è€…ä¸å†ç›´æ¥åŒæ­¥è°ƒç”¨æ¥æ”¶è€…çš„ä¸šåŠ¡æ¥å£ï¼Œè€Œæ˜¯å‘é€ä¸€æ¡æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯Brokerã€‚ç„¶åæ¥æ”¶è€…æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä»æ¶ˆæ¯Brokeré‚£é‡Œè®¢é˜…æ¶ˆæ¯ã€‚æ¯å½“å‘é€æ–¹å‘é€æ¶ˆæ¯åï¼Œæ¥å—è€…éƒ½èƒ½è·å–æ¶ˆæ¯å¹¶å¤„ç†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.3.png" srcset="/img/loading.gif" lazyload></p>
<p>å¼‚æ­¥è°ƒç”¨çš„ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p>
<ul>
<li>è€¦åˆåº¦æ›´ä½</li>
<li>æ€§èƒ½æ›´å¥½</li>
<li>ä¸šåŠ¡æ‹“å±•æ€§å¼º</li>
<li>æ•…éšœéš”ç¦»ï¼Œé¿å…çº§è”å¤±è´¥</li>
</ul>
<p>å¼‚æ­¥é€šä¿¡å­˜åœ¨ä¸‹åˆ—ç¼ºç‚¹ï¼š</p>
<ul>
<li>å®Œå…¨ä¾èµ–äºBrokerçš„å¯é æ€§ã€å®‰å…¨æ€§å’Œæ€§èƒ½</li>
<li>æ¶æ„å¤æ‚ï¼ŒåæœŸç»´æŠ¤å’Œè°ƒè¯•éº»çƒ¦</li>
</ul>
<h3 id="1-3-å¸¸è§MQæŠ€æœ¯å¯¹æ¯”"><a href="#1-3-å¸¸è§MQæŠ€æœ¯å¯¹æ¯”" class="headerlink" title="1.3 å¸¸è§MQæŠ€æœ¯å¯¹æ¯”"></a>1.3 å¸¸è§MQæŠ€æœ¯å¯¹æ¯”</h3><table>
<thead>
<tr>
<th>å¸¸è§MQ</th>
<th>RabbitMQ</th>
<th>ActiveMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td><strong>å…¬å¸&#x2F;ç¤¾åŒº</strong></td>
<td>Rabbit</td>
<td>Apache</td>
<td>é˜¿é‡Œ</td>
<td>Apache</td>
</tr>
<tr>
<td><strong>å¼€å‘è¯­è¨€</strong></td>
<td>Erlang</td>
<td>Java</td>
<td>Java</td>
<td>Scala&amp;Java</td>
</tr>
<tr>
<td><strong>åè®®æ”¯æŒ</strong></td>
<td>AMQP, XMPP, SMTP, STOMP</td>
<td>OpenWire, STOMP, REST, XMPP, AMQP</td>
<td>è‡ªå®šä¹‰åè®®</td>
<td>è‡ªå®šä¹‰åè®®</td>
</tr>
<tr>
<td><strong>å¯ç”¨æ€§</strong></td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
<td>é«˜</td>
<td>é«˜</td>
</tr>
<tr>
<td><strong>å•æœºååé‡</strong></td>
<td>ä¸€èˆ¬</td>
<td>å·®</td>
<td>é«˜</td>
<td>éå¸¸é«˜</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å»¶è¿Ÿ</strong></td>
<td>å¾®ç§’çº§</td>
<td>æ¯«ç§’çº§</td>
<td>æ¯«ç§’çº§</td>
<td>æ¯«ç§’ä»¥å†…</td>
</tr>
<tr>
<td><strong>æ¶ˆæ¯å¯é æ€§</strong></td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
<td>é«˜</td>
<td>ä¸€èˆ¬</td>
</tr>
</tbody></table>
<h2 id="2-RabbitMQ"><a href="#2-RabbitMQ" class="headerlink" title="2. RabbitMQ"></a>2. RabbitMQ</h2><h3 id="2-1-RabbitMQæ¶æ„"><a href="#2-1-RabbitMQæ¶æ„" class="headerlink" title="2.1 RabbitMQæ¶æ„"></a>2.1 RabbitMQæ¶æ„</h3><ul>
<li>publisherï¼š<strong>ç”Ÿäº§è€…</strong>ï¼Œä¹Ÿå°±æ˜¯å‘é€æ¶ˆæ¯çš„ä¸€æ–¹</li>
<li>consumerï¼š<strong>æ¶ˆè´¹è€…</strong>ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹æ¶ˆæ¯çš„ä¸€æ–¹</li>
<li>queueï¼š<strong>é˜Ÿåˆ—ï¼Œå­˜å‚¨æ¶ˆæ¯</strong>ã€‚ç”Ÿäº§è€…æŠ•é€’çš„æ¶ˆæ¯ä¼šæš‚å­˜åœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…æ¶ˆè´¹è€…å¤„ç†</li>
<li>exchangeï¼š<strong>äº¤æ¢æœºï¼Œè´Ÿè´£æ¶ˆæ¯è·¯ç”±</strong>ã€‚ç”Ÿäº§è€…å‘é€çš„æ¶ˆæ¯ç”±äº¤æ¢æœºå†³å®šæŠ•é€’åˆ°å“ªä¸ªé˜Ÿåˆ—ã€‚</li>
<li>virtual hostï¼š<strong>è™šæ‹Ÿä¸»æœºï¼Œèµ·åˆ°æ•°æ®éš”ç¦»çš„ä½œç”¨</strong>ã€‚æ¯ä¸ªè™šæ‹Ÿä¸»æœºç›¸äº’ç‹¬ç«‹ï¼Œæœ‰å„è‡ªçš„exchangeã€queue</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.4.png" srcset="/img/loading.gif" lazyload></p>
<p>ç”Ÿäº§è€…å‘é€åˆ°äº¤æ¢æœºçš„æ¶ˆæ¯ï¼Œåªä¼šè·¯ç”±åˆ°ä¸å…¶ç»‘å®šçš„é˜Ÿåˆ—ï¼Œå› æ­¤ä»…ä»…åˆ›å»ºé˜Ÿåˆ—æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å°†å…¶ä¸äº¤æ¢æœºç»‘å®š</p>
<h3 id="2-2-æ•°æ®éš”ç¦»"><a href="#2-2-æ•°æ®éš”ç¦»" class="headerlink" title="2.2 æ•°æ®éš”ç¦»"></a>2.2 æ•°æ®éš”ç¦»</h3><ul>
<li>ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºä¸åŒçš„virtual hostï¼Œå°†æ¯ä¸ªé¡¹ç›®çš„æ•°æ®éš”ç¦»ã€‚</li>
<li>ç»™æ¯ä¸ªé¡¹ç›®åˆ›å»ºç‹¬ç«‹çš„è¿ç»´è´¦å·ï¼Œå°†ç®¡ç†æƒé™åˆ†ç¦»ã€‚</li>
</ul>
<h2 id="3-SpringAMQP"><a href="#3-SpringAMQP" class="headerlink" title="3. SpringAMQP"></a>3. SpringAMQP</h2><h3 id="3-1-å…¥é—¨æ¡ˆä¾‹"><a href="#3-1-å…¥é—¨æ¡ˆä¾‹" class="headerlink" title="3.1 å…¥é—¨æ¡ˆä¾‹"></a>3.1 å…¥é—¨æ¡ˆä¾‹</h3><h4 id="3-1-1-å¼•å…¥ä¾èµ–"><a href="#3-1-1-å¼•å…¥ä¾èµ–" class="headerlink" title="3.1.1 å¼•å…¥ä¾èµ–"></a>3.1.1 å¼•å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--AMQPä¾èµ–ï¼ŒåŒ…å«RabbitMQ--&gt;</span><br> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-2-æ·»åŠ é…ç½®"><a href="#3-1-2-æ·»åŠ é…ç½®" class="headerlink" title="3.1.2 æ·»åŠ é…ç½®"></a>3.1.2 æ·»åŠ é…ç½®</h4><p>åœ¨publisheræœåŠ¡çš„application.ymlä¸­æ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.150</span><span class="hljs-number">.101</span> <span class="hljs-comment"># ä½ çš„è™šæ‹ŸæœºIP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">5672</span> <span class="hljs-comment"># ç«¯å£</span><br>    <span class="hljs-attr">virtual-host:</span> <span class="hljs-string">/hmall</span> <span class="hljs-comment"># è™šæ‹Ÿä¸»æœº</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">hmall</span> <span class="hljs-comment"># ç”¨æˆ·å</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123</span> <span class="hljs-comment"># å¯†ç </span><br></code></pre></td></tr></table></figure>

<h4 id="3-1-3-å‘é€æ¶ˆæ¯"><a href="#3-1-3-å‘é€æ¶ˆæ¯" class="headerlink" title="3.1.3 å‘é€æ¶ˆæ¯"></a>3.1.3 å‘é€æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringAmqpTest</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSimpleQueue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// é˜Ÿåˆ—åç§°</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>        <span class="hljs-comment">// æ¶ˆæ¯</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, spring amqp!&quot;</span>;<br>        <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>        rabbitTemplate.convertAndSend(queueName, message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-1-4-æ¥æ”¶æ¶ˆæ¯"><a href="#3-1-4-æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="3.1.4 æ¥æ”¶æ¶ˆæ¯"></a>3.1.4 æ¥æ”¶æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringRabbitListener</span> &#123;<br>    <span class="hljs-comment">// åˆ©ç”¨RabbitListeneræ¥å£°æ˜è¦ç›‘å¬çš„é˜Ÿåˆ—ä¿¡æ¯</span><br>    <span class="hljs-comment">// å°†æ¥ä¸€æ—¦ç›‘å¬çš„é˜Ÿåˆ—ä¸­æœ‰äº†æ¶ˆæ¯ï¼Œå°±ä¼šæ¨é€ç»™å½“å‰æœåŠ¡ï¼Œè°ƒç”¨å½“å‰æ–¹æ³•ï¼Œå¤„ç†æ¶ˆæ¯ã€‚</span><br>    <span class="hljs-comment">// å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­æ¥æ”¶çš„å°±æ˜¯æ¶ˆæ¯ä½“çš„å†…å®¹</span><br>    <span class="hljs-meta">@RabbitListener(queues = &quot;simple.queue&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenSimpleQueueMessage</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>        System.out.println(<span class="hljs-string">&quot;spring æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-2-WorkQueuesæ¨¡å‹"><a href="#3-2-WorkQueuesæ¨¡å‹" class="headerlink" title="3.2 WorkQueuesæ¨¡å‹"></a>3.2 WorkQueuesæ¨¡å‹</h3><p>è®©å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼Œå…±åŒæ¶ˆè´¹é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚å¯ä»¥ä½¿ç”¨WorkQueuesæ¨¡å‹ï¼Œå¤šä¸ªæ¶ˆè´¹è€…å…±åŒå¤„ç†æ¶ˆæ¯å¤„ç†ï¼Œæ¶ˆæ¯å¤„ç†çš„é€Ÿåº¦å°±èƒ½å¤§å¤§æé«˜äº†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.5.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="3-2-1-æ¶ˆæ¯å‘é€"><a href="#3-2-1-æ¶ˆæ¯å‘é€" class="headerlink" title="3.2.1 æ¶ˆæ¯å‘é€"></a>3.2.1 æ¶ˆæ¯å‘é€</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * workQueue</span><br><span class="hljs-comment">     * å‘é˜Ÿåˆ—ä¸­ä¸åœå‘é€æ¶ˆæ¯ï¼Œæ¨¡æ‹Ÿæ¶ˆæ¯å †ç§¯ã€‚</span><br><span class="hljs-comment">     */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testWorkQueue</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    <span class="hljs-comment">// é˜Ÿåˆ—åç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">queueName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;simple.queue&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, message_&quot;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) &#123;<br>        <span class="hljs-comment">// å‘é€æ¶ˆæ¯ï¼Œæ¯20æ¯«ç§’å‘é€ä¸€æ¬¡ï¼Œç›¸å½“äºæ¯ç§’å‘é€50æ¡æ¶ˆæ¯</span><br>        rabbitTemplate.convertAndSend(queueName, message + i);<br>        Thread.sleep(<span class="hljs-number">20</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-2-2-æ¶ˆæ¯æ¥æ”¶"><a href="#3-2-2-æ¶ˆæ¯æ¥æ”¶" class="headerlink" title="3.2.2 æ¶ˆæ¯æ¥æ”¶"></a>3.2.2 æ¶ˆæ¯æ¥æ”¶</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;work.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenWorkQueue1</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">20</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;work.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenWorkQueue2</span><span class="hljs-params">(String msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.err.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2........æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span> + LocalTime.now());<br>    Thread.sleep(<span class="hljs-number">200</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>æ¶ˆè´¹è€…1 sleepäº†20æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’é’Ÿå¤„ç†50ä¸ªæ¶ˆæ¯</li>
<li>æ¶ˆè´¹è€…2 sleepäº†200æ¯«ç§’ï¼Œç›¸å½“äºæ¯ç§’å¤„ç†5ä¸ªæ¶ˆæ¯</li>
</ul>
<h4 id="3-2-3-æµ‹è¯•ç»“æœ"><a href="#3-2-3-æµ‹è¯•ç»“æœ" class="headerlink" title="3.2.3 æµ‹è¯•ç»“æœ"></a>3.2.3 æµ‹è¯•ç»“æœ</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java">æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_0ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.869555300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_1ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.884518</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_2ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.907454400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_4ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.953332100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_6ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00.997867300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_8ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.042178700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_3ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.086478800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_10ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.087476600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_12ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.132578300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_14ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.175851200</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_16ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.218533400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_18ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.261322900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_5ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.287003700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_20ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.304412400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_22ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.349950100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_24ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.394533900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_26ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.439876500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_28ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.482937800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_7ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.488977100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_30ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.526409300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_32ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.572148</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_34ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.618264800</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_36ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.660780600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_9ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.689189300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_38ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.705261</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_40ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.746927300</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_42ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.789835</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_44ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.834393100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_46ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.875312100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_11ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.889969500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">1</span>æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_48ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">01.920702500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_13ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.090725900</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_15ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.293060600</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_17ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.493748</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_19ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.696635100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_21ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">02.896809700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_23ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.099533400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_25ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.301446400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_27ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.504999100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_29ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.705702500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_31ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">03.906601200</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_33ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.108118500</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_35ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.308945400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_37ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.511547700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_39ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.714038400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_41ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">04.916192700</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_43ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.116286400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_45ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.318055100</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_47ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.520656400</span><br>æ¶ˆè´¹è€…<span class="hljs-number">2.</span>.......æ¥æ”¶åˆ°æ¶ˆæ¯ï¼šã€hello, message_49ã€‘<span class="hljs-number">21</span>:<span class="hljs-number">06</span>:<span class="hljs-number">05.723106700</span><br></code></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ¶ˆè´¹è€…1å’Œæ¶ˆè´¹è€…2ç«Ÿç„¶æ¯äººæ¶ˆè´¹äº†25æ¡æ¶ˆæ¯ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…1å¾ˆå¿«å®Œæˆäº†è‡ªå·±çš„25æ¡æ¶ˆæ¯</li>
<li>æ¶ˆè´¹è€…2å´åœ¨ç¼“æ…¢çš„å¤„ç†è‡ªå·±çš„25æ¡æ¶ˆæ¯ã€‚<br>ä¹Ÿå°±æ˜¯è¯´<strong>æ¶ˆæ¯æ˜¯å¹³å‡åˆ†é…ç»™æ¯ä¸ªæ¶ˆè´¹è€…</strong>ï¼Œå¹¶æ²¡æœ‰è€ƒè™‘åˆ°æ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚å¯¼è‡´1ä¸ªæ¶ˆè´¹è€…ç©ºé—²ï¼Œå¦ä¸€ä¸ªæ¶ˆè´¹è€…å¿™çš„ä¸å¯å¼€äº¤ã€‚</li>
</ul>
<h4 id="3-2-4-èƒ½è€…å¤šåŠ³é…ç½®"><a href="#3-2-4-èƒ½è€…å¤šåŠ³é…ç½®" class="headerlink" title="3.2.4 èƒ½è€…å¤šåŠ³é…ç½®"></a>3.2.4 èƒ½è€…å¤šåŠ³é…ç½®</h4><p>ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼Œæ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">prefetch:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># æ¯æ¬¡åªèƒ½è·å–ä¸€æ¡æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆæ‰èƒ½è·å–ä¸‹ä¸€ä¸ªæ¶ˆæ¯</span><br></code></pre></td></tr></table></figure>

<p>å†æ¬¡æµ‹è¯•å‘ç°ï¼Œç”±äºæ¶ˆè´¹è€…1å¤„ç†é€Ÿåº¦è¾ƒå¿«ï¼Œæ‰€ä»¥å¤„ç†äº†æ›´å¤šçš„æ¶ˆæ¯ï¼›æ¶ˆè´¹è€…2å¤„ç†é€Ÿåº¦è¾ƒæ…¢ï¼Œåªå¤„ç†äº†6æ¡æ¶ˆæ¯ã€‚è€Œæœ€ç»ˆæ€»çš„æ‰§è¡Œè€—æ—¶ä¹Ÿåœ¨1ç§’å·¦å³ï¼Œå¤§å¤§æå‡ã€‚<br>æ­£æ‰€è°“èƒ½è€…å¤šåŠ³ï¼Œè¿™æ ·å……åˆ†åˆ©ç”¨äº†æ¯ä¸€ä¸ªæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ¶ˆæ¯ç§¯å‹é—®é¢˜ã€‚</p>
<h4 id="3-2-5-Workæ¨¡å‹æ€»ç»“"><a href="#3-2-5-Workæ¨¡å‹æ€»ç»“" class="headerlink" title="3.2.5 Workæ¨¡å‹æ€»ç»“"></a>3.2.5 Workæ¨¡å‹æ€»ç»“</h4><ul>
<li><strong>å¤šä¸ªæ¶ˆè´¹è€…ç»‘å®šåˆ°ä¸€ä¸ªé˜Ÿåˆ—ï¼ŒåŒä¸€æ¡æ¶ˆæ¯åªä¼šè¢«ä¸€ä¸ªæ¶ˆè´¹è€…å¤„ç†</strong></li>
<li>é€šè¿‡è®¾ç½®prefetchæ¥æ§åˆ¶æ¶ˆè´¹è€…é¢„å–çš„æ¶ˆæ¯æ•°é‡</li>
</ul>
<h3 id="3-3-äº¤æ¢æœº"><a href="#3-3-äº¤æ¢æœº" class="headerlink" title="3.3 äº¤æ¢æœº"></a>3.3 äº¤æ¢æœº</h3><p>äº¤æ¢æœºçš„ç±»å‹ï¼š</p>
<ul>
<li>Fanoutï¼šå¹¿æ’­ï¼Œå°†æ¶ˆæ¯äº¤ç»™æ‰€æœ‰ç»‘å®šåˆ°äº¤æ¢æœºçš„é˜Ÿåˆ—ã€‚æˆ‘ä»¬æœ€æ—©åœ¨æ§åˆ¶å°ä½¿ç”¨çš„æ­£æ˜¯Fanoutäº¤æ¢æœº</li>
<li>Directï¼šè®¢é˜…ï¼ŒåŸºäºRoutingKeyï¼ˆè·¯ç”±keyï¼‰å‘é€ç»™è®¢é˜…äº†æ¶ˆæ¯çš„é˜Ÿåˆ—</li>
<li>Topicï¼šé€šé…ç¬¦è®¢é˜…ï¼Œä¸Directç±»ä¼¼ï¼Œåªä¸è¿‡RoutingKeyå¯ä»¥ä½¿ç”¨é€šé…ç¬¦</li>
</ul>
<h4 id="3-3-1-Fanoutäº¤æ¢æœº"><a href="#3-3-1-Fanoutäº¤æ¢æœº" class="headerlink" title="3.3.1 Fanoutäº¤æ¢æœº"></a>3.3.1 Fanoutäº¤æ¢æœº</h4><p><strong>å¹¿æ’­</strong>äº¤æ¢æœºï¼Œäº¤æ¢æœºæŠŠæ¶ˆæ¯å‘é€ç»™ç»‘å®šè¿‡çš„æ‰€æœ‰é˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—çš„æ¶ˆè´¹è€…éƒ½èƒ½æ”¶åˆ°æ¶ˆæ¯</p>
<p><img src="/img/blogs/java/springcloud/mq.6.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>æ¶ˆæ¯å‘é€</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFanoutExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.fanout&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, everyone!&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>æ¶ˆæ¯æ¥æ”¶</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testFanoutExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.fanout&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, everyone!&quot;</span>;<br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>FanoutExchangeçš„ä¼šå°†æ¶ˆæ¯è·¯ç”±åˆ°æ¯ä¸ªç»‘å®šçš„é˜Ÿåˆ—</li>
</ul>
<h4 id="3-3-2-Directäº¤æ¢æœº"><a href="#3-3-2-Directäº¤æ¢æœº" class="headerlink" title="3.3.2 Directäº¤æ¢æœº"></a>3.3.2 Directäº¤æ¢æœº</h4><p>Directæ¨¡å‹ä¸‹ï¼š</p>
<ul>
<li>é˜Ÿåˆ—ä¸äº¤æ¢æœºçš„ç»‘å®šï¼Œä¸èƒ½æ˜¯ä»»æ„ç»‘å®šäº†ï¼Œè€Œæ˜¯è¦<strong>æŒ‡å®šä¸€ä¸ªRoutingKeyï¼ˆè·¯ç”±keyï¼‰</strong></li>
<li>æ¶ˆæ¯çš„å‘é€æ–¹åœ¨ å‘ Exchangeå‘é€æ¶ˆæ¯æ—¶ï¼Œä¹Ÿå¿…é¡»æŒ‡å®šæ¶ˆæ¯çš„ RoutingKeyã€‚</li>
<li>Exchangeä¸å†æŠŠæ¶ˆæ¯äº¤ç»™æ¯ä¸€ä¸ªç»‘å®šçš„é˜Ÿåˆ—ï¼Œè€Œæ˜¯æ ¹æ®æ¶ˆæ¯çš„Routing Keyè¿›è¡Œåˆ¤æ–­ï¼Œ<strong>åªæœ‰é˜Ÿåˆ—çš„Routingkeyä¸æ¶ˆæ¯çš„ Routing keyå®Œå…¨ä¸€è‡´</strong>ï¼Œæ‰ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.7.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="3-3-2-1-æ¶ˆæ¯æ¥æ”¶"><a href="#3-3-2-1-æ¶ˆæ¯æ¥æ”¶" class="headerlink" title="3.3.2.1 æ¶ˆæ¯æ¥æ”¶"></a>3.3.2.1 æ¶ˆæ¯æ¥æ”¶</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;direct.queue1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue1</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;direct.queue2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue2</span><span class="hljs-params">(String msg)</span> &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°direct.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="3-3-2-2-æ¶ˆæ¯å‘é€"><a href="#3-3-2-2-æ¶ˆæ¯å‘é€" class="headerlink" title="3.3.2.2 æ¶ˆæ¯å‘é€"></a>3.3.2.2 æ¶ˆæ¯å‘é€</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendDirectExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.direct&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;æœ€æ–°æŠ¥é“ï¼Œå“¥æ–¯æ‹‰æ˜¯å±…æ°‘è‡ªæ²»å·¨å‹æ°”çƒï¼Œè™šæƒŠä¸€åœºï¼&quot;</span>;<br>    <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;blue&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>æ­¤æ—¶åªæœ‰<code>blue</code>çš„æ¶ˆè´¹è€…æ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…1</p>
<h5 id="3-3-2-3-æ€»ç»“"><a href="#3-3-2-3-æ€»ç»“" class="headerlink" title="3.3.2.3 æ€»ç»“"></a>3.3.2.3 æ€»ç»“</h5><p>Directäº¤æ¢æœºä¸Fanoutäº¤æ¢æœºçš„å·®å¼‚ï¼Ÿ</p>
<ul>
<li>Fanoutäº¤æ¢æœºå°†æ¶ˆæ¯è·¯ç”±ç»™æ¯ä¸€ä¸ªä¸ä¹‹ç»‘å®šçš„é˜Ÿåˆ—</li>
<li>Directäº¤æ¢æœºæ ¹æ®RoutingKeyåˆ¤æ–­è·¯ç”±ç»™å“ªä¸ªé˜Ÿåˆ—</li>
<li>å¦‚æœå¤šä¸ªé˜Ÿåˆ—å…·æœ‰ç›¸åŒçš„RoutingKeyï¼Œåˆ™ä¸FanoutåŠŸèƒ½ç±»ä¼¼</li>
</ul>
<h4 id="3-3-3-Topicäº¤æ¢æœº"><a href="#3-3-3-Topicäº¤æ¢æœº" class="headerlink" title="3.3.3 Topicäº¤æ¢æœº"></a>3.3.3 Topicäº¤æ¢æœº</h4><p>Topicç±»å‹çš„Exchangeä¸Directç›¸æ¯”ï¼Œéƒ½æ˜¯å¯ä»¥<strong>æ ¹æ®RoutingKeyæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é˜Ÿåˆ—</strong>ã€‚<br>åªä¸è¿‡Topicç±»å‹Exchange<strong>å¯ä»¥</strong>è®©é˜Ÿåˆ—åœ¨ç»‘å®šBindingKey çš„æ—¶å€™<strong>ä½¿ç”¨é€šé…ç¬¦</strong>ï¼</p>
<p>é€šé…ç¬¦è§„åˆ™ï¼š</p>
<ul>
<li>#ï¼šåŒ¹é…ä¸€ä¸ªæˆ–å¤šä¸ªè¯</li>
<li>*ï¼šåŒ¹é…ä¸å¤šä¸å°‘æ°å¥½1ä¸ªè¯</li>
</ul>
<p>ä¸¾ä¾‹ï¼š</p>
<ul>
<li>item.#ï¼šèƒ½å¤ŸåŒ¹é…item.spu.insert æˆ–è€… item.spu</li>
<li>item.*ï¼šåªèƒ½åŒ¹é…item.spu</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.8.png" srcset="/img/loading.gif" lazyload></p>
<ol>
<li>æ¶ˆæ¯å‘é€</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * topicExchange</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testSendTopicExchange</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// äº¤æ¢æœºåç§°</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">exchangeName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hmall.topic&quot;</span>;<br>    <span class="hljs-comment">// æ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;å–œæŠ¥ï¼å­™æ‚Ÿç©ºå¤§æˆ˜å“¥æ–¯æ‹‰ï¼Œèƒœ!&quot;</span>;<br>    <span class="hljs-comment">// å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(exchangeName, <span class="hljs-string">&quot;china.news&quot;</span>, message);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol>
<li>æ¶ˆæ¯æ¥æ”¶</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;topic.queue1&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenTopicQueue1</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°topic.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br><br><span class="hljs-meta">@RabbitListener(queues = &quot;topic.queue2&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenTopicQueue2</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…2æ¥æ”¶åˆ°topic.queue2çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>Directäº¤æ¢æœºä¸Topicäº¤æ¢æœºçš„å·®å¼‚</li>
</ol>
<ul>
<li>Topicäº¤æ¢æœºæ¥æ”¶çš„æ¶ˆæ¯RoutingKeyå¿…é¡»æ˜¯å¤šä¸ªå•è¯ï¼Œä»¥ . åˆ†å‰²</li>
<li>Topicäº¤æ¢æœºä¸é˜Ÿåˆ—ç»‘å®šæ—¶çš„bindingKeyå¯ä»¥æŒ‡å®šé€šé…ç¬¦</li>
<li>#ï¼šä»£è¡¨0ä¸ªæˆ–å¤šä¸ªè¯</li>
<li>*ï¼šä»£è¡¨1ä¸ªè¯</li>
</ul>
<h3 id="3-4-å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"><a href="#3-4-å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº" class="headerlink" title="3.4 å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº"></a>3.4 å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢æœº</h3><p>Springæä¾›äº†åŸºäºæ³¨è§£æ–¹å¼æ¥å£°æ˜</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">    value = @Queue(name = &quot;direct.queue1&quot;),</span><br><span class="hljs-meta">    exchange = @Exchange(name = &quot;hmall.direct&quot;, type = ExchangeTypes.DIRECT),</span><br><span class="hljs-meta">    key = &#123;&quot;red&quot;, &quot;blue&quot;&#125;</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDirectQueue1</span><span class="hljs-params">(String msg)</span>&#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…1æ¥æ”¶åˆ°direct.queue1çš„æ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="3-5-æ¶ˆæ¯è½¬æ¢å™¨-JSONè½¬æ¢å™¨"><a href="#3-5-æ¶ˆæ¯è½¬æ¢å™¨-JSONè½¬æ¢å™¨" class="headerlink" title="3.5 æ¶ˆæ¯è½¬æ¢å™¨(JSONè½¬æ¢å™¨)"></a>3.5 æ¶ˆæ¯è½¬æ¢å™¨(JSONè½¬æ¢å™¨)</h3><p>é»˜è®¤æƒ…å†µä¸‹Springé‡‡ç”¨çš„åºåˆ—åŒ–æ–¹å¼æ˜¯JDKåºåˆ—åŒ–ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJDKåºåˆ—åŒ–å­˜åœ¨ä¸‹åˆ—é—®é¢˜ï¼š</p>
<ul>
<li>æ•°æ®ä½“ç§¯è¿‡å¤§</li>
<li>æœ‰å®‰å…¨æ¼æ´</li>
<li>å¯è¯»æ€§å·®</li>
</ul>
<p>å› æ­¤å¯ä»¥ä½¿ç”¨JSONæ–¹å¼æ¥åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚</p>
<h4 id="3-5-1-å¼•å…¥ä¾èµ–"><a href="#3-5-1-å¼•å…¥ä¾èµ–" class="headerlink" title="3.5.1 å¼•å…¥ä¾èµ–"></a>3.5.1 å¼•å…¥ä¾èµ–</h4><p>åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡ä¸­éƒ½å¼•å…¥ä¾èµ–ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.10<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-5-2-é…ç½®æ¶ˆæ¯è½¬æ¢å™¨"><a href="#3-5-2-é…ç½®æ¶ˆæ¯è½¬æ¢å™¨" class="headerlink" title="3.5.2 é…ç½®æ¶ˆæ¯è½¬æ¢å™¨"></a>3.5.2 é…ç½®æ¶ˆæ¯è½¬æ¢å™¨</h4><p>åœ¨publisherå’Œconsumerä¸¤ä¸ªæœåŠ¡çš„å¯åŠ¨ç±»ä¸­æ·»åŠ ä¸€ä¸ªBeanå³å¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</span><br>    <span class="hljs-type">Jackson2JsonMessageConverter</span> <span class="hljs-variable">jackson2JsonMessageConverter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    <span class="hljs-comment">// 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯</span><br>    jackson2JsonMessageConverter.setCreateMessageIds(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> jackson2JsonMessageConverter;<br>&#125;<br></code></pre></td></tr></table></figure>


<h4 id="3-5-3-æ¥æ”¶æ¶ˆæ¯"><a href="#3-5-3-æ¥æ”¶æ¶ˆæ¯" class="headerlink" title="3.5.3 æ¥æ”¶æ¶ˆæ¯"></a>3.5.3 æ¥æ”¶æ¶ˆæ¯</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(queues = &quot;object.queue&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenSimpleQueueMessage</span><span class="hljs-params">(Map&lt;String, Object&gt; msg)</span> <span class="hljs-keyword">throws</span> InterruptedException &#123;<br>    System.out.println(<span class="hljs-string">&quot;æ¶ˆè´¹è€…æ¥æ”¶åˆ°object.queueæ¶ˆæ¯ï¼šã€&quot;</span> + msg + <span class="hljs-string">&quot;ã€‘&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="4-MQæ¶ˆæ¯çš„å¯é æ€§"><a href="#4-MQæ¶ˆæ¯çš„å¯é æ€§" class="headerlink" title="4. MQæ¶ˆæ¯çš„å¯é æ€§"></a>4. MQæ¶ˆæ¯çš„å¯é æ€§</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰çš„å¯é æ€§æŒ‡çš„æ˜¯<strong>æ¶ˆæ¯åœ¨ç”Ÿäº§ã€ä¼ è¾“å’Œæ¶ˆè´¹çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸¢å¤±ã€ä¸ä¼šé‡å¤ã€ä¸è¢«ç¯¡æ”¹ï¼Œå¹¶ä¸”èƒ½å¤ŸæŒ‰é¢„æœŸè¢«æ­£ç¡®æ¶ˆè´¹</strong>ã€‚ç¡®ä¿ MQ å¯é æ€§å¯¹äºä¿è¯ä¸šåŠ¡æ•°æ®ä¸€è‡´æ€§ã€æé«˜ç³»ç»Ÿç¨³å®šæ€§è‡³å…³é‡è¦ã€‚</p>
<p>æ¶ˆæ¯ä»ç”Ÿäº§è€…åˆ°æ¶ˆè´¹è€…çš„æ¯ä¸€æ­¥éƒ½å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼š</p>
<ul>
<li><strong>å‘é€æ¶ˆæ¯æ—¶ä¸¢å¤±</strong>ï¼š<ul>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶è¿æ¥MQå¤±è´¥</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQåæœªæ‰¾åˆ°Exchange</li>
<li>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ°è¾¾MQçš„Exchangeåï¼Œæœªæ‰¾åˆ°åˆé€‚çš„Queue</li>
<li>æ¶ˆæ¯åˆ°è¾¾MQåï¼Œå¤„ç†æ¶ˆæ¯çš„è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸</li>
</ul>
</li>
<li><strong>MQå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</strong>ï¼š<ul>
<li>æ¶ˆæ¯åˆ°è¾¾MQï¼Œä¿å­˜åˆ°é˜Ÿåˆ—åï¼Œå°šæœªæ¶ˆè´¹å°±çªç„¶å®•æœº</li>
</ul>
</li>
<li><strong>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯æ—¶</strong>ï¼š<ul>
<li>æ¶ˆæ¯æ¥æ”¶åå°šæœªå¤„ç†çªç„¶å®•æœº</li>
<li>æ¶ˆæ¯æ¥æ”¶åå¤„ç†è¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸</li>
</ul>
</li>
</ul>
<h3 id="4-1-å‘é€è€…çš„å¯é æ€§"><a href="#4-1-å‘é€è€…çš„å¯é æ€§" class="headerlink" title="4.1 å‘é€è€…çš„å¯é æ€§"></a>4.1 å‘é€è€…çš„å¯é æ€§</h3><h4 id="4-1-1-ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"><a href="#4-1-1-ç”Ÿäº§è€…é‡è¯•æœºåˆ¶" class="headerlink" title="4.1.1 ç”Ÿäº§è€…é‡è¯•æœºåˆ¶"></a>4.1.1 ç”Ÿäº§è€…é‡è¯•æœºåˆ¶</h4><p>ç”Ÿäº§è€…å‘é€æ¶ˆæ¯æ—¶ï¼Œå‡ºç°äº†ç½‘ç»œæ•…éšœï¼Œå¯¼è‡´ä¸MQçš„è¿æ¥ä¸­æ–­ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSpringAMQPæä¾›çš„æ¶ˆæ¯å‘é€æ—¶çš„<strong>é‡è¯•æœºåˆ¶ã€‚å³ï¼šå½“RabbitTemplateä¸MQè¿æ¥è¶…æ—¶åï¼Œå¤šæ¬¡é‡è¯•</strong>ã€‚</p>
<p>ä¿®æ”¹publisheræ¨¡å—çš„application.yamlæ–‡ä»¶ï¼Œæ·»åŠ ä¸‹é¢çš„å†…å®¹ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">connection-timeout:</span> <span class="hljs-string">1s</span> <span class="hljs-comment"># è®¾ç½®MQçš„è¿æ¥è¶…æ—¶æ—¶é—´</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">retry:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯è¶…æ—¶é‡è¯•æœºåˆ¶</span><br>        <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># å¤±è´¥åçš„åˆå§‹ç­‰å¾…æ—¶é—´</span><br>        <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># å¤±è´¥åä¸‹æ¬¡çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = initial-interval * multiplier</span><br>        <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span><br></code></pre></td></tr></table></figure>

<p>æ³¨æ„ï¼šå½“ç½‘ç»œä¸ç¨³å®šçš„æ—¶å€™ï¼Œåˆ©ç”¨é‡è¯•æœºåˆ¶å¯ä»¥æœ‰æ•ˆæé«˜æ¶ˆæ¯å‘é€çš„æˆåŠŸç‡ã€‚ä¸è¿‡SpringAMQPæä¾›çš„<strong>é‡è¯•æœºåˆ¶æ˜¯é˜»å¡å¼çš„é‡è¯•</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šæ¬¡é‡è¯•ç­‰å¾…çš„è¿‡ç¨‹ä¸­ï¼Œå½“å‰çº¿ç¨‹æ˜¯è¢«é˜»å¡çš„ã€‚<br>å¦‚æœå¯¹äºä¸šåŠ¡æ€§èƒ½æœ‰è¦æ±‚ï¼Œå»ºè®®ç¦ç”¨é‡è¯•æœºåˆ¶ã€‚å¦‚æœä¸€å®šè¦ä½¿ç”¨ï¼Œè¯·åˆç†é…ç½®ç­‰å¾…æ—¶é•¿å’Œé‡è¯•æ¬¡æ•°ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è€ƒè™‘ä½¿ç”¨å¼‚æ­¥çº¿ç¨‹æ¥æ‰§è¡Œå‘é€æ¶ˆæ¯çš„ä»£ç ã€‚</p>
<h4 id="4-1-2-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶-ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯"><a href="#4-1-2-ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶-ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯" class="headerlink" title="4.1.2 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶(ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯)"></a>4.1.2 ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶(ä¸€èˆ¬æƒ…å†µä¸‹ä¸å»ºè®®å¼€å¯)</h4><p>RabbitMQæä¾›äº†ç”Ÿäº§è€…æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ŒåŒ…æ‹¬Publisher Confirmå’ŒPublisher Returnä¸¤ç§ã€‚åœ¨å¼€å¯ç¡®è®¤æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œå½“ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ç»™MQåï¼ŒMQä¼šæ ¹æ®æ¶ˆæ¯å¤„ç†çš„æƒ…å†µè¿”å›ä¸åŒçš„å›æ‰§ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.9.png" srcset="/img/loading.gif" lazyload></p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>å½“æ¶ˆæ¯æŠ•é€’åˆ°MQï¼Œä½†æ˜¯è·¯ç”±å¤±è´¥æ—¶ï¼Œé€šè¿‡Publisher Returnè¿”å›å¼‚å¸¸ä¿¡æ¯ï¼ŒåŒæ—¶è¿”å›ackçš„ç¡®è®¤ä¿¡æ¯ï¼Œä»£è¡¨æŠ•é€’æˆåŠŸ</li>
<li>ä¸´æ—¶æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜ŸæˆåŠŸï¼Œè¿”å›ACKï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li>
<li>æŒä¹…æ¶ˆæ¯æŠ•é€’åˆ°äº†MQï¼Œå¹¶ä¸”å…¥é˜Ÿå®ŒæˆæŒä¹…åŒ–ï¼Œè¿”å›ACK ï¼Œå‘ŠçŸ¥æŠ•é€’æˆåŠŸ</li>
<li>å…¶å®ƒæƒ…å†µéƒ½ä¼šè¿”å›NACKï¼Œå‘ŠçŸ¥æŠ•é€’å¤±è´¥</li>
</ul>
<h5 id="4-1-2-1-å¼€å¯ç”Ÿäº§è€…ç¡®è®¤"><a href="#4-1-2-1-å¼€å¯ç”Ÿäº§è€…ç¡®è®¤" class="headerlink" title="4.1.2.1 å¼€å¯ç”Ÿäº§è€…ç¡®è®¤"></a>4.1.2.1 å¼€å¯ç”Ÿäº§è€…ç¡®è®¤</h5><p>åœ¨publisheræ¨¡å—çš„application.yamlä¸­æ·»åŠ é…ç½®ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">publisher-confirm-type:</span> <span class="hljs-string">correlated</span> <span class="hljs-comment"># å¼€å¯publisher confirmæœºåˆ¶ï¼Œå¹¶è®¾ç½®confirmç±»å‹</span><br>    <span class="hljs-attr">publisher-returns:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯publisher returnæœºåˆ¶</span><br></code></pre></td></tr></table></figure>

<p>è¿™é‡Œpublisher-confirm-typeæœ‰ä¸‰ç§æ¨¡å¼å¯é€‰ï¼š</p>
<ul>
<li>noneï¼šå…³é—­confirmæœºåˆ¶</li>
<li>simpleï¼šåŒæ­¥é˜»å¡ç­‰å¾…MQçš„å›æ‰§</li>
<li>correlatedï¼šMQå¼‚æ­¥å›è°ƒè¿”å›å›æ‰§(æ¨è)</li>
</ul>
<h5 id="4-1-2-2-å®šä¹‰ReturnCallback"><a href="#4-1-2-2-å®šä¹‰ReturnCallback" class="headerlink" title="4.1.2.2 å®šä¹‰ReturnCallback"></a>4.1.2.2 å®šä¹‰ReturnCallback</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MqConfig</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br>        rabbitTemplate.setReturnsCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RabbitTemplate</span>.ReturnsCallback() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnedMessage</span><span class="hljs-params">(ReturnedMessage returned)</span> &#123;<br>                log.error(<span class="hljs-string">&quot;è§¦å‘return callback,&quot;</span>);<br>                log.debug(<span class="hljs-string">&quot;exchange: &#123;&#125;&quot;</span>, returned.getExchange());<br>                log.debug(<span class="hljs-string">&quot;routingKey: &#123;&#125;&quot;</span>, returned.getRoutingKey());<br>                log.debug(<span class="hljs-string">&quot;message: &#123;&#125;&quot;</span>, returned.getMessage());<br>                log.debug(<span class="hljs-string">&quot;replyCode: &#123;&#125;&quot;</span>, returned.getReplyCode());<br>                log.debug(<span class="hljs-string">&quot;replyText: &#123;&#125;&quot;</span>, returned.getReplyText());<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="4-1-2-3-å®šä¹‰ConfirmCallback"><a href="#4-1-2-3-å®šä¹‰ConfirmCallback" class="headerlink" title="4.1.2.3 å®šä¹‰ConfirmCallback"></a>4.1.2.3 å®šä¹‰ConfirmCallback</h5><p>CorrelationDataä¸­åŒ…å«ä¸¤ä¸ªæ ¸å¿ƒçš„ä¸œè¥¿ï¼š</p>
<ul>
<li>idï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡ç¤ºï¼ŒMQå¯¹ä¸åŒçš„æ¶ˆæ¯çš„å›æ‰§ä»¥æ­¤åšåˆ¤æ–­ï¼Œé¿å…æ··æ·†</li>
<li>SettableListenableFutureï¼šå›æ‰§ç»“æœçš„Futureå¯¹è±¡</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPublisherConfirm</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºCorrelationData</span><br>    <span class="hljs-type">CorrelationData</span> <span class="hljs-variable">cd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CorrelationData</span>();<br>    <span class="hljs-comment">// 2.ç»™Futureæ·»åŠ ConfirmCallback</span><br>    cd.getFuture().addCallback(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ListenableFutureCallback</span>&lt;CorrelationData.Confirm&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onFailure</span><span class="hljs-params">(Throwable ex)</span> &#123;<br>            <span class="hljs-comment">// 2.1.Futureå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¤„ç†é€»è¾‘ï¼ŒåŸºæœ¬ä¸ä¼šè§¦å‘</span><br>            log.error(<span class="hljs-string">&quot;send message fail&quot;</span>, ex);<br>        &#125;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(CorrelationData.Confirm result)</span> &#123;<br>            <span class="hljs-comment">// 2.2.Futureæ¥æ”¶åˆ°å›æ‰§çš„å¤„ç†é€»è¾‘ï¼Œå‚æ•°ä¸­çš„resultå°±æ˜¯å›æ‰§å†…å®¹</span><br>            <span class="hljs-keyword">if</span>(result.isAck())&#123; <span class="hljs-comment">// result.isAck()ï¼Œbooleanç±»å‹ï¼Œtrueä»£è¡¨ackå›æ‰§ï¼Œfalse ä»£è¡¨ nackå›æ‰§</span><br>                log.debug(<span class="hljs-string">&quot;å‘é€æ¶ˆæ¯æˆåŠŸï¼Œæ”¶åˆ° ack!&quot;</span>);<br>            &#125;<span class="hljs-keyword">else</span>&#123; <span class="hljs-comment">// result.getReason()ï¼ŒStringç±»å‹ï¼Œè¿”å›nackæ—¶çš„å¼‚å¸¸æè¿°</span><br>                log.error(<span class="hljs-string">&quot;å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œæ”¶åˆ° nack, reason : &#123;&#125;&quot;</span>, result.getReason());<br>            &#125;<br>        &#125;<br>    &#125;);<br>    <span class="hljs-comment">// 3.å‘é€æ¶ˆæ¯</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;hmall.direct&quot;</span>, <span class="hljs-string">&quot;q&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>, cd);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-2-MQçš„å¯é æ€§"><a href="#4-2-MQçš„å¯é æ€§" class="headerlink" title="4.2 MQçš„å¯é æ€§"></a>4.2 MQçš„å¯é æ€§</h3><p>æ¶ˆæ¯åˆ°è¾¾MQä»¥åï¼Œå› ä¸º<strong>MQæ˜¯åŸºäºå†…å­˜å­˜å‚¨çš„ï¼Œå¦‚æœå†…å­˜ç©ºé—´è¢«æ¶ˆæ¯å æ»¡ï¼Œå¦‚æœMQä¸èƒ½åŠæ—¶ä¿å­˜ï¼Œä¹Ÿä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±</strong><br>æœ‰ä¸¤ç§è§£å†³æ–¹æ³•ï¼š</p>
<ul>
<li>æ•°æ®æŒä¹…åŒ–</li>
<li>LazyQueue(æ¨è)</li>
</ul>
<h4 id="4-2-1-æ•°æ®æŒä¹…åŒ–"><a href="#4-2-1-æ•°æ®æŒä¹…åŒ–" class="headerlink" title="4.2.1 æ•°æ®æŒä¹…åŒ–"></a>4.2.1 æ•°æ®æŒä¹…åŒ–</h4><p>ä¸ºäº†æå‡æ€§èƒ½ï¼Œé»˜è®¤æƒ…å†µä¸‹MQçš„æ•°æ®éƒ½æ˜¯åœ¨å†…å­˜å­˜å‚¨çš„ä¸´æ—¶æ•°æ®ï¼Œé‡å¯åå°±ä¼šæ¶ˆå¤±ã€‚ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ï¼Œå¿…é¡»é…ç½®æ•°æ®æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>äº¤æ¢æœºæŒä¹…åŒ–</strong></li>
<li><strong>é˜Ÿåˆ—æŒä¹…åŒ–</strong></li>
<li><strong>æ¶ˆæ¯æŒä¹…åŒ–</strong></li>
</ul>
<p>åœ¨æ§åˆ¶å°é…ç½®ç›¸å…³çš„æŒä¹…åŒ–æ¨¡å¼ï¼Œå³å¯å¼€å¯æ•°æ®æŒä¹…åŒ–</p>
<h4 id="4-2-2-LazyQueueæƒ°æ€§é˜Ÿåˆ—"><a href="#4-2-2-LazyQueueæƒ°æ€§é˜Ÿåˆ—" class="headerlink" title="4.2.2 LazyQueueæƒ°æ€§é˜Ÿåˆ—"></a>4.2.2 LazyQueueæƒ°æ€§é˜Ÿåˆ—</h4><p>ä»RabbitMQçš„3.6.0ç‰ˆæœ¬å¼€å§‹ï¼Œå°±å¢åŠ äº†Lazy Queuesçš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æƒ°æ€§é˜Ÿåˆ—ã€‚æƒ°æ€§é˜Ÿåˆ—çš„ç‰¹å¾å¦‚ä¸‹ï¼š</p>
<ul>
<li><strong>æ¥æ”¶åˆ°æ¶ˆæ¯åç›´æ¥å­˜å…¥ç£ç›˜è€Œéå†…å­˜</strong></li>
<li>æ¶ˆè´¹è€…è¦<strong>æ¶ˆè´¹æ¶ˆæ¯æ—¶æ‰ä¼šä»ç£ç›˜ä¸­è¯»å–å¹¶åŠ è½½åˆ°å†…å­˜</strong>ï¼ˆä¹Ÿå°±æ˜¯æ‡’åŠ è½½ï¼‰</li>
<li>æ”¯æŒæ•°ç™¾ä¸‡æ¡çš„æ¶ˆæ¯å­˜å‚¨</li>
</ul>
<p>è€Œåœ¨3.12ç‰ˆæœ¬ä¹‹åï¼ŒLazyQueueå·²ç»æˆä¸ºæ‰€æœ‰é˜Ÿåˆ—çš„é»˜è®¤æ ¼å¼ã€‚å› æ­¤å®˜æ–¹æ¨èå‡çº§MQä¸º3.12ç‰ˆæœ¬æˆ–è€…æ‰€æœ‰é˜Ÿåˆ—éƒ½è®¾ç½®ä¸ºLazyQueueæ¨¡å¼ã€‚</p>
<h3 id="4-3-æ¶ˆè´¹è€…çš„å¯é æ€§"><a href="#4-3-æ¶ˆè´¹è€…çš„å¯é æ€§" class="headerlink" title="4.3 æ¶ˆè´¹è€…çš„å¯é æ€§"></a>4.3 æ¶ˆè´¹è€…çš„å¯é æ€§</h3><p>æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…å¹¶ä¸ä»£è¡¨å°±ä¸€å®šè¢«æ­£ç¡®æ¶ˆè´¹äº†ï¼Œå¯èƒ½å‡ºç°çš„æ•…éšœæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>æ¶ˆæ¯æŠ•é€’çš„è¿‡ç¨‹ä¸­å‡ºç°äº†<strong>ç½‘ç»œæ•…éšœ</strong></li>
<li><strong>æ¶ˆè´¹è€…</strong>æ¥æ”¶åˆ°æ¶ˆæ¯åçªç„¶<strong>å®•æœº</strong></li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œ<strong>å› å¤„ç†ä¸å½“å¯¼è‡´å¼‚å¸¸</strong></li>
</ul>
<h4 id="4-3-1-æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"><a href="#4-3-1-æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶" class="headerlink" title="4.3.1 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶"></a>4.3.1 æ¶ˆè´¹è€…ç¡®è®¤æœºåˆ¶</h4><p>æ¶ˆè´¹è€…å¤„ç†æ¶ˆæ¯ç»“æŸåï¼Œåº”è¯¥å‘RabbitMQå‘é€ä¸€ä¸ªå›æ‰§ï¼Œå‘ŠçŸ¥RabbitMQè‡ªå·±æ¶ˆæ¯å¤„ç†çŠ¶æ€ã€‚å›æ‰§æœ‰ä¸‰ç§å¯é€‰å€¼ï¼š</p>
<ul>
<li>ackï¼š<strong>æˆåŠŸå¤„ç†æ¶ˆæ¯</strong>ï¼ŒRabbitMQ<strong>ä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</strong></li>
<li>nackï¼š<strong>æ¶ˆæ¯å¤„ç†å¤±è´¥</strong>ï¼ŒRabbitMQéœ€è¦<strong>å†æ¬¡æŠ•é€’æ¶ˆæ¯</strong></li>
<li>rejectï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥å¹¶æ‹’ç»è¯¥æ¶ˆæ¯ï¼ŒRabbitMQä»é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥æ¶ˆæ¯</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.10.png" srcset="/img/loading.gif" lazyload></p>
<p>SpringAMQPå¸®æˆ‘ä»¬å®ç°äº†æ¶ˆæ¯ç¡®è®¤ã€‚å¹¶å…è®¸æˆ‘ä»¬é€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ACKå¤„ç†æ–¹å¼ï¼Œæœ‰ä¸‰ç§æ¨¡å¼ï¼š</p>
<ul>
<li>noneï¼šä¸å¤„ç†ã€‚å³æ¶ˆæ¯æŠ•é€’ç»™æ¶ˆè´¹è€…åç«‹åˆ»ackï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»ä»MQåˆ é™¤ã€‚éå¸¸ä¸å®‰å…¨ï¼Œä¸å»ºè®®ä½¿ç”¨</li>
<li>manualï¼šæ‰‹åŠ¨æ¨¡å¼ã€‚éœ€è¦è‡ªå·±åœ¨ä¸šåŠ¡ä»£ç ä¸­è°ƒç”¨apiï¼Œå‘é€ackæˆ–rejectï¼Œå­˜åœ¨ä¸šåŠ¡å…¥ä¾µï¼Œä½†æ›´çµæ´»</li>
<li>autoï¼šè‡ªåŠ¨æ¨¡å¼ã€‚SpringAMQPåˆ©ç”¨AOPå¯¹æˆ‘ä»¬çš„æ¶ˆæ¯å¤„ç†é€»è¾‘åšäº†ç¯ç»•å¢å¼ºï¼Œå½“ä¸šåŠ¡æ­£å¸¸æ‰§è¡Œæ—¶åˆ™è‡ªåŠ¨è¿”å›ack.  å½“ä¸šåŠ¡å‡ºç°å¼‚å¸¸æ—¶ï¼Œæ ¹æ®å¼‚å¸¸åˆ¤æ–­è¿”å›ä¸åŒç»“æœï¼š<ul>
<li>å¦‚æœæ˜¯ä¸šåŠ¡å¼‚å¸¸ï¼Œä¼šè‡ªåŠ¨è¿”å›nackï¼›</li>
<li>å¦‚æœæ˜¯æ¶ˆæ¯å¤„ç†æˆ–æ ¡éªŒå¼‚å¸¸ï¼Œè‡ªåŠ¨è¿”å›reject;</li>
</ul>
</li>
</ul>
<p>ä¿®æ”¹SpringAMQPçš„ACKå¤„ç†æ–¹å¼:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">acknowledge-mode:</span> <span class="hljs-string">none</span> <span class="hljs-comment"># ä¸åšå¤„ç†</span><br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-å¤±è´¥é‡è¯•æœºåˆ¶"><a href="#4-3-2-å¤±è´¥é‡è¯•æœºåˆ¶" class="headerlink" title="4.3.2 å¤±è´¥é‡è¯•æœºåˆ¶"></a>4.3.2 å¤±è´¥é‡è¯•æœºåˆ¶</h4><p>å½“æ¶ˆè´¹è€…å‡ºç°å¼‚å¸¸åï¼Œæ¶ˆæ¯ä¼šä¸æ–­requeueï¼ˆé‡å…¥é˜Ÿï¼‰åˆ°é˜Ÿåˆ—ï¼Œå†é‡æ–°å‘é€ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ¶ˆè´¹è€…å†æ¬¡æ‰§è¡Œä¾ç„¶å‡ºé”™ï¼Œæ¶ˆæ¯ä¼šå†æ¬¡requeueåˆ°é˜Ÿåˆ—ï¼Œå†æ¬¡æŠ•é€’ï¼Œç›´åˆ°æ¶ˆæ¯å¤„ç†æˆåŠŸä¸ºæ­¢ã€‚<br>æç«¯æƒ…å†µå°±æ˜¯æ¶ˆè´¹è€…ä¸€ç›´æ— æ³•æ‰§è¡ŒæˆåŠŸï¼Œé‚£ä¹ˆ<strong>æ¶ˆæ¯requeueå°±ä¼šæ— é™å¾ªç¯</strong>ï¼Œå¯¼è‡´mqçš„æ¶ˆæ¯å¤„ç†é£™å‡ï¼Œå¸¦æ¥ä¸å¿…è¦çš„å‹åŠ›ã€‚</p>
<p>ä¿®æ”¹consumeræœåŠ¡çš„application.ymlæ–‡ä»¶ï¼š</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">rabbitmq:</span><br>    <span class="hljs-attr">listener:</span><br>      <span class="hljs-attr">simple:</span><br>        <span class="hljs-attr">retry:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># å¼€å¯æ¶ˆè´¹è€…å¤±è´¥é‡è¯•</span><br>          <span class="hljs-attr">initial-interval:</span> <span class="hljs-string">1000ms</span> <span class="hljs-comment"># åˆè¯†çš„å¤±è´¥ç­‰å¾…æ—¶é•¿ä¸º1ç§’</span><br>          <span class="hljs-attr">multiplier:</span> <span class="hljs-number">1</span> <span class="hljs-comment"># å¤±è´¥çš„ç­‰å¾…æ—¶é•¿å€æ•°ï¼Œä¸‹æ¬¡ç­‰å¾…æ—¶é•¿ = multiplier * last-interval</span><br>          <span class="hljs-attr">max-attempts:</span> <span class="hljs-number">3</span> <span class="hljs-comment"># æœ€å¤§é‡è¯•æ¬¡æ•°</span><br>          <span class="hljs-attr">stateless:</span> <span class="hljs-literal">true</span> <span class="hljs-comment"># trueæ— çŠ¶æ€ï¼›falseæœ‰çŠ¶æ€ã€‚å¦‚æœä¸šåŠ¡ä¸­åŒ…å«äº‹åŠ¡ï¼Œè¿™é‡Œæ”¹ä¸ºfalse</span><br></code></pre></td></tr></table></figure>

<ul>
<li><strong>é‡è¯•è¾¾åˆ°æœ€å¤§æ¬¡æ•°åï¼ŒSpringä¼šè¿”å›rejectï¼Œæ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒ</strong></li>
</ul>
<h4 id="4-3-3-å¤±è´¥å¤„ç†ç­–ç•¥"><a href="#4-3-3-å¤±è´¥å¤„ç†ç­–ç•¥" class="headerlink" title="4.3.3 å¤±è´¥å¤„ç†ç­–ç•¥"></a>4.3.3 å¤±è´¥å¤„ç†ç­–ç•¥</h4><p>Springå…è®¸æˆ‘ä»¬è‡ªå®šä¹‰é‡è¯•æ¬¡æ•°è€—å°½åçš„æ¶ˆæ¯å¤„ç†ç­–ç•¥ï¼Œè¿™ä¸ªç­–ç•¥æ˜¯ç”±MessageRecoveryæ¥å£æ¥å®šä¹‰çš„ï¼Œå®ƒæœ‰3ä¸ªä¸åŒå®ç°ï¼š</p>
<ul>
<li>RejectAndDontRequeueRecovererï¼š<strong>é‡è¯•è€—å°½åï¼Œç›´æ¥rejectï¼Œä¸¢å¼ƒæ¶ˆæ¯</strong>ã€‚é»˜è®¤å°±æ˜¯è¿™ç§æ–¹å¼ </li>
<li>ImmediateRequeueMessageRecovererï¼šé‡è¯•è€—å°½åï¼Œè¿”å›nackï¼Œæ¶ˆæ¯é‡æ–°å…¥é˜Ÿ </li>
<li>RepublishMessageRecovererï¼š<strong>é‡è¯•è€—å°½åï¼Œå°†å¤±è´¥æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šçš„äº¤æ¢æœº</strong> (æ¨è)</li>
</ul>
<ul>
<li>RepublishMessageRecoverer: å¤±è´¥åå°†æ¶ˆæ¯æŠ•é€’åˆ°ä¸€ä¸ªæŒ‡å®šçš„ï¼Œä¸“é—¨å­˜æ”¾å¼‚å¸¸æ¶ˆæ¯çš„é˜Ÿåˆ—ï¼Œåç»­ç”±äººå·¥é›†ä¸­å¤„ç†ã€‚</li>
</ul>
<p>åœ¨consumeræœåŠ¡ä¸­å®šä¹‰å¤„ç†å¤±è´¥æ¶ˆæ¯çš„äº¤æ¢æœºå’Œé˜Ÿåˆ—,å®šä¹‰ä¸€ä¸ªRepublishMessageRecovererï¼Œå…³è”é˜Ÿåˆ—å’Œäº¤æ¢æœº</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ConditionalOnProperty(name = &quot;spring.rabbitmq.listener.simple.retry.enabled&quot;, havingValue = &quot;true&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorMessageConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title function_">errorMessageExchange</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DirectExchange</span>(<span class="hljs-string">&quot;error.direct&quot;</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Queue <span class="hljs-title function_">errorQueue</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Queue</span>(<span class="hljs-string">&quot;error.queue&quot;</span>, <span class="hljs-literal">true</span>);<br>    &#125;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Binding <span class="hljs-title function_">errorBinding</span><span class="hljs-params">(Queue errorQueue, DirectExchange errorMessageExchange)</span>&#123;<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(errorQueue).to(errorMessageExchange).with(<span class="hljs-string">&quot;error&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MessageRecoverer <span class="hljs-title function_">republishMessageRecoverer</span><span class="hljs-params">(RabbitTemplate rabbitTemplate)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RepublishMessageRecoverer</span>(rabbitTemplate, <span class="hljs-string">&quot;error.direct&quot;</span>, <span class="hljs-string">&quot;error&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-ä¸šåŠ¡å¹‚ç­‰æ€§"><a href="#4-4-ä¸šåŠ¡å¹‚ç­‰æ€§" class="headerlink" title="4.4 ä¸šåŠ¡å¹‚ç­‰æ€§"></a>4.4 ä¸šåŠ¡å¹‚ç­‰æ€§</h3><p>åœ¨ç¨‹åºå¼€å‘ä¸­ï¼Œåˆ™æ˜¯æŒ‡<strong>åŒä¸€ä¸ªä¸šåŠ¡ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡å¯¹ä¸šåŠ¡çŠ¶æ€çš„å½±å“æ˜¯ä¸€è‡´çš„</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<ul>
<li>æ ¹æ®idåˆ é™¤æ•°æ®</li>
<li>æŸ¥è¯¢æ•°æ®</li>
<li>æ–°å¢æ•°æ®</li>
</ul>
<p>æ•°æ®çš„æ›´æ–°å¾€å¾€ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœ<strong>é‡å¤æ‰§è¡Œå¯èƒ½é€ æˆä¸ä¸€æ ·çš„åæœ</strong>ã€‚æ¯”å¦‚ï¼š</p>
<ul>
<li>å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜çš„ä¸šåŠ¡ã€‚å¦‚æœå¤šæ¬¡æ¢å¤å°±ä¼šå‡ºç°åº“å­˜é‡å¤å¢åŠ çš„æƒ…å†µ</li>
<li>é€€æ¬¾ä¸šåŠ¡ã€‚é‡å¤é€€æ¬¾å¯¹å•†å®¶è€Œè¨€ä¼šæœ‰ç»æµæŸå¤±ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œ<strong>æˆ‘ä»¬è¦å°½å¯èƒ½é¿å…ä¸šåŠ¡è¢«é‡å¤æ‰§è¡Œ</strong>ã€‚</p>
<h4 id="4-4-1-å”¯ä¸€æ¶ˆæ¯ID"><a href="#4-4-1-å”¯ä¸€æ¶ˆæ¯ID" class="headerlink" title="4.4.1 å”¯ä¸€æ¶ˆæ¯ID"></a>4.4.1 å”¯ä¸€æ¶ˆæ¯ID</h4><ol>
<li>æ¯ä¸€æ¡æ¶ˆæ¯éƒ½ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„idï¼Œä¸æ¶ˆæ¯ä¸€èµ·æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚</li>
<li>æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åå¤„ç†è‡ªå·±çš„ä¸šåŠ¡ï¼Œä¸šåŠ¡å¤„ç†æˆåŠŸåå°†æ¶ˆæ¯IDä¿å­˜åˆ°æ•°æ®åº“</li>
<li><strong>å¦‚æœä¸‹æ¬¡åˆæ”¶åˆ°ç›¸åŒæ¶ˆæ¯ï¼Œå»æ•°æ®åº“æŸ¥è¯¢åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™ä¸ºé‡å¤æ¶ˆæ¯æ”¾å¼ƒå¤„ç†</strong>ã€‚</li>
</ol>
<p>SpringAMQPçš„MessageConverterè‡ªå¸¦äº†MessageIDçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åªè¦å¼€å¯è¿™ä¸ªåŠŸèƒ½å³å¯:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> MessageConverter <span class="hljs-title function_">messageConverter</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 1.å®šä¹‰æ¶ˆæ¯è½¬æ¢å™¨</span><br>    <span class="hljs-type">Jackson2JsonMessageConverter</span> <span class="hljs-variable">jjmc</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jackson2JsonMessageConverter</span>();<br>    <span class="hljs-comment">// 2.é…ç½®è‡ªåŠ¨åˆ›å»ºæ¶ˆæ¯idï¼Œç”¨äºè¯†åˆ«ä¸åŒæ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸šåŠ¡ä¸­åŸºäºIDåˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤æ¶ˆæ¯</span><br>    jjmc.setCreateMessageIds(<span class="hljs-literal">true</span>);<br>    <span class="hljs-keyword">return</span> jjmc;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-ä¸šåŠ¡åˆ¤æ–­"><a href="#4-4-2-ä¸šåŠ¡åˆ¤æ–­" class="headerlink" title="4.4.2 ä¸šåŠ¡åˆ¤æ–­"></a>4.4.2 ä¸šåŠ¡åˆ¤æ–­</h4><p>ä¸šåŠ¡åˆ¤æ–­å°±æ˜¯åŸºäºä¸šåŠ¡æœ¬èº«çš„é€»è¾‘æˆ–çŠ¶æ€æ¥åˆ¤æ–­æ˜¯å¦æ˜¯é‡å¤çš„è¯·æ±‚æˆ–æ¶ˆæ¯ã€‚<br>å½“å‰æ¡ˆä¾‹ä¸­ï¼Œå¤„ç†æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘æ˜¯æŠŠè®¢å•çŠ¶æ€ä»æœªæ”¯ä»˜ä¿®æ”¹ä¸ºå·²æ”¯ä»˜ã€‚å› æ­¤æˆ‘ä»¬å°±å¯ä»¥<strong>åœ¨æ‰§è¡Œä¸šåŠ¡æ—¶åˆ¤æ–­è®¢å•çŠ¶æ€æ˜¯å¦æ˜¯æœªæ”¯ä»˜</strong>ï¼Œå¦‚æœä¸æ˜¯åˆ™è¯æ˜è®¢å•å·²ç»è¢«å¤„ç†è¿‡ï¼Œæ— éœ€é‡å¤å¤„ç†ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.11.png" srcset="/img/loading.gif" lazyload></p>
<p>ä»¥æ”¯ä»˜ä¿®æ”¹è®¢å•çš„ä¸šåŠ¡ä¸ºä¾‹:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">markOrderPaySuccess</span><span class="hljs-params">(Long orderId)</span> &#123;<br>    <span class="hljs-comment">// 1.æŸ¥è¯¢è®¢å•</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">old</span> <span class="hljs-operator">=</span> getById(orderId);<br>    <span class="hljs-comment">// 2.åˆ¤æ–­è®¢å•çŠ¶æ€</span><br>    <span class="hljs-keyword">if</span> (old == <span class="hljs-literal">null</span> || old.getStatus() != <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-comment">// è®¢å•ä¸å­˜åœ¨æˆ–è€…è®¢å•çŠ¶æ€ä¸æ˜¯1ï¼Œæ”¾å¼ƒå¤„ç†</span><br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-comment">// 3.å°è¯•æ›´æ–°è®¢å•</span><br>    <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();<br>    order.setId(orderId);<br>    order.setStatus(<span class="hljs-number">2</span>);<br>    order.setPayTime(LocalDateTime.now());<br>    updateById(order);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-5-å…œåº•æ–¹æ¡ˆ"><a href="#4-5-å…œåº•æ–¹æ¡ˆ" class="headerlink" title="4.5 å…œåº•æ–¹æ¡ˆ"></a>4.5 å…œåº•æ–¹æ¡ˆ</h3><p>è™½ç„¶æˆ‘ä»¬åˆ©ç”¨å„ç§æœºåˆ¶å°½å¯èƒ½å¢åŠ äº†æ¶ˆæ¯çš„å¯é æ€§ï¼Œä½†ä¹Ÿä¸å¥½è¯´èƒ½ä¿è¯æ¶ˆæ¯100%çš„å¯é ã€‚ä¸‡ä¸€çœŸçš„MQé€šçŸ¥å¤±è´¥è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæœ‰æ²¡æœ‰å…¶å®ƒå…œåº•æ–¹æ¡ˆï¼Œèƒ½å¤Ÿç¡®ä¿è®¢å•çš„æ”¯ä»˜çŠ¶æ€ä¸€è‡´å‘¢ï¼Ÿ</p>
<p>æ—¢ç„¶MQé€šçŸ¥ä¸ä¸€å®šå‘é€åˆ°äº¤æ˜“æœåŠ¡ï¼Œé‚£ä¹ˆ<strong>äº¤æ˜“æœåŠ¡å°±å¿…é¡»è‡ªå·±ä¸»åŠ¨å»æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€</strong>ã€‚è¿™æ ·å³ä¾¿æ”¯ä»˜æœåŠ¡çš„MQé€šçŸ¥å¤±è´¥ï¼Œæˆ‘ä»¬ä¾ç„¶èƒ½<strong>é€šè¿‡ä¸»åŠ¨æŸ¥è¯¢æ¥ä¿è¯è®¢å•çŠ¶æ€çš„ä¸€è‡´</strong>ã€‚</p>
<p><img src="/img/blogs/java/springcloud/mq.12.png" srcset="/img/loading.gif" lazyload></p>
<p>é€šå¸¸æˆ‘ä»¬é‡‡å–çš„æªæ–½å°±æ˜¯åˆ©ç”¨<strong>å®šæ—¶ä»»åŠ¡å®šæœŸæŸ¥è¯¢</strong>ï¼Œä¾‹å¦‚æ¯éš”20ç§’å°±æŸ¥è¯¢ä¸€æ¬¡ï¼Œ<strong>å¹¶åˆ¤æ–­æ”¯ä»˜çŠ¶æ€</strong>ã€‚å¦‚æœå‘ç°è®¢å•å·²ç»æ”¯ä»˜ï¼Œåˆ™ç«‹åˆ»æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜å³å¯ã€‚</p>
<h3 id="4-6-æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"><a href="#4-6-æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ" class="headerlink" title="4.6 æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ"></a>4.6 æ”¯ä»˜æœåŠ¡ä¸äº¤æ˜“æœåŠ¡ä¹‹é—´çš„è®¢å•çŠ¶æ€ä¸€è‡´æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ</h3><ul>
<li>é¦–å…ˆï¼Œæ”¯ä»˜æœåŠ¡ä¼šæ­£åœ¨ç”¨æˆ·æ”¯ä»˜æˆåŠŸä»¥ååˆ©ç”¨MQæ¶ˆæ¯é€šçŸ¥äº¤æ˜“æœåŠ¡ï¼Œå®Œæˆè®¢å•çŠ¶æ€åŒæ­¥ã€‚</li>
<li>å…¶æ¬¡ï¼Œä¸ºäº†ä¿è¯MQæ¶ˆæ¯çš„å¯é æ€§ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ç”Ÿäº§è€…ç¡®è®¤æœºåˆ¶ã€æ¶ˆè´¹è€…ç¡®è®¤ã€æ¶ˆè´¹è€…å¤±è´¥é‡è¯•ç­‰ç­–ç•¥ï¼Œç¡®ä¿æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§</li>
<li>æœ€åï¼Œæˆ‘ä»¬è¿˜åœ¨äº¤æ˜“æœåŠ¡è®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œå®šæœŸæŸ¥è¯¢è®¢å•æ”¯ä»˜çŠ¶æ€ã€‚è¿™æ ·å³ä¾¿MQé€šçŸ¥å¤±è´¥ï¼Œè¿˜å¯ä»¥åˆ©ç”¨å®šæ—¶ä»»åŠ¡ä½œä¸ºå…œåº•æ–¹æ¡ˆï¼Œç¡®ä¿è®¢å•æ”¯ä»˜çŠ¶æ€çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚</li>
</ul>
<h2 id="5-å»¶è¿Ÿæ¶ˆæ¯"><a href="#5-å»¶è¿Ÿæ¶ˆæ¯" class="headerlink" title="5. å»¶è¿Ÿæ¶ˆæ¯"></a>5. å»¶è¿Ÿæ¶ˆæ¯</h2><p>å¯¹äºè¶…è¿‡ä¸€å®šæ—¶é—´æœªæ”¯ä»˜çš„è®¢å•ï¼Œåº”è¯¥ç«‹åˆ»å–æ¶ˆè®¢å•å¹¶é‡Šæ”¾å ç”¨çš„åº“å­˜ã€‚åƒè¿™ç§<strong>åœ¨ä¸€æ®µæ—¶é—´ä»¥åæ‰æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå»¶è¿Ÿä»»åŠ¡</strong>ï¼Œè€Œè¦å®ç°å»¶è¿Ÿä»»åŠ¡ï¼Œæœ€ç®€å•çš„æ–¹æ¡ˆå°±æ˜¯åˆ©ç”¨MQçš„å»¶è¿Ÿæ¶ˆæ¯äº†ã€‚</p>
<p>åœ¨RabbitMQä¸­å®ç°å»¶è¿Ÿæ¶ˆæ¯ä¹Ÿæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š</p>
<ul>
<li>æ­»ä¿¡äº¤æ¢æœº+TTL</li>
<li>å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶(æ¨è)</li>
</ul>
<h3 id="5-1-æ­»ä¿¡äº¤æ¢æœº"><a href="#5-1-æ­»ä¿¡äº¤æ¢æœº" class="headerlink" title="5.1 æ­»ä¿¡äº¤æ¢æœº"></a>5.1 æ­»ä¿¡äº¤æ¢æœº</h3><p>å½“ä¸€ä¸ªé˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ»¡è¶³ä¸‹åˆ—æƒ…å†µä¹‹ä¸€æ—¶ï¼Œå¯ä»¥æˆä¸ºæ­»ä¿¡ï¼ˆdead letterï¼‰ï¼š</p>
<ul>
<li>æ¶ˆè´¹è€…ä½¿ç”¨basic.rejectæˆ– basic.nackå£°æ˜æ¶ˆè´¹å¤±è´¥ï¼Œå¹¶ä¸”æ¶ˆæ¯çš„requeueå‚æ•°è®¾ç½®ä¸ºfalse</li>
<li>æ¶ˆæ¯æ˜¯ä¸€ä¸ªè¿‡æœŸæ¶ˆæ¯ï¼Œè¶…æ—¶æ— äººæ¶ˆè´¹</li>
<li>è¦æŠ•é€’çš„é˜Ÿåˆ—æ¶ˆæ¯æ»¡äº†ï¼Œæ— æ³•æŠ•é€’</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.13.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>åˆ©ç”¨ TTL è®©æ¶ˆæ¯åœ¨æ™®é€šé˜Ÿåˆ—ä¸­å»¶è¿Ÿä¸€æ®µæ—¶é—´ã€‚</li>
<li>è¶…æ—¶åï¼Œæ¶ˆæ¯è¿›å…¥æ­»ä¿¡äº¤æ¢æœºï¼Œå†è½¬å‘åˆ°çœŸæ­£çš„ç›®æ ‡é˜Ÿåˆ—ã€‚</li>
<li>æ¶ˆè´¹è€…ç›‘å¬ç›®æ ‡é˜Ÿåˆ—ï¼Œå»¶è¿Ÿæ—¶é—´ä¸€åˆ°ï¼Œæ‰ä¼šæ”¶åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="5-2-DelayExchangeæ’ä»¶-æ¨è"><a href="#5-2-DelayExchangeæ’ä»¶-æ¨è" class="headerlink" title="5.2 DelayExchangeæ’ä»¶(æ¨è)"></a>5.2 DelayExchangeæ’ä»¶(æ¨è)</h3><p>RabbitMQç¤¾åŒºæä¾›äº†ä¸€ä¸ªå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶æ¥å®ç°ç›¸åŒçš„æ•ˆæœ</p>
<p><a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">æ’ä»¶ä¸‹è½½åœ°å€</a></p>
<p><strong>å£°æ˜å»¶è¿Ÿäº¤æ¢æœº</strong>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RabbitListener(bindings = @QueueBinding(</span><br><span class="hljs-meta">        value = @Queue(name = &quot;delay.queue&quot;, durable = &quot;true&quot;),</span><br><span class="hljs-meta">        exchange = @Exchange(name = &quot;delay.direct&quot;, delayed = &quot;true&quot;),</span><br><span class="hljs-meta">        key = &quot;delay&quot;</span><br><span class="hljs-meta">))</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">listenDelayMessage</span><span class="hljs-params">(String msg)</span>&#123;<br>    log.info(<span class="hljs-string">&quot;æ¥æ”¶åˆ°delay.queueçš„å»¶è¿Ÿæ¶ˆæ¯ï¼š&#123;&#125;&quot;</span>, msg);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>å‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPublisherDelayMessage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºæ¶ˆæ¯</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;hello, delayed message&quot;</span>;<br>    <span class="hljs-comment">// 2.å‘é€æ¶ˆæ¯ï¼Œåˆ©ç”¨æ¶ˆæ¯åç½®å¤„ç†å™¨æ·»åŠ æ¶ˆæ¯å¤´</span><br>    rabbitTemplate.convertAndSend(<span class="hljs-string">&quot;delay.direct&quot;</span>, <span class="hljs-string">&quot;delay&quot;</span>, message, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessagePostProcessor</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Message <span class="hljs-title function_">postProcessMessage</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> AmqpException &#123;<br>            <span class="hljs-comment">// æ·»åŠ å»¶è¿Ÿæ¶ˆæ¯å±æ€§</span><br>            message.getMessageProperties().setDelay(<span class="hljs-number">5000</span>);<br>            <span class="hljs-keyword">return</span> message;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>ï¼š</p>
<ul>
<li>å¦‚æœæ¶ˆæ¯çš„å»¶è¿Ÿæ—¶é—´è®¾ç½®è¾ƒé•¿ï¼Œå¯èƒ½ä¼šå¯¼è‡´å †ç§¯çš„å»¶è¿Ÿæ¶ˆæ¯éå¸¸å¤šï¼Œä¼šå¸¦æ¥è¾ƒå¤§çš„CPUå¼€é”€ï¼Œä¸å»ºè®®è®¾ç½®å»¶è¿Ÿæ—¶é—´è¿‡é•¿çš„å»¶è¿Ÿæ¶ˆæ¯ã€‚</li>
</ul>
<h3 id="5-3-è¶…æ—¶è®¢å•é—®é¢˜"><a href="#5-3-è¶…æ—¶è®¢å•é—®é¢˜" class="headerlink" title="5.3 è¶…æ—¶è®¢å•é—®é¢˜"></a>5.3 è¶…æ—¶è®¢å•é—®é¢˜</h3><p>ç”¨æˆ·ä¸‹å•å®Œæˆå,å‘é€15åˆ†é’Ÿå»¶è¿Ÿæ¶ˆæ¯,åœ¨15åˆ†é’Ÿåæ¥æ”¶æ¶ˆæ¯,æ£€æŸ¥æ”¯ä»˜çŠ¶æ€:</p>
<ul>
<li>å·²æ”¯ä»˜:æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜</li>
<li>æœªæ”¯ä»˜:æ›´æ–°è®¢å•çŠ¶æ€ä¸ºå…³é—­è®¢å•,æ¢å¤å•†å“åº“å­˜</li>
</ul>
<p><img src="/img/blogs/java/springcloud/mq.14.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="å…­-Elasticsearch"><a href="#å…­-Elasticsearch" class="headerlink" title="å…­. Elasticsearch"></a>å…­. Elasticsearch</h1><h2 id="1-Elasticsearch"><a href="#1-Elasticsearch" class="headerlink" title="1. Elasticsearch"></a>1. Elasticsearch</h2><p>Elasticsearchæ˜¯ç”±elasticå…¬å¸å¼€å‘çš„ä¸€å¥—æœç´¢å¼•æ“æŠ€æœ¯</p>
<h3 id="1-1-å€’æ’ç´¢å¼•"><a href="#1-1-å€’æ’ç´¢å¼•" class="headerlink" title="1.1 å€’æ’ç´¢å¼•"></a>1.1 å€’æ’ç´¢å¼•</h3><p>å€’æ’ç´¢å¼•çš„æ¦‚å¿µæ˜¯åŸºäºMySQLè¿™æ ·çš„æ­£å‘ç´¢å¼•è€Œè¨€çš„</p>
<h4 id="1-1-1-æ­£å‘ç´¢å¼•"><a href="#1-1-1-æ­£å‘ç´¢å¼•" class="headerlink" title="1.1.1 æ­£å‘ç´¢å¼•"></a>1.1.1 æ­£å‘ç´¢å¼•</h4><ul>
<li>æ­£å‘ç´¢å¼•ï¼ˆForward Indexï¼‰é€šå¸¸æŒ‡çš„æ˜¯æ•°æ®åº“ç´¢å¼•æŒ‰ç…§å­—æ®µçš„è‡ªç„¶é¡ºåºè¿›è¡Œå­˜å‚¨å’ŒæŸ¥æ‰¾çš„ç´¢å¼•æ–¹å¼ã€‚åœ¨ MySQL ä¸­ï¼Œå¸¸è§çš„æ­£å‘ç´¢å¼•ä¸»è¦æ˜¯B+ æ ‘ç´¢å¼•ã€‚</li>
<li>å½“æœç´¢æ¡ä»¶ä¸º<strong>æ¨¡ç³ŠåŒ¹é…æ—¶ï¼Œç”±äºç´¢å¼•æ— æ³•ç”Ÿæ•ˆ</strong>ï¼Œå¯¼è‡´<strong>ä»ç´¢å¼•æŸ¥è¯¢é€€åŒ–ä¸ºå…¨è¡¨æ‰«æ</strong>ï¼Œæ•ˆç‡å¾ˆå·®ã€‚</li>
</ul>
<h4 id="1-1-2-å€’æ’ç´¢å¼•"><a href="#1-1-2-å€’æ’ç´¢å¼•" class="headerlink" title="1.1.2 å€’æ’ç´¢å¼•"></a>1.1.2 å€’æ’ç´¢å¼•</h4><p>ä¸¤ä¸ªæ¦‚å¿µï¼š</p>
<ul>
<li>æ–‡æ¡£ï¼ˆDocumentï¼‰ï¼šç”¨æ¥æœç´¢çš„æ•°æ®ï¼Œå…¶ä¸­çš„<strong>æ¯ä¸€æ¡æ•°æ®å°±æ˜¯ä¸€ä¸ªæ–‡æ¡£</strong>ã€‚ä¾‹å¦‚ä¸€ä¸ªç½‘é¡µã€ä¸€ä¸ªå•†å“ä¿¡æ¯</li>
<li>è¯æ¡ï¼ˆTermï¼‰ï¼šå¯¹æ–‡æ¡£æ•°æ®æˆ–ç”¨æˆ·æœç´¢æ•°æ®ï¼Œåˆ©ç”¨æŸç§ç®—æ³•åˆ†è¯ï¼Œå¾—åˆ°çš„å…·å¤‡å«ä¹‰çš„è¯è¯­å°±æ˜¯è¯æ¡ã€‚ä¾‹å¦‚ï¼šæˆ‘æ˜¯ä¸­å›½äººï¼Œå°±å¯ä»¥åˆ†ä¸ºï¼šæˆ‘ã€æ˜¯ã€ä¸­å›½äººã€ä¸­å›½ã€å›½äººè¿™æ ·çš„å‡ ä¸ªè¯æ¡</li>
</ul>
<p><strong>åˆ›å»ºå€’æ’ç´¢å¼•</strong>:</p>
<p><img src="/img/blogs/java/springcloud/es.1.png" srcset="/img/loading.gif" lazyload></p>
<p>å€’æ’ç´¢å¼•çš„<strong>æœç´¢æµç¨‹</strong>:</p>
<p><img src="/img/blogs/java/springcloud/es.2.png" srcset="/img/loading.gif" lazyload></p>
<p>æµç¨‹æè¿°ï¼š</p>
<ol>
<li>ç”¨æˆ·è¾“å…¥æ¡ä»¶â€åä¸ºæ‰‹æœºâ€è¿›è¡Œæœç´¢ã€‚</li>
<li>å¯¹ç”¨æˆ·è¾“å…¥æ¡ä»¶åˆ†è¯ï¼Œå¾—åˆ°è¯æ¡ï¼šåä¸ºã€æ‰‹æœºã€‚</li>
<li>æ‹¿ç€è¯æ¡åœ¨å€’æ’ç´¢å¼•ä¸­æŸ¥æ‰¾ï¼ˆç”±äºè¯æ¡æœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ï¼‰ï¼Œå³å¯å¾—åˆ°åŒ…å«è¯æ¡çš„æ–‡æ¡£idï¼š1ã€2ã€3ã€‚</li>
<li>æ‹¿ç€æ–‡æ¡£idåˆ°æ­£å‘ç´¢å¼•ä¸­æŸ¥æ‰¾å…·ä½“æ–‡æ¡£å³å¯ï¼ˆç”±äºidä¹Ÿæœ‰ç´¢å¼•ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¹Ÿå¾ˆé«˜ï¼‰ã€‚</li>
</ol>
<h4 id="1-1-3-æ­£å‘å’Œå€’æ’"><a href="#1-1-3-æ­£å‘å’Œå€’æ’" class="headerlink" title="1.1.3 æ­£å‘å’Œå€’æ’"></a>1.1.3 æ­£å‘å’Œå€’æ’</h4><ul>
<li>æ­£å‘ç´¢å¼•æ˜¯æœ€ä¼ ç»Ÿçš„ï¼Œæ ¹æ®idç´¢å¼•çš„æ–¹å¼ã€‚ä½†æ ¹æ®è¯æ¡æŸ¥è¯¢æ—¶ï¼Œå¿…é¡»å…ˆé€æ¡è·å–æ¯ä¸ªæ–‡æ¡£ï¼Œç„¶ååˆ¤æ–­æ–‡æ¡£ä¸­æ˜¯å¦åŒ…å«æ‰€éœ€è¦çš„è¯æ¡ï¼Œæ˜¯<strong>æ ¹æ®æ–‡æ¡£æ‰¾è¯æ¡çš„è¿‡ç¨‹</strong>ã€‚ </li>
<li>è€Œå€’æ’ç´¢å¼•åˆ™ç›¸åï¼Œæ˜¯<strong>å…ˆæ‰¾åˆ°ç”¨æˆ·è¦æœç´¢çš„è¯æ¡ï¼Œæ ¹æ®è¯æ¡å¾—åˆ°ä¿æŠ¤è¯æ¡çš„æ–‡æ¡£çš„idï¼Œç„¶åæ ¹æ®idè·å–æ–‡æ¡£</strong>ã€‚æ˜¯æ ¹æ®è¯æ¡æ‰¾æ–‡æ¡£çš„è¿‡ç¨‹ã€‚</li>
</ul>
<h3 id="1-2-IKåˆ†è¯å™¨"><a href="#1-2-IKåˆ†è¯å™¨" class="headerlink" title="1.2 IKåˆ†è¯å™¨"></a>1.2 IKåˆ†è¯å™¨</h3><p>åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">https://github.com/medcl/elasticsearch-analysis-ik</a></p>
<p>IKåˆ†è¯å™¨åŒ…å«ä¸¤ç§æ¨¡å¼ï¼š</p>
<ul>
<li>ik_smartï¼šæ™ºèƒ½è¯­ä¹‰åˆ‡åˆ† </li>
<li>ik_max_wordï¼šæœ€ç»†ç²’åº¦åˆ‡åˆ†</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /_analyze<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;text&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬ç¨‹åºå‘˜å­¦ä¹ javaå¤ªæ£’äº†&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;tokens&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;token&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;start_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;end_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;position&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;token&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ç¨‹åºå‘˜&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;start_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;end_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;position&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;token&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å­¦ä¹ &quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;start_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">5</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;end_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;position&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;token&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;java&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;start_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">7</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;end_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ENGLISH&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;position&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;token&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å¤ªæ£’äº†&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;start_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">11</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;end_offset&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">14</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;type&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;CN_WORD&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;position&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>


<p><strong>æ‹“å±•è¯å…¸</strong>:</p>
<ol>
<li>æ‰“å¼€IKåˆ†è¯å™¨configç›®å½•</li>
<li>åœ¨IKAnalyzer.cfg.xmlé…ç½®æ–‡ä»¶å†…å®¹æ·»åŠ </li>
<li>åœ¨IKåˆ†è¯å™¨çš„configç›®å½•æ–°å»ºä¸€ä¸ª ext.dicï¼Œå¯ä»¥å‚è€ƒconfigç›®å½•ä¸‹å¤åˆ¶ä¸€ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹</li>
<li>é‡å¯elasticsearch</li>
</ol>
<h3 id="1-3-ESåŸºç¡€æ¦‚å¿µ"><a href="#1-3-ESåŸºç¡€æ¦‚å¿µ" class="headerlink" title="1.3 ESåŸºç¡€æ¦‚å¿µ"></a>1.3 ESåŸºç¡€æ¦‚å¿µ</h3><p>elasticsearchæ˜¯<strong>é¢å‘æ–‡æ¡£ï¼ˆDocumentï¼‰å­˜å‚¨</strong>çš„ï¼Œå¯ä»¥æ˜¯æ•°æ®åº“ä¸­çš„ä¸€æ¡å•†å“æ•°æ®ï¼Œä¸€ä¸ªè®¢å•ä¿¡æ¯ã€‚æ–‡æ¡£æ•°æ®ä¼šè¢«åºåˆ—åŒ–ä¸ºjsonæ ¼å¼åå­˜å‚¨åœ¨elasticsearchä¸­</p>
<p><img src="/img/blogs/java/springcloud/es.3.png" srcset="/img/loading.gif" lazyload></p>
<p>å°†ç±»å‹ç›¸åŒçš„æ–‡æ¡£é›†ä¸­åœ¨ä¸€èµ·ç®¡ç†ï¼Œç§°ä¸ºç´¢å¼•ï¼ˆIndexï¼‰</p>
<p><img src="/img/blogs/java/springcloud/es.4.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>MySQLå’ŒESçš„å¯¹æ¯”</strong>ï¼š</p>
<p><img src="/img/blogs/java/springcloud/es.5.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Mysqlï¼šæ“…é•¿äº‹åŠ¡ç±»å‹æ“ä½œï¼Œå¯ä»¥ç¡®ä¿æ•°æ®çš„å®‰å…¨å’Œä¸€è‡´æ€§ </li>
<li>Elasticsearchï¼šæ“…é•¿æµ·é‡æ•°æ®çš„æœç´¢ã€åˆ†æã€è®¡ç®—<br>ä¸¤è€…ç»“åˆä½¿ç”¨ï¼š</li>
<li>å¯¹å®‰å…¨æ€§è¦æ±‚è¾ƒé«˜çš„å†™æ“ä½œï¼Œä½¿ç”¨mysqlå®ç°</li>
<li>å¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚è¾ƒé«˜çš„æœç´¢éœ€æ±‚ï¼Œä½¿ç”¨elasticsearchå®ç°</li>
<li>ä¸¤è€…å†åŸºäºæŸç§æ–¹å¼ï¼Œå®ç°æ•°æ®çš„åŒæ­¥ï¼Œä¿è¯ä¸€è‡´æ€§</li>
</ul>
<h2 id="2-ç´¢å¼•åº“æ“ä½œ"><a href="#2-ç´¢å¼•åº“æ“ä½œ" class="headerlink" title="2. ç´¢å¼•åº“æ“ä½œ"></a>2. ç´¢å¼•åº“æ“ä½œ</h2><p>Indexå°±ç±»ä¼¼æ•°æ®åº“è¡¨ï¼ŒMappingæ˜ å°„å°±ç±»ä¼¼è¡¨çš„ç»“æ„ã€‚æˆ‘ä»¬è¦å‘esä¸­å­˜å‚¨æ•°æ®ï¼Œå¿…é¡»å…ˆåˆ›å»ºIndexå’ŒMapping</p>
<h3 id="2-1-Mappingæ˜ å°„å±æ€§"><a href="#2-1-Mappingæ˜ å°„å±æ€§" class="headerlink" title="2.1 Mappingæ˜ å°„å±æ€§"></a>2.1 Mappingæ˜ å°„å±æ€§</h3><p>Mappingæ˜¯å¯¹ç´¢å¼•åº“ä¸­æ–‡æ¡£çš„çº¦æŸï¼Œå¸¸è§çš„Mappingå±æ€§åŒ…æ‹¬ï¼š</p>
<ul>
<li>typeï¼šå­—æ®µæ•°æ®ç±»å‹ï¼Œå¸¸è§çš„ç®€å•ç±»å‹æœ‰ï¼š <ul>
<li>å­—ç¬¦ä¸²ï¼štextï¼ˆå¯åˆ†è¯çš„æ–‡æœ¬ï¼‰ã€keywordï¼ˆç²¾ç¡®å€¼ï¼Œä¾‹å¦‚ï¼šå“ç‰Œã€å›½å®¶ã€ipåœ°å€ï¼‰</li>
<li>æ•°å€¼ï¼šlongã€integerã€shortã€byteã€doubleã€floatã€</li>
<li>å¸ƒå°”ï¼šboolean</li>
<li>æ—¥æœŸï¼šdate</li>
<li>å¯¹è±¡ï¼šobject</li>
</ul>
</li>
<li>indexï¼šæ˜¯å¦åˆ›å»ºç´¢å¼•ï¼Œé»˜è®¤ä¸ºtrue</li>
<li>analyzerï¼šä½¿ç”¨å“ªç§åˆ†è¯å™¨</li>
<li>propertiesï¼šè¯¥å­—æ®µçš„å­å­—æ®µ</li>
</ul>
<h3 id="2-2-ç´¢å¼•åº“çš„å¢åˆ æ”¹æŸ¥"><a href="#2-2-ç´¢å¼•åº“çš„å¢åˆ æ”¹æŸ¥" class="headerlink" title="2.2 ç´¢å¼•åº“çš„å¢åˆ æ”¹æŸ¥"></a>2.2 ç´¢å¼•åº“çš„å¢åˆ æ”¹æŸ¥</h3><p>Elasticsearché‡‡ç”¨çš„æ˜¯Restfulé£æ ¼çš„APIï¼Œè€Œä¸”è¯·æ±‚å‚æ•°ä¹Ÿéƒ½é‡‡ç”¨JSONé£æ ¼</p>
<table>
<thead>
<tr>
<th>æ¥å£ç±»å‹</th>
<th>è¯·æ±‚æ–¹å¼</th>
<th>è¯·æ±‚è·¯å¾„</th>
<th>è¯·æ±‚å‚æ•°</th>
</tr>
</thead>
<tbody><tr>
<td>æŸ¥è¯¢ç”¨æˆ·</td>
<td>GET</td>
<td>&#x2F;users&#x2F;{id}</td>
<td>è·¯å¾„ä¸­çš„ id</td>
</tr>
<tr>
<td>æ–°å¢ç”¨æˆ·</td>
<td>POST</td>
<td>&#x2F;users</td>
<td>json æ ¼å¼ user å¯¹è±¡</td>
</tr>
<tr>
<td>ä¿®æ”¹ç”¨æˆ·</td>
<td>PUT</td>
<td>&#x2F;users&#x2F;{id}</td>
<td>è·¯å¾„ä¸­çš„ id<br>json æ ¼å¼å¯¹è±¡</td>
</tr>
<tr>
<td>åˆ é™¤ç”¨æˆ·</td>
<td>DELETE</td>
<td>&#x2F;users&#x2F;{id}</td>
<td>è·¯å¾„ä¸­çš„ id</td>
</tr>
</tbody></table>
<h4 id="2-2-1-åˆ›å»ºç´¢å¼•åº“"><a href="#2-2-1-åˆ›å»ºç´¢å¼•åº“" class="headerlink" title="2.2.1 åˆ›å»ºç´¢å¼•åº“"></a>2.2.1 åˆ›å»ºç´¢å¼•åº“</h4><p>åŸºæœ¬è¯­æ³•ï¼š</p>
<ul>
<li>è¯·æ±‚æ–¹å¼ï¼šPUT</li>
<li>è¯·æ±‚è·¯å¾„ï¼š&#x2F;ç´¢å¼•åº“åï¼Œå¯ä»¥è‡ªå®šä¹‰</li>
<li>è¯·æ±‚å‚æ•°ï¼šmappingæ˜ å°„</li>
</ul>
<p><strong>æ ¼å¼</strong>ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /ç´¢å¼•åº“åç§°<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;å­—æ®µå2&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;false&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;å­—æ®µå3&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;å­å­—æ®µ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-comment">// ...ç•¥</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs json"># PUT /heima<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_smart&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;false&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-2-2-æŸ¥è¯¢ã€åˆ é™¤ç´¢å¼•åº“"><a href="#2-2-2-æŸ¥è¯¢ã€åˆ é™¤ç´¢å¼•åº“" class="headerlink" title="2.2.2 æŸ¥è¯¢ã€åˆ é™¤ç´¢å¼•åº“"></a>2.2.2 æŸ¥è¯¢ã€åˆ é™¤ç´¢å¼•åº“</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /ç´¢å¼•åº“å<br>DELETE /ç´¢å¼•åº“å<br></code></pre></td></tr></table></figure>

<h4 id="2-2-3-ä¿®æ”¹ç´¢å¼•åº“"><a href="#2-2-3-ä¿®æ”¹ç´¢å¼•åº“" class="headerlink" title="2.2.3 ä¿®æ”¹ç´¢å¼•åº“"></a>2.2.3 ä¿®æ”¹ç´¢å¼•åº“</h4><p>ç´¢å¼•åº“ä¸€æ—¦åˆ›å»ºï¼Œæ— æ³•ä¿®æ”¹mappingã€‚ä½†æ˜¯å´å…è®¸æ·»åŠ æ–°çš„å­—æ®µåˆ°mappingä¸­</p>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /ç´¢å¼•åº“å/_mapping<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;æ–°å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /heima/_mapping<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="3-æ–‡æ¡£æ“ä½œ"><a href="#3-æ–‡æ¡£æ“ä½œ" class="headerlink" title="3. æ–‡æ¡£æ“ä½œ"></a>3. æ–‡æ¡£æ“ä½œ</h2><p>æœ‰äº†ç´¢å¼•åº“ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥å‘ç´¢å¼•åº“çš„æ–‡æ¡£ä¸­æ·»åŠ æ•°æ®äº†ã€‚</p>
<h3 id="3-1-æ–°å¢æ–‡æ¡£"><a href="#3-1-æ–°å¢æ–‡æ¡£" class="headerlink" title="3.1 æ–°å¢æ–‡æ¡£"></a>3.1 æ–°å¢æ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /ç´¢å¼•åº“å/_doc/æ–‡æ¡£id<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;å­—æ®µ1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;å­—æ®µ2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;å­—æ®µ3&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;å­å±æ€§1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼3&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;å­å±æ€§2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼4&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-2-æŸ¥è¯¢æ–‡æ¡£"><a href="#3-2-æŸ¥è¯¢æ–‡æ¡£" class="headerlink" title="3.2 æŸ¥è¯¢æ–‡æ¡£"></a>3.2 æŸ¥è¯¢æ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“åç§°<span class="hljs-punctuation">&#125;</span>/_doc/<span class="hljs-punctuation">&#123;</span>id<span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-3-åˆ é™¤æ–‡æ¡£"><a href="#3-3-åˆ é™¤æ–‡æ¡£" class="headerlink" title="3.3 åˆ é™¤æ–‡æ¡£"></a>3.3 åˆ é™¤æ–‡æ¡£</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">DELETE /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_doc/idå€¼<br></code></pre></td></tr></table></figure>

<h3 id="3-4-ä¿®æ”¹æ–‡æ¡£"><a href="#3-4-ä¿®æ”¹æ–‡æ¡£" class="headerlink" title="3.4 ä¿®æ”¹æ–‡æ¡£"></a>3.4 ä¿®æ”¹æ–‡æ¡£</h3><p>ä¿®æ”¹æœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>å…¨é‡ä¿®æ”¹ï¼šç›´æ¥è¦†ç›–åŸæ¥çš„æ–‡æ¡£</li>
<li>å±€éƒ¨ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</li>
</ul>
<h4 id="3-4-1-å…¨é‡ä¿®æ”¹"><a href="#3-4-1-å…¨é‡ä¿®æ”¹" class="headerlink" title="3.4.1 å…¨é‡ä¿®æ”¹"></a>3.4.1 å…¨é‡ä¿®æ”¹</h4><p>å…¨é‡ä¿®æ”¹æ˜¯è¦†ç›–åŸæ¥çš„æ–‡æ¡£ï¼Œå…¶æœ¬è´¨æ˜¯ä¸¤æ­¥æ“ä½œï¼š</p>
<ul>
<li>æ ¹æ®æŒ‡å®šçš„idåˆ é™¤æ–‡æ¡£</li>
<li>æ–°å¢ä¸€ä¸ªç›¸åŒidçš„æ–‡æ¡£</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_doc/æ–‡æ¡£id<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;å­—æ®µ1&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼1&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;å­—æ®µ2&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å€¼2&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-comment">// ... ç•¥</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-å±€éƒ¨ä¿®æ”¹"><a href="#3-4-2-å±€éƒ¨ä¿®æ”¹" class="headerlink" title="3.4.2 å±€éƒ¨ä¿®æ”¹"></a>3.4.2 å±€éƒ¨ä¿®æ”¹</h4><p>å±€éƒ¨ä¿®æ”¹æ˜¯åªä¿®æ”¹æŒ‡å®šidåŒ¹é…çš„æ–‡æ¡£ä¸­çš„éƒ¨åˆ†å­—æ®µ</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_update/æ–‡æ¡£id<br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>         <span class="hljs-attr">&quot;å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ–°çš„å€¼&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="3-5-æ‰¹å¤„ç†"><a href="#3-5-æ‰¹å¤„ç†" class="headerlink" title="3.5 æ‰¹å¤„ç†"></a>3.5 æ‰¹å¤„ç†</h3><p>æ‰¹å¤„ç†é‡‡ç”¨POSTè¯·æ±‚ï¼ŒåŸºæœ¬è¯­æ³•å¦‚ä¸‹</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">POST _bulk<br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;field1&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;value1&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;delete&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2&quot;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;create&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span> <span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;field1&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;value3&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;update&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_id&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_index&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;test&quot;</span><span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;doc&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;field2&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;value2&quot;</span><span class="hljs-punctuation">&#125;</span> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>indexä»£è¡¨æ–°å¢æ“ä½œ<ul>
<li>_indexï¼šæŒ‡å®šç´¢å¼•åº“å</li>
<li>_idæŒ‡å®šè¦æ“ä½œçš„æ–‡æ¡£id</li>
<li>{ â€œfield1â€ : â€œvalue1â€ }ï¼šåˆ™æ˜¯è¦æ–°å¢çš„æ–‡æ¡£å†…å®¹</li>
</ul>
</li>
<li>deleteä»£è¡¨åˆ é™¤æ“ä½œ<ul>
<li>_indexï¼šæŒ‡å®šç´¢å¼•åº“å</li>
<li>_idæŒ‡å®šè¦æ“ä½œçš„æ–‡æ¡£id</li>
</ul>
</li>
<li>updateä»£è¡¨æ›´æ–°æ“ä½œ<ul>
<li>_indexï¼šæŒ‡å®šç´¢å¼•åº“å</li>
<li>_idæŒ‡å®šè¦æ“ä½œçš„æ–‡æ¡£id</li>
<li>{ â€œdocâ€ : {â€œfield2â€ : â€œvalue2â€} }ï¼šè¦æ›´æ–°çš„æ–‡æ¡£å­—æ®µ</li>
</ul>
</li>
</ul>
<h3 id="3-6-æ¡ˆä¾‹"><a href="#3-6-æ¡ˆä¾‹" class="headerlink" title="3.6 æ¡ˆä¾‹"></a>3.6 æ¡ˆä¾‹</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs json"># æ–°å¢æ–‡æ¡£<br>POST /heima/_doc/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬ç¨‹åºå‘˜Javaè®²å¸ˆ&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zy@itcast.cn&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;äº‘&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;èµµ&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># æŸ¥è¯¢æ–‡æ¡£<br>GET /heima/_doc/<span class="hljs-number">1</span><br><br># åˆ é™¤æ–‡æ¡£<br>DELETE /heima/_doc/<span class="hljs-number">1</span><br><br># å…¨é‡ä¿®æ”¹æ–‡æ¡£<br>PUT /heima/_doc/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬ç¨‹åºå‘˜é«˜çº§Javaè®²å¸ˆ&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zy@itcast.cn&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;äº‘&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;èµµ&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># å±€éƒ¨ä¿®æ”¹æ–‡æ¡£<br>POST /heima/_update/<span class="hljs-number">1</span><br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ZhaoYun@itcast.cn&quot;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br><br># æ‰¹é‡æ–°å¢æ–‡æ¡£<br>POST /_bulk<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;heima&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬ç¨‹åºå‘˜C++è®²å¸ˆ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ww@itcast.cn&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;äº”&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;ç‹&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;heima&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;4&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;info&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;é»‘é©¬ç¨‹åºå‘˜å‰ç«¯è®²å¸ˆ&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;email&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;zhangsan@itcast.cn&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;firstName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ä¸‰&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;lastName&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;å¼ &quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><br># æ‰¹é‡åˆ é™¤æ–‡æ¡£<br>POST /_bulk<br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;delete&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;heima&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;3&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;delete&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;_index&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;heima&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;_id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;4&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="4-JavaRestClient"><a href="#4-JavaRestClient" class="headerlink" title="4. JavaRestClient"></a>4. JavaRestClient</h2><h3 id="4-1-å®¢æˆ·ç«¯åˆå§‹åŒ–RestClient"><a href="#4-1-å®¢æˆ·ç«¯åˆå§‹åŒ–RestClient" class="headerlink" title="4.1 å®¢æˆ·ç«¯åˆå§‹åŒ–RestClient"></a>4.1 å®¢æˆ·ç«¯åˆå§‹åŒ–RestClient</h3><ol>
<li>åœ¨item-serviceæ¨¡å—ä¸­å¼•å…¥esçš„RestHighLevelClientä¾èµ–ï¼š</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.elasticsearch.client<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>å› ä¸ºSpringBooté»˜è®¤çš„ESç‰ˆæœ¬æ˜¯7.17.10ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦è¦†ç›–é»˜è®¤çš„ESç‰ˆæœ¬ï¼š</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">elasticsearch.version</span>&gt;</span>7.12.1<span class="hljs-tag">&lt;/<span class="hljs-name">elasticsearch.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="3">
<li>åˆå§‹åŒ–RestHighLevelClientï¼š</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RestHighLevelClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RestHighLevelClient</span>(RestClient.builder(<br>        HttpHost.create(<span class="hljs-string">&quot;http://192.168.150.101:9200&quot;</span>)<br>));<br></code></pre></td></tr></table></figure>

<h3 id="4-2-åˆ›å»ºç´¢å¼•åº“"><a href="#4-2-åˆ›å»ºç´¢å¼•åº“" class="headerlink" title="4.2 åˆ›å»ºç´¢å¼•åº“"></a>4.2 åˆ›å»ºç´¢å¼•åº“</h3><p>è¦å®ç°å¯¹å•†å“æœç´¢ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†å•†å“æ·»åŠ åˆ°Elasticsearchä¸­ï¼Œä¸è¿‡éœ€è¦æ ¹æ®æœç´¢ä¸šåŠ¡çš„éœ€æ±‚æ¥è®¾å®šç´¢å¼•åº“ç»“æ„ï¼Œè€Œä¸æ˜¯ä¸€è‚¡è„‘çš„æŠŠMySQLæ•°æ®å†™å…¥Elasticsearch.</p>
<h4 id="4-2-1-å•†å“Mappingæ˜ å°„"><a href="#4-2-1-å•†å“Mappingæ˜ å°„" class="headerlink" title="4.2.1 å•†å“Mappingæ˜ å°„"></a>4.2.1 å•†å“Mappingæ˜ å°„</h4><p>ç»“åˆæ•°æ®åº“è¡¨ç»“æ„ï¼Œå­—æ®µå¯¹åº”çš„mappingæ˜ å°„å±æ€§å¦‚ä¸‹ï¼š</p>
<p><img src="/img/blogs/java/springcloud/es.6.png" srcset="/img/loading.gif" lazyload></p>
<p>ç´¢å¼•åº“æ–‡æ¡£ç»“æ„:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /items<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;id&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;analyzer&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ik_max_word&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;stock&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;image&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;sold&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;commentCount&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;integer&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;isAD&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;boolean&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;updateTime&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;date&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="4-2-2-åœ¨javaä¸­åˆ›å»ºç´¢å¼•åº“"><a href="#4-2-2-åœ¨javaä¸­åˆ›å»ºç´¢å¼•åº“" class="headerlink" title="4.2.2 åœ¨javaä¸­åˆ›å»ºç´¢å¼•åº“"></a>4.2.2 åœ¨javaä¸­åˆ›å»ºç´¢å¼•åº“</h4><ol>
<li>åˆ›å»ºRequestå¯¹è±¡ã€‚<br>  å› ä¸ºæ˜¯åˆ›å»ºç´¢å¼•åº“çš„æ“ä½œï¼Œå› æ­¤Requestæ˜¯CreateIndexRequestã€‚</li>
<li>æ·»åŠ è¯·æ±‚å‚æ•°<br>  å…¶å®å°±æ˜¯Jsonæ ¼å¼çš„Mappingæ˜ å°„å‚æ•°ã€‚å› ä¸ºjsonå­—ç¬¦ä¸²å¾ˆé•¿ï¼Œè¿™é‡Œæ˜¯å®šä¹‰äº†é™æ€å­—ç¬¦ä¸²å¸¸é‡MAPPING_TEMPLATEï¼Œè®©ä»£ç çœ‹èµ·æ¥æ›´åŠ ä¼˜é›…ã€‚</li>
<li>å‘é€è¯·æ±‚<br>  client.indices()æ–¹æ³•çš„è¿”å›å€¼æ˜¯IndicesClientç±»å‹ï¼Œå°è£…äº†æ‰€æœ‰ä¸ç´¢å¼•åº“æ“ä½œæœ‰å…³çš„æ–¹æ³•ã€‚ä¾‹å¦‚åˆ›å»ºç´¢å¼•ã€åˆ é™¤ç´¢å¼•ã€åˆ¤æ–­ç´¢å¼•æ˜¯å¦å­˜åœ¨ç­‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testCreateIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequestå¯¹è±¡</span><br>    <span class="hljs-type">CreateIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CreateIndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.å‡†å¤‡è¯·æ±‚å‚æ•°</span><br>    request.source(MAPPING_TEMPLATE, XContentType.JSON);<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    client.indices().create(request, RequestOptions.DEFAULT);<br>&#125;<br><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">MAPPING_TEMPLATE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;  \&quot;mappings\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;    \&quot;properties\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;id\&quot;: &#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;name\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;text\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;analyzer\&quot;: \&quot;ik_max_word\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;price\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;stock\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;image\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;index\&quot;: false\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;category\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;brand\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;keyword\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;sold\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;commentCount\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;integer\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;isAD\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;boolean\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;,\n&quot;</span> +<br>            <span class="hljs-string">&quot;      \&quot;updateTime\&quot;:&#123;\n&quot;</span> +<br>            <span class="hljs-string">&quot;        \&quot;type\&quot;: \&quot;date\&quot;\n&quot;</span> +<br>            <span class="hljs-string">&quot;      &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;    &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;  &#125;\n&quot;</span> +<br>            <span class="hljs-string">&quot;&#125;&quot;</span>;<br></code></pre></td></tr></table></figure>

<h3 id="4-3-åœ¨javaä¸­åˆ é™¤å’ŒæŸ¥è¯¢ç´¢å¼•åº“"><a href="#4-3-åœ¨javaä¸­åˆ é™¤å’ŒæŸ¥è¯¢ç´¢å¼•åº“" class="headerlink" title="4.3 åœ¨javaä¸­åˆ é™¤å’ŒæŸ¥è¯¢ç´¢å¼•åº“"></a>4.3 åœ¨javaä¸­åˆ é™¤å’ŒæŸ¥è¯¢ç´¢å¼•åº“</h3><h4 id="4-3-1-åˆ é™¤ç´¢å¼•åº“"><a href="#4-3-1-åˆ é™¤ç´¢å¼•åº“" class="headerlink" title="4.3.1 åˆ é™¤ç´¢å¼•åº“"></a>4.3.1 åˆ é™¤ç´¢å¼•åº“</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequestå¯¹è±¡</span><br>    <span class="hljs-type">DeleteIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteIndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.å‘é€è¯·æ±‚</span><br>    client.indices().delete(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-3-2-æŸ¥è¯¢ç´¢å¼•åº“"><a href="#4-3-2-æŸ¥è¯¢ç´¢å¼•åº“" class="headerlink" title="4.3.2 æŸ¥è¯¢ç´¢å¼•åº“"></a>4.3.2 æŸ¥è¯¢ç´¢å¼•åº“</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testExistsIndex</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequestå¯¹è±¡</span><br>    <span class="hljs-type">GetIndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetIndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">exists</span> <span class="hljs-operator">=</span> client.indices().exists(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 3.è¾“å‡º</span><br>    System.err.println(exists ? <span class="hljs-string">&quot;ç´¢å¼•åº“å·²ç»å­˜åœ¨ï¼&quot;</span> : <span class="hljs-string">&quot;ç´¢å¼•åº“ä¸å­˜åœ¨ï¼&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="4-4-æ–‡æ¡£æ“ä½œ"><a href="#4-4-æ–‡æ¡£æ“ä½œ" class="headerlink" title="4.4 æ–‡æ¡£æ“ä½œ"></a>4.4 æ–‡æ¡£æ“ä½œ</h3><h4 id="4-4-1-æ–°å¢æ–‡æ¡£"><a href="#4-4-1-æ–°å¢æ–‡æ¡£" class="headerlink" title="4.4.1 æ–°å¢æ–‡æ¡£"></a>4.4.1 æ–°å¢æ–‡æ¡£</h4><ol>
<li>åˆ›å»ºRequestå¯¹è±¡ï¼Œè¿™é‡Œæ˜¯IndexRequestï¼Œå› ä¸ºæ·»åŠ æ–‡æ¡£å°±æ˜¯åˆ›å»ºå€’æ’ç´¢å¼•çš„è¿‡ç¨‹</li>
<li>å‡†å¤‡è¯·æ±‚å‚æ•°ï¼Œæœ¬ä¾‹ä¸­å°±æ˜¯Jsonæ–‡æ¡£</li>
<li>å‘é€è¯·æ±‚</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testAddDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.æ ¹æ®idæŸ¥è¯¢å•†å“æ•°æ®</span><br>    <span class="hljs-type">Item</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> itemService.getById(<span class="hljs-number">100002644680L</span>);<br>    <span class="hljs-comment">// 2.è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹</span><br>    <span class="hljs-type">ItemDoc</span> <span class="hljs-variable">itemDoc</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(item, ItemDoc.class);<br>    <span class="hljs-comment">// 3.å°†ItemDTOè½¬json</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">doc</span> <span class="hljs-operator">=</span> JSONUtil.toJsonStr(itemDoc);<br><br>    <span class="hljs-comment">// 1.å‡†å¤‡Requestå¯¹è±¡</span><br>    <span class="hljs-type">IndexRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>).id(itemDoc.getId());<br>    <span class="hljs-comment">// 2.å‡†å¤‡Jsonæ–‡æ¡£</span><br>    request.source(doc, XContentType.JSON);<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    client.index(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-2-æŸ¥è¯¢æ–‡æ¡£"><a href="#4-4-2-æŸ¥è¯¢æ–‡æ¡£" class="headerlink" title="4.4.2 æŸ¥è¯¢æ–‡æ¡£"></a>4.4.2 æŸ¥è¯¢æ–‡æ¡£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testGetDocumentById</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.å‡†å¤‡Requestå¯¹è±¡</span><br>    <span class="hljs-type">GetRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GetRequest</span>(<span class="hljs-string">&quot;items&quot;</span>).id(<span class="hljs-string">&quot;100002644680&quot;</span>);<br>    <span class="hljs-comment">// 2.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">GetResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.get(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 3.è·å–å“åº”ç»“æœä¸­çš„source</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> response.getSourceAsString();<br>    <br>    <span class="hljs-type">ItemDoc</span> <span class="hljs-variable">itemDoc</span> <span class="hljs-operator">=</span> JSONUtil.toBean(json, ItemDoc.class);<br>    System.out.println(<span class="hljs-string">&quot;itemDoc= &quot;</span> + ItemDoc);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-3-åˆ é™¤æ–‡æ¡£"><a href="#4-4-3-åˆ é™¤æ–‡æ¡£" class="headerlink" title="4.4.3 åˆ é™¤æ–‡æ¡£"></a>4.4.3 åˆ é™¤æ–‡æ¡£</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testDeleteDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.å‡†å¤‡Requestï¼Œä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç´¢å¼•åº“åï¼Œç¬¬äºŒä¸ªæ˜¯æ–‡æ¡£id</span><br>    <span class="hljs-type">DeleteRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DeleteRequest</span>(<span class="hljs-string">&quot;item&quot;</span>, <span class="hljs-string">&quot;100002644680&quot;</span>);<br>    <span class="hljs-comment">// 2.å‘é€è¯·æ±‚</span><br>    client.delete(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-4-ä¿®æ”¹æ–‡æ¡£"><a href="#4-4-4-ä¿®æ”¹æ–‡æ¡£" class="headerlink" title="4.4.4 ä¿®æ”¹æ–‡æ¡£"></a>4.4.4 ä¿®æ”¹æ–‡æ¡£</h4><ul>
<li>å…¨é‡ä¿®æ”¹ï¼šæœ¬è´¨æ˜¯å…ˆæ ¹æ®idåˆ é™¤ï¼Œå†æ–°å¢</li>
<li>å±€éƒ¨ä¿®æ”¹ï¼šä¿®æ”¹æ–‡æ¡£ä¸­çš„æŒ‡å®šå­—æ®µå€¼</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨å±€éƒ¨ä¿®æ”¹çš„API:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testUpdateDocument</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.å‡†å¤‡Request</span><br>    <span class="hljs-type">UpdateRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UpdateRequest</span>(<span class="hljs-string">&quot;items&quot;</span>, <span class="hljs-string">&quot;100002644680&quot;</span>);<br>    <span class="hljs-comment">// 2.å‡†å¤‡è¯·æ±‚å‚æ•°</span><br>    request.doc(<br>            <span class="hljs-string">&quot;price&quot;</span>, <span class="hljs-number">58800</span>,<br>            <span class="hljs-string">&quot;commentCount&quot;</span>, <span class="hljs-number">1</span><br>    );<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    client.update(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-5-æ‰¹é‡å¯¼å…¥æ–‡æ¡£"><a href="#4-4-5-æ‰¹é‡å¯¼å…¥æ–‡æ¡£" class="headerlink" title="4.4.5 æ‰¹é‡å¯¼å…¥æ–‡æ¡£"></a>4.4.5 æ‰¹é‡å¯¼å…¥æ–‡æ¡£</h4><p>Bulkä¸­æ·»åŠ äº†å¤šä¸ªIndexRequestï¼Œå°±æ˜¯æ‰¹é‡æ–°å¢åŠŸèƒ½:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testBulk</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>();<br>    <span class="hljs-comment">// 2.å‡†å¤‡è¯·æ±‚å‚æ•°</span><br>    request.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>).id(<span class="hljs-string">&quot;1&quot;</span>).source(<span class="hljs-string">&quot;json doc1&quot;</span>, XContentType.JSON));<br>    request.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>(<span class="hljs-string">&quot;items&quot;</span>).id(<span class="hljs-string">&quot;2&quot;</span>).source(<span class="hljs-string">&quot;json doc2&quot;</span>, XContentType.JSON));<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    client.bulk(request, RequestOptions.DEFAULT);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>é‡‡ç”¨å¾ªç¯éå†æ–¹å¼ï¼Œæ¯æ¬¡å¯¼å…¥1000æ¡å·¦å³çš„æ•°æ®:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testLoadItemDocs</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// åˆ†é¡µæŸ¥è¯¢å•†å“æ•°æ®</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;<br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        Page&lt;Item&gt; page = itemService.lambdaQuery().eq(Item::getStatus, <span class="hljs-number">1</span>).page(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Page</span>&lt;Item&gt;(pageNo, size));<br>        <span class="hljs-comment">// éç©ºæ ¡éªŒ</span><br>        List&lt;Item&gt; items = page.getRecords();<br>        <span class="hljs-keyword">if</span> (CollUtils.isEmpty(items)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        log.info(<span class="hljs-string">&quot;åŠ è½½ç¬¬&#123;&#125;é¡µæ•°æ®ï¼Œå…±&#123;&#125;æ¡&quot;</span>, pageNo, items.size());<br>        <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>        <span class="hljs-type">BulkRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BulkRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>        <span class="hljs-comment">// 2.å‡†å¤‡å‚æ•°ï¼Œæ·»åŠ å¤šä¸ªæ–°å¢çš„Request</span><br>        <span class="hljs-keyword">for</span> (Item item : items) &#123;<br>            <span class="hljs-comment">// 2.1.è½¬æ¢ä¸ºæ–‡æ¡£ç±»å‹ItemDTO</span><br>            <span class="hljs-type">ItemDoc</span> <span class="hljs-variable">itemDoc</span> <span class="hljs-operator">=</span> BeanUtil.copyProperties(item, ItemDoc.class);<br>            <span class="hljs-comment">// 2.2.åˆ›å»ºæ–°å¢æ–‡æ¡£çš„Requestå¯¹è±¡</span><br>            request.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexRequest</span>()<br>                            .id(itemDoc.getId())<br>                            .source(JSONUtil.toJsonStr(itemDoc), XContentType.JSON));<br>        &#125;<br>        <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>        client.bulk(request, RequestOptions.DEFAULT);<br><br>        <span class="hljs-comment">// ç¿»é¡µ</span><br>        pageNo++;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="5-DSLæŸ¥è¯¢"><a href="#5-DSLæŸ¥è¯¢" class="headerlink" title="5. DSLæŸ¥è¯¢"></a>5. DSLæŸ¥è¯¢</h2><p>Elasticsearchçš„æŸ¥è¯¢å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p>
<ul>
<li>å¶å­æŸ¥è¯¢ï¼ˆLeaf query clausesï¼‰ï¼šä¸€èˆ¬æ˜¯åœ¨ç‰¹å®šçš„å­—æ®µé‡ŒæŸ¥è¯¢ç‰¹å®šå€¼ï¼Œå±äºç®€å•æŸ¥è¯¢ï¼Œå¾ˆå°‘å•ç‹¬ä½¿ç”¨ã€‚</li>
<li>å¤åˆæŸ¥è¯¢ï¼ˆCompound query clausesï¼‰ï¼šä»¥é€»è¾‘æ–¹å¼ç»„åˆå¤šä¸ªå¶å­æŸ¥è¯¢æˆ–è€…æ›´æ”¹å¶å­æŸ¥è¯¢çš„è¡Œä¸ºæ–¹å¼ã€‚</li>
</ul>
<h3 id="5-1-å¶å­æŸ¥è¯¢"><a href="#5-1-å¶å­æŸ¥è¯¢" class="headerlink" title="5.1 å¶å­æŸ¥è¯¢"></a>5.1 å¶å­æŸ¥è¯¢</h3><p>å¶å­æŸ¥è¯¢çš„ç±»å‹ï¼š</p>
<ul>
<li>å…¨æ–‡æ£€ç´¢æŸ¥è¯¢ï¼ˆFull Text Queriesï¼‰ï¼šåˆ©ç”¨åˆ†è¯å™¨å¯¹ç”¨æˆ·è¾“å…¥æœç´¢æ¡ä»¶å…ˆåˆ†è¯ï¼Œå¾—åˆ°è¯æ¡ï¼Œç„¶åå†åˆ©ç”¨å€’æ’ç´¢å¼•æœç´¢è¯æ¡ã€‚ä¾‹å¦‚ï¼š<ul>
<li>matchï¼š</li>
<li>multi_match</li>
</ul>
</li>
<li>ç²¾ç¡®æŸ¥è¯¢ï¼ˆTerm-level queriesï¼‰ï¼šä¸å¯¹ç”¨æˆ·è¾“å…¥æœç´¢æ¡ä»¶åˆ†è¯ï¼Œæ ¹æ®å­—æ®µå†…å®¹ç²¾ç¡®å€¼åŒ¹é…ã€‚ä½†åªèƒ½æŸ¥æ‰¾keywordã€æ•°å€¼ã€æ—¥æœŸã€booleanç±»å‹çš„å­—æ®µã€‚ä¾‹å¦‚ï¼š<ul>
<li>ids</li>
<li>term</li>
<li>range</li>
</ul>
</li>
<li>åœ°ç†åæ ‡æŸ¥è¯¢ï¼šç”¨äºæœç´¢åœ°ç†ä½ç½®ï¼Œæœç´¢æ–¹å¼å¾ˆå¤šï¼Œä¾‹å¦‚ï¼š<ul>
<li>geo_bounding_boxï¼šæŒ‰çŸ©å½¢æœç´¢</li>
<li>geo_distanceï¼šæŒ‰ç‚¹å’ŒåŠå¾„æœç´¢</li>
</ul>
</li>
</ul>
<h4 id="5-1-1-å…¨æ–‡æ£€ç´¢æŸ¥è¯¢"><a href="#5-1-1-å…¨æ–‡æ£€ç´¢æŸ¥è¯¢" class="headerlink" title="5.1.1 å…¨æ–‡æ£€ç´¢æŸ¥è¯¢"></a>5.1.1 å…¨æ–‡æ£€ç´¢æŸ¥è¯¢</h4><p>matchè¯­æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æœç´¢æ¡ä»¶&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>multi_matchè¯­æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;multi_match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æœç´¢æ¡ä»¶&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;å­—æ®µ1&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;å­—æ®µ2&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;multi_match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;åä¸º&quot;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;name&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-1-2-ç²¾ç¡®æŸ¥è¯¢"><a href="#5-1-2-ç²¾ç¡®æŸ¥è¯¢" class="headerlink" title="5.1.2 ç²¾ç¡®æŸ¥è¯¢"></a>5.1.2 ç²¾ç¡®æŸ¥è¯¢</h4><p>è¯æ¡çº§åˆ«çš„æŸ¥è¯¢ï¼›ä½œä¸ºä¸€ä¸ªè¯æ¡ï¼Œä¸æœç´¢çš„å­—æ®µå†…å®¹ç²¾ç¡®å€¼åŒ¹é…ã€‚å› æ­¤æ¨èæŸ¥æ‰¾keywordã€æ•°å€¼ã€æ—¥æœŸã€booleanç±»å‹çš„å­—æ®µã€‚</p>
<p>termæŸ¥è¯¢:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æœç´¢æ¡ä»¶&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>rangeæŸ¥è¯¢:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;å­—æ®µå&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>æœ€å°å€¼<span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;lte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span>æœ€å¤§å€¼<span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-2-å¤åˆæŸ¥è¯¢"><a href="#5-2-å¤åˆæŸ¥è¯¢" class="headerlink" title="5.2 å¤åˆæŸ¥è¯¢"></a>5.2 å¤åˆæŸ¥è¯¢</h3><ul>
<li>ç¬¬ä¸€ç±»ï¼šåŸºäºé€»è¾‘è¿ç®—ç»„åˆå¶å­æŸ¥è¯¢ï¼Œå®ç°ç»„åˆæ¡ä»¶ï¼Œä¾‹å¦‚<ul>
<li>bool</li>
</ul>
</li>
<li>ç¬¬äºŒç±»ï¼šåŸºäºæŸç§ç®—æ³•ä¿®æ”¹æŸ¥è¯¢æ—¶çš„æ–‡æ¡£ç›¸å…³æ€§ç®—åˆ†ï¼Œä»è€Œæ”¹å˜æ–‡æ¡£æ’åã€‚ä¾‹å¦‚ï¼š<ul>
<li>function_score</li>
<li>dis_max</li>
</ul>
</li>
</ul>
<h4 id="boolæŸ¥è¯¢"><a href="#boolæŸ¥è¯¢" class="headerlink" title="boolæŸ¥è¯¢"></a>boolæŸ¥è¯¢</h4><p>boolæŸ¥è¯¢ï¼Œå³å¸ƒå°”æŸ¥è¯¢ã€‚å°±æ˜¯åˆ©ç”¨é€»è¾‘è¿ç®—æ¥ç»„åˆä¸€ä¸ªæˆ–å¤šä¸ªæŸ¥è¯¢å­å¥çš„ç»„åˆã€‚boolæŸ¥è¯¢æ”¯æŒçš„é€»è¾‘è¿ç®—æœ‰ï¼š</p>
<ul>
<li>mustï¼šå¿…é¡»åŒ¹é…æ¯ä¸ªå­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œä¸â€</li>
<li>shouldï¼šé€‰æ‹©æ€§åŒ¹é…å­æŸ¥è¯¢ï¼Œç±»ä¼¼â€œæˆ–â€</li>
<li>must_notï¼šå¿…é¡»ä¸åŒ¹é…ï¼Œä¸å‚ä¸ç®—åˆ†ï¼Œç±»ä¼¼â€œéâ€</li>
<li>filterï¼šå¿…é¡»åŒ¹é…ï¼Œä¸å‚ä¸ç®—åˆ†</li>
</ul>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;must&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ‰‹æœº&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;should&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;vivo&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;å°ç±³&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;must_not&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2500</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;lte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>æœç´¢æ‰‹æœºï¼Œä½†å“ç‰Œå¿…é¡»æ˜¯åä¸ºï¼Œä»·æ ¼å¿…é¡»æ˜¯900~1599ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;must&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ‰‹æœº&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;brand&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;value&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;åä¸º&quot;</span> <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">90000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;lt&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">159900</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-3-æ’åº"><a href="#5-3-æ’åº" class="headerlink" title="5.3 æ’åº"></a>5.3 æ’åº</h3><p>elasticsearché»˜è®¤æ˜¯æ ¹æ®ç›¸å…³åº¦ç®—åˆ†ï¼ˆ_scoreï¼‰æ¥æ’åºï¼Œä½†æ˜¯ä¹Ÿæ”¯æŒè‡ªå®šä¹‰æ–¹å¼å¯¹æœç´¢ç»“æœæ’åºã€‚ä¸è¿‡åˆ†è¯å­—æ®µæ— æ³•æ’åºï¼Œ<strong>èƒ½å‚ä¸æ’åºå­—æ®µç±»å‹æœ‰ï¼škeywordç±»å‹ã€æ•°å€¼ç±»å‹ã€åœ°ç†åæ ‡ç±»å‹ã€æ—¥æœŸç±»å‹</strong>ç­‰ã€‚</p>
<p>è¯­æ³•ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /indexName/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;æ’åºå­—æ®µ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ’åºæ–¹å¼ascå’Œdesc&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>æŒ‰ç…§å•†å“ä»·æ ¼æ’åº:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;desc&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h3 id="5-4-åˆ†é¡µ"><a href="#5-4-åˆ†é¡µ" class="headerlink" title="5.4 åˆ†é¡µ"></a>5.4 åˆ†é¡µ</h3><p>elasticsearch é»˜è®¤æƒ…å†µä¸‹åªè¿”å›top10çš„æ•°æ®ã€‚è€Œå¦‚æœè¦æŸ¥è¯¢æ›´å¤šæ•°æ®å°±éœ€è¦ä¿®æ”¹åˆ†é¡µå‚æ•°äº†</p>
<h4 id="5-4-1-åŸºç¡€åˆ†é¡µ"><a href="#5-4-1-åŸºç¡€åˆ†é¡µ" class="headerlink" title="5.4.1 åŸºç¡€åˆ†é¡µ"></a>5.4.1 åŸºç¡€åˆ†é¡µ</h4><p>elasticsearchä¸­é€šè¿‡ä¿®æ”¹fromã€sizeå‚æ•°æ¥æ§åˆ¶è¦è¿”å›çš„åˆ†é¡µç»“æœï¼š</p>
<ul>
<li>fromï¼šä»ç¬¬å‡ ä¸ªæ–‡æ¡£å¼€å§‹</li>
<li>sizeï¼šæ€»å…±æŸ¥è¯¢å‡ ä¸ªæ–‡æ¡£</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match_all&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;from&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// åˆ†é¡µå¼€å§‹çš„ä½ç½®ï¼Œé»˜è®¤ä¸º0</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">10</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// æ¯é¡µæ–‡æ¡£æ•°é‡ï¼Œé»˜è®¤10</span><br>  <span class="hljs-attr">&quot;sort&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;order&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;desc&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">]</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="5-4-2-æ·±åº¦åˆ†é¡µ"><a href="#5-4-2-æ·±åº¦åˆ†é¡µ" class="headerlink" title="5.4.2 æ·±åº¦åˆ†é¡µ"></a>5.4.2 æ·±åº¦åˆ†é¡µ</h4><p>elasticsearchçš„æ•°æ®ä¸€èˆ¬ä¼šé‡‡ç”¨åˆ†ç‰‡å­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€ä¸ªç´¢å¼•ä¸­çš„æ•°æ®åˆ†æˆNä»½ï¼Œå­˜å‚¨åˆ°ä¸åŒèŠ‚ç‚¹ä¸Šã€‚è¿™ç§å­˜å‚¨æ–¹å¼æ¯”è¾ƒæœ‰åˆ©äºæ•°æ®æ‰©å±•ï¼Œä½†ç»™åˆ†é¡µå¸¦æ¥äº†ä¸€äº›éº»çƒ¦ã€‚<br>è¯•æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬ç°åœ¨è¦æŸ¥è¯¢çš„æ˜¯ç¬¬999é¡µæ•°æ®å‘¢ï¼Œæ˜¯ä¸æ˜¯è¦æ‰¾ç¬¬9990~10000çš„æ•°æ®ï¼Œé‚£å²‚ä¸æ˜¯éœ€è¦æŠŠæ¯ä¸ªåˆ†ç‰‡ä¸­çš„å‰10000åæ•°æ®éƒ½æŸ¥è¯¢å‡ºæ¥ï¼Œæ±‡æ€»åœ¨ä¸€èµ·ï¼Œåœ¨å†…å­˜ä¸­æ’åºï¼Ÿå¦‚æœæŸ¥è¯¢çš„åˆ†é¡µæ·±åº¦æ›´æ·±å‘¢ï¼Œéœ€è¦ä¸€æ¬¡æ£€ç´¢çš„æ•°æ®å²‚ä¸æ˜¯æ›´å¤šï¼Ÿ</p>
<p><img src="/img/blogs/java/springcloud/es.7.png" srcset="/img/loading.gif" lazyload></p>
<p>é’ˆå¯¹æ·±åº¦åˆ†é¡µï¼Œelasticsearchæä¾›äº†è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>search afterï¼šåˆ†é¡µæ—¶éœ€è¦æ’åºï¼ŒåŸç†æ˜¯ä»ä¸Šä¸€æ¬¡çš„æ’åºå€¼å¼€å§‹ï¼ŒæŸ¥è¯¢ä¸‹ä¸€é¡µæ•°æ®ã€‚å®˜æ–¹æ¨èä½¿ç”¨çš„æ–¹å¼ã€‚</li>
</ul>
<h3 id="5-5-é«˜äº®"><a href="#5-5-é«˜äº®" class="headerlink" title="5.5 é«˜äº®"></a>5.5 é«˜äº®</h3><p>è¯æ¡çš„é«˜äº®æ ‡ç­¾è‚¯å®šæ˜¯ç”±æœåŠ¡ç«¯æä¾›æ•°æ®çš„æ—¶å€™å·²ç»åŠ ä¸Šçš„ã€‚</p>
<p>å®ç°é«˜äº®çš„æ€è·¯å°±æ˜¯ï¼š</p>
<ul>
<li>ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®å­—æœç´¢æ•°æ®</li>
<li>æœåŠ¡ç«¯æ ¹æ®æœç´¢å…³é”®å­—åˆ°elasticsearchæœç´¢ï¼Œå¹¶ç»™æœç´¢ç»“æœä¸­çš„å…³é”®å­—è¯æ¡æ·»åŠ htmlæ ‡ç­¾</li>
<li>å‰ç«¯æå‰ç»™çº¦å®šå¥½çš„htmlæ ‡ç­¾æ·»åŠ CSSæ ·å¼</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /<span class="hljs-punctuation">&#123;</span>ç´¢å¼•åº“å<span class="hljs-punctuation">&#125;</span>/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;match&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;æœç´¢å­—æ®µ&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æœç´¢å…³é”®å­—&quot;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-attr">&quot;highlight&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;é«˜äº®å­—æ®µåç§°&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;pre_tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&lt;em&gt;&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;post_tags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&lt;/em&gt;&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="6-JavaRestClientæŸ¥è¯¢"><a href="#6-JavaRestClientæŸ¥è¯¢" class="headerlink" title="6. JavaRestClientæŸ¥è¯¢"></a>6. JavaRestClientæŸ¥è¯¢</h2><h3 id="6-1-æ–‡æ¡£æœç´¢çš„åŸºæœ¬æ­¥éª¤"><a href="#6-1-æ–‡æ¡£æœç´¢çš„åŸºæœ¬æ­¥éª¤" class="headerlink" title="6.1 æ–‡æ¡£æœç´¢çš„åŸºæœ¬æ­¥éª¤"></a>6.1 æ–‡æ¡£æœç´¢çš„åŸºæœ¬æ­¥éª¤</h3><ol>
<li>åˆ›å»ºSearchRequestå¯¹è±¡</li>
<li>å‡†å¤‡request.source()ï¼Œä¹Ÿå°±æ˜¯DSLã€‚</li>
<li>QueryBuildersæ¥æ„å»ºæŸ¥è¯¢æ¡ä»¶</li>
<li>ä¼ å…¥request.source() çš„ query() æ–¹æ³•</li>
<li>å‘é€è¯·æ±‚ï¼Œå¾—åˆ°ç»“æœ</li>
<li>è§£æç»“æœï¼ˆå‚è€ƒJSONç»“æœï¼Œä»å¤–åˆ°å†…ï¼Œé€å±‚è§£æï¼‰</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMatchAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    request.source().query(QueryBuilders.matchAllQuery());<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(SearchResponse response)</span> &#123;<br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">searchHits</span> <span class="hljs-operator">=</span> response.getHits();<br>    <span class="hljs-comment">// 1.è·å–æ€»æ¡æ•°</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> searchHits.getTotalHits().value;<br>    System.out.println(<span class="hljs-string">&quot;å…±æœç´¢åˆ°&quot;</span> + total + <span class="hljs-string">&quot;æ¡æ•°æ®&quot;</span>);<br>    <span class="hljs-comment">// 2.éå†ç»“æœæ•°ç»„</span><br>    SearchHit[] hits = searchHits.getHits();<br>    <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>        <span class="hljs-comment">// 3.å¾—åˆ°_sourceï¼Œä¹Ÿå°±æ˜¯åŸå§‹jsonæ–‡æ¡£</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-comment">// 4.ååºåˆ—åŒ–å¹¶æ‰“å°</span><br>        <span class="hljs-type">ItemDoc</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> JSONUtil.toBean(source, ItemDoc.class);<br>        System.out.println(item);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-2-å¶å­æŸ¥è¯¢"><a href="#6-2-å¶å­æŸ¥è¯¢" class="headerlink" title="6.2 å¶å­æŸ¥è¯¢"></a>6.2 å¶å­æŸ¥è¯¢</h3><p>matchæŸ¥è¯¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    request.source().query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è„±è„‚ç‰›å¥¶&quot;</span>));<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>multi_matchæŸ¥è¯¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testMultiMatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    request.source().query(QueryBuilders.multiMatchQuery(<span class="hljs-string">&quot;è„±è„‚ç‰›å¥¶&quot;</span>, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;category&quot;</span>));<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>rangeæŸ¥è¯¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testRange</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    request.source().query(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).gte(<span class="hljs-number">10000</span>).lte(<span class="hljs-number">30000</span>));<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>termæŸ¥è¯¢ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testTerm</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    request.source().query(QueryBuilders.termQuery(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;åä¸º&quot;</span>));<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-3-å¤åˆæŸ¥è¯¢"><a href="#6-3-å¤åˆæŸ¥è¯¢" class="headerlink" title="6.3 å¤åˆæŸ¥è¯¢"></a>6.3 å¤åˆæŸ¥è¯¢</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testBool</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    <span class="hljs-comment">// 2.1.å‡†å¤‡boolæŸ¥è¯¢</span><br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">bool</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery();<br>    <span class="hljs-comment">// 2.2.å…³é”®å­—æœç´¢</span><br>    bool.must(QueryBuilders.matchQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è„±è„‚ç‰›å¥¶&quot;</span>));<br>    <span class="hljs-comment">// 2.3.å“ç‰Œè¿‡æ»¤</span><br>    bool.filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;brand&quot;</span>, <span class="hljs-string">&quot;å¾·äºš&quot;</span>));<br>    <span class="hljs-comment">// 2.4.ä»·æ ¼è¿‡æ»¤</span><br>    bool.filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).lte(<span class="hljs-number">30000</span>));<br>    request.source().query(bool);<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-4-æ’åºå’Œåˆ†é¡µ"><a href="#6-4-æ’åºå’Œåˆ†é¡µ" class="headerlink" title="6.4 æ’åºå’Œåˆ†é¡µ"></a>6.4 æ’åºå’Œåˆ†é¡µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testPageAndSort</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">pageNo</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, pageSize = <span class="hljs-number">5</span>;<br><br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    <span class="hljs-comment">// 2.1.æœç´¢æ¡ä»¶å‚æ•°</span><br>    request.source().query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è„±è„‚ç‰›å¥¶&quot;</span>));<br>    <span class="hljs-comment">// 2.2.æ’åºå‚æ•°</span><br>    request.source().sort(<span class="hljs-string">&quot;price&quot;</span>, SortOrder.ASC);<br>    <span class="hljs-comment">// 2.3.åˆ†é¡µå‚æ•°</span><br>    request.source().from((pageNo - <span class="hljs-number">1</span>) * pageSize).size(pageSize);<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="6-5-é«˜äº®"><a href="#6-5-é«˜äº®" class="headerlink" title="6.5 é«˜äº®"></a>6.5 é«˜äº®</h3><ul>
<li>æ¡ä»¶åŒæ ·æ˜¯åœ¨request.source()ä¸­æŒ‡å®šï¼Œåªä¸è¿‡é«˜äº®æ¡ä»¶è¦åŸºäºHighlightBuilderæ¥æ„é€ </li>
<li>é«˜äº®å“åº”ç»“æœä¸æœç´¢çš„æ–‡æ¡£ç»“æœä¸åœ¨ä¸€èµ·ï¼Œéœ€è¦å•ç‹¬è§£æ</li>
</ul>
<p>æŸ¥è¯¢:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testHighlight</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.ç»„ç»‡è¯·æ±‚å‚æ•°</span><br>    <span class="hljs-comment">// 2.1.queryæ¡ä»¶</span><br>    request.source().query(QueryBuilders.matchQuery(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;è„±è„‚ç‰›å¥¶&quot;</span>));<br>    <span class="hljs-comment">// 2.2.é«˜äº®æ¡ä»¶</span><br>    request.source().highlighter(<br>            SearchSourceBuilder.highlight()<br>                    .field(<span class="hljs-string">&quot;name&quot;</span>)<br>                    .preTags(<span class="hljs-string">&quot;&lt;em&gt;&quot;</span>)<br>                    .postTags(<span class="hljs-string">&quot;&lt;/em&gt;&quot;</span>)<br>    );<br>    <span class="hljs-comment">// 3.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br>    <span class="hljs-comment">// 4.è§£æå“åº”</span><br>    handleResponse(response);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>è§£ææ•°æ®ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResponse</span><span class="hljs-params">(SearchResponse response)</span> &#123;<br>    <span class="hljs-type">SearchHits</span> <span class="hljs-variable">searchHits</span> <span class="hljs-operator">=</span> response.getHits();<br>    <span class="hljs-comment">// 1.è·å–æ€»æ¡æ•°</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> searchHits.getTotalHits().value;<br>    System.out.println(<span class="hljs-string">&quot;å…±æœç´¢åˆ°&quot;</span> + total + <span class="hljs-string">&quot;æ¡æ•°æ®&quot;</span>);<br>    <span class="hljs-comment">// 2.éå†ç»“æœæ•°ç»„</span><br>    SearchHit[] hits = searchHits.getHits();<br>    <span class="hljs-keyword">for</span> (SearchHit hit : hits) &#123;<br>        <span class="hljs-comment">// 3.å¾—åˆ°_sourceï¼Œä¹Ÿå°±æ˜¯åŸå§‹jsonæ–‡æ¡£</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">source</span> <span class="hljs-operator">=</span> hit.getSourceAsString();<br>        <span class="hljs-comment">// 4.ååºåˆ—åŒ–</span><br>        <span class="hljs-type">ItemDoc</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> JSONUtil.toBean(source, ItemDoc.class);<br>        <span class="hljs-comment">// 5.è·å–é«˜äº®ç»“æœ</span><br>        Map&lt;String, HighlightField&gt; hfs = hit.getHighlightFields();<br>        <span class="hljs-keyword">if</span> (CollUtils.isNotEmpty(hfs)) &#123;<br>            <span class="hljs-comment">// 5.1.æœ‰é«˜äº®ç»“æœï¼Œè·å–nameçš„é«˜äº®ç»“æœ</span><br>            <span class="hljs-type">HighlightField</span> <span class="hljs-variable">hf</span> <span class="hljs-operator">=</span> hfs.get(<span class="hljs-string">&quot;name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (hf != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 5.2.è·å–ç¬¬ä¸€ä¸ªé«˜äº®ç»“æœç‰‡æ®µï¼Œå°±æ˜¯å•†å“åç§°çš„é«˜äº®å€¼</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">hfName</span> <span class="hljs-operator">=</span> hf.getFragments()[<span class="hljs-number">0</span>].string();<br>                item.setName(hfName);<br>            &#125;<br>        &#125;<br>        System.out.println(item);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="7-æ•°æ®èšåˆ"><a href="#7-æ•°æ®èšåˆ" class="headerlink" title="7. æ•°æ®èšåˆ"></a>7. æ•°æ®èšåˆ</h2><h3 id="7-1-èšåˆçš„æ¦‚å¿µ"><a href="#7-1-èšåˆçš„æ¦‚å¿µ" class="headerlink" title="7.1 èšåˆçš„æ¦‚å¿µ"></a>7.1 èšåˆçš„æ¦‚å¿µ</h3><p>èšåˆï¼ˆaggregationsï¼‰å¯ä»¥è®©æˆ‘ä»¬æå…¶æ–¹ä¾¿çš„å®ç°å¯¹æ•°æ®çš„ç»Ÿè®¡ã€åˆ†æã€è¿ç®—</p>
<p>èšåˆå¸¸è§çš„æœ‰ä¸‰ç±»ï¼š</p>
<ul>
<li>æ¡¶ï¼ˆBucketï¼‰èšåˆï¼šç”¨æ¥å¯¹æ–‡æ¡£åšåˆ†ç»„ </li>
<li>TermAggregationï¼šæŒ‰ç…§æ–‡æ¡£å­—æ®µå€¼åˆ†ç»„ï¼Œä¾‹å¦‚æŒ‰ç…§å“ç‰Œå€¼åˆ†ç»„ã€æŒ‰ç…§å›½å®¶åˆ†ç»„</li>
<li>Date Histogramï¼šæŒ‰ç…§æ—¥æœŸé˜¶æ¢¯åˆ†ç»„ï¼Œä¾‹å¦‚ä¸€å‘¨ä¸ºä¸€ç»„ï¼Œæˆ–è€…ä¸€æœˆä¸ºä¸€ç»„</li>
<li>åº¦é‡ï¼ˆMetricï¼‰èšåˆï¼šç”¨ä»¥è®¡ç®—ä¸€äº›å€¼ï¼Œæ¯”å¦‚ï¼šæœ€å¤§å€¼ã€æœ€å°å€¼ã€å¹³å‡å€¼ç­‰ </li>
<li>Avgï¼šæ±‚å¹³å‡å€¼</li>
<li>Maxï¼šæ±‚æœ€å¤§å€¼</li>
<li>Minï¼šæ±‚æœ€å°å€¼</li>
<li>Statsï¼šåŒæ—¶æ±‚maxã€minã€avgã€sumç­‰</li>
<li>ç®¡é“ï¼ˆpipelineï¼‰èšåˆï¼šå…¶å®ƒèšåˆçš„ç»“æœä¸ºåŸºç¡€åšè¿›ä¸€æ­¥è¿ç®—</li>
</ul>
<p><strong>æ³¨æ„</strong>ï¼šå‚åŠ èšåˆçš„<strong>å­—æ®µå¿…é¡»æ˜¯keywordã€æ—¥æœŸã€æ•°å€¼ã€å¸ƒå°”ç±»å‹</strong></p>
<h3 id="7-2-DSLå®ç°èšåˆ"><a href="#7-2-DSLå®ç°èšåˆ" class="headerlink" title="7.2 DSLå®ç°èšåˆ"></a>7.2 DSLå®ç°èšåˆ</h3><h4 id="7-2-1-Bucketèšåˆ"><a href="#7-2-1-Bucketèšåˆ" class="headerlink" title="7.2.1 Bucketèšåˆ"></a>7.2.1 Bucketèšåˆ</h4><p>æˆ‘ä»¬è¦ç»Ÿè®¡æ‰€æœ‰å•†å“ä¸­å…±æœ‰å“ªäº›å•†å“åˆ†ç±»ï¼Œå…¶å®å°±æ˜¯ä»¥åˆ†ç±»ï¼ˆcategoryï¼‰å­—æ®µå¯¹æ•°æ®åˆ†ç»„</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;category_agg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;category&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>sizeï¼šè®¾ç½®sizeä¸º0ï¼Œå°±æ˜¯æ¯é¡µæŸ¥0æ¡ï¼Œåˆ™ç»“æœä¸­å°±ä¸åŒ…å«æ–‡æ¡£ï¼ŒåªåŒ…å«èšåˆ</li>
<li>aggsï¼šå®šä¹‰èšåˆ<ul>
<li>category_aggï¼šèšåˆåç§°ï¼Œè‡ªå®šä¹‰ï¼Œä½†ä¸èƒ½é‡å¤<ul>
<li>termsï¼šèšåˆçš„ç±»å‹ï¼ŒæŒ‰åˆ†ç±»èšåˆï¼Œæ‰€ä»¥ç”¨term<ul>
<li>fieldï¼šå‚ä¸èšåˆçš„å­—æ®µåç§°</li>
<li>sizeï¼šå¸Œæœ›è¿”å›çš„èšåˆç»“æœçš„æœ€å¤§æ•°é‡</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="7-2-2-å¸¦æ¡ä»¶èšåˆ"><a href="#7-2-2-å¸¦æ¡ä»¶èšåˆ" class="headerlink" title="7.2.2 å¸¦æ¡ä»¶èšåˆ"></a>7.2.2 å¸¦æ¡ä»¶èšåˆ</h4><p>ä»·æ ¼é«˜äº3000å…ƒçš„æ‰‹æœºå“ç‰Œæœ‰å“ªäº›</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ‰‹æœº&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300000</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;brand_agg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="7-2-3-Metricèšåˆ"><a href="#7-2-3-Metricèšåˆ" class="headerlink" title="7.2.3 Metricèšåˆ"></a>7.2.3 Metricèšåˆ</h4><p>æˆ‘ä»¬éœ€è¦å¯¹æ¡¶å†…çš„å•†å“åšè¿ç®—ï¼Œè·å–æ¯ä¸ªå“ç‰Œä»·æ ¼çš„æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ã€‚</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs json">GET /items/_search<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;query&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;bool&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;filter&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;term&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;category&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;æ‰‹æœº&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;range&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;price&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>              <span class="hljs-attr">&quot;gte&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300000</span><br>            <span class="hljs-punctuation">&#125;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">]</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;brand_agg&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;terms&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;brand&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;size&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">20</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;aggs&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;stats_meric&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;stats&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;field&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;price&quot;</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>stats_mericï¼šèšåˆåç§°<ul>
<li>statsï¼šèšåˆç±»å‹ï¼Œstatsæ˜¯metricèšåˆçš„ä¸€ç§<ul>
<li>fieldï¼šèšåˆå­—æ®µï¼Œè¿™é‡Œé€‰æ‹©priceï¼Œç»Ÿè®¡ä»·æ ¼</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="7-3-JavaRestClientå®ç°èšåˆ"><a href="#7-3-JavaRestClientå®ç°èšåˆ" class="headerlink" title="7.3 JavaRestClientå®ç°èšåˆ"></a>7.3 JavaRestClientå®ç°èšåˆ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">testAgg</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>    <span class="hljs-comment">// 1.åˆ›å»ºRequest</span><br>    <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SearchRequest</span>(<span class="hljs-string">&quot;items&quot;</span>);<br>    <span class="hljs-comment">// 2.å‡†å¤‡è¯·æ±‚å‚æ•°</span><br>    <span class="hljs-type">BoolQueryBuilder</span> <span class="hljs-variable">bool</span> <span class="hljs-operator">=</span> QueryBuilders.boolQuery()<br>            .filter(QueryBuilders.termQuery(<span class="hljs-string">&quot;category&quot;</span>, <span class="hljs-string">&quot;æ‰‹æœº&quot;</span>))<br>            .filter(QueryBuilders.rangeQuery(<span class="hljs-string">&quot;price&quot;</span>).gte(<span class="hljs-number">300000</span>));<br>    request.source().query(bool).size(<span class="hljs-number">0</span>);<br>    <span class="hljs-comment">// 3.èšåˆå‚æ•°</span><br>    request.source().aggregation(<br>            AggregationBuilders.terms(<span class="hljs-string">&quot;brand_agg&quot;</span>).field(<span class="hljs-string">&quot;brand&quot;</span>).size(<span class="hljs-number">5</span>)<br>    );<br>    <span class="hljs-comment">// 4.å‘é€è¯·æ±‚</span><br>    <span class="hljs-type">SearchResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> client.search(request, RequestOptions.DEFAULT);<br><br><br><br>    <span class="hljs-comment">// 5.è§£æèšåˆç»“æœ</span><br>    <span class="hljs-type">Aggregations</span> <span class="hljs-variable">aggregations</span> <span class="hljs-operator">=</span> response.getAggregations();<br>    <span class="hljs-comment">// 5.1.è·å–å“ç‰Œèšåˆ</span><br>    <span class="hljs-type">Terms</span> <span class="hljs-variable">brandTerms</span> <span class="hljs-operator">=</span> aggregations.get(<span class="hljs-string">&quot;brand_agg&quot;</span>);<br>    <span class="hljs-comment">// 5.2.è·å–èšåˆä¸­çš„æ¡¶</span><br>    List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Terms</span>.Bucket&gt; buckets = brandTerms.getBuckets();<br>    <span class="hljs-comment">// 5.3.éå†æ¡¶å†…æ•°æ®</span><br>    <span class="hljs-keyword">for</span> (Terms.Bucket bucket : buckets) &#123;<br>        <span class="hljs-comment">// 5.4.è·å–æ¡¶å†…key</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">brand</span> <span class="hljs-operator">=</span> bucket.getKeyAsString();<br>        System.out.print(<span class="hljs-string">&quot;brand = &quot;</span> + brand);<br>        <span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> bucket.getDocCount();<br>        System.out.println(<span class="hljs-string">&quot;; count = &quot;</span> + count);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h1 id="ä¸ƒ-å¾®æœåŠ¡é¢è¯•ç¯‡"><a href="#ä¸ƒ-å¾®æœåŠ¡é¢è¯•ç¯‡" class="headerlink" title="ä¸ƒ. å¾®æœåŠ¡é¢è¯•ç¯‡"></a>ä¸ƒ. å¾®æœåŠ¡é¢è¯•ç¯‡</h1><h2 id="1-åˆ†å¸ƒå¼äº‹åŠ¡"><a href="#1-åˆ†å¸ƒå¼äº‹åŠ¡" class="headerlink" title="1. åˆ†å¸ƒå¼äº‹åŠ¡"></a>1. åˆ†å¸ƒå¼äº‹åŠ¡</h2><h3 id="1-1-CAPå®šç†"><a href="#1-1-CAPå®šç†" class="headerlink" title="1.1 CAPå®šç†"></a>1.1 CAPå®šç†</h3><p>åŠ å·å¤§å­¦çš„è®¡ç®—æœºç§‘å­¦å®¶ Eric Brewer æå‡ºï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰ä¸‰ä¸ªæŒ‡æ ‡ï¼š</p>
<ul>
<li>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰</li>
<li>Availabilityï¼ˆå¯ç”¨æ€§ï¼‰</li>
<li>Partition tolerance ï¼ˆåˆ†åŒºå®¹é”™æ€§ï¼‰<br>å®ƒä»¬çš„ç¬¬ä¸€ä¸ªå­—æ¯åˆ†åˆ«æ˜¯ Cã€Aã€Pã€‚Eric Brewerè®¤ä¸ºä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿæ¶æ„æ–¹æ¡ˆéƒ½ä¸å¯èƒ½åŒæ—¶æ»¡è¶³è¿™3ä¸ªç›®æ ‡ï¼Œè¿™ä¸ªç»“è®ºå°±å«åš CAP å®šç†ã€‚</li>
</ul>
<h4 id="1-1-1-ä¸€è‡´æ€§"><a href="#1-1-1-ä¸€è‡´æ€§" class="headerlink" title="1.1.1.ä¸€è‡´æ€§"></a>1.1.1.ä¸€è‡´æ€§</h4><p>Consistencyï¼ˆä¸€è‡´æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä»»æ„èŠ‚ç‚¹ï¼Œå¾—åˆ°çš„æ•°æ®å¿…é¡»ä¸€è‡´ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.1.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="1-1-2-å¯ç”¨æ€§"><a href="#1-1-2-å¯ç”¨æ€§" class="headerlink" title="1.1.2.å¯ç”¨æ€§"></a>1.1.2.å¯ç”¨æ€§</h4><p>Availability ï¼ˆå¯ç”¨æ€§ï¼‰ï¼šç”¨æˆ·è®¿é—®åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ï¼Œè¯»æˆ–å†™æ“ä½œæ€»èƒ½æˆåŠŸã€‚<br>åªèƒ½è¯»ä¸èƒ½å†™ï¼Œæˆ–è€…åªèƒ½å†™ä¸èƒ½è¯»ï¼Œæˆ–è€…ä¸¤è€…éƒ½ä¸èƒ½æ‰§è¡Œï¼Œå°±è¯´æ˜ç³»ç»Ÿå¼±å¯ç”¨æˆ–ä¸å¯ç”¨ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.1.2.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="1-1-3-åˆ†åŒºå®¹é”™æ€§"><a href="#1-1-3-åˆ†åŒºå®¹é”™æ€§" class="headerlink" title="1.1.3 åˆ†åŒºå®¹é”™æ€§"></a>1.1.3 åˆ†åŒºå®¹é”™æ€§</h4><ul>
<li>Partitionï¼ˆåˆ†åŒºï¼‰ï¼šå› ä¸ºç½‘ç»œæ•…éšœæˆ–å…¶å®ƒåŸå› å¯¼è‡´åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„éƒ¨åˆ†èŠ‚ç‚¹ä¸å…¶å®ƒèŠ‚ç‚¹å¤±å»è¿æ¥ï¼Œå½¢æˆç‹¬ç«‹åˆ†åŒºã€‚</li>
<li>Toleranceï¼ˆå®¹é”™ï¼‰ï¼šç³»ç»Ÿè¦èƒ½å®¹å¿ç½‘ç»œåˆ†åŒºç°è±¡ï¼Œå‡ºç°åˆ†åŒºæ—¶ï¼Œæ•´ä¸ªç³»ç»Ÿä¹Ÿè¦æŒç»­å¯¹å¤–æä¾›æœåŠ¡<ul>
<li>å¦‚æœæ­¤æ—¶åªå…è®¸è¯»ï¼Œä¸å…è®¸å†™ï¼Œæ»¡è¶³æ‰€æœ‰èŠ‚ç‚¹ä¸€è‡´æ€§ã€‚ä½†æ˜¯ç‰ºç‰²äº†å¯ç”¨æ€§ã€‚ç¬¦åˆCP</li>
<li>å¦‚æœæ­¤æ—¶å…è®¸ä»»æ„è¯»å†™ï¼Œæ»¡è¶³äº†å¯ç”¨æ€§ã€‚ä½†ç”±äºnode3æ— æ³•åŒæ­¥ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œç‰ºç‰²äº†ä¸€è‡´æ€§ã€‚ç¬¦åˆAP</li>
</ul>
</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.1.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-2-BASEç†è®º"><a href="#1-2-BASEç†è®º" class="headerlink" title="1.2 BASEç†è®º"></a>1.2 BASEç†è®º</h3><p>BASEç†è®ºæ˜¯å¯¹CAPçš„ä¸€ç§è§£å†³æ€è·¯ï¼ŒåŒ…å«ä¸‰ä¸ªæ€æƒ³ï¼š</p>
<ul>
<li>Basically Available ï¼ˆ<strong>åŸºæœ¬å¯ç”¨</strong>ï¼‰ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å‡ºç°æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œå³ä¿è¯æ ¸å¿ƒå¯ç”¨ã€‚</li>
<li>Soft Stateï¼ˆ<strong>è½¯çŠ¶æ€</strong>ï¼‰ï¼šåœ¨ä¸€å®šæ—¶é—´å†…ï¼Œå…è®¸å‡ºç°ä¸­é—´çŠ¶æ€ï¼Œæ¯”å¦‚ä¸´æ—¶çš„ä¸ä¸€è‡´çŠ¶æ€ã€‚</li>
<li>Eventually Consistentï¼ˆ<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰ï¼šè™½ç„¶æ— æ³•ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨è½¯çŠ¶æ€ç»“æŸåï¼Œæœ€ç»ˆè¾¾åˆ°æ•°æ®ä¸€è‡´ã€‚</li>
</ul>
<p>è€Œåˆ†å¸ƒå¼äº‹åŠ¡æœ€å¤§çš„é—®é¢˜æ˜¯å„ä¸ªå­äº‹åŠ¡çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œå› æ­¤å¯ä»¥å€Ÿé‰´CAPå®šç†å’ŒBASEç†è®ºï¼š</p>
<ul>
<li><strong>CPæ¨¡å¼</strong>ï¼šå„ä¸ªå­äº‹åŠ¡æ‰§è¡Œåäº’ç›¸ç­‰å¾…ï¼ŒåŒæ—¶æäº¤ï¼ŒåŒæ—¶å›æ»šï¼Œè¾¾æˆ<strong>å¼ºä¸€è‡´</strong>ã€‚ä½†äº‹åŠ¡ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¤„äºå¼±å¯ç”¨çŠ¶æ€ã€‚ä¾‹å¦‚XAæ¨¡å¼</li>
<li><strong>APæ¨¡å¼</strong>ï¼šå„å­äº‹åŠ¡åˆ†åˆ«æ‰§è¡Œå’Œæäº¤ï¼Œå…è®¸å‡ºç°ç»“æœä¸ä¸€è‡´ï¼Œç„¶åé‡‡ç”¨å¼¥è¡¥æªæ–½æ¢å¤æ•°æ®å³å¯ï¼Œå®ç°æœ€ç»ˆä¸€è‡´ã€‚ä¾‹å¦‚ATæ¨¡å¼å°±æ˜¯å¦‚æ­¤</li>
</ul>
<h3 id="1-3-ATæ¨¡å¼çš„è„å†™é—®é¢˜"><a href="#1-3-ATæ¨¡å¼çš„è„å†™é—®é¢˜" class="headerlink" title="1.3 ATæ¨¡å¼çš„è„å†™é—®é¢˜"></a>1.3 ATæ¨¡å¼çš„è„å†™é—®é¢˜</h3><p>ATæ¨¡å¼ä¹Ÿåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šç¬¬ä¸€é˜¶æ®µæ˜¯è®°å½•æ•°æ®å¿«ç…§ï¼Œæ‰§è¡Œå¹¶æäº¤äº‹åŠ¡ï¼š</p>
<p><img src="/img/blogs/java/springcloud/7.1.4.png" srcset="/img/loading.gif" lazyload></p>
<p>ç¬¬äºŒé˜¶æ®µæ ¹æ®é˜¶æ®µä¸€çš„ç»“æœæ¥åˆ¤æ–­ï¼š</p>
<ul>
<li>å¦‚æœæ¯ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½æˆåŠŸï¼Œåˆ™äº‹åŠ¡å·²ç»ç»“æŸï¼ˆå› ä¸ºé˜¶æ®µä¸€å·²ç»æäº¤ï¼‰ï¼Œå› æ­¤åˆ é™¤é˜¶æ®µä¸€çš„å¿«ç…§å³å¯</li>
<li>å¦‚æœæœ‰ä»»æ„åˆ†æ”¯äº‹åŠ¡å¤±è´¥ï¼Œåˆ™éœ€è¦æ ¹æ®å¿«ç…§æ¢å¤åˆ°æ›´æ–°å‰æ•°æ®ã€‚ç„¶ååˆ é™¤å¿«ç…§</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.1.5.png" srcset="/img/loading.gif" lazyload></p>
<p>è¿™ç§æ¨¡å¼åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ˆ99%ï¼‰å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸è¿‡åœ¨æç«¯æƒ…å†µä¸‹ï¼Œç‰¹åˆ«æ˜¯å¤šçº¿ç¨‹å¹¶å‘è®¿é—®ATæ¨¡å¼çš„åˆ†å¸ƒå¼äº‹åŠ¡æ—¶ï¼Œæœ‰å¯èƒ½å‡ºç°è„å†™é—®é¢˜ï¼Œå¦‚å›¾ï¼š</p>
<p><img src="/img/blogs/java/springcloud/7.1.6.png" srcset="/img/loading.gif" lazyload></p>
<p>è§£å†³æ€è·¯å°±æ˜¯å¼•å…¥äº†å…¨å±€é”çš„æ¦‚å¿µã€‚åœ¨é‡Šæ”¾DBé”ä¹‹å‰ï¼Œå…ˆæ‹¿åˆ°å…¨å±€é”ã€‚é¿å…åŒä¸€æ—¶åˆ»æœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡æ¥æ“ä½œå½“å‰æ•°æ®ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.1.7.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="1-4-TCCæ¨¡å¼"><a href="#1-4-TCCæ¨¡å¼" class="headerlink" title="1.4 TCCæ¨¡å¼"></a>1.4 TCCæ¨¡å¼</h3><p>TCCæ¨¡å¼ä¸ATæ¨¡å¼éå¸¸ç›¸ä¼¼ï¼Œæ¯é˜¶æ®µéƒ½æ˜¯ç‹¬ç«‹äº‹åŠ¡ï¼Œä¸åŒçš„æ˜¯TCCé€šè¿‡äººå·¥ç¼–ç æ¥å®ç°æ•°æ®æ¢å¤ã€‚éœ€è¦å®ç°ä¸‰ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼› </li>
<li>confirmï¼šå®Œæˆèµ„æºæ“ä½œä¸šåŠ¡ï¼›è¦æ±‚ try æˆåŠŸ confirm ä¸€å®šè¦èƒ½æˆåŠŸã€‚ </li>
<li>cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼Œå¯ä»¥ç†è§£ä¸ºtryçš„åå‘æ“ä½œã€‚</li>
</ul>
<p>ä¸¾ä¾‹:</p>
<p><img src="/img/blogs/java/springcloud/7.1.8.png" srcset="/img/loading.gif" lazyload></p>
<p>TCCå·¥ä½œæ¨¡å‹å›¾ï¼š</p>
<p><img src="/img/blogs/java/springcloud/7.1.9.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>å‡å¦‚ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ä¸­åŒ…å«ä¸¤ä¸ªåˆ†æ”¯äº‹åŠ¡ï¼Œtryé˜¶æ®µï¼Œä¸€ä¸ªåˆ†æ”¯æˆåŠŸæ‰§è¡Œï¼Œå¦ä¸€ä¸ªåˆ†æ”¯äº‹åŠ¡é˜»å¡</li>
<li>å¦‚æœé˜»å¡æ—¶é—´å¤ªé•¿ï¼Œå¯èƒ½å¯¼è‡´å…¨å±€äº‹åŠ¡è¶…æ—¶è€Œè§¦å‘äºŒé˜¶æ®µçš„cancelæ“ä½œã€‚ä¸¤ä¸ªåˆ†æ”¯äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œcancelæ“ä½œ</li>
<li>è¦çŸ¥é“ï¼Œå…¶ä¸­ä¸€ä¸ªåˆ†æ”¯æ˜¯æœªæ‰§è¡Œtryæ“ä½œçš„ï¼Œç›´æ¥æ‰§è¡Œäº†cancelæ“ä½œï¼Œåè€Œä¼šå¯¼è‡´æ•°æ®é”™è¯¯ã€‚å› æ­¤ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°½ç®¡cancelæ–¹æ³•è¦æ‰§è¡Œï¼Œä½†å…¶ä¸­ä¸èƒ½åšä»»ä½•å›æ»šæ“ä½œï¼Œè¿™å°±æ˜¯ç©ºå›æ»š</li>
<li>å¯¹äºæ•´ä¸ªç©ºå›æ»šçš„åˆ†æ”¯äº‹åŠ¡ï¼Œå°†æ¥tryæ–¹æ³•é˜»å¡ç»“æŸä¾ç„¶ä¼šæ‰§è¡Œã€‚ä½†æ˜¯æ•´ä¸ªå…¨å±€äº‹åŠ¡å…¶å®å·²ç»ç»“æŸäº†ï¼Œå› æ­¤æ°¸è¿œä¸ä¼šå†æœ‰confirmæˆ–cancelï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªäº‹åŠ¡æ‰§è¡Œäº†ä¸€åŠï¼Œå¤„äºæ‚¬æŒ‚çŠ¶æ€ï¼Œè¿™å°±æ˜¯ä¸šåŠ¡æ‚¬æŒ‚é—®é¢˜</li>
</ul>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>TCCæ¨¡å¼çš„æ¯ä¸ªé˜¶æ®µæ˜¯åšä»€ä¹ˆçš„ï¼Ÿ</p>
<ul>
<li>Tryï¼šèµ„æºæ£€æŸ¥å’Œé¢„ç•™</li>
<li>Confirmï¼šä¸šåŠ¡æ‰§è¡Œå’Œæäº¤</li>
<li>Cancelï¼šé¢„ç•™èµ„æºçš„é‡Šæ”¾</li>
</ul>
<p>TCCçš„ä¼˜ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>ä¸€é˜¶æ®µå®Œæˆç›´æ¥æäº¤äº‹åŠ¡ï¼Œé‡Šæ”¾æ•°æ®åº“èµ„æºï¼Œæ€§èƒ½å¥½</li>
<li>ç›¸æ¯”ATæ¨¡å‹ï¼Œæ— éœ€ç”Ÿæˆå¿«ç…§ï¼Œæ— éœ€ä½¿ç”¨å…¨å±€é”ï¼Œæ€§èƒ½æœ€å¼º</li>
<li>ä¸ä¾èµ–æ•°æ®åº“äº‹åŠ¡ï¼Œè€Œæ˜¯ä¾èµ–è¡¥å¿æ“ä½œï¼Œå¯ä»¥ç”¨äºéäº‹åŠ¡å‹æ•°æ®åº“</li>
</ul>
<p>TCCçš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<ul>
<li>æœ‰ä»£ç ä¾µå…¥ï¼Œéœ€è¦äººä¸ºç¼–å†™tryã€Confirmå’ŒCancelæ¥å£ï¼Œå¤ªéº»çƒ¦</li>
<li>è½¯çŠ¶æ€ï¼Œäº‹åŠ¡æ˜¯æœ€ç»ˆä¸€è‡´</li>
<li>éœ€è¦è€ƒè™‘Confirmå’ŒCancelçš„å¤±è´¥æƒ…å†µï¼Œåšå¥½å¹‚ç­‰å¤„ç†ã€äº‹åŠ¡æ‚¬æŒ‚å’Œç©ºå›æ»šå¤„ç†</li>
</ul>
<h3 id="1-5-æœ€å¤§åŠªåŠ›é€šçŸ¥"><a href="#1-5-æœ€å¤§åŠªåŠ›é€šçŸ¥" class="headerlink" title="1.5 æœ€å¤§åŠªåŠ›é€šçŸ¥"></a>1.5 æœ€å¤§åŠªåŠ›é€šçŸ¥</h3><p>æœ€å¤§åŠªåŠ›é€šçŸ¥æ˜¯ä¸€ç§æœ€ç»ˆä¸€è‡´æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚é¡¾æ˜æ€è®®ï¼Œå°±æ˜¯é€šè¿‡æ¶ˆæ¯é€šçŸ¥çš„æ–¹å¼æ¥é€šçŸ¥äº‹åŠ¡å‚ä¸è€…å®Œæˆä¸šåŠ¡æ‰§è¡Œï¼Œå¦‚æœæ‰§è¡Œå¤±è´¥ä¼šå¤šæ¬¡é€šçŸ¥ã€‚æ— éœ€ä»»ä½•åˆ†å¸ƒå¼äº‹åŠ¡ç»„ä»¶ä»‹å…¥ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.1.10.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="2-æ³¨å†Œä¸­å¿ƒ"><a href="#2-æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="2. æ³¨å†Œä¸­å¿ƒ"></a>2. æ³¨å†Œä¸­å¿ƒ</h2><h3 id="2-1-ç¯å¢ƒéš”ç¦»"><a href="#2-1-ç¯å¢ƒéš”ç¦»" class="headerlink" title="2.1 ç¯å¢ƒéš”ç¦»"></a>2.1 ç¯å¢ƒéš”ç¦»</h3><p>ä¼ä¸šå®é™…å¼€å‘ä¸­ï¼Œå¾€å¾€ä¼šæ­å»ºå¤šä¸ªè¿è¡Œç¯å¢ƒï¼Œä¾‹å¦‚ï¼šå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€å‘å¸ƒç¯å¢ƒã€‚ä¸åŒç¯å¢ƒä¹‹é—´éœ€è¦éš”ç¦»ã€‚æˆ–è€…ä¸åŒé¡¹ç›®ä½¿ç”¨äº†ä¸€å¥—Nacosï¼Œä¸åŒé¡¹ç›®ä¹‹é—´è¦åšç¯å¢ƒéš”ç¦»ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.2.1.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>Nacosä¸­å¯ä»¥é…ç½®å¤šä¸ªnamespaceï¼Œç›¸äº’ä¹‹é—´å®Œå…¨éš”ç¦»ã€‚é»˜è®¤çš„namespaceåä¸ºpublic</li>
<li>namespaceä¸‹è¿˜å¯ä»¥ç»§ç»­åˆ†ç»„ï¼Œä¹Ÿå°±æ˜¯group ï¼Œç›¸äº’éš”ç¦»ã€‚ é»˜è®¤çš„groupæ˜¯DEFAULT_GROUP</li>
<li>groupä¹‹ä¸‹å°±æ˜¯æœåŠ¡å’Œé…ç½®äº†</li>
</ul>
<h3 id="2-2-åˆ†çº§æ¨¡å‹"><a href="#2-2-åˆ†çº§æ¨¡å‹" class="headerlink" title="2.2 åˆ†çº§æ¨¡å‹"></a>2.2 åˆ†çº§æ¨¡å‹</h3><p>åœ¨ä¸€äº›å¤§å‹åº”ç”¨ä¸­ï¼ŒåŒä¸€ä¸ªæœåŠ¡å¯ä»¥éƒ¨ç½²å¾ˆå¤šå®ä¾‹ã€‚è€Œè¿™äº›å®ä¾‹å¯èƒ½åˆ†å¸ƒåœ¨å…¨å›½å„åœ°çš„ä¸åŒæœºæˆ¿ã€‚ç”±äºå­˜åœ¨åœ°åŸŸå·®å¼‚ï¼Œç½‘ç»œä¼ è¾“çš„é€Ÿåº¦ä¼šæœ‰å¾ˆå¤§ä¸åŒï¼Œå› æ­¤åœ¨åšæœåŠ¡æ²»ç†æ—¶éœ€è¦åŒºåˆ†ä¸åŒæœºæˆ¿çš„å®ä¾‹ã€‚</p>
<p>Nacosä¸­æä¾›äº†é›†ç¾¤ï¼ˆclusterï¼‰çš„æ¦‚å¿µï¼Œæ¥å¯¹åº”ä¸åŒæœºæˆ¿ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæœåŠ¡ï¼ˆserviceï¼‰ä¸‹å¯ä»¥æœ‰å¾ˆå¤šé›†ç¾¤ï¼ˆclusterï¼‰ï¼Œè€Œä¸€ä¸ªé›†ç¾¤ï¼ˆclusterï¼‰ä¸­ä¸‹åˆå¯ä»¥åŒ…å«å¾ˆå¤šå®ä¾‹ï¼ˆinstanceï¼‰ã€‚</p>
<p><img src="/img/blogs/java/springcloud/7.2.2.png" srcset="/img/loading.gif" lazyload></p>
<p>ä»»ä½•ä¸€ä¸ªå¾®æœåŠ¡çš„å®ä¾‹åœ¨æ³¨å†Œåˆ°Nacosæ—¶ï¼Œéƒ½ä¼šç”Ÿæˆä»¥ä¸‹å‡ ä¸ªä¿¡æ¯ï¼Œç”¨æ¥ç¡®è®¤å½“å‰å®ä¾‹çš„èº«ä»½ï¼Œä»å¤–åˆ°å†…ä¾æ¬¡æ˜¯ï¼š</p>
<ul>
<li><p>namespaceï¼šå‘½åç©ºé—´</p>
</li>
<li><p>groupï¼šåˆ†ç»„</p>
</li>
<li><p>serviceï¼šæœåŠ¡å</p>
</li>
<li><p>clusterï¼šé›†ç¾¤</p>
</li>
<li><p>instanceï¼šå®ä¾‹ï¼ŒåŒ…å«ipå’Œç«¯å£<br>è¿™å°±æ˜¯nacosä¸­çš„æœåŠ¡åˆ†çº§æ¨¡å‹ã€‚</p>
</li>
<li><p>åœ¨Nacoså†…éƒ¨ä¼šæœ‰ä¸€ä¸ªæœåŠ¡å®ä¾‹çš„æ³¨å†Œè¡¨ï¼Œæ˜¯åŸºäºMapå®ç°çš„ï¼Œå…¶ç»“æ„ä¸åˆ†çº§æ¨¡å‹çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š</p>
</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.2.3.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="3-è¿œç¨‹è°ƒç”¨"><a href="#3-è¿œç¨‹è°ƒç”¨" class="headerlink" title="3. è¿œç¨‹è°ƒç”¨"></a>3. è¿œç¨‹è°ƒç”¨</h2><h3 id="3-1-è´Ÿè½½å‡è¡¡åŸç†"><a href="#3-1-è´Ÿè½½å‡è¡¡åŸç†" class="headerlink" title="3.1 è´Ÿè½½å‡è¡¡åŸç†"></a>3.1 è´Ÿè½½å‡è¡¡åŸç†</h3><p>OpenFeignåœ¨æ•´åˆSpringCloudLoadBalanceræ—¶ï¼Œä¸æˆ‘ä»¬æ‰‹åŠ¨æœåŠ¡å‘ç°ã€å¤æ‚å‡è¡¡çš„æµç¨‹ç±»ä¼¼ã€‚</p>
<ol>
<li>è·å–serviceIdï¼Œä¹Ÿå°±æ˜¯æœåŠ¡åç§°</li>
<li>æ ¹æ®serviceIdæ‹‰å–æœåŠ¡åˆ—è¡¨</li>
<li>åˆ©ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©ä¸€ä¸ªæœåŠ¡</li>
<li>é‡æ„è¯·æ±‚çš„URLè·¯å¾„ï¼Œå‘èµ·è¿œç¨‹è°ƒç”¨</li>
</ol>
<p><strong>è´Ÿè½½å‡è¡¡åŸç†</strong>ï¼š</p>
<p><img src="/img/blogs/java/springcloud/7.3.1.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="åˆ‡æ¢è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#åˆ‡æ¢è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="åˆ‡æ¢è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>åˆ‡æ¢è´Ÿè½½å‡è¡¡ç­–ç•¥</h4><h2 id="4-æœåŠ¡ä¿æŠ¤"><a href="#4-æœåŠ¡ä¿æŠ¤" class="headerlink" title="4. æœåŠ¡ä¿æŠ¤"></a>4. æœåŠ¡ä¿æŠ¤</h2><h3 id="4-1-çº¿ç¨‹éš”ç¦»"><a href="#4-1-çº¿ç¨‹éš”ç¦»" class="headerlink" title="4.1 çº¿ç¨‹éš”ç¦»"></a>4.1 çº¿ç¨‹éš”ç¦»</h3><p>çº¿ç¨‹éš”ç¦»æœ‰ä¸¤ç§æ–¹å¼å®ç°ï¼š</p>
<ul>
<li>çº¿ç¨‹æ± éš”ç¦»(Hystixé»˜è®¤é‡‡ç”¨)ï¼šç»™æ¯ä¸ªæœåŠ¡è°ƒç”¨ä¸šåŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œåˆ©ç”¨çº¿ç¨‹æ± æœ¬èº«å®ç°éš”ç¦»æ•ˆæœ</li>
<li>ä¿¡å·é‡éš”ç¦»(Sentinelé»˜è®¤ä½¿ç”¨)ï¼šä¸åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯è®¡æ•°å™¨æ¨¡å¼ï¼Œè®°å½•ä¸šåŠ¡ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡ï¼Œè¾¾åˆ°ä¿¡å·é‡ä¸Šé™æ—¶ï¼Œç¦æ­¢æ–°çš„è¯·æ±‚</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.4.1.png" srcset="/img/loading.gif" lazyload></p>
<p><strong>Sentinelçš„çº¿ç¨‹éš”ç¦»ä¸Hystixçš„çº¿ç¨‹éš”ç¦»æœ‰ä»€ä¹ˆå·®åˆ«?</strong></p>
<ul>
<li>é—®é¢˜è¯´æ˜ï¼šè€ƒå¯Ÿå¯¹çº¿ç¨‹éš”ç¦»æ–¹æ¡ˆçš„æŒæ¡æƒ…å†µ</li>
<li>éš¾æ˜“ç¨‹åº¦ï¼šä¸€èˆ¬</li>
<li>å‚è€ƒè¯æœ¯ï¼š<ul>
<li>ç­”ï¼šçº¿ç¨‹éš”ç¦»å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± éš”ç¦»æˆ–è€…ä¿¡å·é‡éš”ç¦»ã€‚<ul>
<li>Hystixé»˜è®¤æ˜¯åŸºäºçº¿ç¨‹æ± å®ç°çš„çº¿ç¨‹éš”ç¦»ï¼Œæ¯ä¸€ä¸ªè¢«éš”ç¦»çš„ä¸šåŠ¡éƒ½è¦åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹è¿‡å¤šä¼šå¸¦æ¥é¢å¤–çš„CPUå¼€é”€ï¼Œæ€§èƒ½ä¸€èˆ¬ï¼Œä½†æ˜¯éš”ç¦»æ€§æ›´å¼ºã€‚</li>
<li>Sentinelåˆ™æ˜¯åŸºäºä¿¡å·é‡éš”ç¦»çš„åŸç†ï¼Œè¿™ç§æ–¹å¼ä¸ç”¨åˆ›å»ºçº¿ç¨‹æ± ï¼Œæ€§èƒ½è¾ƒå¥½ï¼Œä½†æ˜¯éš”ç¦»æ€§ä¸€èˆ¬ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="4-2-æ»‘åŠ¨çª—å£ç®—æ³•"><a href="#4-2-æ»‘åŠ¨çª—å£ç®—æ³•" class="headerlink" title="4.2 æ»‘åŠ¨çª—å£ç®—æ³•"></a>4.2 æ»‘åŠ¨çª—å£ç®—æ³•</h3><p>åœ¨ç†”æ–­åŠŸèƒ½ä¸­ï¼Œéœ€è¦ç»Ÿè®¡å¼‚å¸¸è¯·æ±‚æˆ–æ…¢è¯·æ±‚æ¯”ä¾‹ï¼Œä¹Ÿå°±æ˜¯è®¡æ•°ã€‚åœ¨é™æµçš„æ—¶å€™ï¼Œè¦ç»Ÿè®¡æ¯ç§’é’Ÿçš„QPSï¼ŒåŒæ ·æ˜¯è®¡æ•°ã€‚å¯è§è®¡æ•°ç®—æ³•åœ¨ç†”æ–­é™æµä¸­çš„åº”ç”¨éå¸¸å¤šã€‚sentinelä¸­é‡‡ç”¨çš„è®¡æ•°å™¨ç®—æ³•å°±æ˜¯æ»‘åŠ¨çª—å£è®¡æ•°ç®—æ³•ã€‚</p>
<h4 id="4-2-1-å›ºå®šçª—å£è®¡æ•°"><a href="#4-2-1-å›ºå®šçª—å£è®¡æ•°" class="headerlink" title="4.2.1 å›ºå®šçª—å£è®¡æ•°"></a>4.2.1 å›ºå®šçª—å£è®¡æ•°</h4><p>å›ºå®šçª—å£è®¡æ•°å™¨ç®—æ³•æ¦‚å¿µå¦‚ä¸‹ï¼š</p>
<ul>
<li>å°†æ—¶é—´åˆ’åˆ†ä¸ºå¤šä¸ªçª—å£ï¼Œçª—å£æ—¶é—´è·¨åº¦ç§°ä¸ºIntervalï¼Œæœ¬ä¾‹ä¸­ä¸º1000msï¼›</li>
<li>æ¯ä¸ªçª—å£åˆ†åˆ«è®¡æ•°ç»Ÿè®¡ï¼Œæ¯æœ‰ä¸€æ¬¡è¯·æ±‚å°±å°†è®¡æ•°å™¨åŠ ä¸€ï¼Œé™æµå°±æ˜¯è®¾ç½®è®¡æ•°å™¨é˜ˆå€¼ï¼Œæœ¬ä¾‹ä¸º3</li>
<li>å¦‚æœè®¡æ•°å™¨è¶…è¿‡äº†é™æµé˜ˆå€¼ï¼Œåˆ™è¶…å‡ºé˜ˆå€¼çš„è¯·æ±‚éƒ½è¢«ä¸¢å¼ƒã€‚</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.4.2.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="4-2-2-æ»‘åŠ¨çª—å£ç®—æ³•"><a href="#4-2-2-æ»‘åŠ¨çª—å£ç®—æ³•" class="headerlink" title="4.2.2 æ»‘åŠ¨çª—å£ç®—æ³•"></a>4.2.2 æ»‘åŠ¨çª—å£ç®—æ³•</h4><p>å›ºå®šæ—¶é—´çª—å£ç®—æ³•ä¸­çª—å£æœ‰å¾ˆå¤šï¼Œå…¶è·¨åº¦å’Œä½ç½®æ˜¯ä¸æ—¶é—´åŒºé—´ç»‘å®šï¼Œå› æ­¤æ˜¯å¾ˆå¤šå›ºå®šä¸åŠ¨çš„çª—å£ã€‚è€Œæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ä¸­åªåŒ…å«1ä¸ªå›ºå®šè·¨åº¦çš„çª—å£ï¼Œä½†çª—å£æ˜¯å¯ç§»åŠ¨åŠ¨çš„ï¼Œä¸æ—¶é—´åŒºé—´æ— å…³ã€‚</p>
<p>æ»‘åŠ¨çª—å£è®¡æ•°å™¨ç®—æ³•ä¼šå°†ä¸€ä¸ªçª—å£åˆ’åˆ†ä¸ºnä¸ªæ›´å°çš„åŒºé—´ï¼Œä¾‹å¦‚</p>
<ul>
<li>çª—å£æ—¶é—´è·¨åº¦Intervalä¸º1ç§’ï¼›åŒºé—´æ•°é‡ n &#x3D; 2 ï¼Œåˆ™æ¯ä¸ªå°åŒºé—´æ—¶é—´è·¨åº¦ä¸º500msï¼Œæ¯ä¸ªåŒºé—´éƒ½æœ‰è®¡æ•°å™¨</li>
<li>é™æµé˜ˆå€¼ä¾ç„¶ä¸º3ï¼Œæ—¶é—´çª—å£ï¼ˆ1ç§’ï¼‰å†…è¯·æ±‚è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œè¶…å‡ºçš„è¯·æ±‚è¢«é™æµ</li>
<li>çª—å£ä¼šæ ¹æ®å½“å‰è¯·æ±‚æ‰€åœ¨æ—¶é—´ï¼ˆcurrentTimeï¼‰ç§»åŠ¨ï¼Œçª—å£èŒƒå›´æ˜¯ä»ï¼ˆcurrentTime-Intervalï¼‰ä¹‹åçš„ç¬¬ä¸€ä¸ªæ—¶åŒºå¼€å§‹ï¼Œåˆ°currentTimeæ‰€åœ¨æ—¶åŒºç»“æŸã€‚</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.4.3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="4-3-æ¼æ¡¶ç®—æ³•"><a href="#4-3-æ¼æ¡¶ç®—æ³•" class="headerlink" title="4.3 æ¼æ¡¶ç®—æ³•"></a>4.3 æ¼æ¡¶ç®—æ³•</h3><p>æ¼æ¡¶ç®—æ³•è¯´æ˜ï¼š</p>
<ul>
<li>å°†æ¯ä¸ªè¯·æ±‚è§†ä½œâ€æ°´æ»´â€æ”¾å…¥â€æ¼æ¡¶â€è¿›è¡Œå­˜å‚¨ï¼›</li>
<li>â€œæ¼æ¡¶â€ä»¥å›ºå®šé€Ÿç‡å‘å¤–â€æ¼â€å‡ºè¯·æ±‚æ¥æ‰§è¡Œï¼Œå¦‚æœâ€æ¼æ¡¶â€ç©ºäº†åˆ™åœæ­¢â€æ¼æ°´â€ï¼›</li>
<li>å¦‚æœâ€æ¼æ¡¶â€æ»¡äº†åˆ™å¤šä½™çš„â€æ°´æ»´â€ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚</li>
<li>å¯ä»¥ç†è§£æˆè¯·æ±‚åœ¨æ¡¶å†…æ’é˜Ÿç­‰å¾…</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.4.4.png" srcset="/img/loading.gif" lazyload></p>
<p>Sentinelå†…éƒ¨åŸºäºæ¼æ¡¶ç®—æ³•å®ç°äº†æ’é˜Ÿç­‰å¾…æ•ˆæœï¼Œæ¡¶çš„å®¹é‡å–å†³é™æµçš„QPSé˜ˆå€¼ä»¥åŠå…è®¸ç­‰å¾…çš„æœ€å¤§è¶…æ—¶æ—¶é—´ï¼š<br>ä¾‹å¦‚ï¼šé™æµQPS&#x3D;5ï¼Œé˜Ÿåˆ—è¶…æ—¶æ—¶é—´ä¸º2000msã€‚æˆ‘ä»¬è®©æ‰€æœ‰è¯·æ±‚è¿›å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œå¦‚åŒè¿›å…¥æ¼æ¡¶ä¸­ã€‚ç”±äºæ¼æ¡¶æ˜¯å›ºå®šé¢‘ç‡æ‰§è¡Œï¼Œå› æ­¤QPSä¸º5å°±æ˜¯æ¯200msæ‰§è¡Œä¸€ä¸ªè¯·æ±‚ã€‚é‚£ç¬¬Nä¸ªè¯·æ±‚çš„é¢„æœŸçš„æ‰§è¡Œæ—¶é—´ æ˜¯ç¬¬(N - 1) * 200msã€‚å¦‚æœè¯·æ±‚é¢„æœŸçš„æ‰§è¡Œæ—¶é—´è¶…å‡ºæœ€å¤§æ—¶é•¿2000msï¼Œè¯´æ˜â€œæ¡¶æ»¡äº†â€ï¼Œæ–°çš„è¯·æ±‚åˆ™ä¼šè¢«æ‹’ç»ã€‚</p>
<h3 id="4-4-ä»¤ç‰Œæ¡¶ç®—æ³•"><a href="#4-4-ä»¤ç‰Œæ¡¶ç®—æ³•" class="headerlink" title="4.4 ä»¤ç‰Œæ¡¶ç®—æ³•"></a>4.4 ä»¤ç‰Œæ¡¶ç®—æ³•</h3><p>é™æµçš„å¦ä¸€ç§å¸¸è§ç®—æ³•æ˜¯ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚Sentinelä¸­çš„çƒ­ç‚¹å‚æ•°é™æµæ­£æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•å®ç°çš„ã€‚</p>
<p>ä»¤ç‰Œæ¡¶ç®—æ³•è¯´æ˜ï¼š</p>
<ul>
<li>ä»¥å›ºå®šçš„é€Ÿç‡ç”Ÿæˆä»¤ç‰Œï¼Œå­˜å…¥ä»¤ç‰Œæ¡¶ä¸­ï¼Œå¦‚æœä»¤ç‰Œæ¡¶æ»¡äº†ä»¥åï¼Œåœæ­¢ç”Ÿæˆ</li>
<li>è¯·æ±‚è¿›å…¥åï¼Œå¿…é¡»å…ˆå°è¯•ä»æ¡¶ä¸­è·å–ä»¤ç‰Œï¼Œè·å–åˆ°ä»¤ç‰Œåæ‰å¯ä»¥è¢«å¤„ç†</li>
<li>å¦‚æœä»¤ç‰Œæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™è¯·æ±‚ç­‰å¾…æˆ–ä¸¢å¼ƒ</li>
</ul>
<p><img src="/img/blogs/java/springcloud/7.4.5.png" srcset="/img/loading.gif" lazyload></p>
<p>åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¯ç§’äº§ç”Ÿçš„ä»¤ç‰Œæ•°é‡åŸºæœ¬å°±æ˜¯QPSä¸Šé™ã€‚<br>å½“ç„¶ä¹Ÿæœ‰ä¾‹å¤–æƒ…å†µï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>æŸä¸€ç§’ä»¤ç‰Œæ¡¶ä¸­äº§ç”Ÿäº†å¾ˆå¤šä»¤ç‰Œï¼Œè¾¾åˆ°ä»¤ç‰Œæ¡¶ä¸Šé™Nï¼Œç¼“å­˜åœ¨ä»¤ç‰Œæ¡¶ä¸­ï¼Œä½†æ˜¯è¿™ä¸€ç§’æ²¡æœ‰è¯·æ±‚è¿›å…¥ã€‚</li>
<li>ä¸‹ä¸€ç§’çš„å‰åŠç§’æ¶Œå…¥äº†è¶…è¿‡2Nä¸ªè¯·æ±‚ï¼Œä¹‹å‰ç¼“å­˜çš„ä»¤ç‰Œæ¡¶çš„ä»¤ç‰Œè€—å°½ï¼ŒåŒæ—¶è¿™ä¸€ç§’åˆç”Ÿæˆäº†Nä¸ªä»¤ç‰Œï¼Œäºæ˜¯æ€»å…±æ”¾è¡Œäº†2Nä¸ªè¯·æ±‚ã€‚è¶…å‡ºäº†æˆ‘ä»¬è®¾å®šçš„QPSé˜ˆå€¼ã€‚<br>å› æ­¤ï¼Œåœ¨ä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•æ—¶ï¼Œå°½é‡ä¸è¦å°†ä»¤ç‰Œä¸Šé™è®¾å®šåˆ°æœåŠ¡èƒ½æ‰¿å—çš„QPSä¸Šé™ã€‚è€Œæ˜¯é¢„ç•™ä¸€å®šçš„æ³¢åŠ¨ç©ºé—´ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½åº”å¯¹çªå‘æµé‡ã€‚</li>
</ul>
<h3 id="4-5-Sentinelçš„é™æµä¸Gatewayçš„é™æµæœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ"><a href="#4-5-Sentinelçš„é™æµä¸Gatewayçš„é™æµæœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ" class="headerlink" title="4.5 Sentinelçš„é™æµä¸Gatewayçš„é™æµæœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ"></a>4.5 Sentinelçš„é™æµä¸Gatewayçš„é™æµæœ‰ä»€ä¹ˆå·®åˆ«ï¼Ÿ</h3><p>é—®é¢˜è¯´æ˜ï¼šè€ƒå¯Ÿå¯¹é™æµç®—æ³•çš„æŒæ¡æƒ…å†µ<br>éš¾æ˜“ç¨‹åº¦ï¼šéš¾<br>å‚è€ƒè¯æœ¯ï¼š</p>
<ul>
<li>é™æµç®—æ³•å¸¸è§çš„æœ‰ä¸‰ç§å®ç°ï¼šæ»‘åŠ¨æ—¶é—´çª—å£ã€ä»¤ç‰Œæ¡¶ç®—æ³•ã€æ¼æ¡¶ç®—æ³•ã€‚Gatewayåˆ™é‡‡ç”¨äº†åŸºäºRediså®ç°çš„ä»¤ç‰Œæ¡¶ç®—æ³•</li>
<li>è€ŒSentinelå†…éƒ¨å´æ¯”è¾ƒå¤æ‚ï¼š<ul>
<li>é»˜è®¤é™æµæ¨¡å¼æ˜¯åŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•ï¼Œå¦å¤–Sentinelä¸­æ–­è·¯å™¨çš„è®¡æ•°ä¹Ÿæ˜¯åŸºäºæ»‘åŠ¨æ—¶é—´çª—å£ç®—æ³•</li>
<li>é™æµåå¯ä»¥å¿«é€Ÿå¤±è´¥å’Œæ’é˜Ÿç­‰å¾…ï¼Œå…¶ä¸­æ’é˜Ÿç­‰å¾…åŸºäºæ¼æ¡¶ç®—æ³•</li>
<li>è€Œçƒ­ç‚¹å‚æ•°é™æµåˆ™æ˜¯åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•</li>
</ul>
</li>
</ul>
<p>å¼•ç”¨ï¼š<a target="_blank" rel="noopener" href="https://b11et3un53m.feishu.cn/wiki/FYNkwb1i6i0qwCk7lF2caEq5nRe">https://b11et3un53m.feishu.cn/wiki/FYNkwb1i6i0qwCk7lF2caEq5nRe</a></p>
<h1 id="END"><a href="#END" class="headerlink" title="END"></a>END</h1>
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/SpringCloud/" class="category-chain-item">SpringCloud</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/JAVA/" class="print-no-link">#JAVA</a>
      
        <a href="/tags/%E5%AD%A6%E4%B9%A0/" class="print-no-link">#å­¦ä¹ </a>
      
        <a href="/tags/SpringCloud/" class="print-no-link">#SpringCloud</a>
      
    </div>
  
</div>


              

              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/04/08/JAVA/redis/" title="Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Rediså­¦ä¹ ç¬”è®°åŠé¢è¯•é—®é¢˜åˆ†æ</span>
                        <span class="visible-mobile">ä¸Šä¸€ç¯‡</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/08/JAVA/SpringCloud/Elasticsearch/" title="Elasticsearchå­¦ä¹ ç¬”è®°">
                        <span class="hidden-mobile">Elasticsearchå­¦ä¹ ç¬”è®°</span>
                        <span class="visible-mobile">ä¸‹ä¸€ç¯‡</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"sj2tGuxMGSDhkN5hNuOIVta1-gzGzoHsz","appKey":"ysR5OTuTzoby2oNvNyGOtXFQ","path":"window.location.pathname","placeholder":"å¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿æŒ‡æ­£~","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>ç›®å½•</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">æœç´¢</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">å…³é”®è¯</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <span>AI</span> <i class="iconfont icon-love"></i> <span>CPP</span> <i class="iconfont icon-love"></i> <span>JAVA</span> <i class="iconfont icon-love"></i> <span>CyberSec</span> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        æ€»è®¿é—®é‡ 
        <span id="busuanzi_value_site_pv"></span>
         æ¬¡
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        æ€»è®¿å®¢æ•° 
        <span id="busuanzi_value_site_uv"></span>
         äºº
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>




  
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/love.js"></script>
<script src="//cdn.jsdelivr.net/gh/bynotes/texiao/source/js/xiaoxingxing.js"></script>
<script src="/js/bubble.js"></script>



<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ï¼Œå°†å®ƒä¿æŒåœ¨æœ€åº•éƒ¨ -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">åšå®¢åœ¨å…è®¸ JavaScript è¿è¡Œçš„ç¯å¢ƒä¸‹æµè§ˆæ•ˆæœæ›´ä½³</div>
  </noscript>
<!-- hexo injector body_end start --><script src="/js/backgroundize.js"></script><!-- hexo injector body_end end --></body>
</html>
